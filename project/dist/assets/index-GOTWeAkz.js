(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const S of document.querySelectorAll('link[rel="modulepreload"]'))x(S);new MutationObserver(S=>{for(const P of S)if(P.type==="childList")for(const O of P.addedNodes)O.tagName==="LINK"&&O.rel==="modulepreload"&&x(O)}).observe(document,{childList:!0,subtree:!0});function m(S){const P={};return S.integrity&&(P.integrity=S.integrity),S.referrerPolicy&&(P.referrerPolicy=S.referrerPolicy),S.crossOrigin==="use-credentials"?P.credentials="include":S.crossOrigin==="anonymous"?P.credentials="omit":P.credentials="same-origin",P}function x(S){if(S.ep)return;S.ep=!0;const P=m(S);fetch(S.href,P)}})();var Cs=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function az(c){return c&&c.__esModule&&Object.prototype.hasOwnProperty.call(c,"default")?c.default:c}function lz(c){if(c.__esModule)return c;var a=c.default;if(typeof a=="function"){var m=function x(){return this instanceof x?Reflect.construct(a,arguments,this.constructor):a.apply(this,arguments)};m.prototype=a.prototype}else m={};return Object.defineProperty(m,"__esModule",{value:!0}),Object.keys(c).forEach(function(x){var S=Object.getOwnPropertyDescriptor(c,x);Object.defineProperty(m,x,S.get?S:{enumerable:!0,get:function(){return c[x]}})}),m}var OA={exports:{}},uv={},FA={exports:{}},En={};/**
 * @license React
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var eg=Symbol.for("react.element"),cz=Symbol.for("react.portal"),uz=Symbol.for("react.fragment"),hz=Symbol.for("react.strict_mode"),dz=Symbol.for("react.profiler"),fz=Symbol.for("react.provider"),pz=Symbol.for("react.context"),mz=Symbol.for("react.forward_ref"),_z=Symbol.for("react.suspense"),gz=Symbol.for("react.memo"),yz=Symbol.for("react.lazy"),cI=Symbol.iterator;function vz(c){return c===null||typeof c!="object"?null:(c=cI&&c[cI]||c["@@iterator"],typeof c=="function"?c:null)}var BA={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},NA=Object.assign,jA={};function op(c,a,m){this.props=c,this.context=a,this.refs=jA,this.updater=m||BA}op.prototype.isReactComponent={};op.prototype.setState=function(c,a){if(typeof c!="object"&&typeof c!="function"&&c!=null)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,c,a,"setState")};op.prototype.forceUpdate=function(c){this.updater.enqueueForceUpdate(this,c,"forceUpdate")};function UA(){}UA.prototype=op.prototype;function fb(c,a,m){this.props=c,this.context=a,this.refs=jA,this.updater=m||BA}var pb=fb.prototype=new UA;pb.constructor=fb;NA(pb,op.prototype);pb.isPureReactComponent=!0;var uI=Array.isArray,VA=Object.prototype.hasOwnProperty,mb={current:null},$A={key:!0,ref:!0,__self:!0,__source:!0};function GA(c,a,m){var x,S={},P=null,O=null;if(a!=null)for(x in a.ref!==void 0&&(O=a.ref),a.key!==void 0&&(P=""+a.key),a)VA.call(a,x)&&!$A.hasOwnProperty(x)&&(S[x]=a[x]);var s=arguments.length-2;if(s===1)S.children=m;else if(1<s){for(var Z=Array(s),Q=0;Q<s;Q++)Z[Q]=arguments[Q+2];S.children=Z}if(c&&c.defaultProps)for(x in s=c.defaultProps,s)S[x]===void 0&&(S[x]=s[x]);return{$$typeof:eg,type:c,key:P,ref:O,props:S,_owner:mb.current}}function xz(c,a){return{$$typeof:eg,type:c.type,key:a,ref:c.ref,props:c.props,_owner:c._owner}}function _b(c){return typeof c=="object"&&c!==null&&c.$$typeof===eg}function wz(c){var a={"=":"=0",":":"=2"};return"$"+c.replace(/[=:]/g,function(m){return a[m]})}var hI=/\/+/g;function M1(c,a){return typeof c=="object"&&c!==null&&c.key!=null?wz(""+c.key):a.toString(36)}function I0(c,a,m,x,S){var P=typeof c;(P==="undefined"||P==="boolean")&&(c=null);var O=!1;if(c===null)O=!0;else switch(P){case"string":case"number":O=!0;break;case"object":switch(c.$$typeof){case eg:case cz:O=!0}}if(O)return O=c,S=S(O),c=x===""?"."+M1(O,0):x,uI(S)?(m="",c!=null&&(m=c.replace(hI,"$&/")+"/"),I0(S,a,m,"",function(Q){return Q})):S!=null&&(_b(S)&&(S=xz(S,m+(!S.key||O&&O.key===S.key?"":(""+S.key).replace(hI,"$&/")+"/")+c)),a.push(S)),1;if(O=0,x=x===""?".":x+":",uI(c))for(var s=0;s<c.length;s++){P=c[s];var Z=x+M1(P,s);O+=I0(P,a,m,Z,S)}else if(Z=vz(c),typeof Z=="function")for(c=Z.call(c),s=0;!(P=c.next()).done;)P=P.value,Z=x+M1(P,s++),O+=I0(P,a,m,Z,S);else if(P==="object")throw a=String(c),Error("Objects are not valid as a React child (found: "+(a==="[object Object]"?"object with keys {"+Object.keys(c).join(", ")+"}":a)+"). If you meant to render a collection of children, use an array instead.");return O}function o0(c,a,m){if(c==null)return c;var x=[],S=0;return I0(c,x,"","",function(P){return a.call(m,P,S++)}),x}function bz(c){if(c._status===-1){var a=c._result;a=a(),a.then(function(m){(c._status===0||c._status===-1)&&(c._status=1,c._result=m)},function(m){(c._status===0||c._status===-1)&&(c._status=2,c._result=m)}),c._status===-1&&(c._status=0,c._result=a)}if(c._status===1)return c._result.default;throw c._result}var qo={current:null},A0={transition:null},Tz={ReactCurrentDispatcher:qo,ReactCurrentBatchConfig:A0,ReactCurrentOwner:mb};function HA(){throw Error("act(...) is not supported in production builds of React.")}En.Children={map:o0,forEach:function(c,a,m){o0(c,function(){a.apply(this,arguments)},m)},count:function(c){var a=0;return o0(c,function(){a++}),a},toArray:function(c){return o0(c,function(a){return a})||[]},only:function(c){if(!_b(c))throw Error("React.Children.only expected to receive a single React element child.");return c}};En.Component=op;En.Fragment=uz;En.Profiler=dz;En.PureComponent=fb;En.StrictMode=hz;En.Suspense=_z;En.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=Tz;En.act=HA;En.cloneElement=function(c,a,m){if(c==null)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+c+".");var x=NA({},c.props),S=c.key,P=c.ref,O=c._owner;if(a!=null){if(a.ref!==void 0&&(P=a.ref,O=mb.current),a.key!==void 0&&(S=""+a.key),c.type&&c.type.defaultProps)var s=c.type.defaultProps;for(Z in a)VA.call(a,Z)&&!$A.hasOwnProperty(Z)&&(x[Z]=a[Z]===void 0&&s!==void 0?s[Z]:a[Z])}var Z=arguments.length-2;if(Z===1)x.children=m;else if(1<Z){s=Array(Z);for(var Q=0;Q<Z;Q++)s[Q]=arguments[Q+2];x.children=s}return{$$typeof:eg,type:c.type,key:S,ref:P,props:x,_owner:O}};En.createContext=function(c){return c={$$typeof:pz,_currentValue:c,_currentValue2:c,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null},c.Provider={$$typeof:fz,_context:c},c.Consumer=c};En.createElement=GA;En.createFactory=function(c){var a=GA.bind(null,c);return a.type=c,a};En.createRef=function(){return{current:null}};En.forwardRef=function(c){return{$$typeof:mz,render:c}};En.isValidElement=_b;En.lazy=function(c){return{$$typeof:yz,_payload:{_status:-1,_result:c},_init:bz}};En.memo=function(c,a){return{$$typeof:gz,type:c,compare:a===void 0?null:a}};En.startTransition=function(c){var a=A0.transition;A0.transition={};try{c()}finally{A0.transition=a}};En.unstable_act=HA;En.useCallback=function(c,a){return qo.current.useCallback(c,a)};En.useContext=function(c){return qo.current.useContext(c)};En.useDebugValue=function(){};En.useDeferredValue=function(c){return qo.current.useDeferredValue(c)};En.useEffect=function(c,a){return qo.current.useEffect(c,a)};En.useId=function(){return qo.current.useId()};En.useImperativeHandle=function(c,a,m){return qo.current.useImperativeHandle(c,a,m)};En.useInsertionEffect=function(c,a){return qo.current.useInsertionEffect(c,a)};En.useLayoutEffect=function(c,a){return qo.current.useLayoutEffect(c,a)};En.useMemo=function(c,a){return qo.current.useMemo(c,a)};En.useReducer=function(c,a,m){return qo.current.useReducer(c,a,m)};En.useRef=function(c){return qo.current.useRef(c)};En.useState=function(c){return qo.current.useState(c)};En.useSyncExternalStore=function(c,a,m){return qo.current.useSyncExternalStore(c,a,m)};En.useTransition=function(){return qo.current.useTransition()};En.version="18.3.1";FA.exports=En;var vi=FA.exports;/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Sz=vi,Ez=Symbol.for("react.element"),Iz=Symbol.for("react.fragment"),Az=Object.prototype.hasOwnProperty,Cz=Sz.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,Pz={key:!0,ref:!0,__self:!0,__source:!0};function qA(c,a,m){var x,S={},P=null,O=null;m!==void 0&&(P=""+m),a.key!==void 0&&(P=""+a.key),a.ref!==void 0&&(O=a.ref);for(x in a)Az.call(a,x)&&!Pz.hasOwnProperty(x)&&(S[x]=a[x]);if(c&&c.defaultProps)for(x in a=c.defaultProps,a)S[x]===void 0&&(S[x]=a[x]);return{$$typeof:Ez,type:c,key:P,ref:O,props:S,_owner:Cz.current}}uv.Fragment=Iz;uv.jsx=qA;uv.jsxs=qA;OA.exports=uv;var Ce=OA.exports,WA={exports:{}},Ms={},ZA={exports:{}},XA={};/**
 * @license React
 * scheduler.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */(function(c){function a($t,ki){var ji=$t.length;$t.push(ki);e:for(;0<ji;){var On=ji-1>>>1,Un=$t[On];if(0<S(Un,ki))$t[On]=ki,$t[ji]=Un,ji=On;else break e}}function m($t){return $t.length===0?null:$t[0]}function x($t){if($t.length===0)return null;var ki=$t[0],ji=$t.pop();if(ji!==ki){$t[0]=ji;e:for(var On=0,Un=$t.length,gn=Un>>>1;On<gn;){var Er=2*(On+1)-1,ja=$t[Er],Lo=Er+1,ia=$t[Lo];if(0>S(ja,ji))Lo<Un&&0>S(ia,ja)?($t[On]=ia,$t[Lo]=ji,On=Lo):($t[On]=ja,$t[Er]=ji,On=Er);else if(Lo<Un&&0>S(ia,ji))$t[On]=ia,$t[Lo]=ji,On=Lo;else break e}}return ki}function S($t,ki){var ji=$t.sortIndex-ki.sortIndex;return ji!==0?ji:$t.id-ki.id}if(typeof performance=="object"&&typeof performance.now=="function"){var P=performance;c.unstable_now=function(){return P.now()}}else{var O=Date,s=O.now();c.unstable_now=function(){return O.now()-s}}var Z=[],Q=[],me=1,Ee=null,De=3,Xe=!1,mt=!1,We=!1,ct=typeof setTimeout=="function"?setTimeout:null,Me=typeof clearTimeout=="function"?clearTimeout:null,xe=typeof setImmediate<"u"?setImmediate:null;typeof navigator<"u"&&navigator.scheduling!==void 0&&navigator.scheduling.isInputPending!==void 0&&navigator.scheduling.isInputPending.bind(navigator.scheduling);function Pe($t){for(var ki=m(Q);ki!==null;){if(ki.callback===null)x(Q);else if(ki.startTime<=$t)x(Q),ki.sortIndex=ki.expirationTime,a(Z,ki);else break;ki=m(Q)}}function Ze($t){if(We=!1,Pe($t),!mt)if(m(Z)!==null)mt=!0,In(Ct);else{var ki=m(Q);ki!==null&&dn(Ze,ki.startTime-$t)}}function Ct($t,ki){mt=!1,We&&(We=!1,Me(Zt),Zt=-1),Xe=!0;var ji=De;try{for(Pe(ki),Ee=m(Z);Ee!==null&&(!(Ee.expirationTime>ki)||$t&&!Mi());){var On=Ee.callback;if(typeof On=="function"){Ee.callback=null,De=Ee.priorityLevel;var Un=On(Ee.expirationTime<=ki);ki=c.unstable_now(),typeof Un=="function"?Ee.callback=Un:Ee===m(Z)&&x(Z),Pe(ki)}else x(Z);Ee=m(Z)}if(Ee!==null)var gn=!0;else{var Er=m(Q);Er!==null&&dn(Ze,Er.startTime-ki),gn=!1}return gn}finally{Ee=null,De=ji,Xe=!1}}var kt=!1,zt=null,Zt=-1,mn=5,Xt=-1;function Mi(){return!(c.unstable_now()-Xt<mn)}function or(){if(zt!==null){var $t=c.unstable_now();Xt=$t;var ki=!0;try{ki=zt(!0,$t)}finally{ki?Ri():(kt=!1,zt=null)}}else kt=!1}var Ri;if(typeof xe=="function")Ri=function(){xe(or)};else if(typeof MessageChannel<"u"){var wl=new MessageChannel,pr=wl.port2;wl.port1.onmessage=or,Ri=function(){pr.postMessage(null)}}else Ri=function(){ct(or,0)};function In($t){zt=$t,kt||(kt=!0,Ri())}function dn($t,ki){Zt=ct(function(){$t(c.unstable_now())},ki)}c.unstable_IdlePriority=5,c.unstable_ImmediatePriority=1,c.unstable_LowPriority=4,c.unstable_NormalPriority=3,c.unstable_Profiling=null,c.unstable_UserBlockingPriority=2,c.unstable_cancelCallback=function($t){$t.callback=null},c.unstable_continueExecution=function(){mt||Xe||(mt=!0,In(Ct))},c.unstable_forceFrameRate=function($t){0>$t||125<$t?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):mn=0<$t?Math.floor(1e3/$t):5},c.unstable_getCurrentPriorityLevel=function(){return De},c.unstable_getFirstCallbackNode=function(){return m(Z)},c.unstable_next=function($t){switch(De){case 1:case 2:case 3:var ki=3;break;default:ki=De}var ji=De;De=ki;try{return $t()}finally{De=ji}},c.unstable_pauseExecution=function(){},c.unstable_requestPaint=function(){},c.unstable_runWithPriority=function($t,ki){switch($t){case 1:case 2:case 3:case 4:case 5:break;default:$t=3}var ji=De;De=$t;try{return ki()}finally{De=ji}},c.unstable_scheduleCallback=function($t,ki,ji){var On=c.unstable_now();switch(typeof ji=="object"&&ji!==null?(ji=ji.delay,ji=typeof ji=="number"&&0<ji?On+ji:On):ji=On,$t){case 1:var Un=-1;break;case 2:Un=250;break;case 5:Un=1073741823;break;case 4:Un=1e4;break;default:Un=5e3}return Un=ji+Un,$t={id:me++,callback:ki,priorityLevel:$t,startTime:ji,expirationTime:Un,sortIndex:-1},ji>On?($t.sortIndex=ji,a(Q,$t),m(Z)===null&&$t===m(Q)&&(We?(Me(Zt),Zt=-1):We=!0,dn(Ze,ji-On))):($t.sortIndex=Un,a(Z,$t),mt||Xe||(mt=!0,In(Ct))),$t},c.unstable_shouldYield=Mi,c.unstable_wrapCallback=function($t){var ki=De;return function(){var ji=De;De=ki;try{return $t.apply(this,arguments)}finally{De=ji}}}})(XA);ZA.exports=XA;var Mz=ZA.exports;/**
 * @license React
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Rz=vi,Ps=Mz;function Vt(c){for(var a="https://reactjs.org/docs/error-decoder.html?invariant="+c,m=1;m<arguments.length;m++)a+="&args[]="+encodeURIComponent(arguments[m]);return"Minified React error #"+c+"; visit "+a+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var KA=new Set,D_={};function zh(c,a){Yf(c,a),Yf(c+"Capture",a)}function Yf(c,a){for(D_[c]=a,c=0;c<a.length;c++)KA.add(a[c])}var cc=!(typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"),uw=Object.prototype.hasOwnProperty,kz=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,dI={},fI={};function Lz(c){return uw.call(fI,c)?!0:uw.call(dI,c)?!1:kz.test(c)?fI[c]=!0:(dI[c]=!0,!1)}function zz(c,a,m,x){if(m!==null&&m.type===0)return!1;switch(typeof a){case"function":case"symbol":return!0;case"boolean":return x?!1:m!==null?!m.acceptsBooleans:(c=c.toLowerCase().slice(0,5),c!=="data-"&&c!=="aria-");default:return!1}}function Dz(c,a,m,x){if(a===null||typeof a>"u"||zz(c,a,m,x))return!0;if(x)return!1;if(m!==null)switch(m.type){case 3:return!a;case 4:return a===!1;case 5:return isNaN(a);case 6:return isNaN(a)||1>a}return!1}function Wo(c,a,m,x,S,P,O){this.acceptsBooleans=a===2||a===3||a===4,this.attributeName=x,this.attributeNamespace=S,this.mustUseProperty=m,this.propertyName=c,this.type=a,this.sanitizeURL=P,this.removeEmptyString=O}var So={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(c){So[c]=new Wo(c,0,!1,c,null,!1,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(c){var a=c[0];So[a]=new Wo(a,1,!1,c[1],null,!1,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(c){So[c]=new Wo(c,2,!1,c.toLowerCase(),null,!1,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(c){So[c]=new Wo(c,2,!1,c,null,!1,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(c){So[c]=new Wo(c,3,!1,c.toLowerCase(),null,!1,!1)});["checked","multiple","muted","selected"].forEach(function(c){So[c]=new Wo(c,3,!0,c,null,!1,!1)});["capture","download"].forEach(function(c){So[c]=new Wo(c,4,!1,c,null,!1,!1)});["cols","rows","size","span"].forEach(function(c){So[c]=new Wo(c,6,!1,c,null,!1,!1)});["rowSpan","start"].forEach(function(c){So[c]=new Wo(c,5,!1,c.toLowerCase(),null,!1,!1)});var gb=/[\-:]([a-z])/g;function yb(c){return c[1].toUpperCase()}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(c){var a=c.replace(gb,yb);So[a]=new Wo(a,1,!1,c,null,!1,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(c){var a=c.replace(gb,yb);So[a]=new Wo(a,1,!1,c,"http://www.w3.org/1999/xlink",!1,!1)});["xml:base","xml:lang","xml:space"].forEach(function(c){var a=c.replace(gb,yb);So[a]=new Wo(a,1,!1,c,"http://www.w3.org/XML/1998/namespace",!1,!1)});["tabIndex","crossOrigin"].forEach(function(c){So[c]=new Wo(c,1,!1,c.toLowerCase(),null,!1,!1)});So.xlinkHref=new Wo("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1);["src","href","action","formAction"].forEach(function(c){So[c]=new Wo(c,1,!1,c.toLowerCase(),null,!0,!0)});function vb(c,a,m,x){var S=So.hasOwnProperty(a)?So[a]:null;(S!==null?S.type!==0:x||!(2<a.length)||a[0]!=="o"&&a[0]!=="O"||a[1]!=="n"&&a[1]!=="N")&&(Dz(a,m,S,x)&&(m=null),x||S===null?Lz(a)&&(m===null?c.removeAttribute(a):c.setAttribute(a,""+m)):S.mustUseProperty?c[S.propertyName]=m===null?S.type===3?!1:"":m:(a=S.attributeName,x=S.attributeNamespace,m===null?c.removeAttribute(a):(S=S.type,m=S===3||S===4&&m===!0?"":""+m,x?c.setAttributeNS(x,a,m):c.setAttribute(a,m))))}var fc=Rz.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,s0=Symbol.for("react.element"),Lf=Symbol.for("react.portal"),zf=Symbol.for("react.fragment"),xb=Symbol.for("react.strict_mode"),hw=Symbol.for("react.profiler"),YA=Symbol.for("react.provider"),JA=Symbol.for("react.context"),wb=Symbol.for("react.forward_ref"),dw=Symbol.for("react.suspense"),fw=Symbol.for("react.suspense_list"),bb=Symbol.for("react.memo"),eu=Symbol.for("react.lazy"),QA=Symbol.for("react.offscreen"),pI=Symbol.iterator;function l_(c){return c===null||typeof c!="object"?null:(c=pI&&c[pI]||c["@@iterator"],typeof c=="function"?c:null)}var kr=Object.assign,R1;function g_(c){if(R1===void 0)try{throw Error()}catch(m){var a=m.stack.trim().match(/\n( *(at )?)/);R1=a&&a[1]||""}return`
`+R1+c}var k1=!1;function L1(c,a){if(!c||k1)return"";k1=!0;var m=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(a)if(a=function(){throw Error()},Object.defineProperty(a.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(a,[])}catch(Q){var x=Q}Reflect.construct(c,[],a)}else{try{a.call()}catch(Q){x=Q}c.call(a.prototype)}else{try{throw Error()}catch(Q){x=Q}c()}}catch(Q){if(Q&&x&&typeof Q.stack=="string"){for(var S=Q.stack.split(`
`),P=x.stack.split(`
`),O=S.length-1,s=P.length-1;1<=O&&0<=s&&S[O]!==P[s];)s--;for(;1<=O&&0<=s;O--,s--)if(S[O]!==P[s]){if(O!==1||s!==1)do if(O--,s--,0>s||S[O]!==P[s]){var Z=`
`+S[O].replace(" at new "," at ");return c.displayName&&Z.includes("<anonymous>")&&(Z=Z.replace("<anonymous>",c.displayName)),Z}while(1<=O&&0<=s);break}}}finally{k1=!1,Error.prepareStackTrace=m}return(c=c?c.displayName||c.name:"")?g_(c):""}function Oz(c){switch(c.tag){case 5:return g_(c.type);case 16:return g_("Lazy");case 13:return g_("Suspense");case 19:return g_("SuspenseList");case 0:case 2:case 15:return c=L1(c.type,!1),c;case 11:return c=L1(c.type.render,!1),c;case 1:return c=L1(c.type,!0),c;default:return""}}function pw(c){if(c==null)return null;if(typeof c=="function")return c.displayName||c.name||null;if(typeof c=="string")return c;switch(c){case zf:return"Fragment";case Lf:return"Portal";case hw:return"Profiler";case xb:return"StrictMode";case dw:return"Suspense";case fw:return"SuspenseList"}if(typeof c=="object")switch(c.$$typeof){case JA:return(c.displayName||"Context")+".Consumer";case YA:return(c._context.displayName||"Context")+".Provider";case wb:var a=c.render;return c=c.displayName,c||(c=a.displayName||a.name||"",c=c!==""?"ForwardRef("+c+")":"ForwardRef"),c;case bb:return a=c.displayName||null,a!==null?a:pw(c.type)||"Memo";case eu:a=c._payload,c=c._init;try{return pw(c(a))}catch{}}return null}function Fz(c){var a=c.type;switch(c.tag){case 24:return"Cache";case 9:return(a.displayName||"Context")+".Consumer";case 10:return(a._context.displayName||"Context")+".Provider";case 18:return"DehydratedFragment";case 11:return c=a.render,c=c.displayName||c.name||"",a.displayName||(c!==""?"ForwardRef("+c+")":"ForwardRef");case 7:return"Fragment";case 5:return a;case 4:return"Portal";case 3:return"Root";case 6:return"Text";case 16:return pw(a);case 8:return a===xb?"StrictMode":"Mode";case 22:return"Offscreen";case 12:return"Profiler";case 21:return"Scope";case 13:return"Suspense";case 19:return"SuspenseList";case 25:return"TracingMarker";case 1:case 0:case 17:case 2:case 14:case 15:if(typeof a=="function")return a.displayName||a.name||null;if(typeof a=="string")return a}return null}function mu(c){switch(typeof c){case"boolean":case"number":case"string":case"undefined":return c;case"object":return c;default:return""}}function eC(c){var a=c.type;return(c=c.nodeName)&&c.toLowerCase()==="input"&&(a==="checkbox"||a==="radio")}function Bz(c){var a=eC(c)?"checked":"value",m=Object.getOwnPropertyDescriptor(c.constructor.prototype,a),x=""+c[a];if(!c.hasOwnProperty(a)&&typeof m<"u"&&typeof m.get=="function"&&typeof m.set=="function"){var S=m.get,P=m.set;return Object.defineProperty(c,a,{configurable:!0,get:function(){return S.call(this)},set:function(O){x=""+O,P.call(this,O)}}),Object.defineProperty(c,a,{enumerable:m.enumerable}),{getValue:function(){return x},setValue:function(O){x=""+O},stopTracking:function(){c._valueTracker=null,delete c[a]}}}}function a0(c){c._valueTracker||(c._valueTracker=Bz(c))}function tC(c){if(!c)return!1;var a=c._valueTracker;if(!a)return!0;var m=a.getValue(),x="";return c&&(x=eC(c)?c.checked?"true":"false":c.value),c=x,c!==m?(a.setValue(c),!0):!1}function B0(c){if(c=c||(typeof document<"u"?document:void 0),typeof c>"u")return null;try{return c.activeElement||c.body}catch{return c.body}}function mw(c,a){var m=a.checked;return kr({},a,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:m??c._wrapperState.initialChecked})}function mI(c,a){var m=a.defaultValue==null?"":a.defaultValue,x=a.checked!=null?a.checked:a.defaultChecked;m=mu(a.value!=null?a.value:m),c._wrapperState={initialChecked:x,initialValue:m,controlled:a.type==="checkbox"||a.type==="radio"?a.checked!=null:a.value!=null}}function iC(c,a){a=a.checked,a!=null&&vb(c,"checked",a,!1)}function _w(c,a){iC(c,a);var m=mu(a.value),x=a.type;if(m!=null)x==="number"?(m===0&&c.value===""||c.value!=m)&&(c.value=""+m):c.value!==""+m&&(c.value=""+m);else if(x==="submit"||x==="reset"){c.removeAttribute("value");return}a.hasOwnProperty("value")?gw(c,a.type,m):a.hasOwnProperty("defaultValue")&&gw(c,a.type,mu(a.defaultValue)),a.checked==null&&a.defaultChecked!=null&&(c.defaultChecked=!!a.defaultChecked)}function _I(c,a,m){if(a.hasOwnProperty("value")||a.hasOwnProperty("defaultValue")){var x=a.type;if(!(x!=="submit"&&x!=="reset"||a.value!==void 0&&a.value!==null))return;a=""+c._wrapperState.initialValue,m||a===c.value||(c.value=a),c.defaultValue=a}m=c.name,m!==""&&(c.name=""),c.defaultChecked=!!c._wrapperState.initialChecked,m!==""&&(c.name=m)}function gw(c,a,m){(a!=="number"||B0(c.ownerDocument)!==c)&&(m==null?c.defaultValue=""+c._wrapperState.initialValue:c.defaultValue!==""+m&&(c.defaultValue=""+m))}var y_=Array.isArray;function Hf(c,a,m,x){if(c=c.options,a){a={};for(var S=0;S<m.length;S++)a["$"+m[S]]=!0;for(m=0;m<c.length;m++)S=a.hasOwnProperty("$"+c[m].value),c[m].selected!==S&&(c[m].selected=S),S&&x&&(c[m].defaultSelected=!0)}else{for(m=""+mu(m),a=null,S=0;S<c.length;S++){if(c[S].value===m){c[S].selected=!0,x&&(c[S].defaultSelected=!0);return}a!==null||c[S].disabled||(a=c[S])}a!==null&&(a.selected=!0)}}function yw(c,a){if(a.dangerouslySetInnerHTML!=null)throw Error(Vt(91));return kr({},a,{value:void 0,defaultValue:void 0,children:""+c._wrapperState.initialValue})}function gI(c,a){var m=a.value;if(m==null){if(m=a.children,a=a.defaultValue,m!=null){if(a!=null)throw Error(Vt(92));if(y_(m)){if(1<m.length)throw Error(Vt(93));m=m[0]}a=m}a==null&&(a=""),m=a}c._wrapperState={initialValue:mu(m)}}function nC(c,a){var m=mu(a.value),x=mu(a.defaultValue);m!=null&&(m=""+m,m!==c.value&&(c.value=m),a.defaultValue==null&&c.defaultValue!==m&&(c.defaultValue=m)),x!=null&&(c.defaultValue=""+x)}function yI(c){var a=c.textContent;a===c._wrapperState.initialValue&&a!==""&&a!==null&&(c.value=a)}function rC(c){switch(c){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function vw(c,a){return c==null||c==="http://www.w3.org/1999/xhtml"?rC(a):c==="http://www.w3.org/2000/svg"&&a==="foreignObject"?"http://www.w3.org/1999/xhtml":c}var l0,oC=function(c){return typeof MSApp<"u"&&MSApp.execUnsafeLocalFunction?function(a,m,x,S){MSApp.execUnsafeLocalFunction(function(){return c(a,m,x,S)})}:c}(function(c,a){if(c.namespaceURI!=="http://www.w3.org/2000/svg"||"innerHTML"in c)c.innerHTML=a;else{for(l0=l0||document.createElement("div"),l0.innerHTML="<svg>"+a.valueOf().toString()+"</svg>",a=l0.firstChild;c.firstChild;)c.removeChild(c.firstChild);for(;a.firstChild;)c.appendChild(a.firstChild)}});function O_(c,a){if(a){var m=c.firstChild;if(m&&m===c.lastChild&&m.nodeType===3){m.nodeValue=a;return}}c.textContent=a}var T_={animationIterationCount:!0,aspectRatio:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},Nz=["Webkit","ms","Moz","O"];Object.keys(T_).forEach(function(c){Nz.forEach(function(a){a=a+c.charAt(0).toUpperCase()+c.substring(1),T_[a]=T_[c]})});function sC(c,a,m){return a==null||typeof a=="boolean"||a===""?"":m||typeof a!="number"||a===0||T_.hasOwnProperty(c)&&T_[c]?(""+a).trim():a+"px"}function aC(c,a){c=c.style;for(var m in a)if(a.hasOwnProperty(m)){var x=m.indexOf("--")===0,S=sC(m,a[m],x);m==="float"&&(m="cssFloat"),x?c.setProperty(m,S):c[m]=S}}var jz=kr({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function xw(c,a){if(a){if(jz[c]&&(a.children!=null||a.dangerouslySetInnerHTML!=null))throw Error(Vt(137,c));if(a.dangerouslySetInnerHTML!=null){if(a.children!=null)throw Error(Vt(60));if(typeof a.dangerouslySetInnerHTML!="object"||!("__html"in a.dangerouslySetInnerHTML))throw Error(Vt(61))}if(a.style!=null&&typeof a.style!="object")throw Error(Vt(62))}}function ww(c,a){if(c.indexOf("-")===-1)return typeof a.is=="string";switch(c){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var bw=null;function Tb(c){return c=c.target||c.srcElement||window,c.correspondingUseElement&&(c=c.correspondingUseElement),c.nodeType===3?c.parentNode:c}var Tw=null,qf=null,Wf=null;function vI(c){if(c=ng(c)){if(typeof Tw!="function")throw Error(Vt(280));var a=c.stateNode;a&&(a=mv(a),Tw(c.stateNode,c.type,a))}}function lC(c){qf?Wf?Wf.push(c):Wf=[c]:qf=c}function cC(){if(qf){var c=qf,a=Wf;if(Wf=qf=null,vI(c),a)for(c=0;c<a.length;c++)vI(a[c])}}function uC(c,a){return c(a)}function hC(){}var z1=!1;function dC(c,a,m){if(z1)return c(a,m);z1=!0;try{return uC(c,a,m)}finally{z1=!1,(qf!==null||Wf!==null)&&(hC(),cC())}}function F_(c,a){var m=c.stateNode;if(m===null)return null;var x=mv(m);if(x===null)return null;m=x[a];e:switch(a){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(x=!x.disabled)||(c=c.type,x=!(c==="button"||c==="input"||c==="select"||c==="textarea")),c=!x;break e;default:c=!1}if(c)return null;if(m&&typeof m!="function")throw Error(Vt(231,a,typeof m));return m}var Sw=!1;if(cc)try{var c_={};Object.defineProperty(c_,"passive",{get:function(){Sw=!0}}),window.addEventListener("test",c_,c_),window.removeEventListener("test",c_,c_)}catch{Sw=!1}function Uz(c,a,m,x,S,P,O,s,Z){var Q=Array.prototype.slice.call(arguments,3);try{a.apply(m,Q)}catch(me){this.onError(me)}}var S_=!1,N0=null,j0=!1,Ew=null,Vz={onError:function(c){S_=!0,N0=c}};function $z(c,a,m,x,S,P,O,s,Z){S_=!1,N0=null,Uz.apply(Vz,arguments)}function Gz(c,a,m,x,S,P,O,s,Z){if($z.apply(this,arguments),S_){if(S_){var Q=N0;S_=!1,N0=null}else throw Error(Vt(198));j0||(j0=!0,Ew=Q)}}function Dh(c){var a=c,m=c;if(c.alternate)for(;a.return;)a=a.return;else{c=a;do a=c,a.flags&4098&&(m=a.return),c=a.return;while(c)}return a.tag===3?m:null}function fC(c){if(c.tag===13){var a=c.memoizedState;if(a===null&&(c=c.alternate,c!==null&&(a=c.memoizedState)),a!==null)return a.dehydrated}return null}function xI(c){if(Dh(c)!==c)throw Error(Vt(188))}function Hz(c){var a=c.alternate;if(!a){if(a=Dh(c),a===null)throw Error(Vt(188));return a!==c?null:c}for(var m=c,x=a;;){var S=m.return;if(S===null)break;var P=S.alternate;if(P===null){if(x=S.return,x!==null){m=x;continue}break}if(S.child===P.child){for(P=S.child;P;){if(P===m)return xI(S),c;if(P===x)return xI(S),a;P=P.sibling}throw Error(Vt(188))}if(m.return!==x.return)m=S,x=P;else{for(var O=!1,s=S.child;s;){if(s===m){O=!0,m=S,x=P;break}if(s===x){O=!0,x=S,m=P;break}s=s.sibling}if(!O){for(s=P.child;s;){if(s===m){O=!0,m=P,x=S;break}if(s===x){O=!0,x=P,m=S;break}s=s.sibling}if(!O)throw Error(Vt(189))}}if(m.alternate!==x)throw Error(Vt(190))}if(m.tag!==3)throw Error(Vt(188));return m.stateNode.current===m?c:a}function pC(c){return c=Hz(c),c!==null?mC(c):null}function mC(c){if(c.tag===5||c.tag===6)return c;for(c=c.child;c!==null;){var a=mC(c);if(a!==null)return a;c=c.sibling}return null}var _C=Ps.unstable_scheduleCallback,wI=Ps.unstable_cancelCallback,qz=Ps.unstable_shouldYield,Wz=Ps.unstable_requestPaint,Nr=Ps.unstable_now,Zz=Ps.unstable_getCurrentPriorityLevel,Sb=Ps.unstable_ImmediatePriority,gC=Ps.unstable_UserBlockingPriority,U0=Ps.unstable_NormalPriority,Xz=Ps.unstable_LowPriority,yC=Ps.unstable_IdlePriority,hv=null,vl=null;function Kz(c){if(vl&&typeof vl.onCommitFiberRoot=="function")try{vl.onCommitFiberRoot(hv,c,void 0,(c.current.flags&128)===128)}catch{}}var Fa=Math.clz32?Math.clz32:Qz,Yz=Math.log,Jz=Math.LN2;function Qz(c){return c>>>=0,c===0?32:31-(Yz(c)/Jz|0)|0}var c0=64,u0=4194304;function v_(c){switch(c&-c){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return c&4194240;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return c&130023424;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 1073741824;default:return c}}function V0(c,a){var m=c.pendingLanes;if(m===0)return 0;var x=0,S=c.suspendedLanes,P=c.pingedLanes,O=m&268435455;if(O!==0){var s=O&~S;s!==0?x=v_(s):(P&=O,P!==0&&(x=v_(P)))}else O=m&~S,O!==0?x=v_(O):P!==0&&(x=v_(P));if(x===0)return 0;if(a!==0&&a!==x&&!(a&S)&&(S=x&-x,P=a&-a,S>=P||S===16&&(P&4194240)!==0))return a;if(x&4&&(x|=m&16),a=c.entangledLanes,a!==0)for(c=c.entanglements,a&=x;0<a;)m=31-Fa(a),S=1<<m,x|=c[m],a&=~S;return x}function eD(c,a){switch(c){case 1:case 2:case 4:return a+250;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return a+5e3;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return-1;case 134217728:case 268435456:case 536870912:case 1073741824:return-1;default:return-1}}function tD(c,a){for(var m=c.suspendedLanes,x=c.pingedLanes,S=c.expirationTimes,P=c.pendingLanes;0<P;){var O=31-Fa(P),s=1<<O,Z=S[O];Z===-1?(!(s&m)||s&x)&&(S[O]=eD(s,a)):Z<=a&&(c.expiredLanes|=s),P&=~s}}function Iw(c){return c=c.pendingLanes&-1073741825,c!==0?c:c&1073741824?1073741824:0}function vC(){var c=c0;return c0<<=1,!(c0&4194240)&&(c0=64),c}function D1(c){for(var a=[],m=0;31>m;m++)a.push(c);return a}function tg(c,a,m){c.pendingLanes|=a,a!==536870912&&(c.suspendedLanes=0,c.pingedLanes=0),c=c.eventTimes,a=31-Fa(a),c[a]=m}function iD(c,a){var m=c.pendingLanes&~a;c.pendingLanes=a,c.suspendedLanes=0,c.pingedLanes=0,c.expiredLanes&=a,c.mutableReadLanes&=a,c.entangledLanes&=a,a=c.entanglements;var x=c.eventTimes;for(c=c.expirationTimes;0<m;){var S=31-Fa(m),P=1<<S;a[S]=0,x[S]=-1,c[S]=-1,m&=~P}}function Eb(c,a){var m=c.entangledLanes|=a;for(c=c.entanglements;m;){var x=31-Fa(m),S=1<<x;S&a|c[x]&a&&(c[x]|=a),m&=~S}}var Jn=0;function xC(c){return c&=-c,1<c?4<c?c&268435455?16:536870912:4:1}var wC,Ib,bC,TC,SC,Aw=!1,h0=[],au=null,lu=null,cu=null,B_=new Map,N_=new Map,iu=[],nD="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset submit".split(" ");function bI(c,a){switch(c){case"focusin":case"focusout":au=null;break;case"dragenter":case"dragleave":lu=null;break;case"mouseover":case"mouseout":cu=null;break;case"pointerover":case"pointerout":B_.delete(a.pointerId);break;case"gotpointercapture":case"lostpointercapture":N_.delete(a.pointerId)}}function u_(c,a,m,x,S,P){return c===null||c.nativeEvent!==P?(c={blockedOn:a,domEventName:m,eventSystemFlags:x,nativeEvent:P,targetContainers:[S]},a!==null&&(a=ng(a),a!==null&&Ib(a)),c):(c.eventSystemFlags|=x,a=c.targetContainers,S!==null&&a.indexOf(S)===-1&&a.push(S),c)}function rD(c,a,m,x,S){switch(a){case"focusin":return au=u_(au,c,a,m,x,S),!0;case"dragenter":return lu=u_(lu,c,a,m,x,S),!0;case"mouseover":return cu=u_(cu,c,a,m,x,S),!0;case"pointerover":var P=S.pointerId;return B_.set(P,u_(B_.get(P)||null,c,a,m,x,S)),!0;case"gotpointercapture":return P=S.pointerId,N_.set(P,u_(N_.get(P)||null,c,a,m,x,S)),!0}return!1}function EC(c){var a=Sh(c.target);if(a!==null){var m=Dh(a);if(m!==null){if(a=m.tag,a===13){if(a=fC(m),a!==null){c.blockedOn=a,SC(c.priority,function(){bC(m)});return}}else if(a===3&&m.stateNode.current.memoizedState.isDehydrated){c.blockedOn=m.tag===3?m.stateNode.containerInfo:null;return}}}c.blockedOn=null}function C0(c){if(c.blockedOn!==null)return!1;for(var a=c.targetContainers;0<a.length;){var m=Cw(c.domEventName,c.eventSystemFlags,a[0],c.nativeEvent);if(m===null){m=c.nativeEvent;var x=new m.constructor(m.type,m);bw=x,m.target.dispatchEvent(x),bw=null}else return a=ng(m),a!==null&&Ib(a),c.blockedOn=m,!1;a.shift()}return!0}function TI(c,a,m){C0(c)&&m.delete(a)}function oD(){Aw=!1,au!==null&&C0(au)&&(au=null),lu!==null&&C0(lu)&&(lu=null),cu!==null&&C0(cu)&&(cu=null),B_.forEach(TI),N_.forEach(TI)}function h_(c,a){c.blockedOn===a&&(c.blockedOn=null,Aw||(Aw=!0,Ps.unstable_scheduleCallback(Ps.unstable_NormalPriority,oD)))}function j_(c){function a(S){return h_(S,c)}if(0<h0.length){h_(h0[0],c);for(var m=1;m<h0.length;m++){var x=h0[m];x.blockedOn===c&&(x.blockedOn=null)}}for(au!==null&&h_(au,c),lu!==null&&h_(lu,c),cu!==null&&h_(cu,c),B_.forEach(a),N_.forEach(a),m=0;m<iu.length;m++)x=iu[m],x.blockedOn===c&&(x.blockedOn=null);for(;0<iu.length&&(m=iu[0],m.blockedOn===null);)EC(m),m.blockedOn===null&&iu.shift()}var Zf=fc.ReactCurrentBatchConfig,$0=!0;function sD(c,a,m,x){var S=Jn,P=Zf.transition;Zf.transition=null;try{Jn=1,Ab(c,a,m,x)}finally{Jn=S,Zf.transition=P}}function aD(c,a,m,x){var S=Jn,P=Zf.transition;Zf.transition=null;try{Jn=4,Ab(c,a,m,x)}finally{Jn=S,Zf.transition=P}}function Ab(c,a,m,x){if($0){var S=Cw(c,a,m,x);if(S===null)H1(c,a,x,G0,m),bI(c,x);else if(rD(S,c,a,m,x))x.stopPropagation();else if(bI(c,x),a&4&&-1<nD.indexOf(c)){for(;S!==null;){var P=ng(S);if(P!==null&&wC(P),P=Cw(c,a,m,x),P===null&&H1(c,a,x,G0,m),P===S)break;S=P}S!==null&&x.stopPropagation()}else H1(c,a,x,null,m)}}var G0=null;function Cw(c,a,m,x){if(G0=null,c=Tb(x),c=Sh(c),c!==null)if(a=Dh(c),a===null)c=null;else if(m=a.tag,m===13){if(c=fC(a),c!==null)return c;c=null}else if(m===3){if(a.stateNode.current.memoizedState.isDehydrated)return a.tag===3?a.stateNode.containerInfo:null;c=null}else a!==c&&(c=null);return G0=c,null}function IC(c){switch(c){case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 1;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"toggle":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 4;case"message":switch(Zz()){case Sb:return 1;case gC:return 4;case U0:case Xz:return 16;case yC:return 536870912;default:return 16}default:return 16}}var ou=null,Cb=null,P0=null;function AC(){if(P0)return P0;var c,a=Cb,m=a.length,x,S="value"in ou?ou.value:ou.textContent,P=S.length;for(c=0;c<m&&a[c]===S[c];c++);var O=m-c;for(x=1;x<=O&&a[m-x]===S[P-x];x++);return P0=S.slice(c,1<x?1-x:void 0)}function M0(c){var a=c.keyCode;return"charCode"in c?(c=c.charCode,c===0&&a===13&&(c=13)):c=a,c===10&&(c=13),32<=c||c===13?c:0}function d0(){return!0}function SI(){return!1}function Rs(c){function a(m,x,S,P,O){this._reactName=m,this._targetInst=S,this.type=x,this.nativeEvent=P,this.target=O,this.currentTarget=null;for(var s in c)c.hasOwnProperty(s)&&(m=c[s],this[s]=m?m(P):P[s]);return this.isDefaultPrevented=(P.defaultPrevented!=null?P.defaultPrevented:P.returnValue===!1)?d0:SI,this.isPropagationStopped=SI,this}return kr(a.prototype,{preventDefault:function(){this.defaultPrevented=!0;var m=this.nativeEvent;m&&(m.preventDefault?m.preventDefault():typeof m.returnValue!="unknown"&&(m.returnValue=!1),this.isDefaultPrevented=d0)},stopPropagation:function(){var m=this.nativeEvent;m&&(m.stopPropagation?m.stopPropagation():typeof m.cancelBubble!="unknown"&&(m.cancelBubble=!0),this.isPropagationStopped=d0)},persist:function(){},isPersistent:d0}),a}var sp={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(c){return c.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},Pb=Rs(sp),ig=kr({},sp,{view:0,detail:0}),lD=Rs(ig),O1,F1,d_,dv=kr({},ig,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:Mb,button:0,buttons:0,relatedTarget:function(c){return c.relatedTarget===void 0?c.fromElement===c.srcElement?c.toElement:c.fromElement:c.relatedTarget},movementX:function(c){return"movementX"in c?c.movementX:(c!==d_&&(d_&&c.type==="mousemove"?(O1=c.screenX-d_.screenX,F1=c.screenY-d_.screenY):F1=O1=0,d_=c),O1)},movementY:function(c){return"movementY"in c?c.movementY:F1}}),EI=Rs(dv),cD=kr({},dv,{dataTransfer:0}),uD=Rs(cD),hD=kr({},ig,{relatedTarget:0}),B1=Rs(hD),dD=kr({},sp,{animationName:0,elapsedTime:0,pseudoElement:0}),fD=Rs(dD),pD=kr({},sp,{clipboardData:function(c){return"clipboardData"in c?c.clipboardData:window.clipboardData}}),mD=Rs(pD),_D=kr({},sp,{data:0}),II=Rs(_D),gD={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},yD={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},vD={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function xD(c){var a=this.nativeEvent;return a.getModifierState?a.getModifierState(c):(c=vD[c])?!!a[c]:!1}function Mb(){return xD}var wD=kr({},ig,{key:function(c){if(c.key){var a=gD[c.key]||c.key;if(a!=="Unidentified")return a}return c.type==="keypress"?(c=M0(c),c===13?"Enter":String.fromCharCode(c)):c.type==="keydown"||c.type==="keyup"?yD[c.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:Mb,charCode:function(c){return c.type==="keypress"?M0(c):0},keyCode:function(c){return c.type==="keydown"||c.type==="keyup"?c.keyCode:0},which:function(c){return c.type==="keypress"?M0(c):c.type==="keydown"||c.type==="keyup"?c.keyCode:0}}),bD=Rs(wD),TD=kr({},dv,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0}),AI=Rs(TD),SD=kr({},ig,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:Mb}),ED=Rs(SD),ID=kr({},sp,{propertyName:0,elapsedTime:0,pseudoElement:0}),AD=Rs(ID),CD=kr({},dv,{deltaX:function(c){return"deltaX"in c?c.deltaX:"wheelDeltaX"in c?-c.wheelDeltaX:0},deltaY:function(c){return"deltaY"in c?c.deltaY:"wheelDeltaY"in c?-c.wheelDeltaY:"wheelDelta"in c?-c.wheelDelta:0},deltaZ:0,deltaMode:0}),PD=Rs(CD),MD=[9,13,27,32],Rb=cc&&"CompositionEvent"in window,E_=null;cc&&"documentMode"in document&&(E_=document.documentMode);var RD=cc&&"TextEvent"in window&&!E_,CC=cc&&(!Rb||E_&&8<E_&&11>=E_),CI=" ",PI=!1;function PC(c,a){switch(c){case"keyup":return MD.indexOf(a.keyCode)!==-1;case"keydown":return a.keyCode!==229;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function MC(c){return c=c.detail,typeof c=="object"&&"data"in c?c.data:null}var Df=!1;function kD(c,a){switch(c){case"compositionend":return MC(a);case"keypress":return a.which!==32?null:(PI=!0,CI);case"textInput":return c=a.data,c===CI&&PI?null:c;default:return null}}function LD(c,a){if(Df)return c==="compositionend"||!Rb&&PC(c,a)?(c=AC(),P0=Cb=ou=null,Df=!1,c):null;switch(c){case"paste":return null;case"keypress":if(!(a.ctrlKey||a.altKey||a.metaKey)||a.ctrlKey&&a.altKey){if(a.char&&1<a.char.length)return a.char;if(a.which)return String.fromCharCode(a.which)}return null;case"compositionend":return CC&&a.locale!=="ko"?null:a.data;default:return null}}var zD={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function MI(c){var a=c&&c.nodeName&&c.nodeName.toLowerCase();return a==="input"?!!zD[c.type]:a==="textarea"}function RC(c,a,m,x){lC(x),a=H0(a,"onChange"),0<a.length&&(m=new Pb("onChange","change",null,m,x),c.push({event:m,listeners:a}))}var I_=null,U_=null;function DD(c){VC(c,0)}function fv(c){var a=Bf(c);if(tC(a))return c}function OD(c,a){if(c==="change")return a}var kC=!1;if(cc){var N1;if(cc){var j1="oninput"in document;if(!j1){var RI=document.createElement("div");RI.setAttribute("oninput","return;"),j1=typeof RI.oninput=="function"}N1=j1}else N1=!1;kC=N1&&(!document.documentMode||9<document.documentMode)}function kI(){I_&&(I_.detachEvent("onpropertychange",LC),U_=I_=null)}function LC(c){if(c.propertyName==="value"&&fv(U_)){var a=[];RC(a,U_,c,Tb(c)),dC(DD,a)}}function FD(c,a,m){c==="focusin"?(kI(),I_=a,U_=m,I_.attachEvent("onpropertychange",LC)):c==="focusout"&&kI()}function BD(c){if(c==="selectionchange"||c==="keyup"||c==="keydown")return fv(U_)}function ND(c,a){if(c==="click")return fv(a)}function jD(c,a){if(c==="input"||c==="change")return fv(a)}function UD(c,a){return c===a&&(c!==0||1/c===1/a)||c!==c&&a!==a}var Na=typeof Object.is=="function"?Object.is:UD;function V_(c,a){if(Na(c,a))return!0;if(typeof c!="object"||c===null||typeof a!="object"||a===null)return!1;var m=Object.keys(c),x=Object.keys(a);if(m.length!==x.length)return!1;for(x=0;x<m.length;x++){var S=m[x];if(!uw.call(a,S)||!Na(c[S],a[S]))return!1}return!0}function LI(c){for(;c&&c.firstChild;)c=c.firstChild;return c}function zI(c,a){var m=LI(c);c=0;for(var x;m;){if(m.nodeType===3){if(x=c+m.textContent.length,c<=a&&x>=a)return{node:m,offset:a-c};c=x}e:{for(;m;){if(m.nextSibling){m=m.nextSibling;break e}m=m.parentNode}m=void 0}m=LI(m)}}function zC(c,a){return c&&a?c===a?!0:c&&c.nodeType===3?!1:a&&a.nodeType===3?zC(c,a.parentNode):"contains"in c?c.contains(a):c.compareDocumentPosition?!!(c.compareDocumentPosition(a)&16):!1:!1}function DC(){for(var c=window,a=B0();a instanceof c.HTMLIFrameElement;){try{var m=typeof a.contentWindow.location.href=="string"}catch{m=!1}if(m)c=a.contentWindow;else break;a=B0(c.document)}return a}function kb(c){var a=c&&c.nodeName&&c.nodeName.toLowerCase();return a&&(a==="input"&&(c.type==="text"||c.type==="search"||c.type==="tel"||c.type==="url"||c.type==="password")||a==="textarea"||c.contentEditable==="true")}function VD(c){var a=DC(),m=c.focusedElem,x=c.selectionRange;if(a!==m&&m&&m.ownerDocument&&zC(m.ownerDocument.documentElement,m)){if(x!==null&&kb(m)){if(a=x.start,c=x.end,c===void 0&&(c=a),"selectionStart"in m)m.selectionStart=a,m.selectionEnd=Math.min(c,m.value.length);else if(c=(a=m.ownerDocument||document)&&a.defaultView||window,c.getSelection){c=c.getSelection();var S=m.textContent.length,P=Math.min(x.start,S);x=x.end===void 0?P:Math.min(x.end,S),!c.extend&&P>x&&(S=x,x=P,P=S),S=zI(m,P);var O=zI(m,x);S&&O&&(c.rangeCount!==1||c.anchorNode!==S.node||c.anchorOffset!==S.offset||c.focusNode!==O.node||c.focusOffset!==O.offset)&&(a=a.createRange(),a.setStart(S.node,S.offset),c.removeAllRanges(),P>x?(c.addRange(a),c.extend(O.node,O.offset)):(a.setEnd(O.node,O.offset),c.addRange(a)))}}for(a=[],c=m;c=c.parentNode;)c.nodeType===1&&a.push({element:c,left:c.scrollLeft,top:c.scrollTop});for(typeof m.focus=="function"&&m.focus(),m=0;m<a.length;m++)c=a[m],c.element.scrollLeft=c.left,c.element.scrollTop=c.top}}var $D=cc&&"documentMode"in document&&11>=document.documentMode,Of=null,Pw=null,A_=null,Mw=!1;function DI(c,a,m){var x=m.window===m?m.document:m.nodeType===9?m:m.ownerDocument;Mw||Of==null||Of!==B0(x)||(x=Of,"selectionStart"in x&&kb(x)?x={start:x.selectionStart,end:x.selectionEnd}:(x=(x.ownerDocument&&x.ownerDocument.defaultView||window).getSelection(),x={anchorNode:x.anchorNode,anchorOffset:x.anchorOffset,focusNode:x.focusNode,focusOffset:x.focusOffset}),A_&&V_(A_,x)||(A_=x,x=H0(Pw,"onSelect"),0<x.length&&(a=new Pb("onSelect","select",null,a,m),c.push({event:a,listeners:x}),a.target=Of)))}function f0(c,a){var m={};return m[c.toLowerCase()]=a.toLowerCase(),m["Webkit"+c]="webkit"+a,m["Moz"+c]="moz"+a,m}var Ff={animationend:f0("Animation","AnimationEnd"),animationiteration:f0("Animation","AnimationIteration"),animationstart:f0("Animation","AnimationStart"),transitionend:f0("Transition","TransitionEnd")},U1={},OC={};cc&&(OC=document.createElement("div").style,"AnimationEvent"in window||(delete Ff.animationend.animation,delete Ff.animationiteration.animation,delete Ff.animationstart.animation),"TransitionEvent"in window||delete Ff.transitionend.transition);function pv(c){if(U1[c])return U1[c];if(!Ff[c])return c;var a=Ff[c],m;for(m in a)if(a.hasOwnProperty(m)&&m in OC)return U1[c]=a[m];return c}var FC=pv("animationend"),BC=pv("animationiteration"),NC=pv("animationstart"),jC=pv("transitionend"),UC=new Map,OI="abort auxClick cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");function gu(c,a){UC.set(c,a),zh(a,[c])}for(var V1=0;V1<OI.length;V1++){var $1=OI[V1],GD=$1.toLowerCase(),HD=$1[0].toUpperCase()+$1.slice(1);gu(GD,"on"+HD)}gu(FC,"onAnimationEnd");gu(BC,"onAnimationIteration");gu(NC,"onAnimationStart");gu("dblclick","onDoubleClick");gu("focusin","onFocus");gu("focusout","onBlur");gu(jC,"onTransitionEnd");Yf("onMouseEnter",["mouseout","mouseover"]);Yf("onMouseLeave",["mouseout","mouseover"]);Yf("onPointerEnter",["pointerout","pointerover"]);Yf("onPointerLeave",["pointerout","pointerover"]);zh("onChange","change click focusin focusout input keydown keyup selectionchange".split(" "));zh("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" "));zh("onBeforeInput",["compositionend","keypress","textInput","paste"]);zh("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" "));zh("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" "));zh("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var x_="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),qD=new Set("cancel close invalid load scroll toggle".split(" ").concat(x_));function FI(c,a,m){var x=c.type||"unknown-event";c.currentTarget=m,Gz(x,a,void 0,c),c.currentTarget=null}function VC(c,a){a=(a&4)!==0;for(var m=0;m<c.length;m++){var x=c[m],S=x.event;x=x.listeners;e:{var P=void 0;if(a)for(var O=x.length-1;0<=O;O--){var s=x[O],Z=s.instance,Q=s.currentTarget;if(s=s.listener,Z!==P&&S.isPropagationStopped())break e;FI(S,s,Q),P=Z}else for(O=0;O<x.length;O++){if(s=x[O],Z=s.instance,Q=s.currentTarget,s=s.listener,Z!==P&&S.isPropagationStopped())break e;FI(S,s,Q),P=Z}}}if(j0)throw c=Ew,j0=!1,Ew=null,c}function yr(c,a){var m=a[Dw];m===void 0&&(m=a[Dw]=new Set);var x=c+"__bubble";m.has(x)||($C(a,c,2,!1),m.add(x))}function G1(c,a,m){var x=0;a&&(x|=4),$C(m,c,x,a)}var p0="_reactListening"+Math.random().toString(36).slice(2);function $_(c){if(!c[p0]){c[p0]=!0,KA.forEach(function(m){m!=="selectionchange"&&(qD.has(m)||G1(m,!1,c),G1(m,!0,c))});var a=c.nodeType===9?c:c.ownerDocument;a===null||a[p0]||(a[p0]=!0,G1("selectionchange",!1,a))}}function $C(c,a,m,x){switch(IC(a)){case 1:var S=sD;break;case 4:S=aD;break;default:S=Ab}m=S.bind(null,a,m,c),S=void 0,!Sw||a!=="touchstart"&&a!=="touchmove"&&a!=="wheel"||(S=!0),x?S!==void 0?c.addEventListener(a,m,{capture:!0,passive:S}):c.addEventListener(a,m,!0):S!==void 0?c.addEventListener(a,m,{passive:S}):c.addEventListener(a,m,!1)}function H1(c,a,m,x,S){var P=x;if(!(a&1)&&!(a&2)&&x!==null)e:for(;;){if(x===null)return;var O=x.tag;if(O===3||O===4){var s=x.stateNode.containerInfo;if(s===S||s.nodeType===8&&s.parentNode===S)break;if(O===4)for(O=x.return;O!==null;){var Z=O.tag;if((Z===3||Z===4)&&(Z=O.stateNode.containerInfo,Z===S||Z.nodeType===8&&Z.parentNode===S))return;O=O.return}for(;s!==null;){if(O=Sh(s),O===null)return;if(Z=O.tag,Z===5||Z===6){x=P=O;continue e}s=s.parentNode}}x=x.return}dC(function(){var Q=P,me=Tb(m),Ee=[];e:{var De=UC.get(c);if(De!==void 0){var Xe=Pb,mt=c;switch(c){case"keypress":if(M0(m)===0)break e;case"keydown":case"keyup":Xe=bD;break;case"focusin":mt="focus",Xe=B1;break;case"focusout":mt="blur",Xe=B1;break;case"beforeblur":case"afterblur":Xe=B1;break;case"click":if(m.button===2)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":Xe=EI;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":Xe=uD;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":Xe=ED;break;case FC:case BC:case NC:Xe=fD;break;case jC:Xe=AD;break;case"scroll":Xe=lD;break;case"wheel":Xe=PD;break;case"copy":case"cut":case"paste":Xe=mD;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":Xe=AI}var We=(a&4)!==0,ct=!We&&c==="scroll",Me=We?De!==null?De+"Capture":null:De;We=[];for(var xe=Q,Pe;xe!==null;){Pe=xe;var Ze=Pe.stateNode;if(Pe.tag===5&&Ze!==null&&(Pe=Ze,Me!==null&&(Ze=F_(xe,Me),Ze!=null&&We.push(G_(xe,Ze,Pe)))),ct)break;xe=xe.return}0<We.length&&(De=new Xe(De,mt,null,m,me),Ee.push({event:De,listeners:We}))}}if(!(a&7)){e:{if(De=c==="mouseover"||c==="pointerover",Xe=c==="mouseout"||c==="pointerout",De&&m!==bw&&(mt=m.relatedTarget||m.fromElement)&&(Sh(mt)||mt[uc]))break e;if((Xe||De)&&(De=me.window===me?me:(De=me.ownerDocument)?De.defaultView||De.parentWindow:window,Xe?(mt=m.relatedTarget||m.toElement,Xe=Q,mt=mt?Sh(mt):null,mt!==null&&(ct=Dh(mt),mt!==ct||mt.tag!==5&&mt.tag!==6)&&(mt=null)):(Xe=null,mt=Q),Xe!==mt)){if(We=EI,Ze="onMouseLeave",Me="onMouseEnter",xe="mouse",(c==="pointerout"||c==="pointerover")&&(We=AI,Ze="onPointerLeave",Me="onPointerEnter",xe="pointer"),ct=Xe==null?De:Bf(Xe),Pe=mt==null?De:Bf(mt),De=new We(Ze,xe+"leave",Xe,m,me),De.target=ct,De.relatedTarget=Pe,Ze=null,Sh(me)===Q&&(We=new We(Me,xe+"enter",mt,m,me),We.target=Pe,We.relatedTarget=ct,Ze=We),ct=Ze,Xe&&mt)t:{for(We=Xe,Me=mt,xe=0,Pe=We;Pe;Pe=Ef(Pe))xe++;for(Pe=0,Ze=Me;Ze;Ze=Ef(Ze))Pe++;for(;0<xe-Pe;)We=Ef(We),xe--;for(;0<Pe-xe;)Me=Ef(Me),Pe--;for(;xe--;){if(We===Me||Me!==null&&We===Me.alternate)break t;We=Ef(We),Me=Ef(Me)}We=null}else We=null;Xe!==null&&BI(Ee,De,Xe,We,!1),mt!==null&&ct!==null&&BI(Ee,ct,mt,We,!0)}}e:{if(De=Q?Bf(Q):window,Xe=De.nodeName&&De.nodeName.toLowerCase(),Xe==="select"||Xe==="input"&&De.type==="file")var Ct=OD;else if(MI(De))if(kC)Ct=jD;else{Ct=BD;var kt=FD}else(Xe=De.nodeName)&&Xe.toLowerCase()==="input"&&(De.type==="checkbox"||De.type==="radio")&&(Ct=ND);if(Ct&&(Ct=Ct(c,Q))){RC(Ee,Ct,m,me);break e}kt&&kt(c,De,Q),c==="focusout"&&(kt=De._wrapperState)&&kt.controlled&&De.type==="number"&&gw(De,"number",De.value)}switch(kt=Q?Bf(Q):window,c){case"focusin":(MI(kt)||kt.contentEditable==="true")&&(Of=kt,Pw=Q,A_=null);break;case"focusout":A_=Pw=Of=null;break;case"mousedown":Mw=!0;break;case"contextmenu":case"mouseup":case"dragend":Mw=!1,DI(Ee,m,me);break;case"selectionchange":if($D)break;case"keydown":case"keyup":DI(Ee,m,me)}var zt;if(Rb)e:{switch(c){case"compositionstart":var Zt="onCompositionStart";break e;case"compositionend":Zt="onCompositionEnd";break e;case"compositionupdate":Zt="onCompositionUpdate";break e}Zt=void 0}else Df?PC(c,m)&&(Zt="onCompositionEnd"):c==="keydown"&&m.keyCode===229&&(Zt="onCompositionStart");Zt&&(CC&&m.locale!=="ko"&&(Df||Zt!=="onCompositionStart"?Zt==="onCompositionEnd"&&Df&&(zt=AC()):(ou=me,Cb="value"in ou?ou.value:ou.textContent,Df=!0)),kt=H0(Q,Zt),0<kt.length&&(Zt=new II(Zt,c,null,m,me),Ee.push({event:Zt,listeners:kt}),zt?Zt.data=zt:(zt=MC(m),zt!==null&&(Zt.data=zt)))),(zt=RD?kD(c,m):LD(c,m))&&(Q=H0(Q,"onBeforeInput"),0<Q.length&&(me=new II("onBeforeInput","beforeinput",null,m,me),Ee.push({event:me,listeners:Q}),me.data=zt))}VC(Ee,a)})}function G_(c,a,m){return{instance:c,listener:a,currentTarget:m}}function H0(c,a){for(var m=a+"Capture",x=[];c!==null;){var S=c,P=S.stateNode;S.tag===5&&P!==null&&(S=P,P=F_(c,m),P!=null&&x.unshift(G_(c,P,S)),P=F_(c,a),P!=null&&x.push(G_(c,P,S))),c=c.return}return x}function Ef(c){if(c===null)return null;do c=c.return;while(c&&c.tag!==5);return c||null}function BI(c,a,m,x,S){for(var P=a._reactName,O=[];m!==null&&m!==x;){var s=m,Z=s.alternate,Q=s.stateNode;if(Z!==null&&Z===x)break;s.tag===5&&Q!==null&&(s=Q,S?(Z=F_(m,P),Z!=null&&O.unshift(G_(m,Z,s))):S||(Z=F_(m,P),Z!=null&&O.push(G_(m,Z,s)))),m=m.return}O.length!==0&&c.push({event:a,listeners:O})}var WD=/\r\n?/g,ZD=/\u0000|\uFFFD/g;function NI(c){return(typeof c=="string"?c:""+c).replace(WD,`
`).replace(ZD,"")}function m0(c,a,m){if(a=NI(a),NI(c)!==a&&m)throw Error(Vt(425))}function q0(){}var Rw=null,kw=null;function Lw(c,a){return c==="textarea"||c==="noscript"||typeof a.children=="string"||typeof a.children=="number"||typeof a.dangerouslySetInnerHTML=="object"&&a.dangerouslySetInnerHTML!==null&&a.dangerouslySetInnerHTML.__html!=null}var zw=typeof setTimeout=="function"?setTimeout:void 0,XD=typeof clearTimeout=="function"?clearTimeout:void 0,jI=typeof Promise=="function"?Promise:void 0,KD=typeof queueMicrotask=="function"?queueMicrotask:typeof jI<"u"?function(c){return jI.resolve(null).then(c).catch(YD)}:zw;function YD(c){setTimeout(function(){throw c})}function q1(c,a){var m=a,x=0;do{var S=m.nextSibling;if(c.removeChild(m),S&&S.nodeType===8)if(m=S.data,m==="/$"){if(x===0){c.removeChild(S),j_(a);return}x--}else m!=="$"&&m!=="$?"&&m!=="$!"||x++;m=S}while(m);j_(a)}function uu(c){for(;c!=null;c=c.nextSibling){var a=c.nodeType;if(a===1||a===3)break;if(a===8){if(a=c.data,a==="$"||a==="$!"||a==="$?")break;if(a==="/$")return null}}return c}function UI(c){c=c.previousSibling;for(var a=0;c;){if(c.nodeType===8){var m=c.data;if(m==="$"||m==="$!"||m==="$?"){if(a===0)return c;a--}else m==="/$"&&a++}c=c.previousSibling}return null}var ap=Math.random().toString(36).slice(2),yl="__reactFiber$"+ap,H_="__reactProps$"+ap,uc="__reactContainer$"+ap,Dw="__reactEvents$"+ap,JD="__reactListeners$"+ap,QD="__reactHandles$"+ap;function Sh(c){var a=c[yl];if(a)return a;for(var m=c.parentNode;m;){if(a=m[uc]||m[yl]){if(m=a.alternate,a.child!==null||m!==null&&m.child!==null)for(c=UI(c);c!==null;){if(m=c[yl])return m;c=UI(c)}return a}c=m,m=c.parentNode}return null}function ng(c){return c=c[yl]||c[uc],!c||c.tag!==5&&c.tag!==6&&c.tag!==13&&c.tag!==3?null:c}function Bf(c){if(c.tag===5||c.tag===6)return c.stateNode;throw Error(Vt(33))}function mv(c){return c[H_]||null}var Ow=[],Nf=-1;function yu(c){return{current:c}}function vr(c){0>Nf||(c.current=Ow[Nf],Ow[Nf]=null,Nf--)}function fr(c,a){Nf++,Ow[Nf]=c.current,c.current=a}var _u={},ko=yu(_u),ls=yu(!1),Ph=_u;function Jf(c,a){var m=c.type.contextTypes;if(!m)return _u;var x=c.stateNode;if(x&&x.__reactInternalMemoizedUnmaskedChildContext===a)return x.__reactInternalMemoizedMaskedChildContext;var S={},P;for(P in m)S[P]=a[P];return x&&(c=c.stateNode,c.__reactInternalMemoizedUnmaskedChildContext=a,c.__reactInternalMemoizedMaskedChildContext=S),S}function cs(c){return c=c.childContextTypes,c!=null}function W0(){vr(ls),vr(ko)}function VI(c,a,m){if(ko.current!==_u)throw Error(Vt(168));fr(ko,a),fr(ls,m)}function GC(c,a,m){var x=c.stateNode;if(a=a.childContextTypes,typeof x.getChildContext!="function")return m;x=x.getChildContext();for(var S in x)if(!(S in a))throw Error(Vt(108,Fz(c)||"Unknown",S));return kr({},m,x)}function Z0(c){return c=(c=c.stateNode)&&c.__reactInternalMemoizedMergedChildContext||_u,Ph=ko.current,fr(ko,c),fr(ls,ls.current),!0}function $I(c,a,m){var x=c.stateNode;if(!x)throw Error(Vt(169));m?(c=GC(c,a,Ph),x.__reactInternalMemoizedMergedChildContext=c,vr(ls),vr(ko),fr(ko,c)):vr(ls),fr(ls,m)}var oc=null,_v=!1,W1=!1;function HC(c){oc===null?oc=[c]:oc.push(c)}function eO(c){_v=!0,HC(c)}function vu(){if(!W1&&oc!==null){W1=!0;var c=0,a=Jn;try{var m=oc;for(Jn=1;c<m.length;c++){var x=m[c];do x=x(!0);while(x!==null)}oc=null,_v=!1}catch(S){throw oc!==null&&(oc=oc.slice(c+1)),_C(Sb,vu),S}finally{Jn=a,W1=!1}}return null}var jf=[],Uf=0,X0=null,K0=0,Ks=[],Ys=0,Mh=null,sc=1,ac="";function xh(c,a){jf[Uf++]=K0,jf[Uf++]=X0,X0=c,K0=a}function qC(c,a,m){Ks[Ys++]=sc,Ks[Ys++]=ac,Ks[Ys++]=Mh,Mh=c;var x=sc;c=ac;var S=32-Fa(x)-1;x&=~(1<<S),m+=1;var P=32-Fa(a)+S;if(30<P){var O=S-S%5;P=(x&(1<<O)-1).toString(32),x>>=O,S-=O,sc=1<<32-Fa(a)+S|m<<S|x,ac=P+c}else sc=1<<P|m<<S|x,ac=c}function Lb(c){c.return!==null&&(xh(c,1),qC(c,1,0))}function zb(c){for(;c===X0;)X0=jf[--Uf],jf[Uf]=null,K0=jf[--Uf],jf[Uf]=null;for(;c===Mh;)Mh=Ks[--Ys],Ks[Ys]=null,ac=Ks[--Ys],Ks[Ys]=null,sc=Ks[--Ys],Ks[Ys]=null}var As=null,Is=null,Sr=!1,Oa=null;function WC(c,a){var m=Js(5,null,null,0);m.elementType="DELETED",m.stateNode=a,m.return=c,a=c.deletions,a===null?(c.deletions=[m],c.flags|=16):a.push(m)}function GI(c,a){switch(c.tag){case 5:var m=c.type;return a=a.nodeType!==1||m.toLowerCase()!==a.nodeName.toLowerCase()?null:a,a!==null?(c.stateNode=a,As=c,Is=uu(a.firstChild),!0):!1;case 6:return a=c.pendingProps===""||a.nodeType!==3?null:a,a!==null?(c.stateNode=a,As=c,Is=null,!0):!1;case 13:return a=a.nodeType!==8?null:a,a!==null?(m=Mh!==null?{id:sc,overflow:ac}:null,c.memoizedState={dehydrated:a,treeContext:m,retryLane:1073741824},m=Js(18,null,null,0),m.stateNode=a,m.return=c,c.child=m,As=c,Is=null,!0):!1;default:return!1}}function Fw(c){return(c.mode&1)!==0&&(c.flags&128)===0}function Bw(c){if(Sr){var a=Is;if(a){var m=a;if(!GI(c,a)){if(Fw(c))throw Error(Vt(418));a=uu(m.nextSibling);var x=As;a&&GI(c,a)?WC(x,m):(c.flags=c.flags&-4097|2,Sr=!1,As=c)}}else{if(Fw(c))throw Error(Vt(418));c.flags=c.flags&-4097|2,Sr=!1,As=c}}}function HI(c){for(c=c.return;c!==null&&c.tag!==5&&c.tag!==3&&c.tag!==13;)c=c.return;As=c}function _0(c){if(c!==As)return!1;if(!Sr)return HI(c),Sr=!0,!1;var a;if((a=c.tag!==3)&&!(a=c.tag!==5)&&(a=c.type,a=a!=="head"&&a!=="body"&&!Lw(c.type,c.memoizedProps)),a&&(a=Is)){if(Fw(c))throw ZC(),Error(Vt(418));for(;a;)WC(c,a),a=uu(a.nextSibling)}if(HI(c),c.tag===13){if(c=c.memoizedState,c=c!==null?c.dehydrated:null,!c)throw Error(Vt(317));e:{for(c=c.nextSibling,a=0;c;){if(c.nodeType===8){var m=c.data;if(m==="/$"){if(a===0){Is=uu(c.nextSibling);break e}a--}else m!=="$"&&m!=="$!"&&m!=="$?"||a++}c=c.nextSibling}Is=null}}else Is=As?uu(c.stateNode.nextSibling):null;return!0}function ZC(){for(var c=Is;c;)c=uu(c.nextSibling)}function Qf(){Is=As=null,Sr=!1}function Db(c){Oa===null?Oa=[c]:Oa.push(c)}var tO=fc.ReactCurrentBatchConfig;function f_(c,a,m){if(c=m.ref,c!==null&&typeof c!="function"&&typeof c!="object"){if(m._owner){if(m=m._owner,m){if(m.tag!==1)throw Error(Vt(309));var x=m.stateNode}if(!x)throw Error(Vt(147,c));var S=x,P=""+c;return a!==null&&a.ref!==null&&typeof a.ref=="function"&&a.ref._stringRef===P?a.ref:(a=function(O){var s=S.refs;O===null?delete s[P]:s[P]=O},a._stringRef=P,a)}if(typeof c!="string")throw Error(Vt(284));if(!m._owner)throw Error(Vt(290,c))}return c}function g0(c,a){throw c=Object.prototype.toString.call(a),Error(Vt(31,c==="[object Object]"?"object with keys {"+Object.keys(a).join(", ")+"}":c))}function qI(c){var a=c._init;return a(c._payload)}function XC(c){function a(Me,xe){if(c){var Pe=Me.deletions;Pe===null?(Me.deletions=[xe],Me.flags|=16):Pe.push(xe)}}function m(Me,xe){if(!c)return null;for(;xe!==null;)a(Me,xe),xe=xe.sibling;return null}function x(Me,xe){for(Me=new Map;xe!==null;)xe.key!==null?Me.set(xe.key,xe):Me.set(xe.index,xe),xe=xe.sibling;return Me}function S(Me,xe){return Me=pu(Me,xe),Me.index=0,Me.sibling=null,Me}function P(Me,xe,Pe){return Me.index=Pe,c?(Pe=Me.alternate,Pe!==null?(Pe=Pe.index,Pe<xe?(Me.flags|=2,xe):Pe):(Me.flags|=2,xe)):(Me.flags|=1048576,xe)}function O(Me){return c&&Me.alternate===null&&(Me.flags|=2),Me}function s(Me,xe,Pe,Ze){return xe===null||xe.tag!==6?(xe=ew(Pe,Me.mode,Ze),xe.return=Me,xe):(xe=S(xe,Pe),xe.return=Me,xe)}function Z(Me,xe,Pe,Ze){var Ct=Pe.type;return Ct===zf?me(Me,xe,Pe.props.children,Ze,Pe.key):xe!==null&&(xe.elementType===Ct||typeof Ct=="object"&&Ct!==null&&Ct.$$typeof===eu&&qI(Ct)===xe.type)?(Ze=S(xe,Pe.props),Ze.ref=f_(Me,xe,Pe),Ze.return=Me,Ze):(Ze=F0(Pe.type,Pe.key,Pe.props,null,Me.mode,Ze),Ze.ref=f_(Me,xe,Pe),Ze.return=Me,Ze)}function Q(Me,xe,Pe,Ze){return xe===null||xe.tag!==4||xe.stateNode.containerInfo!==Pe.containerInfo||xe.stateNode.implementation!==Pe.implementation?(xe=tw(Pe,Me.mode,Ze),xe.return=Me,xe):(xe=S(xe,Pe.children||[]),xe.return=Me,xe)}function me(Me,xe,Pe,Ze,Ct){return xe===null||xe.tag!==7?(xe=Ch(Pe,Me.mode,Ze,Ct),xe.return=Me,xe):(xe=S(xe,Pe),xe.return=Me,xe)}function Ee(Me,xe,Pe){if(typeof xe=="string"&&xe!==""||typeof xe=="number")return xe=ew(""+xe,Me.mode,Pe),xe.return=Me,xe;if(typeof xe=="object"&&xe!==null){switch(xe.$$typeof){case s0:return Pe=F0(xe.type,xe.key,xe.props,null,Me.mode,Pe),Pe.ref=f_(Me,null,xe),Pe.return=Me,Pe;case Lf:return xe=tw(xe,Me.mode,Pe),xe.return=Me,xe;case eu:var Ze=xe._init;return Ee(Me,Ze(xe._payload),Pe)}if(y_(xe)||l_(xe))return xe=Ch(xe,Me.mode,Pe,null),xe.return=Me,xe;g0(Me,xe)}return null}function De(Me,xe,Pe,Ze){var Ct=xe!==null?xe.key:null;if(typeof Pe=="string"&&Pe!==""||typeof Pe=="number")return Ct!==null?null:s(Me,xe,""+Pe,Ze);if(typeof Pe=="object"&&Pe!==null){switch(Pe.$$typeof){case s0:return Pe.key===Ct?Z(Me,xe,Pe,Ze):null;case Lf:return Pe.key===Ct?Q(Me,xe,Pe,Ze):null;case eu:return Ct=Pe._init,De(Me,xe,Ct(Pe._payload),Ze)}if(y_(Pe)||l_(Pe))return Ct!==null?null:me(Me,xe,Pe,Ze,null);g0(Me,Pe)}return null}function Xe(Me,xe,Pe,Ze,Ct){if(typeof Ze=="string"&&Ze!==""||typeof Ze=="number")return Me=Me.get(Pe)||null,s(xe,Me,""+Ze,Ct);if(typeof Ze=="object"&&Ze!==null){switch(Ze.$$typeof){case s0:return Me=Me.get(Ze.key===null?Pe:Ze.key)||null,Z(xe,Me,Ze,Ct);case Lf:return Me=Me.get(Ze.key===null?Pe:Ze.key)||null,Q(xe,Me,Ze,Ct);case eu:var kt=Ze._init;return Xe(Me,xe,Pe,kt(Ze._payload),Ct)}if(y_(Ze)||l_(Ze))return Me=Me.get(Pe)||null,me(xe,Me,Ze,Ct,null);g0(xe,Ze)}return null}function mt(Me,xe,Pe,Ze){for(var Ct=null,kt=null,zt=xe,Zt=xe=0,mn=null;zt!==null&&Zt<Pe.length;Zt++){zt.index>Zt?(mn=zt,zt=null):mn=zt.sibling;var Xt=De(Me,zt,Pe[Zt],Ze);if(Xt===null){zt===null&&(zt=mn);break}c&&zt&&Xt.alternate===null&&a(Me,zt),xe=P(Xt,xe,Zt),kt===null?Ct=Xt:kt.sibling=Xt,kt=Xt,zt=mn}if(Zt===Pe.length)return m(Me,zt),Sr&&xh(Me,Zt),Ct;if(zt===null){for(;Zt<Pe.length;Zt++)zt=Ee(Me,Pe[Zt],Ze),zt!==null&&(xe=P(zt,xe,Zt),kt===null?Ct=zt:kt.sibling=zt,kt=zt);return Sr&&xh(Me,Zt),Ct}for(zt=x(Me,zt);Zt<Pe.length;Zt++)mn=Xe(zt,Me,Zt,Pe[Zt],Ze),mn!==null&&(c&&mn.alternate!==null&&zt.delete(mn.key===null?Zt:mn.key),xe=P(mn,xe,Zt),kt===null?Ct=mn:kt.sibling=mn,kt=mn);return c&&zt.forEach(function(Mi){return a(Me,Mi)}),Sr&&xh(Me,Zt),Ct}function We(Me,xe,Pe,Ze){var Ct=l_(Pe);if(typeof Ct!="function")throw Error(Vt(150));if(Pe=Ct.call(Pe),Pe==null)throw Error(Vt(151));for(var kt=Ct=null,zt=xe,Zt=xe=0,mn=null,Xt=Pe.next();zt!==null&&!Xt.done;Zt++,Xt=Pe.next()){zt.index>Zt?(mn=zt,zt=null):mn=zt.sibling;var Mi=De(Me,zt,Xt.value,Ze);if(Mi===null){zt===null&&(zt=mn);break}c&&zt&&Mi.alternate===null&&a(Me,zt),xe=P(Mi,xe,Zt),kt===null?Ct=Mi:kt.sibling=Mi,kt=Mi,zt=mn}if(Xt.done)return m(Me,zt),Sr&&xh(Me,Zt),Ct;if(zt===null){for(;!Xt.done;Zt++,Xt=Pe.next())Xt=Ee(Me,Xt.value,Ze),Xt!==null&&(xe=P(Xt,xe,Zt),kt===null?Ct=Xt:kt.sibling=Xt,kt=Xt);return Sr&&xh(Me,Zt),Ct}for(zt=x(Me,zt);!Xt.done;Zt++,Xt=Pe.next())Xt=Xe(zt,Me,Zt,Xt.value,Ze),Xt!==null&&(c&&Xt.alternate!==null&&zt.delete(Xt.key===null?Zt:Xt.key),xe=P(Xt,xe,Zt),kt===null?Ct=Xt:kt.sibling=Xt,kt=Xt);return c&&zt.forEach(function(or){return a(Me,or)}),Sr&&xh(Me,Zt),Ct}function ct(Me,xe,Pe,Ze){if(typeof Pe=="object"&&Pe!==null&&Pe.type===zf&&Pe.key===null&&(Pe=Pe.props.children),typeof Pe=="object"&&Pe!==null){switch(Pe.$$typeof){case s0:e:{for(var Ct=Pe.key,kt=xe;kt!==null;){if(kt.key===Ct){if(Ct=Pe.type,Ct===zf){if(kt.tag===7){m(Me,kt.sibling),xe=S(kt,Pe.props.children),xe.return=Me,Me=xe;break e}}else if(kt.elementType===Ct||typeof Ct=="object"&&Ct!==null&&Ct.$$typeof===eu&&qI(Ct)===kt.type){m(Me,kt.sibling),xe=S(kt,Pe.props),xe.ref=f_(Me,kt,Pe),xe.return=Me,Me=xe;break e}m(Me,kt);break}else a(Me,kt);kt=kt.sibling}Pe.type===zf?(xe=Ch(Pe.props.children,Me.mode,Ze,Pe.key),xe.return=Me,Me=xe):(Ze=F0(Pe.type,Pe.key,Pe.props,null,Me.mode,Ze),Ze.ref=f_(Me,xe,Pe),Ze.return=Me,Me=Ze)}return O(Me);case Lf:e:{for(kt=Pe.key;xe!==null;){if(xe.key===kt)if(xe.tag===4&&xe.stateNode.containerInfo===Pe.containerInfo&&xe.stateNode.implementation===Pe.implementation){m(Me,xe.sibling),xe=S(xe,Pe.children||[]),xe.return=Me,Me=xe;break e}else{m(Me,xe);break}else a(Me,xe);xe=xe.sibling}xe=tw(Pe,Me.mode,Ze),xe.return=Me,Me=xe}return O(Me);case eu:return kt=Pe._init,ct(Me,xe,kt(Pe._payload),Ze)}if(y_(Pe))return mt(Me,xe,Pe,Ze);if(l_(Pe))return We(Me,xe,Pe,Ze);g0(Me,Pe)}return typeof Pe=="string"&&Pe!==""||typeof Pe=="number"?(Pe=""+Pe,xe!==null&&xe.tag===6?(m(Me,xe.sibling),xe=S(xe,Pe),xe.return=Me,Me=xe):(m(Me,xe),xe=ew(Pe,Me.mode,Ze),xe.return=Me,Me=xe),O(Me)):m(Me,xe)}return ct}var ep=XC(!0),KC=XC(!1),Y0=yu(null),J0=null,Vf=null,Ob=null;function Fb(){Ob=Vf=J0=null}function Bb(c){var a=Y0.current;vr(Y0),c._currentValue=a}function Nw(c,a,m){for(;c!==null;){var x=c.alternate;if((c.childLanes&a)!==a?(c.childLanes|=a,x!==null&&(x.childLanes|=a)):x!==null&&(x.childLanes&a)!==a&&(x.childLanes|=a),c===m)break;c=c.return}}function Xf(c,a){J0=c,Ob=Vf=null,c=c.dependencies,c!==null&&c.firstContext!==null&&(c.lanes&a&&(as=!0),c.firstContext=null)}function ea(c){var a=c._currentValue;if(Ob!==c)if(c={context:c,memoizedValue:a,next:null},Vf===null){if(J0===null)throw Error(Vt(308));Vf=c,J0.dependencies={lanes:0,firstContext:c}}else Vf=Vf.next=c;return a}var Eh=null;function Nb(c){Eh===null?Eh=[c]:Eh.push(c)}function YC(c,a,m,x){var S=a.interleaved;return S===null?(m.next=m,Nb(a)):(m.next=S.next,S.next=m),a.interleaved=m,hc(c,x)}function hc(c,a){c.lanes|=a;var m=c.alternate;for(m!==null&&(m.lanes|=a),m=c,c=c.return;c!==null;)c.childLanes|=a,m=c.alternate,m!==null&&(m.childLanes|=a),m=c,c=c.return;return m.tag===3?m.stateNode:null}var tu=!1;function jb(c){c.updateQueue={baseState:c.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,interleaved:null,lanes:0},effects:null}}function JC(c,a){c=c.updateQueue,a.updateQueue===c&&(a.updateQueue={baseState:c.baseState,firstBaseUpdate:c.firstBaseUpdate,lastBaseUpdate:c.lastBaseUpdate,shared:c.shared,effects:c.effects})}function lc(c,a){return{eventTime:c,lane:a,tag:0,payload:null,callback:null,next:null}}function hu(c,a,m){var x=c.updateQueue;if(x===null)return null;if(x=x.shared,jn&2){var S=x.pending;return S===null?a.next=a:(a.next=S.next,S.next=a),x.pending=a,hc(c,m)}return S=x.interleaved,S===null?(a.next=a,Nb(x)):(a.next=S.next,S.next=a),x.interleaved=a,hc(c,m)}function R0(c,a,m){if(a=a.updateQueue,a!==null&&(a=a.shared,(m&4194240)!==0)){var x=a.lanes;x&=c.pendingLanes,m|=x,a.lanes=m,Eb(c,m)}}function WI(c,a){var m=c.updateQueue,x=c.alternate;if(x!==null&&(x=x.updateQueue,m===x)){var S=null,P=null;if(m=m.firstBaseUpdate,m!==null){do{var O={eventTime:m.eventTime,lane:m.lane,tag:m.tag,payload:m.payload,callback:m.callback,next:null};P===null?S=P=O:P=P.next=O,m=m.next}while(m!==null);P===null?S=P=a:P=P.next=a}else S=P=a;m={baseState:x.baseState,firstBaseUpdate:S,lastBaseUpdate:P,shared:x.shared,effects:x.effects},c.updateQueue=m;return}c=m.lastBaseUpdate,c===null?m.firstBaseUpdate=a:c.next=a,m.lastBaseUpdate=a}function Q0(c,a,m,x){var S=c.updateQueue;tu=!1;var P=S.firstBaseUpdate,O=S.lastBaseUpdate,s=S.shared.pending;if(s!==null){S.shared.pending=null;var Z=s,Q=Z.next;Z.next=null,O===null?P=Q:O.next=Q,O=Z;var me=c.alternate;me!==null&&(me=me.updateQueue,s=me.lastBaseUpdate,s!==O&&(s===null?me.firstBaseUpdate=Q:s.next=Q,me.lastBaseUpdate=Z))}if(P!==null){var Ee=S.baseState;O=0,me=Q=Z=null,s=P;do{var De=s.lane,Xe=s.eventTime;if((x&De)===De){me!==null&&(me=me.next={eventTime:Xe,lane:0,tag:s.tag,payload:s.payload,callback:s.callback,next:null});e:{var mt=c,We=s;switch(De=a,Xe=m,We.tag){case 1:if(mt=We.payload,typeof mt=="function"){Ee=mt.call(Xe,Ee,De);break e}Ee=mt;break e;case 3:mt.flags=mt.flags&-65537|128;case 0:if(mt=We.payload,De=typeof mt=="function"?mt.call(Xe,Ee,De):mt,De==null)break e;Ee=kr({},Ee,De);break e;case 2:tu=!0}}s.callback!==null&&s.lane!==0&&(c.flags|=64,De=S.effects,De===null?S.effects=[s]:De.push(s))}else Xe={eventTime:Xe,lane:De,tag:s.tag,payload:s.payload,callback:s.callback,next:null},me===null?(Q=me=Xe,Z=Ee):me=me.next=Xe,O|=De;if(s=s.next,s===null){if(s=S.shared.pending,s===null)break;De=s,s=De.next,De.next=null,S.lastBaseUpdate=De,S.shared.pending=null}}while(!0);if(me===null&&(Z=Ee),S.baseState=Z,S.firstBaseUpdate=Q,S.lastBaseUpdate=me,a=S.shared.interleaved,a!==null){S=a;do O|=S.lane,S=S.next;while(S!==a)}else P===null&&(S.shared.lanes=0);kh|=O,c.lanes=O,c.memoizedState=Ee}}function ZI(c,a,m){if(c=a.effects,a.effects=null,c!==null)for(a=0;a<c.length;a++){var x=c[a],S=x.callback;if(S!==null){if(x.callback=null,x=m,typeof S!="function")throw Error(Vt(191,S));S.call(x)}}}var rg={},xl=yu(rg),q_=yu(rg),W_=yu(rg);function Ih(c){if(c===rg)throw Error(Vt(174));return c}function Ub(c,a){switch(fr(W_,a),fr(q_,c),fr(xl,rg),c=a.nodeType,c){case 9:case 11:a=(a=a.documentElement)?a.namespaceURI:vw(null,"");break;default:c=c===8?a.parentNode:a,a=c.namespaceURI||null,c=c.tagName,a=vw(a,c)}vr(xl),fr(xl,a)}function tp(){vr(xl),vr(q_),vr(W_)}function QC(c){Ih(W_.current);var a=Ih(xl.current),m=vw(a,c.type);a!==m&&(fr(q_,c),fr(xl,m))}function Vb(c){q_.current===c&&(vr(xl),vr(q_))}var Mr=yu(0);function ev(c){for(var a=c;a!==null;){if(a.tag===13){var m=a.memoizedState;if(m!==null&&(m=m.dehydrated,m===null||m.data==="$?"||m.data==="$!"))return a}else if(a.tag===19&&a.memoizedProps.revealOrder!==void 0){if(a.flags&128)return a}else if(a.child!==null){a.child.return=a,a=a.child;continue}if(a===c)break;for(;a.sibling===null;){if(a.return===null||a.return===c)return null;a=a.return}a.sibling.return=a.return,a=a.sibling}return null}var Z1=[];function $b(){for(var c=0;c<Z1.length;c++)Z1[c]._workInProgressVersionPrimary=null;Z1.length=0}var k0=fc.ReactCurrentDispatcher,X1=fc.ReactCurrentBatchConfig,Rh=0,Rr=null,to=null,ho=null,tv=!1,C_=!1,Z_=0,iO=0;function Po(){throw Error(Vt(321))}function Gb(c,a){if(a===null)return!1;for(var m=0;m<a.length&&m<c.length;m++)if(!Na(c[m],a[m]))return!1;return!0}function Hb(c,a,m,x,S,P){if(Rh=P,Rr=a,a.memoizedState=null,a.updateQueue=null,a.lanes=0,k0.current=c===null||c.memoizedState===null?sO:aO,c=m(x,S),C_){P=0;do{if(C_=!1,Z_=0,25<=P)throw Error(Vt(301));P+=1,ho=to=null,a.updateQueue=null,k0.current=lO,c=m(x,S)}while(C_)}if(k0.current=iv,a=to!==null&&to.next!==null,Rh=0,ho=to=Rr=null,tv=!1,a)throw Error(Vt(300));return c}function qb(){var c=Z_!==0;return Z_=0,c}function _l(){var c={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return ho===null?Rr.memoizedState=ho=c:ho=ho.next=c,ho}function ta(){if(to===null){var c=Rr.alternate;c=c!==null?c.memoizedState:null}else c=to.next;var a=ho===null?Rr.memoizedState:ho.next;if(a!==null)ho=a,to=c;else{if(c===null)throw Error(Vt(310));to=c,c={memoizedState:to.memoizedState,baseState:to.baseState,baseQueue:to.baseQueue,queue:to.queue,next:null},ho===null?Rr.memoizedState=ho=c:ho=ho.next=c}return ho}function X_(c,a){return typeof a=="function"?a(c):a}function K1(c){var a=ta(),m=a.queue;if(m===null)throw Error(Vt(311));m.lastRenderedReducer=c;var x=to,S=x.baseQueue,P=m.pending;if(P!==null){if(S!==null){var O=S.next;S.next=P.next,P.next=O}x.baseQueue=S=P,m.pending=null}if(S!==null){P=S.next,x=x.baseState;var s=O=null,Z=null,Q=P;do{var me=Q.lane;if((Rh&me)===me)Z!==null&&(Z=Z.next={lane:0,action:Q.action,hasEagerState:Q.hasEagerState,eagerState:Q.eagerState,next:null}),x=Q.hasEagerState?Q.eagerState:c(x,Q.action);else{var Ee={lane:me,action:Q.action,hasEagerState:Q.hasEagerState,eagerState:Q.eagerState,next:null};Z===null?(s=Z=Ee,O=x):Z=Z.next=Ee,Rr.lanes|=me,kh|=me}Q=Q.next}while(Q!==null&&Q!==P);Z===null?O=x:Z.next=s,Na(x,a.memoizedState)||(as=!0),a.memoizedState=x,a.baseState=O,a.baseQueue=Z,m.lastRenderedState=x}if(c=m.interleaved,c!==null){S=c;do P=S.lane,Rr.lanes|=P,kh|=P,S=S.next;while(S!==c)}else S===null&&(m.lanes=0);return[a.memoizedState,m.dispatch]}function Y1(c){var a=ta(),m=a.queue;if(m===null)throw Error(Vt(311));m.lastRenderedReducer=c;var x=m.dispatch,S=m.pending,P=a.memoizedState;if(S!==null){m.pending=null;var O=S=S.next;do P=c(P,O.action),O=O.next;while(O!==S);Na(P,a.memoizedState)||(as=!0),a.memoizedState=P,a.baseQueue===null&&(a.baseState=P),m.lastRenderedState=P}return[P,x]}function eP(){}function tP(c,a){var m=Rr,x=ta(),S=a(),P=!Na(x.memoizedState,S);if(P&&(x.memoizedState=S,as=!0),x=x.queue,Wb(rP.bind(null,m,x,c),[c]),x.getSnapshot!==a||P||ho!==null&&ho.memoizedState.tag&1){if(m.flags|=2048,K_(9,nP.bind(null,m,x,S,a),void 0,null),fo===null)throw Error(Vt(349));Rh&30||iP(m,a,S)}return S}function iP(c,a,m){c.flags|=16384,c={getSnapshot:a,value:m},a=Rr.updateQueue,a===null?(a={lastEffect:null,stores:null},Rr.updateQueue=a,a.stores=[c]):(m=a.stores,m===null?a.stores=[c]:m.push(c))}function nP(c,a,m,x){a.value=m,a.getSnapshot=x,oP(a)&&sP(c)}function rP(c,a,m){return m(function(){oP(a)&&sP(c)})}function oP(c){var a=c.getSnapshot;c=c.value;try{var m=a();return!Na(c,m)}catch{return!0}}function sP(c){var a=hc(c,1);a!==null&&Ba(a,c,1,-1)}function XI(c){var a=_l();return typeof c=="function"&&(c=c()),a.memoizedState=a.baseState=c,c={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:X_,lastRenderedState:c},a.queue=c,c=c.dispatch=oO.bind(null,Rr,c),[a.memoizedState,c]}function K_(c,a,m,x){return c={tag:c,create:a,destroy:m,deps:x,next:null},a=Rr.updateQueue,a===null?(a={lastEffect:null,stores:null},Rr.updateQueue=a,a.lastEffect=c.next=c):(m=a.lastEffect,m===null?a.lastEffect=c.next=c:(x=m.next,m.next=c,c.next=x,a.lastEffect=c)),c}function aP(){return ta().memoizedState}function L0(c,a,m,x){var S=_l();Rr.flags|=c,S.memoizedState=K_(1|a,m,void 0,x===void 0?null:x)}function gv(c,a,m,x){var S=ta();x=x===void 0?null:x;var P=void 0;if(to!==null){var O=to.memoizedState;if(P=O.destroy,x!==null&&Gb(x,O.deps)){S.memoizedState=K_(a,m,P,x);return}}Rr.flags|=c,S.memoizedState=K_(1|a,m,P,x)}function KI(c,a){return L0(8390656,8,c,a)}function Wb(c,a){return gv(2048,8,c,a)}function lP(c,a){return gv(4,2,c,a)}function cP(c,a){return gv(4,4,c,a)}function uP(c,a){if(typeof a=="function")return c=c(),a(c),function(){a(null)};if(a!=null)return c=c(),a.current=c,function(){a.current=null}}function hP(c,a,m){return m=m!=null?m.concat([c]):null,gv(4,4,uP.bind(null,a,c),m)}function Zb(){}function dP(c,a){var m=ta();a=a===void 0?null:a;var x=m.memoizedState;return x!==null&&a!==null&&Gb(a,x[1])?x[0]:(m.memoizedState=[c,a],c)}function fP(c,a){var m=ta();a=a===void 0?null:a;var x=m.memoizedState;return x!==null&&a!==null&&Gb(a,x[1])?x[0]:(c=c(),m.memoizedState=[c,a],c)}function pP(c,a,m){return Rh&21?(Na(m,a)||(m=vC(),Rr.lanes|=m,kh|=m,c.baseState=!0),a):(c.baseState&&(c.baseState=!1,as=!0),c.memoizedState=m)}function nO(c,a){var m=Jn;Jn=m!==0&&4>m?m:4,c(!0);var x=X1.transition;X1.transition={};try{c(!1),a()}finally{Jn=m,X1.transition=x}}function mP(){return ta().memoizedState}function rO(c,a,m){var x=fu(c);if(m={lane:x,action:m,hasEagerState:!1,eagerState:null,next:null},_P(c))gP(a,m);else if(m=YC(c,a,m,x),m!==null){var S=Ho();Ba(m,c,x,S),yP(m,a,x)}}function oO(c,a,m){var x=fu(c),S={lane:x,action:m,hasEagerState:!1,eagerState:null,next:null};if(_P(c))gP(a,S);else{var P=c.alternate;if(c.lanes===0&&(P===null||P.lanes===0)&&(P=a.lastRenderedReducer,P!==null))try{var O=a.lastRenderedState,s=P(O,m);if(S.hasEagerState=!0,S.eagerState=s,Na(s,O)){var Z=a.interleaved;Z===null?(S.next=S,Nb(a)):(S.next=Z.next,Z.next=S),a.interleaved=S;return}}catch{}finally{}m=YC(c,a,S,x),m!==null&&(S=Ho(),Ba(m,c,x,S),yP(m,a,x))}}function _P(c){var a=c.alternate;return c===Rr||a!==null&&a===Rr}function gP(c,a){C_=tv=!0;var m=c.pending;m===null?a.next=a:(a.next=m.next,m.next=a),c.pending=a}function yP(c,a,m){if(m&4194240){var x=a.lanes;x&=c.pendingLanes,m|=x,a.lanes=m,Eb(c,m)}}var iv={readContext:ea,useCallback:Po,useContext:Po,useEffect:Po,useImperativeHandle:Po,useInsertionEffect:Po,useLayoutEffect:Po,useMemo:Po,useReducer:Po,useRef:Po,useState:Po,useDebugValue:Po,useDeferredValue:Po,useTransition:Po,useMutableSource:Po,useSyncExternalStore:Po,useId:Po,unstable_isNewReconciler:!1},sO={readContext:ea,useCallback:function(c,a){return _l().memoizedState=[c,a===void 0?null:a],c},useContext:ea,useEffect:KI,useImperativeHandle:function(c,a,m){return m=m!=null?m.concat([c]):null,L0(4194308,4,uP.bind(null,a,c),m)},useLayoutEffect:function(c,a){return L0(4194308,4,c,a)},useInsertionEffect:function(c,a){return L0(4,2,c,a)},useMemo:function(c,a){var m=_l();return a=a===void 0?null:a,c=c(),m.memoizedState=[c,a],c},useReducer:function(c,a,m){var x=_l();return a=m!==void 0?m(a):a,x.memoizedState=x.baseState=a,c={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:c,lastRenderedState:a},x.queue=c,c=c.dispatch=rO.bind(null,Rr,c),[x.memoizedState,c]},useRef:function(c){var a=_l();return c={current:c},a.memoizedState=c},useState:XI,useDebugValue:Zb,useDeferredValue:function(c){return _l().memoizedState=c},useTransition:function(){var c=XI(!1),a=c[0];return c=nO.bind(null,c[1]),_l().memoizedState=c,[a,c]},useMutableSource:function(){},useSyncExternalStore:function(c,a,m){var x=Rr,S=_l();if(Sr){if(m===void 0)throw Error(Vt(407));m=m()}else{if(m=a(),fo===null)throw Error(Vt(349));Rh&30||iP(x,a,m)}S.memoizedState=m;var P={value:m,getSnapshot:a};return S.queue=P,KI(rP.bind(null,x,P,c),[c]),x.flags|=2048,K_(9,nP.bind(null,x,P,m,a),void 0,null),m},useId:function(){var c=_l(),a=fo.identifierPrefix;if(Sr){var m=ac,x=sc;m=(x&~(1<<32-Fa(x)-1)).toString(32)+m,a=":"+a+"R"+m,m=Z_++,0<m&&(a+="H"+m.toString(32)),a+=":"}else m=iO++,a=":"+a+"r"+m.toString(32)+":";return c.memoizedState=a},unstable_isNewReconciler:!1},aO={readContext:ea,useCallback:dP,useContext:ea,useEffect:Wb,useImperativeHandle:hP,useInsertionEffect:lP,useLayoutEffect:cP,useMemo:fP,useReducer:K1,useRef:aP,useState:function(){return K1(X_)},useDebugValue:Zb,useDeferredValue:function(c){var a=ta();return pP(a,to.memoizedState,c)},useTransition:function(){var c=K1(X_)[0],a=ta().memoizedState;return[c,a]},useMutableSource:eP,useSyncExternalStore:tP,useId:mP,unstable_isNewReconciler:!1},lO={readContext:ea,useCallback:dP,useContext:ea,useEffect:Wb,useImperativeHandle:hP,useInsertionEffect:lP,useLayoutEffect:cP,useMemo:fP,useReducer:Y1,useRef:aP,useState:function(){return Y1(X_)},useDebugValue:Zb,useDeferredValue:function(c){var a=ta();return to===null?a.memoizedState=c:pP(a,to.memoizedState,c)},useTransition:function(){var c=Y1(X_)[0],a=ta().memoizedState;return[c,a]},useMutableSource:eP,useSyncExternalStore:tP,useId:mP,unstable_isNewReconciler:!1};function La(c,a){if(c&&c.defaultProps){a=kr({},a),c=c.defaultProps;for(var m in c)a[m]===void 0&&(a[m]=c[m]);return a}return a}function jw(c,a,m,x){a=c.memoizedState,m=m(x,a),m=m==null?a:kr({},a,m),c.memoizedState=m,c.lanes===0&&(c.updateQueue.baseState=m)}var yv={isMounted:function(c){return(c=c._reactInternals)?Dh(c)===c:!1},enqueueSetState:function(c,a,m){c=c._reactInternals;var x=Ho(),S=fu(c),P=lc(x,S);P.payload=a,m!=null&&(P.callback=m),a=hu(c,P,S),a!==null&&(Ba(a,c,S,x),R0(a,c,S))},enqueueReplaceState:function(c,a,m){c=c._reactInternals;var x=Ho(),S=fu(c),P=lc(x,S);P.tag=1,P.payload=a,m!=null&&(P.callback=m),a=hu(c,P,S),a!==null&&(Ba(a,c,S,x),R0(a,c,S))},enqueueForceUpdate:function(c,a){c=c._reactInternals;var m=Ho(),x=fu(c),S=lc(m,x);S.tag=2,a!=null&&(S.callback=a),a=hu(c,S,x),a!==null&&(Ba(a,c,x,m),R0(a,c,x))}};function YI(c,a,m,x,S,P,O){return c=c.stateNode,typeof c.shouldComponentUpdate=="function"?c.shouldComponentUpdate(x,P,O):a.prototype&&a.prototype.isPureReactComponent?!V_(m,x)||!V_(S,P):!0}function vP(c,a,m){var x=!1,S=_u,P=a.contextType;return typeof P=="object"&&P!==null?P=ea(P):(S=cs(a)?Ph:ko.current,x=a.contextTypes,P=(x=x!=null)?Jf(c,S):_u),a=new a(m,P),c.memoizedState=a.state!==null&&a.state!==void 0?a.state:null,a.updater=yv,c.stateNode=a,a._reactInternals=c,x&&(c=c.stateNode,c.__reactInternalMemoizedUnmaskedChildContext=S,c.__reactInternalMemoizedMaskedChildContext=P),a}function JI(c,a,m,x){c=a.state,typeof a.componentWillReceiveProps=="function"&&a.componentWillReceiveProps(m,x),typeof a.UNSAFE_componentWillReceiveProps=="function"&&a.UNSAFE_componentWillReceiveProps(m,x),a.state!==c&&yv.enqueueReplaceState(a,a.state,null)}function Uw(c,a,m,x){var S=c.stateNode;S.props=m,S.state=c.memoizedState,S.refs={},jb(c);var P=a.contextType;typeof P=="object"&&P!==null?S.context=ea(P):(P=cs(a)?Ph:ko.current,S.context=Jf(c,P)),S.state=c.memoizedState,P=a.getDerivedStateFromProps,typeof P=="function"&&(jw(c,a,P,m),S.state=c.memoizedState),typeof a.getDerivedStateFromProps=="function"||typeof S.getSnapshotBeforeUpdate=="function"||typeof S.UNSAFE_componentWillMount!="function"&&typeof S.componentWillMount!="function"||(a=S.state,typeof S.componentWillMount=="function"&&S.componentWillMount(),typeof S.UNSAFE_componentWillMount=="function"&&S.UNSAFE_componentWillMount(),a!==S.state&&yv.enqueueReplaceState(S,S.state,null),Q0(c,m,S,x),S.state=c.memoizedState),typeof S.componentDidMount=="function"&&(c.flags|=4194308)}function ip(c,a){try{var m="",x=a;do m+=Oz(x),x=x.return;while(x);var S=m}catch(P){S=`
Error generating stack: `+P.message+`
`+P.stack}return{value:c,source:a,stack:S,digest:null}}function J1(c,a,m){return{value:c,source:null,stack:m??null,digest:a??null}}function Vw(c,a){try{console.error(a.value)}catch(m){setTimeout(function(){throw m})}}var cO=typeof WeakMap=="function"?WeakMap:Map;function xP(c,a,m){m=lc(-1,m),m.tag=3,m.payload={element:null};var x=a.value;return m.callback=function(){rv||(rv=!0,Jw=x),Vw(c,a)},m}function wP(c,a,m){m=lc(-1,m),m.tag=3;var x=c.type.getDerivedStateFromError;if(typeof x=="function"){var S=a.value;m.payload=function(){return x(S)},m.callback=function(){Vw(c,a)}}var P=c.stateNode;return P!==null&&typeof P.componentDidCatch=="function"&&(m.callback=function(){Vw(c,a),typeof x!="function"&&(du===null?du=new Set([this]):du.add(this));var O=a.stack;this.componentDidCatch(a.value,{componentStack:O!==null?O:""})}),m}function QI(c,a,m){var x=c.pingCache;if(x===null){x=c.pingCache=new cO;var S=new Set;x.set(a,S)}else S=x.get(a),S===void 0&&(S=new Set,x.set(a,S));S.has(m)||(S.add(m),c=TO.bind(null,c,a,m),a.then(c,c))}function eA(c){do{var a;if((a=c.tag===13)&&(a=c.memoizedState,a=a!==null?a.dehydrated!==null:!0),a)return c;c=c.return}while(c!==null);return null}function tA(c,a,m,x,S){return c.mode&1?(c.flags|=65536,c.lanes=S,c):(c===a?c.flags|=65536:(c.flags|=128,m.flags|=131072,m.flags&=-52805,m.tag===1&&(m.alternate===null?m.tag=17:(a=lc(-1,1),a.tag=2,hu(m,a,1))),m.lanes|=1),c)}var uO=fc.ReactCurrentOwner,as=!1;function Go(c,a,m,x){a.child=c===null?KC(a,null,m,x):ep(a,c.child,m,x)}function iA(c,a,m,x,S){m=m.render;var P=a.ref;return Xf(a,S),x=Hb(c,a,m,x,P,S),m=qb(),c!==null&&!as?(a.updateQueue=c.updateQueue,a.flags&=-2053,c.lanes&=~S,dc(c,a,S)):(Sr&&m&&Lb(a),a.flags|=1,Go(c,a,x,S),a.child)}function nA(c,a,m,x,S){if(c===null){var P=m.type;return typeof P=="function"&&!iT(P)&&P.defaultProps===void 0&&m.compare===null&&m.defaultProps===void 0?(a.tag=15,a.type=P,bP(c,a,P,x,S)):(c=F0(m.type,null,x,a,a.mode,S),c.ref=a.ref,c.return=a,a.child=c)}if(P=c.child,!(c.lanes&S)){var O=P.memoizedProps;if(m=m.compare,m=m!==null?m:V_,m(O,x)&&c.ref===a.ref)return dc(c,a,S)}return a.flags|=1,c=pu(P,x),c.ref=a.ref,c.return=a,a.child=c}function bP(c,a,m,x,S){if(c!==null){var P=c.memoizedProps;if(V_(P,x)&&c.ref===a.ref)if(as=!1,a.pendingProps=x=P,(c.lanes&S)!==0)c.flags&131072&&(as=!0);else return a.lanes=c.lanes,dc(c,a,S)}return $w(c,a,m,x,S)}function TP(c,a,m){var x=a.pendingProps,S=x.children,P=c!==null?c.memoizedState:null;if(x.mode==="hidden")if(!(a.mode&1))a.memoizedState={baseLanes:0,cachePool:null,transitions:null},fr(Gf,Es),Es|=m;else{if(!(m&1073741824))return c=P!==null?P.baseLanes|m:m,a.lanes=a.childLanes=1073741824,a.memoizedState={baseLanes:c,cachePool:null,transitions:null},a.updateQueue=null,fr(Gf,Es),Es|=c,null;a.memoizedState={baseLanes:0,cachePool:null,transitions:null},x=P!==null?P.baseLanes:m,fr(Gf,Es),Es|=x}else P!==null?(x=P.baseLanes|m,a.memoizedState=null):x=m,fr(Gf,Es),Es|=x;return Go(c,a,S,m),a.child}function SP(c,a){var m=a.ref;(c===null&&m!==null||c!==null&&c.ref!==m)&&(a.flags|=512,a.flags|=2097152)}function $w(c,a,m,x,S){var P=cs(m)?Ph:ko.current;return P=Jf(a,P),Xf(a,S),m=Hb(c,a,m,x,P,S),x=qb(),c!==null&&!as?(a.updateQueue=c.updateQueue,a.flags&=-2053,c.lanes&=~S,dc(c,a,S)):(Sr&&x&&Lb(a),a.flags|=1,Go(c,a,m,S),a.child)}function rA(c,a,m,x,S){if(cs(m)){var P=!0;Z0(a)}else P=!1;if(Xf(a,S),a.stateNode===null)z0(c,a),vP(a,m,x),Uw(a,m,x,S),x=!0;else if(c===null){var O=a.stateNode,s=a.memoizedProps;O.props=s;var Z=O.context,Q=m.contextType;typeof Q=="object"&&Q!==null?Q=ea(Q):(Q=cs(m)?Ph:ko.current,Q=Jf(a,Q));var me=m.getDerivedStateFromProps,Ee=typeof me=="function"||typeof O.getSnapshotBeforeUpdate=="function";Ee||typeof O.UNSAFE_componentWillReceiveProps!="function"&&typeof O.componentWillReceiveProps!="function"||(s!==x||Z!==Q)&&JI(a,O,x,Q),tu=!1;var De=a.memoizedState;O.state=De,Q0(a,x,O,S),Z=a.memoizedState,s!==x||De!==Z||ls.current||tu?(typeof me=="function"&&(jw(a,m,me,x),Z=a.memoizedState),(s=tu||YI(a,m,s,x,De,Z,Q))?(Ee||typeof O.UNSAFE_componentWillMount!="function"&&typeof O.componentWillMount!="function"||(typeof O.componentWillMount=="function"&&O.componentWillMount(),typeof O.UNSAFE_componentWillMount=="function"&&O.UNSAFE_componentWillMount()),typeof O.componentDidMount=="function"&&(a.flags|=4194308)):(typeof O.componentDidMount=="function"&&(a.flags|=4194308),a.memoizedProps=x,a.memoizedState=Z),O.props=x,O.state=Z,O.context=Q,x=s):(typeof O.componentDidMount=="function"&&(a.flags|=4194308),x=!1)}else{O=a.stateNode,JC(c,a),s=a.memoizedProps,Q=a.type===a.elementType?s:La(a.type,s),O.props=Q,Ee=a.pendingProps,De=O.context,Z=m.contextType,typeof Z=="object"&&Z!==null?Z=ea(Z):(Z=cs(m)?Ph:ko.current,Z=Jf(a,Z));var Xe=m.getDerivedStateFromProps;(me=typeof Xe=="function"||typeof O.getSnapshotBeforeUpdate=="function")||typeof O.UNSAFE_componentWillReceiveProps!="function"&&typeof O.componentWillReceiveProps!="function"||(s!==Ee||De!==Z)&&JI(a,O,x,Z),tu=!1,De=a.memoizedState,O.state=De,Q0(a,x,O,S);var mt=a.memoizedState;s!==Ee||De!==mt||ls.current||tu?(typeof Xe=="function"&&(jw(a,m,Xe,x),mt=a.memoizedState),(Q=tu||YI(a,m,Q,x,De,mt,Z)||!1)?(me||typeof O.UNSAFE_componentWillUpdate!="function"&&typeof O.componentWillUpdate!="function"||(typeof O.componentWillUpdate=="function"&&O.componentWillUpdate(x,mt,Z),typeof O.UNSAFE_componentWillUpdate=="function"&&O.UNSAFE_componentWillUpdate(x,mt,Z)),typeof O.componentDidUpdate=="function"&&(a.flags|=4),typeof O.getSnapshotBeforeUpdate=="function"&&(a.flags|=1024)):(typeof O.componentDidUpdate!="function"||s===c.memoizedProps&&De===c.memoizedState||(a.flags|=4),typeof O.getSnapshotBeforeUpdate!="function"||s===c.memoizedProps&&De===c.memoizedState||(a.flags|=1024),a.memoizedProps=x,a.memoizedState=mt),O.props=x,O.state=mt,O.context=Z,x=Q):(typeof O.componentDidUpdate!="function"||s===c.memoizedProps&&De===c.memoizedState||(a.flags|=4),typeof O.getSnapshotBeforeUpdate!="function"||s===c.memoizedProps&&De===c.memoizedState||(a.flags|=1024),x=!1)}return Gw(c,a,m,x,P,S)}function Gw(c,a,m,x,S,P){SP(c,a);var O=(a.flags&128)!==0;if(!x&&!O)return S&&$I(a,m,!1),dc(c,a,P);x=a.stateNode,uO.current=a;var s=O&&typeof m.getDerivedStateFromError!="function"?null:x.render();return a.flags|=1,c!==null&&O?(a.child=ep(a,c.child,null,P),a.child=ep(a,null,s,P)):Go(c,a,s,P),a.memoizedState=x.state,S&&$I(a,m,!0),a.child}function EP(c){var a=c.stateNode;a.pendingContext?VI(c,a.pendingContext,a.pendingContext!==a.context):a.context&&VI(c,a.context,!1),Ub(c,a.containerInfo)}function oA(c,a,m,x,S){return Qf(),Db(S),a.flags|=256,Go(c,a,m,x),a.child}var Hw={dehydrated:null,treeContext:null,retryLane:0};function qw(c){return{baseLanes:c,cachePool:null,transitions:null}}function IP(c,a,m){var x=a.pendingProps,S=Mr.current,P=!1,O=(a.flags&128)!==0,s;if((s=O)||(s=c!==null&&c.memoizedState===null?!1:(S&2)!==0),s?(P=!0,a.flags&=-129):(c===null||c.memoizedState!==null)&&(S|=1),fr(Mr,S&1),c===null)return Bw(a),c=a.memoizedState,c!==null&&(c=c.dehydrated,c!==null)?(a.mode&1?c.data==="$!"?a.lanes=8:a.lanes=1073741824:a.lanes=1,null):(O=x.children,c=x.fallback,P?(x=a.mode,P=a.child,O={mode:"hidden",children:O},!(x&1)&&P!==null?(P.childLanes=0,P.pendingProps=O):P=wv(O,x,0,null),c=Ch(c,x,m,null),P.return=a,c.return=a,P.sibling=c,a.child=P,a.child.memoizedState=qw(m),a.memoizedState=Hw,c):Xb(a,O));if(S=c.memoizedState,S!==null&&(s=S.dehydrated,s!==null))return hO(c,a,O,x,s,S,m);if(P){P=x.fallback,O=a.mode,S=c.child,s=S.sibling;var Z={mode:"hidden",children:x.children};return!(O&1)&&a.child!==S?(x=a.child,x.childLanes=0,x.pendingProps=Z,a.deletions=null):(x=pu(S,Z),x.subtreeFlags=S.subtreeFlags&14680064),s!==null?P=pu(s,P):(P=Ch(P,O,m,null),P.flags|=2),P.return=a,x.return=a,x.sibling=P,a.child=x,x=P,P=a.child,O=c.child.memoizedState,O=O===null?qw(m):{baseLanes:O.baseLanes|m,cachePool:null,transitions:O.transitions},P.memoizedState=O,P.childLanes=c.childLanes&~m,a.memoizedState=Hw,x}return P=c.child,c=P.sibling,x=pu(P,{mode:"visible",children:x.children}),!(a.mode&1)&&(x.lanes=m),x.return=a,x.sibling=null,c!==null&&(m=a.deletions,m===null?(a.deletions=[c],a.flags|=16):m.push(c)),a.child=x,a.memoizedState=null,x}function Xb(c,a){return a=wv({mode:"visible",children:a},c.mode,0,null),a.return=c,c.child=a}function y0(c,a,m,x){return x!==null&&Db(x),ep(a,c.child,null,m),c=Xb(a,a.pendingProps.children),c.flags|=2,a.memoizedState=null,c}function hO(c,a,m,x,S,P,O){if(m)return a.flags&256?(a.flags&=-257,x=J1(Error(Vt(422))),y0(c,a,O,x)):a.memoizedState!==null?(a.child=c.child,a.flags|=128,null):(P=x.fallback,S=a.mode,x=wv({mode:"visible",children:x.children},S,0,null),P=Ch(P,S,O,null),P.flags|=2,x.return=a,P.return=a,x.sibling=P,a.child=x,a.mode&1&&ep(a,c.child,null,O),a.child.memoizedState=qw(O),a.memoizedState=Hw,P);if(!(a.mode&1))return y0(c,a,O,null);if(S.data==="$!"){if(x=S.nextSibling&&S.nextSibling.dataset,x)var s=x.dgst;return x=s,P=Error(Vt(419)),x=J1(P,x,void 0),y0(c,a,O,x)}if(s=(O&c.childLanes)!==0,as||s){if(x=fo,x!==null){switch(O&-O){case 4:S=2;break;case 16:S=8;break;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:S=32;break;case 536870912:S=268435456;break;default:S=0}S=S&(x.suspendedLanes|O)?0:S,S!==0&&S!==P.retryLane&&(P.retryLane=S,hc(c,S),Ba(x,c,S,-1))}return tT(),x=J1(Error(Vt(421))),y0(c,a,O,x)}return S.data==="$?"?(a.flags|=128,a.child=c.child,a=SO.bind(null,c),S._reactRetry=a,null):(c=P.treeContext,Is=uu(S.nextSibling),As=a,Sr=!0,Oa=null,c!==null&&(Ks[Ys++]=sc,Ks[Ys++]=ac,Ks[Ys++]=Mh,sc=c.id,ac=c.overflow,Mh=a),a=Xb(a,x.children),a.flags|=4096,a)}function sA(c,a,m){c.lanes|=a;var x=c.alternate;x!==null&&(x.lanes|=a),Nw(c.return,a,m)}function Q1(c,a,m,x,S){var P=c.memoizedState;P===null?c.memoizedState={isBackwards:a,rendering:null,renderingStartTime:0,last:x,tail:m,tailMode:S}:(P.isBackwards=a,P.rendering=null,P.renderingStartTime=0,P.last=x,P.tail=m,P.tailMode=S)}function AP(c,a,m){var x=a.pendingProps,S=x.revealOrder,P=x.tail;if(Go(c,a,x.children,m),x=Mr.current,x&2)x=x&1|2,a.flags|=128;else{if(c!==null&&c.flags&128)e:for(c=a.child;c!==null;){if(c.tag===13)c.memoizedState!==null&&sA(c,m,a);else if(c.tag===19)sA(c,m,a);else if(c.child!==null){c.child.return=c,c=c.child;continue}if(c===a)break e;for(;c.sibling===null;){if(c.return===null||c.return===a)break e;c=c.return}c.sibling.return=c.return,c=c.sibling}x&=1}if(fr(Mr,x),!(a.mode&1))a.memoizedState=null;else switch(S){case"forwards":for(m=a.child,S=null;m!==null;)c=m.alternate,c!==null&&ev(c)===null&&(S=m),m=m.sibling;m=S,m===null?(S=a.child,a.child=null):(S=m.sibling,m.sibling=null),Q1(a,!1,S,m,P);break;case"backwards":for(m=null,S=a.child,a.child=null;S!==null;){if(c=S.alternate,c!==null&&ev(c)===null){a.child=S;break}c=S.sibling,S.sibling=m,m=S,S=c}Q1(a,!0,m,null,P);break;case"together":Q1(a,!1,null,null,void 0);break;default:a.memoizedState=null}return a.child}function z0(c,a){!(a.mode&1)&&c!==null&&(c.alternate=null,a.alternate=null,a.flags|=2)}function dc(c,a,m){if(c!==null&&(a.dependencies=c.dependencies),kh|=a.lanes,!(m&a.childLanes))return null;if(c!==null&&a.child!==c.child)throw Error(Vt(153));if(a.child!==null){for(c=a.child,m=pu(c,c.pendingProps),a.child=m,m.return=a;c.sibling!==null;)c=c.sibling,m=m.sibling=pu(c,c.pendingProps),m.return=a;m.sibling=null}return a.child}function dO(c,a,m){switch(a.tag){case 3:EP(a),Qf();break;case 5:QC(a);break;case 1:cs(a.type)&&Z0(a);break;case 4:Ub(a,a.stateNode.containerInfo);break;case 10:var x=a.type._context,S=a.memoizedProps.value;fr(Y0,x._currentValue),x._currentValue=S;break;case 13:if(x=a.memoizedState,x!==null)return x.dehydrated!==null?(fr(Mr,Mr.current&1),a.flags|=128,null):m&a.child.childLanes?IP(c,a,m):(fr(Mr,Mr.current&1),c=dc(c,a,m),c!==null?c.sibling:null);fr(Mr,Mr.current&1);break;case 19:if(x=(m&a.childLanes)!==0,c.flags&128){if(x)return AP(c,a,m);a.flags|=128}if(S=a.memoizedState,S!==null&&(S.rendering=null,S.tail=null,S.lastEffect=null),fr(Mr,Mr.current),x)break;return null;case 22:case 23:return a.lanes=0,TP(c,a,m)}return dc(c,a,m)}var CP,Ww,PP,MP;CP=function(c,a){for(var m=a.child;m!==null;){if(m.tag===5||m.tag===6)c.appendChild(m.stateNode);else if(m.tag!==4&&m.child!==null){m.child.return=m,m=m.child;continue}if(m===a)break;for(;m.sibling===null;){if(m.return===null||m.return===a)return;m=m.return}m.sibling.return=m.return,m=m.sibling}};Ww=function(){};PP=function(c,a,m,x){var S=c.memoizedProps;if(S!==x){c=a.stateNode,Ih(xl.current);var P=null;switch(m){case"input":S=mw(c,S),x=mw(c,x),P=[];break;case"select":S=kr({},S,{value:void 0}),x=kr({},x,{value:void 0}),P=[];break;case"textarea":S=yw(c,S),x=yw(c,x),P=[];break;default:typeof S.onClick!="function"&&typeof x.onClick=="function"&&(c.onclick=q0)}xw(m,x);var O;m=null;for(Q in S)if(!x.hasOwnProperty(Q)&&S.hasOwnProperty(Q)&&S[Q]!=null)if(Q==="style"){var s=S[Q];for(O in s)s.hasOwnProperty(O)&&(m||(m={}),m[O]="")}else Q!=="dangerouslySetInnerHTML"&&Q!=="children"&&Q!=="suppressContentEditableWarning"&&Q!=="suppressHydrationWarning"&&Q!=="autoFocus"&&(D_.hasOwnProperty(Q)?P||(P=[]):(P=P||[]).push(Q,null));for(Q in x){var Z=x[Q];if(s=S!=null?S[Q]:void 0,x.hasOwnProperty(Q)&&Z!==s&&(Z!=null||s!=null))if(Q==="style")if(s){for(O in s)!s.hasOwnProperty(O)||Z&&Z.hasOwnProperty(O)||(m||(m={}),m[O]="");for(O in Z)Z.hasOwnProperty(O)&&s[O]!==Z[O]&&(m||(m={}),m[O]=Z[O])}else m||(P||(P=[]),P.push(Q,m)),m=Z;else Q==="dangerouslySetInnerHTML"?(Z=Z?Z.__html:void 0,s=s?s.__html:void 0,Z!=null&&s!==Z&&(P=P||[]).push(Q,Z)):Q==="children"?typeof Z!="string"&&typeof Z!="number"||(P=P||[]).push(Q,""+Z):Q!=="suppressContentEditableWarning"&&Q!=="suppressHydrationWarning"&&(D_.hasOwnProperty(Q)?(Z!=null&&Q==="onScroll"&&yr("scroll",c),P||s===Z||(P=[])):(P=P||[]).push(Q,Z))}m&&(P=P||[]).push("style",m);var Q=P;(a.updateQueue=Q)&&(a.flags|=4)}};MP=function(c,a,m,x){m!==x&&(a.flags|=4)};function p_(c,a){if(!Sr)switch(c.tailMode){case"hidden":a=c.tail;for(var m=null;a!==null;)a.alternate!==null&&(m=a),a=a.sibling;m===null?c.tail=null:m.sibling=null;break;case"collapsed":m=c.tail;for(var x=null;m!==null;)m.alternate!==null&&(x=m),m=m.sibling;x===null?a||c.tail===null?c.tail=null:c.tail.sibling=null:x.sibling=null}}function Mo(c){var a=c.alternate!==null&&c.alternate.child===c.child,m=0,x=0;if(a)for(var S=c.child;S!==null;)m|=S.lanes|S.childLanes,x|=S.subtreeFlags&14680064,x|=S.flags&14680064,S.return=c,S=S.sibling;else for(S=c.child;S!==null;)m|=S.lanes|S.childLanes,x|=S.subtreeFlags,x|=S.flags,S.return=c,S=S.sibling;return c.subtreeFlags|=x,c.childLanes=m,a}function fO(c,a,m){var x=a.pendingProps;switch(zb(a),a.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return Mo(a),null;case 1:return cs(a.type)&&W0(),Mo(a),null;case 3:return x=a.stateNode,tp(),vr(ls),vr(ko),$b(),x.pendingContext&&(x.context=x.pendingContext,x.pendingContext=null),(c===null||c.child===null)&&(_0(a)?a.flags|=4:c===null||c.memoizedState.isDehydrated&&!(a.flags&256)||(a.flags|=1024,Oa!==null&&(tb(Oa),Oa=null))),Ww(c,a),Mo(a),null;case 5:Vb(a);var S=Ih(W_.current);if(m=a.type,c!==null&&a.stateNode!=null)PP(c,a,m,x,S),c.ref!==a.ref&&(a.flags|=512,a.flags|=2097152);else{if(!x){if(a.stateNode===null)throw Error(Vt(166));return Mo(a),null}if(c=Ih(xl.current),_0(a)){x=a.stateNode,m=a.type;var P=a.memoizedProps;switch(x[yl]=a,x[H_]=P,c=(a.mode&1)!==0,m){case"dialog":yr("cancel",x),yr("close",x);break;case"iframe":case"object":case"embed":yr("load",x);break;case"video":case"audio":for(S=0;S<x_.length;S++)yr(x_[S],x);break;case"source":yr("error",x);break;case"img":case"image":case"link":yr("error",x),yr("load",x);break;case"details":yr("toggle",x);break;case"input":mI(x,P),yr("invalid",x);break;case"select":x._wrapperState={wasMultiple:!!P.multiple},yr("invalid",x);break;case"textarea":gI(x,P),yr("invalid",x)}xw(m,P),S=null;for(var O in P)if(P.hasOwnProperty(O)){var s=P[O];O==="children"?typeof s=="string"?x.textContent!==s&&(P.suppressHydrationWarning!==!0&&m0(x.textContent,s,c),S=["children",s]):typeof s=="number"&&x.textContent!==""+s&&(P.suppressHydrationWarning!==!0&&m0(x.textContent,s,c),S=["children",""+s]):D_.hasOwnProperty(O)&&s!=null&&O==="onScroll"&&yr("scroll",x)}switch(m){case"input":a0(x),_I(x,P,!0);break;case"textarea":a0(x),yI(x);break;case"select":case"option":break;default:typeof P.onClick=="function"&&(x.onclick=q0)}x=S,a.updateQueue=x,x!==null&&(a.flags|=4)}else{O=S.nodeType===9?S:S.ownerDocument,c==="http://www.w3.org/1999/xhtml"&&(c=rC(m)),c==="http://www.w3.org/1999/xhtml"?m==="script"?(c=O.createElement("div"),c.innerHTML="<script><\/script>",c=c.removeChild(c.firstChild)):typeof x.is=="string"?c=O.createElement(m,{is:x.is}):(c=O.createElement(m),m==="select"&&(O=c,x.multiple?O.multiple=!0:x.size&&(O.size=x.size))):c=O.createElementNS(c,m),c[yl]=a,c[H_]=x,CP(c,a,!1,!1),a.stateNode=c;e:{switch(O=ww(m,x),m){case"dialog":yr("cancel",c),yr("close",c),S=x;break;case"iframe":case"object":case"embed":yr("load",c),S=x;break;case"video":case"audio":for(S=0;S<x_.length;S++)yr(x_[S],c);S=x;break;case"source":yr("error",c),S=x;break;case"img":case"image":case"link":yr("error",c),yr("load",c),S=x;break;case"details":yr("toggle",c),S=x;break;case"input":mI(c,x),S=mw(c,x),yr("invalid",c);break;case"option":S=x;break;case"select":c._wrapperState={wasMultiple:!!x.multiple},S=kr({},x,{value:void 0}),yr("invalid",c);break;case"textarea":gI(c,x),S=yw(c,x),yr("invalid",c);break;default:S=x}xw(m,S),s=S;for(P in s)if(s.hasOwnProperty(P)){var Z=s[P];P==="style"?aC(c,Z):P==="dangerouslySetInnerHTML"?(Z=Z?Z.__html:void 0,Z!=null&&oC(c,Z)):P==="children"?typeof Z=="string"?(m!=="textarea"||Z!=="")&&O_(c,Z):typeof Z=="number"&&O_(c,""+Z):P!=="suppressContentEditableWarning"&&P!=="suppressHydrationWarning"&&P!=="autoFocus"&&(D_.hasOwnProperty(P)?Z!=null&&P==="onScroll"&&yr("scroll",c):Z!=null&&vb(c,P,Z,O))}switch(m){case"input":a0(c),_I(c,x,!1);break;case"textarea":a0(c),yI(c);break;case"option":x.value!=null&&c.setAttribute("value",""+mu(x.value));break;case"select":c.multiple=!!x.multiple,P=x.value,P!=null?Hf(c,!!x.multiple,P,!1):x.defaultValue!=null&&Hf(c,!!x.multiple,x.defaultValue,!0);break;default:typeof S.onClick=="function"&&(c.onclick=q0)}switch(m){case"button":case"input":case"select":case"textarea":x=!!x.autoFocus;break e;case"img":x=!0;break e;default:x=!1}}x&&(a.flags|=4)}a.ref!==null&&(a.flags|=512,a.flags|=2097152)}return Mo(a),null;case 6:if(c&&a.stateNode!=null)MP(c,a,c.memoizedProps,x);else{if(typeof x!="string"&&a.stateNode===null)throw Error(Vt(166));if(m=Ih(W_.current),Ih(xl.current),_0(a)){if(x=a.stateNode,m=a.memoizedProps,x[yl]=a,(P=x.nodeValue!==m)&&(c=As,c!==null))switch(c.tag){case 3:m0(x.nodeValue,m,(c.mode&1)!==0);break;case 5:c.memoizedProps.suppressHydrationWarning!==!0&&m0(x.nodeValue,m,(c.mode&1)!==0)}P&&(a.flags|=4)}else x=(m.nodeType===9?m:m.ownerDocument).createTextNode(x),x[yl]=a,a.stateNode=x}return Mo(a),null;case 13:if(vr(Mr),x=a.memoizedState,c===null||c.memoizedState!==null&&c.memoizedState.dehydrated!==null){if(Sr&&Is!==null&&a.mode&1&&!(a.flags&128))ZC(),Qf(),a.flags|=98560,P=!1;else if(P=_0(a),x!==null&&x.dehydrated!==null){if(c===null){if(!P)throw Error(Vt(318));if(P=a.memoizedState,P=P!==null?P.dehydrated:null,!P)throw Error(Vt(317));P[yl]=a}else Qf(),!(a.flags&128)&&(a.memoizedState=null),a.flags|=4;Mo(a),P=!1}else Oa!==null&&(tb(Oa),Oa=null),P=!0;if(!P)return a.flags&65536?a:null}return a.flags&128?(a.lanes=m,a):(x=x!==null,x!==(c!==null&&c.memoizedState!==null)&&x&&(a.child.flags|=8192,a.mode&1&&(c===null||Mr.current&1?io===0&&(io=3):tT())),a.updateQueue!==null&&(a.flags|=4),Mo(a),null);case 4:return tp(),Ww(c,a),c===null&&$_(a.stateNode.containerInfo),Mo(a),null;case 10:return Bb(a.type._context),Mo(a),null;case 17:return cs(a.type)&&W0(),Mo(a),null;case 19:if(vr(Mr),P=a.memoizedState,P===null)return Mo(a),null;if(x=(a.flags&128)!==0,O=P.rendering,O===null)if(x)p_(P,!1);else{if(io!==0||c!==null&&c.flags&128)for(c=a.child;c!==null;){if(O=ev(c),O!==null){for(a.flags|=128,p_(P,!1),x=O.updateQueue,x!==null&&(a.updateQueue=x,a.flags|=4),a.subtreeFlags=0,x=m,m=a.child;m!==null;)P=m,c=x,P.flags&=14680066,O=P.alternate,O===null?(P.childLanes=0,P.lanes=c,P.child=null,P.subtreeFlags=0,P.memoizedProps=null,P.memoizedState=null,P.updateQueue=null,P.dependencies=null,P.stateNode=null):(P.childLanes=O.childLanes,P.lanes=O.lanes,P.child=O.child,P.subtreeFlags=0,P.deletions=null,P.memoizedProps=O.memoizedProps,P.memoizedState=O.memoizedState,P.updateQueue=O.updateQueue,P.type=O.type,c=O.dependencies,P.dependencies=c===null?null:{lanes:c.lanes,firstContext:c.firstContext}),m=m.sibling;return fr(Mr,Mr.current&1|2),a.child}c=c.sibling}P.tail!==null&&Nr()>np&&(a.flags|=128,x=!0,p_(P,!1),a.lanes=4194304)}else{if(!x)if(c=ev(O),c!==null){if(a.flags|=128,x=!0,m=c.updateQueue,m!==null&&(a.updateQueue=m,a.flags|=4),p_(P,!0),P.tail===null&&P.tailMode==="hidden"&&!O.alternate&&!Sr)return Mo(a),null}else 2*Nr()-P.renderingStartTime>np&&m!==1073741824&&(a.flags|=128,x=!0,p_(P,!1),a.lanes=4194304);P.isBackwards?(O.sibling=a.child,a.child=O):(m=P.last,m!==null?m.sibling=O:a.child=O,P.last=O)}return P.tail!==null?(a=P.tail,P.rendering=a,P.tail=a.sibling,P.renderingStartTime=Nr(),a.sibling=null,m=Mr.current,fr(Mr,x?m&1|2:m&1),a):(Mo(a),null);case 22:case 23:return eT(),x=a.memoizedState!==null,c!==null&&c.memoizedState!==null!==x&&(a.flags|=8192),x&&a.mode&1?Es&1073741824&&(Mo(a),a.subtreeFlags&6&&(a.flags|=8192)):Mo(a),null;case 24:return null;case 25:return null}throw Error(Vt(156,a.tag))}function pO(c,a){switch(zb(a),a.tag){case 1:return cs(a.type)&&W0(),c=a.flags,c&65536?(a.flags=c&-65537|128,a):null;case 3:return tp(),vr(ls),vr(ko),$b(),c=a.flags,c&65536&&!(c&128)?(a.flags=c&-65537|128,a):null;case 5:return Vb(a),null;case 13:if(vr(Mr),c=a.memoizedState,c!==null&&c.dehydrated!==null){if(a.alternate===null)throw Error(Vt(340));Qf()}return c=a.flags,c&65536?(a.flags=c&-65537|128,a):null;case 19:return vr(Mr),null;case 4:return tp(),null;case 10:return Bb(a.type._context),null;case 22:case 23:return eT(),null;case 24:return null;default:return null}}var v0=!1,Ro=!1,mO=typeof WeakSet=="function"?WeakSet:Set,mi=null;function $f(c,a){var m=c.ref;if(m!==null)if(typeof m=="function")try{m(null)}catch(x){Dr(c,a,x)}else m.current=null}function Zw(c,a,m){try{m()}catch(x){Dr(c,a,x)}}var aA=!1;function _O(c,a){if(Rw=$0,c=DC(),kb(c)){if("selectionStart"in c)var m={start:c.selectionStart,end:c.selectionEnd};else e:{m=(m=c.ownerDocument)&&m.defaultView||window;var x=m.getSelection&&m.getSelection();if(x&&x.rangeCount!==0){m=x.anchorNode;var S=x.anchorOffset,P=x.focusNode;x=x.focusOffset;try{m.nodeType,P.nodeType}catch{m=null;break e}var O=0,s=-1,Z=-1,Q=0,me=0,Ee=c,De=null;t:for(;;){for(var Xe;Ee!==m||S!==0&&Ee.nodeType!==3||(s=O+S),Ee!==P||x!==0&&Ee.nodeType!==3||(Z=O+x),Ee.nodeType===3&&(O+=Ee.nodeValue.length),(Xe=Ee.firstChild)!==null;)De=Ee,Ee=Xe;for(;;){if(Ee===c)break t;if(De===m&&++Q===S&&(s=O),De===P&&++me===x&&(Z=O),(Xe=Ee.nextSibling)!==null)break;Ee=De,De=Ee.parentNode}Ee=Xe}m=s===-1||Z===-1?null:{start:s,end:Z}}else m=null}m=m||{start:0,end:0}}else m=null;for(kw={focusedElem:c,selectionRange:m},$0=!1,mi=a;mi!==null;)if(a=mi,c=a.child,(a.subtreeFlags&1028)!==0&&c!==null)c.return=a,mi=c;else for(;mi!==null;){a=mi;try{var mt=a.alternate;if(a.flags&1024)switch(a.tag){case 0:case 11:case 15:break;case 1:if(mt!==null){var We=mt.memoizedProps,ct=mt.memoizedState,Me=a.stateNode,xe=Me.getSnapshotBeforeUpdate(a.elementType===a.type?We:La(a.type,We),ct);Me.__reactInternalSnapshotBeforeUpdate=xe}break;case 3:var Pe=a.stateNode.containerInfo;Pe.nodeType===1?Pe.textContent="":Pe.nodeType===9&&Pe.documentElement&&Pe.removeChild(Pe.documentElement);break;case 5:case 6:case 4:case 17:break;default:throw Error(Vt(163))}}catch(Ze){Dr(a,a.return,Ze)}if(c=a.sibling,c!==null){c.return=a.return,mi=c;break}mi=a.return}return mt=aA,aA=!1,mt}function P_(c,a,m){var x=a.updateQueue;if(x=x!==null?x.lastEffect:null,x!==null){var S=x=x.next;do{if((S.tag&c)===c){var P=S.destroy;S.destroy=void 0,P!==void 0&&Zw(a,m,P)}S=S.next}while(S!==x)}}function vv(c,a){if(a=a.updateQueue,a=a!==null?a.lastEffect:null,a!==null){var m=a=a.next;do{if((m.tag&c)===c){var x=m.create;m.destroy=x()}m=m.next}while(m!==a)}}function Xw(c){var a=c.ref;if(a!==null){var m=c.stateNode;switch(c.tag){case 5:c=m;break;default:c=m}typeof a=="function"?a(c):a.current=c}}function RP(c){var a=c.alternate;a!==null&&(c.alternate=null,RP(a)),c.child=null,c.deletions=null,c.sibling=null,c.tag===5&&(a=c.stateNode,a!==null&&(delete a[yl],delete a[H_],delete a[Dw],delete a[JD],delete a[QD])),c.stateNode=null,c.return=null,c.dependencies=null,c.memoizedProps=null,c.memoizedState=null,c.pendingProps=null,c.stateNode=null,c.updateQueue=null}function kP(c){return c.tag===5||c.tag===3||c.tag===4}function lA(c){e:for(;;){for(;c.sibling===null;){if(c.return===null||kP(c.return))return null;c=c.return}for(c.sibling.return=c.return,c=c.sibling;c.tag!==5&&c.tag!==6&&c.tag!==18;){if(c.flags&2||c.child===null||c.tag===4)continue e;c.child.return=c,c=c.child}if(!(c.flags&2))return c.stateNode}}function Kw(c,a,m){var x=c.tag;if(x===5||x===6)c=c.stateNode,a?m.nodeType===8?m.parentNode.insertBefore(c,a):m.insertBefore(c,a):(m.nodeType===8?(a=m.parentNode,a.insertBefore(c,m)):(a=m,a.appendChild(c)),m=m._reactRootContainer,m!=null||a.onclick!==null||(a.onclick=q0));else if(x!==4&&(c=c.child,c!==null))for(Kw(c,a,m),c=c.sibling;c!==null;)Kw(c,a,m),c=c.sibling}function Yw(c,a,m){var x=c.tag;if(x===5||x===6)c=c.stateNode,a?m.insertBefore(c,a):m.appendChild(c);else if(x!==4&&(c=c.child,c!==null))for(Yw(c,a,m),c=c.sibling;c!==null;)Yw(c,a,m),c=c.sibling}var bo=null,za=!1;function Yc(c,a,m){for(m=m.child;m!==null;)LP(c,a,m),m=m.sibling}function LP(c,a,m){if(vl&&typeof vl.onCommitFiberUnmount=="function")try{vl.onCommitFiberUnmount(hv,m)}catch{}switch(m.tag){case 5:Ro||$f(m,a);case 6:var x=bo,S=za;bo=null,Yc(c,a,m),bo=x,za=S,bo!==null&&(za?(c=bo,m=m.stateNode,c.nodeType===8?c.parentNode.removeChild(m):c.removeChild(m)):bo.removeChild(m.stateNode));break;case 18:bo!==null&&(za?(c=bo,m=m.stateNode,c.nodeType===8?q1(c.parentNode,m):c.nodeType===1&&q1(c,m),j_(c)):q1(bo,m.stateNode));break;case 4:x=bo,S=za,bo=m.stateNode.containerInfo,za=!0,Yc(c,a,m),bo=x,za=S;break;case 0:case 11:case 14:case 15:if(!Ro&&(x=m.updateQueue,x!==null&&(x=x.lastEffect,x!==null))){S=x=x.next;do{var P=S,O=P.destroy;P=P.tag,O!==void 0&&(P&2||P&4)&&Zw(m,a,O),S=S.next}while(S!==x)}Yc(c,a,m);break;case 1:if(!Ro&&($f(m,a),x=m.stateNode,typeof x.componentWillUnmount=="function"))try{x.props=m.memoizedProps,x.state=m.memoizedState,x.componentWillUnmount()}catch(s){Dr(m,a,s)}Yc(c,a,m);break;case 21:Yc(c,a,m);break;case 22:m.mode&1?(Ro=(x=Ro)||m.memoizedState!==null,Yc(c,a,m),Ro=x):Yc(c,a,m);break;default:Yc(c,a,m)}}function cA(c){var a=c.updateQueue;if(a!==null){c.updateQueue=null;var m=c.stateNode;m===null&&(m=c.stateNode=new mO),a.forEach(function(x){var S=EO.bind(null,c,x);m.has(x)||(m.add(x),x.then(S,S))})}}function Ra(c,a){var m=a.deletions;if(m!==null)for(var x=0;x<m.length;x++){var S=m[x];try{var P=c,O=a,s=O;e:for(;s!==null;){switch(s.tag){case 5:bo=s.stateNode,za=!1;break e;case 3:bo=s.stateNode.containerInfo,za=!0;break e;case 4:bo=s.stateNode.containerInfo,za=!0;break e}s=s.return}if(bo===null)throw Error(Vt(160));LP(P,O,S),bo=null,za=!1;var Z=S.alternate;Z!==null&&(Z.return=null),S.return=null}catch(Q){Dr(S,a,Q)}}if(a.subtreeFlags&12854)for(a=a.child;a!==null;)zP(a,c),a=a.sibling}function zP(c,a){var m=c.alternate,x=c.flags;switch(c.tag){case 0:case 11:case 14:case 15:if(Ra(a,c),ml(c),x&4){try{P_(3,c,c.return),vv(3,c)}catch(We){Dr(c,c.return,We)}try{P_(5,c,c.return)}catch(We){Dr(c,c.return,We)}}break;case 1:Ra(a,c),ml(c),x&512&&m!==null&&$f(m,m.return);break;case 5:if(Ra(a,c),ml(c),x&512&&m!==null&&$f(m,m.return),c.flags&32){var S=c.stateNode;try{O_(S,"")}catch(We){Dr(c,c.return,We)}}if(x&4&&(S=c.stateNode,S!=null)){var P=c.memoizedProps,O=m!==null?m.memoizedProps:P,s=c.type,Z=c.updateQueue;if(c.updateQueue=null,Z!==null)try{s==="input"&&P.type==="radio"&&P.name!=null&&iC(S,P),ww(s,O);var Q=ww(s,P);for(O=0;O<Z.length;O+=2){var me=Z[O],Ee=Z[O+1];me==="style"?aC(S,Ee):me==="dangerouslySetInnerHTML"?oC(S,Ee):me==="children"?O_(S,Ee):vb(S,me,Ee,Q)}switch(s){case"input":_w(S,P);break;case"textarea":nC(S,P);break;case"select":var De=S._wrapperState.wasMultiple;S._wrapperState.wasMultiple=!!P.multiple;var Xe=P.value;Xe!=null?Hf(S,!!P.multiple,Xe,!1):De!==!!P.multiple&&(P.defaultValue!=null?Hf(S,!!P.multiple,P.defaultValue,!0):Hf(S,!!P.multiple,P.multiple?[]:"",!1))}S[H_]=P}catch(We){Dr(c,c.return,We)}}break;case 6:if(Ra(a,c),ml(c),x&4){if(c.stateNode===null)throw Error(Vt(162));S=c.stateNode,P=c.memoizedProps;try{S.nodeValue=P}catch(We){Dr(c,c.return,We)}}break;case 3:if(Ra(a,c),ml(c),x&4&&m!==null&&m.memoizedState.isDehydrated)try{j_(a.containerInfo)}catch(We){Dr(c,c.return,We)}break;case 4:Ra(a,c),ml(c);break;case 13:Ra(a,c),ml(c),S=c.child,S.flags&8192&&(P=S.memoizedState!==null,S.stateNode.isHidden=P,!P||S.alternate!==null&&S.alternate.memoizedState!==null||(Jb=Nr())),x&4&&cA(c);break;case 22:if(me=m!==null&&m.memoizedState!==null,c.mode&1?(Ro=(Q=Ro)||me,Ra(a,c),Ro=Q):Ra(a,c),ml(c),x&8192){if(Q=c.memoizedState!==null,(c.stateNode.isHidden=Q)&&!me&&c.mode&1)for(mi=c,me=c.child;me!==null;){for(Ee=mi=me;mi!==null;){switch(De=mi,Xe=De.child,De.tag){case 0:case 11:case 14:case 15:P_(4,De,De.return);break;case 1:$f(De,De.return);var mt=De.stateNode;if(typeof mt.componentWillUnmount=="function"){x=De,m=De.return;try{a=x,mt.props=a.memoizedProps,mt.state=a.memoizedState,mt.componentWillUnmount()}catch(We){Dr(x,m,We)}}break;case 5:$f(De,De.return);break;case 22:if(De.memoizedState!==null){hA(Ee);continue}}Xe!==null?(Xe.return=De,mi=Xe):hA(Ee)}me=me.sibling}e:for(me=null,Ee=c;;){if(Ee.tag===5){if(me===null){me=Ee;try{S=Ee.stateNode,Q?(P=S.style,typeof P.setProperty=="function"?P.setProperty("display","none","important"):P.display="none"):(s=Ee.stateNode,Z=Ee.memoizedProps.style,O=Z!=null&&Z.hasOwnProperty("display")?Z.display:null,s.style.display=sC("display",O))}catch(We){Dr(c,c.return,We)}}}else if(Ee.tag===6){if(me===null)try{Ee.stateNode.nodeValue=Q?"":Ee.memoizedProps}catch(We){Dr(c,c.return,We)}}else if((Ee.tag!==22&&Ee.tag!==23||Ee.memoizedState===null||Ee===c)&&Ee.child!==null){Ee.child.return=Ee,Ee=Ee.child;continue}if(Ee===c)break e;for(;Ee.sibling===null;){if(Ee.return===null||Ee.return===c)break e;me===Ee&&(me=null),Ee=Ee.return}me===Ee&&(me=null),Ee.sibling.return=Ee.return,Ee=Ee.sibling}}break;case 19:Ra(a,c),ml(c),x&4&&cA(c);break;case 21:break;default:Ra(a,c),ml(c)}}function ml(c){var a=c.flags;if(a&2){try{e:{for(var m=c.return;m!==null;){if(kP(m)){var x=m;break e}m=m.return}throw Error(Vt(160))}switch(x.tag){case 5:var S=x.stateNode;x.flags&32&&(O_(S,""),x.flags&=-33);var P=lA(c);Yw(c,P,S);break;case 3:case 4:var O=x.stateNode.containerInfo,s=lA(c);Kw(c,s,O);break;default:throw Error(Vt(161))}}catch(Z){Dr(c,c.return,Z)}c.flags&=-3}a&4096&&(c.flags&=-4097)}function gO(c,a,m){mi=c,DP(c)}function DP(c,a,m){for(var x=(c.mode&1)!==0;mi!==null;){var S=mi,P=S.child;if(S.tag===22&&x){var O=S.memoizedState!==null||v0;if(!O){var s=S.alternate,Z=s!==null&&s.memoizedState!==null||Ro;s=v0;var Q=Ro;if(v0=O,(Ro=Z)&&!Q)for(mi=S;mi!==null;)O=mi,Z=O.child,O.tag===22&&O.memoizedState!==null?dA(S):Z!==null?(Z.return=O,mi=Z):dA(S);for(;P!==null;)mi=P,DP(P),P=P.sibling;mi=S,v0=s,Ro=Q}uA(c)}else S.subtreeFlags&8772&&P!==null?(P.return=S,mi=P):uA(c)}}function uA(c){for(;mi!==null;){var a=mi;if(a.flags&8772){var m=a.alternate;try{if(a.flags&8772)switch(a.tag){case 0:case 11:case 15:Ro||vv(5,a);break;case 1:var x=a.stateNode;if(a.flags&4&&!Ro)if(m===null)x.componentDidMount();else{var S=a.elementType===a.type?m.memoizedProps:La(a.type,m.memoizedProps);x.componentDidUpdate(S,m.memoizedState,x.__reactInternalSnapshotBeforeUpdate)}var P=a.updateQueue;P!==null&&ZI(a,P,x);break;case 3:var O=a.updateQueue;if(O!==null){if(m=null,a.child!==null)switch(a.child.tag){case 5:m=a.child.stateNode;break;case 1:m=a.child.stateNode}ZI(a,O,m)}break;case 5:var s=a.stateNode;if(m===null&&a.flags&4){m=s;var Z=a.memoizedProps;switch(a.type){case"button":case"input":case"select":case"textarea":Z.autoFocus&&m.focus();break;case"img":Z.src&&(m.src=Z.src)}}break;case 6:break;case 4:break;case 12:break;case 13:if(a.memoizedState===null){var Q=a.alternate;if(Q!==null){var me=Q.memoizedState;if(me!==null){var Ee=me.dehydrated;Ee!==null&&j_(Ee)}}}break;case 19:case 17:case 21:case 22:case 23:case 25:break;default:throw Error(Vt(163))}Ro||a.flags&512&&Xw(a)}catch(De){Dr(a,a.return,De)}}if(a===c){mi=null;break}if(m=a.sibling,m!==null){m.return=a.return,mi=m;break}mi=a.return}}function hA(c){for(;mi!==null;){var a=mi;if(a===c){mi=null;break}var m=a.sibling;if(m!==null){m.return=a.return,mi=m;break}mi=a.return}}function dA(c){for(;mi!==null;){var a=mi;try{switch(a.tag){case 0:case 11:case 15:var m=a.return;try{vv(4,a)}catch(Z){Dr(a,m,Z)}break;case 1:var x=a.stateNode;if(typeof x.componentDidMount=="function"){var S=a.return;try{x.componentDidMount()}catch(Z){Dr(a,S,Z)}}var P=a.return;try{Xw(a)}catch(Z){Dr(a,P,Z)}break;case 5:var O=a.return;try{Xw(a)}catch(Z){Dr(a,O,Z)}}}catch(Z){Dr(a,a.return,Z)}if(a===c){mi=null;break}var s=a.sibling;if(s!==null){s.return=a.return,mi=s;break}mi=a.return}}var yO=Math.ceil,nv=fc.ReactCurrentDispatcher,Kb=fc.ReactCurrentOwner,Qs=fc.ReactCurrentBatchConfig,jn=0,fo=null,Zr=null,To=0,Es=0,Gf=yu(0),io=0,Y_=null,kh=0,xv=0,Yb=0,M_=null,os=null,Jb=0,np=1/0,nc=null,rv=!1,Jw=null,du=null,x0=!1,su=null,ov=0,R_=0,Qw=null,D0=-1,O0=0;function Ho(){return jn&6?Nr():D0!==-1?D0:D0=Nr()}function fu(c){return c.mode&1?jn&2&&To!==0?To&-To:tO.transition!==null?(O0===0&&(O0=vC()),O0):(c=Jn,c!==0||(c=window.event,c=c===void 0?16:IC(c.type)),c):1}function Ba(c,a,m,x){if(50<R_)throw R_=0,Qw=null,Error(Vt(185));tg(c,m,x),(!(jn&2)||c!==fo)&&(c===fo&&(!(jn&2)&&(xv|=m),io===4&&nu(c,To)),us(c,x),m===1&&jn===0&&!(a.mode&1)&&(np=Nr()+500,_v&&vu()))}function us(c,a){var m=c.callbackNode;tD(c,a);var x=V0(c,c===fo?To:0);if(x===0)m!==null&&wI(m),c.callbackNode=null,c.callbackPriority=0;else if(a=x&-x,c.callbackPriority!==a){if(m!=null&&wI(m),a===1)c.tag===0?eO(fA.bind(null,c)):HC(fA.bind(null,c)),KD(function(){!(jn&6)&&vu()}),m=null;else{switch(xC(x)){case 1:m=Sb;break;case 4:m=gC;break;case 16:m=U0;break;case 536870912:m=yC;break;default:m=U0}m=$P(m,OP.bind(null,c))}c.callbackPriority=a,c.callbackNode=m}}function OP(c,a){if(D0=-1,O0=0,jn&6)throw Error(Vt(327));var m=c.callbackNode;if(Kf()&&c.callbackNode!==m)return null;var x=V0(c,c===fo?To:0);if(x===0)return null;if(x&30||x&c.expiredLanes||a)a=sv(c,x);else{a=x;var S=jn;jn|=2;var P=BP();(fo!==c||To!==a)&&(nc=null,np=Nr()+500,Ah(c,a));do try{wO();break}catch(s){FP(c,s)}while(!0);Fb(),nv.current=P,jn=S,Zr!==null?a=0:(fo=null,To=0,a=io)}if(a!==0){if(a===2&&(S=Iw(c),S!==0&&(x=S,a=eb(c,S))),a===1)throw m=Y_,Ah(c,0),nu(c,x),us(c,Nr()),m;if(a===6)nu(c,x);else{if(S=c.current.alternate,!(x&30)&&!vO(S)&&(a=sv(c,x),a===2&&(P=Iw(c),P!==0&&(x=P,a=eb(c,P))),a===1))throw m=Y_,Ah(c,0),nu(c,x),us(c,Nr()),m;switch(c.finishedWork=S,c.finishedLanes=x,a){case 0:case 1:throw Error(Vt(345));case 2:wh(c,os,nc);break;case 3:if(nu(c,x),(x&130023424)===x&&(a=Jb+500-Nr(),10<a)){if(V0(c,0)!==0)break;if(S=c.suspendedLanes,(S&x)!==x){Ho(),c.pingedLanes|=c.suspendedLanes&S;break}c.timeoutHandle=zw(wh.bind(null,c,os,nc),a);break}wh(c,os,nc);break;case 4:if(nu(c,x),(x&4194240)===x)break;for(a=c.eventTimes,S=-1;0<x;){var O=31-Fa(x);P=1<<O,O=a[O],O>S&&(S=O),x&=~P}if(x=S,x=Nr()-x,x=(120>x?120:480>x?480:1080>x?1080:1920>x?1920:3e3>x?3e3:4320>x?4320:1960*yO(x/1960))-x,10<x){c.timeoutHandle=zw(wh.bind(null,c,os,nc),x);break}wh(c,os,nc);break;case 5:wh(c,os,nc);break;default:throw Error(Vt(329))}}}return us(c,Nr()),c.callbackNode===m?OP.bind(null,c):null}function eb(c,a){var m=M_;return c.current.memoizedState.isDehydrated&&(Ah(c,a).flags|=256),c=sv(c,a),c!==2&&(a=os,os=m,a!==null&&tb(a)),c}function tb(c){os===null?os=c:os.push.apply(os,c)}function vO(c){for(var a=c;;){if(a.flags&16384){var m=a.updateQueue;if(m!==null&&(m=m.stores,m!==null))for(var x=0;x<m.length;x++){var S=m[x],P=S.getSnapshot;S=S.value;try{if(!Na(P(),S))return!1}catch{return!1}}}if(m=a.child,a.subtreeFlags&16384&&m!==null)m.return=a,a=m;else{if(a===c)break;for(;a.sibling===null;){if(a.return===null||a.return===c)return!0;a=a.return}a.sibling.return=a.return,a=a.sibling}}return!0}function nu(c,a){for(a&=~Yb,a&=~xv,c.suspendedLanes|=a,c.pingedLanes&=~a,c=c.expirationTimes;0<a;){var m=31-Fa(a),x=1<<m;c[m]=-1,a&=~x}}function fA(c){if(jn&6)throw Error(Vt(327));Kf();var a=V0(c,0);if(!(a&1))return us(c,Nr()),null;var m=sv(c,a);if(c.tag!==0&&m===2){var x=Iw(c);x!==0&&(a=x,m=eb(c,x))}if(m===1)throw m=Y_,Ah(c,0),nu(c,a),us(c,Nr()),m;if(m===6)throw Error(Vt(345));return c.finishedWork=c.current.alternate,c.finishedLanes=a,wh(c,os,nc),us(c,Nr()),null}function Qb(c,a){var m=jn;jn|=1;try{return c(a)}finally{jn=m,jn===0&&(np=Nr()+500,_v&&vu())}}function Lh(c){su!==null&&su.tag===0&&!(jn&6)&&Kf();var a=jn;jn|=1;var m=Qs.transition,x=Jn;try{if(Qs.transition=null,Jn=1,c)return c()}finally{Jn=x,Qs.transition=m,jn=a,!(jn&6)&&vu()}}function eT(){Es=Gf.current,vr(Gf)}function Ah(c,a){c.finishedWork=null,c.finishedLanes=0;var m=c.timeoutHandle;if(m!==-1&&(c.timeoutHandle=-1,XD(m)),Zr!==null)for(m=Zr.return;m!==null;){var x=m;switch(zb(x),x.tag){case 1:x=x.type.childContextTypes,x!=null&&W0();break;case 3:tp(),vr(ls),vr(ko),$b();break;case 5:Vb(x);break;case 4:tp();break;case 13:vr(Mr);break;case 19:vr(Mr);break;case 10:Bb(x.type._context);break;case 22:case 23:eT()}m=m.return}if(fo=c,Zr=c=pu(c.current,null),To=Es=a,io=0,Y_=null,Yb=xv=kh=0,os=M_=null,Eh!==null){for(a=0;a<Eh.length;a++)if(m=Eh[a],x=m.interleaved,x!==null){m.interleaved=null;var S=x.next,P=m.pending;if(P!==null){var O=P.next;P.next=S,x.next=O}m.pending=x}Eh=null}return c}function FP(c,a){do{var m=Zr;try{if(Fb(),k0.current=iv,tv){for(var x=Rr.memoizedState;x!==null;){var S=x.queue;S!==null&&(S.pending=null),x=x.next}tv=!1}if(Rh=0,ho=to=Rr=null,C_=!1,Z_=0,Kb.current=null,m===null||m.return===null){io=1,Y_=a,Zr=null;break}e:{var P=c,O=m.return,s=m,Z=a;if(a=To,s.flags|=32768,Z!==null&&typeof Z=="object"&&typeof Z.then=="function"){var Q=Z,me=s,Ee=me.tag;if(!(me.mode&1)&&(Ee===0||Ee===11||Ee===15)){var De=me.alternate;De?(me.updateQueue=De.updateQueue,me.memoizedState=De.memoizedState,me.lanes=De.lanes):(me.updateQueue=null,me.memoizedState=null)}var Xe=eA(O);if(Xe!==null){Xe.flags&=-257,tA(Xe,O,s,P,a),Xe.mode&1&&QI(P,Q,a),a=Xe,Z=Q;var mt=a.updateQueue;if(mt===null){var We=new Set;We.add(Z),a.updateQueue=We}else mt.add(Z);break e}else{if(!(a&1)){QI(P,Q,a),tT();break e}Z=Error(Vt(426))}}else if(Sr&&s.mode&1){var ct=eA(O);if(ct!==null){!(ct.flags&65536)&&(ct.flags|=256),tA(ct,O,s,P,a),Db(ip(Z,s));break e}}P=Z=ip(Z,s),io!==4&&(io=2),M_===null?M_=[P]:M_.push(P),P=O;do{switch(P.tag){case 3:P.flags|=65536,a&=-a,P.lanes|=a;var Me=xP(P,Z,a);WI(P,Me);break e;case 1:s=Z;var xe=P.type,Pe=P.stateNode;if(!(P.flags&128)&&(typeof xe.getDerivedStateFromError=="function"||Pe!==null&&typeof Pe.componentDidCatch=="function"&&(du===null||!du.has(Pe)))){P.flags|=65536,a&=-a,P.lanes|=a;var Ze=wP(P,s,a);WI(P,Ze);break e}}P=P.return}while(P!==null)}jP(m)}catch(Ct){a=Ct,Zr===m&&m!==null&&(Zr=m=m.return);continue}break}while(!0)}function BP(){var c=nv.current;return nv.current=iv,c===null?iv:c}function tT(){(io===0||io===3||io===2)&&(io=4),fo===null||!(kh&268435455)&&!(xv&268435455)||nu(fo,To)}function sv(c,a){var m=jn;jn|=2;var x=BP();(fo!==c||To!==a)&&(nc=null,Ah(c,a));do try{xO();break}catch(S){FP(c,S)}while(!0);if(Fb(),jn=m,nv.current=x,Zr!==null)throw Error(Vt(261));return fo=null,To=0,io}function xO(){for(;Zr!==null;)NP(Zr)}function wO(){for(;Zr!==null&&!qz();)NP(Zr)}function NP(c){var a=VP(c.alternate,c,Es);c.memoizedProps=c.pendingProps,a===null?jP(c):Zr=a,Kb.current=null}function jP(c){var a=c;do{var m=a.alternate;if(c=a.return,a.flags&32768){if(m=pO(m,a),m!==null){m.flags&=32767,Zr=m;return}if(c!==null)c.flags|=32768,c.subtreeFlags=0,c.deletions=null;else{io=6,Zr=null;return}}else if(m=fO(m,a,Es),m!==null){Zr=m;return}if(a=a.sibling,a!==null){Zr=a;return}Zr=a=c}while(a!==null);io===0&&(io=5)}function wh(c,a,m){var x=Jn,S=Qs.transition;try{Qs.transition=null,Jn=1,bO(c,a,m,x)}finally{Qs.transition=S,Jn=x}return null}function bO(c,a,m,x){do Kf();while(su!==null);if(jn&6)throw Error(Vt(327));m=c.finishedWork;var S=c.finishedLanes;if(m===null)return null;if(c.finishedWork=null,c.finishedLanes=0,m===c.current)throw Error(Vt(177));c.callbackNode=null,c.callbackPriority=0;var P=m.lanes|m.childLanes;if(iD(c,P),c===fo&&(Zr=fo=null,To=0),!(m.subtreeFlags&2064)&&!(m.flags&2064)||x0||(x0=!0,$P(U0,function(){return Kf(),null})),P=(m.flags&15990)!==0,m.subtreeFlags&15990||P){P=Qs.transition,Qs.transition=null;var O=Jn;Jn=1;var s=jn;jn|=4,Kb.current=null,_O(c,m),zP(m,c),VD(kw),$0=!!Rw,kw=Rw=null,c.current=m,gO(m),Wz(),jn=s,Jn=O,Qs.transition=P}else c.current=m;if(x0&&(x0=!1,su=c,ov=S),P=c.pendingLanes,P===0&&(du=null),Kz(m.stateNode),us(c,Nr()),a!==null)for(x=c.onRecoverableError,m=0;m<a.length;m++)S=a[m],x(S.value,{componentStack:S.stack,digest:S.digest});if(rv)throw rv=!1,c=Jw,Jw=null,c;return ov&1&&c.tag!==0&&Kf(),P=c.pendingLanes,P&1?c===Qw?R_++:(R_=0,Qw=c):R_=0,vu(),null}function Kf(){if(su!==null){var c=xC(ov),a=Qs.transition,m=Jn;try{if(Qs.transition=null,Jn=16>c?16:c,su===null)var x=!1;else{if(c=su,su=null,ov=0,jn&6)throw Error(Vt(331));var S=jn;for(jn|=4,mi=c.current;mi!==null;){var P=mi,O=P.child;if(mi.flags&16){var s=P.deletions;if(s!==null){for(var Z=0;Z<s.length;Z++){var Q=s[Z];for(mi=Q;mi!==null;){var me=mi;switch(me.tag){case 0:case 11:case 15:P_(8,me,P)}var Ee=me.child;if(Ee!==null)Ee.return=me,mi=Ee;else for(;mi!==null;){me=mi;var De=me.sibling,Xe=me.return;if(RP(me),me===Q){mi=null;break}if(De!==null){De.return=Xe,mi=De;break}mi=Xe}}}var mt=P.alternate;if(mt!==null){var We=mt.child;if(We!==null){mt.child=null;do{var ct=We.sibling;We.sibling=null,We=ct}while(We!==null)}}mi=P}}if(P.subtreeFlags&2064&&O!==null)O.return=P,mi=O;else e:for(;mi!==null;){if(P=mi,P.flags&2048)switch(P.tag){case 0:case 11:case 15:P_(9,P,P.return)}var Me=P.sibling;if(Me!==null){Me.return=P.return,mi=Me;break e}mi=P.return}}var xe=c.current;for(mi=xe;mi!==null;){O=mi;var Pe=O.child;if(O.subtreeFlags&2064&&Pe!==null)Pe.return=O,mi=Pe;else e:for(O=xe;mi!==null;){if(s=mi,s.flags&2048)try{switch(s.tag){case 0:case 11:case 15:vv(9,s)}}catch(Ct){Dr(s,s.return,Ct)}if(s===O){mi=null;break e}var Ze=s.sibling;if(Ze!==null){Ze.return=s.return,mi=Ze;break e}mi=s.return}}if(jn=S,vu(),vl&&typeof vl.onPostCommitFiberRoot=="function")try{vl.onPostCommitFiberRoot(hv,c)}catch{}x=!0}return x}finally{Jn=m,Qs.transition=a}}return!1}function pA(c,a,m){a=ip(m,a),a=xP(c,a,1),c=hu(c,a,1),a=Ho(),c!==null&&(tg(c,1,a),us(c,a))}function Dr(c,a,m){if(c.tag===3)pA(c,c,m);else for(;a!==null;){if(a.tag===3){pA(a,c,m);break}else if(a.tag===1){var x=a.stateNode;if(typeof a.type.getDerivedStateFromError=="function"||typeof x.componentDidCatch=="function"&&(du===null||!du.has(x))){c=ip(m,c),c=wP(a,c,1),a=hu(a,c,1),c=Ho(),a!==null&&(tg(a,1,c),us(a,c));break}}a=a.return}}function TO(c,a,m){var x=c.pingCache;x!==null&&x.delete(a),a=Ho(),c.pingedLanes|=c.suspendedLanes&m,fo===c&&(To&m)===m&&(io===4||io===3&&(To&130023424)===To&&500>Nr()-Jb?Ah(c,0):Yb|=m),us(c,a)}function UP(c,a){a===0&&(c.mode&1?(a=u0,u0<<=1,!(u0&130023424)&&(u0=4194304)):a=1);var m=Ho();c=hc(c,a),c!==null&&(tg(c,a,m),us(c,m))}function SO(c){var a=c.memoizedState,m=0;a!==null&&(m=a.retryLane),UP(c,m)}function EO(c,a){var m=0;switch(c.tag){case 13:var x=c.stateNode,S=c.memoizedState;S!==null&&(m=S.retryLane);break;case 19:x=c.stateNode;break;default:throw Error(Vt(314))}x!==null&&x.delete(a),UP(c,m)}var VP;VP=function(c,a,m){if(c!==null)if(c.memoizedProps!==a.pendingProps||ls.current)as=!0;else{if(!(c.lanes&m)&&!(a.flags&128))return as=!1,dO(c,a,m);as=!!(c.flags&131072)}else as=!1,Sr&&a.flags&1048576&&qC(a,K0,a.index);switch(a.lanes=0,a.tag){case 2:var x=a.type;z0(c,a),c=a.pendingProps;var S=Jf(a,ko.current);Xf(a,m),S=Hb(null,a,x,c,S,m);var P=qb();return a.flags|=1,typeof S=="object"&&S!==null&&typeof S.render=="function"&&S.$$typeof===void 0?(a.tag=1,a.memoizedState=null,a.updateQueue=null,cs(x)?(P=!0,Z0(a)):P=!1,a.memoizedState=S.state!==null&&S.state!==void 0?S.state:null,jb(a),S.updater=yv,a.stateNode=S,S._reactInternals=a,Uw(a,x,c,m),a=Gw(null,a,x,!0,P,m)):(a.tag=0,Sr&&P&&Lb(a),Go(null,a,S,m),a=a.child),a;case 16:x=a.elementType;e:{switch(z0(c,a),c=a.pendingProps,S=x._init,x=S(x._payload),a.type=x,S=a.tag=AO(x),c=La(x,c),S){case 0:a=$w(null,a,x,c,m);break e;case 1:a=rA(null,a,x,c,m);break e;case 11:a=iA(null,a,x,c,m);break e;case 14:a=nA(null,a,x,La(x.type,c),m);break e}throw Error(Vt(306,x,""))}return a;case 0:return x=a.type,S=a.pendingProps,S=a.elementType===x?S:La(x,S),$w(c,a,x,S,m);case 1:return x=a.type,S=a.pendingProps,S=a.elementType===x?S:La(x,S),rA(c,a,x,S,m);case 3:e:{if(EP(a),c===null)throw Error(Vt(387));x=a.pendingProps,P=a.memoizedState,S=P.element,JC(c,a),Q0(a,x,null,m);var O=a.memoizedState;if(x=O.element,P.isDehydrated)if(P={element:x,isDehydrated:!1,cache:O.cache,pendingSuspenseBoundaries:O.pendingSuspenseBoundaries,transitions:O.transitions},a.updateQueue.baseState=P,a.memoizedState=P,a.flags&256){S=ip(Error(Vt(423)),a),a=oA(c,a,x,m,S);break e}else if(x!==S){S=ip(Error(Vt(424)),a),a=oA(c,a,x,m,S);break e}else for(Is=uu(a.stateNode.containerInfo.firstChild),As=a,Sr=!0,Oa=null,m=KC(a,null,x,m),a.child=m;m;)m.flags=m.flags&-3|4096,m=m.sibling;else{if(Qf(),x===S){a=dc(c,a,m);break e}Go(c,a,x,m)}a=a.child}return a;case 5:return QC(a),c===null&&Bw(a),x=a.type,S=a.pendingProps,P=c!==null?c.memoizedProps:null,O=S.children,Lw(x,S)?O=null:P!==null&&Lw(x,P)&&(a.flags|=32),SP(c,a),Go(c,a,O,m),a.child;case 6:return c===null&&Bw(a),null;case 13:return IP(c,a,m);case 4:return Ub(a,a.stateNode.containerInfo),x=a.pendingProps,c===null?a.child=ep(a,null,x,m):Go(c,a,x,m),a.child;case 11:return x=a.type,S=a.pendingProps,S=a.elementType===x?S:La(x,S),iA(c,a,x,S,m);case 7:return Go(c,a,a.pendingProps,m),a.child;case 8:return Go(c,a,a.pendingProps.children,m),a.child;case 12:return Go(c,a,a.pendingProps.children,m),a.child;case 10:e:{if(x=a.type._context,S=a.pendingProps,P=a.memoizedProps,O=S.value,fr(Y0,x._currentValue),x._currentValue=O,P!==null)if(Na(P.value,O)){if(P.children===S.children&&!ls.current){a=dc(c,a,m);break e}}else for(P=a.child,P!==null&&(P.return=a);P!==null;){var s=P.dependencies;if(s!==null){O=P.child;for(var Z=s.firstContext;Z!==null;){if(Z.context===x){if(P.tag===1){Z=lc(-1,m&-m),Z.tag=2;var Q=P.updateQueue;if(Q!==null){Q=Q.shared;var me=Q.pending;me===null?Z.next=Z:(Z.next=me.next,me.next=Z),Q.pending=Z}}P.lanes|=m,Z=P.alternate,Z!==null&&(Z.lanes|=m),Nw(P.return,m,a),s.lanes|=m;break}Z=Z.next}}else if(P.tag===10)O=P.type===a.type?null:P.child;else if(P.tag===18){if(O=P.return,O===null)throw Error(Vt(341));O.lanes|=m,s=O.alternate,s!==null&&(s.lanes|=m),Nw(O,m,a),O=P.sibling}else O=P.child;if(O!==null)O.return=P;else for(O=P;O!==null;){if(O===a){O=null;break}if(P=O.sibling,P!==null){P.return=O.return,O=P;break}O=O.return}P=O}Go(c,a,S.children,m),a=a.child}return a;case 9:return S=a.type,x=a.pendingProps.children,Xf(a,m),S=ea(S),x=x(S),a.flags|=1,Go(c,a,x,m),a.child;case 14:return x=a.type,S=La(x,a.pendingProps),S=La(x.type,S),nA(c,a,x,S,m);case 15:return bP(c,a,a.type,a.pendingProps,m);case 17:return x=a.type,S=a.pendingProps,S=a.elementType===x?S:La(x,S),z0(c,a),a.tag=1,cs(x)?(c=!0,Z0(a)):c=!1,Xf(a,m),vP(a,x,S),Uw(a,x,S,m),Gw(null,a,x,!0,c,m);case 19:return AP(c,a,m);case 22:return TP(c,a,m)}throw Error(Vt(156,a.tag))};function $P(c,a){return _C(c,a)}function IO(c,a,m,x){this.tag=c,this.key=m,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=a,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=x,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function Js(c,a,m,x){return new IO(c,a,m,x)}function iT(c){return c=c.prototype,!(!c||!c.isReactComponent)}function AO(c){if(typeof c=="function")return iT(c)?1:0;if(c!=null){if(c=c.$$typeof,c===wb)return 11;if(c===bb)return 14}return 2}function pu(c,a){var m=c.alternate;return m===null?(m=Js(c.tag,a,c.key,c.mode),m.elementType=c.elementType,m.type=c.type,m.stateNode=c.stateNode,m.alternate=c,c.alternate=m):(m.pendingProps=a,m.type=c.type,m.flags=0,m.subtreeFlags=0,m.deletions=null),m.flags=c.flags&14680064,m.childLanes=c.childLanes,m.lanes=c.lanes,m.child=c.child,m.memoizedProps=c.memoizedProps,m.memoizedState=c.memoizedState,m.updateQueue=c.updateQueue,a=c.dependencies,m.dependencies=a===null?null:{lanes:a.lanes,firstContext:a.firstContext},m.sibling=c.sibling,m.index=c.index,m.ref=c.ref,m}function F0(c,a,m,x,S,P){var O=2;if(x=c,typeof c=="function")iT(c)&&(O=1);else if(typeof c=="string")O=5;else e:switch(c){case zf:return Ch(m.children,S,P,a);case xb:O=8,S|=8;break;case hw:return c=Js(12,m,a,S|2),c.elementType=hw,c.lanes=P,c;case dw:return c=Js(13,m,a,S),c.elementType=dw,c.lanes=P,c;case fw:return c=Js(19,m,a,S),c.elementType=fw,c.lanes=P,c;case QA:return wv(m,S,P,a);default:if(typeof c=="object"&&c!==null)switch(c.$$typeof){case YA:O=10;break e;case JA:O=9;break e;case wb:O=11;break e;case bb:O=14;break e;case eu:O=16,x=null;break e}throw Error(Vt(130,c==null?c:typeof c,""))}return a=Js(O,m,a,S),a.elementType=c,a.type=x,a.lanes=P,a}function Ch(c,a,m,x){return c=Js(7,c,x,a),c.lanes=m,c}function wv(c,a,m,x){return c=Js(22,c,x,a),c.elementType=QA,c.lanes=m,c.stateNode={isHidden:!1},c}function ew(c,a,m){return c=Js(6,c,null,a),c.lanes=m,c}function tw(c,a,m){return a=Js(4,c.children!==null?c.children:[],c.key,a),a.lanes=m,a.stateNode={containerInfo:c.containerInfo,pendingChildren:null,implementation:c.implementation},a}function CO(c,a,m,x,S){this.tag=a,this.containerInfo=c,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.pendingContext=this.context=null,this.callbackPriority=0,this.eventTimes=D1(0),this.expirationTimes=D1(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=D1(0),this.identifierPrefix=x,this.onRecoverableError=S,this.mutableSourceEagerHydrationData=null}function nT(c,a,m,x,S,P,O,s,Z){return c=new CO(c,a,m,s,Z),a===1?(a=1,P===!0&&(a|=8)):a=0,P=Js(3,null,null,a),c.current=P,P.stateNode=c,P.memoizedState={element:x,isDehydrated:m,cache:null,transitions:null,pendingSuspenseBoundaries:null},jb(P),c}function PO(c,a,m){var x=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:Lf,key:x==null?null:""+x,children:c,containerInfo:a,implementation:m}}function GP(c){if(!c)return _u;c=c._reactInternals;e:{if(Dh(c)!==c||c.tag!==1)throw Error(Vt(170));var a=c;do{switch(a.tag){case 3:a=a.stateNode.context;break e;case 1:if(cs(a.type)){a=a.stateNode.__reactInternalMemoizedMergedChildContext;break e}}a=a.return}while(a!==null);throw Error(Vt(171))}if(c.tag===1){var m=c.type;if(cs(m))return GC(c,m,a)}return a}function HP(c,a,m,x,S,P,O,s,Z){return c=nT(m,x,!0,c,S,P,O,s,Z),c.context=GP(null),m=c.current,x=Ho(),S=fu(m),P=lc(x,S),P.callback=a??null,hu(m,P,S),c.current.lanes=S,tg(c,S,x),us(c,x),c}function bv(c,a,m,x){var S=a.current,P=Ho(),O=fu(S);return m=GP(m),a.context===null?a.context=m:a.pendingContext=m,a=lc(P,O),a.payload={element:c},x=x===void 0?null:x,x!==null&&(a.callback=x),c=hu(S,a,O),c!==null&&(Ba(c,S,O,P),R0(c,S,O)),O}function av(c){if(c=c.current,!c.child)return null;switch(c.child.tag){case 5:return c.child.stateNode;default:return c.child.stateNode}}function mA(c,a){if(c=c.memoizedState,c!==null&&c.dehydrated!==null){var m=c.retryLane;c.retryLane=m!==0&&m<a?m:a}}function rT(c,a){mA(c,a),(c=c.alternate)&&mA(c,a)}function MO(){return null}var qP=typeof reportError=="function"?reportError:function(c){console.error(c)};function oT(c){this._internalRoot=c}Tv.prototype.render=oT.prototype.render=function(c){var a=this._internalRoot;if(a===null)throw Error(Vt(409));bv(c,a,null,null)};Tv.prototype.unmount=oT.prototype.unmount=function(){var c=this._internalRoot;if(c!==null){this._internalRoot=null;var a=c.containerInfo;Lh(function(){bv(null,c,null,null)}),a[uc]=null}};function Tv(c){this._internalRoot=c}Tv.prototype.unstable_scheduleHydration=function(c){if(c){var a=TC();c={blockedOn:null,target:c,priority:a};for(var m=0;m<iu.length&&a!==0&&a<iu[m].priority;m++);iu.splice(m,0,c),m===0&&EC(c)}};function sT(c){return!(!c||c.nodeType!==1&&c.nodeType!==9&&c.nodeType!==11)}function Sv(c){return!(!c||c.nodeType!==1&&c.nodeType!==9&&c.nodeType!==11&&(c.nodeType!==8||c.nodeValue!==" react-mount-point-unstable "))}function _A(){}function RO(c,a,m,x,S){if(S){if(typeof x=="function"){var P=x;x=function(){var Q=av(O);P.call(Q)}}var O=HP(a,x,c,0,null,!1,!1,"",_A);return c._reactRootContainer=O,c[uc]=O.current,$_(c.nodeType===8?c.parentNode:c),Lh(),O}for(;S=c.lastChild;)c.removeChild(S);if(typeof x=="function"){var s=x;x=function(){var Q=av(Z);s.call(Q)}}var Z=nT(c,0,!1,null,null,!1,!1,"",_A);return c._reactRootContainer=Z,c[uc]=Z.current,$_(c.nodeType===8?c.parentNode:c),Lh(function(){bv(a,Z,m,x)}),Z}function Ev(c,a,m,x,S){var P=m._reactRootContainer;if(P){var O=P;if(typeof S=="function"){var s=S;S=function(){var Z=av(O);s.call(Z)}}bv(a,O,c,S)}else O=RO(m,a,c,S,x);return av(O)}wC=function(c){switch(c.tag){case 3:var a=c.stateNode;if(a.current.memoizedState.isDehydrated){var m=v_(a.pendingLanes);m!==0&&(Eb(a,m|1),us(a,Nr()),!(jn&6)&&(np=Nr()+500,vu()))}break;case 13:Lh(function(){var x=hc(c,1);if(x!==null){var S=Ho();Ba(x,c,1,S)}}),rT(c,1)}};Ib=function(c){if(c.tag===13){var a=hc(c,134217728);if(a!==null){var m=Ho();Ba(a,c,134217728,m)}rT(c,134217728)}};bC=function(c){if(c.tag===13){var a=fu(c),m=hc(c,a);if(m!==null){var x=Ho();Ba(m,c,a,x)}rT(c,a)}};TC=function(){return Jn};SC=function(c,a){var m=Jn;try{return Jn=c,a()}finally{Jn=m}};Tw=function(c,a,m){switch(a){case"input":if(_w(c,m),a=m.name,m.type==="radio"&&a!=null){for(m=c;m.parentNode;)m=m.parentNode;for(m=m.querySelectorAll("input[name="+JSON.stringify(""+a)+'][type="radio"]'),a=0;a<m.length;a++){var x=m[a];if(x!==c&&x.form===c.form){var S=mv(x);if(!S)throw Error(Vt(90));tC(x),_w(x,S)}}}break;case"textarea":nC(c,m);break;case"select":a=m.value,a!=null&&Hf(c,!!m.multiple,a,!1)}};uC=Qb;hC=Lh;var kO={usingClientEntryPoint:!1,Events:[ng,Bf,mv,lC,cC,Qb]},m_={findFiberByHostInstance:Sh,bundleType:0,version:"18.3.1",rendererPackageName:"react-dom"},LO={bundleType:m_.bundleType,version:m_.version,rendererPackageName:m_.rendererPackageName,rendererConfig:m_.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setErrorHandler:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:fc.ReactCurrentDispatcher,findHostInstanceByFiber:function(c){return c=pC(c),c===null?null:c.stateNode},findFiberByHostInstance:m_.findFiberByHostInstance||MO,findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null,reconcilerVersion:"18.3.1-next-f1338f8080-20240426"};if(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__<"u"){var w0=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!w0.isDisabled&&w0.supportsFiber)try{hv=w0.inject(LO),vl=w0}catch{}}Ms.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=kO;Ms.createPortal=function(c,a){var m=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!sT(a))throw Error(Vt(200));return PO(c,a,null,m)};Ms.createRoot=function(c,a){if(!sT(c))throw Error(Vt(299));var m=!1,x="",S=qP;return a!=null&&(a.unstable_strictMode===!0&&(m=!0),a.identifierPrefix!==void 0&&(x=a.identifierPrefix),a.onRecoverableError!==void 0&&(S=a.onRecoverableError)),a=nT(c,1,!1,null,null,m,!1,x,S),c[uc]=a.current,$_(c.nodeType===8?c.parentNode:c),new oT(a)};Ms.findDOMNode=function(c){if(c==null)return null;if(c.nodeType===1)return c;var a=c._reactInternals;if(a===void 0)throw typeof c.render=="function"?Error(Vt(188)):(c=Object.keys(c).join(","),Error(Vt(268,c)));return c=pC(a),c=c===null?null:c.stateNode,c};Ms.flushSync=function(c){return Lh(c)};Ms.hydrate=function(c,a,m){if(!Sv(a))throw Error(Vt(200));return Ev(null,c,a,!0,m)};Ms.hydrateRoot=function(c,a,m){if(!sT(c))throw Error(Vt(405));var x=m!=null&&m.hydratedSources||null,S=!1,P="",O=qP;if(m!=null&&(m.unstable_strictMode===!0&&(S=!0),m.identifierPrefix!==void 0&&(P=m.identifierPrefix),m.onRecoverableError!==void 0&&(O=m.onRecoverableError)),a=HP(a,null,c,1,m??null,S,!1,P,O),c[uc]=a.current,$_(c),x)for(c=0;c<x.length;c++)m=x[c],S=m._getVersion,S=S(m._source),a.mutableSourceEagerHydrationData==null?a.mutableSourceEagerHydrationData=[m,S]:a.mutableSourceEagerHydrationData.push(m,S);return new Tv(a)};Ms.render=function(c,a,m){if(!Sv(a))throw Error(Vt(200));return Ev(null,c,a,!1,m)};Ms.unmountComponentAtNode=function(c){if(!Sv(c))throw Error(Vt(40));return c._reactRootContainer?(Lh(function(){Ev(null,null,c,!1,function(){c._reactRootContainer=null,c[uc]=null})}),!0):!1};Ms.unstable_batchedUpdates=Qb;Ms.unstable_renderSubtreeIntoContainer=function(c,a,m,x){if(!Sv(m))throw Error(Vt(200));if(c==null||c._reactInternals===void 0)throw Error(Vt(38));return Ev(c,a,m,!1,x)};Ms.version="18.3.1-next-f1338f8080-20240426";function WP(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(WP)}catch(c){console.error(c)}}WP(),WA.exports=Ms;var zO=WA.exports,ZP,gA=zO;ZP=gA.createRoot,gA.hydrateRoot;const DO="modulepreload",OO=function(c){return"/"+c},yA={},og=function(a,m,x){let S=Promise.resolve();if(m&&m.length>0){document.getElementsByTagName("link");const O=document.querySelector("meta[property=csp-nonce]"),s=(O==null?void 0:O.nonce)||(O==null?void 0:O.getAttribute("nonce"));S=Promise.allSettled(m.map(Z=>{if(Z=OO(Z),Z in yA)return;yA[Z]=!0;const Q=Z.endsWith(".css"),me=Q?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${Z}"]${me}`))return;const Ee=document.createElement("link");if(Ee.rel=Q?"stylesheet":DO,Q||(Ee.as="script"),Ee.crossOrigin="",Ee.href=Z,s&&Ee.setAttribute("nonce",s),document.head.appendChild(Ee),Q)return new Promise((De,Xe)=>{Ee.addEventListener("load",De),Ee.addEventListener("error",()=>Xe(new Error(`Unable to preload CSS for ${Z}`)))})}))}function P(O){const s=new Event("vite:preloadError",{cancelable:!0});if(s.payload=O,window.dispatchEvent(s),!s.defaultPrevented)throw O}return S.then(O=>{for(const s of O||[])s.status==="rejected"&&P(s.reason);return a().catch(P)})},FO=c=>{let a;return c?a=c:typeof fetch>"u"?a=(...m)=>og(async()=>{const{default:x}=await Promise.resolve().then(()=>lp);return{default:x}},void 0).then(({default:x})=>x(...m)):a=fetch,(...m)=>a(...m)};class aT extends Error{constructor(a,m="FunctionsError",x){super(a),this.name=m,this.context=x}}class BO extends aT{constructor(a){super("Failed to send a request to the Edge Function","FunctionsFetchError",a)}}class vA extends aT{constructor(a){super("Relay Error invoking the Edge Function","FunctionsRelayError",a)}}class xA extends aT{constructor(a){super("Edge Function returned a non-2xx status code","FunctionsHttpError",a)}}var ib;(function(c){c.Any="any",c.ApNortheast1="ap-northeast-1",c.ApNortheast2="ap-northeast-2",c.ApSouth1="ap-south-1",c.ApSoutheast1="ap-southeast-1",c.ApSoutheast2="ap-southeast-2",c.CaCentral1="ca-central-1",c.EuCentral1="eu-central-1",c.EuWest1="eu-west-1",c.EuWest2="eu-west-2",c.EuWest3="eu-west-3",c.SaEast1="sa-east-1",c.UsEast1="us-east-1",c.UsWest1="us-west-1",c.UsWest2="us-west-2"})(ib||(ib={}));var NO=function(c,a,m,x){function S(P){return P instanceof m?P:new m(function(O){O(P)})}return new(m||(m=Promise))(function(P,O){function s(me){try{Q(x.next(me))}catch(Ee){O(Ee)}}function Z(me){try{Q(x.throw(me))}catch(Ee){O(Ee)}}function Q(me){me.done?P(me.value):S(me.value).then(s,Z)}Q((x=x.apply(c,a||[])).next())})};class jO{constructor(a,{headers:m={},customFetch:x,region:S=ib.Any}={}){this.url=a,this.headers=m,this.region=S,this.fetch=FO(x)}setAuth(a){this.headers.Authorization=`Bearer ${a}`}invoke(a,m={}){var x;return NO(this,void 0,void 0,function*(){try{const{headers:S,method:P,body:O}=m;let s={},{region:Z}=m;Z||(Z=this.region);const Q=new URL(`${this.url}/${a}`);Z&&Z!=="any"&&(s["x-region"]=Z,Q.searchParams.set("forceFunctionRegion",Z));let me;O&&(S&&!Object.prototype.hasOwnProperty.call(S,"Content-Type")||!S)&&(typeof Blob<"u"&&O instanceof Blob||O instanceof ArrayBuffer?(s["Content-Type"]="application/octet-stream",me=O):typeof O=="string"?(s["Content-Type"]="text/plain",me=O):typeof FormData<"u"&&O instanceof FormData?me=O:(s["Content-Type"]="application/json",me=JSON.stringify(O)));const Ee=yield this.fetch(Q.toString(),{method:P||"POST",headers:Object.assign(Object.assign(Object.assign({},s),this.headers),S),body:me}).catch(We=>{throw new BO(We)}),De=Ee.headers.get("x-relay-error");if(De&&De==="true")throw new vA(Ee);if(!Ee.ok)throw new xA(Ee);let Xe=((x=Ee.headers.get("Content-Type"))!==null&&x!==void 0?x:"text/plain").split(";")[0].trim(),mt;return Xe==="application/json"?mt=yield Ee.json():Xe==="application/octet-stream"?mt=yield Ee.blob():Xe==="text/event-stream"?mt=Ee:Xe==="multipart/form-data"?mt=yield Ee.formData():mt=yield Ee.text(),{data:mt,error:null,response:Ee}}catch(S){return{data:null,error:S,response:S instanceof xA||S instanceof vA?S.context:void 0}}})}}var ss={},lT={},Iv={},sg={},Av={},Cv={},UO=function(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("unable to locate global object")},rp=UO();const VO=rp.fetch,XP=rp.fetch.bind(rp),KP=rp.Headers,$O=rp.Request,GO=rp.Response,lp=Object.freeze(Object.defineProperty({__proto__:null,Headers:KP,Request:$O,Response:GO,default:XP,fetch:VO},Symbol.toStringTag,{value:"Module"})),HO=lz(lp);var Pv={};Object.defineProperty(Pv,"__esModule",{value:!0});let qO=class extends Error{constructor(a){super(a.message),this.name="PostgrestError",this.details=a.details,this.hint=a.hint,this.code=a.code}};Pv.default=qO;var YP=Cs&&Cs.__importDefault||function(c){return c&&c.__esModule?c:{default:c}};Object.defineProperty(Cv,"__esModule",{value:!0});const WO=YP(HO),ZO=YP(Pv);let XO=class{constructor(a){var m,x;this.shouldThrowOnError=!1,this.method=a.method,this.url=a.url,this.headers=new Headers(a.headers),this.schema=a.schema,this.body=a.body,this.shouldThrowOnError=(m=a.shouldThrowOnError)!==null&&m!==void 0?m:!1,this.signal=a.signal,this.isMaybeSingle=(x=a.isMaybeSingle)!==null&&x!==void 0?x:!1,a.fetch?this.fetch=a.fetch:typeof fetch>"u"?this.fetch=WO.default:this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}setHeader(a,m){return this.headers=new Headers(this.headers),this.headers.set(a,m),this}then(a,m){this.schema===void 0||(["GET","HEAD"].includes(this.method)?this.headers.set("Accept-Profile",this.schema):this.headers.set("Content-Profile",this.schema)),this.method!=="GET"&&this.method!=="HEAD"&&this.headers.set("Content-Type","application/json");const x=this.fetch;let S=x(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then(async P=>{var O,s,Z,Q;let me=null,Ee=null,De=null,Xe=P.status,mt=P.statusText;if(P.ok){if(this.method!=="HEAD"){const xe=await P.text();xe===""||(this.headers.get("Accept")==="text/csv"||this.headers.get("Accept")&&(!((O=this.headers.get("Accept"))===null||O===void 0)&&O.includes("application/vnd.pgrst.plan+text"))?Ee=xe:Ee=JSON.parse(xe))}const ct=(s=this.headers.get("Prefer"))===null||s===void 0?void 0:s.match(/count=(exact|planned|estimated)/),Me=(Z=P.headers.get("content-range"))===null||Z===void 0?void 0:Z.split("/");ct&&Me&&Me.length>1&&(De=parseInt(Me[1])),this.isMaybeSingle&&this.method==="GET"&&Array.isArray(Ee)&&(Ee.length>1?(me={code:"PGRST116",details:`Results contain ${Ee.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},Ee=null,De=null,Xe=406,mt="Not Acceptable"):Ee.length===1?Ee=Ee[0]:Ee=null)}else{const ct=await P.text();try{me=JSON.parse(ct),Array.isArray(me)&&P.status===404&&(Ee=[],me=null,Xe=200,mt="OK")}catch{P.status===404&&ct===""?(Xe=204,mt="No Content"):me={message:ct}}if(me&&this.isMaybeSingle&&(!((Q=me==null?void 0:me.details)===null||Q===void 0)&&Q.includes("0 rows"))&&(me=null,Xe=200,mt="OK"),me&&this.shouldThrowOnError)throw new ZO.default(me)}return{error:me,data:Ee,count:De,status:Xe,statusText:mt}});return this.shouldThrowOnError||(S=S.catch(P=>{var O,s,Z;return{error:{message:`${(O=P==null?void 0:P.name)!==null&&O!==void 0?O:"FetchError"}: ${P==null?void 0:P.message}`,details:`${(s=P==null?void 0:P.stack)!==null&&s!==void 0?s:""}`,hint:"",code:`${(Z=P==null?void 0:P.code)!==null&&Z!==void 0?Z:""}`},data:null,count:null,status:0,statusText:""}})),S.then(a,m)}returns(){return this}overrideTypes(){return this}};Cv.default=XO;var KO=Cs&&Cs.__importDefault||function(c){return c&&c.__esModule?c:{default:c}};Object.defineProperty(Av,"__esModule",{value:!0});const YO=KO(Cv);let JO=class extends YO.default{select(a){let m=!1;const x=(a??"*").split("").map(S=>/\s/.test(S)&&!m?"":(S==='"'&&(m=!m),S)).join("");return this.url.searchParams.set("select",x),this.headers.append("Prefer","return=representation"),this}order(a,{ascending:m=!0,nullsFirst:x,foreignTable:S,referencedTable:P=S}={}){const O=P?`${P}.order`:"order",s=this.url.searchParams.get(O);return this.url.searchParams.set(O,`${s?`${s},`:""}${a}.${m?"asc":"desc"}${x===void 0?"":x?".nullsfirst":".nullslast"}`),this}limit(a,{foreignTable:m,referencedTable:x=m}={}){const S=typeof x>"u"?"limit":`${x}.limit`;return this.url.searchParams.set(S,`${a}`),this}range(a,m,{foreignTable:x,referencedTable:S=x}={}){const P=typeof S>"u"?"offset":`${S}.offset`,O=typeof S>"u"?"limit":`${S}.limit`;return this.url.searchParams.set(P,`${a}`),this.url.searchParams.set(O,`${m-a+1}`),this}abortSignal(a){return this.signal=a,this}single(){return this.headers.set("Accept","application/vnd.pgrst.object+json"),this}maybeSingle(){return this.method==="GET"?this.headers.set("Accept","application/json"):this.headers.set("Accept","application/vnd.pgrst.object+json"),this.isMaybeSingle=!0,this}csv(){return this.headers.set("Accept","text/csv"),this}geojson(){return this.headers.set("Accept","application/geo+json"),this}explain({analyze:a=!1,verbose:m=!1,settings:x=!1,buffers:S=!1,wal:P=!1,format:O="text"}={}){var s;const Z=[a?"analyze":null,m?"verbose":null,x?"settings":null,S?"buffers":null,P?"wal":null].filter(Boolean).join("|"),Q=(s=this.headers.get("Accept"))!==null&&s!==void 0?s:"application/json";return this.headers.set("Accept",`application/vnd.pgrst.plan+${O}; for="${Q}"; options=${Z};`),O==="json"?this:this}rollback(){return this.headers.append("Prefer","tx=rollback"),this}returns(){return this}maxAffected(a){return this.headers.append("Prefer","handling=strict"),this.headers.append("Prefer",`max-affected=${a}`),this}};Av.default=JO;var QO=Cs&&Cs.__importDefault||function(c){return c&&c.__esModule?c:{default:c}};Object.defineProperty(sg,"__esModule",{value:!0});const e3=QO(Av);let t3=class extends e3.default{eq(a,m){return this.url.searchParams.append(a,`eq.${m}`),this}neq(a,m){return this.url.searchParams.append(a,`neq.${m}`),this}gt(a,m){return this.url.searchParams.append(a,`gt.${m}`),this}gte(a,m){return this.url.searchParams.append(a,`gte.${m}`),this}lt(a,m){return this.url.searchParams.append(a,`lt.${m}`),this}lte(a,m){return this.url.searchParams.append(a,`lte.${m}`),this}like(a,m){return this.url.searchParams.append(a,`like.${m}`),this}likeAllOf(a,m){return this.url.searchParams.append(a,`like(all).{${m.join(",")}}`),this}likeAnyOf(a,m){return this.url.searchParams.append(a,`like(any).{${m.join(",")}}`),this}ilike(a,m){return this.url.searchParams.append(a,`ilike.${m}`),this}ilikeAllOf(a,m){return this.url.searchParams.append(a,`ilike(all).{${m.join(",")}}`),this}ilikeAnyOf(a,m){return this.url.searchParams.append(a,`ilike(any).{${m.join(",")}}`),this}is(a,m){return this.url.searchParams.append(a,`is.${m}`),this}in(a,m){const x=Array.from(new Set(m)).map(S=>typeof S=="string"&&new RegExp("[,()]").test(S)?`"${S}"`:`${S}`).join(",");return this.url.searchParams.append(a,`in.(${x})`),this}contains(a,m){return typeof m=="string"?this.url.searchParams.append(a,`cs.${m}`):Array.isArray(m)?this.url.searchParams.append(a,`cs.{${m.join(",")}}`):this.url.searchParams.append(a,`cs.${JSON.stringify(m)}`),this}containedBy(a,m){return typeof m=="string"?this.url.searchParams.append(a,`cd.${m}`):Array.isArray(m)?this.url.searchParams.append(a,`cd.{${m.join(",")}}`):this.url.searchParams.append(a,`cd.${JSON.stringify(m)}`),this}rangeGt(a,m){return this.url.searchParams.append(a,`sr.${m}`),this}rangeGte(a,m){return this.url.searchParams.append(a,`nxl.${m}`),this}rangeLt(a,m){return this.url.searchParams.append(a,`sl.${m}`),this}rangeLte(a,m){return this.url.searchParams.append(a,`nxr.${m}`),this}rangeAdjacent(a,m){return this.url.searchParams.append(a,`adj.${m}`),this}overlaps(a,m){return typeof m=="string"?this.url.searchParams.append(a,`ov.${m}`):this.url.searchParams.append(a,`ov.{${m.join(",")}}`),this}textSearch(a,m,{config:x,type:S}={}){let P="";S==="plain"?P="pl":S==="phrase"?P="ph":S==="websearch"&&(P="w");const O=x===void 0?"":`(${x})`;return this.url.searchParams.append(a,`${P}fts${O}.${m}`),this}match(a){return Object.entries(a).forEach(([m,x])=>{this.url.searchParams.append(m,`eq.${x}`)}),this}not(a,m,x){return this.url.searchParams.append(a,`not.${m}.${x}`),this}or(a,{foreignTable:m,referencedTable:x=m}={}){const S=x?`${x}.or`:"or";return this.url.searchParams.append(S,`(${a})`),this}filter(a,m,x){return this.url.searchParams.append(a,`${m}.${x}`),this}};sg.default=t3;var i3=Cs&&Cs.__importDefault||function(c){return c&&c.__esModule?c:{default:c}};Object.defineProperty(Iv,"__esModule",{value:!0});const __=i3(sg);let n3=class{constructor(a,{headers:m={},schema:x,fetch:S}){this.url=a,this.headers=new Headers(m),this.schema=x,this.fetch=S}select(a,{head:m=!1,count:x}={}){const S=m?"HEAD":"GET";let P=!1;const O=(a??"*").split("").map(s=>/\s/.test(s)&&!P?"":(s==='"'&&(P=!P),s)).join("");return this.url.searchParams.set("select",O),x&&this.headers.append("Prefer",`count=${x}`),new __.default({method:S,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch})}insert(a,{count:m,defaultToNull:x=!0}={}){var S;const P="POST";if(m&&this.headers.append("Prefer",`count=${m}`),x||this.headers.append("Prefer","missing=default"),Array.isArray(a)){const O=a.reduce((s,Z)=>s.concat(Object.keys(Z)),[]);if(O.length>0){const s=[...new Set(O)].map(Z=>`"${Z}"`);this.url.searchParams.set("columns",s.join(","))}}return new __.default({method:P,url:this.url,headers:this.headers,schema:this.schema,body:a,fetch:(S=this.fetch)!==null&&S!==void 0?S:fetch})}upsert(a,{onConflict:m,ignoreDuplicates:x=!1,count:S,defaultToNull:P=!0}={}){var O;const s="POST";if(this.headers.append("Prefer",`resolution=${x?"ignore":"merge"}-duplicates`),m!==void 0&&this.url.searchParams.set("on_conflict",m),S&&this.headers.append("Prefer",`count=${S}`),P||this.headers.append("Prefer","missing=default"),Array.isArray(a)){const Z=a.reduce((Q,me)=>Q.concat(Object.keys(me)),[]);if(Z.length>0){const Q=[...new Set(Z)].map(me=>`"${me}"`);this.url.searchParams.set("columns",Q.join(","))}}return new __.default({method:s,url:this.url,headers:this.headers,schema:this.schema,body:a,fetch:(O=this.fetch)!==null&&O!==void 0?O:fetch})}update(a,{count:m}={}){var x;const S="PATCH";return m&&this.headers.append("Prefer",`count=${m}`),new __.default({method:S,url:this.url,headers:this.headers,schema:this.schema,body:a,fetch:(x=this.fetch)!==null&&x!==void 0?x:fetch})}delete({count:a}={}){var m;const x="DELETE";return a&&this.headers.append("Prefer",`count=${a}`),new __.default({method:x,url:this.url,headers:this.headers,schema:this.schema,fetch:(m=this.fetch)!==null&&m!==void 0?m:fetch})}};Iv.default=n3;var JP=Cs&&Cs.__importDefault||function(c){return c&&c.__esModule?c:{default:c}};Object.defineProperty(lT,"__esModule",{value:!0});const r3=JP(Iv),o3=JP(sg);let s3=class QP{constructor(a,{headers:m={},schema:x,fetch:S}={}){this.url=a,this.headers=new Headers(m),this.schemaName=x,this.fetch=S}from(a){const m=new URL(`${this.url}/${a}`);return new r3.default(m,{headers:new Headers(this.headers),schema:this.schemaName,fetch:this.fetch})}schema(a){return new QP(this.url,{headers:this.headers,schema:a,fetch:this.fetch})}rpc(a,m={},{head:x=!1,get:S=!1,count:P}={}){var O;let s;const Z=new URL(`${this.url}/rpc/${a}`);let Q;x||S?(s=x?"HEAD":"GET",Object.entries(m).filter(([Ee,De])=>De!==void 0).map(([Ee,De])=>[Ee,Array.isArray(De)?`{${De.join(",")}}`:`${De}`]).forEach(([Ee,De])=>{Z.searchParams.append(Ee,De)})):(s="POST",Q=m);const me=new Headers(this.headers);return P&&me.set("Prefer",`count=${P}`),new o3.default({method:s,url:Z,headers:me,schema:this.schemaName,body:Q,fetch:(O=this.fetch)!==null&&O!==void 0?O:fetch})}};lT.default=s3;var cp=Cs&&Cs.__importDefault||function(c){return c&&c.__esModule?c:{default:c}};Object.defineProperty(ss,"__esModule",{value:!0});ss.PostgrestError=ss.PostgrestBuilder=ss.PostgrestTransformBuilder=ss.PostgrestFilterBuilder=ss.PostgrestQueryBuilder=ss.PostgrestClient=void 0;const eM=cp(lT);ss.PostgrestClient=eM.default;const tM=cp(Iv);ss.PostgrestQueryBuilder=tM.default;const iM=cp(sg);ss.PostgrestFilterBuilder=iM.default;const nM=cp(Av);ss.PostgrestTransformBuilder=nM.default;const rM=cp(Cv);ss.PostgrestBuilder=rM.default;const oM=cp(Pv);ss.PostgrestError=oM.default;var a3=ss.default={PostgrestClient:eM.default,PostgrestQueryBuilder:tM.default,PostgrestFilterBuilder:iM.default,PostgrestTransformBuilder:nM.default,PostgrestBuilder:rM.default,PostgrestError:oM.default};const{PostgrestClient:l3,PostgrestQueryBuilder:TB,PostgrestFilterBuilder:SB,PostgrestTransformBuilder:EB,PostgrestBuilder:IB,PostgrestError:AB}=a3;class c3{static detectEnvironment(){var a;if(typeof WebSocket<"u")return{type:"native",constructor:WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocket<"u")return{type:"native",constructor:globalThis.WebSocket};if(typeof global<"u"&&typeof global.WebSocket<"u")return{type:"native",constructor:global.WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocketPair<"u"&&typeof globalThis.WebSocket>"u")return{type:"cloudflare",error:"Cloudflare Workers detected. WebSocket clients are not supported in Cloudflare Workers.",workaround:"Use Cloudflare Workers WebSocket API for server-side WebSocket handling, or deploy to a different runtime."};if(typeof globalThis<"u"&&globalThis.EdgeRuntime||typeof navigator<"u"&&(!((a=navigator.userAgent)===null||a===void 0)&&a.includes("Vercel-Edge")))return{type:"unsupported",error:"Edge runtime detected (Vercel Edge/Netlify Edge). WebSockets are not supported in edge functions.",workaround:"Use serverless functions or a different deployment target for WebSocket functionality."};if(typeof process<"u"){const m=process.versions;if(m&&m.node){const x=m.node,S=parseInt(x.replace(/^v/,"").split(".")[0]);return S>=22?typeof globalThis.WebSocket<"u"?{type:"native",constructor:globalThis.WebSocket}:{type:"unsupported",error:`Node.js ${S} detected but native WebSocket not found.`,workaround:"Provide a WebSocket implementation via the transport option."}:{type:"unsupported",error:`Node.js ${S} detected without native WebSocket support.`,workaround:`For Node.js < 22, install "ws" package and provide it via the transport option:
import ws from "ws"
new RealtimeClient(url, { transport: ws })`}}}return{type:"unsupported",error:"Unknown JavaScript runtime without WebSocket support.",workaround:"Ensure you're running in a supported environment (browser, Node.js, Deno) or provide a custom WebSocket implementation."}}static getWebSocketConstructor(){const a=this.detectEnvironment();if(a.constructor)return a.constructor;let m=a.error||"WebSocket not supported in this environment.";throw a.workaround&&(m+=`

Suggested solution: ${a.workaround}`),new Error(m)}static createWebSocket(a,m){const x=this.getWebSocketConstructor();return new x(a,m)}static isWebSocketSupported(){try{const a=this.detectEnvironment();return a.type==="native"||a.type==="ws"}catch{return!1}}}const u3="2.15.5",h3=`realtime-js/${u3}`,d3="1.0.0",nb=1e4,f3=1e3,p3=100;var k_;(function(c){c[c.connecting=0]="connecting",c[c.open=1]="open",c[c.closing=2]="closing",c[c.closed=3]="closed"})(k_||(k_={}));var Qr;(function(c){c.closed="closed",c.errored="errored",c.joined="joined",c.joining="joining",c.leaving="leaving"})(Qr||(Qr={}));var Da;(function(c){c.close="phx_close",c.error="phx_error",c.join="phx_join",c.reply="phx_reply",c.leave="phx_leave",c.access_token="access_token"})(Da||(Da={}));var rb;(function(c){c.websocket="websocket"})(rb||(rb={}));var Th;(function(c){c.Connecting="connecting",c.Open="open",c.Closing="closing",c.Closed="closed"})(Th||(Th={}));class m3{constructor(){this.HEADER_LENGTH=1}decode(a,m){return a.constructor===ArrayBuffer?m(this._binaryDecode(a)):m(typeof a=="string"?JSON.parse(a):{})}_binaryDecode(a){const m=new DataView(a),x=new TextDecoder;return this._decodeBroadcast(a,m,x)}_decodeBroadcast(a,m,x){const S=m.getUint8(1),P=m.getUint8(2);let O=this.HEADER_LENGTH+2;const s=x.decode(a.slice(O,O+S));O=O+S;const Z=x.decode(a.slice(O,O+P));O=O+P;const Q=JSON.parse(x.decode(a.slice(O,a.byteLength)));return{ref:null,topic:s,event:Z,payload:Q}}}class sM{constructor(a,m){this.callback=a,this.timerCalc=m,this.timer=void 0,this.tries=0,this.callback=a,this.timerCalc=m}reset(){this.tries=0,clearTimeout(this.timer),this.timer=void 0}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}}var hr;(function(c){c.abstime="abstime",c.bool="bool",c.date="date",c.daterange="daterange",c.float4="float4",c.float8="float8",c.int2="int2",c.int4="int4",c.int4range="int4range",c.int8="int8",c.int8range="int8range",c.json="json",c.jsonb="jsonb",c.money="money",c.numeric="numeric",c.oid="oid",c.reltime="reltime",c.text="text",c.time="time",c.timestamp="timestamp",c.timestamptz="timestamptz",c.timetz="timetz",c.tsrange="tsrange",c.tstzrange="tstzrange"})(hr||(hr={}));const wA=(c,a,m={})=>{var x;const S=(x=m.skipTypes)!==null&&x!==void 0?x:[];return Object.keys(a).reduce((P,O)=>(P[O]=_3(O,c,a,S),P),{})},_3=(c,a,m,x)=>{const S=a.find(s=>s.name===c),P=S==null?void 0:S.type,O=m[c];return P&&!x.includes(P)?aM(P,O):ob(O)},aM=(c,a)=>{if(c.charAt(0)==="_"){const m=c.slice(1,c.length);return x3(a,m)}switch(c){case hr.bool:return g3(a);case hr.float4:case hr.float8:case hr.int2:case hr.int4:case hr.int8:case hr.numeric:case hr.oid:return y3(a);case hr.json:case hr.jsonb:return v3(a);case hr.timestamp:return w3(a);case hr.abstime:case hr.date:case hr.daterange:case hr.int4range:case hr.int8range:case hr.money:case hr.reltime:case hr.text:case hr.time:case hr.timestamptz:case hr.timetz:case hr.tsrange:case hr.tstzrange:return ob(a);default:return ob(a)}},ob=c=>c,g3=c=>{switch(c){case"t":return!0;case"f":return!1;default:return c}},y3=c=>{if(typeof c=="string"){const a=parseFloat(c);if(!Number.isNaN(a))return a}return c},v3=c=>{if(typeof c=="string")try{return JSON.parse(c)}catch(a){return console.log(`JSON parse error: ${a}`),c}return c},x3=(c,a)=>{if(typeof c!="string")return c;const m=c.length-1,x=c[m];if(c[0]==="{"&&x==="}"){let P;const O=c.slice(1,m);try{P=JSON.parse("["+O+"]")}catch{P=O?O.split(","):[]}return P.map(s=>aM(a,s))}return c},w3=c=>typeof c=="string"?c.replace(" ","T"):c,lM=c=>{let a=c;return a=a.replace(/^ws/i,"http"),a=a.replace(/(\/socket\/websocket|\/socket|\/websocket)\/?$/i,""),a.replace(/\/+$/,"")+"/api/broadcast"};class iw{constructor(a,m,x={},S=nb){this.channel=a,this.event=m,this.payload=x,this.timeout=S,this.sent=!1,this.timeoutTimer=void 0,this.ref="",this.receivedResp=null,this.recHooks=[],this.refEvent=null}resend(a){this.timeout=a,this._cancelRefEvent(),this.ref="",this.refEvent=null,this.receivedResp=null,this.sent=!1,this.send()}send(){this._hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()}))}updatePayload(a){this.payload=Object.assign(Object.assign({},this.payload),a)}receive(a,m){var x;return this._hasReceived(a)&&m((x=this.receivedResp)===null||x===void 0?void 0:x.response),this.recHooks.push({status:a,callback:m}),this}startTimeout(){if(this.timeoutTimer)return;this.ref=this.channel.socket._makeRef(),this.refEvent=this.channel._replyEventName(this.ref);const a=m=>{this._cancelRefEvent(),this._cancelTimeout(),this.receivedResp=m,this._matchReceive(m)};this.channel._on(this.refEvent,{},a),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}trigger(a,m){this.refEvent&&this.channel._trigger(this.refEvent,{status:a,response:m})}destroy(){this._cancelRefEvent(),this._cancelTimeout()}_cancelRefEvent(){this.refEvent&&this.channel._off(this.refEvent,{})}_cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0}_matchReceive({status:a,response:m}){this.recHooks.filter(x=>x.status===a).forEach(x=>x.callback(m))}_hasReceived(a){return this.receivedResp&&this.receivedResp.status===a}}var bA;(function(c){c.SYNC="sync",c.JOIN="join",c.LEAVE="leave"})(bA||(bA={}));class L_{constructor(a,m){this.channel=a,this.state={},this.pendingDiffs=[],this.joinRef=null,this.enabled=!1,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};const x=(m==null?void 0:m.events)||{state:"presence_state",diff:"presence_diff"};this.channel._on(x.state,{},S=>{const{onJoin:P,onLeave:O,onSync:s}=this.caller;this.joinRef=this.channel._joinRef(),this.state=L_.syncState(this.state,S,P,O),this.pendingDiffs.forEach(Z=>{this.state=L_.syncDiff(this.state,Z,P,O)}),this.pendingDiffs=[],s()}),this.channel._on(x.diff,{},S=>{const{onJoin:P,onLeave:O,onSync:s}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(S):(this.state=L_.syncDiff(this.state,S,P,O),s())}),this.onJoin((S,P,O)=>{this.channel._trigger("presence",{event:"join",key:S,currentPresences:P,newPresences:O})}),this.onLeave((S,P,O)=>{this.channel._trigger("presence",{event:"leave",key:S,currentPresences:P,leftPresences:O})}),this.onSync(()=>{this.channel._trigger("presence",{event:"sync"})})}static syncState(a,m,x,S){const P=this.cloneDeep(a),O=this.transformState(m),s={},Z={};return this.map(P,(Q,me)=>{O[Q]||(Z[Q]=me)}),this.map(O,(Q,me)=>{const Ee=P[Q];if(Ee){const De=me.map(ct=>ct.presence_ref),Xe=Ee.map(ct=>ct.presence_ref),mt=me.filter(ct=>Xe.indexOf(ct.presence_ref)<0),We=Ee.filter(ct=>De.indexOf(ct.presence_ref)<0);mt.length>0&&(s[Q]=mt),We.length>0&&(Z[Q]=We)}else s[Q]=me}),this.syncDiff(P,{joins:s,leaves:Z},x,S)}static syncDiff(a,m,x,S){const{joins:P,leaves:O}={joins:this.transformState(m.joins),leaves:this.transformState(m.leaves)};return x||(x=()=>{}),S||(S=()=>{}),this.map(P,(s,Z)=>{var Q;const me=(Q=a[s])!==null&&Q!==void 0?Q:[];if(a[s]=this.cloneDeep(Z),me.length>0){const Ee=a[s].map(Xe=>Xe.presence_ref),De=me.filter(Xe=>Ee.indexOf(Xe.presence_ref)<0);a[s].unshift(...De)}x(s,me,Z)}),this.map(O,(s,Z)=>{let Q=a[s];if(!Q)return;const me=Z.map(Ee=>Ee.presence_ref);Q=Q.filter(Ee=>me.indexOf(Ee.presence_ref)<0),a[s]=Q,S(s,Q,Z),Q.length===0&&delete a[s]}),a}static map(a,m){return Object.getOwnPropertyNames(a).map(x=>m(x,a[x]))}static transformState(a){return a=this.cloneDeep(a),Object.getOwnPropertyNames(a).reduce((m,x)=>{const S=a[x];return"metas"in S?m[x]=S.metas.map(P=>(P.presence_ref=P.phx_ref,delete P.phx_ref,delete P.phx_ref_prev,P)):m[x]=S,m},{})}static cloneDeep(a){return JSON.parse(JSON.stringify(a))}onJoin(a){this.caller.onJoin=a}onLeave(a){this.caller.onLeave=a}onSync(a){this.caller.onSync=a}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}}var TA;(function(c){c.ALL="*",c.INSERT="INSERT",c.UPDATE="UPDATE",c.DELETE="DELETE"})(TA||(TA={}));var z_;(function(c){c.BROADCAST="broadcast",c.PRESENCE="presence",c.POSTGRES_CHANGES="postgres_changes",c.SYSTEM="system"})(z_||(z_={}));var rc;(function(c){c.SUBSCRIBED="SUBSCRIBED",c.TIMED_OUT="TIMED_OUT",c.CLOSED="CLOSED",c.CHANNEL_ERROR="CHANNEL_ERROR"})(rc||(rc={}));class cT{constructor(a,m={config:{}},x){this.topic=a,this.params=m,this.socket=x,this.bindings={},this.state=Qr.closed,this.joinedOnce=!1,this.pushBuffer=[],this.subTopic=a.replace(/^realtime:/i,""),this.params.config=Object.assign({broadcast:{ack:!1,self:!1},presence:{key:"",enabled:!1},private:!1},m.config),this.timeout=this.socket.timeout,this.joinPush=new iw(this,Da.join,this.params,this.timeout),this.rejoinTimer=new sM(()=>this._rejoinUntilConnected(),this.socket.reconnectAfterMs),this.joinPush.receive("ok",()=>{this.state=Qr.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(S=>S.send()),this.pushBuffer=[]}),this._onClose(()=>{this.rejoinTimer.reset(),this.socket.log("channel",`close ${this.topic} ${this._joinRef()}`),this.state=Qr.closed,this.socket._remove(this)}),this._onError(S=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,S),this.state=Qr.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("timeout",()=>{this._isJoining()&&(this.socket.log("channel",`timeout ${this.topic}`,this.joinPush.timeout),this.state=Qr.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("error",S=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,S),this.state=Qr.errored,this.rejoinTimer.scheduleTimeout())}),this._on(Da.reply,{},(S,P)=>{this._trigger(this._replyEventName(P),S)}),this.presence=new L_(this),this.broadcastEndpointURL=lM(this.socket.endPoint),this.private=this.params.config.private||!1}subscribe(a,m=this.timeout){var x,S,P;if(this.socket.isConnected()||this.socket.connect(),this.state==Qr.closed){const{config:{broadcast:O,presence:s,private:Z}}=this.params,Q=(S=(x=this.bindings.postgres_changes)===null||x===void 0?void 0:x.map(Xe=>Xe.filter))!==null&&S!==void 0?S:[],me=!!this.bindings[z_.PRESENCE]&&this.bindings[z_.PRESENCE].length>0||((P=this.params.config.presence)===null||P===void 0?void 0:P.enabled)===!0,Ee={},De={broadcast:O,presence:Object.assign(Object.assign({},s),{enabled:me}),postgres_changes:Q,private:Z};this.socket.accessTokenValue&&(Ee.access_token=this.socket.accessTokenValue),this._onError(Xe=>a==null?void 0:a(rc.CHANNEL_ERROR,Xe)),this._onClose(()=>a==null?void 0:a(rc.CLOSED)),this.updateJoinPayload(Object.assign({config:De},Ee)),this.joinedOnce=!0,this._rejoin(m),this.joinPush.receive("ok",async({postgres_changes:Xe})=>{var mt;if(this.socket.setAuth(),Xe===void 0){a==null||a(rc.SUBSCRIBED);return}else{const We=this.bindings.postgres_changes,ct=(mt=We==null?void 0:We.length)!==null&&mt!==void 0?mt:0,Me=[];for(let xe=0;xe<ct;xe++){const Pe=We[xe],{filter:{event:Ze,schema:Ct,table:kt,filter:zt}}=Pe,Zt=Xe&&Xe[xe];if(Zt&&Zt.event===Ze&&Zt.schema===Ct&&Zt.table===kt&&Zt.filter===zt)Me.push(Object.assign(Object.assign({},Pe),{id:Zt.id}));else{this.unsubscribe(),this.state=Qr.errored,a==null||a(rc.CHANNEL_ERROR,new Error("mismatch between server and client bindings for postgres changes"));return}}this.bindings.postgres_changes=Me,a&&a(rc.SUBSCRIBED);return}}).receive("error",Xe=>{this.state=Qr.errored,a==null||a(rc.CHANNEL_ERROR,new Error(JSON.stringify(Object.values(Xe).join(", ")||"error")))}).receive("timeout",()=>{a==null||a(rc.TIMED_OUT)})}return this}presenceState(){return this.presence.state}async track(a,m={}){return await this.send({type:"presence",event:"track",payload:a},m.timeout||this.timeout)}async untrack(a={}){return await this.send({type:"presence",event:"untrack"},a)}on(a,m,x){return this.state===Qr.joined&&a===z_.PRESENCE&&(this.socket.log("channel",`resubscribe to ${this.topic} due to change in presence callbacks on joined channel`),this.unsubscribe().then(()=>this.subscribe())),this._on(a,m,x)}async send(a,m={}){var x,S;if(!this._canPush()&&a.type==="broadcast"){const{event:P,payload:O}=a,Z={method:"POST",headers:{Authorization:this.socket.accessTokenValue?`Bearer ${this.socket.accessTokenValue}`:"",apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"},body:JSON.stringify({messages:[{topic:this.subTopic,event:P,payload:O,private:this.private}]})};try{const Q=await this._fetchWithTimeout(this.broadcastEndpointURL,Z,(x=m.timeout)!==null&&x!==void 0?x:this.timeout);return await((S=Q.body)===null||S===void 0?void 0:S.cancel()),Q.ok?"ok":"error"}catch(Q){return Q.name==="AbortError"?"timed out":"error"}}else return new Promise(P=>{var O,s,Z;const Q=this._push(a.type,a,m.timeout||this.timeout);a.type==="broadcast"&&!(!((Z=(s=(O=this.params)===null||O===void 0?void 0:O.config)===null||s===void 0?void 0:s.broadcast)===null||Z===void 0)&&Z.ack)&&P("ok"),Q.receive("ok",()=>P("ok")),Q.receive("error",()=>P("error")),Q.receive("timeout",()=>P("timed out"))})}updateJoinPayload(a){this.joinPush.updatePayload(a)}unsubscribe(a=this.timeout){this.state=Qr.leaving;const m=()=>{this.socket.log("channel",`leave ${this.topic}`),this._trigger(Da.close,"leave",this._joinRef())};this.joinPush.destroy();let x=null;return new Promise(S=>{x=new iw(this,Da.leave,{},a),x.receive("ok",()=>{m(),S("ok")}).receive("timeout",()=>{m(),S("timed out")}).receive("error",()=>{S("error")}),x.send(),this._canPush()||x.trigger("ok",{})}).finally(()=>{x==null||x.destroy()})}teardown(){this.pushBuffer.forEach(a=>a.destroy()),this.pushBuffer=[],this.rejoinTimer.reset(),this.joinPush.destroy(),this.state=Qr.closed,this.bindings={}}async _fetchWithTimeout(a,m,x){const S=new AbortController,P=setTimeout(()=>S.abort(),x),O=await this.socket.fetch(a,Object.assign(Object.assign({},m),{signal:S.signal}));return clearTimeout(P),O}_push(a,m,x=this.timeout){if(!this.joinedOnce)throw`tried to push '${a}' to '${this.topic}' before joining. Use channel.subscribe() before pushing events`;let S=new iw(this,a,m,x);return this._canPush()?S.send():this._addToPushBuffer(S),S}_addToPushBuffer(a){if(a.startTimeout(),this.pushBuffer.push(a),this.pushBuffer.length>p3){const m=this.pushBuffer.shift();m&&(m.destroy(),this.socket.log("channel",`discarded push due to buffer overflow: ${m.event}`,m.payload))}}_onMessage(a,m,x){return m}_isMember(a){return this.topic===a}_joinRef(){return this.joinPush.ref}_trigger(a,m,x){var S,P;const O=a.toLocaleLowerCase(),{close:s,error:Z,leave:Q,join:me}=Da;if(x&&[s,Z,Q,me].indexOf(O)>=0&&x!==this._joinRef())return;let De=this._onMessage(O,m,x);if(m&&!De)throw"channel onMessage callbacks must return the payload, modified or unmodified";["insert","update","delete"].includes(O)?(S=this.bindings.postgres_changes)===null||S===void 0||S.filter(Xe=>{var mt,We,ct;return((mt=Xe.filter)===null||mt===void 0?void 0:mt.event)==="*"||((ct=(We=Xe.filter)===null||We===void 0?void 0:We.event)===null||ct===void 0?void 0:ct.toLocaleLowerCase())===O}).map(Xe=>Xe.callback(De,x)):(P=this.bindings[O])===null||P===void 0||P.filter(Xe=>{var mt,We,ct,Me,xe,Pe;if(["broadcast","presence","postgres_changes"].includes(O))if("id"in Xe){const Ze=Xe.id,Ct=(mt=Xe.filter)===null||mt===void 0?void 0:mt.event;return Ze&&((We=m.ids)===null||We===void 0?void 0:We.includes(Ze))&&(Ct==="*"||(Ct==null?void 0:Ct.toLocaleLowerCase())===((ct=m.data)===null||ct===void 0?void 0:ct.type.toLocaleLowerCase()))}else{const Ze=(xe=(Me=Xe==null?void 0:Xe.filter)===null||Me===void 0?void 0:Me.event)===null||xe===void 0?void 0:xe.toLocaleLowerCase();return Ze==="*"||Ze===((Pe=m==null?void 0:m.event)===null||Pe===void 0?void 0:Pe.toLocaleLowerCase())}else return Xe.type.toLocaleLowerCase()===O}).map(Xe=>{if(typeof De=="object"&&"ids"in De){const mt=De.data,{schema:We,table:ct,commit_timestamp:Me,type:xe,errors:Pe}=mt;De=Object.assign(Object.assign({},{schema:We,table:ct,commit_timestamp:Me,eventType:xe,new:{},old:{},errors:Pe}),this._getPayloadRecords(mt))}Xe.callback(De,x)})}_isClosed(){return this.state===Qr.closed}_isJoined(){return this.state===Qr.joined}_isJoining(){return this.state===Qr.joining}_isLeaving(){return this.state===Qr.leaving}_replyEventName(a){return`chan_reply_${a}`}_on(a,m,x){const S=a.toLocaleLowerCase(),P={type:S,filter:m,callback:x};return this.bindings[S]?this.bindings[S].push(P):this.bindings[S]=[P],this}_off(a,m){const x=a.toLocaleLowerCase();return this.bindings[x]&&(this.bindings[x]=this.bindings[x].filter(S=>{var P;return!(((P=S.type)===null||P===void 0?void 0:P.toLocaleLowerCase())===x&&cT.isEqual(S.filter,m))})),this}static isEqual(a,m){if(Object.keys(a).length!==Object.keys(m).length)return!1;for(const x in a)if(a[x]!==m[x])return!1;return!0}_rejoinUntilConnected(){this.rejoinTimer.scheduleTimeout(),this.socket.isConnected()&&this._rejoin()}_onClose(a){this._on(Da.close,{},a)}_onError(a){this._on(Da.error,{},m=>a(m))}_canPush(){return this.socket.isConnected()&&this._isJoined()}_rejoin(a=this.timeout){this._isLeaving()||(this.socket._leaveOpenTopic(this.topic),this.state=Qr.joining,this.joinPush.resend(a))}_getPayloadRecords(a){const m={new:{},old:{}};return(a.type==="INSERT"||a.type==="UPDATE")&&(m.new=wA(a.columns,a.record)),(a.type==="UPDATE"||a.type==="DELETE")&&(m.old=wA(a.columns,a.old_record)),m}}const nw=()=>{},b0={HEARTBEAT_INTERVAL:25e3,RECONNECT_DELAY:10,HEARTBEAT_TIMEOUT_FALLBACK:100},b3=[1e3,2e3,5e3,1e4],T3=1e4,S3=`
  addEventListener("message", (e) => {
    if (e.data.event === "start") {
      setInterval(() => postMessage({ event: "keepAlive" }), e.data.interval);
    }
  });`;class E3{constructor(a,m){var x;if(this.accessTokenValue=null,this.apiKey=null,this.channels=new Array,this.endPoint="",this.httpEndpoint="",this.headers={},this.params={},this.timeout=nb,this.transport=null,this.heartbeatIntervalMs=b0.HEARTBEAT_INTERVAL,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.heartbeatCallback=nw,this.ref=0,this.reconnectTimer=null,this.logger=nw,this.conn=null,this.sendBuffer=[],this.serializer=new m3,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.accessToken=null,this._connectionState="disconnected",this._wasManualDisconnect=!1,this._authPromise=null,this._resolveFetch=S=>{let P;return S?P=S:typeof fetch>"u"?P=(...O)=>og(async()=>{const{default:s}=await Promise.resolve().then(()=>lp);return{default:s}},void 0).then(({default:s})=>s(...O)).catch(s=>{throw new Error(`Failed to load @supabase/node-fetch: ${s.message}. This is required for HTTP requests in Node.js environments without native fetch.`)}):P=fetch,(...O)=>P(...O)},!(!((x=m==null?void 0:m.params)===null||x===void 0)&&x.apikey))throw new Error("API key is required to connect to Realtime");this.apiKey=m.params.apikey,this.endPoint=`${a}/${rb.websocket}`,this.httpEndpoint=lM(a),this._initializeOptions(m),this._setupReconnectionTimer(),this.fetch=this._resolveFetch(m==null?void 0:m.fetch)}connect(){if(!(this.isConnecting()||this.isDisconnecting()||this.conn!==null&&this.isConnected())){if(this._setConnectionState("connecting"),this._setAuthSafely("connect"),this.transport)this.conn=new this.transport(this.endpointURL());else try{this.conn=c3.createWebSocket(this.endpointURL())}catch(a){this._setConnectionState("disconnected");const m=a.message;throw m.includes("Node.js")?new Error(`${m}

To use Realtime in Node.js, you need to provide a WebSocket implementation:

Option 1: Use Node.js 22+ which has native WebSocket support
Option 2: Install and provide the "ws" package:

  npm install ws

  import ws from "ws"
  const client = new RealtimeClient(url, {
    ...options,
    transport: ws
  })`):new Error(`WebSocket not available: ${m}`)}this._setupConnectionHandlers()}}endpointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:d3}))}disconnect(a,m){if(!this.isDisconnecting())if(this._setConnectionState("disconnecting",!0),this.conn){const x=setTimeout(()=>{this._setConnectionState("disconnected")},100);this.conn.onclose=()=>{clearTimeout(x),this._setConnectionState("disconnected")},a?this.conn.close(a,m??""):this.conn.close(),this._teardownConnection()}else this._setConnectionState("disconnected")}getChannels(){return this.channels}async removeChannel(a){const m=await a.unsubscribe();return this.channels.length===0&&this.disconnect(),m}async removeAllChannels(){const a=await Promise.all(this.channels.map(m=>m.unsubscribe()));return this.channels=[],this.disconnect(),a}log(a,m,x){this.logger(a,m,x)}connectionState(){switch(this.conn&&this.conn.readyState){case k_.connecting:return Th.Connecting;case k_.open:return Th.Open;case k_.closing:return Th.Closing;default:return Th.Closed}}isConnected(){return this.connectionState()===Th.Open}isConnecting(){return this._connectionState==="connecting"}isDisconnecting(){return this._connectionState==="disconnecting"}channel(a,m={config:{}}){const x=`realtime:${a}`,S=this.getChannels().find(P=>P.topic===x);if(S)return S;{const P=new cT(`realtime:${a}`,m,this);return this.channels.push(P),P}}push(a){const{topic:m,event:x,payload:S,ref:P}=a,O=()=>{this.encode(a,s=>{var Z;(Z=this.conn)===null||Z===void 0||Z.send(s)})};this.log("push",`${m} ${x} (${P})`,S),this.isConnected()?O():this.sendBuffer.push(O)}async setAuth(a=null){this._authPromise=this._performAuth(a);try{await this._authPromise}finally{this._authPromise=null}}async sendHeartbeat(){var a;if(!this.isConnected()){try{this.heartbeatCallback("disconnected")}catch(m){this.log("error","error in heartbeat callback",m)}return}if(this.pendingHeartbeatRef){this.pendingHeartbeatRef=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection");try{this.heartbeatCallback("timeout")}catch(m){this.log("error","error in heartbeat callback",m)}this._wasManualDisconnect=!1,(a=this.conn)===null||a===void 0||a.close(f3,"heartbeat timeout"),setTimeout(()=>{var m;this.isConnected()||(m=this.reconnectTimer)===null||m===void 0||m.scheduleTimeout()},b0.HEARTBEAT_TIMEOUT_FALLBACK);return}this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef});try{this.heartbeatCallback("sent")}catch(m){this.log("error","error in heartbeat callback",m)}this._setAuthSafely("heartbeat")}onHeartbeat(a){this.heartbeatCallback=a}flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(a=>a()),this.sendBuffer=[])}_makeRef(){let a=this.ref+1;return a===this.ref?this.ref=0:this.ref=a,this.ref.toString()}_leaveOpenTopic(a){let m=this.channels.find(x=>x.topic===a&&(x._isJoined()||x._isJoining()));m&&(this.log("transport",`leaving duplicate topic "${a}"`),m.unsubscribe())}_remove(a){this.channels=this.channels.filter(m=>m.topic!==a.topic)}_onConnMessage(a){this.decode(a.data,m=>{if(m.topic==="phoenix"&&m.event==="phx_reply")try{this.heartbeatCallback(m.payload.status==="ok"?"ok":"error")}catch(Q){this.log("error","error in heartbeat callback",Q)}m.ref&&m.ref===this.pendingHeartbeatRef&&(this.pendingHeartbeatRef=null);const{topic:x,event:S,payload:P,ref:O}=m,s=O?`(${O})`:"",Z=P.status||"";this.log("receive",`${Z} ${x} ${S} ${s}`.trim(),P),this.channels.filter(Q=>Q._isMember(x)).forEach(Q=>Q._trigger(S,P,O)),this._triggerStateCallbacks("message",m)})}_clearTimer(a){var m;a==="heartbeat"&&this.heartbeatTimer?(clearInterval(this.heartbeatTimer),this.heartbeatTimer=void 0):a==="reconnect"&&((m=this.reconnectTimer)===null||m===void 0||m.reset())}_clearAllTimers(){this._clearTimer("heartbeat"),this._clearTimer("reconnect")}_setupConnectionHandlers(){this.conn&&("binaryType"in this.conn&&(this.conn.binaryType="arraybuffer"),this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=a=>this._onConnError(a),this.conn.onmessage=a=>this._onConnMessage(a),this.conn.onclose=a=>this._onConnClose(a))}_teardownConnection(){this.conn&&(this.conn.onopen=null,this.conn.onerror=null,this.conn.onmessage=null,this.conn.onclose=null,this.conn=null),this._clearAllTimers(),this.channels.forEach(a=>a.teardown())}_onConnOpen(){this._setConnectionState("connected"),this.log("transport",`connected to ${this.endpointURL()}`),this.flushSendBuffer(),this._clearTimer("reconnect"),this.worker?this.workerRef||this._startWorkerHeartbeat():this._startHeartbeat(),this._triggerStateCallbacks("open")}_startHeartbeat(){this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(()=>this.sendHeartbeat(),this.heartbeatIntervalMs)}_startWorkerHeartbeat(){this.workerUrl?this.log("worker",`starting worker for from ${this.workerUrl}`):this.log("worker","starting default worker");const a=this._workerObjectUrl(this.workerUrl);this.workerRef=new Worker(a),this.workerRef.onerror=m=>{this.log("worker","worker error",m.message),this.workerRef.terminate()},this.workerRef.onmessage=m=>{m.data.event==="keepAlive"&&this.sendHeartbeat()},this.workerRef.postMessage({event:"start",interval:this.heartbeatIntervalMs})}_onConnClose(a){var m;this._setConnectionState("disconnected"),this.log("transport","close",a),this._triggerChanError(),this._clearTimer("heartbeat"),this._wasManualDisconnect||(m=this.reconnectTimer)===null||m===void 0||m.scheduleTimeout(),this._triggerStateCallbacks("close",a)}_onConnError(a){this._setConnectionState("disconnected"),this.log("transport",`${a}`),this._triggerChanError(),this._triggerStateCallbacks("error",a)}_triggerChanError(){this.channels.forEach(a=>a._trigger(Da.error))}_appendParams(a,m){if(Object.keys(m).length===0)return a;const x=a.match(/\?/)?"&":"?",S=new URLSearchParams(m);return`${a}${x}${S}`}_workerObjectUrl(a){let m;if(a)m=a;else{const x=new Blob([S3],{type:"application/javascript"});m=URL.createObjectURL(x)}return m}_setConnectionState(a,m=!1){this._connectionState=a,a==="connecting"?this._wasManualDisconnect=!1:a==="disconnecting"&&(this._wasManualDisconnect=m)}async _performAuth(a=null){let m;a?m=a:this.accessToken?m=await this.accessToken():m=this.accessTokenValue,this.accessTokenValue!=m&&(this.accessTokenValue=m,this.channels.forEach(x=>{const S={access_token:m,version:h3};m&&x.updateJoinPayload(S),x.joinedOnce&&x._isJoined()&&x._push(Da.access_token,{access_token:m})}))}async _waitForAuthIfNeeded(){this._authPromise&&await this._authPromise}_setAuthSafely(a="general"){this.setAuth().catch(m=>{this.log("error",`error setting auth in ${a}`,m)})}_triggerStateCallbacks(a,m){try{this.stateChangeCallbacks[a].forEach(x=>{try{x(m)}catch(S){this.log("error",`error in ${a} callback`,S)}})}catch(x){this.log("error",`error triggering ${a} callbacks`,x)}}_setupReconnectionTimer(){this.reconnectTimer=new sM(async()=>{setTimeout(async()=>{await this._waitForAuthIfNeeded(),this.isConnected()||this.connect()},b0.RECONNECT_DELAY)},this.reconnectAfterMs)}_initializeOptions(a){var m,x,S,P,O,s,Z,Q,me;if(this.transport=(m=a==null?void 0:a.transport)!==null&&m!==void 0?m:null,this.timeout=(x=a==null?void 0:a.timeout)!==null&&x!==void 0?x:nb,this.heartbeatIntervalMs=(S=a==null?void 0:a.heartbeatIntervalMs)!==null&&S!==void 0?S:b0.HEARTBEAT_INTERVAL,this.worker=(P=a==null?void 0:a.worker)!==null&&P!==void 0?P:!1,this.accessToken=(O=a==null?void 0:a.accessToken)!==null&&O!==void 0?O:null,this.heartbeatCallback=(s=a==null?void 0:a.heartbeatCallback)!==null&&s!==void 0?s:nw,a!=null&&a.params&&(this.params=a.params),a!=null&&a.logger&&(this.logger=a.logger),(a!=null&&a.logLevel||a!=null&&a.log_level)&&(this.logLevel=a.logLevel||a.log_level,this.params=Object.assign(Object.assign({},this.params),{log_level:this.logLevel})),this.reconnectAfterMs=(Z=a==null?void 0:a.reconnectAfterMs)!==null&&Z!==void 0?Z:Ee=>b3[Ee-1]||T3,this.encode=(Q=a==null?void 0:a.encode)!==null&&Q!==void 0?Q:(Ee,De)=>De(JSON.stringify(Ee)),this.decode=(me=a==null?void 0:a.decode)!==null&&me!==void 0?me:this.serializer.decode.bind(this.serializer),this.worker){if(typeof window<"u"&&!window.Worker)throw new Error("Web Worker is not supported");this.workerUrl=a==null?void 0:a.workerUrl}}}class uT extends Error{constructor(a){super(a),this.__isStorageError=!0,this.name="StorageError"}}function eo(c){return typeof c=="object"&&c!==null&&"__isStorageError"in c}class I3 extends uT{constructor(a,m,x){super(a),this.name="StorageApiError",this.status=m,this.statusCode=x}toJSON(){return{name:this.name,message:this.message,status:this.status,statusCode:this.statusCode}}}class sb extends uT{constructor(a,m){super(a),this.name="StorageUnknownError",this.originalError=m}}var A3=function(c,a,m,x){function S(P){return P instanceof m?P:new m(function(O){O(P)})}return new(m||(m=Promise))(function(P,O){function s(me){try{Q(x.next(me))}catch(Ee){O(Ee)}}function Z(me){try{Q(x.throw(me))}catch(Ee){O(Ee)}}function Q(me){me.done?P(me.value):S(me.value).then(s,Z)}Q((x=x.apply(c,a||[])).next())})};const cM=c=>{let a;return c?a=c:typeof fetch>"u"?a=(...m)=>og(async()=>{const{default:x}=await Promise.resolve().then(()=>lp);return{default:x}},void 0).then(({default:x})=>x(...m)):a=fetch,(...m)=>a(...m)},C3=()=>A3(void 0,void 0,void 0,function*(){return typeof Response>"u"?(yield og(()=>Promise.resolve().then(()=>lp),void 0)).Response:Response}),ab=c=>{if(Array.isArray(c))return c.map(m=>ab(m));if(typeof c=="function"||c!==Object(c))return c;const a={};return Object.entries(c).forEach(([m,x])=>{const S=m.replace(/([-_][a-z])/gi,P=>P.toUpperCase().replace(/[-_]/g,""));a[S]=ab(x)}),a},P3=c=>{if(typeof c!="object"||c===null)return!1;const a=Object.getPrototypeOf(c);return(a===null||a===Object.prototype||Object.getPrototypeOf(a)===null)&&!(Symbol.toStringTag in c)&&!(Symbol.iterator in c)};var Oh=function(c,a,m,x){function S(P){return P instanceof m?P:new m(function(O){O(P)})}return new(m||(m=Promise))(function(P,O){function s(me){try{Q(x.next(me))}catch(Ee){O(Ee)}}function Z(me){try{Q(x.throw(me))}catch(Ee){O(Ee)}}function Q(me){me.done?P(me.value):S(me.value).then(s,Z)}Q((x=x.apply(c,a||[])).next())})};const rw=c=>c.msg||c.message||c.error_description||c.error||JSON.stringify(c),M3=(c,a,m)=>Oh(void 0,void 0,void 0,function*(){const x=yield C3();c instanceof x&&!(m!=null&&m.noResolveJson)?c.json().then(S=>{const P=c.status||500,O=(S==null?void 0:S.statusCode)||P+"";a(new I3(rw(S),P,O))}).catch(S=>{a(new sb(rw(S),S))}):a(new sb(rw(c),c))}),R3=(c,a,m,x)=>{const S={method:c,headers:(a==null?void 0:a.headers)||{}};return c==="GET"||!x?S:(P3(x)?(S.headers=Object.assign({"Content-Type":"application/json"},a==null?void 0:a.headers),S.body=JSON.stringify(x)):S.body=x,a!=null&&a.duplex&&(S.duplex=a.duplex),Object.assign(Object.assign({},S),m))};function ag(c,a,m,x,S,P){return Oh(this,void 0,void 0,function*(){return new Promise((O,s)=>{c(m,R3(a,x,S,P)).then(Z=>{if(!Z.ok)throw Z;return x!=null&&x.noResolveJson?Z:Z.json()}).then(Z=>O(Z)).catch(Z=>M3(Z,s,x))})})}function lv(c,a,m,x){return Oh(this,void 0,void 0,function*(){return ag(c,"GET",a,m,x)})}function gl(c,a,m,x,S){return Oh(this,void 0,void 0,function*(){return ag(c,"POST",a,x,S,m)})}function lb(c,a,m,x,S){return Oh(this,void 0,void 0,function*(){return ag(c,"PUT",a,x,S,m)})}function k3(c,a,m,x){return Oh(this,void 0,void 0,function*(){return ag(c,"HEAD",a,Object.assign(Object.assign({},m),{noResolveJson:!0}),x)})}function uM(c,a,m,x,S){return Oh(this,void 0,void 0,function*(){return ag(c,"DELETE",a,x,S,m)})}var $o=function(c,a,m,x){function S(P){return P instanceof m?P:new m(function(O){O(P)})}return new(m||(m=Promise))(function(P,O){function s(me){try{Q(x.next(me))}catch(Ee){O(Ee)}}function Z(me){try{Q(x.throw(me))}catch(Ee){O(Ee)}}function Q(me){me.done?P(me.value):S(me.value).then(s,Z)}Q((x=x.apply(c,a||[])).next())})};const L3={limit:100,offset:0,sortBy:{column:"name",order:"asc"}},SA={cacheControl:"3600",contentType:"text/plain;charset=UTF-8",upsert:!1};class z3{constructor(a,m={},x,S){this.shouldThrowOnError=!1,this.url=a,this.headers=m,this.bucketId=x,this.fetch=cM(S)}throwOnError(){return this.shouldThrowOnError=!0,this}uploadOrUpdate(a,m,x,S){return $o(this,void 0,void 0,function*(){try{let P;const O=Object.assign(Object.assign({},SA),S);let s=Object.assign(Object.assign({},this.headers),a==="POST"&&{"x-upsert":String(O.upsert)});const Z=O.metadata;typeof Blob<"u"&&x instanceof Blob?(P=new FormData,P.append("cacheControl",O.cacheControl),Z&&P.append("metadata",this.encodeMetadata(Z)),P.append("",x)):typeof FormData<"u"&&x instanceof FormData?(P=x,P.append("cacheControl",O.cacheControl),Z&&P.append("metadata",this.encodeMetadata(Z))):(P=x,s["cache-control"]=`max-age=${O.cacheControl}`,s["content-type"]=O.contentType,Z&&(s["x-metadata"]=this.toBase64(this.encodeMetadata(Z)))),S!=null&&S.headers&&(s=Object.assign(Object.assign({},s),S.headers));const Q=this._removeEmptyFolders(m),me=this._getFinalPath(Q),Ee=yield(a=="PUT"?lb:gl)(this.fetch,`${this.url}/object/${me}`,P,Object.assign({headers:s},O!=null&&O.duplex?{duplex:O.duplex}:{}));return{data:{path:Q,id:Ee.Id,fullPath:Ee.Key},error:null}}catch(P){if(this.shouldThrowOnError)throw P;if(eo(P))return{data:null,error:P};throw P}})}upload(a,m,x){return $o(this,void 0,void 0,function*(){return this.uploadOrUpdate("POST",a,m,x)})}uploadToSignedUrl(a,m,x,S){return $o(this,void 0,void 0,function*(){const P=this._removeEmptyFolders(a),O=this._getFinalPath(P),s=new URL(this.url+`/object/upload/sign/${O}`);s.searchParams.set("token",m);try{let Z;const Q=Object.assign({upsert:SA.upsert},S),me=Object.assign(Object.assign({},this.headers),{"x-upsert":String(Q.upsert)});typeof Blob<"u"&&x instanceof Blob?(Z=new FormData,Z.append("cacheControl",Q.cacheControl),Z.append("",x)):typeof FormData<"u"&&x instanceof FormData?(Z=x,Z.append("cacheControl",Q.cacheControl)):(Z=x,me["cache-control"]=`max-age=${Q.cacheControl}`,me["content-type"]=Q.contentType);const Ee=yield lb(this.fetch,s.toString(),Z,{headers:me});return{data:{path:P,fullPath:Ee.Key},error:null}}catch(Z){if(this.shouldThrowOnError)throw Z;if(eo(Z))return{data:null,error:Z};throw Z}})}createSignedUploadUrl(a,m){return $o(this,void 0,void 0,function*(){try{let x=this._getFinalPath(a);const S=Object.assign({},this.headers);m!=null&&m.upsert&&(S["x-upsert"]="true");const P=yield gl(this.fetch,`${this.url}/object/upload/sign/${x}`,{},{headers:S}),O=new URL(this.url+P.url),s=O.searchParams.get("token");if(!s)throw new uT("No token returned by API");return{data:{signedUrl:O.toString(),path:a,token:s},error:null}}catch(x){if(this.shouldThrowOnError)throw x;if(eo(x))return{data:null,error:x};throw x}})}update(a,m,x){return $o(this,void 0,void 0,function*(){return this.uploadOrUpdate("PUT",a,m,x)})}move(a,m,x){return $o(this,void 0,void 0,function*(){try{return{data:yield gl(this.fetch,`${this.url}/object/move`,{bucketId:this.bucketId,sourceKey:a,destinationKey:m,destinationBucket:x==null?void 0:x.destinationBucket},{headers:this.headers}),error:null}}catch(S){if(this.shouldThrowOnError)throw S;if(eo(S))return{data:null,error:S};throw S}})}copy(a,m,x){return $o(this,void 0,void 0,function*(){try{return{data:{path:(yield gl(this.fetch,`${this.url}/object/copy`,{bucketId:this.bucketId,sourceKey:a,destinationKey:m,destinationBucket:x==null?void 0:x.destinationBucket},{headers:this.headers})).Key},error:null}}catch(S){if(this.shouldThrowOnError)throw S;if(eo(S))return{data:null,error:S};throw S}})}createSignedUrl(a,m,x){return $o(this,void 0,void 0,function*(){try{let S=this._getFinalPath(a),P=yield gl(this.fetch,`${this.url}/object/sign/${S}`,Object.assign({expiresIn:m},x!=null&&x.transform?{transform:x.transform}:{}),{headers:this.headers});const O=x!=null&&x.download?`&download=${x.download===!0?"":x.download}`:"";return P={signedUrl:encodeURI(`${this.url}${P.signedURL}${O}`)},{data:P,error:null}}catch(S){if(this.shouldThrowOnError)throw S;if(eo(S))return{data:null,error:S};throw S}})}createSignedUrls(a,m,x){return $o(this,void 0,void 0,function*(){try{const S=yield gl(this.fetch,`${this.url}/object/sign/${this.bucketId}`,{expiresIn:m,paths:a},{headers:this.headers}),P=x!=null&&x.download?`&download=${x.download===!0?"":x.download}`:"";return{data:S.map(O=>Object.assign(Object.assign({},O),{signedUrl:O.signedURL?encodeURI(`${this.url}${O.signedURL}${P}`):null})),error:null}}catch(S){if(this.shouldThrowOnError)throw S;if(eo(S))return{data:null,error:S};throw S}})}download(a,m){return $o(this,void 0,void 0,function*(){const S=typeof(m==null?void 0:m.transform)<"u"?"render/image/authenticated":"object",P=this.transformOptsToQueryString((m==null?void 0:m.transform)||{}),O=P?`?${P}`:"";try{const s=this._getFinalPath(a);return{data:yield(yield lv(this.fetch,`${this.url}/${S}/${s}${O}`,{headers:this.headers,noResolveJson:!0})).blob(),error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(eo(s))return{data:null,error:s};throw s}})}info(a){return $o(this,void 0,void 0,function*(){const m=this._getFinalPath(a);try{const x=yield lv(this.fetch,`${this.url}/object/info/${m}`,{headers:this.headers});return{data:ab(x),error:null}}catch(x){if(this.shouldThrowOnError)throw x;if(eo(x))return{data:null,error:x};throw x}})}exists(a){return $o(this,void 0,void 0,function*(){const m=this._getFinalPath(a);try{return yield k3(this.fetch,`${this.url}/object/${m}`,{headers:this.headers}),{data:!0,error:null}}catch(x){if(this.shouldThrowOnError)throw x;if(eo(x)&&x instanceof sb){const S=x.originalError;if([400,404].includes(S==null?void 0:S.status))return{data:!1,error:x}}throw x}})}getPublicUrl(a,m){const x=this._getFinalPath(a),S=[],P=m!=null&&m.download?`download=${m.download===!0?"":m.download}`:"";P!==""&&S.push(P);const s=typeof(m==null?void 0:m.transform)<"u"?"render/image":"object",Z=this.transformOptsToQueryString((m==null?void 0:m.transform)||{});Z!==""&&S.push(Z);let Q=S.join("&");return Q!==""&&(Q=`?${Q}`),{data:{publicUrl:encodeURI(`${this.url}/${s}/public/${x}${Q}`)}}}remove(a){return $o(this,void 0,void 0,function*(){try{return{data:yield uM(this.fetch,`${this.url}/object/${this.bucketId}`,{prefixes:a},{headers:this.headers}),error:null}}catch(m){if(this.shouldThrowOnError)throw m;if(eo(m))return{data:null,error:m};throw m}})}list(a,m,x){return $o(this,void 0,void 0,function*(){try{const S=Object.assign(Object.assign(Object.assign({},L3),m),{prefix:a||""});return{data:yield gl(this.fetch,`${this.url}/object/list/${this.bucketId}`,S,{headers:this.headers},x),error:null}}catch(S){if(this.shouldThrowOnError)throw S;if(eo(S))return{data:null,error:S};throw S}})}listV2(a,m){return $o(this,void 0,void 0,function*(){try{const x=Object.assign({},a);return{data:yield gl(this.fetch,`${this.url}/object/list-v2/${this.bucketId}`,x,{headers:this.headers},m),error:null}}catch(x){if(this.shouldThrowOnError)throw x;if(eo(x))return{data:null,error:x};throw x}})}encodeMetadata(a){return JSON.stringify(a)}toBase64(a){return typeof Buffer<"u"?Buffer.from(a).toString("base64"):btoa(a)}_getFinalPath(a){return`${this.bucketId}/${a.replace(/^\/+/,"")}`}_removeEmptyFolders(a){return a.replace(/^\/|\/$/g,"").replace(/\/+/g,"/")}transformOptsToQueryString(a){const m=[];return a.width&&m.push(`width=${a.width}`),a.height&&m.push(`height=${a.height}`),a.resize&&m.push(`resize=${a.resize}`),a.format&&m.push(`format=${a.format}`),a.quality&&m.push(`quality=${a.quality}`),m.join("&")}}const D3="2.12.1",O3={"X-Client-Info":`storage-js/${D3}`};var If=function(c,a,m,x){function S(P){return P instanceof m?P:new m(function(O){O(P)})}return new(m||(m=Promise))(function(P,O){function s(me){try{Q(x.next(me))}catch(Ee){O(Ee)}}function Z(me){try{Q(x.throw(me))}catch(Ee){O(Ee)}}function Q(me){me.done?P(me.value):S(me.value).then(s,Z)}Q((x=x.apply(c,a||[])).next())})};class F3{constructor(a,m={},x,S){this.shouldThrowOnError=!1;const P=new URL(a);S!=null&&S.useNewHostname&&/supabase\.(co|in|red)$/.test(P.hostname)&&!P.hostname.includes("storage.supabase.")&&(P.hostname=P.hostname.replace("supabase.","storage.supabase.")),this.url=P.href,this.headers=Object.assign(Object.assign({},O3),m),this.fetch=cM(x)}throwOnError(){return this.shouldThrowOnError=!0,this}listBuckets(){return If(this,void 0,void 0,function*(){try{return{data:yield lv(this.fetch,`${this.url}/bucket`,{headers:this.headers}),error:null}}catch(a){if(this.shouldThrowOnError)throw a;if(eo(a))return{data:null,error:a};throw a}})}getBucket(a){return If(this,void 0,void 0,function*(){try{return{data:yield lv(this.fetch,`${this.url}/bucket/${a}`,{headers:this.headers}),error:null}}catch(m){if(this.shouldThrowOnError)throw m;if(eo(m))return{data:null,error:m};throw m}})}createBucket(a,m={public:!1}){return If(this,void 0,void 0,function*(){try{return{data:yield gl(this.fetch,`${this.url}/bucket`,{id:a,name:a,type:m.type,public:m.public,file_size_limit:m.fileSizeLimit,allowed_mime_types:m.allowedMimeTypes},{headers:this.headers}),error:null}}catch(x){if(this.shouldThrowOnError)throw x;if(eo(x))return{data:null,error:x};throw x}})}updateBucket(a,m){return If(this,void 0,void 0,function*(){try{return{data:yield lb(this.fetch,`${this.url}/bucket/${a}`,{id:a,name:a,public:m.public,file_size_limit:m.fileSizeLimit,allowed_mime_types:m.allowedMimeTypes},{headers:this.headers}),error:null}}catch(x){if(this.shouldThrowOnError)throw x;if(eo(x))return{data:null,error:x};throw x}})}emptyBucket(a){return If(this,void 0,void 0,function*(){try{return{data:yield gl(this.fetch,`${this.url}/bucket/${a}/empty`,{},{headers:this.headers}),error:null}}catch(m){if(this.shouldThrowOnError)throw m;if(eo(m))return{data:null,error:m};throw m}})}deleteBucket(a){return If(this,void 0,void 0,function*(){try{return{data:yield uM(this.fetch,`${this.url}/bucket/${a}`,{},{headers:this.headers}),error:null}}catch(m){if(this.shouldThrowOnError)throw m;if(eo(m))return{data:null,error:m};throw m}})}}class B3 extends F3{constructor(a,m={},x,S){super(a,m,x,S)}from(a){return new z3(this.url,this.headers,a,this.fetch)}}const N3="2.57.4";let w_="";typeof Deno<"u"?w_="deno":typeof document<"u"?w_="web":typeof navigator<"u"&&navigator.product==="ReactNative"?w_="react-native":w_="node";const j3={"X-Client-Info":`supabase-js-${w_}/${N3}`},U3={headers:j3},V3={schema:"public"},$3={autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"},G3={};var H3=function(c,a,m,x){function S(P){return P instanceof m?P:new m(function(O){O(P)})}return new(m||(m=Promise))(function(P,O){function s(me){try{Q(x.next(me))}catch(Ee){O(Ee)}}function Z(me){try{Q(x.throw(me))}catch(Ee){O(Ee)}}function Q(me){me.done?P(me.value):S(me.value).then(s,Z)}Q((x=x.apply(c,a||[])).next())})};const q3=c=>{let a;return c?a=c:typeof fetch>"u"?a=XP:a=fetch,(...m)=>a(...m)},W3=()=>typeof Headers>"u"?KP:Headers,Z3=(c,a,m)=>{const x=q3(m),S=W3();return(P,O)=>H3(void 0,void 0,void 0,function*(){var s;const Z=(s=yield a())!==null&&s!==void 0?s:c;let Q=new S(O==null?void 0:O.headers);return Q.has("apikey")||Q.set("apikey",c),Q.has("Authorization")||Q.set("Authorization",`Bearer ${Z}`),x(P,Object.assign(Object.assign({},O),{headers:Q}))})};var X3=function(c,a,m,x){function S(P){return P instanceof m?P:new m(function(O){O(P)})}return new(m||(m=Promise))(function(P,O){function s(me){try{Q(x.next(me))}catch(Ee){O(Ee)}}function Z(me){try{Q(x.throw(me))}catch(Ee){O(Ee)}}function Q(me){me.done?P(me.value):S(me.value).then(s,Z)}Q((x=x.apply(c,a||[])).next())})};function K3(c){return c.endsWith("/")?c:c+"/"}function Y3(c,a){var m,x;const{db:S,auth:P,realtime:O,global:s}=c,{db:Z,auth:Q,realtime:me,global:Ee}=a,De={db:Object.assign(Object.assign({},Z),S),auth:Object.assign(Object.assign({},Q),P),realtime:Object.assign(Object.assign({},me),O),storage:{},global:Object.assign(Object.assign(Object.assign({},Ee),s),{headers:Object.assign(Object.assign({},(m=Ee==null?void 0:Ee.headers)!==null&&m!==void 0?m:{}),(x=s==null?void 0:s.headers)!==null&&x!==void 0?x:{})}),accessToken:()=>X3(this,void 0,void 0,function*(){return""})};return c.accessToken?De.accessToken=c.accessToken:delete De.accessToken,De}function J3(c){const a=c==null?void 0:c.trim();if(!a)throw new Error("supabaseUrl is required.");if(!a.match(/^https?:\/\//i))throw new Error("Invalid supabaseUrl: Must be a valid HTTP or HTTPS URL.");try{return new URL(K3(a))}catch{throw Error("Invalid supabaseUrl: Provided URL is malformed.")}}const hM="2.71.1",Rf=30*1e3,cb=3,ow=cb*Rf,Q3="http://localhost:9999",eF="supabase.auth.token",tF={"X-Client-Info":`gotrue-js/${hM}`},ub="X-Supabase-Api-Version",dM={"2024-01-01":{timestamp:Date.parse("2024-01-01T00:00:00.0Z"),name:"2024-01-01"}},iF=/^([a-z0-9_-]{4})*($|[a-z0-9_-]{3}$|[a-z0-9_-]{2}$)$/i,nF=10*60*1e3;class hT extends Error{constructor(a,m,x){super(a),this.__isAuthError=!0,this.name="AuthError",this.status=m,this.code=x}}function hn(c){return typeof c=="object"&&c!==null&&"__isAuthError"in c}class rF extends hT{constructor(a,m,x){super(a,m,x),this.name="AuthApiError",this.status=m,this.code=x}}function oF(c){return hn(c)&&c.name==="AuthApiError"}class fM extends hT{constructor(a,m){super(a),this.name="AuthUnknownError",this.originalError=m}}class xu extends hT{constructor(a,m,x,S){super(a,x,S),this.name=m,this.status=x}}class Qc extends xu{constructor(){super("Auth session missing!","AuthSessionMissingError",400,void 0)}}function sF(c){return hn(c)&&c.name==="AuthSessionMissingError"}class T0 extends xu{constructor(){super("Auth session or user missing","AuthInvalidTokenResponseError",500,void 0)}}class S0 extends xu{constructor(a){super(a,"AuthInvalidCredentialsError",400,void 0)}}class E0 extends xu{constructor(a,m=null){super(a,"AuthImplicitGrantRedirectError",500,void 0),this.details=null,this.details=m}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}function aF(c){return hn(c)&&c.name==="AuthImplicitGrantRedirectError"}class EA extends xu{constructor(a,m=null){super(a,"AuthPKCEGrantCodeExchangeError",500,void 0),this.details=null,this.details=m}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class hb extends xu{constructor(a,m){super(a,"AuthRetryableFetchError",m,void 0)}}function sw(c){return hn(c)&&c.name==="AuthRetryableFetchError"}class IA extends xu{constructor(a,m,x){super(a,"AuthWeakPasswordError",m,"weak_password"),this.reasons=x}}class db extends xu{constructor(a){super(a,"AuthInvalidJwtError",400,"invalid_jwt")}}const cv="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".split(""),AA=` 	
\r=`.split(""),lF=(()=>{const c=new Array(128);for(let a=0;a<c.length;a+=1)c[a]=-1;for(let a=0;a<AA.length;a+=1)c[AA[a].charCodeAt(0)]=-2;for(let a=0;a<cv.length;a+=1)c[cv[a].charCodeAt(0)]=a;return c})();function CA(c,a,m){if(c!==null)for(a.queue=a.queue<<8|c,a.queuedBits+=8;a.queuedBits>=6;){const x=a.queue>>a.queuedBits-6&63;m(cv[x]),a.queuedBits-=6}else if(a.queuedBits>0)for(a.queue=a.queue<<6-a.queuedBits,a.queuedBits=6;a.queuedBits>=6;){const x=a.queue>>a.queuedBits-6&63;m(cv[x]),a.queuedBits-=6}}function pM(c,a,m){const x=lF[c];if(x>-1)for(a.queue=a.queue<<6|x,a.queuedBits+=6;a.queuedBits>=8;)m(a.queue>>a.queuedBits-8&255),a.queuedBits-=8;else{if(x===-2)return;throw new Error(`Invalid Base64-URL character "${String.fromCharCode(c)}"`)}}function PA(c){const a=[],m=O=>{a.push(String.fromCodePoint(O))},x={utf8seq:0,codepoint:0},S={queue:0,queuedBits:0},P=O=>{hF(O,x,m)};for(let O=0;O<c.length;O+=1)pM(c.charCodeAt(O),S,P);return a.join("")}function cF(c,a){if(c<=127){a(c);return}else if(c<=2047){a(192|c>>6),a(128|c&63);return}else if(c<=65535){a(224|c>>12),a(128|c>>6&63),a(128|c&63);return}else if(c<=1114111){a(240|c>>18),a(128|c>>12&63),a(128|c>>6&63),a(128|c&63);return}throw new Error(`Unrecognized Unicode codepoint: ${c.toString(16)}`)}function uF(c,a){for(let m=0;m<c.length;m+=1){let x=c.charCodeAt(m);if(x>55295&&x<=56319){const S=(x-55296)*1024&65535;x=(c.charCodeAt(m+1)-56320&65535|S)+65536,m+=1}cF(x,a)}}function hF(c,a,m){if(a.utf8seq===0){if(c<=127){m(c);return}for(let x=1;x<6;x+=1)if(!(c>>7-x&1)){a.utf8seq=x;break}if(a.utf8seq===2)a.codepoint=c&31;else if(a.utf8seq===3)a.codepoint=c&15;else if(a.utf8seq===4)a.codepoint=c&7;else throw new Error("Invalid UTF-8 sequence");a.utf8seq-=1}else if(a.utf8seq>0){if(c<=127)throw new Error("Invalid UTF-8 sequence");a.codepoint=a.codepoint<<6|c&63,a.utf8seq-=1,a.utf8seq===0&&m(a.codepoint)}}function dF(c){const a=[],m={queue:0,queuedBits:0},x=S=>{a.push(S)};for(let S=0;S<c.length;S+=1)pM(c.charCodeAt(S),m,x);return new Uint8Array(a)}function fF(c){const a=[];return uF(c,m=>a.push(m)),new Uint8Array(a)}function pF(c){const a=[],m={queue:0,queuedBits:0},x=S=>{a.push(S)};return c.forEach(S=>CA(S,m,x)),CA(null,m,x),a.join("")}function mF(c){return Math.round(Date.now()/1e3)+c}function _F(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){const a=Math.random()*16|0;return(c=="x"?a:a&3|8).toString(16)})}const ka=()=>typeof window<"u"&&typeof document<"u",yh={tested:!1,writable:!1},mM=()=>{if(!ka())return!1;try{if(typeof globalThis.localStorage!="object")return!1}catch{return!1}if(yh.tested)return yh.writable;const c=`lswt-${Math.random()}${Math.random()}`;try{globalThis.localStorage.setItem(c,c),globalThis.localStorage.removeItem(c),yh.tested=!0,yh.writable=!0}catch{yh.tested=!0,yh.writable=!1}return yh.writable};function gF(c){const a={},m=new URL(c);if(m.hash&&m.hash[0]==="#")try{new URLSearchParams(m.hash.substring(1)).forEach((S,P)=>{a[P]=S})}catch{}return m.searchParams.forEach((x,S)=>{a[S]=x}),a}const _M=c=>{let a;return c?a=c:typeof fetch>"u"?a=(...m)=>og(async()=>{const{default:x}=await Promise.resolve().then(()=>lp);return{default:x}},void 0).then(({default:x})=>x(...m)):a=fetch,(...m)=>a(...m)},yF=c=>typeof c=="object"&&c!==null&&"status"in c&&"ok"in c&&"json"in c&&typeof c.json=="function",kf=async(c,a,m)=>{await c.setItem(a,JSON.stringify(m))},vh=async(c,a)=>{const m=await c.getItem(a);if(!m)return null;try{return JSON.parse(m)}catch{return m}},Jc=async(c,a)=>{await c.removeItem(a)};class Mv{constructor(){this.promise=new Mv.promiseConstructor((a,m)=>{this.resolve=a,this.reject=m})}}Mv.promiseConstructor=Promise;function aw(c){const a=c.split(".");if(a.length!==3)throw new db("Invalid JWT structure");for(let x=0;x<a.length;x++)if(!iF.test(a[x]))throw new db("JWT not in base64url format");return{header:JSON.parse(PA(a[0])),payload:JSON.parse(PA(a[1])),signature:dF(a[2]),raw:{header:a[0],payload:a[1]}}}async function vF(c){return await new Promise(a=>{setTimeout(()=>a(null),c)})}function xF(c,a){return new Promise((x,S)=>{(async()=>{for(let P=0;P<1/0;P++)try{const O=await c(P);if(!a(P,null,O)){x(O);return}}catch(O){if(!a(P,O)){S(O);return}}})()})}function wF(c){return("0"+c.toString(16)).substr(-2)}function bF(){const a=new Uint32Array(56);if(typeof crypto>"u"){const m="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",x=m.length;let S="";for(let P=0;P<56;P++)S+=m.charAt(Math.floor(Math.random()*x));return S}return crypto.getRandomValues(a),Array.from(a,wF).join("")}async function TF(c){const m=new TextEncoder().encode(c),x=await crypto.subtle.digest("SHA-256",m),S=new Uint8Array(x);return Array.from(S).map(P=>String.fromCharCode(P)).join("")}async function SF(c){if(!(typeof crypto<"u"&&typeof crypto.subtle<"u"&&typeof TextEncoder<"u"))return console.warn("WebCrypto API is not supported. Code challenge method will default to use plain instead of sha256."),c;const m=await TF(c);return btoa(m).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function Af(c,a,m=!1){const x=bF();let S=x;m&&(S+="/PASSWORD_RECOVERY"),await kf(c,`${a}-code-verifier`,S);const P=await SF(x);return[P,x===P?"plain":"s256"]}const EF=/^2[0-9]{3}-(0[1-9]|1[0-2])-(0[1-9]|1[0-9]|2[0-9]|3[0-1])$/i;function IF(c){const a=c.headers.get(ub);if(!a||!a.match(EF))return null;try{return new Date(`${a}T00:00:00.0Z`)}catch{return null}}function AF(c){if(!c)throw new Error("Missing exp claim");const a=Math.floor(Date.now()/1e3);if(c<=a)throw new Error("JWT has expired")}function CF(c){switch(c){case"RS256":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case"ES256":return{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}};default:throw new Error("Invalid alg claim")}}const PF=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;function Cf(c){if(!PF.test(c))throw new Error("@supabase/auth-js: Expected parameter to be UUID but is not")}function lw(){const c={};return new Proxy(c,{get:(a,m)=>{if(m==="__isUserNotAvailableProxy")return!0;if(typeof m=="symbol"){const x=m.toString();if(x==="Symbol(Symbol.toPrimitive)"||x==="Symbol(Symbol.toStringTag)"||x==="Symbol(util.inspect.custom)")return}throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Accessing the "${m}" property of the session object is not supported. Please use getUser() instead.`)},set:(a,m)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Setting the "${m}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)},deleteProperty:(a,m)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Deleting the "${m}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)}})}function MA(c){return JSON.parse(JSON.stringify(c))}var MF=function(c,a){var m={};for(var x in c)Object.prototype.hasOwnProperty.call(c,x)&&a.indexOf(x)<0&&(m[x]=c[x]);if(c!=null&&typeof Object.getOwnPropertySymbols=="function")for(var S=0,x=Object.getOwnPropertySymbols(c);S<x.length;S++)a.indexOf(x[S])<0&&Object.prototype.propertyIsEnumerable.call(c,x[S])&&(m[x[S]]=c[x[S]]);return m};const bh=c=>c.msg||c.message||c.error_description||c.error||JSON.stringify(c),RF=[502,503,504];async function RA(c){var a;if(!yF(c))throw new hb(bh(c),0);if(RF.includes(c.status))throw new hb(bh(c),c.status);let m;try{m=await c.json()}catch(P){throw new fM(bh(P),P)}let x;const S=IF(c);if(S&&S.getTime()>=dM["2024-01-01"].timestamp&&typeof m=="object"&&m&&typeof m.code=="string"?x=m.code:typeof m=="object"&&m&&typeof m.error_code=="string"&&(x=m.error_code),x){if(x==="weak_password")throw new IA(bh(m),c.status,((a=m.weak_password)===null||a===void 0?void 0:a.reasons)||[]);if(x==="session_not_found")throw new Qc}else if(typeof m=="object"&&m&&typeof m.weak_password=="object"&&m.weak_password&&Array.isArray(m.weak_password.reasons)&&m.weak_password.reasons.length&&m.weak_password.reasons.reduce((P,O)=>P&&typeof O=="string",!0))throw new IA(bh(m),c.status,m.weak_password.reasons);throw new rF(bh(m),c.status||500,x)}const kF=(c,a,m,x)=>{const S={method:c,headers:(a==null?void 0:a.headers)||{}};return c==="GET"?S:(S.headers=Object.assign({"Content-Type":"application/json;charset=UTF-8"},a==null?void 0:a.headers),S.body=JSON.stringify(x),Object.assign(Object.assign({},S),m))};async function Sn(c,a,m,x){var S;const P=Object.assign({},x==null?void 0:x.headers);P[ub]||(P[ub]=dM["2024-01-01"].name),x!=null&&x.jwt&&(P.Authorization=`Bearer ${x.jwt}`);const O=(S=x==null?void 0:x.query)!==null&&S!==void 0?S:{};x!=null&&x.redirectTo&&(O.redirect_to=x.redirectTo);const s=Object.keys(O).length?"?"+new URLSearchParams(O).toString():"",Z=await LF(c,a,m+s,{headers:P,noResolveJson:x==null?void 0:x.noResolveJson},{},x==null?void 0:x.body);return x!=null&&x.xform?x==null?void 0:x.xform(Z):{data:Object.assign({},Z),error:null}}async function LF(c,a,m,x,S,P){const O=kF(a,x,S,P);let s;try{s=await c(m,Object.assign({},O))}catch(Z){throw console.error(Z),new hb(bh(Z),0)}if(s.ok||await RA(s),x!=null&&x.noResolveJson)return s;try{return await s.json()}catch(Z){await RA(Z)}}function ic(c){var a;let m=null;FF(c)&&(m=Object.assign({},c),c.expires_at||(m.expires_at=mF(c.expires_in)));const x=(a=c.user)!==null&&a!==void 0?a:c;return{data:{session:m,user:x},error:null}}function kA(c){const a=ic(c);return!a.error&&c.weak_password&&typeof c.weak_password=="object"&&Array.isArray(c.weak_password.reasons)&&c.weak_password.reasons.length&&c.weak_password.message&&typeof c.weak_password.message=="string"&&c.weak_password.reasons.reduce((m,x)=>m&&typeof x=="string",!0)&&(a.data.weak_password=c.weak_password),a}function ru(c){var a;return{data:{user:(a=c.user)!==null&&a!==void 0?a:c},error:null}}function zF(c){return{data:c,error:null}}function DF(c){const{action_link:a,email_otp:m,hashed_token:x,redirect_to:S,verification_type:P}=c,O=MF(c,["action_link","email_otp","hashed_token","redirect_to","verification_type"]),s={action_link:a,email_otp:m,hashed_token:x,redirect_to:S,verification_type:P},Z=Object.assign({},O);return{data:{properties:s,user:Z},error:null}}function OF(c){return c}function FF(c){return c.access_token&&c.refresh_token&&c.expires_in}const cw=["global","local","others"];var BF=function(c,a){var m={};for(var x in c)Object.prototype.hasOwnProperty.call(c,x)&&a.indexOf(x)<0&&(m[x]=c[x]);if(c!=null&&typeof Object.getOwnPropertySymbols=="function")for(var S=0,x=Object.getOwnPropertySymbols(c);S<x.length;S++)a.indexOf(x[S])<0&&Object.prototype.propertyIsEnumerable.call(c,x[S])&&(m[x[S]]=c[x[S]]);return m};class NF{constructor({url:a="",headers:m={},fetch:x}){this.url=a,this.headers=m,this.fetch=_M(x),this.mfa={listFactors:this._listFactors.bind(this),deleteFactor:this._deleteFactor.bind(this)}}async signOut(a,m=cw[0]){if(cw.indexOf(m)<0)throw new Error(`@supabase/auth-js: Parameter scope must be one of ${cw.join(", ")}`);try{return await Sn(this.fetch,"POST",`${this.url}/logout?scope=${m}`,{headers:this.headers,jwt:a,noResolveJson:!0}),{data:null,error:null}}catch(x){if(hn(x))return{data:null,error:x};throw x}}async inviteUserByEmail(a,m={}){try{return await Sn(this.fetch,"POST",`${this.url}/invite`,{body:{email:a,data:m.data},headers:this.headers,redirectTo:m.redirectTo,xform:ru})}catch(x){if(hn(x))return{data:{user:null},error:x};throw x}}async generateLink(a){try{const{options:m}=a,x=BF(a,["options"]),S=Object.assign(Object.assign({},x),m);return"newEmail"in x&&(S.new_email=x==null?void 0:x.newEmail,delete S.newEmail),await Sn(this.fetch,"POST",`${this.url}/admin/generate_link`,{body:S,headers:this.headers,xform:DF,redirectTo:m==null?void 0:m.redirectTo})}catch(m){if(hn(m))return{data:{properties:null,user:null},error:m};throw m}}async createUser(a){try{return await Sn(this.fetch,"POST",`${this.url}/admin/users`,{body:a,headers:this.headers,xform:ru})}catch(m){if(hn(m))return{data:{user:null},error:m};throw m}}async listUsers(a){var m,x,S,P,O,s,Z;try{const Q={nextPage:null,lastPage:0,total:0},me=await Sn(this.fetch,"GET",`${this.url}/admin/users`,{headers:this.headers,noResolveJson:!0,query:{page:(x=(m=a==null?void 0:a.page)===null||m===void 0?void 0:m.toString())!==null&&x!==void 0?x:"",per_page:(P=(S=a==null?void 0:a.perPage)===null||S===void 0?void 0:S.toString())!==null&&P!==void 0?P:""},xform:OF});if(me.error)throw me.error;const Ee=await me.json(),De=(O=me.headers.get("x-total-count"))!==null&&O!==void 0?O:0,Xe=(Z=(s=me.headers.get("link"))===null||s===void 0?void 0:s.split(","))!==null&&Z!==void 0?Z:[];return Xe.length>0&&(Xe.forEach(mt=>{const We=parseInt(mt.split(";")[0].split("=")[1].substring(0,1)),ct=JSON.parse(mt.split(";")[1].split("=")[1]);Q[`${ct}Page`]=We}),Q.total=parseInt(De)),{data:Object.assign(Object.assign({},Ee),Q),error:null}}catch(Q){if(hn(Q))return{data:{users:[]},error:Q};throw Q}}async getUserById(a){Cf(a);try{return await Sn(this.fetch,"GET",`${this.url}/admin/users/${a}`,{headers:this.headers,xform:ru})}catch(m){if(hn(m))return{data:{user:null},error:m};throw m}}async updateUserById(a,m){Cf(a);try{return await Sn(this.fetch,"PUT",`${this.url}/admin/users/${a}`,{body:m,headers:this.headers,xform:ru})}catch(x){if(hn(x))return{data:{user:null},error:x};throw x}}async deleteUser(a,m=!1){Cf(a);try{return await Sn(this.fetch,"DELETE",`${this.url}/admin/users/${a}`,{headers:this.headers,body:{should_soft_delete:m},xform:ru})}catch(x){if(hn(x))return{data:{user:null},error:x};throw x}}async _listFactors(a){Cf(a.userId);try{const{data:m,error:x}=await Sn(this.fetch,"GET",`${this.url}/admin/users/${a.userId}/factors`,{headers:this.headers,xform:S=>({data:{factors:S},error:null})});return{data:m,error:x}}catch(m){if(hn(m))return{data:null,error:m};throw m}}async _deleteFactor(a){Cf(a.userId),Cf(a.id);try{return{data:await Sn(this.fetch,"DELETE",`${this.url}/admin/users/${a.userId}/factors/${a.id}`,{headers:this.headers}),error:null}}catch(m){if(hn(m))return{data:null,error:m};throw m}}}function LA(c={}){return{getItem:a=>c[a]||null,setItem:(a,m)=>{c[a]=m},removeItem:a=>{delete c[a]}}}function jF(){if(typeof globalThis!="object")try{Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__}catch{typeof self<"u"&&(self.globalThis=self)}}const Pf={debug:!!(globalThis&&mM()&&globalThis.localStorage&&globalThis.localStorage.getItem("supabase.gotrue-js.locks.debug")==="true")};class gM extends Error{constructor(a){super(a),this.isAcquireTimeout=!0}}class UF extends gM{}async function VF(c,a,m){Pf.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquire lock",c,a);const x=new globalThis.AbortController;return a>0&&setTimeout(()=>{x.abort(),Pf.debug&&console.log("@supabase/gotrue-js: navigatorLock acquire timed out",c)},a),await Promise.resolve().then(()=>globalThis.navigator.locks.request(c,a===0?{mode:"exclusive",ifAvailable:!0}:{mode:"exclusive",signal:x.signal},async S=>{if(S){Pf.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquired",c,S.name);try{return await m()}finally{Pf.debug&&console.log("@supabase/gotrue-js: navigatorLock: released",c,S.name)}}else{if(a===0)throw Pf.debug&&console.log("@supabase/gotrue-js: navigatorLock: not immediately available",c),new UF(`Acquiring an exclusive Navigator LockManager lock "${c}" immediately failed`);if(Pf.debug)try{const P=await globalThis.navigator.locks.query();console.log("@supabase/gotrue-js: Navigator LockManager state",JSON.stringify(P,null,"  "))}catch(P){console.warn("@supabase/gotrue-js: Error when querying Navigator LockManager state",P)}return console.warn("@supabase/gotrue-js: Navigator LockManager returned a null lock when using #request without ifAvailable set to true, it appears this browser is not following the LockManager spec https://developer.mozilla.org/en-US/docs/Web/API/LockManager/request"),await m()}}))}jF();const $F={url:Q3,storageKey:eF,autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:tF,flowType:"implicit",debug:!1,hasCustomAuthorizationHeader:!1};async function zA(c,a,m){return await m()}const Mf={};class J_{constructor(a){var m,x;this.userStorage=null,this.memoryStorage=null,this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.hasCustomAuthorizationHeader=!1,this.suppressGetSessionWarning=!1,this.lockAcquired=!1,this.pendingInLock=[],this.broadcastChannel=null,this.logger=console.log,this.instanceID=J_.nextInstanceID,J_.nextInstanceID+=1,this.instanceID>0&&ka()&&console.warn("Multiple GoTrueClient instances detected in the same browser context. It is not an error, but this should be avoided as it may produce undefined behavior when used concurrently under the same storage key.");const S=Object.assign(Object.assign({},$F),a);if(this.logDebugMessages=!!S.debug,typeof S.debug=="function"&&(this.logger=S.debug),this.persistSession=S.persistSession,this.storageKey=S.storageKey,this.autoRefreshToken=S.autoRefreshToken,this.admin=new NF({url:S.url,headers:S.headers,fetch:S.fetch}),this.url=S.url,this.headers=S.headers,this.fetch=_M(S.fetch),this.lock=S.lock||zA,this.detectSessionInUrl=S.detectSessionInUrl,this.flowType=S.flowType,this.hasCustomAuthorizationHeader=S.hasCustomAuthorizationHeader,S.lock?this.lock=S.lock:ka()&&(!((m=globalThis==null?void 0:globalThis.navigator)===null||m===void 0)&&m.locks)?this.lock=VF:this.lock=zA,this.jwks||(this.jwks={keys:[]},this.jwks_cached_at=Number.MIN_SAFE_INTEGER),this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this)},this.persistSession?(S.storage?this.storage=S.storage:mM()?this.storage=globalThis.localStorage:(this.memoryStorage={},this.storage=LA(this.memoryStorage)),S.userStorage&&(this.userStorage=S.userStorage)):(this.memoryStorage={},this.storage=LA(this.memoryStorage)),ka()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(P){console.error("Failed to create a new BroadcastChannel, multi-tab state changes will not be available",P)}(x=this.broadcastChannel)===null||x===void 0||x.addEventListener("message",async P=>{this._debug("received broadcast notification from other tab or client",P),await this._notifyAllSubscribers(P.data.event,P.data.session,!1)})}this.initialize()}get jwks(){var a,m;return(m=(a=Mf[this.storageKey])===null||a===void 0?void 0:a.jwks)!==null&&m!==void 0?m:{keys:[]}}set jwks(a){Mf[this.storageKey]=Object.assign(Object.assign({},Mf[this.storageKey]),{jwks:a})}get jwks_cached_at(){var a,m;return(m=(a=Mf[this.storageKey])===null||a===void 0?void 0:a.cachedAt)!==null&&m!==void 0?m:Number.MIN_SAFE_INTEGER}set jwks_cached_at(a){Mf[this.storageKey]=Object.assign(Object.assign({},Mf[this.storageKey]),{cachedAt:a})}_debug(...a){return this.logDebugMessages&&this.logger(`GoTrueClient@${this.instanceID} (${hM}) ${new Date().toISOString()}`,...a),this}async initialize(){return this.initializePromise?await this.initializePromise:(this.initializePromise=(async()=>await this._acquireLock(-1,async()=>await this._initialize()))(),await this.initializePromise)}async _initialize(){var a;try{const m=gF(window.location.href);let x="none";if(this._isImplicitGrantCallback(m)?x="implicit":await this._isPKCECallback(m)&&(x="pkce"),ka()&&this.detectSessionInUrl&&x!=="none"){const{data:S,error:P}=await this._getSessionFromURL(m,x);if(P){if(this._debug("#_initialize()","error detecting session from URL",P),aF(P)){const Z=(a=P.details)===null||a===void 0?void 0:a.code;if(Z==="identity_already_exists"||Z==="identity_not_found"||Z==="single_identity_not_deletable")return{error:P}}return await this._removeSession(),{error:P}}const{session:O,redirectType:s}=S;return this._debug("#_initialize()","detected session in URL",O,"redirect type",s),await this._saveSession(O),setTimeout(async()=>{s==="recovery"?await this._notifyAllSubscribers("PASSWORD_RECOVERY",O):await this._notifyAllSubscribers("SIGNED_IN",O)},0),{error:null}}return await this._recoverAndRefresh(),{error:null}}catch(m){return hn(m)?{error:m}:{error:new fM("Unexpected error during initialization",m)}}finally{await this._handleVisibilityChange(),this._debug("#_initialize()","end")}}async signInAnonymously(a){var m,x,S;try{const P=await Sn(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{data:(x=(m=a==null?void 0:a.options)===null||m===void 0?void 0:m.data)!==null&&x!==void 0?x:{},gotrue_meta_security:{captcha_token:(S=a==null?void 0:a.options)===null||S===void 0?void 0:S.captchaToken}},xform:ic}),{data:O,error:s}=P;if(s||!O)return{data:{user:null,session:null},error:s};const Z=O.session,Q=O.user;return O.session&&(await this._saveSession(O.session),await this._notifyAllSubscribers("SIGNED_IN",Z)),{data:{user:Q,session:Z},error:null}}catch(P){if(hn(P))return{data:{user:null,session:null},error:P};throw P}}async signUp(a){var m,x,S;try{let P;if("email"in a){const{email:me,password:Ee,options:De}=a;let Xe=null,mt=null;this.flowType==="pkce"&&([Xe,mt]=await Af(this.storage,this.storageKey)),P=await Sn(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,redirectTo:De==null?void 0:De.emailRedirectTo,body:{email:me,password:Ee,data:(m=De==null?void 0:De.data)!==null&&m!==void 0?m:{},gotrue_meta_security:{captcha_token:De==null?void 0:De.captchaToken},code_challenge:Xe,code_challenge_method:mt},xform:ic})}else if("phone"in a){const{phone:me,password:Ee,options:De}=a;P=await Sn(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{phone:me,password:Ee,data:(x=De==null?void 0:De.data)!==null&&x!==void 0?x:{},channel:(S=De==null?void 0:De.channel)!==null&&S!==void 0?S:"sms",gotrue_meta_security:{captcha_token:De==null?void 0:De.captchaToken}},xform:ic})}else throw new S0("You must provide either an email or phone number and a password");const{data:O,error:s}=P;if(s||!O)return{data:{user:null,session:null},error:s};const Z=O.session,Q=O.user;return O.session&&(await this._saveSession(O.session),await this._notifyAllSubscribers("SIGNED_IN",Z)),{data:{user:Q,session:Z},error:null}}catch(P){if(hn(P))return{data:{user:null,session:null},error:P};throw P}}async signInWithPassword(a){try{let m;if("email"in a){const{email:P,password:O,options:s}=a;m=await Sn(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{email:P,password:O,gotrue_meta_security:{captcha_token:s==null?void 0:s.captchaToken}},xform:kA})}else if("phone"in a){const{phone:P,password:O,options:s}=a;m=await Sn(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{phone:P,password:O,gotrue_meta_security:{captcha_token:s==null?void 0:s.captchaToken}},xform:kA})}else throw new S0("You must provide either an email or phone number and a password");const{data:x,error:S}=m;return S?{data:{user:null,session:null},error:S}:!x||!x.session||!x.user?{data:{user:null,session:null},error:new T0}:(x.session&&(await this._saveSession(x.session),await this._notifyAllSubscribers("SIGNED_IN",x.session)),{data:Object.assign({user:x.user,session:x.session},x.weak_password?{weakPassword:x.weak_password}:null),error:S})}catch(m){if(hn(m))return{data:{user:null,session:null},error:m};throw m}}async signInWithOAuth(a){var m,x,S,P;return await this._handleProviderSignIn(a.provider,{redirectTo:(m=a.options)===null||m===void 0?void 0:m.redirectTo,scopes:(x=a.options)===null||x===void 0?void 0:x.scopes,queryParams:(S=a.options)===null||S===void 0?void 0:S.queryParams,skipBrowserRedirect:(P=a.options)===null||P===void 0?void 0:P.skipBrowserRedirect})}async exchangeCodeForSession(a){return await this.initializePromise,this._acquireLock(-1,async()=>this._exchangeCodeForSession(a))}async signInWithWeb3(a){const{chain:m}=a;if(m==="solana")return await this.signInWithSolana(a);throw new Error(`@supabase/auth-js: Unsupported chain "${m}"`)}async signInWithSolana(a){var m,x,S,P,O,s,Z,Q,me,Ee,De,Xe;let mt,We;if("message"in a)mt=a.message,We=a.signature;else{const{chain:ct,wallet:Me,statement:xe,options:Pe}=a;let Ze;if(ka())if(typeof Me=="object")Ze=Me;else{const kt=window;if("solana"in kt&&typeof kt.solana=="object"&&("signIn"in kt.solana&&typeof kt.solana.signIn=="function"||"signMessage"in kt.solana&&typeof kt.solana.signMessage=="function"))Ze=kt.solana;else throw new Error("@supabase/auth-js: No compatible Solana wallet interface on the window object (window.solana) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'solana', wallet: resolvedUserWallet }) instead.")}else{if(typeof Me!="object"||!(Pe!=null&&Pe.url))throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");Ze=Me}const Ct=new URL((m=Pe==null?void 0:Pe.url)!==null&&m!==void 0?m:window.location.href);if("signIn"in Ze&&Ze.signIn){const kt=await Ze.signIn(Object.assign(Object.assign(Object.assign({issuedAt:new Date().toISOString()},Pe==null?void 0:Pe.signInWithSolana),{version:"1",domain:Ct.host,uri:Ct.href}),xe?{statement:xe}:null));let zt;if(Array.isArray(kt)&&kt[0]&&typeof kt[0]=="object")zt=kt[0];else if(kt&&typeof kt=="object"&&"signedMessage"in kt&&"signature"in kt)zt=kt;else throw new Error("@supabase/auth-js: Wallet method signIn() returned unrecognized value");if("signedMessage"in zt&&"signature"in zt&&(typeof zt.signedMessage=="string"||zt.signedMessage instanceof Uint8Array)&&zt.signature instanceof Uint8Array)mt=typeof zt.signedMessage=="string"?zt.signedMessage:new TextDecoder().decode(zt.signedMessage),We=zt.signature;else throw new Error("@supabase/auth-js: Wallet method signIn() API returned object without signedMessage and signature fields")}else{if(!("signMessage"in Ze)||typeof Ze.signMessage!="function"||!("publicKey"in Ze)||typeof Ze!="object"||!Ze.publicKey||!("toBase58"in Ze.publicKey)||typeof Ze.publicKey.toBase58!="function")throw new Error("@supabase/auth-js: Wallet does not have a compatible signMessage() and publicKey.toBase58() API");mt=[`${Ct.host} wants you to sign in with your Solana account:`,Ze.publicKey.toBase58(),...xe?["",xe,""]:[""],"Version: 1",`URI: ${Ct.href}`,`Issued At: ${(S=(x=Pe==null?void 0:Pe.signInWithSolana)===null||x===void 0?void 0:x.issuedAt)!==null&&S!==void 0?S:new Date().toISOString()}`,...!((P=Pe==null?void 0:Pe.signInWithSolana)===null||P===void 0)&&P.notBefore?[`Not Before: ${Pe.signInWithSolana.notBefore}`]:[],...!((O=Pe==null?void 0:Pe.signInWithSolana)===null||O===void 0)&&O.expirationTime?[`Expiration Time: ${Pe.signInWithSolana.expirationTime}`]:[],...!((s=Pe==null?void 0:Pe.signInWithSolana)===null||s===void 0)&&s.chainId?[`Chain ID: ${Pe.signInWithSolana.chainId}`]:[],...!((Z=Pe==null?void 0:Pe.signInWithSolana)===null||Z===void 0)&&Z.nonce?[`Nonce: ${Pe.signInWithSolana.nonce}`]:[],...!((Q=Pe==null?void 0:Pe.signInWithSolana)===null||Q===void 0)&&Q.requestId?[`Request ID: ${Pe.signInWithSolana.requestId}`]:[],...!((Ee=(me=Pe==null?void 0:Pe.signInWithSolana)===null||me===void 0?void 0:me.resources)===null||Ee===void 0)&&Ee.length?["Resources",...Pe.signInWithSolana.resources.map(zt=>`- ${zt}`)]:[]].join(`
`);const kt=await Ze.signMessage(new TextEncoder().encode(mt),"utf8");if(!kt||!(kt instanceof Uint8Array))throw new Error("@supabase/auth-js: Wallet signMessage() API returned an recognized value");We=kt}}try{const{data:ct,error:Me}=await Sn(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"solana",message:mt,signature:pF(We)},!((De=a.options)===null||De===void 0)&&De.captchaToken?{gotrue_meta_security:{captcha_token:(Xe=a.options)===null||Xe===void 0?void 0:Xe.captchaToken}}:null),xform:ic});if(Me)throw Me;return!ct||!ct.session||!ct.user?{data:{user:null,session:null},error:new T0}:(ct.session&&(await this._saveSession(ct.session),await this._notifyAllSubscribers("SIGNED_IN",ct.session)),{data:Object.assign({},ct),error:Me})}catch(ct){if(hn(ct))return{data:{user:null,session:null},error:ct};throw ct}}async _exchangeCodeForSession(a){const m=await vh(this.storage,`${this.storageKey}-code-verifier`),[x,S]=(m??"").split("/");try{const{data:P,error:O}=await Sn(this.fetch,"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:a,code_verifier:x},xform:ic});if(await Jc(this.storage,`${this.storageKey}-code-verifier`),O)throw O;return!P||!P.session||!P.user?{data:{user:null,session:null,redirectType:null},error:new T0}:(P.session&&(await this._saveSession(P.session),await this._notifyAllSubscribers("SIGNED_IN",P.session)),{data:Object.assign(Object.assign({},P),{redirectType:S??null}),error:O})}catch(P){if(hn(P))return{data:{user:null,session:null,redirectType:null},error:P};throw P}}async signInWithIdToken(a){try{const{options:m,provider:x,token:S,access_token:P,nonce:O}=a,s=await Sn(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider:x,id_token:S,access_token:P,nonce:O,gotrue_meta_security:{captcha_token:m==null?void 0:m.captchaToken}},xform:ic}),{data:Z,error:Q}=s;return Q?{data:{user:null,session:null},error:Q}:!Z||!Z.session||!Z.user?{data:{user:null,session:null},error:new T0}:(Z.session&&(await this._saveSession(Z.session),await this._notifyAllSubscribers("SIGNED_IN",Z.session)),{data:Z,error:Q})}catch(m){if(hn(m))return{data:{user:null,session:null},error:m};throw m}}async signInWithOtp(a){var m,x,S,P,O;try{if("email"in a){const{email:s,options:Z}=a;let Q=null,me=null;this.flowType==="pkce"&&([Q,me]=await Af(this.storage,this.storageKey));const{error:Ee}=await Sn(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email:s,data:(m=Z==null?void 0:Z.data)!==null&&m!==void 0?m:{},create_user:(x=Z==null?void 0:Z.shouldCreateUser)!==null&&x!==void 0?x:!0,gotrue_meta_security:{captcha_token:Z==null?void 0:Z.captchaToken},code_challenge:Q,code_challenge_method:me},redirectTo:Z==null?void 0:Z.emailRedirectTo});return{data:{user:null,session:null},error:Ee}}if("phone"in a){const{phone:s,options:Z}=a,{data:Q,error:me}=await Sn(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone:s,data:(S=Z==null?void 0:Z.data)!==null&&S!==void 0?S:{},create_user:(P=Z==null?void 0:Z.shouldCreateUser)!==null&&P!==void 0?P:!0,gotrue_meta_security:{captcha_token:Z==null?void 0:Z.captchaToken},channel:(O=Z==null?void 0:Z.channel)!==null&&O!==void 0?O:"sms"}});return{data:{user:null,session:null,messageId:Q==null?void 0:Q.message_id},error:me}}throw new S0("You must provide either an email or phone number.")}catch(s){if(hn(s))return{data:{user:null,session:null},error:s};throw s}}async verifyOtp(a){var m,x;try{let S,P;"options"in a&&(S=(m=a.options)===null||m===void 0?void 0:m.redirectTo,P=(x=a.options)===null||x===void 0?void 0:x.captchaToken);const{data:O,error:s}=await Sn(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},a),{gotrue_meta_security:{captcha_token:P}}),redirectTo:S,xform:ic});if(s)throw s;if(!O)throw new Error("An error occurred on token verification.");const Z=O.session,Q=O.user;return Z!=null&&Z.access_token&&(await this._saveSession(Z),await this._notifyAllSubscribers(a.type=="recovery"?"PASSWORD_RECOVERY":"SIGNED_IN",Z)),{data:{user:Q,session:Z},error:null}}catch(S){if(hn(S))return{data:{user:null,session:null},error:S};throw S}}async signInWithSSO(a){var m,x,S;try{let P=null,O=null;return this.flowType==="pkce"&&([P,O]=await Af(this.storage,this.storageKey)),await Sn(this.fetch,"POST",`${this.url}/sso`,{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in a?{provider_id:a.providerId}:null),"domain"in a?{domain:a.domain}:null),{redirect_to:(x=(m=a.options)===null||m===void 0?void 0:m.redirectTo)!==null&&x!==void 0?x:void 0}),!((S=a==null?void 0:a.options)===null||S===void 0)&&S.captchaToken?{gotrue_meta_security:{captcha_token:a.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:P,code_challenge_method:O}),headers:this.headers,xform:zF})}catch(P){if(hn(P))return{data:null,error:P};throw P}}async reauthenticate(){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._reauthenticate())}async _reauthenticate(){try{return await this._useSession(async a=>{const{data:{session:m},error:x}=a;if(x)throw x;if(!m)throw new Qc;const{error:S}=await Sn(this.fetch,"GET",`${this.url}/reauthenticate`,{headers:this.headers,jwt:m.access_token});return{data:{user:null,session:null},error:S}})}catch(a){if(hn(a))return{data:{user:null,session:null},error:a};throw a}}async resend(a){try{const m=`${this.url}/resend`;if("email"in a){const{email:x,type:S,options:P}=a,{error:O}=await Sn(this.fetch,"POST",m,{headers:this.headers,body:{email:x,type:S,gotrue_meta_security:{captcha_token:P==null?void 0:P.captchaToken}},redirectTo:P==null?void 0:P.emailRedirectTo});return{data:{user:null,session:null},error:O}}else if("phone"in a){const{phone:x,type:S,options:P}=a,{data:O,error:s}=await Sn(this.fetch,"POST",m,{headers:this.headers,body:{phone:x,type:S,gotrue_meta_security:{captcha_token:P==null?void 0:P.captchaToken}}});return{data:{user:null,session:null,messageId:O==null?void 0:O.message_id},error:s}}throw new S0("You must provide either an email or phone number and a type")}catch(m){if(hn(m))return{data:{user:null,session:null},error:m};throw m}}async getSession(){return await this.initializePromise,await this._acquireLock(-1,async()=>this._useSession(async m=>m))}async _acquireLock(a,m){this._debug("#_acquireLock","begin",a);try{if(this.lockAcquired){const x=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),S=(async()=>(await x,await m()))();return this.pendingInLock.push((async()=>{try{await S}catch{}})()),S}return await this.lock(`lock:${this.storageKey}`,a,async()=>{this._debug("#_acquireLock","lock acquired for storage key",this.storageKey);try{this.lockAcquired=!0;const x=m();for(this.pendingInLock.push((async()=>{try{await x}catch{}})()),await x;this.pendingInLock.length;){const S=[...this.pendingInLock];await Promise.all(S),this.pendingInLock.splice(0,S.length)}return await x}finally{this._debug("#_acquireLock","lock released for storage key",this.storageKey),this.lockAcquired=!1}})}finally{this._debug("#_acquireLock","end")}}async _useSession(a){this._debug("#_useSession","begin");try{const m=await this.__loadSession();return await a(m)}finally{this._debug("#_useSession","end")}}async __loadSession(){this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",new Error().stack);try{let a=null;const m=await vh(this.storage,this.storageKey);if(this._debug("#getSession()","session from storage",m),m!==null&&(this._isValidSession(m)?a=m:(this._debug("#getSession()","session from storage is not valid"),await this._removeSession())),!a)return{data:{session:null},error:null};const x=a.expires_at?a.expires_at*1e3-Date.now()<ow:!1;if(this._debug("#__loadSession()",`session has${x?"":" not"} expired`,"expires_at",a.expires_at),!x){if(this.userStorage){const O=await vh(this.userStorage,this.storageKey+"-user");O!=null&&O.user?a.user=O.user:a.user=lw()}if(this.storage.isServer&&a.user){let O=this.suppressGetSessionWarning;a=new Proxy(a,{get:(Z,Q,me)=>(!O&&Q==="user"&&(console.warn("Using the user object as returned from supabase.auth.getSession() or from some supabase.auth.onAuthStateChange() events could be insecure! This value comes directly from the storage medium (usually cookies on the server) and may not be authentic. Use supabase.auth.getUser() instead which authenticates the data by contacting the Supabase Auth server."),O=!0,this.suppressGetSessionWarning=!0),Reflect.get(Z,Q,me))})}return{data:{session:a},error:null}}const{session:S,error:P}=await this._callRefreshToken(a.refresh_token);return P?{data:{session:null},error:P}:{data:{session:S},error:null}}finally{this._debug("#__loadSession()","end")}}async getUser(a){return a?await this._getUser(a):(await this.initializePromise,await this._acquireLock(-1,async()=>await this._getUser()))}async _getUser(a){try{return a?await Sn(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:a,xform:ru}):await this._useSession(async m=>{var x,S,P;const{data:O,error:s}=m;if(s)throw s;return!(!((x=O.session)===null||x===void 0)&&x.access_token)&&!this.hasCustomAuthorizationHeader?{data:{user:null},error:new Qc}:await Sn(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:(P=(S=O.session)===null||S===void 0?void 0:S.access_token)!==null&&P!==void 0?P:void 0,xform:ru})})}catch(m){if(hn(m))return sF(m)&&(await this._removeSession(),await Jc(this.storage,`${this.storageKey}-code-verifier`)),{data:{user:null},error:m};throw m}}async updateUser(a,m={}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._updateUser(a,m))}async _updateUser(a,m={}){try{return await this._useSession(async x=>{const{data:S,error:P}=x;if(P)throw P;if(!S.session)throw new Qc;const O=S.session;let s=null,Z=null;this.flowType==="pkce"&&a.email!=null&&([s,Z]=await Af(this.storage,this.storageKey));const{data:Q,error:me}=await Sn(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:m==null?void 0:m.emailRedirectTo,body:Object.assign(Object.assign({},a),{code_challenge:s,code_challenge_method:Z}),jwt:O.access_token,xform:ru});if(me)throw me;return O.user=Q.user,await this._saveSession(O),await this._notifyAllSubscribers("USER_UPDATED",O),{data:{user:O.user},error:null}})}catch(x){if(hn(x))return{data:{user:null},error:x};throw x}}async setSession(a){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._setSession(a))}async _setSession(a){try{if(!a.access_token||!a.refresh_token)throw new Qc;const m=Date.now()/1e3;let x=m,S=!0,P=null;const{payload:O}=aw(a.access_token);if(O.exp&&(x=O.exp,S=x<=m),S){const{session:s,error:Z}=await this._callRefreshToken(a.refresh_token);if(Z)return{data:{user:null,session:null},error:Z};if(!s)return{data:{user:null,session:null},error:null};P=s}else{const{data:s,error:Z}=await this._getUser(a.access_token);if(Z)throw Z;P={access_token:a.access_token,refresh_token:a.refresh_token,user:s.user,token_type:"bearer",expires_in:x-m,expires_at:x},await this._saveSession(P),await this._notifyAllSubscribers("SIGNED_IN",P)}return{data:{user:P.user,session:P},error:null}}catch(m){if(hn(m))return{data:{session:null,user:null},error:m};throw m}}async refreshSession(a){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._refreshSession(a))}async _refreshSession(a){try{return await this._useSession(async m=>{var x;if(!a){const{data:O,error:s}=m;if(s)throw s;a=(x=O.session)!==null&&x!==void 0?x:void 0}if(!(a!=null&&a.refresh_token))throw new Qc;const{session:S,error:P}=await this._callRefreshToken(a.refresh_token);return P?{data:{user:null,session:null},error:P}:S?{data:{user:S.user,session:S},error:null}:{data:{user:null,session:null},error:null}})}catch(m){if(hn(m))return{data:{user:null,session:null},error:m};throw m}}async _getSessionFromURL(a,m){try{if(!ka())throw new E0("No browser detected.");if(a.error||a.error_description||a.error_code)throw new E0(a.error_description||"Error in URL with unspecified error_description",{error:a.error||"unspecified_error",code:a.error_code||"unspecified_code"});switch(m){case"implicit":if(this.flowType==="pkce")throw new EA("Not a valid PKCE flow url.");break;case"pkce":if(this.flowType==="implicit")throw new E0("Not a valid implicit grant flow url.");break;default:}if(m==="pkce"){if(this._debug("#_initialize()","begin","is PKCE flow",!0),!a.code)throw new EA("No code detected.");const{data:xe,error:Pe}=await this._exchangeCodeForSession(a.code);if(Pe)throw Pe;const Ze=new URL(window.location.href);return Ze.searchParams.delete("code"),window.history.replaceState(window.history.state,"",Ze.toString()),{data:{session:xe.session,redirectType:null},error:null}}const{provider_token:x,provider_refresh_token:S,access_token:P,refresh_token:O,expires_in:s,expires_at:Z,token_type:Q}=a;if(!P||!s||!O||!Q)throw new E0("No session defined in URL");const me=Math.round(Date.now()/1e3),Ee=parseInt(s);let De=me+Ee;Z&&(De=parseInt(Z));const Xe=De-me;Xe*1e3<=Rf&&console.warn(`@supabase/gotrue-js: Session as retrieved from URL expires in ${Xe}s, should have been closer to ${Ee}s`);const mt=De-Ee;me-mt>=120?console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued over 120s ago, URL could be stale",mt,De,me):me-mt<0&&console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued in the future? Check the device clock for skew",mt,De,me);const{data:We,error:ct}=await this._getUser(P);if(ct)throw ct;const Me={provider_token:x,provider_refresh_token:S,access_token:P,expires_in:Ee,expires_at:De,refresh_token:O,token_type:Q,user:We.user};return window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),{data:{session:Me,redirectType:a.type},error:null}}catch(x){if(hn(x))return{data:{session:null,redirectType:null},error:x};throw x}}_isImplicitGrantCallback(a){return!!(a.access_token||a.error_description)}async _isPKCECallback(a){const m=await vh(this.storage,`${this.storageKey}-code-verifier`);return!!(a.code&&m)}async signOut(a={scope:"global"}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._signOut(a))}async _signOut({scope:a}={scope:"global"}){return await this._useSession(async m=>{var x;const{data:S,error:P}=m;if(P)return{error:P};const O=(x=S.session)===null||x===void 0?void 0:x.access_token;if(O){const{error:s}=await this.admin.signOut(O,a);if(s&&!(oF(s)&&(s.status===404||s.status===401||s.status===403)))return{error:s}}return a!=="others"&&(await this._removeSession(),await Jc(this.storage,`${this.storageKey}-code-verifier`)),{error:null}})}onAuthStateChange(a){const m=_F(),x={id:m,callback:a,unsubscribe:()=>{this._debug("#unsubscribe()","state change callback with id removed",m),this.stateChangeEmitters.delete(m)}};return this._debug("#onAuthStateChange()","registered callback with id",m),this.stateChangeEmitters.set(m,x),(async()=>(await this.initializePromise,await this._acquireLock(-1,async()=>{this._emitInitialSession(m)})))(),{data:{subscription:x}}}async _emitInitialSession(a){return await this._useSession(async m=>{var x,S;try{const{data:{session:P},error:O}=m;if(O)throw O;await((x=this.stateChangeEmitters.get(a))===null||x===void 0?void 0:x.callback("INITIAL_SESSION",P)),this._debug("INITIAL_SESSION","callback id",a,"session",P)}catch(P){await((S=this.stateChangeEmitters.get(a))===null||S===void 0?void 0:S.callback("INITIAL_SESSION",null)),this._debug("INITIAL_SESSION","callback id",a,"error",P),console.error(P)}})}async resetPasswordForEmail(a,m={}){let x=null,S=null;this.flowType==="pkce"&&([x,S]=await Af(this.storage,this.storageKey,!0));try{return await Sn(this.fetch,"POST",`${this.url}/recover`,{body:{email:a,code_challenge:x,code_challenge_method:S,gotrue_meta_security:{captcha_token:m.captchaToken}},headers:this.headers,redirectTo:m.redirectTo})}catch(P){if(hn(P))return{data:null,error:P};throw P}}async getUserIdentities(){var a;try{const{data:m,error:x}=await this.getUser();if(x)throw x;return{data:{identities:(a=m.user.identities)!==null&&a!==void 0?a:[]},error:null}}catch(m){if(hn(m))return{data:null,error:m};throw m}}async linkIdentity(a){var m;try{const{data:x,error:S}=await this._useSession(async P=>{var O,s,Z,Q,me;const{data:Ee,error:De}=P;if(De)throw De;const Xe=await this._getUrlForProvider(`${this.url}/user/identities/authorize`,a.provider,{redirectTo:(O=a.options)===null||O===void 0?void 0:O.redirectTo,scopes:(s=a.options)===null||s===void 0?void 0:s.scopes,queryParams:(Z=a.options)===null||Z===void 0?void 0:Z.queryParams,skipBrowserRedirect:!0});return await Sn(this.fetch,"GET",Xe,{headers:this.headers,jwt:(me=(Q=Ee.session)===null||Q===void 0?void 0:Q.access_token)!==null&&me!==void 0?me:void 0})});if(S)throw S;return ka()&&!(!((m=a.options)===null||m===void 0)&&m.skipBrowserRedirect)&&window.location.assign(x==null?void 0:x.url),{data:{provider:a.provider,url:x==null?void 0:x.url},error:null}}catch(x){if(hn(x))return{data:{provider:a.provider,url:null},error:x};throw x}}async unlinkIdentity(a){try{return await this._useSession(async m=>{var x,S;const{data:P,error:O}=m;if(O)throw O;return await Sn(this.fetch,"DELETE",`${this.url}/user/identities/${a.identity_id}`,{headers:this.headers,jwt:(S=(x=P.session)===null||x===void 0?void 0:x.access_token)!==null&&S!==void 0?S:void 0})})}catch(m){if(hn(m))return{data:null,error:m};throw m}}async _refreshAccessToken(a){const m=`#_refreshAccessToken(${a.substring(0,5)}...)`;this._debug(m,"begin");try{const x=Date.now();return await xF(async S=>(S>0&&await vF(200*Math.pow(2,S-1)),this._debug(m,"refreshing attempt",S),await Sn(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:a},headers:this.headers,xform:ic})),(S,P)=>{const O=200*Math.pow(2,S);return P&&sw(P)&&Date.now()+O-x<Rf})}catch(x){if(this._debug(m,"error",x),hn(x))return{data:{session:null,user:null},error:x};throw x}finally{this._debug(m,"end")}}_isValidSession(a){return typeof a=="object"&&a!==null&&"access_token"in a&&"refresh_token"in a&&"expires_at"in a}async _handleProviderSignIn(a,m){const x=await this._getUrlForProvider(`${this.url}/authorize`,a,{redirectTo:m.redirectTo,scopes:m.scopes,queryParams:m.queryParams});return this._debug("#_handleProviderSignIn()","provider",a,"options",m,"url",x),ka()&&!m.skipBrowserRedirect&&window.location.assign(x),{data:{provider:a,url:x},error:null}}async _recoverAndRefresh(){var a,m;const x="#_recoverAndRefresh()";this._debug(x,"begin");try{const S=await vh(this.storage,this.storageKey);if(S&&this.userStorage){let O=await vh(this.userStorage,this.storageKey+"-user");!this.storage.isServer&&Object.is(this.storage,this.userStorage)&&!O&&(O={user:S.user},await kf(this.userStorage,this.storageKey+"-user",O)),S.user=(a=O==null?void 0:O.user)!==null&&a!==void 0?a:lw()}else if(S&&!S.user&&!S.user){const O=await vh(this.storage,this.storageKey+"-user");O&&(O!=null&&O.user)?(S.user=O.user,await Jc(this.storage,this.storageKey+"-user"),await kf(this.storage,this.storageKey,S)):S.user=lw()}if(this._debug(x,"session from storage",S),!this._isValidSession(S)){this._debug(x,"session is not valid"),S!==null&&await this._removeSession();return}const P=((m=S.expires_at)!==null&&m!==void 0?m:1/0)*1e3-Date.now()<ow;if(this._debug(x,`session has${P?"":" not"} expired with margin of ${ow}s`),P){if(this.autoRefreshToken&&S.refresh_token){const{error:O}=await this._callRefreshToken(S.refresh_token);O&&(console.error(O),sw(O)||(this._debug(x,"refresh failed with a non-retryable error, removing the session",O),await this._removeSession()))}}else if(S.user&&S.user.__isUserNotAvailableProxy===!0)try{const{data:O,error:s}=await this._getUser(S.access_token);!s&&(O!=null&&O.user)?(S.user=O.user,await this._saveSession(S),await this._notifyAllSubscribers("SIGNED_IN",S)):this._debug(x,"could not get user data, skipping SIGNED_IN notification")}catch(O){console.error("Error getting user data:",O),this._debug(x,"error getting user data, skipping SIGNED_IN notification",O)}else await this._notifyAllSubscribers("SIGNED_IN",S)}catch(S){this._debug(x,"error",S),console.error(S);return}finally{this._debug(x,"end")}}async _callRefreshToken(a){var m,x;if(!a)throw new Qc;if(this.refreshingDeferred)return this.refreshingDeferred.promise;const S=`#_callRefreshToken(${a.substring(0,5)}...)`;this._debug(S,"begin");try{this.refreshingDeferred=new Mv;const{data:P,error:O}=await this._refreshAccessToken(a);if(O)throw O;if(!P.session)throw new Qc;await this._saveSession(P.session),await this._notifyAllSubscribers("TOKEN_REFRESHED",P.session);const s={session:P.session,error:null};return this.refreshingDeferred.resolve(s),s}catch(P){if(this._debug(S,"error",P),hn(P)){const O={session:null,error:P};return sw(P)||await this._removeSession(),(m=this.refreshingDeferred)===null||m===void 0||m.resolve(O),O}throw(x=this.refreshingDeferred)===null||x===void 0||x.reject(P),P}finally{this.refreshingDeferred=null,this._debug(S,"end")}}async _notifyAllSubscribers(a,m,x=!0){const S=`#_notifyAllSubscribers(${a})`;this._debug(S,"begin",m,`broadcast = ${x}`);try{this.broadcastChannel&&x&&this.broadcastChannel.postMessage({event:a,session:m});const P=[],O=Array.from(this.stateChangeEmitters.values()).map(async s=>{try{await s.callback(a,m)}catch(Z){P.push(Z)}});if(await Promise.all(O),P.length>0){for(let s=0;s<P.length;s+=1)console.error(P[s]);throw P[0]}}finally{this._debug(S,"end")}}async _saveSession(a){this._debug("#_saveSession()",a),this.suppressGetSessionWarning=!0;const m=Object.assign({},a),x=m.user&&m.user.__isUserNotAvailableProxy===!0;if(this.userStorage){!x&&m.user&&await kf(this.userStorage,this.storageKey+"-user",{user:m.user});const S=Object.assign({},m);delete S.user;const P=MA(S);await kf(this.storage,this.storageKey,P)}else{const S=MA(m);await kf(this.storage,this.storageKey,S)}}async _removeSession(){this._debug("#_removeSession()"),await Jc(this.storage,this.storageKey),await Jc(this.storage,this.storageKey+"-code-verifier"),await Jc(this.storage,this.storageKey+"-user"),this.userStorage&&await Jc(this.userStorage,this.storageKey+"-user"),await this._notifyAllSubscribers("SIGNED_OUT",null)}_removeVisibilityChangedCallback(){this._debug("#_removeVisibilityChangedCallback()");const a=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{a&&ka()&&(window!=null&&window.removeEventListener)&&window.removeEventListener("visibilitychange",a)}catch(m){console.error("removing visibilitychange callback failed",m)}}async _startAutoRefresh(){await this._stopAutoRefresh(),this._debug("#_startAutoRefresh()");const a=setInterval(()=>this._autoRefreshTokenTick(),Rf);this.autoRefreshTicker=a,a&&typeof a=="object"&&typeof a.unref=="function"?a.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(a),setTimeout(async()=>{await this.initializePromise,await this._autoRefreshTokenTick()},0)}async _stopAutoRefresh(){this._debug("#_stopAutoRefresh()");const a=this.autoRefreshTicker;this.autoRefreshTicker=null,a&&clearInterval(a)}async startAutoRefresh(){this._removeVisibilityChangedCallback(),await this._startAutoRefresh()}async stopAutoRefresh(){this._removeVisibilityChangedCallback(),await this._stopAutoRefresh()}async _autoRefreshTokenTick(){this._debug("#_autoRefreshTokenTick()","begin");try{await this._acquireLock(0,async()=>{try{const a=Date.now();try{return await this._useSession(async m=>{const{data:{session:x}}=m;if(!x||!x.refresh_token||!x.expires_at){this._debug("#_autoRefreshTokenTick()","no session");return}const S=Math.floor((x.expires_at*1e3-a)/Rf);this._debug("#_autoRefreshTokenTick()",`access token expires in ${S} ticks, a tick lasts ${Rf}ms, refresh threshold is ${cb} ticks`),S<=cb&&await this._callRefreshToken(x.refresh_token)})}catch(m){console.error("Auto refresh tick failed with error. This is likely a transient error.",m)}}finally{this._debug("#_autoRefreshTokenTick()","end")}})}catch(a){if(a.isAcquireTimeout||a instanceof gM)this._debug("auto refresh token tick lock not available");else throw a}}async _handleVisibilityChange(){if(this._debug("#_handleVisibilityChange()"),!ka()||!(window!=null&&window.addEventListener))return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=async()=>await this._onVisibilityChanged(!1),window==null||window.addEventListener("visibilitychange",this.visibilityChangedCallback),await this._onVisibilityChanged(!0)}catch(a){console.error("_handleVisibilityChange",a)}}async _onVisibilityChanged(a){const m=`#_onVisibilityChanged(${a})`;this._debug(m,"visibilityState",document.visibilityState),document.visibilityState==="visible"?(this.autoRefreshToken&&this._startAutoRefresh(),a||(await this.initializePromise,await this._acquireLock(-1,async()=>{if(document.visibilityState!=="visible"){this._debug(m,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting");return}await this._recoverAndRefresh()}))):document.visibilityState==="hidden"&&this.autoRefreshToken&&this._stopAutoRefresh()}async _getUrlForProvider(a,m,x){const S=[`provider=${encodeURIComponent(m)}`];if(x!=null&&x.redirectTo&&S.push(`redirect_to=${encodeURIComponent(x.redirectTo)}`),x!=null&&x.scopes&&S.push(`scopes=${encodeURIComponent(x.scopes)}`),this.flowType==="pkce"){const[P,O]=await Af(this.storage,this.storageKey),s=new URLSearchParams({code_challenge:`${encodeURIComponent(P)}`,code_challenge_method:`${encodeURIComponent(O)}`});S.push(s.toString())}if(x!=null&&x.queryParams){const P=new URLSearchParams(x.queryParams);S.push(P.toString())}return x!=null&&x.skipBrowserRedirect&&S.push(`skip_http_redirect=${x.skipBrowserRedirect}`),`${a}?${S.join("&")}`}async _unenroll(a){try{return await this._useSession(async m=>{var x;const{data:S,error:P}=m;return P?{data:null,error:P}:await Sn(this.fetch,"DELETE",`${this.url}/factors/${a.factorId}`,{headers:this.headers,jwt:(x=S==null?void 0:S.session)===null||x===void 0?void 0:x.access_token})})}catch(m){if(hn(m))return{data:null,error:m};throw m}}async _enroll(a){try{return await this._useSession(async m=>{var x,S;const{data:P,error:O}=m;if(O)return{data:null,error:O};const s=Object.assign({friendly_name:a.friendlyName,factor_type:a.factorType},a.factorType==="phone"?{phone:a.phone}:{issuer:a.issuer}),{data:Z,error:Q}=await Sn(this.fetch,"POST",`${this.url}/factors`,{body:s,headers:this.headers,jwt:(x=P==null?void 0:P.session)===null||x===void 0?void 0:x.access_token});return Q?{data:null,error:Q}:(a.factorType==="totp"&&(!((S=Z==null?void 0:Z.totp)===null||S===void 0)&&S.qr_code)&&(Z.totp.qr_code=`data:image/svg+xml;utf-8,${Z.totp.qr_code}`),{data:Z,error:null})})}catch(m){if(hn(m))return{data:null,error:m};throw m}}async _verify(a){return this._acquireLock(-1,async()=>{try{return await this._useSession(async m=>{var x;const{data:S,error:P}=m;if(P)return{data:null,error:P};const{data:O,error:s}=await Sn(this.fetch,"POST",`${this.url}/factors/${a.factorId}/verify`,{body:{code:a.code,challenge_id:a.challengeId},headers:this.headers,jwt:(x=S==null?void 0:S.session)===null||x===void 0?void 0:x.access_token});return s?{data:null,error:s}:(await this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+O.expires_in},O)),await this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",O),{data:O,error:s})})}catch(m){if(hn(m))return{data:null,error:m};throw m}})}async _challenge(a){return this._acquireLock(-1,async()=>{try{return await this._useSession(async m=>{var x;const{data:S,error:P}=m;return P?{data:null,error:P}:await Sn(this.fetch,"POST",`${this.url}/factors/${a.factorId}/challenge`,{body:{channel:a.channel},headers:this.headers,jwt:(x=S==null?void 0:S.session)===null||x===void 0?void 0:x.access_token})})}catch(m){if(hn(m))return{data:null,error:m};throw m}})}async _challengeAndVerify(a){const{data:m,error:x}=await this._challenge({factorId:a.factorId});return x?{data:null,error:x}:await this._verify({factorId:a.factorId,challengeId:m.id,code:a.code})}async _listFactors(){const{data:{user:a},error:m}=await this.getUser();if(m)return{data:null,error:m};const x=(a==null?void 0:a.factors)||[],S=x.filter(O=>O.factor_type==="totp"&&O.status==="verified"),P=x.filter(O=>O.factor_type==="phone"&&O.status==="verified");return{data:{all:x,totp:S,phone:P},error:null}}async _getAuthenticatorAssuranceLevel(){return this._acquireLock(-1,async()=>await this._useSession(async a=>{var m,x;const{data:{session:S},error:P}=a;if(P)return{data:null,error:P};if(!S)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const{payload:O}=aw(S.access_token);let s=null;O.aal&&(s=O.aal);let Z=s;((x=(m=S.user.factors)===null||m===void 0?void 0:m.filter(Ee=>Ee.status==="verified"))!==null&&x!==void 0?x:[]).length>0&&(Z="aal2");const me=O.amr||[];return{data:{currentLevel:s,nextLevel:Z,currentAuthenticationMethods:me},error:null}}))}async fetchJwk(a,m={keys:[]}){let x=m.keys.find(s=>s.kid===a);if(x)return x;const S=Date.now();if(x=this.jwks.keys.find(s=>s.kid===a),x&&this.jwks_cached_at+nF>S)return x;const{data:P,error:O}=await Sn(this.fetch,"GET",`${this.url}/.well-known/jwks.json`,{headers:this.headers});if(O)throw O;return!P.keys||P.keys.length===0||(this.jwks=P,this.jwks_cached_at=S,x=P.keys.find(s=>s.kid===a),!x)?null:x}async getClaims(a,m={}){try{let x=a;if(!x){const{data:Xe,error:mt}=await this.getSession();if(mt||!Xe.session)return{data:null,error:mt};x=Xe.session.access_token}const{header:S,payload:P,signature:O,raw:{header:s,payload:Z}}=aw(x);m!=null&&m.allowExpired||AF(P.exp);const Q=!S.alg||S.alg.startsWith("HS")||!S.kid||!("crypto"in globalThis&&"subtle"in globalThis.crypto)?null:await this.fetchJwk(S.kid,m!=null&&m.keys?{keys:m.keys}:m==null?void 0:m.jwks);if(!Q){const{error:Xe}=await this.getUser(x);if(Xe)throw Xe;return{data:{claims:P,header:S,signature:O},error:null}}const me=CF(S.alg),Ee=await crypto.subtle.importKey("jwk",Q,me,!0,["verify"]);if(!await crypto.subtle.verify(me,Ee,O,fF(`${s}.${Z}`)))throw new db("Invalid JWT signature");return{data:{claims:P,header:S,signature:O},error:null}}catch(x){if(hn(x))return{data:null,error:x};throw x}}}J_.nextInstanceID=0;const GF=J_;class HF extends GF{constructor(a){super(a)}}var qF=function(c,a,m,x){function S(P){return P instanceof m?P:new m(function(O){O(P)})}return new(m||(m=Promise))(function(P,O){function s(me){try{Q(x.next(me))}catch(Ee){O(Ee)}}function Z(me){try{Q(x.throw(me))}catch(Ee){O(Ee)}}function Q(me){me.done?P(me.value):S(me.value).then(s,Z)}Q((x=x.apply(c,a||[])).next())})};class WF{constructor(a,m,x){var S,P,O;this.supabaseUrl=a,this.supabaseKey=m;const s=J3(a);if(!m)throw new Error("supabaseKey is required.");this.realtimeUrl=new URL("realtime/v1",s),this.realtimeUrl.protocol=this.realtimeUrl.protocol.replace("http","ws"),this.authUrl=new URL("auth/v1",s),this.storageUrl=new URL("storage/v1",s),this.functionsUrl=new URL("functions/v1",s);const Z=`sb-${s.hostname.split(".")[0]}-auth-token`,Q={db:V3,realtime:G3,auth:Object.assign(Object.assign({},$3),{storageKey:Z}),global:U3},me=Y3(x??{},Q);this.storageKey=(S=me.auth.storageKey)!==null&&S!==void 0?S:"",this.headers=(P=me.global.headers)!==null&&P!==void 0?P:{},me.accessToken?(this.accessToken=me.accessToken,this.auth=new Proxy({},{get:(Ee,De)=>{throw new Error(`@supabase/supabase-js: Supabase Client is configured with the accessToken option, accessing supabase.auth.${String(De)} is not possible`)}})):this.auth=this._initSupabaseAuthClient((O=me.auth)!==null&&O!==void 0?O:{},this.headers,me.global.fetch),this.fetch=Z3(m,this._getAccessToken.bind(this),me.global.fetch),this.realtime=this._initRealtimeClient(Object.assign({headers:this.headers,accessToken:this._getAccessToken.bind(this)},me.realtime)),this.rest=new l3(new URL("rest/v1",s).href,{headers:this.headers,schema:me.db.schema,fetch:this.fetch}),this.storage=new B3(this.storageUrl.href,this.headers,this.fetch,x==null?void 0:x.storage),me.accessToken||this._listenForAuthEvents()}get functions(){return new jO(this.functionsUrl.href,{headers:this.headers,customFetch:this.fetch})}from(a){return this.rest.from(a)}schema(a){return this.rest.schema(a)}rpc(a,m={},x={}){return this.rest.rpc(a,m,x)}channel(a,m={config:{}}){return this.realtime.channel(a,m)}getChannels(){return this.realtime.getChannels()}removeChannel(a){return this.realtime.removeChannel(a)}removeAllChannels(){return this.realtime.removeAllChannels()}_getAccessToken(){var a,m;return qF(this,void 0,void 0,function*(){if(this.accessToken)return yield this.accessToken();const{data:x}=yield this.auth.getSession();return(m=(a=x.session)===null||a===void 0?void 0:a.access_token)!==null&&m!==void 0?m:this.supabaseKey})}_initSupabaseAuthClient({autoRefreshToken:a,persistSession:m,detectSessionInUrl:x,storage:S,userStorage:P,storageKey:O,flowType:s,lock:Z,debug:Q},me,Ee){const De={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new HF({url:this.authUrl.href,headers:Object.assign(Object.assign({},De),me),storageKey:O,autoRefreshToken:a,persistSession:m,detectSessionInUrl:x,storage:S,userStorage:P,flowType:s,lock:Z,debug:Q,fetch:Ee,hasCustomAuthorizationHeader:Object.keys(this.headers).some(Xe=>Xe.toLowerCase()==="authorization")})}_initRealtimeClient(a){return new E3(this.realtimeUrl.href,Object.assign(Object.assign({},a),{params:Object.assign({apikey:this.supabaseKey},a==null?void 0:a.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange((m,x)=>{this._handleTokenChanged(m,"CLIENT",x==null?void 0:x.access_token)})}_handleTokenChanged(a,m,x){(a==="TOKEN_REFRESHED"||a==="SIGNED_IN")&&this.changedAccessToken!==x?this.changedAccessToken=x:a==="SIGNED_OUT"&&(this.realtime.setAuth(),m=="STORAGE"&&this.auth.signOut(),this.changedAccessToken=void 0)}}const ZF=(c,a,m)=>new WF(c,a,m);function XF(){if(typeof window<"u"||typeof process>"u")return!1;const c=process.version;if(c==null)return!1;const a=c.match(/^v(\d+)\./);return a?parseInt(a[1],10)<=18:!1}XF()&&console.warn("  Node.js 18 and below are deprecated and will no longer be supported in future versions of @supabase/supabase-js. Please upgrade to Node.js 20 or later. For more information, visit: https://github.com/orgs/supabase/discussions/37217");const KF="https://xrtkpctoufpmfreyjdfl.supabase.co",YF="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhydGtwY3RvdWZwbWZyZXlqZGZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0MTE3MTgsImV4cCI6MjA4Mjk4NzcxOH0.RIj-X5VRUdLF3CowKjJ5xyAs2DuRvnkbLbzMMN8LNWw",dr=ZF(KF,YF),yM=vi.createContext(void 0);function JF({children:c}){const[a,m]=vi.useState(null),[x,S]=vi.useState(null),[P,O]=vi.useState(null),[s,Z]=vi.useState(!0);vi.useEffect(()=>{dr.auth.getSession().then(({data:{session:ct}})=>{O(ct),m((ct==null?void 0:ct.user)??null),ct!=null&&ct.user?Q(ct.user.id):Z(!1)});const{data:{subscription:We}}=dr.auth.onAuthStateChange((ct,Me)=>{O(Me),m((Me==null?void 0:Me.user)??null),Me!=null&&Me.user?Q(Me.user.id):(S(null),Z(!1))});return()=>We.unsubscribe()},[]);const Q=async We=>{try{const{data:ct,error:Me}=await dr.from("profiles").select("*").eq("id",We).maybeSingle();if(Me)throw Me;S(ct)}catch(ct){console.error("Error loading profile:",ct)}finally{Z(!1)}},mt={user:a,profile:x,session:P,loading:s,signUp:async(We,ct,Me)=>{try{const{data:xe,error:Pe}=await dr.auth.signUp({email:We,password:ct});if(Pe)return{error:Pe};if(!xe.user)return{error:new Error("User creation failed")};const{error:Ze}=await dr.from("profiles").insert({id:xe.user.id,username:Me,display_name:Me});return Ze?{error:Ze}:{error:null}}catch(xe){return{error:xe}}},signIn:async(We,ct)=>{const{error:Me}=await dr.auth.signInWithPassword({email:We,password:ct});return{error:Me}},signOut:async()=>{await dr.auth.signOut()},updateProfile:async We=>{if(!a)return;const{error:ct}=await dr.from("profiles").update({...We,updated_at:new Date().toISOString()}).eq("id",a.id);if(ct)throw ct;await Q(a.id)}};return Ce.jsx(yM.Provider,{value:mt,children:c})}function up(){const c=vi.useContext(yM);if(c===void 0)throw new Error("useAuth must be used within an AuthProvider");return c}/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */var QF={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const eB=c=>c.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase().trim(),ks=(c,a)=>{const m=vi.forwardRef(({color:x="currentColor",size:S=24,strokeWidth:P=2,absoluteStrokeWidth:O,className:s="",children:Z,...Q},me)=>vi.createElement("svg",{ref:me,...QF,width:S,height:S,stroke:x,strokeWidth:O?Number(P)*24/Number(S):P,className:["lucide",`lucide-${eB(c)}`,s].join(" "),...Q},[...a.map(([Ee,De])=>vi.createElement(Ee,De)),...Array.isArray(Z)?Z:[Z]]));return m.displayName=`${c}`,m};/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const tB=ks("Camera",[["path",{d:"M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z",key:"1tc9qg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vM=ks("Heart",[["path",{d:"M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z",key:"c3ymky"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const iB=ks("LogIn",[["path",{d:"M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4",key:"u53s6r"}],["polyline",{points:"10 17 15 12 10 7",key:"1ail0h"}],["line",{x1:"15",x2:"3",y1:"12",y2:"12",key:"v6grx8"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const nB=ks("LogOut",[["path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4",key:"1uf3rs"}],["polyline",{points:"16 17 21 12 16 7",key:"1gabdz"}],["line",{x1:"21",x2:"9",y1:"12",y2:"12",key:"1uyos4"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const dT=ks("MapPin",[["path",{d:"M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z",key:"2oe9fu"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const DA=ks("Map",[["polygon",{points:"3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21",key:"ok2ie8"}],["line",{x1:"9",x2:"9",y1:"3",y2:"18",key:"w34qz5"}],["line",{x1:"15",x2:"15",y1:"6",y2:"21",key:"volv9a"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xM=ks("Plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const rB=ks("Star",[["polygon",{points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2",key:"8f66p6"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const oB=ks("Trash2",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const sB=ks("UserPlus",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const aB=ks("User",[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const lB=ks("Users",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["path",{d:"M16 3.13a4 4 0 0 1 0 7.75",key:"1da9ce"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Q_=ks("X",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]]);function cB(){const[c,a]=vi.useState(!1),[m,x]=vi.useState(""),[S,P]=vi.useState(""),[O,s]=vi.useState(""),[Z,Q]=vi.useState(""),[me,Ee]=vi.useState(!1),{signIn:De,signUp:Xe}=up(),mt=async We=>{We.preventDefault(),Q(""),Ee(!0);try{if(c){if(!O.trim()){Q("Username is required");return}const{error:ct}=await Xe(m,S,O);ct&&Q(ct.message)}else{const{error:ct}=await De(m,S);ct&&Q(ct.message)}}catch{Q("An unexpected error occurred")}finally{Ee(!1)}};return Ce.jsx("div",{className:"min-h-screen bg-gradient-to-br from-emerald-50 to-blue-50 flex items-center justify-center p-4",children:Ce.jsxs("div",{className:"bg-white rounded-2xl shadow-xl p-8 w-full max-w-md",children:[Ce.jsxs("div",{className:"text-center mb-8",children:[Ce.jsx("div",{className:"text-6xl mb-4",children:""}),Ce.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"SniffLocal"}),Ce.jsx("p",{className:"text-gray-600",children:"Discover dog-friendly places near you"})]}),Ce.jsxs("form",{onSubmit:mt,className:"space-y-4",children:[c&&Ce.jsxs("div",{children:[Ce.jsx("label",{htmlFor:"username",className:"block text-sm font-medium text-gray-700 mb-1",children:"Username"}),Ce.jsx("input",{id:"username",type:"text",value:O,onChange:We=>s(We.target.value),required:!0,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent",placeholder:"Choose a username"})]}),Ce.jsxs("div",{children:[Ce.jsx("label",{htmlFor:"email",className:"block text-sm font-medium text-gray-700 mb-1",children:"Email"}),Ce.jsx("input",{id:"email",type:"email",value:m,onChange:We=>x(We.target.value),required:!0,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent",placeholder:"you@example.com"})]}),Ce.jsxs("div",{children:[Ce.jsx("label",{htmlFor:"password",className:"block text-sm font-medium text-gray-700 mb-1",children:"Password"}),Ce.jsx("input",{id:"password",type:"password",value:S,onChange:We=>P(We.target.value),required:!0,minLength:6,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent",placeholder:""})]}),Z&&Ce.jsx("div",{className:"bg-red-50 text-red-700 px-4 py-3 rounded-lg text-sm",children:Z}),Ce.jsx("button",{type:"submit",disabled:me,className:"w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed",children:me?"Loading...":c?Ce.jsxs(Ce.Fragment,{children:[Ce.jsx(sB,{size:20}),"Sign Up"]}):Ce.jsxs(Ce.Fragment,{children:[Ce.jsx(iB,{size:20}),"Sign In"]})})]}),Ce.jsx("div",{className:"mt-6 text-center",children:Ce.jsx("button",{onClick:()=>{a(!c),Q("")},className:"text-emerald-600 hover:text-emerald-700 text-sm font-medium",children:c?"Already have an account? Sign in":"Don't have an account? Sign up"})})]})})}var wM={exports:{}};(function(c,a){(function(m,x){c.exports=x()})(Cs,function(){var m,x,S;function P(s,Z){if(!m)m=Z;else if(!x)x=Z;else{var Q="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+m+")(sharedChunk); ("+x+")(sharedChunk); self.onerror = null;",me={};m(me),S=Z(me),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(S.workerUrl=window.URL.createObjectURL(new Blob([Q],{type:"text/javascript"})))}}P(["exports"],function(s){var Z=1e-6,Q=typeof Float32Array<"u"?Float32Array:Array;function me(n,e){var i=e[0],o=e[1],l=e[2],d=e[3],f=i*d-l*o;return f?(n[0]=d*(f=1/f),n[1]=-o*f,n[2]=-l*f,n[3]=i*f,n):null}function Ee(){var n=new Q(9);return Q!=Float32Array&&(n[1]=0,n[2]=0,n[3]=0,n[5]=0,n[6]=0,n[7]=0),n[0]=1,n[4]=1,n[8]=1,n}function De(n,e){var i=e[0],o=e[1],l=e[2],d=e[3],f=e[4],_=e[5],v=e[6],b=e[7],E=e[8];return n[0]=f*E-_*b,n[1]=l*b-o*E,n[2]=o*_-l*f,n[3]=_*v-d*E,n[4]=i*E-l*v,n[5]=l*d-i*_,n[6]=d*b-f*v,n[7]=o*v-i*b,n[8]=i*f-o*d,n}function Xe(n,e,i){var o=e[0],l=e[1],d=e[2],f=e[3],_=e[4],v=e[5],b=e[6],E=e[7],I=e[8],C=i[0],R=i[1],k=i[2],F=i[3],U=i[4],j=i[5],H=i[6],W=i[7],Y=i[8];return n[0]=C*o+R*f+k*b,n[1]=C*l+R*_+k*E,n[2]=C*d+R*v+k*I,n[3]=F*o+U*f+j*b,n[4]=F*l+U*_+j*E,n[5]=F*d+U*v+j*I,n[6]=H*o+W*f+Y*b,n[7]=H*l+W*_+Y*E,n[8]=H*d+W*v+Y*I,n}function mt(){var n=new Q(16);return Q!=Float32Array&&(n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=0,n[12]=0,n[13]=0,n[14]=0),n[0]=1,n[5]=1,n[10]=1,n[15]=1,n}function We(n){var e=new Q(16);return e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7],e[8]=n[8],e[9]=n[9],e[10]=n[10],e[11]=n[11],e[12]=n[12],e[13]=n[13],e[14]=n[14],e[15]=n[15],e}function ct(n){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function Me(n,e){var i=e[0],o=e[1],l=e[2],d=e[3],f=e[4],_=e[5],v=e[6],b=e[7],E=e[8],I=e[9],C=e[10],R=e[11],k=e[12],F=e[13],U=e[14],j=e[15],H=i*_-o*f,W=i*v-l*f,Y=i*b-d*f,se=o*v-l*_,ie=o*b-d*_,ce=l*b-d*v,fe=E*F-I*k,ge=E*U-C*k,Fe=E*j-R*k,be=I*U-C*F,Ue=I*j-R*F,He=C*j-R*U,qe=H*He-W*Ue+Y*be+se*Fe-ie*ge+ce*fe;return qe?(n[0]=(_*He-v*Ue+b*be)*(qe=1/qe),n[1]=(l*Ue-o*He-d*be)*qe,n[2]=(F*ce-U*ie+j*se)*qe,n[3]=(C*ie-I*ce-R*se)*qe,n[4]=(v*Fe-f*He-b*ge)*qe,n[5]=(i*He-l*Fe+d*ge)*qe,n[6]=(U*Y-k*ce-j*W)*qe,n[7]=(E*ce-C*Y+R*W)*qe,n[8]=(f*Ue-_*Fe+b*fe)*qe,n[9]=(o*Fe-i*Ue-d*fe)*qe,n[10]=(k*ie-F*Y+j*H)*qe,n[11]=(I*Y-E*ie-R*H)*qe,n[12]=(_*ge-f*be-v*fe)*qe,n[13]=(i*be-o*ge+l*fe)*qe,n[14]=(F*W-k*se-U*H)*qe,n[15]=(E*se-I*W+C*H)*qe,n):null}function xe(n,e,i){var o=e[0],l=e[1],d=e[2],f=e[3],_=e[4],v=e[5],b=e[6],E=e[7],I=e[8],C=e[9],R=e[10],k=e[11],F=e[12],U=e[13],j=e[14],H=e[15],W=i[0],Y=i[1],se=i[2],ie=i[3];return n[0]=W*o+Y*_+se*I+ie*F,n[1]=W*l+Y*v+se*C+ie*U,n[2]=W*d+Y*b+se*R+ie*j,n[3]=W*f+Y*E+se*k+ie*H,n[4]=(W=i[4])*o+(Y=i[5])*_+(se=i[6])*I+(ie=i[7])*F,n[5]=W*l+Y*v+se*C+ie*U,n[6]=W*d+Y*b+se*R+ie*j,n[7]=W*f+Y*E+se*k+ie*H,n[8]=(W=i[8])*o+(Y=i[9])*_+(se=i[10])*I+(ie=i[11])*F,n[9]=W*l+Y*v+se*C+ie*U,n[10]=W*d+Y*b+se*R+ie*j,n[11]=W*f+Y*E+se*k+ie*H,n[12]=(W=i[12])*o+(Y=i[13])*_+(se=i[14])*I+(ie=i[15])*F,n[13]=W*l+Y*v+se*C+ie*U,n[14]=W*d+Y*b+se*R+ie*j,n[15]=W*f+Y*E+se*k+ie*H,n}function Pe(n,e,i){var o,l,d,f,_,v,b,E,I,C,R,k,F=i[0],U=i[1],j=i[2];return e===n?(n[12]=e[0]*F+e[4]*U+e[8]*j+e[12],n[13]=e[1]*F+e[5]*U+e[9]*j+e[13],n[14]=e[2]*F+e[6]*U+e[10]*j+e[14],n[15]=e[3]*F+e[7]*U+e[11]*j+e[15]):(l=e[1],d=e[2],f=e[3],_=e[4],v=e[5],b=e[6],E=e[7],I=e[8],C=e[9],R=e[10],k=e[11],n[0]=o=e[0],n[1]=l,n[2]=d,n[3]=f,n[4]=_,n[5]=v,n[6]=b,n[7]=E,n[8]=I,n[9]=C,n[10]=R,n[11]=k,n[12]=o*F+_*U+I*j+e[12],n[13]=l*F+v*U+C*j+e[13],n[14]=d*F+b*U+R*j+e[14],n[15]=f*F+E*U+k*j+e[15]),n}function Ze(n,e,i){var o=i[0],l=i[1],d=i[2];return n[0]=e[0]*o,n[1]=e[1]*o,n[2]=e[2]*o,n[3]=e[3]*o,n[4]=e[4]*l,n[5]=e[5]*l,n[6]=e[6]*l,n[7]=e[7]*l,n[8]=e[8]*d,n[9]=e[9]*d,n[10]=e[10]*d,n[11]=e[11]*d,n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15],n}function Ct(n,e,i){var o=Math.sin(i),l=Math.cos(i),d=e[4],f=e[5],_=e[6],v=e[7],b=e[8],E=e[9],I=e[10],C=e[11];return e!==n&&(n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n[4]=d*l+b*o,n[5]=f*l+E*o,n[6]=_*l+I*o,n[7]=v*l+C*o,n[8]=b*l-d*o,n[9]=E*l-f*o,n[10]=I*l-_*o,n[11]=C*l-v*o,n}function kt(n,e,i){var o=Math.sin(i),l=Math.cos(i),d=e[0],f=e[1],_=e[2],v=e[3],b=e[8],E=e[9],I=e[10],C=e[11];return e!==n&&(n[4]=e[4],n[5]=e[5],n[6]=e[6],n[7]=e[7],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n[0]=d*l-b*o,n[1]=f*l-E*o,n[2]=_*l-I*o,n[3]=v*l-C*o,n[8]=d*o+b*l,n[9]=f*o+E*l,n[10]=_*o+I*l,n[11]=v*o+C*l,n}function zt(n,e,i){var o=Math.sin(i),l=Math.cos(i),d=e[0],f=e[1],_=e[2],v=e[3],b=e[4],E=e[5],I=e[6],C=e[7];return e!==n&&(n[8]=e[8],n[9]=e[9],n[10]=e[10],n[11]=e[11],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n[0]=d*l+b*o,n[1]=f*l+E*o,n[2]=_*l+I*o,n[3]=v*l+C*o,n[4]=b*l-d*o,n[5]=E*l-f*o,n[6]=I*l-_*o,n[7]=C*l-v*o,n}function Zt(n,e){return n[0]=e[0],n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=e[1],n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=e[2],n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function mn(n,e,i){var o,l,d,f=i[0],_=i[1],v=i[2],b=Math.sqrt(f*f+_*_+v*v);return b<Z?null:(f*=b=1/b,_*=b,v*=b,o=Math.sin(e),l=Math.cos(e),n[0]=f*f*(d=1-l)+l,n[1]=_*f*d+v*o,n[2]=v*f*d-_*o,n[3]=0,n[4]=f*_*d-v*o,n[5]=_*_*d+l,n[6]=v*_*d+f*o,n[7]=0,n[8]=f*v*d+_*o,n[9]=_*v*d-f*o,n[10]=v*v*d+l,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n)}function Xt(n,e){var i=e[0],o=e[1],l=e[2],d=e[4],f=e[5],_=e[6],v=e[8],b=e[9],E=e[10];return n[0]=Math.sqrt(i*i+o*o+l*l),n[1]=Math.sqrt(d*d+f*f+_*_),n[2]=Math.sqrt(v*v+b*b+E*E),n}function Mi(n,e){var i=e[0],o=e[1],l=e[2],d=e[3],f=i+i,_=o+o,v=l+l,b=i*f,E=o*f,I=o*_,C=l*f,R=l*_,k=l*v,F=d*f,U=d*_,j=d*v;return n[0]=1-I-k,n[1]=E+j,n[2]=C-U,n[3]=0,n[4]=E-j,n[5]=1-b-k,n[6]=R+F,n[7]=0,n[8]=C+U,n[9]=R-F,n[10]=1-b-I,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}var or=xe;function Ri(){var n=new Q(3);return Q!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n}function wl(n){var e=new Q(3);return e[0]=n[0],e[1]=n[1],e[2]=n[2],e}function pr(n){var e=n[0],i=n[1],o=n[2];return Math.sqrt(e*e+i*i+o*o)}function In(n,e,i){var o=new Q(3);return o[0]=n,o[1]=e,o[2]=i,o}function dn(n,e,i,o){return n[0]=e,n[1]=i,n[2]=o,n}function $t(n,e,i){return n[0]=e[0]+i[0],n[1]=e[1]+i[1],n[2]=e[2]+i[2],n}function ki(n,e,i){return n[0]=e[0]-i[0],n[1]=e[1]-i[1],n[2]=e[2]-i[2],n}function ji(n,e,i){return n[0]=e[0]*i[0],n[1]=e[1]*i[1],n[2]=e[2]*i[2],n}function On(n,e,i){return n[0]=Math.min(e[0],i[0]),n[1]=Math.min(e[1],i[1]),n[2]=Math.min(e[2],i[2]),n}function Un(n,e,i){return n[0]=Math.max(e[0],i[0]),n[1]=Math.max(e[1],i[1]),n[2]=Math.max(e[2],i[2]),n}function gn(n,e,i){return n[0]=e[0]*i,n[1]=e[1]*i,n[2]=e[2]*i,n}function Er(n,e,i,o){return n[0]=e[0]+i[0]*o,n[1]=e[1]+i[1]*o,n[2]=e[2]+i[2]*o,n}function ja(n,e){var i=e[0]-n[0],o=e[1]-n[1],l=e[2]-n[2];return Math.sqrt(i*i+o*o+l*l)}function Lo(n,e){var i=e[0]-n[0],o=e[1]-n[1],l=e[2]-n[2];return i*i+o*o+l*l}function ia(n){var e=n[0],i=n[1],o=n[2];return e*e+i*i+o*o}function Ua(n,e){return n[0]=-e[0],n[1]=-e[1],n[2]=-e[2],n}function yn(n,e){var i=e[0],o=e[1],l=e[2],d=i*i+o*o+l*l;return d>0&&(d=1/Math.sqrt(d)),n[0]=e[0]*d,n[1]=e[1]*d,n[2]=e[2]*d,n}function qn(n,e){return n[0]*e[0]+n[1]*e[1]+n[2]*e[2]}function jr(n,e,i){var o=e[0],l=e[1],d=e[2],f=i[0],_=i[1],v=i[2];return n[0]=l*v-d*_,n[1]=d*f-o*v,n[2]=o*_-l*f,n}function bl(n,e,i,o){var l=e[0],d=e[1],f=e[2];return n[0]=l+o*(i[0]-l),n[1]=d+o*(i[1]-d),n[2]=f+o*(i[2]-f),n}function Kn(n,e,i){var o=e[0],l=e[1],d=e[2],f=i[3]*o+i[7]*l+i[11]*d+i[15];return n[0]=(i[0]*o+i[4]*l+i[8]*d+i[12])/(f=f||1),n[1]=(i[1]*o+i[5]*l+i[9]*d+i[13])/f,n[2]=(i[2]*o+i[6]*l+i[10]*d+i[14])/f,n}function Va(n,e,i){var o=e[0],l=e[1],d=e[2];return n[0]=o*i[0]+l*i[3]+d*i[6],n[1]=o*i[1]+l*i[4]+d*i[7],n[2]=o*i[2]+l*i[5]+d*i[8],n}function $a(n,e,i){var o=i[0],l=i[1],d=i[2],f=i[3],_=e[0],v=e[1],b=e[2],E=l*b-d*v,I=d*_-o*b,C=o*v-l*_;return n[0]=_+f*(E+=E)+l*(C+=C)-d*(I+=I),n[1]=v+f*I+d*E-o*C,n[2]=b+f*C+o*I-l*E,n}function Eo(n){return n[0]=0,n[1]=0,n[2]=0,n}function Xr(n,e){return n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]}var Qn=ki,hp=ji,pc=pr;function Tl(){var n=new Q(4);return Q!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0,n[3]=0),n}function Ga(n,e,i){return n[0]=e[0]*i,n[1]=e[1]*i,n[2]=e[2]*i,n[3]=e[3]*i,n}function Ha(n,e){var i=e[0],o=e[1],l=e[2],d=e[3],f=i*i+o*o+l*l+d*d;return f>0&&(f=1/Math.sqrt(f)),n[0]=i*f,n[1]=o*f,n[2]=l*f,n[3]=d*f,n}function Ur(n,e,i){var o=e[0],l=e[1],d=e[2],f=e[3];return n[0]=i[0]*o+i[4]*l+i[8]*d+i[12]*f,n[1]=i[1]*o+i[5]*l+i[9]*d+i[13]*f,n[2]=i[2]*o+i[6]*l+i[10]*d+i[14]*f,n[3]=i[3]*o+i[7]*l+i[11]*d+i[15]*f,n}function na(){var n=new Q(4);return Q!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n[3]=1,n}function mc(n){return n[0]=0,n[1]=0,n[2]=0,n[3]=1,n}function hs(n,e,i){i*=.5;var o=e[0],l=e[1],d=e[2],f=e[3],_=Math.sin(i),v=Math.cos(i);return n[0]=o*v+f*_,n[1]=l*v+d*_,n[2]=d*v-l*_,n[3]=f*v-o*_,n}function ra(n,e,i){i*=.5;var o=e[0],l=e[1],d=e[2],f=e[3],_=Math.sin(i),v=Math.cos(i);return n[0]=o*v-d*_,n[1]=l*v+f*_,n[2]=d*v+o*_,n[3]=f*v-l*_,n}Ri(),Tl();var no,Sl,El,Il=Ha,_c=(no=Ri(),Sl=In(1,0,0),El=In(0,1,0),function(n,e,i){var o=qn(e,i);return o<-.999999?(jr(no,Sl,e),pc(no)<1e-6&&jr(no,El,e),yn(no,no),function(l,d,f){f*=.5;var _=Math.sin(f);l[0]=_*d[0],l[1]=_*d[1],l[2]=_*d[2],l[3]=Math.cos(f)}(n,no,Math.PI),n):o>.999999?(n[0]=0,n[1]=0,n[2]=0,n[3]=1,n):(jr(no,e,i),n[0]=no[0],n[1]=no[1],n[2]=no[2],n[3]=1+o,Il(n,n))});function Ir(){var n=new Q(2);return Q!=Float32Array&&(n[0]=0,n[1]=0),n}function po(n,e){var i=new Q(2);return i[0]=n,i[1]=e,i}function wu(n,e,i){return n[0]=e,n[1]=i,n}function qa(n,e,i){return n[0]=e[0]+i[0],n[1]=e[1]+i[1],n}function Ls(n,e,i){return n[0]=e[0]-i[0],n[1]=e[1]-i[1],n}function oa(n,e,i){return n[0]=e[0]*i,n[1]=e[1]*i,n}function ds(n){var e=n[0],i=n[1];return Math.sqrt(e*e+i*i)}function bu(n,e){var i=e[0],o=e[1],l=i*i+o*o;return l>0&&(l=1/Math.sqrt(l)),n[0]=e[0]*l,n[1]=e[1]*l,n}function Al(n,e){return n[0]*e[0]+n[1]*e[1]}na(),na(),Ee();var Rn,Lr,Fh=Ls;function Cl(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}Ir();var fs=function(){if(Lr)return Rn;function n(e,i,o,l){this.cx=3*e,this.bx=3*(o-e)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*i,this.by=3*(l-i)-this.cy,this.ay=1-this.cy-this.by,this.p1x=e,this.p1y=i,this.p2x=o,this.p2y=l}return Lr=1,Rn=n,n.prototype={sampleCurveX:function(e){return((this.ax*e+this.bx)*e+this.cx)*e},sampleCurveY:function(e){return((this.ay*e+this.by)*e+this.cy)*e},sampleCurveDerivativeX:function(e){return(3*this.ax*e+2*this.bx)*e+this.cx},solveCurveX:function(e,i){if(i===void 0&&(i=1e-6),e<0)return 0;if(e>1)return 1;for(var o=e,l=0;l<8;l++){var d=this.sampleCurveX(o)-e;if(Math.abs(d)<i)return o;var f=this.sampleCurveDerivativeX(o);if(Math.abs(f)<1e-6)break;o-=d/f}var _=0,v=1;for(o=e,l=0;l<20&&(d=this.sampleCurveX(o),!(Math.abs(d-e)<i));l++)e>d?_=o:v=o,o=.5*(v-_)+_;return o},solve:function(e,i){return this.sampleCurveY(this.solveCurveX(e,i))}},Rn}(),Bh=Cl(fs);function et(n,e){this.x=n,this.y=e}function sa(n,e){if(Array.isArray(n)){if(!Array.isArray(e)||n.length!==e.length)return!1;for(let i=0;i<n.length;i++)if(!sa(n[i],e[i]))return!1;return!0}if(typeof n=="object"&&n!==null&&e!==null){if(typeof e!="object"||Object.keys(n).length!==Object.keys(e).length)return!1;for(const i in n)if(!sa(n[i],e[i]))return!1;return!0}return n===e}et.prototype={clone(){return new et(this.x,this.y)},add(n){return this.clone()._add(n)},sub(n){return this.clone()._sub(n)},multByPoint(n){return this.clone()._multByPoint(n)},divByPoint(n){return this.clone()._divByPoint(n)},mult(n){return this.clone()._mult(n)},div(n){return this.clone()._div(n)},rotate(n){return this.clone()._rotate(n)},rotateAround(n,e){return this.clone()._rotateAround(n,e)},matMult(n){return this.clone()._matMult(n)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(n){return this.x===n.x&&this.y===n.y},dist(n){return Math.sqrt(this.distSqr(n))},distSqr(n){const e=n.x-this.x,i=n.y-this.y;return e*e+i*i},angle(){return Math.atan2(this.y,this.x)},angleTo(n){return Math.atan2(this.y-n.y,this.x-n.x)},angleWith(n){return this.angleWithSep(n.x,n.y)},angleWithSep(n,e){return Math.atan2(this.x*e-this.y*n,this.x*n+this.y*e)},_matMult(n){const e=n[2]*this.x+n[3]*this.y;return this.x=n[0]*this.x+n[1]*this.y,this.y=e,this},_add(n){return this.x+=n.x,this.y+=n.y,this},_sub(n){return this.x-=n.x,this.y-=n.y,this},_mult(n){return this.x*=n,this.y*=n,this},_div(n){return this.x/=n,this.y/=n,this},_multByPoint(n){return this.x*=n.x,this.y*=n.y,this},_divByPoint(n){return this.x/=n.x,this.y/=n.y,this},_unit(){return this._div(this.mag()),this},_perp(){const n=this.y;return this.y=this.x,this.x=-n,this},_rotate(n){const e=Math.cos(n),i=Math.sin(n),o=i*this.x+e*this.y;return this.x=e*this.x-i*this.y,this.y=o,this},_rotateAround(n,e){const i=Math.cos(n),o=Math.sin(n),l=e.y+o*(this.x-e.x)+i*(this.y-e.y);return this.x=e.x+i*(this.x-e.x)-o*(this.y-e.y),this.y=l,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:et},et.convert=function(n){if(n instanceof et)return n;if(Array.isArray(n))return new et(+n[0],+n[1]);if(n.x!==void 0&&n.y!==void 0)return new et(+n.x,+n.y);throw new Error("Expected [x, y] or {x, y} point format")};const dp=Math.PI/180,Pl=180/Math.PI;function Oi(n){return n*dp}function Kr(n){return n*Pl}const fp=[[0,0],[1,0],[1,1],[0,1]];function Ml(n){if(n<=0)return 0;if(n>=1)return 1;const e=n*n,i=e*n;return 4*(n<.5?i:3*(n-e)+i-.75)}function Tu(n,e,i,o){const l=new Bh(n,e,i,o);return function(d){return l.solve(d)}}const Ie=Tu(.25,.1,.25,1);function V(n,e,i){return Math.min(i,Math.max(e,n))}function q(n,e,i){return(i=V((i-n)/(e-n),0,1))*i*(3-2*i)}function ee(n,e,i){const o=i-e,l=((n-e)%o+o)%o+e;return l===e?i:l}function pe(n,e,i){if(!n.length)return i(null,[]);let o=n.length;const l=new Array(n.length);let d=null;n.forEach((f,_)=>{e(f,(v,b)=>{v&&(d=v),l[_]=b,--o==0&&i(d,l)})})}let de=1;function ve(){return de++}function Le(n){return n<=1?1:Math.pow(2,Math.ceil(Math.log2(n)))}function Te(n,e){n.forEach(i=>{e[i]&&(e[i]=e[i].bind(e))})}function ke(n,e,i){const o={};for(const l in n)o[l]=e.call(this,n[l],l,n);return o}function rt(n,e,i){const o={};for(const l in n)e.call(this,n[l],l,n)&&(o[l]=n[l]);return o}function Ge(n){return Array.isArray(n)?n.map(Ge):typeof n=="object"&&n?ke(n,Ge):n}function Et(n,e){for(let i=0;i<n.length;i++)if(e.indexOf(n[i])>=0)return!0;return!1}const jt={};function bt(n){jt[n]||(typeof console<"u"&&console.warn(n),jt[n]=!0)}function li(n,e,i){return(i.y-n.y)*(e.x-n.x)>(e.y-n.y)*(i.x-n.x)}function si(n){let e=0;for(let i,o,l=0,d=n.length,f=d-1;l<d;f=l++)i=n[l],o=n[f],e+=(o.x-i.x)*(i.y+o.y);return e}function ri([n,e,i]){const o=Oi(e+90),l=Oi(i);return{x:n*Math.cos(o)*Math.sin(l),y:n*Math.sin(o)*Math.sin(l),z:n*Math.cos(l),azimuthal:e,polar:i}}function Ii(n){return(typeof self<"u"||n!==void 0)&&typeof WorkerGlobalScope<"u"&&(n!==void 0?n:self)instanceof WorkerGlobalScope}function Fn(n){const e={};if(n.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(i,o,l,d)=>{const f=l||d;return e[o]=!f||f.toLowerCase(),""}),e["max-age"]){const i=parseInt(e["max-age"],10);isNaN(i)?delete e["max-age"]:e["max-age"]=i}return e}let er=null;function Vn(n,e){return[n[4*e],n[4*e+1],n[4*e+2],n[4*e+3]]}function rr(n,e,i,o){for(;e<i;){const l=e+i>>1;n[l]<o?e=l+1:i=l}return e}function kn(n,e,i,o){for(;e<i;){const l=e+i>>1;n[l]<=o?e=l+1:i=l}return e}function Li(n){return n>0?1/(1.001-n):1+n}function Ln(n){return n>0?1-1/(1.001-n):-n}function an(n,e,i){return(n-e.min)*(i.max-i.min)/(e.max-e.min)+i.min}const xi={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!xi.API_URL)return null;try{const n=new URL(xi.API_URL);return n.hostname==="api.mapbox.cn"?"https://events.mapbox.cn/events/v2":n.hostname==="api.mapbox.com"?"https://events.mapbox.com/events/v2":null}catch{return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",BUILDING_GEN_URL:"https://api.mapbox.com/mapbox-gl-js/building-gen/building_gen_v1.2.4.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function $n(n){return xi.API_URL_REGEX.test(n)}function Or(n){return xi.API_SPRITE_REGEX.test(n)}let Vr,mo,Rl,Ar,zo,Yr;function zs(){return Vr==null&&(Vr=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&typeof self.createImageBitmap=="function"),Vr}const xr={now:()=>Ar!==void 0?Ar:performance.now(),setNow(n){Ar=n},restoreNow(){Ar=void 0},frame(n){const e=requestAnimationFrame(n);return{cancel:()=>cancelAnimationFrame(e)}},getImageData(n,e=0){const{width:i,height:o}=n;zo||(zo=document.createElement("canvas"));const l=zo.getContext("2d",{willReadFrequently:!0});if(!l)throw new Error("failed to create canvas 2d context");return(i>zo.width||o>zo.height)&&(zo.width=i,zo.height=o),l.clearRect(-e,-e,i+2*e,o+2*e),l.drawImage(n,0,0,i,o),l.getImageData(-e,-e,i+2*e,o+2*e)},resolveURL:n=>(mo||(mo=document.createElement("a")),mo.href=n,mo.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(Rl==null&&(Rl=window.matchMedia("(prefers-reduced-motion: reduce)")),Rl.matches)},hasCanvasFingerprintNoise(){if(Yr!==void 0)return Yr;if(!zs())return Yr=!1,!1;const n=new OffscreenCanvas(85,1),e=n.getContext("2d",{willReadFrequently:!0});let i=0;for(let l=0;l<n.width;++l)e.fillStyle=`rgba(${i++},${i++},${i++}, 255)`,e.fillRect(l,0,1,1);const o=e.getImageData(0,0,n.width,n.height);i=0;for(let l=0;l<o.data.length;++l)if(l%4!=3&&i++!==o.data[l])return Yr=!0,!0;return Yr=!1,!1}};function kl(n,e){const i=n.indexOf("?");if(i<0)return`${n}?${new URLSearchParams(e).toString()}`;const o=new URLSearchParams(n.slice(i));for(const l in e)o.set(l,e[l]);return`${n.slice(0,i)}?${o.toString()}`}function gc(n,e={persistentParams:[]}){const i=n.indexOf("?");if(i<0)return n;const o=new URLSearchParams,l=new URLSearchParams(n.slice(i));for(const f of e.persistentParams){const _=l.get(f);_&&o.set(f,_)}const d=o.toString();return`${n.slice(0,i)}${d.length>0?`?${d}`:""}`}const Nh="mapbox-tiles";let jh=500,Uh=50;const Su=["language","worldview","jobid"];let Ds,_o;function ps(){try{return caches}catch{}}function ms(){const n=ps();n&&Ds==null&&(Ds=n.open(Nh))}let Zo=1/0;const Os={supported:!1,testSupport:function(n){!Vh&&Ll&&(zl?lg(n):Wa=n)}};let Wa,Ll,Vh=!1,zl=!1;const $h=typeof self<"u"?self:{};function lg(n){const e=n.createTexture();n.bindTexture(n.TEXTURE_2D,e);try{if(n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,Ll),n.isContextLost())return;Os.supported=!0}catch{}n.deleteTexture(e),Vh=!0}$h.document&&(Ll=$h.document.createElement("img"),Ll.onload=function(){Wa&&lg(Wa),Wa=null,zl=!0},Ll.onerror=function(){Vh=!0,Wa=null},Ll.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const Eu={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Iconset:"Iconset",Image:"Image",Model:"Model"};typeof Object.freeze=="function"&&Object.freeze(Eu);class Io extends Error{constructor(e,i,o){i===401&&$n(o)&&(e+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(e),this.status=i,this.url=o}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const Gh=Ii()?()=>self.worker.referrer:()=>(location.protocol==="blob:"?parent:self).location.href,Dl=function(n,e){if(!(/^file:/.test(i=n.url)||/^file:/.test(Gh())&&!/^\w+:/.test(i))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(o,l){const d=new AbortController,f=new Request(o.url,{method:o.method||"GET",body:o.body,credentials:o.credentials,headers:o.headers,referrer:Gh(),referrerPolicy:o.referrerPolicy,signal:d.signal});let _=!1,v=!1;const b=(E=f.url).indexOf("sku=")>0&&$n(E);var E;o.type==="json"&&f.headers.set("Accept","application/json");const I=(R,k,F)=>{if(v)return;if(R&&R.message!=="SecurityError"&&bt(R.toString()),k&&F)return C(k);const U=Date.now();fetch(f).then(j=>{if(j.ok){const H=b?j.clone():null;return C(j,H,U)}return l(new Io(j.statusText,j.status,o.url))}).catch(j=>{j.name!=="AbortError"&&l(new Error(`${j.message} ${o.url}`))})},C=(R,k,F)=>{(o.type==="arrayBuffer"?R.arrayBuffer():o.type==="json"?R.json():R.text()).then(U=>{v||(k&&F&&function(j,H,W){if(ms(),Ds==null)return;const Y=Fn(H.headers.get("Cache-Control")||"");if(Y["no-store"])return;const se={status:H.status,statusText:H.statusText,headers:new Headers};H.headers.forEach((fe,ge)=>se.headers.set(ge,fe)),Y["max-age"]&&se.headers.set("Expires",new Date(W+1e3*Y["max-age"]).toUTCString());const ie=se.headers.get("Expires");if(!ie||new Date(ie).getTime()-W<42e4)return;let ce=gc(j.url,{persistentParams:Su});if(H.status===206){const fe=j.headers.get("Range");if(!fe)return;se.status=200,ce=kl(ce,{range:fe})}(function(fe,ge){if(_o===void 0)try{new Response(new ReadableStream),_o=!0}catch{_o=!1}_o?ge(fe.body):fe.blob().then(ge).catch(Fe=>bt(Fe.message))})(H,fe=>{const ge=new Response((Fe=H.status)!==200&&Fe!==404&&[101,103,204,205,304].includes(Fe)?null:fe,se);var Fe;ms(),Ds!=null&&Ds.then(be=>be.put(ce,ge)).catch(be=>bt(be.message))})}(f,k,F),_=!0,l(null,U,R.headers))}).catch(U=>{v||l(new Error(U.message))})};return b?function(R,k){if(ms(),Ds==null)return k(null);Ds.then(F=>{let U=gc(R.url,{persistentParams:Su});const j=R.headers.get("Range");j&&(U=kl(U,{range:j})),F.match(U).then(H=>{const W=function(Y){if(!Y)return!1;const se=new Date(Y.headers.get("Expires")||0),ie=Fn(Y.headers.get("Cache-Control")||"");return Number(se)>Date.now()&&!ie["no-cache"]}(H);F.delete(U).catch(k),W&&F.put(U,H.clone()).catch(k),k(null,H,W)}).catch(k)}).catch(k)}(f,I):I(null,null),{cancel:()=>{v=!0,_||d.abort()}}}(n,e);if(Ii(self)&&self.worker.actor)return self.worker.actor.send("getResource",n,e,void 0,!0)}var i;return function(o,l){const d=new XMLHttpRequest;d.open(o.method||"GET",o.url,!0),o.type==="arrayBuffer"&&(d.responseType="arraybuffer");for(const f in o.headers)d.setRequestHeader(f,o.headers[f]);return o.type==="json"&&(d.responseType="text",d.setRequestHeader("Accept","application/json")),d.withCredentials=o.credentials==="include",d.onerror=()=>{l(new Error(d.statusText))},d.onload=()=>{if((d.status>=200&&d.status<300||d.status===0)&&d.response!==null){let f=d.response;if(o.type==="json")try{f=JSON.parse(d.response)}catch(v){return l(v)}const _=new Headers;d.getAllResponseHeaders().trim().split(/[\r\n]+/).forEach(v=>{const b=v.split(": "),E=b.shift(),I=b.join(": ");_.append(E,I)}),l(null,f,_)}else l(new Io(d.statusText,d.status,o.url))},d.send(o.body),{cancel:()=>d.abort()}}(n,e)},aa=function(n,e){return Dl(Object.assign(n,{type:"arrayBuffer"}),e)};function Rv(n){const e=document.createElement("a");return e.href=n,e.protocol===location.protocol&&e.host===location.host}const cg="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let Iu,zi;Iu=[],zi=0;const Hh=function(n,e){if(Os.supported&&(n.headers||(n.headers={}),n.headers.accept="image/webp,*/*"),zi>=xi.MAX_PARALLEL_IMAGE_REQUESTS){const d={requestParameters:n,callback:e,cancelled:!1,cancel(){this.cancelled=!0}};return Iu.push(d),d}zi++;let i=!1;const o=()=>{if(!i)for(i=!0,zi--;Iu.length&&zi<xi.MAX_PARALLEL_IMAGE_REQUESTS;){const d=Iu.shift(),{requestParameters:f,callback:_,cancelled:v}=d;v||(d.cancel=Hh(f,_).cancel)}},l=aa(n,(d,f,_)=>{o(),d?e(d):f&&(self.createImageBitmap?function(v,b){const E=new Blob([new Uint8Array(v)],{type:"image/png"});createImageBitmap(E).then(I=>{b(null,I)}).catch(I=>{b(new Error(`Could not load image because of ${I.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(f,(v,b)=>e(v,b,_)):function(v,b){const E=new Image;E.onload=()=>{b(null,E),URL.revokeObjectURL(E.src),E.onload=null,requestAnimationFrame(()=>{E.src=cg})},E.onerror=()=>b(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const I=new Blob([new Uint8Array(v)],{type:"image/png"});E.src=v.byteLength?URL.createObjectURL(I):cg}(f,(v,b)=>e(v,b,_)))});return{cancel:()=>{l.cancel(),o()}}};var pp,ug,hg,Za={exports:{}},Au={exports:{}},Cu={exports:{}},mp=function(){if(hg)return Za.exports;hg=1;var n=(pp||(pp=1,Au.exports=function(i,o){var l,d,f,_,v,b,E,I;for(d=i.length-(l=3&i.length),f=o,v=3432918353,b=461845907,I=0;I<d;)E=255&i.charCodeAt(I)|(255&i.charCodeAt(++I))<<8|(255&i.charCodeAt(++I))<<16|(255&i.charCodeAt(++I))<<24,++I,f=27492+(65535&(_=5*(65535&(f=(f^=E=(65535&(E=(E=(65535&E)*v+(((E>>>16)*v&65535)<<16)&4294967295)<<15|E>>>17))*b+(((E>>>16)*b&65535)<<16)&4294967295)<<13|f>>>19))+((5*(f>>>16)&65535)<<16)&4294967295))+((58964+(_>>>16)&65535)<<16);switch(E=0,l){case 3:E^=(255&i.charCodeAt(I+2))<<16;case 2:E^=(255&i.charCodeAt(I+1))<<8;case 1:f^=E=(65535&(E=(E=(65535&(E^=255&i.charCodeAt(I)))*v+(((E>>>16)*v&65535)<<16)&4294967295)<<15|E>>>17))*b+(((E>>>16)*b&65535)<<16)&4294967295}return f^=i.length,f=2246822507*(65535&(f^=f>>>16))+((2246822507*(f>>>16)&65535)<<16)&4294967295,f=3266489909*(65535&(f^=f>>>13))+((3266489909*(f>>>16)&65535)<<16)&4294967295,(f^=f>>>16)>>>0}),Au.exports),e=(ug||(ug=1,Cu.exports=function(i,o){for(var l,d=i.length,f=o^d,_=0;d>=4;)l=1540483477*(65535&(l=255&i.charCodeAt(_)|(255&i.charCodeAt(++_))<<8|(255&i.charCodeAt(++_))<<16|(255&i.charCodeAt(++_))<<24))+((1540483477*(l>>>16)&65535)<<16),f=1540483477*(65535&f)+((1540483477*(f>>>16)&65535)<<16)^(l=1540483477*(65535&(l^=l>>>24))+((1540483477*(l>>>16)&65535)<<16)),d-=4,++_;switch(d){case 3:f^=(255&i.charCodeAt(_+2))<<16;case 2:f^=(255&i.charCodeAt(_+1))<<8;case 1:f=1540483477*(65535&(f^=255&i.charCodeAt(_)))+((1540483477*(f>>>16)&65535)<<16)}return f=1540483477*(65535&(f^=f>>>13))+((1540483477*(f>>>16)&65535)<<16),(f^=f>>>15)>>>0}),Cu.exports);return Za.exports=n,Za.exports.murmur3=n,Za.exports.murmur2=e,Za.exports}(),qh=Cl(mp);class Fs{constructor(e,...i){Object.assign(this,i[0]||{}),this.type=e}}class Pu extends Fs{constructor(e,i={}){super("error",Object.assign({error:e},i))}}function _p(n,e,i){i[n]&&i[n].indexOf(e)!==-1||(i[n]=i[n]||[],i[n].push(e))}function Xa(n,e,i){if(i&&i[n]){const o=i[n].indexOf(e);o!==-1&&i[n].splice(o,1)}}class Ol{on(e,i){return this._listeners=this._listeners||{},_p(e,i,this._listeners),this}off(e,i){return Xa(e,i,this._listeners),Xa(e,i,this._oneTimeListeners),this}once(e,i){return i?(this._oneTimeListeners=this._oneTimeListeners||{},_p(e,i,this._oneTimeListeners),this):new Promise(o=>{this.once(e,o)})}fire(e,i){const o=typeof e=="string"?new Fs(e,i):e,l=o.type;if(this.listens(l)){o.target=this;const d=this._listeners&&this._listeners[l]?this._listeners[l].slice():[];for(const v of d)v.call(this,o);const f=this._oneTimeListeners&&this._oneTimeListeners[l]?this._oneTimeListeners[l].slice():[];for(const v of f)Xa(l,v,this._oneTimeListeners),v.call(this,o);const _=this._eventedParent;if(_){const v=typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData;Object.assign(o,v),_.fire(o)}}else o instanceof Pu&&console.error(o.error);return this}listens(e){return!!(this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e))}setEventedParent(e,i){return this._eventedParent=e,this._eventedParentData=i,this}}class Jr{constructor(e){typeof e=="string"?this.name=e:(this.name=e.name,this.iconsetId=e.iconsetId)}static from(e){return new Jr(e)}static toString(e){return e.iconsetId?`${e.name}${e.iconsetId}`:e.name}static parse(e){const[i,o]=e.split("");return new Jr({name:i,iconsetId:o})}static isEqual(e,i){return e.name===i.name&&e.iconsetId===i.iconsetId}toString(){return Jr.toString(this)}serialize(){return{name:this.name,iconsetId:this.iconsetId}}}var Wh,Mu={},Xo=function(){if(Wh)return Mu;Wh=1;var n={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function e(d){return(d=Math.round(d))<0?0:d>255?255:d}function i(d){return e(d[d.length-1]==="%"?parseFloat(d)/100*255:parseInt(d))}function o(d){return(f=d[d.length-1]==="%"?parseFloat(d)/100:parseFloat(d))<0?0:f>1?1:f;var f}function l(d,f,_){return _<0?_+=1:_>1&&(_-=1),6*_<1?d+(f-d)*_*6:2*_<1?f:3*_<2?d+(f-d)*(2/3-_)*6:d}try{Mu.parseCSSColor=function(d){var f,_=d.replace(/ /g,"").toLowerCase();if(_ in n)return n[_].slice();if(_[0]==="#")return _.length===4?(f=parseInt(_.substr(1),16))>=0&&f<=4095?[(3840&f)>>4|(3840&f)>>8,240&f|(240&f)>>4,15&f|(15&f)<<4,1]:null:_.length===7&&(f=parseInt(_.substr(1),16))>=0&&f<=16777215?[(16711680&f)>>16,(65280&f)>>8,255&f,1]:null;var v=_.indexOf("("),b=_.indexOf(")");if(v!==-1&&b+1===_.length){var E=_.substr(0,v),I=_.substr(v+1,b-(v+1)).split(","),C=1;switch(E){case"rgba":if(I.length!==4)return null;C=o(I.pop());case"rgb":return I.length!==3?null:[i(I[0]),i(I[1]),i(I[2]),C];case"hsla":if(I.length!==4)return null;C=o(I.pop());case"hsl":if(I.length!==3)return null;var R=(parseFloat(I[0])%360+360)%360/360,k=o(I[1]),F=o(I[2]),U=F<=.5?F*(k+1):F+k-F*k,j=2*F-U;return[e(255*l(j,U,R+1/3)),e(255*l(j,U,R)),e(255*l(j,U,R-1/3)),C];default:return null}}return null}}catch{}return Mu}();class Zi{constructor(e,i,o,l=1){this.r=e,this.g=i,this.b=o,this.a=l}static parse(e){if(!e)return;if(e instanceof Zi)return e;if(typeof e!="string")return;const i=Xo.parseCSSColor(e);return i?new Zi(i[0]/255,i[1]/255,i[2]/255,i[3]):void 0}toString(){const[e,i,o,l]=[this.r,this.g,this.b,this.a];return`rgba(${Math.round(255*e)},${Math.round(255*i)},${Math.round(255*o)},${l})`}toNonPremultipliedRenderColor(e){const{r:i,g:o,b:l,a:d}=this;return new fg(e,i,o,l,d)}toPremultipliedRenderColor(e){const{r:i,g:o,b:l,a:d}=this;return new pg(e,i*d,o*d,l*d,d)}clone(){return new Zi(this.r,this.g,this.b,this.a)}}class dg{constructor(e,i,o,l,d,f=!1){if(this.premultiplied=!1,this.premultiplied=f,e){const _=e.image.height,v=_*_;this.premultiplied?(i=d===0?0:i/d*(_-1),o=d===0?0:o/d*(_-1),l=d===0?0:l/d*(_-1)):(i*=_-1,o*=_-1,l*=_-1);const b=Math.floor(i),E=Math.floor(o),I=Math.floor(l),C=Math.ceil(i),R=Math.ceil(o),k=Math.ceil(l),F=i-b,U=o-E,j=l-I,H=e.image.data,W=4*(b+E*v+I*_),Y=4*(b+E*v+k*_),se=4*(b+R*v+I*_),ie=4*(b+R*v+k*_),ce=4*(C+E*v+I*_),fe=4*(C+E*v+k*_),ge=4*(C+R*v+I*_),Fe=4*(C+R*v+k*_);if(W<0||Fe>=H.length)throw new Error("out of range");this.r=Kt(Kt(Kt(H[W],H[Y],j),Kt(H[se],H[ie],j),U),Kt(Kt(H[ce],H[fe],j),Kt(H[ge],H[Fe],j),U),F)/255*(this.premultiplied?d:1),this.g=Kt(Kt(Kt(H[W+1],H[Y+1],j),Kt(H[se+1],H[ie+1],j),U),Kt(Kt(H[ce+1],H[fe+1],j),Kt(H[ge+1],H[Fe+1],j),U),F)/255*(this.premultiplied?d:1),this.b=Kt(Kt(Kt(H[W+2],H[Y+2],j),Kt(H[se+2],H[ie+2],j),U),Kt(Kt(H[ce+2],H[fe+2],j),Kt(H[ge+2],H[Fe+2],j),U),F)/255*(this.premultiplied?d:1),this.a=d}else this.r=i,this.g=o,this.b=l,this.a=d}toArray(){const{r:e,g:i,b:o,a:l}=this;return[255*e,255*i,255*o,l]}toHslaArray(){let{r:e,g:i,b:o,a:l}=this;if(this.premultiplied){if(l===0)return[0,0,0,0];const k=1/l;e*=k,i*=k,o*=k}const d=Math.min(Math.max(e,0),1),f=Math.min(Math.max(i,0),1),_=Math.min(Math.max(o,0),1),v=Math.min(d,f,_),b=Math.max(d,f,_),E=b-v,I=.5*(v+b);if(E===0)return[0,0,100*I,l];const C=I>.5?E/(2-b-v):E/(b+v);let R;switch(b){case d:R=60*((f-_)/E+(f<_?6:0));break;case f:R=60*((_-d)/E+2);break;default:R=60*((d-f)/E+4)}return[R,100*C,100*I,l]}toArray01(){const{r:e,g:i,b:o,a:l}=this;return[e,i,o,l]}toArray01Scaled(e){const{r:i,g:o,b:l}=this;return[i*e,o*e,l*e]}toArray01Linear(){const{r:e,g:i,b:o,a:l}=this;return[Math.pow(e,2.2),Math.pow(i,2.2),Math.pow(o,2.2),l]}}class fg extends dg{constructor(e,i,o,l,d){super(e,i,o,l,d,!1)}}class pg extends dg{constructor(e,i,o,l,d){super(e,i,o,l,d,!0)}}function Kt(n,e,i){return n*(1-i)+e*i}function gp(n,e,i){return n.map((o,l)=>Kt(o,e[l],i))}Zi.black=new Zi(0,0,0,1),Zi.white=new Zi(1,1,1,1),Zi.transparent=new Zi(0,0,0,0),Zi.red=new Zi(1,0,0,1),Zi.blue=new Zi(0,0,1,1);var Ru=Object.freeze({__proto__:null,array:gp,color:function(n,e,i){return new Zi(Kt(n.r,e.r,i),Kt(n.g,e.g,i),Kt(n.b,e.b,i),Kt(n.a,e.a,i))},number:Kt});class Ko extends Error{constructor(e,i){super(i),this.message=i,this.key=e}}class yc{constructor(e,i=[]){this.parent=e,this.bindings={};for(const[o,l]of i)this.bindings[o]=l}concat(e){return new yc(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}const _s={kind:"null"},Bt={kind:"number"},Ei={kind:"string"},Ji={kind:"boolean"},go={kind:"color"},Bs={kind:"object"},Wi={kind:"value"},Zh={kind:"collator"},ku={kind:"formatted"},Lu={kind:"resolvedImage"};function $r(n,e){return{kind:"array",itemType:n,N:e}}function tr(n){if(n.kind==="array"){const e=tr(n.itemType);return typeof n.N=="number"?`array<${e}, ${n.N}>`:n.itemType.kind==="value"?"array":`array<${e}>`}return n.kind}const kv=[_s,Bt,Ei,Ji,go,ku,Bs,$r(Wi),Lu];function Ka(n,e){if(e.kind==="error")return null;if(n.kind==="array"){if(e.kind==="array"&&(e.N===0&&e.itemType.kind==="value"||!Ka(n.itemType,e.itemType))&&(typeof n.N!="number"||n.N===e.N))return null}else{if(n.kind===e.kind)return null;if(n.kind==="value"){for(const i of kv)if(!Ka(i,e))return null}}return`Expected ${tr(n)} but found ${tr(e)} instead.`}function yp(n,e){return e.some(i=>i.kind===n.kind)}function zu(n,e){return e.some(i=>i==="null"?n===null:i==="array"?Array.isArray(n):i==="object"?n&&!Array.isArray(n)&&typeof n=="object":i===typeof n)}function Xh(n,e){return n.kind==="array"&&e.kind==="array"?n.N===e.N&&Xh(n.itemType,e.itemType):n.kind===e.kind}class vp{constructor(e,i,o){this.sensitivity=e?i?"variant":"case":i?"accent":"base",this.locale=o,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,i){return this.collator.compare(e,i)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class Kh{constructor(e,i,o,l,d){this.text=e.normalize?e.normalize():e,this.image=i,this.scale=o,this.fontStack=l,this.textColor=d}}class ro{constructor(e){this.sections=e}static fromString(e){return new ro([new Kh(e,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(e=>e.text.length!==0||!!e.image&&e.image.hasPrimary())}static factory(e){return e instanceof ro?e:ro.fromString(e)}toString(){return this.sections.length===0?"":this.sections.map(e=>e.text).join("")}serialize(){const e=["format"];for(const i of this.sections){if(i.image){const l=i.image.getPrimary().id.toString();e.push(["image",l]);continue}e.push(i.text);const o={};i.fontStack&&(o["text-font"]=["literal",i.fontStack.split(",")]),i.scale&&(o["font-scale"]=i.scale),i.textColor&&(o["text-color"]=["rgba"].concat(i.textColor.toNonPremultipliedRenderColor(null).toArray())),e.push(o)}return e}}class la{constructor(e,i={}){this.id=Jr.from(e),this.params=i.params,this.sx=i.sx||1,this.sy=i.sy||1}toString(){return JSON.stringify(this)}static parse(e){let i,o,l,d;try{({id:i,params:o,sx:l,sy:d}=JSON.parse(e)||{})}catch{return null}return i?new la(i,{params:o,sx:l,sy:d}):null}scaleSelf(e,i=e){return this.sx*=e,this.sy*=i,this}}class oo{constructor(e,i,o,l,d=!1){this.primaryId=Jr.from(e),this.primaryOptions=i,o&&(this.secondaryId=Jr.from(o)),this.secondaryOptions=l,this.available=d}toString(){return this.primaryId&&this.secondaryId?`[${this.primaryId.name},${this.secondaryId.name}]`:this.primaryId.name}hasPrimary(){return!!this.primaryId}getPrimary(){return new la(this.primaryId,this.primaryOptions)}hasSecondary(){return!!this.secondaryId}getSecondary(){return this.secondaryId?new la(this.secondaryId,this.secondaryOptions):null}static from(e){return typeof e=="string"?oo.build({name:e}):e}static build(e,i,o,l){return!e||typeof e=="object"&&!("name"in e)?null:new oo(e,o,i,l)}}function Fl(n,e,i,o){return typeof n=="number"&&n>=0&&n<=255&&typeof e=="number"&&e>=0&&e<=255&&typeof i=="number"&&i>=0&&i<=255?o===void 0||typeof o=="number"&&o>=0&&o<=1?null:`Invalid rgba value [${[n,e,i,o].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof o=="number"?[n,e,i,o]:[n,e,i]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function vc(n){if(n===null||typeof n=="string"||typeof n=="boolean"||typeof n=="number"||n instanceof Zi||n instanceof vp||n instanceof ro||n instanceof oo)return!0;if(Array.isArray(n)){for(const e of n)if(!vc(e))return!1;return!0}if(typeof n=="object"){for(const e in n)if(!vc(n[e]))return!1;return!0}return!1}function wr(n){if(n===null)return _s;if(typeof n=="string")return Ei;if(typeof n=="boolean")return Ji;if(typeof n=="number")return Bt;if(n instanceof Zi)return go;if(n instanceof vp)return Zh;if(n instanceof ro)return ku;if(n instanceof oo)return Lu;if(Array.isArray(n)){const e=n.length;let i;for(const o of n){const l=wr(o);if(i){if(i===l)continue;i=Wi;break}i=l}return $r(i||Wi,e)}return Bs}function Yo(n){const e=typeof n;return n===null?"":e==="string"||e==="number"||e==="boolean"?String(n):n instanceof ro||n instanceof oo||n instanceof Zi?n.toString():JSON.stringify(n)}class ca{constructor(e,i){this.type=e,this.value=i}static parse(e,i){if(e.length!==2)return i.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!vc(e[1]))return i.error("invalid value");const o=e[1];let l=wr(o);const d=i.expectedType;return l.kind!=="array"||l.N!==0||!d||d.kind!=="array"||typeof d.N=="number"&&d.N!==0||(l=d),new ca(l,o)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof Zi?["rgba"].concat(this.value.toNonPremultipliedRenderColor(null).toArray()):this.value instanceof ro?this.value.serialize():this.value}}class mr{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}}const xp={string:Ei,number:Bt,boolean:Ji,object:Bs};class gs{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");let o,l=1;const d=e[0];if(d==="array"){let _,v;if(e.length>2){const b=e[1];if(typeof b!="string"||!(b in xp)||b==="object")return i.error('The item type argument of "array" must be one of string, number, boolean',1);_=xp[b],l++}else _=Wi;if(e.length>3){if(e[2]!==null&&(typeof e[2]!="number"||e[2]<0||e[2]!==Math.floor(e[2])))return i.error('The length argument to "array" must be a positive integer literal',2);v=e[2],l++}o=$r(_,v)}else o=xp[d];const f=[];for(;l<e.length;l++){const _=i.parse(e[l],l,Wi);if(!_)return null;f.push(_)}return new gs(o,f)}evaluate(e){for(let i=0;i<this.args.length;i++){const o=this.args[i].evaluate(e);if(!Ka(this.type,wr(o)))return o;if(i===this.args.length-1)throw new mr(`The expression ${JSON.stringify(this.args[i].serialize())} evaluated to ${tr(wr(o))} but was expected to be of type ${tr(this.type)}.`)}return null}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){const e=this.type,i=[e.kind];if(e.kind==="array"){const o=e.itemType;if(o.kind==="string"||o.kind==="number"||o.kind==="boolean"){i.push(o.kind);const l=e.N;(typeof l=="number"||this.args.length>1)&&i.push(l)}}return i.concat(this.args.map(o=>o.serialize()))}}class Ns{constructor(e){this.type=ku,this.sections=e}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");const o=e[1];if(!Array.isArray(o)&&typeof o=="object")return i.error("First argument must be an image or text section.");const l=[];let d=!1;for(let f=1;f<=e.length-1;++f){const _=e[f];if(d&&typeof _=="object"&&!Array.isArray(_)){d=!1;let v=null;if(_["font-scale"]&&(v=i.parseObjectValue(_["font-scale"],f,"font-scale",Bt),!v))return null;let b=null;if(_["text-font"]&&(b=i.parseObjectValue(_["text-font"],f,"text-font",$r(Ei)),!b))return null;let E=null;if(_["text-color"]&&(E=i.parseObjectValue(_["text-color"],f,"text-color",go),!E))return null;const I=l[l.length-1];I.scale=v,I.font=b,I.textColor=E}else{const v=i.parse(e[f],f,Wi);if(!v)return null;const b=v.type.kind;if(b!=="string"&&b!=="value"&&b!=="null"&&b!=="resolvedImage")return i.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");d=!0,l.push({content:v,scale:null,font:null,textColor:null})}}return new Ns(l)}evaluate(e){return new ro(this.sections.map(i=>{const o=i.content.evaluate(e);return Xh(wr(o),Lu)?new Kh("",o,null,null,null):new Kh(Yo(o),null,i.scale?i.scale.evaluate(e):null,i.font?i.font.evaluate(e).join(","):null,i.textColor?i.textColor.evaluate(e):null)}))}eachChild(e){for(const i of this.sections)e(i.content),i.scale&&e(i.scale),i.font&&e(i.font),i.textColor&&e(i.textColor)}outputDefined(){return!1}serialize(){const e=["format"];for(const i of this.sections){e.push(i.content.serialize());const o={};i.scale&&(o["font-scale"]=i.scale.serialize()),i.font&&(o["text-font"]=i.font.serialize()),i.textColor&&(o["text-color"]=i.textColor.serialize()),e.push(o)}return e}}class ai{constructor(e,i,o,l){this._imageWarnHistory={},this.type=Lu,this.namePrimary=e,this.nameSecondary=i,o&&(this.paramsPrimary=o.params,this.iconsetIdPrimary=o.iconset?o.iconset.id:void 0),l&&(this.paramsSecondary=l.params,this.iconsetIdSecondary=l.iconset?l.iconset.id:void 0)}static parse(e,i){if(e.length<2)return i.error("Expected two or more arguments.");let o=1;const l=[];function d(){if(o<e.length){const _=i.parse(e[o],o++,Ei);return _?(l.push({image:_,options:{}}),!0):(i.error(l.length?"Secondary image variant is not a string.":"No image name provided."),!1)}return!0}function f(){if(o<e.length){const v=e[o];if((_=v)===null||typeof _!="object"||Array.isArray(_))return!0;const b=v.params,E=v.iconset,I=i.concat(o);if(!b&&!E)return o++,!0;if(b){if(typeof b!="object"||b.constructor!==Object)return I.error('Image options "params" should be an object'),!1;const C={},R=I.concat(void 0,"params");for(const k in b){if(!k)return R.error("Image parameter name should be non-empty"),!1;const F=R.concat(void 0,k).parse(b[k],void 0,go,void 0,{typeAnnotation:"coerce"});if(!F)return!1;C[k]=F}l[l.length-1].options.params=C}if(E){if(typeof E!="object"||E.constructor!==Object)return I.error('Image options "iconset" should be an object'),!1;if(!E.id)return I.error('Image options "iconset" should have an "id" property'),!1;l[l.length-1].options.iconset=E}return o++,!0}var _;return!0}for(let _=0;_<2;_++)if(!d()||!f())return;return new ai(l[0].image,l[1]?l[1].image:void 0,l[0].options,l[1]?l[1].options:void 0)}evaluateParams(e,i){const o={};if(i){for(const l in i)if(i[l])try{o[l]=i[l].evaluate(e)}catch{continue}if(Object.keys(o).length!==0)return{params:o}}}evaluate(e){const i={name:this.namePrimary.evaluate(e),iconsetId:this.iconsetIdPrimary},o=this.nameSecondary?{name:this.nameSecondary.evaluate(e),iconsetId:this.iconsetIdSecondary}:void 0,l=oo.build(i,o,this.paramsPrimary?this.evaluateParams(e,this.paramsPrimary):void 0,this.paramsSecondary?this.evaluateParams(e,this.paramsSecondary):void 0);if(l&&e.availableImages){const d=l.getPrimary().id;if(l.available=e.availableImages.some(f=>Jr.isEqual(f,d)),l.available){const f=l.getSecondary()?l.getSecondary().id:null;f&&(l.available=e.availableImages.some(_=>Jr.isEqual(_,f)))}}return l}eachChild(e){if(e(this.namePrimary),this.paramsPrimary)for(const i in this.paramsPrimary)this.paramsPrimary[i]&&e(this.paramsPrimary[i]);if(this.nameSecondary&&(e(this.nameSecondary),this.paramsSecondary))for(const i in this.paramsSecondary)this.paramsSecondary[i]&&e(this.paramsSecondary[i])}outputDefined(){return!1}serializeOptions(e,i){const o={};if(i&&(o.iconset={id:i}),e){o.params={};for(const l in e)e[l]&&(o.params[l]=e[l].serialize())}return Object.keys(o).length>0?o:void 0}serialize(){const e=["image",this.namePrimary.serialize()];if(this.paramsPrimary||this.iconsetIdPrimary){const i=this.serializeOptions(this.paramsPrimary,this.iconsetIdPrimary);i&&e.push(i)}if(this.nameSecondary&&(e.push(this.nameSecondary.serialize()),this.paramsSecondary||this.iconsetIdSecondary)){const i=this.serializeOptions(this.paramsSecondary,this.iconsetIdSecondary);i&&e.push(i)}return e}}function Dt(n){return Jt(n)?"string":xc(n)?"number":Jh(n)?"boolean":Array.isArray(n)?"array":n===null?"null":Yh(n)?"object":typeof n}function Yh(n){return n!=null&&!Array.isArray(n)&&typeof n!="function"&&!(n instanceof String||n instanceof Number||n instanceof Boolean)&&typeof n=="object"}function Jt(n){return typeof n=="string"||n instanceof String}function xc(n){return typeof n=="number"||n instanceof Number}function Jh(n){return typeof n=="boolean"||n instanceof Boolean}const Yt={"to-boolean":Ji,"to-color":go,"to-number":Bt,"to-string":Ei};class js{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");const o=e[0],l=[];let d=_s;if(o==="to-array"){if(!Array.isArray(e[1]))return null;const f=e[1].length;if(i.expectedType){if(i.expectedType.kind!=="array")return i.error(`Expected ${i.expectedType.kind} but found array.`);d=$r(i.expectedType.itemType,f)}else{if(!(f>0&&vc(e[1][0])))return null;d=$r(wr(e[1][0]),f)}for(let _=0;_<f;_++){const v=e[1][_];let b;if(Array.isArray(v))b=i.parse(v,void 0,d.itemType);else{const E=Dt(v);if(E!==d.itemType.kind)return i.error(`Expected ${d.itemType.kind} but found ${E}.`);b=i.registry.literal.parse(["literal",v===void 0?null:v],i)}if(!b)return null;l.push(b)}}else{if((o==="to-boolean"||o==="to-string")&&e.length!==2)return i.error("Expected one argument.");d=Yt[o];for(let f=1;f<e.length;f++){const _=i.parse(e[f],f,Wi);if(!_)return null;l.push(_)}}return new js(d,l)}evaluate(e){if(this.type.kind==="boolean")return!!this.args[0].evaluate(e);if(this.type.kind==="color"){let i,o;for(const l of this.args){if(i=l.evaluate(e),o=null,i instanceof Zi)return i;if(typeof i=="string"){const d=e.parseColor(i);if(d)return d}else if(Array.isArray(i)&&(o=i.length<3||i.length>4?`Invalid rbga value ${JSON.stringify(i)}: expected an array containing either three or four numeric values.`:Fl(i[0],i[1],i[2],i[3]),!o))return new Zi(i[0]/255,i[1]/255,i[2]/255,i[3])}throw new mr(o||`Could not parse color from value '${typeof i=="string"?i:String(JSON.stringify(i))}'`)}if(this.type.kind==="number"){let i=null;for(const o of this.args){if(i=o.evaluate(e),i===null)return 0;const l=Number(i);if(!isNaN(l))return l}throw new mr(`Could not convert ${JSON.stringify(i)} to number.`)}return this.type.kind==="formatted"?ro.fromString(Yo(this.args[0].evaluate(e))):this.type.kind==="resolvedImage"?oo.build(Yo(this.args[0].evaluate(e))):this.type.kind==="array"?this.args.map(i=>i.evaluate(e)):Yo(this.args[0].evaluate(e))}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){if(this.type.kind==="formatted")return new Ns([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new ai(this.args[0]).serialize();const e=this.type.kind==="array"?[]:[`to-${this.type.kind}`];return this.eachChild(i=>{e.push(i.serialize())}),e}}const wp=["Unknown","Point","LineString","Polygon"];class Qh{constructor(e,i,o){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=e,this.options=i,this.iconImageUseTheme=o}id(){return this.feature&&this.feature.id!==void 0?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?wp[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(e){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const e=this.featureDistanceData.center,i=this.featureDistanceData.scale,{x:o,y:l}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(o*i-e[0])+this.featureDistanceData.bearing[1]*(l*i-e[1])}return 0}parseColor(e){let i=this._parseColorCache[e];return i||(i=this._parseColorCache[e]=Zi.parse(e)),i}getConfig(e){return this.options?this.options.get(e):null}}class so{constructor(e,i,o,l,d){this.name=e,this.type=i,this._evaluate=o,this.args=l,this._overloadIndex=d}evaluate(e){if(!this._evaluate){const i=so.definitions[this.name];this._evaluate=Array.isArray(i)?i[2]:i.overloads[this._overloadIndex][1]}return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(e=>e.serialize()))}static parse(e,i){const o=e[0],l=so.definitions[o];if(!l)return i.error(`Unknown expression "${o}". If you wanted a literal array, use ["literal", [...]].`,0);const d=Array.isArray(l)?l[0]:l.type,f=Array.isArray(l)?[[l[1],l[2]]]:l.overloads,_=[];let v=null,b=-1;for(const[E,I]of f){if(Array.isArray(E)&&E.length!==e.length-1)continue;_.push(E),b++,v=new hd(i.registry,i.path,null,i.scope,void 0,i._scope,i.options,i.iconImageUseTheme);const C=[];let R=!1;for(let k=1;k<e.length;k++){const F=e[k],U=Array.isArray(E)?E[k-1]:E.type,j=v.parse(F,1+C.length,U);if(!j){R=!0;break}C.push(j)}if(!R)if(Array.isArray(E)&&E.length!==C.length)v.error(`Expected ${E.length} arguments, but found ${C.length} instead.`);else{for(let k=0;k<C.length;k++){const F=Array.isArray(E)?E[k]:E.type,U=C[k];v.concat(k+1).checkSubtype(F,U.type)}if(v.errors.length===0)return new so(o,d,I,C,b)}}if(_.length===1)i.errors.push(...v.errors);else{const E=(_.length?_:f.map(([C])=>C)).map(ed).join(" | "),I=[];for(let C=1;C<e.length;C++){const R=i.parse(e[C],1+I.length);if(!R)return null;I.push(tr(R.type))}i.error(`Expected arguments of type ${E}, but found (${I.join(", ")}) instead.`)}return null}static register(e,i){so.definitions=i;for(const o in i)e[o]=so}}function ed(n){return Array.isArray(n)?`(${n.map(tr).join(", ")})`:`(${tr(n.type)}...)`}class Cr{constructor(e,i,o){this.type=Zh,this.locale=o,this.caseSensitive=e,this.diacriticSensitive=i}static parse(e,i){if(e.length!==2)return i.error("Expected one argument.");const o=e[1];if(typeof o!="object"||Array.isArray(o))return i.error("Collator options argument must be an object.");const l=o["case-sensitive"]===void 0?i.parse(!1,1,Ji):i.parseObjectValue(o["case-sensitive"],1,"case-sensitive",Ji);if(!l)return null;const d=o["diacritic-sensitive"]===void 0?i.parse(!1,1,Ji):i.parseObjectValue(o["diacritic-sensitive"],1,"diacritic-sensitive",Ji);if(!d)return null;let f=null;return o.locale&&(f=i.parseObjectValue(o.locale,1,"locale",Ei),!f)?null:new Cr(l,d,f)}evaluate(e){return new vp(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}serialize(){const e={};return e["case-sensitive"]=this.caseSensitive.serialize(),e["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(e.locale=this.locale.serialize()),["collator",e]}}function td(n,e,i=0,o=n.length-1,l=bp){for(;o>i;){if(o-i>600){const v=o-i+1,b=e-i+1,E=Math.log(v),I=.5*Math.exp(2*E/3),C=.5*Math.sqrt(E*I*(v-I)/v)*(b-v/2<0?-1:1);td(n,e,Math.max(i,Math.floor(e-b*I/v+C)),Math.min(o,Math.floor(e+(v-b)*I/v+C)),l)}const d=n[e];let f=i,_=o;for(ys(n,i,e),l(n[o],d)>0&&ys(n,i,o);f<_;){for(ys(n,f,_),f++,_--;l(n[f],d)<0;)f++;for(;l(n[_],d)>0;)_--}l(n[i],d)===0?ys(n,i,_):(_++,ys(n,_,o)),_<=e&&(i=_+1),e<=_&&(o=_-1)}}function ys(n,e,i){const o=n[e];n[e]=n[i],n[i]=o}function bp(n,e){return n<e?-1:n>e?1:0}function Ya(n){let e=0;for(let i,o,l=0,d=n.length,f=d-1;l<d;f=l++)i=n[l],o=n[f],e+=(o.x-i.x)*(i.y+o.y);return e}function Jo(n,e){n[0]=Math.min(n[0],e[0]),n[1]=Math.min(n[1],e[1]),n[2]=Math.max(n[2],e[0]),n[3]=Math.max(n[3],e[1])}function Du(n,e){return!(n[0]<=e[0]||n[2]>=e[2]||n[1]<=e[1]||n[3]>=e[3])}function Lv(n,e,i){const o=n[0]-e[0],l=n[1]-e[1],d=n[0]-i[0],f=n[1]-i[1];return o*f-d*l==0&&o*d<=0&&l*f<=0}function wc(n,e,i=!1){let o=!1;for(let _=0,v=e.length;_<v;_++){const b=e[_];for(let E=0,I=b.length,C=I-1;E<I;C=E++){const R=b[C],k=b[E];if(Lv(n,R,k))return i;(d=R)[1]>(l=n)[1]!=(f=k)[1]>l[1]&&l[0]<(f[0]-d[0])*(l[1]-d[1])/(f[1]-d[1])+d[0]&&(o=!o)}}var l,d,f;return o}function Ou(n,e,i,o){const l=o[0]-i[0],d=o[1]-i[1],f=(n[0]-i[0])*d-l*(n[1]-i[1]),_=(e[0]-i[0])*d-l*(e[1]-i[1]);return f>0&&_<0||f<0&&_>0}function Fu(n,e,i,o){return(l=[o[0]-i[0],o[1]-i[1]])[0]*(d=[e[0]-n[0],e[1]-n[1]])[1]-l[1]*d[0]!=0&&!(!Ou(n,e,i,o)||!Ou(i,o,n,e));var l,d}function ua(n){const e=new et(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),i=new et(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(const o of n[0])e.x>o.x&&(e.x=o.x),e.y>o.y&&(e.y=o.y),i.x<o.x&&(i.x=o.x),i.y<o.y&&(i.y=o.y);return{min:e,max:i}}const Ja=8192;function zv(n,e){const i=(180+n[0])/360,o=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+n[1]*Math.PI/360)))/360,l=Math.pow(2,e.z);return[Math.round(i*l*Ja),Math.round(o*l*Ja)]}function Tp(n,e){for(let i=0;i<e.length;i++)if(wc(n,e[i]))return!0;return!1}function Dv(n,e,i){for(const o of i)for(let l=0,d=o.length,f=d-1;l<d;f=l++)if(Fu(n,e,o[f],o[l]))return!0;return!1}function mg(n,e){for(let i=0;i<n.length;++i)if(!wc(n[i],e))return!1;for(let i=0;i<n.length-1;++i)if(Dv(n[i],n[i+1],e))return!1;return!0}function _g(n,e){for(let i=0;i<e.length;i++)if(mg(n,e[i]))return!0;return!1}function Sp(n,e,i){const o=[];for(let l=0;l<n.length;l++){const d=[];for(let f=0;f<n[l].length;f++){const _=zv(n[l][f],i);Jo(e,_),d.push(_)}o.push(d)}return o}function Qa(n,e,i){const o=[];for(let l=0;l<n.length;l++){const d=Sp(n[l],e,i);o.push(d)}return o}function gg(n,e,i,o){if(n[0]<i[0]||n[0]>i[2]){const l=.5*o;let d=n[0]-i[0]>l?-o:i[0]-n[0]>l?o:0;d===0&&(d=n[0]-i[2]>l?-o:i[2]-n[0]>l?o:0),n[0]+=d}Jo(e,n)}function yg(n,e,i,o){const l=Math.pow(2,o.z)*Ja,d=[o.x*Ja,o.y*Ja],f=[];if(!n)return f;for(const _ of n)for(const v of _){const b=[v.x+d[0],v.y+d[1]];gg(b,e,i,l),f.push(b)}return f}function id(n,e,i,o){const l=Math.pow(2,o.z)*Ja,d=[o.x*Ja,o.y*Ja],f=[];if(!n)return f;for(const v of n){const b=[];for(const E of v){const I=[E.x+d[0],E.y+d[1]];Jo(e,I),b.push(I)}f.push(b)}if(e[2]-e[0]<=l/2){(_=e)[0]=_[1]=1/0,_[2]=_[3]=-1/0;for(const v of f)for(const b of v)gg(b,e,i,l)}var _;return f}class el{constructor(e,i){this.type=Ji,this.geojson=e,this.geometries=i}static parse(e,i){if(e.length!==2)return i.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if(vc(e[1])){const o=e[1];if(o.type==="FeatureCollection")for(let l=0;l<o.features.length;++l){const d=o.features[l].geometry.type;if(d==="Polygon"||d==="MultiPolygon")return new el(o,o.features[l].geometry)}else if(o.type==="Feature"){const l=o.geometry.type;if(l==="Polygon"||l==="MultiPolygon")return new el(o,o.geometry)}else if(o.type==="Polygon"||o.type==="MultiPolygon")return new el(o,o)}return i.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return function(i,o){const l=[1/0,1/0,-1/0,-1/0],d=[1/0,1/0,-1/0,-1/0],f=i.canonicalID();if(!f)return!1;if(o.type==="Polygon"){const _=Sp(o.coordinates,d,f),v=yg(i.geometry(),l,d,f);if(!Du(l,d))return!1;for(const b of v)if(!wc(b,_))return!1}if(o.type==="MultiPolygon"){const _=Qa(o.coordinates,d,f),v=yg(i.geometry(),l,d,f);if(!Du(l,d))return!1;for(const b of v)if(!Tp(b,_))return!1}return!0}(e,this.geometries);if(e.geometryType()==="LineString")return function(i,o){const l=[1/0,1/0,-1/0,-1/0],d=[1/0,1/0,-1/0,-1/0],f=i.canonicalID();if(!f)return!1;if(o.type==="Polygon"){const _=Sp(o.coordinates,d,f),v=id(i.geometry(),l,d,f);if(!Du(l,d))return!1;for(const b of v)if(!mg(b,_))return!1}if(o.type==="MultiPolygon"){const _=Qa(o.coordinates,d,f),v=id(i.geometry(),l,d,f);if(!Du(l,d))return!1;for(const b of v)if(!_g(b,_))return!1}return!0}(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}const Bu={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},Qo=1/298.257223563,vg=Qo*(2-Qo),bc=Math.PI/180;class Tc{static fromTile(e,i,o){const l=Math.PI*(1-2*(e+.5)/Math.pow(2,i)),d=Math.atan(.5*(Math.exp(l)-Math.exp(-l)))/bc;return new Tc(d,o)}static get units(){return Bu}constructor(e,i){if(e===void 0)throw new Error("No latitude given.");if(i&&!Bu[i])throw new Error(`Unknown unit ${i}. Use one of: ${Object.keys(Bu).join(", ")}`);const o=6378.137*bc*(i?Bu[i]:1),l=Math.cos(e*bc),d=1/(1-vg*(1-l*l)),f=Math.sqrt(d);this.kx=o*f*l,this.ky=o*f*d*(1-vg)}distance(e,i){const o=Do(e[0]-i[0])*this.kx,l=(e[1]-i[1])*this.ky;return Math.sqrt(o*o+l*l)}bearing(e,i){const o=Do(i[0]-e[0])*this.kx;return Math.atan2(o,(i[1]-e[1])*this.ky)/bc}destination(e,i,o){const l=o*bc;return this.offset(e,Math.sin(l)*i,Math.cos(l)*i)}offset(e,i,o){return[e[0]+i/this.kx,e[1]+o/this.ky]}lineDistance(e){let i=0;for(let o=0;o<e.length-1;o++)i+=this.distance(e[o],e[o+1]);return i}area(e){let i=0;for(let o=0;o<e.length;o++){const l=e[o];for(let d=0,f=l.length,_=f-1;d<f;_=d++)i+=Do(l[d][0]-l[_][0])*(l[d][1]+l[_][1])*(o?-1:1)}return Math.abs(i)/2*this.kx*this.ky}along(e,i){let o=0;if(i<=0)return e[0];for(let l=0;l<e.length-1;l++){const d=e[l],f=e[l+1],_=this.distance(d,f);if(o+=_,o>i)return nd(d,f,(i-(o-_))/_)}return e[e.length-1]}pointToSegmentDistance(e,i,o){let[l,d]=i,f=Do(o[0]-l)*this.kx,_=(o[1]-d)*this.ky;if(f!==0||_!==0){const v=(Do(e[0]-l)*this.kx*f+(e[1]-d)*this.ky*_)/(f*f+_*_);v>1?(l=o[0],d=o[1]):v>0&&(l+=f/this.kx*v,d+=_/this.ky*v)}return f=Do(e[0]-l)*this.kx,_=(e[1]-d)*this.ky,Math.sqrt(f*f+_*_)}pointOnLine(e,i){let o=1/0,l=e[0][0],d=e[0][1],f=0,_=0;for(let v=0;v<e.length-1;v++){let b=e[v][0],E=e[v][1],I=Do(e[v+1][0]-b)*this.kx,C=(e[v+1][1]-E)*this.ky,R=0;I===0&&C===0||(R=(Do(i[0]-b)*this.kx*I+(i[1]-E)*this.ky*C)/(I*I+C*C),R>1?(b=e[v+1][0],E=e[v+1][1]):R>0&&(b+=I/this.kx*R,E+=C/this.ky*R)),I=Do(i[0]-b)*this.kx,C=(i[1]-E)*this.ky;const k=I*I+C*C;k<o&&(o=k,l=b,d=E,f=v,_=R)}return{point:[l,d],index:f,t:Math.max(0,Math.min(1,_))}}lineSlice(e,i,o){let l=this.pointOnLine(o,e),d=this.pointOnLine(o,i);if(l.index>d.index||l.index===d.index&&l.t>d.t){const b=l;l=d,d=b}const f=[l.point],_=l.index+1,v=d.index;!Ep(o[_],f[0])&&_<=v&&f.push(o[_]);for(let b=_+1;b<=v;b++)f.push(o[b]);return Ep(o[v],d.point)||f.push(d.point),f}lineSliceAlong(e,i,o){let l=0;const d=[];for(let f=0;f<o.length-1;f++){const _=o[f],v=o[f+1],b=this.distance(_,v);if(l+=b,l>e&&d.length===0&&d.push(nd(_,v,(e-(l-b))/b)),l>=i)return d.push(nd(_,v,(i-(l-b))/b)),d;l>e&&d.push(v)}return d}bufferPoint(e,i){const o=i/this.ky,l=i/this.kx;return[e[0]-l,e[1]-o,e[0]+l,e[1]+o]}bufferBBox(e,i){const o=i/this.ky,l=i/this.kx;return[e[0]-l,e[1]-o,e[2]+l,e[3]+o]}insideBBox(e,i){return Do(e[0]-i[0])>=0&&Do(e[0]-i[2])<=0&&e[1]>=i[1]&&e[1]<=i[3]}}function Ep(n,e){return n[0]===e[0]&&n[1]===e[1]}function nd(n,e,i){const o=Do(e[0]-n[0]);return[n[0]+o*i,n[1]+(e[1]-n[1])*i]}function Do(n){for(;n<-180;)n+=360;for(;n>180;)n-=360;return n}class rd{constructor(e=[],i=(o,l)=>o<l?-1:o>l?1:0){if(this.data=e,this.length=this.data.length,this.compare=i,this.length>0)for(let o=(this.length>>1)-1;o>=0;o--)this._down(o)}push(e){this.data.push(e),this._up(this.length++)}pop(){if(this.length===0)return;const e=this.data[0],i=this.data.pop();return--this.length>0&&(this.data[0]=i,this._down(0)),e}peek(){return this.data[0]}_up(e){const{data:i,compare:o}=this,l=i[e];for(;e>0;){const d=e-1>>1,f=i[d];if(o(l,f)>=0)break;i[e]=f,e=d}i[e]=l}_down(e){const{data:i,compare:o}=this,l=this.length>>1,d=i[e];for(;e<l;){let f=1+(e<<1);const _=f+1;if(_<this.length&&o(i[_],i[f])<0&&(f=_),o(i[f],d)>=0)break;i[e]=i[f],e=f}i[e]=d}}var dt=8192;function Ip(n,e){return e.dist-n.dist}const od=100,sd=50;function Ap(n){const e=[1/0,1/0,-1/0,-1/0];if(e.length!==n.length)return!1;for(let i=0;i<e.length;i++)if(e[i]!==n[i])return!1;return!0}function Nu(n){return n[1]-n[0]+1}function Us(n,e){const i=n[1]>=n[0]&&n[1]<e;return i||console.warn("Distance Expression: Index is out of range"),i}function Cp(n,e){if(n[0]>n[1])return[null,null];const i=Nu(n);if(e){if(i===2)return[n,null];const o=Math.floor(i/2);return[[n[0],n[0]+o],[n[0]+o,n[1]]]}{if(i===1)return[n,null];const o=Math.floor(i/2)-1;return[[n[0],n[0]+o],[n[0]+o+1,n[1]]]}}function Bl(n,e){const i=[1/0,1/0,-1/0,-1/0];if(!Us(e,n.length))return i;for(let o=e[0];o<=e[1];++o)Jo(i,n[o]);return i}function Nl(n){const e=[1/0,1/0,-1/0,-1/0];for(let i=0;i<n.length;++i)for(let o=0;o<n[i].length;++o)Jo(e,n[i][o]);return e}function tl(n,e,i){if(Ap(n)||Ap(e))return NaN;let o=0,l=0;return n[2]<e[0]&&(o=e[0]-n[2]),n[0]>e[2]&&(o=n[0]-e[2]),n[1]>e[3]&&(l=n[1]-e[3]),n[3]<e[1]&&(l=e[1]-n[3]),i.distance([0,0],[o,l])}function ad(n){return 360*n-180}function xg(n){return 360/Math.PI*Math.atan(Math.exp((180-360*n)*Math.PI/180))-90}function ld(n,e){const i=Math.pow(2,e.z),o=(n.y/dt+e.y)/i;return[ad((n.x/dt+e.x)/i),xg(o)]}function Ov(n,e){const i=[];for(let o=0;o<n.length;++o)i.push(ld(n[o],e));return i}function wg(n,e,i){const o=i.pointOnLine(e,n).point;return i.distance(n,o)}function Pp(n,e,i,o,l){const d=i.slice(o[0],o[1]+1);let f=1/0;for(let _=e[0];_<=e[1];++_)if((f=Math.min(f,wg(n[_],d,l)))===0)return 0;return f}function il(n,e,i,o,l){const d=Math.min(l.pointToSegmentDistance(n,i,o),l.pointToSegmentDistance(e,i,o)),f=Math.min(l.pointToSegmentDistance(i,n,e),l.pointToSegmentDistance(o,n,e));return Math.min(d,f)}function Ai(n,e,i,o,l){if(!Us(e,n.length)||!Us(o,i.length))return NaN;let d=1/0;for(let f=e[0];f<e[1];++f)for(let _=o[0];_<o[1];++_){if(Fu(n[f],n[f+1],i[_],i[_+1]))return 0;d=Math.min(d,il(n[f],n[f+1],i[_],i[_+1],l))}return d}function Fv(n,e,i,o,l){if(!Us(e,n.length)||!Us(o,i.length))return NaN;let d=1/0;for(let f=e[0];f<=e[1];++f)for(let _=o[0];_<=o[1];++_)if((d=Math.min(d,l.distance(n[f],i[_])))===0)return d;return d}function Bv(n,e,i){if(wc(n,e,!0))return 0;let o=1/0;for(const l of e){const d=l.length;if(d<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(l[0]!==l[d-1]&&(o=Math.min(o,i.pointToSegmentDistance(n,l[d-1],l[0])))===0||(o=Math.min(o,wg(n,l,i)))===0)return o}return o}function Nv(n,e,i,o){if(!Us(e,n.length))return NaN;for(let d=e[0];d<=e[1];++d)if(wc(n[d],i,!0))return 0;let l=1/0;for(let d=e[0];d<e[1];++d)for(const f of i)for(let _=0,v=f.length,b=v-1;_<v;b=_++){if(Fu(n[d],n[d+1],f[b],f[_]))return 0;l=Math.min(l,il(n[d],n[d+1],f[b],f[_],o))}return l}function Mp(n,e){for(const i of n)for(let o=0;o<=i.length-1;++o)if(wc(i[o],e,!0))return!0;return!1}function jv(n,e,i,o=1/0){const l=Nl(n),d=Nl(e);if(o!==1/0&&tl(l,d,i)>=o)return o;if(Du(l,d)){if(Mp(n,e))return 0}else if(Mp(e,n))return 0;let f=o;for(const _ of n)for(let v=0,b=_.length,E=b-1;v<b;E=v++)for(const I of e)for(let C=0,R=I.length,k=R-1;C<R;k=C++){if(Fu(_[E],_[v],I[k],I[C]))return 0;f=Math.min(f,il(_[E],_[v],I[k],I[C],i))}return f}function bn(n,e,i,o,l,d,f){if(d===null||f===null)return;const _=tl(Bl(o,d),Bl(l,f),i);_<e&&n.push({dist:_,range1:d,range2:f})}function Uv(n,e,i,o,l=1/0){let d=Math.min(o.distance(n[0],i[0][0]),l);if(d===0)return d;const f=new rd([{dist:0,range1:[0,n.length-1],range2:[0,0]}],Ip),_=e?sd:od,v=Nl(i);for(;f.length;){const b=f.pop();if(b.dist>=d)continue;const E=b.range1;if(Nu(E)<=_){if(!Us(E,n.length))return NaN;if(e){const I=Nv(n,E,i,o);if((d=Math.min(d,I))===0)return d}else for(let I=E[0];I<=E[1];++I){const C=Bv(n[I],i,o);if((d=Math.min(d,C))===0)return d}}else{const I=Cp(E,e);if(I[0]!==null){const C=tl(Bl(n,I[0]),v,o);C<d&&f.push({dist:C,range1:I[0],range2:[0,0]})}if(I[1]!==null){const C=tl(Bl(n,I[1]),v,o);C<d&&f.push({dist:C,range1:I[1],range2:[0,0]})}}}return d}function bg(n,e,i,o,l,d=1/0){let f=Math.min(d,l.distance(n[0],i[0]));if(f===0)return f;const _=new rd([{dist:0,range1:[0,n.length-1],range2:[0,i.length-1]}],Ip),v=e?sd:od,b=o?sd:od;for(;_.length;){const E=_.pop();if(E.dist>=f)continue;const I=E.range1,C=E.range2;if(Nu(I)<=v&&Nu(C)<=b){if(!Us(I,n.length)||!Us(C,i.length))return NaN;if(e&&o?f=Math.min(f,Ai(n,I,i,C,l)):e||o?e&&!o?f=Math.min(f,Pp(i,C,n,I,l)):!e&&o&&(f=Math.min(f,Pp(n,I,i,C,l))):f=Math.min(f,Fv(n,I,i,C,l)),f===0)return f}else{const R=Cp(I,e),k=Cp(C,o);bn(_,f,l,n,i,R[0],k[0]),bn(_,f,l,n,i,R[0],k[1]),bn(_,f,l,n,i,R[1],k[0]),bn(_,f,l,n,i,R[1],k[1])}}return f}function Rp(n,e,i,o,l=1/0){let d=l;const f=Bl(n,[0,n.length-1]);for(const _ of i)if(!(d!==1/0&&tl(f,Bl(_,[0,_.length-1]),o)>=d)&&(d=Math.min(d,bg(n,e,_,!0,o,d)),d===0))return d;return d}function cd(n,e,i,o,l=1/0){let d=l;const f=Bl(n,[0,n.length-1]);for(const _ of i){if(d!==1/0&&tl(f,Nl(_),o)>=d)continue;const v=Uv(n,e,_,o,d);if(isNaN(v))return v;if((d=Math.min(d,v))===0)return d}return d}function kp(n){return n==="Point"||n==="MultiPoint"||n==="LineString"||n==="MultiLineString"||n==="Polygon"||n==="MultiPolygon"}class jl{constructor(e,i){this.type=Bt,this.geojson=e,this.geometries=i}static parse(e,i){if(e.length!==2)return i.error(`'distance' expression requires either one argument, but found ' ${e.length-1} instead.`);if(vc(e[1])){const o=e[1];if(o.type==="FeatureCollection"){for(let l=0;l<o.features.length;++l)if(kp(o.features[l].geometry.type))return new jl(o,o.features[l].geometry)}else if(o.type==="Feature"){if(kp(o.geometry.type))return new jl(o,o.geometry)}else if(kp(o.type))return new jl(o,o)}return i.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(e){const i=e.geometry(),o=e.canonicalID();if(i!=null&&o!=null){if(e.geometryType()==="Point")return function(l,d,f){const _=[];for(const b of l)for(const E of b)_.push(ld(E,d));const v=new Tc(_[0][1],"meters");return f.type==="Point"||f.type==="MultiPoint"||f.type==="LineString"?bg(_,!1,f.type==="Point"?[f.coordinates]:f.coordinates,f.type==="LineString",v):f.type==="MultiLineString"?Rp(_,!1,f.coordinates,v):f.type==="Polygon"||f.type==="MultiPolygon"?cd(_,!1,f.type==="Polygon"?[f.coordinates]:f.coordinates,v):null}(i,o,this.geometries);if(e.geometryType()==="LineString")return function(l,d,f){const _=[];for(const b of l){const E=[];for(const I of b)E.push(ld(I,d));_.push(E)}const v=new Tc(_[0][0][1],"meters");if(f.type==="Point"||f.type==="MultiPoint"||f.type==="LineString")return Rp(f.type==="Point"?[f.coordinates]:f.coordinates,f.type==="LineString",_,v);if(f.type==="MultiLineString"){let b=1/0;for(let E=0;E<f.coordinates.length;E++){const I=Rp(f.coordinates[E],!0,_,v,b);if(isNaN(I))return I;if((b=Math.min(b,I))===0)return b}return b}if(f.type==="Polygon"||f.type==="MultiPolygon"){let b=1/0;for(let E=0;E<_.length;E++){const I=cd(_[E],!0,f.type==="Polygon"?[f.coordinates]:f.coordinates,v,b);if(isNaN(I))return I;if((b=Math.min(b,I))===0)return b}return b}return null}(i,o,this.geometries);if(e.geometryType()==="Polygon")return function(l,d,f){const _=[];for(const b of function(E,I){const C=E.length;if(C<=1)return[E];const R=[];let k,F;for(let U=0;U<C;U++){const j=Ya(E[U]);j!==0&&(E[U].area=Math.abs(j),F===void 0&&(F=j<0),F===j<0?(k&&R.push(k),k=[E[U]]):k.push(E[U]))}return k&&R.push(k),R}(l)){const E=[];for(let I=0;I<b.length;++I)E.push(Ov(b[I],d));_.push(E)}const v=new Tc(_[0][0][0][1],"meters");if(f.type==="Point"||f.type==="MultiPoint"||f.type==="LineString")return cd(f.type==="Point"?[f.coordinates]:f.coordinates,f.type==="LineString",_,v);if(f.type==="MultiLineString"){let b=1/0;for(let E=0;E<f.coordinates.length;E++){const I=cd(f.coordinates[E],!0,_,v,b);if(isNaN(I))return I;if((b=Math.min(b,I))===0)return b}return b}return f.type==="Polygon"||f.type==="MultiPolygon"?function(b,E,I){let C=1/0;for(const R of b)for(const k of E){const F=jv(R,k,I,C);if(isNaN(F))return F;if((C=Math.min(C,F))===0)return C}return C}(f.type==="Polygon"?[f.coordinates]:f.coordinates,_,v):null}(i,o,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function Sc(n){if(n instanceof so&&(n.name==="get"&&n.args.length===1||n.name==="feature-state"||n.name==="has"&&n.args.length===1||n.name==="properties"||n.name==="geometry-type"||n.name==="id"||/^filter-/.test(n.name))||n instanceof el||n instanceof jl)return!1;if(n instanceof Ic)return n.featureConstant;let e=!0;return n.eachChild(i=>{e&&!Sc(i)&&(e=!1)}),e}function ju(n){if(n instanceof so&&n.name==="feature-state")return!1;let e=!0;return n.eachChild(i=>{e&&!ju(i)&&(e=!1)}),e}function Ec(n,e){if(n instanceof so&&e.indexOf(n.name)>=0)return!1;let i=!0;return n.eachChild(o=>{i&&!Ec(o,e)&&(i=!1)}),i}function Tg(n,e,i){return[n,e,i].filter(Boolean).join("")}function Lp(n,e){switch(n){case"string":return Yo(e);case"number":return+e;case"boolean":return!!e;case"color":return Zi.parse(e);case"formatted":return ro.fromString(Yo(e));case"resolvedImage":return oo.build(Yo(e))}return e}function Sg(n,e,i,o){return o!==void 0&&(n=o*Math.round(n/o)),e!==void 0&&n<e&&(n=e),i!==void 0&&n>i&&(n=i),n}class Ic{constructor(e,i,o,l=!1){this.type=e,this.key=i,this.scope=o,this.featureConstant=l}static parse(e,i){let o=i.expectedType;if(o==null&&(o=Wi),e.length<2||e.length>3)return i.error("Invalid number of arguments for 'config' expression.");const l=i.parse(e[1],1);if(!(l instanceof ca))return i.error("Key name of 'config' expression must be a string literal.");let d,f=!0;const _=Yo(l.value);if(e.length>=3){const v=i.parse(e[2],2);if(!(v instanceof ca))return i.error("Scope of 'config' expression must be a string literal.");d=Yo(v.value)}if(i.options){const v=Tg(_,d,i._scope),b=i.options.get(v);b&&(f=Sc(b.value||b.default))}return new Ic(o,_,d,f)}evaluate(e){const i=Tg(this.key,this.scope,e.scope),o=e.getConfig(i);if(!o)return null;const{type:l,value:d,values:f,minValue:_,maxValue:v,stepValue:b}=o,E=o.default.evaluate(e);let I=E;if(d){const C=e.scope;e.scope=(C||"").split("").slice(1).join(""),I=d.evaluate(e),e.scope=C}return l&&(I=Lp(l,I)),I===void 0||_===void 0&&v===void 0&&b===void 0||(typeof I=="number"?I=Sg(I,_,v,b):Array.isArray(I)&&(I=I.map(C=>typeof C=="number"?Sg(C,_,v,b):C))),d!==void 0&&I!==void 0&&f&&!f.includes(I)&&(I=E,l&&(I=Lp(l,I))),(l&&l!==this.type||I!==void 0&&!Xh(wr(I),this.type))&&(I=Lp(this.type.kind,I)),I}eachChild(){}outputDefined(){return!1}serialize(){const e=["config",this.key];return this.scope&&e.concat(this.scope),e}}class ud{constructor(e,i){this.type=i.type,this.name=e,this.boundExpression=i}static parse(e,i){if(e.length!==2||typeof e[1]!="string")return i.error("'var' expression requires exactly one string literal argument.");const o=e[1];return i.scope.has(o)?new ud(o,i.scope.get(o)):i.error(`Unknown variable "${o}". Make sure "${o}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class hd{constructor(e,i=[],o,l=new yc,d=[],f,_,v){this.registry=e,this.path=i,this.key=i.map(b=>typeof b=="string"?`['${b}']`:`[${b}]`).join(""),this.scope=l,this.errors=d,this.expectedType=o,this._scope=f,this.options=_,this.iconImageUseTheme=v}parse(e,i,o,l,d={}){return i||o?this.concat(i,null,o,l)._parse(e,d):this._parse(e,d)}parseObjectValue(e,i,o,l,d,f={}){return this.concat(i,o,l,d)._parse(e,f)}_parse(e,i){function o(l,d,f){return f==="assert"?new gs(d,[l]):f==="coerce"?new js(d,[l]):l}if(e!==null&&typeof e!="string"&&typeof e!="boolean"&&typeof e!="number"||(e=["literal",e]),Array.isArray(e)){if(e.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const l=typeof e[0]=="string"?this.registry[e[0]]:void 0;if(l){let d=l.parse(e,this);if(!d)return null;if(this.expectedType){const f=this.expectedType,_=d.type;if(f.kind!=="string"&&f.kind!=="number"&&f.kind!=="boolean"&&f.kind!=="object"&&f.kind!=="array"||_.kind!=="value")if(f.kind!=="color"&&f.kind!=="formatted"&&f.kind!=="resolvedImage"||_.kind!=="value"&&_.kind!=="string"){if(this.checkSubtype(f,_))return null}else d=o(d,f,i.typeAnnotation||"coerce");else d=o(d,f,i.typeAnnotation||"assert")}if(!(d instanceof ca)&&d.type.kind!=="resolvedImage"&&zp(d)){const f=new Qh(this._scope,this.options,this.iconImageUseTheme);try{d=new ca(d.type,d.evaluate(f))}catch(_){return this.error(_.message),null}}return d}return js.parse(["to-array",e],this)}return this.error(e===void 0?"'undefined' value invalid. Use null instead.":typeof e=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof e} instead.`)}concat(e,i,o,l){let d=typeof e=="number"?this.path.concat(e):this.path;d=typeof i=="string"?d.concat(i):d;const f=l?this.scope.concat(l):this.scope;return new hd(this.registry,d,o||null,f,this.errors,this._scope,this.options,this.iconImageUseTheme)}error(e,...i){const o=`${this.key}${i.map(l=>`[${l}]`).join("")}`;this.errors.push(new Ko(o,e))}checkSubtype(e,i){const o=Ka(e,i);return o&&this.error(o),o}}function zp(n){if(n instanceof ud)return zp(n.boundExpression);if(n instanceof so&&n.name==="error"||n instanceof Cr||n instanceof el||n instanceof jl||n instanceof Ic)return!1;const e=n instanceof js||n instanceof gs;let i=!0;return n.eachChild(o=>{i=e?i&&zp(o):i&&o instanceof ca}),!!i&&Sc(n)&&Ec(n,["zoom","heatmap-density","worldview","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function dd(n,e){const i=n.length-1;let o,l,d=0,f=i,_=0;for(;d<=f;)if(_=Math.floor((d+f)/2),o=n[_],l=n[_+1],o<=e){if(_===i||e<l)return _;d=_+1}else{if(!(o>e))throw new mr("Input is not a number.");f=_-1}return 0}class Uu{constructor(e,i,o){this.type=e,this.input=i,this.labels=[],this.outputs=[];for(const[l,d]of o)this.labels.push(l),this.outputs.push(d)}static parse(e,i){if(e.length-1<4)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return i.error("Expected an even number of arguments.");const o=i.parse(e[1],1,Bt);if(!o)return null;const l=[];let d=null;i.expectedType&&i.expectedType.kind!=="value"&&(d=i.expectedType);for(let f=1;f<e.length;f+=2){const _=f===1?-1/0:e[f],v=e[f+1],b=f,E=f+1;if(typeof _!="number")return i.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',b);if(l.length&&l[l.length-1][0]>=_)return i.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',b);const I=i.parse(v,E,d);if(!I)return null;d=d||I.type,l.push([_,I])}return new Uu(d,o,l)}evaluate(e){const i=this.labels,o=this.outputs;if(i.length===1)return o[0].evaluate(e);const l=this.input.evaluate(e);if(l<=i[0])return o[0].evaluate(e);const d=i.length;return l>=i[d-1]?o[d-1].evaluate(e):o[dd(i,l)].evaluate(e)}eachChild(e){e(this.input);for(const i of this.outputs)e(i)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){const e=["step",this.input.serialize()];for(let i=0;i<this.labels.length;i++)i>0&&e.push(this.labels[i]),e.push(this.outputs[i].serialize());return e}}const Eg=.95047,Ig=1.08883,Ag=4/29,Ac=6/29,Cg=3*Ac*Ac,Vv=Ac*Ac*Ac,$v=Math.PI/180,Gv=180/Math.PI;function Dp(n){return n>Vv?Math.pow(n,1/3):n/Cg+Ag}function Op(n){return n>Ac?n*n*n:Cg*(n-Ag)}function Fp(n){return 255*(n<=.0031308?12.92*n:1.055*Math.pow(n,1/2.4)-.055)}function Bp(n){return(n/=255)<=.04045?n/12.92:Math.pow((n+.055)/1.055,2.4)}function Pg(n){const e=Bp(n.r),i=Bp(n.g),o=Bp(n.b),l=Dp((.4124564*e+.3575761*i+.1804375*o)/Eg),d=Dp((.2126729*e+.7151522*i+.072175*o)/1);return{l:116*d-16,a:500*(l-d),b:200*(d-Dp((.0193339*e+.119192*i+.9503041*o)/Ig)),alpha:n.a}}function fd(n){let e=(n.l+16)/116,i=isNaN(n.a)?e:e+n.a/500,o=isNaN(n.b)?e:e-n.b/200;return e=1*Op(e),i=Eg*Op(i),o=Ig*Op(o),new Zi(Fp(3.2404542*i-1.5371385*e-.4985314*o),Fp(-.969266*i+1.8760108*e+.041556*o),Fp(.0556434*i-.2040259*e+1.0572252*o),n.alpha)}function pd(n,e,i){const o=e-n;return n+i*(o>180||o<-180?o-360*Math.round(o/360):o)}const Cc={forward:Pg,reverse:fd,interpolate:function(n,e,i){return{l:Kt(n.l,e.l,i),a:Kt(n.a,e.a,i),b:Kt(n.b,e.b,i),alpha:Kt(n.alpha,e.alpha,i)}}},Vu={forward:function(n){const{l:e,a:i,b:o}=Pg(n),l=Math.atan2(o,i)*Gv;return{h:l<0?l+360:l,c:Math.sqrt(i*i+o*o),l:e,alpha:n.a}},reverse:function(n){const e=n.h*$v,i=n.c;return fd({l:n.l,a:Math.cos(e)*i,b:Math.sin(e)*i,alpha:n.alpha})},interpolate:function(n,e,i){return{h:pd(n.h,e.h,i),c:Kt(n.c,e.c,i),l:Kt(n.l,e.l,i),alpha:Kt(n.alpha,e.alpha,i)}}};var Mg=Object.freeze({__proto__:null,hcl:Vu,lab:Cc});class Oo{constructor(e,i,o,l,d){this.type=e,this.operator=i,this.interpolation=o,this.input=l,this.labels=[],this.outputs=[];for(const[f,_]of d)this.labels.push(f),this.outputs.push(_)}static interpolationFactor(e,i,o,l){let d=0;if(e.name==="exponential")d=md(i,e.base,o,l);else if(e.name==="linear")d=md(i,1,o,l);else if(e.name==="cubic-bezier"){const f=e.controlPoints;d=new Bh(f[0],f[1],f[2],f[3]).solve(md(i,1,o,l))}return d}static parse(e,i){let[o,l,d,...f]=e;if(!Array.isArray(l)||l.length===0)return i.error("Expected an interpolation type expression.",1);if(l[0]==="linear")l={name:"linear"};else if(l[0]==="exponential"){const b=l[1];if(typeof b!="number")return i.error("Exponential interpolation requires a numeric base.",1,1);l={name:"exponential",base:b}}else{if(l[0]!=="cubic-bezier")return i.error(`Unknown interpolation type ${String(l[0])}`,1,0);{const b=l.slice(1);if(b.length!==4||b.some(E=>typeof E!="number"||E<0||E>1))return i.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);l={name:"cubic-bezier",controlPoints:b}}}if(e.length-1<4)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length-1>3&&(e.length-1)%2!=0)return i.error("Expected an even number of arguments.");if(d=i.parse(d,2,Bt),!d)return null;const _=[];let v=null;o==="interpolate-hcl"||o==="interpolate-lab"?v=go:i.expectedType&&i.expectedType.kind!=="value"&&(v=i.expectedType);for(let b=0;b<f.length;b+=2){const E=f[b],I=f[b+1],C=b+3,R=b+4;if(typeof E!="number")return i.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',C);if(_.length&&_[_.length-1][0]>=E)return i.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',C);const k=i.parse(I,R,v);if(!k)return null;v=v||k.type,_.push([E,k])}return v.kind==="number"||v.kind==="color"||v.kind==="array"&&v.itemType.kind==="number"&&typeof v.N=="number"?new Oo(v,o,l,d,_):i.error(`Type ${tr(v)} is not interpolatable.`)}evaluate(e){const i=this.labels,o=this.outputs;if(i.length===1)return o[0].evaluate(e);const l=this.input.evaluate(e);if(l<=i[0])return o[0].evaluate(e);const d=i.length;if(l>=i[d-1])return o[d-1].evaluate(e);const f=dd(i,l),_=Oo.interpolationFactor(this.interpolation,l,i[f],i[f+1]),v=o[f].evaluate(e),b=o[f+1].evaluate(e);return this.operator==="interpolate"?Ru[this.type.kind.toLowerCase()](v,b,_):this.operator==="interpolate-hcl"?Vu.reverse(Vu.interpolate(Vu.forward(v),Vu.forward(b),_)):Cc.reverse(Cc.interpolate(Cc.forward(v),Cc.forward(b),_))}eachChild(e){e(this.input);for(const i of this.outputs)e(i)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){let e;e=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier",...this.interpolation.controlPoints];const i=[this.operator,e,this.input.serialize()];for(let o=0;o<this.labels.length;o++)i.push(this.labels[o],this.outputs[o].serialize());return i}}function md(n,e,i,o){const l=o-i,d=n-i;return l===0?0:e===1?d/l:(Math.pow(e,d)-1)/(Math.pow(e,l)-1)}class $u{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expectected at least one argument.");let o=null;const l=i.expectedType;l&&l.kind!=="value"&&(o=l);const d=[];for(const _ of e.slice(1)){const v=i.parse(_,1+d.length,o,void 0,{typeAnnotation:"omit"});if(!v)return null;o=o||v.type,d.push(v)}const f=l&&d.some(_=>Ka(l,_.type));return new $u(f?Wi:o,d)}evaluate(e){let i,o=null,l=0;for(const d of this.args){if(l++,o=d.evaluate(e),o&&o instanceof oo&&!o.available&&(i||(i=o),o=null,l===this.args.length))return i;if(o!==null)break}return o}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){const e=["coalesce"];return this.eachChild(i=>{e.push(i.serialize())}),e}}class ha{constructor(e,i){this.type=i.type,this.bindings=[].concat(e),this.result=i}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(const i of this.bindings)e(i[1]);e(this.result)}static parse(e,i){if(e.length<4)return i.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);const o=[];for(let d=1;d<e.length-1;d+=2){const f=e[d];if(typeof f!="string")return i.error(`Expected string, but found ${typeof f} instead.`,d);if(/[^a-zA-Z0-9_]/.test(f))return i.error("Variable names must contain only alphanumeric characters or '_'.",d);const _=i.parse(e[d+1],d+1);if(!_)return null;o.push([f,_])}const l=i.parse(e[e.length-1],e.length-1,i.expectedType,o);return l?new ha(o,l):null}outputDefined(){return this.result.outputDefined()}serialize(){const e=["let"];for(const[i,o]of this.bindings)e.push(i,o.serialize());return e.push(this.result.serialize()),e}}class _d{constructor(e,i,o){this.type=e,this.index=i,this.input=o}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const o=i.parse(e[1],1,Bt),l=i.parse(e[2],2,$r(i.expectedType||Wi));return o&&l?new _d(l.type.itemType,o,l):null}evaluate(e){const i=this.index.evaluate(e),o=this.input.evaluate(e);if(i<0)throw new mr("Array index out of bounds: negative index");if(i>=o.length)throw new mr("Array index out of bounds: index exceeds array size");if(i!==Math.floor(i))throw new mr("Array index must be an integer. Use at-interpolated for fractional indices");return o[i]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class gd{constructor(e,i,o){this.type=e,this.index=i,this.input=o}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const o=i.parse(e[1],1,Bt),l=i.parse(e[2],2,$r(i.expectedType||Wi));return o&&l?new gd(l.type.itemType,o,l):null}evaluate(e){const i=this.index.evaluate(e),o=this.input.evaluate(e);if(i<0)throw new mr(`Array index out of bounds: ${i} < 0.`);if(i>o.length-1)throw new mr(`Array index out of bounds: ${i} > ${o.length-1}.`);if(i===Math.floor(i))return o[i];const l=Math.floor(i),d=Math.ceil(i),f=o[l],_=o[d];if(typeof f!="number"||typeof _!="number")throw new mr(`Cannot interpolate between non-number values at index ${i}.`);const v=i-l;return f*(1-v)+_*v}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at-interpolated",this.index.serialize(),this.input.serialize()]}}class Np{constructor(e,i){this.type=Ji,this.needle=e,this.haystack=i}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const o=i.parse(e[1],1,Wi),l=i.parse(e[2],2,Wi);return o&&l?yp(o.type,[Ji,Ei,Bt,_s,Wi])?new Np(o,l):i.error(`Expected first argument to be of type boolean, string, number or null, but found ${tr(o.type)} instead`):null}evaluate(e){const i=this.needle.evaluate(e),o=this.haystack.evaluate(e);if(o==null)return!1;if(!zu(i,["boolean","string","number","null"]))throw new mr(`Expected first argument to be of type boolean, string, number or null, but found ${tr(wr(i))} instead.`);if(!zu(o,["string","array"]))throw new mr(`Expected second argument to be of type array or string, but found ${tr(wr(o))} instead.`);return o.indexOf(i)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class Pc{constructor(e,i,o){this.type=Bt,this.needle=e,this.haystack=i,this.fromIndex=o}static parse(e,i){if(e.length<=2||e.length>=5)return i.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const o=i.parse(e[1],1,Wi),l=i.parse(e[2],2,Wi);if(!o||!l)return null;if(!yp(o.type,[Ji,Ei,Bt,_s,Wi]))return i.error(`Expected first argument to be of type boolean, string, number or null, but found ${tr(o.type)} instead`);if(e.length===4){const d=i.parse(e[3],3,Bt);return d?new Pc(o,l,d):null}return new Pc(o,l)}evaluate(e){const i=this.needle.evaluate(e),o=this.haystack.evaluate(e);if(!zu(i,["boolean","string","number","null"]))throw new mr(`Expected first argument to be of type boolean, string, number or null, but found ${tr(wr(i))} instead.`);if(!zu(o,["string","array"]))throw new mr(`Expected second argument to be of type array or string, but found ${tr(wr(o))} instead.`);if(this.fromIndex){const l=this.fromIndex.evaluate(e);return o.indexOf(i,l)}return o.indexOf(i)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){const e=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),e]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class Gu{constructor(e,i,o,l,d,f){this.inputType=e,this.type=i,this.input=o,this.cases=l,this.outputs=d,this.otherwise=f}static parse(e,i){if(e.length<5)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return i.error("Expected an even number of arguments.");let o,l;i.expectedType&&i.expectedType.kind!=="value"&&(l=i.expectedType);const d={},f=[];for(let b=2;b<e.length-1;b+=2){let E=e[b];const I=e[b+1];Array.isArray(E)||(E=[E]);const C=i.concat(b);if(E.length===0)return C.error("Expected at least one branch label.");for(const k of E){if(typeof k!="number"&&typeof k!="string")return C.error("Branch labels must be numbers or strings.");if(typeof k=="number"&&Math.abs(k)>Number.MAX_SAFE_INTEGER)return C.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof k=="number"&&Math.floor(k)!==k)return C.error("Numeric branch labels must be integer values.");if(o){if(C.checkSubtype(o,wr(k)))return null}else o=wr(k);if(d[String(k)]!==void 0)return C.error("Branch labels must be unique.");d[String(k)]=f.length}const R=i.parse(I,b,l);if(!R)return null;l=l||R.type,f.push(R)}const _=i.parse(e[1],1,Wi);if(!_)return null;const v=i.parse(e[e.length-1],e.length-1,l);return v?_.type.kind!=="value"&&i.concat(1).checkSubtype(o,_.type)?null:new Gu(o,l,_,d,f,v):null}evaluate(e){const i=this.input.evaluate(e);return(Xh(wr(i),this.inputType)&&this.outputs[this.cases[i]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every(e=>e.outputDefined())&&this.otherwise.outputDefined()}serialize(){const e=["match",this.input.serialize()],i=Object.keys(this.cases).sort(),o=[],l={};for(const f of i){const _=l[this.cases[f]];_===void 0?(l[this.cases[f]]=o.length,o.push([this.cases[f],[f]])):o[_][1].push(f)}const d=f=>this.inputType.kind==="number"?Number(f):f;for(const[f,_]of o)e.push(_.length===1?d(_[0]):_.map(d)),e.push(this.outputs[f].serialize());return e.push(this.otherwise.serialize()),e}}class Hu{constructor(e,i,o){this.type=e,this.branches=i,this.otherwise=o}static parse(e,i){if(e.length<4)return i.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return i.error("Expected an odd number of arguments.");let o;i.expectedType&&i.expectedType.kind!=="value"&&(o=i.expectedType);const l=[];for(let f=1;f<e.length-1;f+=2){const _=i.parse(e[f],f,Ji);if(!_)return null;const v=i.parse(e[f+1],f+1,o);if(!v)return null;l.push([_,v]),o=o||v.type}const d=i.parse(e[e.length-1],e.length-1,o);return d?new Hu(o,l,d):null}evaluate(e){for(const[i,o]of this.branches)if(i.evaluate(e))return o.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(const[i,o]of this.branches)e(i),e(o);e(this.otherwise)}outputDefined(){return this.branches.every(([e,i])=>i.outputDefined())&&this.otherwise.outputDefined()}serialize(){const e=["case"];return this.eachChild(i=>{e.push(i.serialize())}),e}}class yd{constructor(e,i,o,l){this.type=e,this.input=i,this.beginIndex=o,this.endIndex=l}static parse(e,i){if(e.length<=2||e.length>=5)return i.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const o=i.parse(e[1],1,Wi),l=i.parse(e[2],2,Bt);if(!o||!l)return null;if(!yp(o.type,[$r(Wi),Ei,Wi]))return i.error(`Expected first argument to be of type array or string, but found ${tr(o.type)} instead`);if(e.length===4){const d=i.parse(e[3],3,Bt);return d?new yd(o.type,o,l,d):null}return new yd(o.type,o,l)}evaluate(e){const i=this.input.evaluate(e),o=this.beginIndex.evaluate(e);if(!zu(i,["string","array"]))throw new mr(`Expected first argument to be of type array or string, but found ${tr(wr(i))} instead.`);if(this.endIndex){const l=this.endIndex.evaluate(e);return i.slice(o,l)}return i.slice(o)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){const e=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),e]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}class jp{constructor(e,i){this.type=$r(Ei),this.str=e,this.delimiter=i}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const o=i.parse(e[1],1,Ei),l=i.parse(e[2],2,Ei);return o&&l?new jp(o,l):void 0}evaluate(e){const i=this.str.evaluate(e),o=this.delimiter.evaluate(e);return i.split(o)}eachChild(e){e(this.str),e(this.delimiter)}outputDefined(){return!1}serialize(){return["split",this.str.serialize(),this.delimiter.serialize()]}}function Up(n,e){return n==="=="||n==="!="?e.kind==="boolean"||e.kind==="string"||e.kind==="number"||e.kind==="null"||e.kind==="value":e.kind==="string"||e.kind==="number"||e.kind==="value"}function Vp(n,e,i,o){return o.compare(e,i)===0}function Mc(n,e,i){const o=n!=="=="&&n!=="!=";return class bM{constructor(d,f,_){this.type=Ji,this.lhs=d,this.rhs=f,this.collator=_,this.hasUntypedArgument=d.type.kind==="value"||f.type.kind==="value"}static parse(d,f){if(d.length!==3&&d.length!==4)return f.error("Expected two or three arguments.");const _=d[0];let v=f.parse(d[1],1,Wi);if(!v)return null;if(!Up(_,v.type))return f.concat(1).error(`"${_}" comparisons are not supported for type '${tr(v.type)}'.`);let b=f.parse(d[2],2,Wi);if(!b)return null;if(!Up(_,b.type))return f.concat(2).error(`"${_}" comparisons are not supported for type '${tr(b.type)}'.`);if(v.type.kind!==b.type.kind&&v.type.kind!=="value"&&b.type.kind!=="value")return f.error(`Cannot compare types '${tr(v.type)}' and '${tr(b.type)}'.`);o&&(v.type.kind==="value"&&b.type.kind!=="value"?v=new gs(b.type,[v]):v.type.kind!=="value"&&b.type.kind==="value"&&(b=new gs(v.type,[b])));let E=null;if(d.length===4){if(v.type.kind!=="string"&&b.type.kind!=="string"&&v.type.kind!=="value"&&b.type.kind!=="value")return f.error("Cannot use collator to compare non-string types.");if(E=f.parse(d[3],3,Zh),!E)return null}return new bM(v,b,E)}evaluate(d){const f=this.lhs.evaluate(d),_=this.rhs.evaluate(d);if(o&&this.hasUntypedArgument){const v=wr(f),b=wr(_);if(v.kind!==b.kind||v.kind!=="string"&&v.kind!=="number")throw new mr(`Expected arguments for "${n}" to be (string, string) or (number, number), but found (${v.kind}, ${b.kind}) instead.`)}if(this.collator&&!o&&this.hasUntypedArgument){const v=wr(f),b=wr(_);if(v.kind!=="string"||b.kind!=="string")return e(d,f,_)}return this.collator?i(d,f,_,this.collator.evaluate(d)):e(d,f,_)}eachChild(d){d(this.lhs),d(this.rhs),this.collator&&d(this.collator)}outputDefined(){return!0}serialize(){const d=[n];return this.eachChild(f=>{d.push(f.serialize())}),d}}}const Hv=Mc("==",function(n,e,i){return e===i},Vp),qv=Mc("!=",function(n,e,i){return e!==i},function(n,e,i,o){return!Vp(0,e,i,o)}),Rg=Mc("<",function(n,e,i){return e<i},function(n,e,i,o){return o.compare(e,i)<0}),kg=Mc(">",function(n,e,i){return e>i},function(n,e,i,o){return o.compare(e,i)>0}),vd=Mc("<=",function(n,e,i){return e<=i},function(n,e,i,o){return o.compare(e,i)<=0}),Wv=Mc(">=",function(n,e,i){return e>=i},function(n,e,i,o){return o.compare(e,i)>=0});class xd{constructor(e,i,o,l,d,f){this.type=Ei,this.number=e,this.locale=i,this.currency=o,this.unit=l,this.minFractionDigits=d,this.maxFractionDigits=f}static parse(e,i){if(e.length!==3)return i.error("Expected two arguments.");const o=i.parse(e[1],1,Bt);if(!o)return null;const l=e[2];if(typeof l!="object"||Array.isArray(l))return i.error("NumberFormat options argument must be an object.");let d=null;if(l.locale&&(d=i.parseObjectValue(l.locale,2,"locale",Ei),!d))return null;let f=null;if(l.currency&&(f=i.parseObjectValue(l.currency,2,"currency",Ei),!f))return null;let _=null;if(l.unit&&(_=i.parseObjectValue(l.unit,2,"unit",Ei),!_))return null;let v=null;if(l["min-fraction-digits"]&&(v=i.parseObjectValue(l["min-fraction-digits"],2,"min-fraction-digits",Bt),!v))return null;let b=null;return l["max-fraction-digits"]&&(b=i.parseObjectValue(l["max-fraction-digits"],2,"max-fraction-digits",Bt),!b)?null:new xd(o,d,f,_,v,b)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(e):void 0,unit:this.unit?this.unit.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.unit&&e(this.unit),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const e={};return this.locale&&(e.locale=this.locale.serialize()),this.currency&&(e.currency=this.currency.serialize()),this.unit&&(e.unit=this.unit.serialize()),this.minFractionDigits&&(e["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(e["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),e]}}class $p{constructor(e){this.type=Bt,this.input=e}static parse(e,i){if(e.length!==2)return i.error(`Expected 1 argument, but found ${e.length-1} instead.`);const o=i.parse(e[1],1);return o?o.type.kind!=="array"&&o.type.kind!=="string"&&o.type.kind!=="value"?i.error(`Expected argument of type string or array, but found ${tr(o.type)} instead.`):new $p(o):null}evaluate(e){const i=this.input.evaluate(e);if(typeof i=="string"||Array.isArray(i))return i.length;throw new mr(`Expected value to be of type string or array, but found ${tr(wr(i))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}serialize(){const e=["length"];return this.eachChild(i=>{e.push(i.serialize())}),e}}function Lg(n){return function(){n=1831565813+(n|=0)|0;let e=Math.imul(n^n>>>15,1|n);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}}const Rc={"==":Hv,"!=":qv,">":kg,"<":Rg,">=":Wv,"<=":vd,array:gs,at:_d,"at-interpolated":gd,boolean:gs,case:Hu,coalesce:$u,collator:Cr,format:Ns,image:ai,in:Np,"index-of":Pc,interpolate:Oo,"interpolate-hcl":Oo,"interpolate-lab":Oo,length:$p,let:ha,literal:ca,match:Gu,number:gs,"number-format":xd,object:gs,slice:yd,step:Uu,string:gs,"to-boolean":js,"to-color":js,"to-number":js,"to-string":js,var:ud,within:el,distance:jl,config:Ic,split:jp};function Gp(n,[e,i,o,l]){e=e.evaluate(n),i=i.evaluate(n),o=o.evaluate(n);const d=l?l.evaluate(n):1,f=Fl(e,i,o,d);if(f)throw new mr(f);return new Zi(e/255,i/255,o/255,d)}function Hp(n,[e,i,o,l]){e=e.evaluate(n),i=i.evaluate(n),o=o.evaluate(n);const d=l?l.evaluate(n):1,f=function(b,E,I,C){return typeof b=="number"&&b>=0&&b<=360?typeof E=="number"&&E>=0&&E<=100&&typeof I=="number"&&I>=0&&I<=100?C===void 0||typeof C=="number"&&C>=0&&C<=1?null:`Invalid hsla value [${[b,E,I,C].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${(typeof C=="number"?[b,E,I,C]:[b,E,I]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${(typeof C=="number"?[b,E,I,C]:[b,E,I]).join(", ")}]: 'h' must be between 0 and 360.`}(e,i,o,d);if(f)throw new mr(f);const _=`hsla(${e}, ${i}%, ${o}%, ${d})`,v=Zi.parse(_);if(!v)throw new mr(`Failed to parse HSLA color: ${_}`);return v}function zg(n,e){return n in e}function qp(n,e){const i=e[n];return i===void 0?null:i}function nl(n){return{type:n}}function Ul(n){if(n instanceof Ic)return new Set([n.key]);let e=new Set;return n.eachChild(i=>{e=new Set([...e,...Ul(i)])}),e}function wd(n){if(n instanceof so&&n.name==="is-active-floor")return!0;let e=!1;return n.eachChild(i=>{!e&&wd(i)&&(e=!0)}),e}function Dg(n){return{result:"success",value:n}}function rl(n){return{result:"error",value:n}}function Wp(n,e){return!!n&&!!n.parameters&&n.parameters.indexOf(e)>-1}function qu(n){return n["property-type"]==="data-driven"}function Og(n){return Wp(n.expression,"measure-light")}function Fg(n){return Wp(n.expression,"zoom")}function bd(n){return!!n.expression&&n.expression.interpolated}function Td(n){return typeof n=="object"&&n!==null&&!Array.isArray(n)}function Bg(n){return n}function Ng(n,e){const i=e.type==="color",o=n.stops&&typeof n.stops[0][0]=="object",l=o||!(o||n.property!==void 0),d=n.type||(bd(e)?"exponential":"interval");if(i&&((n=Object.assign({},n)).stops&&(n.stops=n.stops.map(b=>[b[0],Zi.parse(b[1])])),n.default=Zi.parse(n.default?n.default:e.default)),n.colorSpace&&n.colorSpace!=="rgb"&&!Mg[n.colorSpace])throw new Error(`Unknown color space: ${n.colorSpace}`);let f,_,v;if(d==="exponential")f=jg;else if(d==="interval")f=Xv;else if(d==="categorical"){f=Zv,_=Object.create(null);for(const b of n.stops)_[b[0]]=b[1];v=typeof n.stops[0][0]}else{if(d!=="identity")throw new Error(`Unknown function type "${d}"`);f=Ug}if(o){const b={},E=[];for(let R=0;R<n.stops.length;R++){const k=n.stops[R],F=k[0].zoom;b[F]===void 0&&(b[F]={zoom:F,type:n.type,property:n.property,default:n.default,stops:[]},E.push(F)),b[F].stops.push([k[0].value,k[1]])}const I=[];for(const R of E)I.push([b[R].zoom,Ng(b[R],e)]);const C={name:"linear"};return{kind:"composite",interpolationType:C,interpolationFactor:Oo.interpolationFactor.bind(void 0,C),zoomStops:I.map(R=>R[0]),evaluate:({zoom:R},k)=>jg({stops:I,base:n.base},e,R).evaluate(R,k)}}if(l){const b=d==="exponential"?{name:"exponential",base:n.base!==void 0?n.base:1}:null;return{kind:"camera",interpolationType:b,interpolationFactor:Oo.interpolationFactor.bind(void 0,b),zoomStops:n.stops.map(E=>E[0]),evaluate:({zoom:E})=>f(n,e,E,_,v)}}return{kind:"source",evaluate(b,E){const I=E&&E.properties?E.properties[n.property]:void 0;return I===void 0?Vs(n.default,e.default):f(n,e,I,_,v)}}}function Vs(n,e,i){return n!==void 0?n:e!==void 0?e:i!==void 0?i:void 0}function Zv(n,e,i,o,l){return Vs(typeof i===l?o[i]:void 0,n.default,e.default)}function Xv(n,e,i){if(!xc(i))return Vs(n.default,e.default);const o=n.stops.length;if(o===1||i<=n.stops[0][0])return n.stops[0][1];if(i>=n.stops[o-1][0])return n.stops[o-1][1];const l=dd(n.stops.map(d=>d[0]),i);return n.stops[l][1]}function jg(n,e,i){const o=n.base!==void 0?n.base:1;if(!xc(i))return Vs(n.default,e.default);const l=n.stops.length;if(l===1||i<=n.stops[0][0])return n.stops[0][1];if(i>=n.stops[l-1][0])return n.stops[l-1][1];const d=dd(n.stops.map(E=>E[0]),i),f=function(E,I,C,R){const k=R-C,F=E-C;return k===0?0:I===1?F/k:(Math.pow(I,F)-1)/(Math.pow(I,k)-1)}(i,o,n.stops[d][0],n.stops[d+1][0]),_=n.stops[d][1],v=n.stops[d+1][1];let b=Ru[e.type]||Bg;if(n.colorSpace&&n.colorSpace!=="rgb"){const E=Mg[n.colorSpace];b=(I,C)=>E.reverse(E.interpolate(E.forward(I),E.forward(C),f))}return typeof _.evaluate=="function"?{evaluate(...E){const I=_.evaluate.apply(void 0,E),C=v.evaluate.apply(void 0,E);if(I!==void 0&&C!==void 0)return b(I,C,f)}}:b(_,v,f)}function Ug(n,e,i){return e.type==="color"?i=Zi.parse(i):e.type==="formatted"?i=ro.fromString(i.toString()):e.type==="resolvedImage"?i=oo.build(i.toString()):Dt(i)===e.type||e.type==="enum"&&e.values[i]||(i=void 0),Vs(i,n.default,e.default)}so.register(Rc,{error:[{kind:"error"},[Ei],(n,[e])=>{throw new mr(e.evaluate(n))}],typeof:[Ei,[Wi],(n,[e])=>tr(wr(e.evaluate(n)))],"to-rgba":[$r(Bt,4),[go],(n,[e])=>e.evaluate(n).toNonPremultipliedRenderColor(null).toArray()],"to-hsla":[$r(Bt,4),[go],(n,[e])=>e.evaluate(n).toNonPremultipliedRenderColor(null).toHslaArray()],rgb:[go,[Bt,Bt,Bt],Gp],rgba:[go,[Bt,Bt,Bt,Bt],Gp],hsl:[go,[Bt,Bt,Bt],Hp],hsla:[go,[Bt,Bt,Bt,Bt],Hp],has:{type:Ji,overloads:[[[Ei],(n,[e])=>zg(e.evaluate(n),n.properties())],[[Ei,Bs],(n,[e,i])=>zg(e.evaluate(n),i.evaluate(n))]]},get:{type:Wi,overloads:[[[Ei],(n,[e])=>qp(e.evaluate(n),n.properties())],[[Ei,Bs],(n,[e,i])=>qp(e.evaluate(n),i.evaluate(n))]]},"feature-state":[Wi,[Ei],(n,[e])=>qp(e.evaluate(n),n.featureState||{})],properties:[Bs,[],n=>n.properties()],"geometry-type":[Ei,[],n=>n.geometryType()],worldview:[Ei,[],n=>n.globals.worldview||""],"is-active-floor":[Ji,nl(Ei),(n,e)=>{if(!(n.globals.activeFloors&&n.globals.activeFloors.size>0))return!1;const i=n.globals.activeFloors;return e.some(o=>{const l=o.evaluate(n);return i.has(l)})}],id:[Wi,[],n=>n.id()],zoom:[Bt,[],n=>n.globals.zoom],pitch:[Bt,[],n=>n.globals.pitch||0],"distance-from-center":[Bt,[],n=>n.distanceFromCenter()],"measure-light":[Bt,[Ei],(n,[e])=>n.measureLight(e.evaluate(n))],"heatmap-density":[Bt,[],n=>n.globals.heatmapDensity||0],"line-progress":[Bt,[],n=>n.globals.lineProgress||0],"raster-value":[Bt,[],n=>n.globals.rasterValue||0],"raster-particle-speed":[Bt,[],n=>n.globals.rasterParticleSpeed||0],"sky-radial-progress":[Bt,[],n=>n.globals.skyRadialProgress||0],accumulated:[Wi,[],n=>n.globals.accumulated===void 0?null:n.globals.accumulated],"+":[Bt,nl(Bt),(n,e)=>{let i=0;for(const o of e)i+=o.evaluate(n);return i}],"*":[Bt,nl(Bt),(n,e)=>{let i=1;for(const o of e)i*=o.evaluate(n);return i}],"-":{type:Bt,overloads:[[[Bt,Bt],(n,[e,i])=>e.evaluate(n)-i.evaluate(n)],[[Bt],(n,[e])=>-e.evaluate(n)]]},"/":[Bt,[Bt,Bt],(n,[e,i])=>e.evaluate(n)/i.evaluate(n)],"%":[Bt,[Bt,Bt],(n,[e,i])=>e.evaluate(n)%i.evaluate(n)],ln2:[Bt,[],()=>Math.LN2],pi:[Bt,[],()=>Math.PI],e:[Bt,[],()=>Math.E],"^":[Bt,[Bt,Bt],(n,[e,i])=>Math.pow(e.evaluate(n),i.evaluate(n))],sqrt:[Bt,[Bt],(n,[e])=>Math.sqrt(e.evaluate(n))],log10:[Bt,[Bt],(n,[e])=>Math.log(e.evaluate(n))/Math.LN10],ln:[Bt,[Bt],(n,[e])=>Math.log(e.evaluate(n))],log2:[Bt,[Bt],(n,[e])=>Math.log2(e.evaluate(n))],sin:[Bt,[Bt],(n,[e])=>Math.sin(e.evaluate(n))],cos:[Bt,[Bt],(n,[e])=>Math.cos(e.evaluate(n))],tan:[Bt,[Bt],(n,[e])=>Math.tan(e.evaluate(n))],asin:[Bt,[Bt],(n,[e])=>Math.asin(e.evaluate(n))],acos:[Bt,[Bt],(n,[e])=>Math.acos(e.evaluate(n))],atan:[Bt,[Bt],(n,[e])=>Math.atan(e.evaluate(n))],min:[Bt,nl(Bt),(n,e)=>Math.min(...e.map(i=>i.evaluate(n)))],max:[Bt,nl(Bt),(n,e)=>Math.max(...e.map(i=>i.evaluate(n)))],abs:[Bt,[Bt],(n,[e])=>Math.abs(e.evaluate(n))],round:[Bt,[Bt],(n,[e])=>{const i=e.evaluate(n);return i<0?-Math.round(-i):Math.round(i)}],floor:[Bt,[Bt],(n,[e])=>Math.floor(e.evaluate(n))],ceil:[Bt,[Bt],(n,[e])=>Math.ceil(e.evaluate(n))],"filter-==":[Ji,[Ei,Wi],(n,[e,i])=>n.properties()[e.value]===i.value],"filter-id-==":[Ji,[Wi],(n,[e])=>n.id()===e.value],"filter-type-==":[Ji,[Ei],(n,[e])=>n.geometryType()===e.value],"filter-<":[Ji,[Ei,Wi],(n,[e,i])=>{const o=n.properties()[e.value],l=i.value;return typeof o==typeof l&&o<l}],"filter-id-<":[Ji,[Wi],(n,[e])=>{const i=n.id(),o=e.value;return typeof i==typeof o&&i<o}],"filter->":[Ji,[Ei,Wi],(n,[e,i])=>{const o=n.properties()[e.value],l=i.value;return typeof o==typeof l&&o>l}],"filter-id->":[Ji,[Wi],(n,[e])=>{const i=n.id(),o=e.value;return typeof i==typeof o&&i>o}],"filter-<=":[Ji,[Ei,Wi],(n,[e,i])=>{const o=n.properties()[e.value],l=i.value;return typeof o==typeof l&&o<=l}],"filter-id-<=":[Ji,[Wi],(n,[e])=>{const i=n.id(),o=e.value;return typeof i==typeof o&&i<=o}],"filter->=":[Ji,[Ei,Wi],(n,[e,i])=>{const o=n.properties()[e.value],l=i.value;return typeof o==typeof l&&o>=l}],"filter-id->=":[Ji,[Wi],(n,[e])=>{const i=n.id(),o=e.value;return typeof i==typeof o&&i>=o}],"filter-has":[Ji,[Wi],(n,[e])=>e.value in n.properties()],"filter-has-id":[Ji,[],n=>n.id()!==null&&n.id()!==void 0],"filter-type-in":[Ji,[$r(Ei)],(n,[e])=>e.value.indexOf(n.geometryType())>=0],"filter-id-in":[Ji,[$r(Wi)],(n,[e])=>e.value.indexOf(n.id())>=0],"filter-in-small":[Ji,[Ei,$r(Wi)],(n,[e,i])=>i.value.indexOf(n.properties()[e.value])>=0],"filter-in-large":[Ji,[Ei,$r(Wi)],(n,[e,i])=>function(o,l,d,f){for(;d<=f;){const _=d+f>>1;if(l[_]===o)return!0;l[_]>o?f=_-1:d=_+1}return!1}(n.properties()[e.value],i.value,0,i.value.length-1)],all:{type:Ji,overloads:[[[Ji,Ji],(n,[e,i])=>e.evaluate(n)&&i.evaluate(n)],[nl(Ji),(n,e)=>{for(const i of e)if(!i.evaluate(n))return!1;return!0}]]},any:{type:Ji,overloads:[[[Ji,Ji],(n,[e,i])=>e.evaluate(n)||i.evaluate(n)],[nl(Ji),(n,e)=>{for(const i of e)if(i.evaluate(n))return!0;return!1}]]},"!":[Ji,[Ji],(n,[e])=>!e.evaluate(n)],"is-supported-script":[Ji,[Ei],(n,[e])=>{const i=n.globals&&n.globals.isSupportedScript;return!i||i(e.evaluate(n))}],upcase:[Ei,[Ei],(n,[e])=>e.evaluate(n).toUpperCase()],downcase:[Ei,[Ei],(n,[e])=>e.evaluate(n).toLowerCase()],concat:[Ei,nl(Wi),(n,e)=>e.map(i=>Yo(i.evaluate(n))).join("")],"resolved-locale":[Ei,[Zh],(n,[e])=>e.evaluate(n).resolvedLocale()],random:[Bt,[Bt,Bt,Wi],(n,e)=>{const[i,o,l]=e.map(f=>f.evaluate(n));if(i>o||i===o)return i;let d;if(typeof l=="string")d=function(f){let _=0;if(f.length===0)return _;for(let v=0;v<f.length;v++)_=(_<<5)-_+f.charCodeAt(v),_|=0;return _}(l);else{if(typeof l!="number")throw new mr(`Invalid seed input: ${l}`);d=l}return i+Lg(d)()*(o-i)}]});class Sd{constructor(e,i,o,l,d){this.expression=e,this._warningHistory={},this._scope=o,this._options=l,this._iconImageUseTheme=d,this._evaluator=new Qh(o,l,d),this._defaultValue=i?function(f){return f.type==="color"&&(Td(f.default)||Array.isArray(f.default))?new Zi(0,0,0,0):f.type==="color"?Zi.parse(f.default)||null:f.default===void 0?null:f.default}(i):null,this._enumValues=i&&i.type==="enum"?i.values:null,this.configDependencies=Ul(e),this.isIndoorDependent=wd(e)}evaluateWithoutErrorHandling(e,i,o,l,d,f,_,v){return this._evaluator.globals=e,this._evaluator.feature=i,this._evaluator.featureState=o,this._evaluator.canonical=l||null,this._evaluator.availableImages=d||null,this._evaluator.formattedSection=f,this._evaluator.featureTileCoord=_||null,this._evaluator.featureDistanceData=v||null,this.expression.evaluate(this._evaluator)}evaluate(e,i,o,l,d,f,_,v,b){this._evaluator||(this._evaluator=new Qh(this._scope,this._options,this._iconImageUseTheme)),this._evaluator.globals=e,this._evaluator.feature=i||null,this._evaluator.featureState=o||null,this._evaluator.canonical=l||null,this._evaluator.availableImages=d||null,this._evaluator.formattedSection=f||null,this._evaluator.featureTileCoord=_||null,this._evaluator.featureDistanceData=v||null,this._evaluator.iconImageUseTheme=b||null;try{const E=this.expression.evaluate(this._evaluator);if(E==null||typeof E=="number"&&E!=E)return this._defaultValue;if(this._enumValues&&!(E in this._enumValues))throw new mr(`Expected value to be one of ${Object.keys(this._enumValues).map(I=>JSON.stringify(I)).join(", ")}, but found ${JSON.stringify(E)} instead.`);return E}catch(E){const I=E;return this._warningHistory[I.message]||(this._warningHistory[I.message]=!0,typeof console<"u"&&console.warn(`Failed to evaluate expression "${JSON.stringify(this.expression.serialize())}". ${I.message}`)),this._defaultValue}}}function Wu(n){return Array.isArray(n)&&n.length>0&&typeof n[0]=="string"&&n[0]in Rc}function ol(n,e,i,o,l){const d=new hd(Rc,[],e?function(_){const v={color:go,string:Ei,number:Bt,enum:Ei,boolean:Ji,formatted:ku,resolvedImage:Lu};return _.type==="array"?$r(v[_.value]||Wi,_.length):v[_.type]}(e):void 0,void 0,void 0,i,o,l),f=d.parse(n,void 0,void 0,void 0,e&&e.type==="string"?{typeAnnotation:"coerce"}:void 0);return f?Dg(new Sd(f,e,i,o,l)):rl(d.errors)}class kc{constructor(e,i,o,l){this.kind=e,this._styleExpression=i,this.isLightConstant=o,this.isLineProgressConstant=l,this.isStateDependent=e!=="constant"&&!ju(i.expression),this.configDependencies=Ul(i.expression),this.isIndoorDependent=wd(i.expression)}evaluateWithoutErrorHandling(e,i,o,l,d,f){return this._styleExpression.evaluateWithoutErrorHandling(e,i,o,l,d,f)}evaluate(e,i,o,l,d,f,_){return this._styleExpression.evaluate(e,i,o,l,d,f,void 0,void 0,_)}}class Vl{constructor(e,i,o,l,d,f){this.kind=e,this.zoomStops=o,this._styleExpression=i,this.isStateDependent=e!=="camera"&&!ju(i.expression),this.isIndoorDependent=wd(i.expression),this.isLightConstant=d,this.isLineProgressConstant=f,this.configDependencies=Ul(i.expression),this.interpolationType=l}evaluateWithoutErrorHandling(e,i,o,l,d,f){return this._styleExpression.evaluateWithoutErrorHandling(e,i,o,l,d,f)}evaluate(e,i,o,l,d,f){return this._styleExpression.evaluate(e,i,o,l,d,f)}interpolationFactor(e,i,o){return this.interpolationType?Oo.interpolationFactor(this.interpolationType,e,i,o):0}}function Zp(n,e,i,o,l){if((n=ol(n,e,i,o,l)).result==="error")return n;const d=n.value.expression,f=Sc(d);if(!f&&!qu(e))return rl([new Ko("","data expressions not supported")]);const _=Ec(d,["zoom","pitch","distance-from-center"]);if(!_&&!Fg(e))return rl([new Ko("","zoom expressions not supported")]);const v=Ec(d,["measure-light"]);if(!v&&!Og(e))return rl([new Ko("","measure-light expression not supported")]);const b=Ec(d,["line-progress"]);if(!b&&!function(C){return Wp(C.expression,"line-progress")}(e))return rl([new Ko("","line-progress expression not supported")]);const E=e.expression&&e.expression.relaxZoomRestriction,I=vs(d);return I||_||E?I instanceof Ko?rl([I]):I instanceof Oo&&!bd(e)?rl([new Ko("",'"interpolate" expressions cannot be used with this property')]):Dg(I?new Vl(f&&b?"camera":"composite",n.value,I.labels,I instanceof Oo?I.interpolation:void 0,v,b):new kc(f&&b?"constant":"source",n.value,v,b)):rl([new Ko("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class Ed{constructor(e,i){this._parameters=e,this._specification=i,Object.assign(this,Ng(this._parameters,this._specification))}static deserialize(e){return new Ed(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function vs(n){let e=null;if(n instanceof ha)e=vs(n.result);else if(n instanceof $u){for(const i of n.args)if(e=vs(i),e)break}else(n instanceof Uu||n instanceof Oo)&&n.input instanceof so&&n.input.name==="zoom"&&(e=n);return e instanceof Ko||n.eachChild(i=>{const o=vs(i);o instanceof Ko?e=o:e&&o&&e!==o&&(e=new Ko("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),e}var Xp,Vg,$g=function(){if(Vg)return Xp;Vg=1,Xp=e;var n=3;function e(i,o,l){var d=this.cells=[];if(i instanceof ArrayBuffer){this.arrayBuffer=i;var f=new Int32Array(this.arrayBuffer);i=f[0],this.d=(o=f[1])+2*(l=f[2]);for(var _=0;_<this.d*this.d;_++){var v=f[n+_],b=f[n+_+1];d.push(v===b?null:f.subarray(v,b))}var E=f[n+d.length+1];this.keys=f.subarray(f[n+d.length],E),this.bboxes=f.subarray(E),this.insert=this._insertReadonly}else{this.d=o+2*l;for(var I=0;I<this.d*this.d;I++)d.push([]);this.keys=[],this.bboxes=[]}this.n=o,this.extent=i,this.padding=l,this.scale=o/i,this.uid=0;var C=l/o*i;this.min=-C,this.max=i+C}return e.prototype.insert=function(i,o,l,d,f){this._forEachCell(o,l,d,f,this._insertCell,this.uid++),this.keys.push(i),this.bboxes.push(o),this.bboxes.push(l),this.bboxes.push(d),this.bboxes.push(f)},e.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},e.prototype._insertCell=function(i,o,l,d,f,_){this.cells[f].push(_)},e.prototype.query=function(i,o,l,d,f){var _=this.min,v=this.max;if(i<=_&&o<=_&&v<=l&&v<=d&&!f)return Array.prototype.slice.call(this.keys);var b=[];return this._forEachCell(i,o,l,d,this._queryCell,b,{},f),b},e.prototype._queryCell=function(i,o,l,d,f,_,v,b){var E=this.cells[f];if(E!==null)for(var I=this.keys,C=this.bboxes,R=0;R<E.length;R++){var k=E[R];if(v[k]===void 0){var F=4*k;(b?b(C[F+0],C[F+1],C[F+2],C[F+3]):i<=C[F+2]&&o<=C[F+3]&&l>=C[F+0]&&d>=C[F+1])?(v[k]=!0,_.push(I[k])):v[k]=!1}}},e.prototype._forEachCell=function(i,o,l,d,f,_,v,b){for(var E=this._convertToCellCoord(i),I=this._convertToCellCoord(o),C=this._convertToCellCoord(l),R=this._convertToCellCoord(d),k=E;k<=C;k++)for(var F=I;F<=R;F++){var U=this.d*F+k;if((!b||b(this._convertFromCellCoord(k),this._convertFromCellCoord(F),this._convertFromCellCoord(k+1),this._convertFromCellCoord(F+1)))&&f.call(this,i,o,l,d,U,_,v,b))return}},e.prototype._convertFromCellCoord=function(i){return(i-this.padding)/this.scale},e.prototype._convertToCellCoord=function(i){return Math.max(0,Math.min(this.d-1,Math.floor(i*this.scale)+this.padding))},e.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var i=this.cells,o=n+this.cells.length+1+1,l=0,d=0;d<this.cells.length;d++)l+=this.cells[d].length;var f=new Int32Array(o+l+this.keys.length+this.bboxes.length);f[0]=this.extent,f[1]=this.n,f[2]=this.padding;for(var _=o,v=0;v<i.length;v++){var b=i[v];f[n+v]=_,f.set(b,_),_+=b.length}return f[n+i.length]=_,f.set(this.keys,_),f[n+i.length+1]=_+=this.keys.length,f.set(this.bboxes,_),_+=this.bboxes.length,f.buffer},Xp}(),Lc=Cl($g);const $l={};function It(n,e,i={}){Object.defineProperty(n,"_classRegistryKey",{value:e,writable:!1}),$l[e]={klass:n,omit:i.omit||[]}}It(Object,"Object"),Lc.serialize=function(n,e){const i=n.toArrayBuffer();return e&&e.add(i),{buffer:i}},Lc.deserialize=function(n){return new Lc(n.buffer)},Object.defineProperty(Lc,"name",{value:"Grid"}),It(Lc,"Grid"),delete et.prototype.constructor,It(Zi,"Color"),It(Error,"Error"),It(ro,"Formatted"),It(Kh,"FormattedSection"),It(Io,"AJAXError"),It(oo,"ResolvedImage"),It(Ed,"StylePropertyFunction"),It(Sd,"StyleExpression",{omit:["_evaluator"]}),It(Jr,"ImageId"),It(la,"ImageVariant"),It(Vl,"ZoomDependentExpression"),It(kc,"ZoomConstantExpression"),It(so,"CompoundExpression",{omit:["_evaluate"]});for(const n in Rc)$l[Rc[n]._classRegistryKey]||It(Rc[n],`Expression${n}`);function Zu(n){return n&&(n instanceof ArrayBuffer||n.constructor&&n.constructor.name==="ArrayBuffer")}function da(n,e){if(n==null||typeof n=="boolean"||typeof n=="number"||typeof n=="string"||n instanceof Boolean||n instanceof Number||n instanceof String||n instanceof Date||n instanceof RegExp)return n;if(Zu(n)||n instanceof ImageBitmap)return e&&e.add(n),n;if(ArrayBuffer.isView(n))return e&&e.add(n.buffer),n;if(n instanceof ImageData)return e&&e.add(n.data.buffer),n;if(Array.isArray(n)){const i=[];for(const o of n)i.push(da(o,e));return i}if(n instanceof Map){const i={$name:"Map",entries:[]};for(const[o,l]of n.entries())i.entries.push(da(o),da(l,e));return i}if(n instanceof Set){const i={$name:"Set"};let o=0;for(const l of n.values())i[++o]=da(l);return i}if(typeof n=="bigint")return{$name:"BigInt",value:n.toString()};if(typeof n=="object"){const i=n.constructor,o=i._classRegistryKey;if(!o)throw new Error(`Can't serialize object of unregistered class "${i.name}".`);const l=i.serialize?i.serialize(n,e):{};if(!i.serialize){for(const d in n)n.hasOwnProperty(d)&&($l[o].omit.indexOf(d)>=0||(l[d]=da(n[d],e)));n instanceof Error&&(l.message=n.message)}if(l.$name)throw new Error("$name property is reserved for worker serialization logic.");return o!=="Object"&&(l.$name=o),l}throw new Error("can't serialize object of type "+typeof n)}function sl(n){if(n==null||typeof n=="boolean"||typeof n=="number"||typeof n=="string"||n instanceof Boolean||n instanceof Number||n instanceof String||n instanceof Date||n instanceof RegExp||Zu(n)||n instanceof ImageBitmap||ArrayBuffer.isView(n)||n instanceof ImageData)return n;if(Array.isArray(n))return n.map(sl);if(typeof n=="object"){const e=n.$name||"Object";if(e==="Map"){const l=n.entries||[],d=new Map;for(let f=0;f<l.length;f+=2)d.set(sl(l[f]),sl(l[f+1]));return d}if(e==="Set"){const l=new Set;for(const d of Object.keys(n))d!=="$name"&&l.add(sl(n[d]));return l}if(e==="BigInt")return BigInt(n.value);const{klass:i}=$l[e];if(!i)throw new Error(`Can't deserialize unregistered class "${e}".`);if(i.deserialize)return i.deserialize(n);const o=Object.create(i.prototype);for(const l of Object.keys(n))l!=="$name"&&(o[l]=sl(n[l]));return o}throw new Error("can't deserialize object of type "+typeof n)}const Gt={"Latin-1 Supplement":n=>n>=128&&n<=255,Arabic:n=>n>=1536&&n<=1791,"Arabic Supplement":n=>n>=1872&&n<=1919,"Arabic Extended-A":n=>n>=2208&&n<=2303,"Hangul Jamo":n=>n>=4352&&n<=4607,"Unified Canadian Aboriginal Syllabics":n=>n>=5120&&n<=5759,Khmer:n=>n>=6016&&n<=6143,"Unified Canadian Aboriginal Syllabics Extended":n=>n>=6320&&n<=6399,"General Punctuation":n=>n>=8192&&n<=8303,"Letterlike Symbols":n=>n>=8448&&n<=8527,"Number Forms":n=>n>=8528&&n<=8591,"Miscellaneous Technical":n=>n>=8960&&n<=9215,"Control Pictures":n=>n>=9216&&n<=9279,"Optical Character Recognition":n=>n>=9280&&n<=9311,"Enclosed Alphanumerics":n=>n>=9312&&n<=9471,"Geometric Shapes":n=>n>=9632&&n<=9727,"Miscellaneous Symbols":n=>n>=9728&&n<=9983,"Miscellaneous Symbols and Arrows":n=>n>=11008&&n<=11263,"CJK Radicals Supplement":n=>n>=11904&&n<=12031,"Kangxi Radicals":n=>n>=12032&&n<=12255,"Ideographic Description Characters":n=>n>=12272&&n<=12287,"CJK Symbols and Punctuation":n=>n>=12288&&n<=12351,Hiragana:n=>n>=12352&&n<=12447,Katakana:n=>n>=12448&&n<=12543,Bopomofo:n=>n>=12544&&n<=12591,"Hangul Compatibility Jamo":n=>n>=12592&&n<=12687,Kanbun:n=>n>=12688&&n<=12703,"Bopomofo Extended":n=>n>=12704&&n<=12735,"CJK Strokes":n=>n>=12736&&n<=12783,"Katakana Phonetic Extensions":n=>n>=12784&&n<=12799,"Enclosed CJK Letters and Months":n=>n>=12800&&n<=13055,"CJK Compatibility":n=>n>=13056&&n<=13311,"CJK Unified Ideographs Extension A":n=>n>=13312&&n<=19903,"Yijing Hexagram Symbols":n=>n>=19904&&n<=19967,"CJK Unified Ideographs":n=>n>=19968&&n<=40959,"Yi Syllables":n=>n>=40960&&n<=42127,"Yi Radicals":n=>n>=42128&&n<=42191,"Hangul Jamo Extended-A":n=>n>=43360&&n<=43391,"Hangul Syllables":n=>n>=44032&&n<=55215,"Hangul Jamo Extended-B":n=>n>=55216&&n<=55295,"Private Use Area":n=>n>=57344&&n<=63743,"CJK Compatibility Ideographs":n=>n>=63744&&n<=64255,"Arabic Presentation Forms-A":n=>n>=64336&&n<=65023,"Vertical Forms":n=>n>=65040&&n<=65055,"CJK Compatibility Forms":n=>n>=65072&&n<=65103,"Small Form Variants":n=>n>=65104&&n<=65135,"Arabic Presentation Forms-B":n=>n>=65136&&n<=65279,"Halfwidth and Fullwidth Forms":n=>n>=65280&&n<=65519,Osage:n=>n>=66736&&n<=66815,"CJK Unified Ideographs Extension B":n=>n>=131072&&n<=173791};function Xu(n){for(const e of n)if(Id(e.charCodeAt(0)))return!0;return!1}function Kp(n){for(const e of n)if(!Gg(e.charCodeAt(0)))return!1;return!0}function Gg(n){return!(Gt.Arabic(n)||Gt["Arabic Supplement"](n)||Gt["Arabic Extended-A"](n)||Gt["Arabic Presentation Forms-A"](n)||Gt["Arabic Presentation Forms-B"](n))}function Id(n){return!(n!==746&&n!==747&&(n<4352||!(Gt["Bopomofo Extended"](n)||Gt.Bopomofo(n)||Gt["CJK Compatibility Forms"](n)&&!(n>=65097&&n<=65103)||Gt["CJK Compatibility Ideographs"](n)||Gt["CJK Compatibility"](n)||Gt["CJK Radicals Supplement"](n)||Gt["CJK Strokes"](n)||!(!Gt["CJK Symbols and Punctuation"](n)||n>=12296&&n<=12305||n>=12308&&n<=12319||n===12336)||Gt["CJK Unified Ideographs Extension A"](n)||Gt["CJK Unified Ideographs"](n)||Gt["Enclosed CJK Letters and Months"](n)||Gt["Hangul Compatibility Jamo"](n)||Gt["Hangul Jamo Extended-A"](n)||Gt["Hangul Jamo Extended-B"](n)||Gt["Hangul Jamo"](n)||Gt["Hangul Syllables"](n)||Gt.Hiragana(n)||Gt["Ideographic Description Characters"](n)||Gt.Kanbun(n)||Gt["Kangxi Radicals"](n)||Gt["Katakana Phonetic Extensions"](n)||Gt.Katakana(n)&&n!==12540||!(!Gt["Halfwidth and Fullwidth Forms"](n)||n===65288||n===65289||n===65293||n>=65306&&n<=65310||n===65339||n===65341||n===65343||n>=65371&&n<=65503||n===65507||n>=65512&&n<=65519)||!(!Gt["Small Form Variants"](n)||n>=65112&&n<=65118||n>=65123&&n<=65126)||Gt["Unified Canadian Aboriginal Syllabics"](n)||Gt["Unified Canadian Aboriginal Syllabics Extended"](n)||Gt["Vertical Forms"](n)||Gt["Yijing Hexagram Symbols"](n)||Gt["Yi Syllables"](n)||Gt["Yi Radicals"](n))))}function Ad(n){return!(Id(n)||function(e){return!!(Gt["Latin-1 Supplement"](e)&&(e===167||e===169||e===174||e===177||e===188||e===189||e===190||e===215||e===247)||Gt["General Punctuation"](e)&&(e===8214||e===8224||e===8225||e===8240||e===8241||e===8251||e===8252||e===8258||e===8263||e===8264||e===8265||e===8273)||Gt["Letterlike Symbols"](e)||Gt["Number Forms"](e)||Gt["Miscellaneous Technical"](e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||e===9003||e>=9085&&e<=9114||e>=9150&&e<=9165||e===9167||e>=9169&&e<=9179||e>=9186&&e<=9215)||Gt["Control Pictures"](e)&&e!==9251||Gt["Optical Character Recognition"](e)||Gt["Enclosed Alphanumerics"](e)||Gt["Geometric Shapes"](e)||Gt["Miscellaneous Symbols"](e)&&!(e>=9754&&e<=9759)||Gt["Miscellaneous Symbols and Arrows"](e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||Gt["CJK Symbols and Punctuation"](e)||Gt.Katakana(e)||Gt["Private Use Area"](e)||Gt["CJK Compatibility Forms"](e)||Gt["Small Form Variants"](e)||Gt["Halfwidth and Fullwidth Forms"](e)||e===8734||e===8756||e===8757||e>=9984&&e<=10087||e>=10102&&e<=10131||e===65532||e===65533)}(n))}function Cd(n){return Gt.Arabic(n)||Gt["Arabic Supplement"](n)||Gt["Arabic Extended-A"](n)||Gt["Arabic Presentation Forms-A"](n)||Gt["Arabic Presentation Forms-B"](n)}function Yp(n){return n>=1424&&n<=2303||Gt["Arabic Presentation Forms-A"](n)||Gt["Arabic Presentation Forms-B"](n)}function fa(n,e){return!(!e&&Yp(n)||n>=2304&&n<=3583||n>=3840&&n<=4255||Gt.Khmer(n))}function Kv(n){for(const e of n)if(Yp(e.charCodeAt(0)))return!0;return!1}const Ao={unavailable:"unavailable",deferred:"deferred",loading:"loading",parsing:"parsing",parsed:"parsed",loaded:"loaded",error:"error"};let Jp=null,ao=Ao.unavailable,pa=null;const Ku=function(n){n&&typeof n=="string"&&n.indexOf("NetworkError")>-1&&(ao=Ao.error),Jp&&Jp(n)};function Pd(){Md.fire(new Fs("pluginStateChange",{pluginStatus:ao,pluginURL:pa}))}const Md=new Ol,Yu=function(){return ao},Hg=function(){if(ao!==Ao.deferred||!pa)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");ao=Ao.loading,Pd(),pa&&aa({url:pa},n=>{n?Ku(n):(ao=Ao.loaded,Pd())})},ma={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>ao===Ao.loaded||ma.applyArabicShaping!=null,isLoading:()=>ao===Ao.loading,setState(n){ao=n.pluginStatus,pa=n.pluginURL},isParsing:()=>ao===Ao.parsing,isParsed:()=>ao===Ao.parsed,getPluginURL:()=>pa};class fn{constructor(e,i){this.zoom=e,i?(this.now=i.now,this.fadeDuration=i.fadeDuration,this.transition=i.transition,this.pitch=i.pitch,this.brightness=i.brightness,this.worldview=i.worldview,this.activeFloors=i.activeFloors):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(e){return function(i,o){for(const l of i)if(!fa(l.charCodeAt(0),o))return!1;return!0}(e,ma.isLoaded())}}class Rd{constructor(e,i,o,l,d){this.property=e,this.value=i,this.expression=function(f,_,v,b,E){if(Td(f))return new Ed(f,_);if(Wu(f)||Array.isArray(f)&&f.length>0){const I=Zp(f,_,v,b,E);if(I.result==="error")throw new Error(I.value.map(C=>`${C.key}: ${C.message}`).join(", "));return I.value}{let I=f;return typeof f=="string"&&_.type==="color"&&(I=Zi.parse(f)),{kind:"constant",configDependencies:new Set,isIndoorDependent:!1,evaluate:()=>I}}}(i===void 0?e.specification.default:i,e.specification,o,l,d)}isIndoorDependent(){return this.expression.isIndoorDependent}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(e,i,o,l){return this.property.possiblyEvaluate(this,e,i,o,l)}}class Qp{constructor(e,i,o,l){this.property=e,this.value=new Rd(e,void 0,i,o,l)}transitioned(e,i){return new Wg(this.property,this.value,i,Object.assign({},e.transition,this.transition),e.now)}untransitioned(){return new Wg(this.property,this.value,null,{},0)}}class qg{constructor(e,i,o,l){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues),this._scope=i,this._options=o,this._iconImageUseTheme=l,this._isIndoorDependent=!1,this.configDependencies=new Set}getValue(e){return Ge(this._values[e].value.value)}setValue(e,i){this._values.hasOwnProperty(e)||(this._values[e]=new Qp(this._values[e].property,this._scope,this._options,this._iconImageUseTheme)),this._values[e].value=new Rd(this._values[e].property,i===null?void 0:Ge(i),this._scope,this._options,this._iconImageUseTheme),this._values[e].value.expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].value.expression.configDependencies]),this._isIndoorDependent=this._isIndoorDependent||this._values[e].value.isIndoorDependent())}setTransitionOrValue(e,i){i&&(this._options=i);const o=this._properties.properties;if(e)for(const l in e){const d=e[l];if(l.endsWith("-transition")){const f=l.slice(0,-11);o[f]&&this.setTransition(f,d)}else o.hasOwnProperty(l)&&this.setValue(l,d)}}getTransition(e){return Ge(this._values[e].transition)}setTransition(e,i){this._values.hasOwnProperty(e)||(this._values[e]=new Qp(this._values[e].property)),this._values[e].transition=Ge(i)||void 0}serialize(){const e={};for(const i of Object.keys(this._values)){const o=this.getValue(i);o!==void 0&&(e[i]=o);const l=this.getTransition(i);l!==void 0&&(e[`${i}-transition`]=l)}return e}transitioned(e,i){const o=new Zg(this._properties);for(const l of Object.keys(this._values))o._values[l]=this._values[l].transitioned(e,i._values[l]);return o}untransitioned(){const e=new Zg(this._properties);for(const i of Object.keys(this._values))e._values[i]=this._values[i].untransitioned();return e}isIndoorDependent(){return this._isIndoorDependent}}class Wg{constructor(e,i,o,l,d){const f=l.delay||0,_=l.duration||0;d=d||0,this.property=e,this.value=i,this.begin=d+f,this.end=this.begin+_,e.specification.transition&&(l.delay||l.duration)&&(this.prior=o)}possiblyEvaluate(e,i,o){const l=e.now||0,d=this.value.possiblyEvaluate(e,i,o),f=this.prior;if(f){if(l>this.end)return this.prior=null,d;if(this.value.isDataDriven())return this.prior=null,d;if(l<this.begin)return f.possiblyEvaluate(e,i,o);{const _=(l-this.begin)/(this.end-this.begin);return this.property.interpolate(f.possiblyEvaluate(e,i,o),d,Ml(_))}}return d}}class Zg{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues)}possiblyEvaluate(e,i,o){const l=new Hl(this._properties);for(const d of Object.keys(this._values))l._values[d]=this._values[d].possiblyEvaluate(e,i,o);return l}hasTransition(){for(const e of Object.keys(this._values))if(this._values[e].prior)return!0;return!1}}class Xg{constructor(e,i,o,l){this._properties=e,this._values=Object.create(e.defaultPropertyValues),this._scope=i,this._options=o,this._iconImageUseTheme=l,this._isIndoorDependent=!1,this.configDependencies=new Set}getValue(e){return Ge(this._values[e].value)}setValue(e,i){this._values[e]=new Rd(this._values[e].property,i===null?void 0:Ge(i),this._scope,this._options,this._iconImageUseTheme),this._values[e].expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].expression.configDependencies]),this._isIndoorDependent=this._isIndoorDependent||this._values[e].isIndoorDependent())}serialize(){const e={};for(const i of Object.keys(this._values)){const o=this.getValue(i);o!==void 0&&(e[i]=o)}return e}possiblyEvaluate(e,i,o,l){const d=new Hl(this._properties);for(const f of Object.keys(this._values))d._values[f]=this._values[f].possiblyEvaluate(e,i,o,l);return d}isIndoorDependent(){return this._isIndoorDependent}}class Gl{constructor(e,i,o,l){this.property=e,this.value=i,this.parameters=o,this.iconImageUseTheme=l}isConstant(){return this.value.kind==="constant"}constantOr(e){return this.value.kind==="constant"?this.value.value:e}evaluate(e,i,o,l){return this.property.evaluate(this.value,this.parameters,e,i,o,l,this.iconImageUseTheme)}}class Hl{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues)}get(e){return this._values[e]}}class ut{constructor(e){this.specification=e}possiblyEvaluate(e,i){return e.expression.evaluate(i)}interpolate(e,i,o){const l=Ru[this.specification.type];return l?l(e,i,o):e}}class _t{constructor(e,i){this.specification=e,this.overrides=i}possiblyEvaluate(e,i,o,l,d){return e.expression.kind==="constant"||e.expression.kind==="camera"?new Gl(this,{kind:"constant",value:e.expression.evaluate(i,null,{},o,l,void 0,d)},i):new Gl(this,e.expression,i,d)}interpolate(e,i,o){if(e.value.kind!=="constant"||i.value.kind!=="constant")return e;if(e.value.value===void 0||i.value.value===void 0)return new Gl(this,{kind:"constant",value:void 0},e.parameters);const l=Ru[this.specification.type];return l?new Gl(this,{kind:"constant",value:l(e.value.value,i.value.value,o)},e.parameters):e}evaluate(e,i,o,l,d,f,_){return e.kind==="constant"?e.value:e.evaluate(i,o,l,d,f,void 0,_)}}class ql{constructor(e){this.specification=e}possiblyEvaluate(e,i,o,l){return!!e.expression.evaluate(i,null,{},o,l)}interpolate(){return!1}}class Bn{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const i=new fn(0,{});for(const o in e){const l=e[o];l.specification.overridable&&this.overridableProperties.push(o);const d=this.defaultPropertyValues[o]=new Rd(l,void 0),f=this.defaultTransitionablePropertyValues[o]=new Qp(l);this.defaultTransitioningPropertyValues[o]=f.untransitioned(),this.defaultPossiblyEvaluatedValues[o]=d.possiblyEvaluate(i)}}}It(_t,"DataDrivenProperty"),It(ut,"DataConstantProperty"),It(ql,"ColorRampProperty");var Se=JSON.parse('{"$version":8,"$root":{"version":{"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"snow":{"type":"snow"},"rain":{"type":"rain"},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"indoor":{"type":"indoor"},"imports":{"type":"array","value":"import"},"iconsets":{"type":"iconsets"},"schema":{"type":"schema"},"sources":{"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"type":"array","value":"layer"},"models":{"type":"models"},"featuresets":{"type":"featuresets"}},"featuresets":{"*":{"type":"featureset"}},"featureset":{"metadata":{"type":"*"},"selectors":{"type":"array","value":"selector"}},"selector":{"layer":{"type":"string"},"properties":{"type":"selectorProperty"},"featureNamespace":{"type":"string"},"_uniqueFeatureID":{"type":"boolean"}},"selectorProperty":{"*":{"type":"*"}},"model":{"type":"string"},"import":{"id":{"type":"string"},"url":{"type":"string"},"config":{"type":"config"},"data":{"type":"$root"},"color-theme":{"type":"colorTheme","optional":true}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","expression":{}},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string"},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false},"shadow-quality":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"parameters":["zoom"]}},"shadow-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"iconsets":{"*":{"type":"iconset"}},"iconset":["iconset_sprite","iconset_source"],"iconset_sprite":{"type":{"type":"enum","values":{"sprite":1}},"url":{"type":"string"}},"iconset_source":{"type":{"type":"enum","values":{"source":1}},"source":{"type":"string"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"type":{"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"type":"enum","values":{"video":1}},"urls":{"type":"array","value":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"type":"enum","values":{"image":1}},"url":{"type":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"modelNodeOverride":{"orientation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360}},"modelNodeOverrides":{"*":{"type":"modelNodeOverride"}},"modelMaterialOverride":{"model-color":{"type":"color"},"model-color-mix-intensity":{"type":"number"},"model-opacity":{"type":"number"},"model-emissive-strength":{"type":"number"}},"modelMaterialOverrides":{"*":{"type":"modelMaterialOverride"}},"modelSourceModel":{"uri":{"type":"string"},"position":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[-180,-90],"maximum":[180,90]},"orientation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360},"nodeOverrides":{"type":"modelNodeOverrides"},"materialOverrides":{"type":"modelMaterialOverrides"},"nodeOverrideNames":{"type":"array","value":"string"},"materialOverrideNames":{"type":"array","value":"string"},"featureProperties":{"type":"*"}},"modelSourceModels":{"*":{"type":"modelSourceModel"}},"source_model":{"type":{"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"},"models":{"type":"modelSourceModels"}},"layer":{"id":{"type":"string"},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"building":{},"raster":{},"raster-particle":{},"hillshade":{},"model":{},"background":{},"sky":{},"slot":{},"clip":{}}},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"},"appearances":{"type":"array","value":"appearance","supported-layer-types":["symbol"]}},"appearance":{"condition":{"type":"boolean","expression":{"interpolated":true,"parameters":["zoom","pitch","feature","feature-state","measure-light","distance-from-center"]},"property-type":"data-driven"},"name":{"type":"string"},"properties":{"type":"*"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_building","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{}},"clip-layer-scope":{"type":"array","value":"string","default":[],"expression":{}}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-base":1,"hd-road-markup":1},"default":"none","expression":{}},"fill-construct-bridge-guard-rail":{"type":"boolean","default":"true","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"circle-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-markup":1},"default":"none","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-extrusion-edge-radius":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}}},"layout_building":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"building-facade":{"type":"boolean","default":false,"expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-facade-floors":{"type":"number","minimum":1,"maximum":200,"default":3,"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-facade-unit-width":{"type":"number","minimum":1,"maximum":20,"default":3.1,"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-facade-window":{"type":"array","length":2,"value":"number","minimum":0.1,"maximum":1,"default":[0.9,0.9],"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-roof-shape":{"type":"enum","values":{"flat":1,"hipped":1,"gabled":1,"parapet":1,"mansard":1,"skillion":1,"pyramidal":1},"default":"flat","expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"},"building-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"},"building-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"building-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"building-flip-roof-orientation":{"property-type":"data-driven","type":"boolean","default":false,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","default":0,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"line-elevation-reference":{"type":"enum","values":{"none":1,"sea":1,"ground":1,"hd-road-markup":1},"default":"none","expression":{}},"line-cross-slope":{"type":"number","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"line-width-unit":{"type":"enum","values":{"pixels":1,"meters":1},"default":"pixels","expression":{"parameters":["zoom"]}}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]}},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]}},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]}},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","expression":{"parameters":["zoom"]}},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"icon-size":{"type":"number","default":1,"minimum":0,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":[0.1,0.1],"maximum":[10,10],"expression":{}},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"appearance":true,"use-theme":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":[0.1,0.1],"maximum":[10,10],"expression":{}},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]}},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]}},"text-rotate":{"type":"number","default":0,"period":360,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_hillshade":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster-particle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_clip":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_model":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_building":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*"}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"high-color":{"type":"color","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"space-color":{"type":"color","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"horizon-blend":{"type":"number","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"snow":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.85],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.3],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.4,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,50],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"flake-size":{"type":"number","default":0.71,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"rain":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.5],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#03113d",0.3,"#a8adbc"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":["interpolate",["linear"],["measure-light","brightness"],0,0.88,1,0.7],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#001736",0.3,"#464646"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.57,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,80],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"droplet-size":{"type":"array","default":[2.6,18.2],"minimum":0,"maximum":50,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"distortion-strength":{"type":"number","default":0.7,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective"}},"colorTheme":{"data":{"type":"string","expression":{}}},"indoor_source":{"sourceId":{"type":"string"},"sourceLayers":{"type":"array","value":"string"}},"indoor":{"*":{"type":"indoor_source"}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator"},"center":{"type":"array","length":2,"value":"number","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string"},"exaggeration":{"type":"number","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_building","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-bridge-guard-rail-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"},"fill-tunnel-structure-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-height-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"flat"},"fill-extrusion-base-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"terrain"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"type":"color","default":"#ffffff","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"fill-extrusion-line-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-cast-shadows":{"type":"boolean","default":true}},"paint_building":{"building-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"parameters":[]},"transition":true},"building-ambient-occlusion-ground-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-cast-shadows":{"type":"boolean","default":true},"building-color":{"type":"color","default":"rgba(193, 154, 127, 1)","use-theme":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-emissive-strength":{"type":"number","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-facade-emissive-chance":{"type":"number","default":0.35,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["measure-light","zoom"]}},"building-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"building-flood-light-color":{"type":"color","default":"#ffffff","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"building-flood-light-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"building-flood-light-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light","line-progress"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-gradient":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["line-progress"]}},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1]},"line-trim-fade-range":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-trim-color":{"type":"color","default":"transparent","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-driven"},"line-border-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"use-theme":true,"expression":{"interpolated":true,"parameters":["heatmap-density"]}},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-image-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{}},"symbol-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-value"]}},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]}},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"raster-array-band":{"type":"string"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string"},"raster-particle-count":{"type":"number","default":512,"minimum":1},"raster-particle-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-particle-speed"]}},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1},"raster-particle-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-shadow-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-accent-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_background":{"background-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":[]}},"background-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]}},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]}},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]}},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"use-theme":true,"expression":{"interpolated":true,"parameters":["sky-radial-progress"]}},"sky-atmosphere-halo-color":{"type":"color","default":"white","use-theme":true},"sky-atmosphere-color":{"type":"color","default":"white","use-theme":true},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"property-type":"data-driven"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"use-theme":true,"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d"},"model-cast-shadows":{"type":"boolean","default":true},"model-receive-shadows":{"type":"boolean","default":true},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"model-front-cutoff":{"type":"array","value":"number","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]},"model-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","expression":{}}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"promoteId":{"*":{"type":"*"}}}');function Kg(n){return n instanceof Number||n instanceof String||n instanceof Boolean?n.valueOf():n}function kd(n){if(Array.isArray(n))return n.map(kd);if(n instanceof Object&&!(n instanceof Number||n instanceof String||n instanceof Boolean)){const e={};for(const i in n)e[i]=kd(n[i]);return e}return Kg(n)}function $s(n){if(n===!0||n===!1)return!0;if(!Array.isArray(n)||n.length===0)return!1;switch(n[0]){case"has":return n.length>=2&&n[1]!=="$id"&&n[1]!=="$type";case"in":return n.length>=3&&(typeof n[1]!="string"||Array.isArray(n[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return n.length!==3||Array.isArray(n[1])||Array.isArray(n[2]);case"any":case"all":for(const e of n.slice(1))if(!$s(e)&&typeof e!="boolean")return!1;return!0;default:return!0}}function Ld(n,e="",i=null,o="fill"){if(n==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};$s(n)||(n=zd(n));const l=n;let d=!0;try{d=function(E){if(!zc(E))return E;let I=kd(E);return Yg(I),I=Wl(I),I}(l)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(l,null,2)}
        `)}let f=null,_=null;if(o!=="background"&&o!=="sky"&&o!=="slot"){_=Se[`filter_${o}`];const E=ol(d,_,e,i);if(E.result==="error")throw new Error(E.value.map(I=>`${I.key}: ${I.message}`).join(", "));f=(I,C,R)=>E.value.evaluate(I,C,{},R)}let v=null,b=null;if(d!==l){const E=ol(l,_,e,i);if(E.result==="error")throw new Error(E.value.map(I=>`${I.key}: ${I.message}`).join(", "));v=(I,C,R,k,F)=>E.value.evaluate(I,C,{},R,void 0,void 0,k,F),b=!Sc(E.value.expression)}return{filter:f,dynamicFilter:v||void 0,needGeometry:Jg(d),needFeature:!!b}}function Wl(n){if(!Array.isArray(n))return n;const e=function(i){if(Yv.has(i[0])){for(let o=1;o<i.length;o++)if(zc(i[o]))return!0}return i}(n);return e===!0?e:e.map(i=>Wl(i))}function Yg(n){let e=!1;const i=[];if(n[0]==="case"){for(let o=1;o<n.length-1;o+=2)e=e||zc(n[o]),i.push(n[o+1]);i.push(n[n.length-1])}else if(n[0]==="match"){e=e||zc(n[1]);for(let o=2;o<n.length-1;o+=2)i.push(n[o+1]);i.push(n[n.length-1])}else if(n[0]==="step"){e=e||zc(n[1]);for(let o=1;o<n.length-1;o+=2)i.push(n[o+1])}e&&(n.length=0,n.push("any",...i));for(let o=1;o<n.length;o++)Yg(n[o])}function zc(n){if(!Array.isArray(n))return!1;if((e=n[0])==="pitch"||e==="distance-from-center")return!0;var e;for(let i=1;i<n.length;i++)if(zc(n[i]))return!0;return!1}const Yv=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function Jv(n,e){return n<e?-1:n>e?1:0}function Jg(n){if(!Array.isArray(n))return!1;if(n[0]==="within"||n[0]==="distance")return!0;for(let e=1;e<n.length;e++)if(Jg(n[e]))return!0;return!1}function zd(n){if(!n)return!0;const e=n[0];return n.length<=1?e!=="any":e==="=="?Dd(n[1],n[2],"=="):e==="!="?Ju(Dd(n[1],n[2],"==")):e==="<"||e===">"||e==="<="||e===">="?Dd(n[1],n[2],e):e==="any"?(i=n.slice(1),["any"].concat(i.map(zd))):e==="all"?["all"].concat(n.slice(1).map(zd)):e==="none"?["all"].concat(n.slice(1).map(zd).map(Ju)):e==="in"?Od(n[1],n.slice(2)):e==="!in"?Ju(Od(n[1],n.slice(2))):e==="has"?Fd(n[1]):e!=="!has"||Ju(Fd(n[1]));var i}function Dd(n,e,i){switch(n){case"$type":return[`filter-type-${i}`,e];case"$id":return[`filter-id-${i}`,e];default:return[`filter-${i}`,n,e]}}function Od(n,e){if(e.length===0)return!1;switch(n){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some(i=>typeof i!=typeof e[0])?["filter-in-large",n,["literal",e.sort(Jv)]]:["filter-in-small",n,["literal",e]]}}function Fd(n){switch(n){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",n]}}function Ju(n){return["!",n]}const Zl="";function xs(n,e){return e?`${n}${Zl}${e}`:n}let Qg;const ey=()=>Qg||(Qg=new Bn({"icon-size":new _t(Se.layout_symbol["icon-size"]),"icon-image":new _t(Se.layout_symbol["icon-image"]),"icon-rotate":new _t(Se.layout_symbol["icon-rotate"]),"icon-offset":new _t(Se.layout_symbol["icon-offset"]),"text-size":new _t(Se.layout_symbol["text-size"]),"text-rotate":new _t(Se.layout_symbol["text-rotate"]),"text-offset":new _t(Se.layout_symbol["text-offset"])}));class ty{constructor(e,i,o,l,d,f){const _=ol(e,Se.appearance.condition);if(_.result==="success"&&(this.condition=_.value),this.name=i,o){this.properties=new Hl(ey()),this.unevaluatedLayout=new Xg(ey(),l,d,f);for(const v in o)this.unevaluatedLayout.setValue(v,o[v])}}isActive(e){return!(this.condition||!e.isHidden||this.name!=="hidden")||this.condition.evaluate(e.globals,e.feature,e.featureState,e.canonical)}getCondition(){return this.condition}getName(){return this.name}getProperty(e){return this.properties.get(e)}getUnevaluatedProperties(){return this.unevaluatedLayout}getUnevaluatedProperty(e){return this.unevaluatedLayout._values[e]}recalculate(e,i,o){this.unevaluatedLayout&&(this.properties=this.unevaluatedLayout.possiblyEvaluate(e,void 0,i,o))}serialize(){const e={};return e.condition=this.condition.expression.serialize(),this.name&&(e.name=this.name),this.unevaluatedLayout&&(e.properties=this.unevaluatedLayout.serialize()),e}hasIconProperties(){const e=this.hasProperty("icon-image"),i=this.hasProperty("icon-size"),o=this.hasProperty("icon-offset"),l=this.hasProperty("icon-rotate");return e||i||o||l}hasTextProperties(){const e=this.hasProperty("text-size"),i=this.hasProperty("text-offset"),o=this.hasProperty("text-rotate");return e||i||o}hasProperty(e){return this.getUnevaluatedProperty(e).value!==void 0}}const iy="-transition",Gs=new Set(["fill","line","background","hillshade","raster"]);class lo extends Ol{constructor(e,i,o,l,d,f){if(super(),this.id=e.id,this.fqid=xs(this.id,o),this.type=e.type,this.scope=o,this.lut=l,this.options=d,this.iconImageUseTheme=f,this.appearances=new Array,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.expressionDependencies={isIndoorDependent:!1,configDependencies:new Set},e.type!=="custom"){if(this.metadata=e.metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,e.type&&e.type!=="background"&&e.type!=="sky"&&e.type!=="slot"){this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter;const _=ol(this.filter,Se[`filter_${e.type}`]);_.result!=="error"&&(this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,..._.value.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||_.value.isIndoorDependent)}if(e.slot&&(this.slot=e.slot),e.appearances&&this.setAppearances(e.appearances),i.layout&&(this._unevaluatedLayout=new Xg(i.layout,this.scope,d,this.iconImageUseTheme),this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...this._unevaluatedLayout.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||this._unevaluatedLayout.isIndoorDependent()),i.paint){this._transitionablePaint=new qg(i.paint,this.scope,d);for(const _ in e.paint)this.setPaintProperty(_,e.paint[_]);for(const _ in e.layout)this.setLayoutProperty(_,e.layout[_]);this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...this._transitionablePaint.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||this._transitionablePaint.isIndoorDependent(),this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new Hl(i.paint)}}}onAdd(e){}onRemove(e){}isDraped(e){return!this.is3D(!0)&&Gs.has(this.type)}getLayoutProperty(e){return e==="visibility"?this.visibility:this._unevaluatedLayout.getValue(e)}setLayoutProperty(e,i){if(this.type==="custom"&&e==="visibility")return void(this.visibility=i);const o=this._unevaluatedLayout;o._properties.properties[e]&&(o.setValue(e,i),this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...o.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||o.isIndoorDependent(),e==="visibility"&&this.possiblyEvaluateVisibility())}setAppearances(e){this.appearances=[],e.forEach(i=>{this.appearances.push(new ty(i.condition,i.name,i.properties,this.scope,this.options,this.iconImageUseTheme))})}possiblyEvaluateVisibility(){this._unevaluatedLayout._values.visibility&&(this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0}))}getPaintProperty(e){return e.endsWith(iy)?this._transitionablePaint.getTransition(e.slice(0,-11)):this._transitionablePaint.getValue(e)}isPaintProperty(e){return!!this._transitionablePaint._properties.properties[e]}setPaintProperty(e,i){const o=this._transitionablePaint,l=o._properties.properties;if(e.endsWith(iy)){const I=e.slice(0,-11);return l[I]&&o.setTransition(I,i||void 0),!1}if(!l[e])return!1;const d=o._values[e],f=d.value.isDataDriven(),_=d.value;o.setValue(e,i),this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...o.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||o.isIndoorDependent(),this._handleSpecialPaintPropertyUpdate(e);const v=o._values[e].value,b=v.isDataDriven(),E=e.endsWith("pattern")||e==="line-dasharray";return b||f||E||this._handleOverridablePaintPropertyUpdate(e,_,v)}_handleSpecialPaintPropertyUpdate(e){}getProgramIds(){return null}getDefaultProgramParams(e,i,o){return null}_handleOverridablePaintPropertyUpdate(e,i,o){return!1}isHidden(e){return!!(this.minzoom&&e<this.minzoom)||!!(this.maxzoom&&e>=this.maxzoom)||this.visibility==="none"}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(e,i){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,i,this.iconImageUseTheme)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,i)}serialize(){const e={id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.appearances.length!==0&&(e.appearances=this.appearances.map(i=>i.serialize())),rt(e,(i,o)=>!(i===void 0||o==="layout"&&!Object.keys(i).length||o==="paint"&&!Object.keys(i).length))}is3D(e){return!1}hasElevation(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}_clear(){}isStateDependent(){for(const e in this.paint._values){const i=this.paint.get(e);if(i instanceof Gl&&qu(i.property.specification)&&(i.value.kind==="source"||i.value.kind==="composite")&&i.value.isStateDependent)return!0}for(const e of this.appearances)if(!ju(e.condition.expression))return!0;return!1}compileFilter(e){this._filterCompiled||(this._featureFilter=Ld(this.filter,this.scope,e),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(e){this._stats&&(e.renderPass==="shadow"?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}getAppearances(){return this.appearances}queryRenderedFeatures(e,i,o){return{}}queryRadius(e){}queryIntersectsFeature(e,i,o,l,d,f,_,v,b){}}const ny={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Qu{constructor(e,i){this._structArray=e,this._pos1=i*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}const Qv=new ArrayBuffer(0);class vn{constructor(){this._reallocCount=0,this.capacity=0,this.length=0}static serialize(e,i){return e._trim(),i&&e.arrayBuffer&&i.add(e.arrayBuffer),{length:e.length,arrayBuffer:e.arrayBuffer}}static deserialize(e){const i=Object.create(this.prototype);return i.arrayBuffer=e.arrayBuffer,i.length=e.length,e.arrayBuffer?i.capacity=e.arrayBuffer.byteLength/i.bytesPerElement:(i.capacity=0,i.arrayBuffer=Qv),i._refreshViews(),i}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(e){this.reserve(e),this.length=e}reserve(e){if(e>this.capacity){this._reallocCount++,this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const i=this.uint8;this._refreshViews(),i&&this.uint8.set(i)}}reserveForAdditional(e){this.reserve(this.length+e)}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...e){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...e){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function _i(n,e=1){let i=0,o=0;return{members:n.map(l=>{const d=ny[l.type].BYTES_PER_ELEMENT,f=i=ry(i,Math.max(e,d)),_=l.components||1;return o=Math.max(o,d),i+=d*_,{name:l.name,type:l.type,components:_,offset:f}}),size:ry(i,Math.max(o,e)),alignment:e}}function ry(n,e){return Math.ceil(n/e)*e}class al extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i){const o=this.length;return this.resize(o+1),this.emplace(o,e,i)}emplace(e,i,o){const l=2*e;return this.int16[l+0]=i,this.int16[l+1]=o,e}}al.prototype.bytesPerElement=4,It(al,"StructArrayLayout2i4");class Dc extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o){const l=this.length;return this.resize(l+1),this.emplace(l,e,i,o)}emplace(e,i,o,l){const d=3*e;return this.int16[d+0]=i,this.int16[d+1]=o,this.int16[d+2]=l,e}}Dc.prototype.bytesPerElement=6,It(Dc,"StructArrayLayout3i6");class Oc extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o,l){const d=this.length;return this.resize(d+1),this.emplace(d,e,i,o,l)}emplace(e,i,o,l,d){const f=4*e;return this.int16[f+0]=i,this.int16[f+1]=o,this.int16[f+2]=l,this.int16[f+3]=d,e}}Oc.prototype.bytesPerElement=8,It(Oc,"StructArrayLayout4i8");class _a extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.float32[1*e+0]=i,e}}_a.prototype.bytesPerElement=4,It(_a,"StructArrayLayout1f4");class em extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o){const l=this.length;return this.resize(l+1),this.emplace(l,e,i,o)}emplace(e,i,o,l){const d=4*e,f=2*e;return this.int16[d+0]=i,this.int16[d+1]=o,this.float32[f+1]=l,e}}em.prototype.bytesPerElement=8,It(em,"StructArrayLayout2i1f8");class tm extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o){const l=this.length;return this.resize(l+1),this.emplace(l,e,i,o)}emplace(e,i,o,l){const d=4*e;return this.int16[d+0]=i,this.int16[d+1]=o,this.int16[d+2]=l,e}}tm.prototype.bytesPerElement=8,It(tm,"StructArrayLayout3i8");class im extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o,l,d){const f=this.length;return this.resize(f+1),this.emplace(f,e,i,o,l,d)}emplace(e,i,o,l,d,f){const _=5*e;return this.int16[_+0]=i,this.int16[_+1]=o,this.int16[_+2]=l,this.int16[_+3]=d,this.int16[_+4]=f,e}}im.prototype.bytesPerElement=10,It(im,"StructArrayLayout5i10");class Bd extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,l,d,f,_){const v=this.length;return this.resize(v+1),this.emplace(v,e,i,o,l,d,f,_)}emplace(e,i,o,l,d,f,_,v){const b=6*e,E=12*e,I=3*e;return this.int16[b+0]=i,this.int16[b+1]=o,this.uint8[E+4]=l,this.uint8[E+5]=d,this.uint8[E+6]=f,this.uint8[E+7]=_,this.float32[I+2]=v,e}}Bd.prototype.bytesPerElement=12,It(Bd,"StructArrayLayout2i4ub1f12");class Fo extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o){const l=this.length;return this.resize(l+1),this.emplace(l,e,i,o)}emplace(e,i,o,l){const d=3*e;return this.float32[d+0]=i,this.float32[d+1]=o,this.float32[d+2]=l,e}}Fo.prototype.bytesPerElement=12,It(Fo,"StructArrayLayout3f12");class yo extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,l,d){const f=this.length;return this.resize(f+1),this.emplace(f,e,i,o,l,d)}emplace(e,i,o,l,d,f){const _=6*e,v=3*e;return this.uint16[_+0]=i,this.uint16[_+1]=o,this.uint16[_+2]=l,this.uint16[_+3]=d,this.float32[v+2]=f,e}}yo.prototype.bytesPerElement=12,It(yo,"StructArrayLayout4ui1f12");class Xl extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,o,l){const d=this.length;return this.resize(d+1),this.emplace(d,e,i,o,l)}emplace(e,i,o,l,d){const f=4*e;return this.uint16[f+0]=i,this.uint16[f+1]=o,this.uint16[f+2]=l,this.uint16[f+3]=d,e}}Xl.prototype.bytesPerElement=8,It(Xl,"StructArrayLayout4ui8");class Nd extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o,l,d,f){const _=this.length;return this.resize(_+1),this.emplace(_,e,i,o,l,d,f)}emplace(e,i,o,l,d,f,_){const v=6*e;return this.int16[v+0]=i,this.int16[v+1]=o,this.int16[v+2]=l,this.int16[v+3]=d,this.int16[v+4]=f,this.int16[v+5]=_,e}}Nd.prototype.bytesPerElement=12,It(Nd,"StructArrayLayout6i12");class nm extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,o,l,d,f,_,v,b,E,I,C){const R=this.length;return this.resize(R+1),this.emplace(R,e,i,o,l,d,f,_,v,b,E,I,C)}emplace(e,i,o,l,d,f,_,v,b,E,I,C,R){const k=12*e;return this.int16[k+0]=i,this.int16[k+1]=o,this.int16[k+2]=l,this.int16[k+3]=d,this.uint16[k+4]=f,this.uint16[k+5]=_,this.uint16[k+6]=v,this.uint16[k+7]=b,this.int16[k+8]=E,this.int16[k+9]=I,this.int16[k+10]=C,this.int16[k+11]=R,e}}nm.prototype.bytesPerElement=24,It(nm,"StructArrayLayout4i4ui4i24");class rm extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,l,d,f){const _=this.length;return this.resize(_+1),this.emplace(_,e,i,o,l,d,f)}emplace(e,i,o,l,d,f,_){const v=10*e,b=5*e;return this.int16[v+0]=i,this.int16[v+1]=o,this.int16[v+2]=l,this.float32[b+2]=d,this.float32[b+3]=f,this.float32[b+4]=_,e}}rm.prototype.bytesPerElement=20,It(rm,"StructArrayLayout3i3f20");class ll extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,l){const d=this.length;return this.resize(d+1),this.emplace(d,e,i,o,l)}emplace(e,i,o,l,d){const f=4*e;return this.float32[f+0]=i,this.float32[f+1]=o,this.float32[f+2]=l,this.float32[f+3]=d,e}}ll.prototype.bytesPerElement=16,It(ll,"StructArrayLayout4f16");class jd extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint32[1*e+0]=i,e}}jd.prototype.bytesPerElement=4,It(jd,"StructArrayLayout1ul4");class Bo extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i){const o=this.length;return this.resize(o+1),this.emplace(o,e,i)}emplace(e,i,o){const l=2*e;return this.uint16[l+0]=i,this.uint16[l+1]=o,e}}Bo.prototype.bytesPerElement=4,It(Bo,"StructArrayLayout2ui4");class Ud extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,o,l,d,f,_,v,b,E,I,C,R){const k=this.length;return this.resize(k+1),this.emplace(k,e,i,o,l,d,f,_,v,b,E,I,C,R)}emplace(e,i,o,l,d,f,_,v,b,E,I,C,R,k){const F=20*e,U=10*e;return this.int16[F+0]=i,this.int16[F+1]=o,this.int16[F+2]=l,this.int16[F+3]=d,this.int16[F+4]=f,this.float32[U+3]=_,this.float32[U+4]=v,this.float32[U+5]=b,this.float32[U+6]=E,this.int16[F+14]=I,this.uint32[U+8]=C,this.uint16[F+18]=R,this.uint16[F+19]=k,e}}Ud.prototype.bytesPerElement=40,It(Ud,"StructArrayLayout5i4f1i1ul2ui40");class Vd extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o,l,d,f,_){const v=this.length;return this.resize(v+1),this.emplace(v,e,i,o,l,d,f,_)}emplace(e,i,o,l,d,f,_,v){const b=8*e;return this.int16[b+0]=i,this.int16[b+1]=o,this.int16[b+2]=l,this.int16[b+4]=d,this.int16[b+5]=f,this.int16[b+6]=_,this.int16[b+7]=v,e}}Vd.prototype.bytesPerElement=16,It(Vd,"StructArrayLayout3i2i2i16");class $d extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o,l,d){const f=this.length;return this.resize(f+1),this.emplace(f,e,i,o,l,d)}emplace(e,i,o,l,d,f){const _=4*e,v=8*e;return this.float32[_+0]=i,this.float32[_+1]=o,this.float32[_+2]=l,this.int16[v+6]=d,this.int16[v+7]=f,e}}$d.prototype.bytesPerElement=16,It($d,"StructArrayLayout2f1f2i16");class om extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,l,d,f){const _=this.length;return this.resize(_+1),this.emplace(_,e,i,o,l,d,f)}emplace(e,i,o,l,d,f,_){const v=20*e,b=5*e;return this.uint8[v+0]=i,this.uint8[v+1]=o,this.float32[b+1]=l,this.float32[b+2]=d,this.float32[b+3]=f,this.float32[b+4]=_,e}}om.prototype.bytesPerElement=20,It(om,"StructArrayLayout2ub4f20");class sr extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,o){const l=this.length;return this.resize(l+1),this.emplace(l,e,i,o)}emplace(e,i,o,l){const d=3*e;return this.uint16[d+0]=i,this.uint16[d+1]=o,this.uint16[d+2]=l,e}}sr.prototype.bytesPerElement=6,It(sr,"StructArrayLayout3ui6");class Fc extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,i,o,l,d,f,_,v,b,E,I,C,R,k,F,U,j,H,W,Y,se){const ie=this.length;return this.resize(ie+1),this.emplace(ie,e,i,o,l,d,f,_,v,b,E,I,C,R,k,F,U,j,H,W,Y,se)}emplace(e,i,o,l,d,f,_,v,b,E,I,C,R,k,F,U,j,H,W,Y,se,ie){const ce=30*e,fe=15*e,ge=60*e;return this.int16[ce+0]=i,this.int16[ce+1]=o,this.int16[ce+2]=l,this.float32[fe+2]=d,this.float32[fe+3]=f,this.uint16[ce+8]=_,this.uint16[ce+9]=v,this.uint32[fe+5]=b,this.uint32[fe+6]=E,this.uint32[fe+7]=I,this.uint16[ce+16]=C,this.uint16[ce+17]=R,this.uint16[ce+18]=k,this.float32[fe+10]=F,this.float32[fe+11]=U,this.uint8[ge+48]=j,this.uint8[ge+49]=H,this.uint8[ge+50]=W,this.uint32[fe+13]=Y,this.int16[ce+28]=se,this.uint8[ge+58]=ie,e}}Fc.prototype.bytesPerElement=60,It(Fc,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class sm extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,i,o,l,d,f,_,v,b,E,I,C,R,k,F,U,j,H,W,Y,se,ie,ce,fe,ge,Fe,be,Ue,He,qe,tt,nt,Ye){const Je=this.length;return this.resize(Je+1),this.emplace(Je,e,i,o,l,d,f,_,v,b,E,I,C,R,k,F,U,j,H,W,Y,se,ie,ce,fe,ge,Fe,be,Ue,He,qe,tt,nt,Ye)}emplace(e,i,o,l,d,f,_,v,b,E,I,C,R,k,F,U,j,H,W,Y,se,ie,ce,fe,ge,Fe,be,Ue,He,qe,tt,nt,Ye,Je){const je=20*e,Be=40*e,Qe=80*e;return this.float32[je+0]=i,this.float32[je+1]=o,this.int16[Be+4]=l,this.int16[Be+5]=d,this.int16[Be+6]=f,this.int16[Be+7]=_,this.int16[Be+8]=v,this.int16[Be+9]=b,this.int16[Be+10]=E,this.int16[Be+11]=I,this.int16[Be+12]=C,this.uint16[Be+13]=R,this.uint16[Be+14]=k,this.uint16[Be+15]=F,this.uint16[Be+16]=U,this.uint16[Be+17]=j,this.uint16[Be+18]=H,this.uint16[Be+19]=W,this.uint16[Be+20]=Y,this.uint16[Be+21]=se,this.uint16[Be+22]=ie,this.uint16[Be+23]=ce,this.uint16[Be+24]=fe,this.uint16[Be+25]=ge,this.uint16[Be+26]=Fe,this.uint16[Be+27]=be,this.uint32[je+14]=Ue,this.float32[je+15]=He,this.float32[je+16]=qe,this.float32[je+17]=tt,this.float32[je+18]=nt,this.uint8[Qe+76]=Ye,this.uint16[Be+39]=Je,e}}sm.prototype.bytesPerElement=80,It(sm,"StructArrayLayout2f9i15ui1ul4f1ub1ui80");class am extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,l,d,f){const _=this.length;return this.resize(_+1),this.emplace(_,e,i,o,l,d,f)}emplace(e,i,o,l,d,f,_){const v=6*e;return this.float32[v+0]=i,this.float32[v+1]=o,this.float32[v+2]=l,this.float32[v+3]=d,this.float32[v+4]=f,this.float32[v+5]=_,e}}am.prototype.bytesPerElement=24,It(am,"StructArrayLayout6f24");class Kl extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,l,d){const f=this.length;return this.resize(f+1),this.emplace(f,e,i,o,l,d)}emplace(e,i,o,l,d,f){const _=5*e;return this.float32[_+0]=i,this.float32[_+1]=o,this.float32[_+2]=l,this.float32[_+3]=d,this.float32[_+4]=f,e}}Kl.prototype.bytesPerElement=20,It(Kl,"StructArrayLayout5f20");class lm extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,l,d,f,_){const v=this.length;return this.resize(v+1),this.emplace(v,e,i,o,l,d,f,_)}emplace(e,i,o,l,d,f,_,v){const b=7*e;return this.float32[b+0]=i,this.float32[b+1]=o,this.float32[b+2]=l,this.float32[b+3]=d,this.float32[b+4]=f,this.float32[b+5]=_,this.float32[b+6]=v,e}}lm.prototype.bytesPerElement=28,It(lm,"StructArrayLayout7f28");class cm extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,l,d,f,_,v,b,E,I){const C=this.length;return this.resize(C+1),this.emplace(C,e,i,o,l,d,f,_,v,b,E,I)}emplace(e,i,o,l,d,f,_,v,b,E,I,C){const R=11*e;return this.float32[R+0]=i,this.float32[R+1]=o,this.float32[R+2]=l,this.float32[R+3]=d,this.float32[R+4]=f,this.float32[R+5]=_,this.float32[R+6]=v,this.float32[R+7]=b,this.float32[R+8]=E,this.float32[R+9]=I,this.float32[R+10]=C,e}}cm.prototype.bytesPerElement=44,It(cm,"StructArrayLayout11f44");class Bc extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,l,d,f,_,v,b){const E=this.length;return this.resize(E+1),this.emplace(E,e,i,o,l,d,f,_,v,b)}emplace(e,i,o,l,d,f,_,v,b,E){const I=9*e;return this.float32[I+0]=i,this.float32[I+1]=o,this.float32[I+2]=l,this.float32[I+3]=d,this.float32[I+4]=f,this.float32[I+5]=_,this.float32[I+6]=v,this.float32[I+7]=b,this.float32[I+8]=E,e}}Bc.prototype.bytesPerElement=36,It(Bc,"StructArrayLayout9f36");class Hs extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i){const o=this.length;return this.resize(o+1),this.emplace(o,e,i)}emplace(e,i,o){const l=2*e;return this.float32[l+0]=i,this.float32[l+1]=o,e}}Hs.prototype.bytesPerElement=8,It(Hs,"StructArrayLayout2f8");class vo extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,o,l){const d=this.length;return this.resize(d+1),this.emplace(d,e,i,o,l)}emplace(e,i,o,l,d){const f=6*e;return this.uint32[3*e+0]=i,this.uint16[f+2]=o,this.uint16[f+3]=l,this.uint16[f+4]=d,e}}vo.prototype.bytesPerElement=12,It(vo,"StructArrayLayout1ul3ui12");class cl extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint16[1*e+0]=i,e}}cl.prototype.bytesPerElement=2,It(cl,"StructArrayLayout1ui2");class um extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,l,d,f,_,v,b,E,I,C,R,k,F,U){const j=this.length;return this.resize(j+1),this.emplace(j,e,i,o,l,d,f,_,v,b,E,I,C,R,k,F,U)}emplace(e,i,o,l,d,f,_,v,b,E,I,C,R,k,F,U,j){const H=16*e;return this.float32[H+0]=i,this.float32[H+1]=o,this.float32[H+2]=l,this.float32[H+3]=d,this.float32[H+4]=f,this.float32[H+5]=_,this.float32[H+6]=v,this.float32[H+7]=b,this.float32[H+8]=E,this.float32[H+9]=I,this.float32[H+10]=C,this.float32[H+11]=R,this.float32[H+12]=k,this.float32[H+13]=F,this.float32[H+14]=U,this.float32[H+15]=j,e}}um.prototype.bytesPerElement=64,It(um,"StructArrayLayout16f64");class Gd extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,l,d,f,_){const v=this.length;return this.resize(v+1),this.emplace(v,e,i,o,l,d,f,_)}emplace(e,i,o,l,d,f,_,v){const b=10*e,E=5*e;return this.uint16[b+0]=i,this.uint16[b+1]=o,this.uint16[b+2]=l,this.uint16[b+3]=d,this.float32[E+2]=f,this.float32[E+3]=_,this.float32[E+4]=v,e}}Gd.prototype.bytesPerElement=20,It(Gd,"StructArrayLayout4ui3f20");class hm extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.int16[1*e+0]=i,e}}hm.prototype.bytesPerElement=2,It(hm,"StructArrayLayout1i2");class Hd extends vn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint8[1*e+0]=i,e}}Hd.prototype.bytesPerElement=1,It(Hd,"StructArrayLayout1ub1");class qd extends Qu{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}qd.prototype.size=40;class oy extends Ud{get(e){return new qd(this,e)}}It(oy,"CollisionBoxArray");class Wd extends Qu{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(e){this._structArray.uint8[this._pos1+49]=e}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(e){this._structArray.uint8[this._pos1+50]=e}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(e){this._structArray.uint32[this._pos4+13]=e}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(e){this._structArray.uint8[this._pos1+58]=e}}Wd.prototype.size=60;class sy extends Fc{get(e){return new Wd(this,e)}}It(sy,"PlacedSymbolArray");class ay extends Qu{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(e){this._structArray.uint32[this._pos4+14]=e}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(e){this._structArray.float32[this._pos4+18]=e}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}get elevationFeatureIndex(){return this._structArray.uint16[this._pos2+39]}}ay.prototype.size=80;class dm extends sm{get(e){return new ay(this,e)}}It(dm,"SymbolInstanceArray");class Zd extends _a{getoffsetX(e){return this.float32[1*e+0]}}It(Zd,"GlyphOffsetArray");class ly extends al{getx(e){return this.int16[2*e+0]}gety(e){return this.int16[2*e+1]}}It(ly,"SymbolLineVertexArray");class fm extends Qu{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}fm.prototype.size=12;class pm extends vo{get(e){return new fm(this,e)}}It(pm,"FeatureIndexArray");class cy extends Bo{geta_centroid_pos0(e){return this.uint16[2*e+0]}geta_centroid_pos1(e){return this.uint16[2*e+1]}}It(cy,"FillExtrusionCentroidArray");class Xd extends Qu{get a_join_normal_inside0(){return this._structArray.int16[this._pos2+0]}get a_join_normal_inside1(){return this._structArray.int16[this._pos2+1]}get a_join_normal_inside2(){return this._structArray.int16[this._pos2+2]}}Xd.prototype.size=6;class eh extends Dc{get(e){return new Xd(this,e)}}It(eh,"FillExtrusionWallArray");const uy=_i([{name:"a_pos",components:2,type:"Int16"}],4),ex=_i([{name:"a_circle_z_offset",components:1,type:"Float32"}],4),hy=_i([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class An{constructor(e=[]){this.segments=e}_prepareSegment(e,i,o,l){let d=this.segments[this.segments.length-1];return e>An.MAX_VERTEX_ARRAY_LENGTH&&bt(`Max vertices per segment is ${An.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${e}`),(!d||d.vertexLength+e>An.MAX_VERTEX_ARRAY_LENGTH||d.sortKey!==l)&&(d={vertexOffset:i,primitiveOffset:o,vertexLength:0,primitiveLength:0},l!==void 0&&(d.sortKey=l),this.segments.push(d)),d}prepareSegment(e,i,o,l){return this._prepareSegment(e,i.length,o.length,l)}get(){return this.segments}destroy(){for(const e of this.segments)for(const i in e.vaos)e.vaos[i].destroy()}static simpleSegment(e,i,o,l){return new An([{vertexOffset:e,primitiveOffset:i,vertexLength:o,primitiveLength:l,vaos:{},sortKey:0}])}}function Kd(n,e){return 256*(n=V(Math.floor(n),0,255))+V(Math.floor(e),0,255)}An.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,It(An,"SegmentVector");const tx=_i([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),ix=_i([{name:"a_pattern_b",components:4,type:"Uint16"}]),nx=_i([{name:"a_dash",components:4,type:"Uint16"}]);class th{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(e,i,o,l){this.ids.push(mm(e)),this.positions.push(i,o,l)}eachPosition(e,i){const o=mm(e);let l=0,d=this.ids.length-1;for(;l<d;){const f=l+d>>1;this.ids[f]>=o?d=f:l=f+1}for(;this.ids[l]===o;)i(this.positions[3*l],this.positions[3*l+1],this.positions[3*l+2]),l++}static serialize(e,i){const o=new Float64Array(e.ids),l=new Uint32Array(e.positions);return _m(o,l,0,o.length-1),i&&(i.add(o.buffer),i.add(l.buffer)),{ids:o,positions:l}}static deserialize(e){const i=new th;let o;i.ids=e.ids,i.positions=e.positions;for(const l of i.ids)l!==o&&i.uniqueIds.push(l),o=l;return i.indexed=!0,i}}function mm(n){const e=+n;return Number.isSafeInteger(e)?e:qh(String(n))}function _m(n,e,i,o){for(;i<o;){const l=n[i+o>>1];let d=i-1,f=o+1;for(;;){do d++;while(n[d]<l);do f--;while(n[f]>l);if(d>=f)break;Yd(n,d,f),Yd(e,3*d,3*f),Yd(e,3*d+1,3*f+1),Yd(e,3*d+2,3*f+2)}f-i<o-f?(_m(n,e,i,f),i=f+1):(_m(n,e,f+1,o),o=f)}}function Yd(n,e,i){const o=n[e];n[e]=n[i],n[i]=o}It(th,"FeaturePositionMap");class ga{constructor(e){this.gl=e.gl,this.initialized=!1}fetchUniformLocation(e,i){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(e,i),this.initialized=!0),!!this.location}set(e,i,o){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class Jd extends ga{constructor(e){super(e),this.current=0}set(e,i,o){this.fetchUniformLocation(e,i)&&this.current!==o&&(this.current=o,this.gl.uniform1i(this.location,o))}}class ar extends ga{constructor(e){super(e),this.current=0}set(e,i,o){this.fetchUniformLocation(e,i)&&this.current!==o&&(this.current=o,this.gl.uniform1f(this.location,o))}}class qs extends ga{constructor(e){super(e),this.current=[0,0]}set(e,i,o){this.fetchUniformLocation(e,i)&&(o[0]===this.current[0]&&o[1]===this.current[1]||(this.current=o,this.gl.uniform2f(this.location,o[0],o[1])))}}class ih extends ga{constructor(e){super(e),this.current=[0,0,0]}set(e,i,o){this.fetchUniformLocation(e,i)&&(o[0]===this.current[0]&&o[1]===this.current[1]&&o[2]===this.current[2]||(this.current=o,this.gl.uniform3f(this.location,o[0],o[1],o[2])))}}class Qd extends ga{constructor(e){super(e),this.current=[0,0,0,0]}set(e,i,o){this.fetchUniformLocation(e,i)&&(o[0]===this.current[0]&&o[1]===this.current[1]&&o[2]===this.current[2]&&o[3]===this.current[3]||(this.current=o,this.gl.uniform4f(this.location,o[0],o[1],o[2],o[3])))}}class nh extends ga{constructor(e){super(e),this.current=Zi.transparent.toPremultipliedRenderColor(null)}set(e,i,o){this.fetchUniformLocation(e,i)&&(o.r===this.current.r&&o.g===this.current.g&&o.b===this.current.b&&o.a===this.current.a||(this.current=o,this.gl.uniform4f(this.location,o.r,o.g,o.b,o.a)))}}const rx=new Float32Array(16);class rh extends ga{constructor(e){super(e),this.current=rx}set(e,i,o){if(this.fetchUniformLocation(e,i)){if(o[12]!==this.current[12]||o[0]!==this.current[0])return this.current=o,void this.gl.uniformMatrix4fv(this.location,!1,o);for(let l=1;l<16;l++)if(o[l]!==this.current[l]){this.current=o,this.gl.uniformMatrix4fv(this.location,!1,o);break}}}}const ef=new Float32Array(9),ox=new Float32Array(4);class tf extends ga{constructor(e){super(e),this.current=ox}set(e,i,o){if(this.fetchUniformLocation(e,i)){for(let l=0;l<4;l++)if(o[l]!==this.current[l]){this.current=o,this.gl.uniformMatrix2fv(this.location,!1,o);break}}}}function gm(n){return[Kd(255*n.r,255*n.g),Kd(255*n.b,255*n.a)]}function oh(n,e,i,o,l,d,f,_){return!!n&&(n.kind==="composite"||n.kind==="source"?n.evaluate(new fn(0,{brightness:d,worldview:_}),e,i,l,o,f)==="none":n.value==="none")}class sh{constructor(e,i,o,l){this.value=e,this.uniformNames=i.map(d=>`u_${d}`),this.type=o,this.context=l}setUniform(e,i,o,l,d){const f=l.constantOr(this.value);i.set(e,d,f instanceof Zi?f.toPremultipliedRenderColor(this.lutExpression&&this.lutExpression.kind==="constant"&&this.lutExpression.value==="none"?null:this.context.lut):f)}getBinding(e,i){return this.type==="color"?new nh(e):new ar(e)}}class Nc{constructor(e,i){this.uniformNames=i.map(o=>`u_${o}`),this.pattern=null,this.patternTransition=null,this.pixelRatio=1}setConstantPatternPositions(e,i){this.pixelRatio=e.pixelRatio||1,this.pattern=e.tl.concat(e.br),this.patternTransition=i?i.tl.concat(i.br):this.pattern}setUniform(e,i,o,l,d){let f=null;d!=="u_pattern"&&d!=="u_dash"||(f=this.pattern),d==="u_pattern_b"&&(f=this.patternTransition),d==="u_pixel_ratio"&&(f=this.pixelRatio),f&&i.set(e,d,f)}getBinding(e,i){return i==="u_pattern"||i==="u_pattern_b"||i==="u_dash"?new Qd(e):new ar(e)}}class ya{constructor(e,i,o,l){this.expression=e,this.type=o,this.maxValue=0,this.paintVertexAttributes=i.map(d=>({name:`a_${d}`,type:"Float32",components:o==="color"?2:1,offset:0})),this.paintVertexArray=new l}populatePaintArray(e,i,o,l,d,f,_,v){const b=this.paintVertexArray.length,E=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate(new fn(0,{brightness:f,worldview:v}),i,{},d,l,_):this.expression.kind==="constant"&&this.expression.value,I=oh(this.lutExpression,i,{},l,d,f,_,v);this.paintVertexArray.resize(e),this._setPaintValue(b,e,E,I?null:this.context.lut)}updatePaintArray(e,i,o,l,d,f,_,v){const b=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate({zoom:0,brightness:_,worldview:v},o,l,void 0,d):this.expression.kind==="constant"&&this.expression.value,E=oh(this.lutExpression,o,l,d,void 0,_,void 0,v);this._setPaintValue(e,i,b,E?null:this.context.lut)}_setPaintValue(e,i,o,l){if(this.type==="color"){const d=gm(o.toPremultipliedRenderColor(l));for(let f=e;f<i;f++)this.paintVertexArray.emplace(f,d[0],d[1])}else{for(let d=e;d<i;d++)this.paintVertexArray.emplace(d,o);this.maxValue=Math.max(this.maxValue,Math.abs(o))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.lutExpression&&this.lutExpression.kind!=="constant"&&(this.lutExpression.isStateDependent||!this.lutExpression.isLightConstant)||this.expression.kind!=="constant"&&(this.expression.isStateDependent||!this.expression.isLightConstant)))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class va{constructor(e,i,o,l,d,f){this.expression=e,this.uniformNames=i.map(_=>`u_${_}_t`),this.type=o,this.useIntegerZoom=l,this.context=d,this.maxValue=0,this.paintVertexAttributes=i.map(_=>({name:`a_${_}`,type:"Float32",components:o==="color"?4:2,offset:0})),this.paintVertexArray=new f}populatePaintArray(e,i,o,l,d,f,_,v){const b=this.expression.evaluate(new fn(this.context.zoom,{brightness:f,worldview:v}),i,{},d,l,_),E=this.expression.evaluate(new fn(this.context.zoom+1,{brightness:f,worldview:v}),i,{},d,l,_),I=oh(this.lutExpression,i,{},l,d,f,_,v),C=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(C,e,b,E,I?null:this.context.lut)}updatePaintArray(e,i,o,l,d,f,_,v){const b=this.expression.evaluate({zoom:this.context.zoom,brightness:_,worldview:v},o,l,void 0,d),E=this.expression.evaluate({zoom:this.context.zoom+1,brightness:_,worldview:v},o,l,void 0,d),I=oh(this.lutExpression,o,l,d,void 0,_,void 0,v);this._setPaintValue(e,i,b,E,I?null:this.context.lut)}_setPaintValue(e,i,o,l,d){if(this.type==="color"){const f=gm(o.toPremultipliedRenderColor(d)),_=gm(o.toPremultipliedRenderColor(d));for(let v=e;v<i;v++)this.paintVertexArray.emplace(v,f[0],f[1],_[0],_[1])}else{for(let f=e;f<i;f++)this.paintVertexArray.emplace(f,o,l);this.maxValue=Math.max(this.maxValue,Math.abs(o),Math.abs(l))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(e,i,o,l,d){const f=this.useIntegerZoom?Math.floor(o.zoom):o.zoom,_=V(this.expression.interpolationFactor(f,this.context.zoom,this.context.zoom+1),0,1);i.set(e,d,_)}getBinding(e,i){return new ar(e)}}class xa{constructor(e,i,o,l,d){this.expression=e,this.layerId=d,this.paintVertexAttributes=(o==="array"?nx:tx).members;for(let f=0;f<i.length;++f);this.paintVertexArray=new l,this.paintTransitionVertexArray=new Xl}populatePaintArray(e,i,o,l){const d=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValues(d,e,i.patterns&&i.patterns[this.layerId],o)}updatePaintArray(e,i,o,l,d,f,_){this._setPaintValues(e,i,o.patterns&&o.patterns[this.layerId],f)}_setPaintValues(e,i,o,l){if(!l||!o)return;const d=l[o[0]],f=l[o[1]];if(d){if(d){const{tl:_,br:v,pixelRatio:b}=d;for(let E=e;E<i;E++)this.paintVertexArray.emplace(E,_[0],_[1],v[0],v[1],b)}if(f){this.paintTransitionVertexArray.resize(this.paintVertexArray.length);const{tl:_,br:v}=f;for(let b=e;b<i;b++)this.paintTransitionVertexArray.emplace(b,_[0],_[1],v[0],v[1])}}}upload(e){const i=this.expression.isStateDependent||!this.expression.isLightConstant;this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,i)),this.paintTransitionVertexArray&&this.paintTransitionVertexArray.length&&(this.paintTransitionVertexBuffer=e.createVertexBuffer(this.paintTransitionVertexArray,ix.members,i))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy(),this.paintTransitionVertexBuffer&&this.paintTransitionVertexBuffer.destroy()}}class ul{constructor(e,i,o=()=>!0){this.binders={},this._buffers=[],this.context=i;const l=[];for(const d in e.paint._values){const f=e.paint.get(d);if(d.endsWith("-use-theme")||!o(d)||!(f instanceof Gl&&qu(f.property.specification)))continue;const _=ax(d,e.type),v=f.value,b=f.property.specification.type,E=!!f.property.useIntegerZoom,I=d==="line-dasharray"||d.endsWith("pattern"),C=e.paint.get(`${d}-use-theme`),R=d==="line-dasharray"&&e.layout.get("line-cap").value.kind!=="constant"||C&&C.value.kind!=="constant";if(v.kind!=="constant"||R)if(v.kind==="source"||R||I){const k=ym(d,b,"source");this.binders[d]=I?new xa(v,_,b,k,e.id):new ya(v,_,b,k),l.push(`/a_${d}`)}else{const k=ym(d,b,"composite");this.binders[d]=new va(v,_,b,E,i,k),l.push(`/z_${d}`)}else this.binders[d]=I?new Nc(v.value,_):new sh(v.value,_,b,i),l.push(`/u_${d}`);C&&(this.binders[d].lutExpression=C.value)}this.cacheKey=l.sort().join("")}getMaxValue(e){const i=this.binders[e];return i instanceof ya||i instanceof va?i.maxValue:0}populatePaintArrays(e,i,o,l,d,f,_,v){for(const b in this.binders){const E=this.binders[b];E.context=this.context,(E instanceof ya||E instanceof va||E instanceof xa)&&E.populatePaintArray(e,i,o,l,d,f,_,v)}}setConstantPatternPositions(e,i){for(const o in this.binders){const l=this.binders[o];l instanceof Nc&&l.setConstantPatternPositions(e,i)}}getPatternTransitionVertexBuffer(e){const i=this.binders[e];return i instanceof xa?i.paintTransitionVertexBuffer:null}updatePaintArrays(e,i,o,l,d,f,_,v,b,E){let I=!1;const C=Object.keys(e),R=C.length!==0&&!v,k=R?C:i.uniqueIds;this.context.lut=d.lut;for(const F in this.binders){const U=this.binders[F];if(U.context=this.context,(U instanceof ya||U instanceof va||U instanceof xa)&&U.expression&&U.expression.kind&&U.expression.kind!=="constant"&&(U.expression.isStateDependent===!0||U.expression.isLightConstant===!1)){const j=d.paint.get(F);U.expression=j.value;for(const H of k){const W=e[H.toString()];i.eachPosition(H,(Y,se,ie)=>{const ce=l.feature(Y);U.updatePaintArray(se,ie,ce,W,f,_,b,E)})}if(!R)for(const H of o.uniqueIds){const W=e[H.toString()];o.eachPosition(H,(Y,se,ie)=>{const ce=l.feature(Y);U.updatePaintArray(se,ie,ce,W,f,_,b,E)})}I=!0}}return I}defines(){const e=[];for(const i in this.binders){const o=this.binders[i];(o instanceof sh||o instanceof Nc)&&e.push(...o.uniformNames.map(l=>`#define HAS_UNIFORM_${l}`))}return e}getPaintVertexBuffers(){return this._buffers}getUniforms(e){const i=[];for(const o in this.binders){const l=this.binders[o];if(l instanceof sh||l instanceof Nc||l instanceof va)for(const d of l.uniformNames)i.push({name:d,property:o,binding:l.getBinding(e,d)})}return i}setUniforms(e,i,o,l,d){for(const{name:f,property:_,binding:v}of o)this.binders[_].setUniform(e,v,d,l.get(_),f)}updatePaintBuffers(){this._buffers=[];for(const e in this.binders){const i=this.binders[e];(i instanceof ya||i instanceof va||i instanceof xa)&&i.paintVertexBuffer&&this._buffers.push(i.paintVertexBuffer),i instanceof xa&&i.paintTransitionVertexBuffer&&this._buffers.push(i.paintTransitionVertexBuffer)}}upload(e){for(const i in this.binders){const o=this.binders[i];(o instanceof ya||o instanceof va||o instanceof xa)&&o.upload(e)}this.updatePaintBuffers()}destroy(){for(const e in this.binders){const i=this.binders[e];(i instanceof ya||i instanceof va||i instanceof xa)&&i.destroy()}}}class ws{constructor(e,i,o=()=>!0){this.programConfigurations={};for(const l of e)this.programConfigurations[l.id]=new ul(l,i,o);this.needsUpload=!1,this._featureMap=new th,this._featureMapWithoutIds=new th,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(e,i,o,l,d,f,_,v,b){for(const E in this.programConfigurations)this.programConfigurations[E].populatePaintArrays(e,i,l,d,f,_,v,b);i.id!==void 0?this._featureMap.add(i.id,o,this._bufferOffset,e):(this._featureMapWithoutIds.add(this._idlessCounter,o,this._bufferOffset,e),this._idlessCounter+=1),this._bufferOffset=e,this.needsUpload=!0}updatePaintArrays(e,i,o,l,d,f,_,v){for(const b of o)this.needsUpload=this.programConfigurations[b.id].updatePaintArrays(e,this._featureMap,this._featureMapWithoutIds,i,b,l,d,f,_||0,v)||this.needsUpload}get(e){return this.programConfigurations[e]}upload(e){if(this.needsUpload){for(const i in this.programConfigurations)this.programConfigurations[i].upload(e);this.needsUpload=!1}}destroy(){for(const e in this.programConfigurations)this.programConfigurations[e].destroy()}}const sx={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"symbol-z-offset":["z_offset"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio","pattern_b"],"fill-pattern":["pattern","pixel_ratio","pattern_b"],"fill-extrusion-pattern":["pattern","pixel_ratio","pattern_b"],"line-dasharray":["dash"],"fill-bridge-guard-rail-color":["structure_color"],"fill-tunnel-structure-color":["structure_color"]};function ax(n,e){return sx[n]||[n.replace(`${e}-`,"").replace(/-/g,"_")]}const lx={"line-pattern":{source:yo,composite:yo},"fill-pattern":{source:yo,composite:yo},"fill-extrusion-pattern":{source:yo,composite:yo},"line-dasharray":{source:Xl,composite:Xl}},cx={color:{source:Hs,composite:ll},number:{source:_a,composite:Hs}};function ym(n,e,i){const o=lx[n];return o&&o[i]||cx[e][i]}It(sh,"ConstantBinder"),It(Nc,"PatternConstantBinder"),It(ya,"SourceExpressionBinder"),It(xa,"PatternCompositeBinder"),It(va,"CompositeExpressionBinder"),It(ul,"ProgramConfiguration",{omit:["_buffers"]}),It(ws,"ProgramConfigurationSet");const Gr=dt/Math.PI/2,es=5,nf=6,ux=16383,jc=64,vm=[jc,32,16],ts=-Gr,is=Gr;function Yl(n,e,i,o=Gr){return i=Oi(i),[n*Math.sin(i)*o,-e*o,n*Math.cos(i)*o]}function Uc(n,e,i){return Yl(Math.cos(Oi(n)),Math.sin(Oi(n)),e,i)}const u=63710088e-1,t=2*Math.PI*u;class r{constructor(e,i){if(isNaN(e)||isNaN(i))throw new Error(`Invalid LngLat object: (${e}, ${i})`);if(this.lng=+e,this.lat=+i,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new r(ee(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(e){const i=Math.PI/180,o=this.lat*i,l=e.lat*i,d=Math.sin(o)*Math.sin(l)+Math.cos(o)*Math.cos(l)*Math.cos((e.lng-this.lng)*i);return u*Math.acos(Math.min(d,1))}toBounds(e=0){const i=360*e/40075017,o=i/Math.cos(Math.PI/180*this.lat);return new h({lng:this.lng-o,lat:this.lat-i},{lng:this.lng+o,lat:this.lat+i})}toEcef(e){return Uc(this.lat,this.lng,Gr+e*Gr/u)}static convert(e){if(e instanceof r)return e;if(Array.isArray(e)&&(e.length===2||e.length===3))return new r(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&typeof e=="object"&&e!==null)return new r(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class h{constructor(e,i){e&&(i?this.setSouthWest(e).setNorthEast(i):Array.isArray(e)&&e.length===4?this.setSouthWest([e[0],e[1]]).setNorthEast([e[2],e[3]]):this.setSouthWest(e[0]).setNorthEast(e[1]))}setNorthEast(e){return this._ne=e instanceof r?new r(e.lng,e.lat):r.convert(e),this}setSouthWest(e){return this._sw=e instanceof r?new r(e.lng,e.lat):r.convert(e),this}extend(e){const i=this._sw,o=this._ne;let l,d;if(e instanceof r)l=e,d=e;else{if(!(e instanceof h))return Array.isArray(e)?e.length===4||e.every(Array.isArray)?this.extend(h.convert(e)):this.extend(r.convert(e)):typeof e=="object"&&e!==null&&e.hasOwnProperty("lat")&&(e.hasOwnProperty("lon")||e.hasOwnProperty("lng"))?this.extend(r.convert(e)):this;if(l=e._sw,d=e._ne,!l||!d)return this}return i||o?(i.lng=Math.min(l.lng,i.lng),i.lat=Math.min(l.lat,i.lat),o.lng=Math.max(d.lng,o.lng),o.lat=Math.max(d.lat,o.lat)):(this._sw=new r(l.lng,l.lat),this._ne=new r(d.lng,d.lat)),this}getCenter(){return new r((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new r(this.getWest(),this.getNorth())}getSouthEast(){return new r(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(e){const{lng:i,lat:o}=r.convert(e);let l=this._sw.lng<=i&&i<=this._ne.lng;return this._sw.lng>this._ne.lng&&(l=this._sw.lng>=i&&i>=this._ne.lng),this._sw.lat<=o&&o<=this._ne.lat&&l}static convert(e){if(e)return e instanceof h?e:new h(e)}}const p=0,g=25.5;function y(n){return t*Math.cos(n*Math.PI/180)}function w(n){return(180+n)/360}function T(n){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+n*Math.PI/360)))/360}function A(n,e){return n/y(e)}function M(n){return 360*n-180}function z(n){return 360/Math.PI*Math.atan(Math.exp((180-360*n)*Math.PI/180))-90}function L(n,e){return n*y(z(e))}const D=85.051129;function N(n){return Math.cos(Oi(V(n,-D,D)))}function B(n,e){const i=V(e,p,g),o=Math.pow(2,i);return N(n)*t/(512*o)}function G(n){return 1/Math.cos(n*Math.PI/180)}function $(n,e=0){const i=Math.exp(Math.PI*(1-(n.y+e/dt)/(1<<n.z)*2));return 80150034*i/(i*i+1)/dt/(1<<n.z)}class X{constructor(e,i,o=0){this.x=+e,this.y=+i,this.z=+o}static fromLngLat(e,i=0){const o=r.convert(e);return new X(w(o.lng),T(o.lat),A(i,o.lat))}toLngLat(){return new r(M(this.x),z(this.y))}toAltitude(){return L(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/t*G(z(this.y))}}function J(n,e,i,o,l,d,f,_,v){const b=(e+o)/2,E=(i+l)/2,I=new et(b,E);_(I),function(C,R,k,F,U,j){const H=k-U,W=F-j;return Math.abs((F-R)*H-(k-C)*W)/Math.hypot(H,W)}(I.x,I.y,d.x,d.y,f.x,f.y)>=v?(J(n,e,i,b,E,d,I,_,v),J(n,b,E,o,l,I,f,_,v)):n.push(f)}function K(n,e,i){let o=n[0],l=o.x,d=o.y;e(o);const f=[o];for(let _=1;_<n.length;_++){const v=n[_],{x:b,y:E}=v;e(v),J(f,l,d,b,E,o,v,e,i),l=b,d=E,o=v}return f}function ue(n,e,i,o){if(o(e,i)){const l=e.add(i)._mult(.5);ue(n,e,l,o),ue(n,l,i,o)}else n.push(i)}function oe(n,e){let i=n[0];const o=[i];for(let l=1;l<n.length;l++){const d=n[l];ue(o,i,d,e),i=d}return o}const le=Math.pow(2,14)-1,re=-le-1;function te(n,e){const i=Math.round(n.x*e),o=Math.round(n.y*e);return n.x=V(i,re,le),n.y=V(o,re,le),(i<n.x||i>n.x+1||o<n.y||o>n.y+1)&&bt("Geometry exceeds allowed extent, reduce your vector tile buffer size"),n}function he(n,e,i){const o=n.loadGeometry(),l=n.extent,d=dt/l;if(e&&i&&i.projection.isReprojectedInTileSpace){const f=1<<e.z,{scale:_,x:v,y:b,projection:E}=i,I=C=>{const R=M((e.x+C.x/l)/f),k=z((e.y+C.y/l)/f),F=E.project(R,k);C.x=(F.x*_-v)*l,C.y=(F.y*_-b)*l};for(let C=0;C<o.length;C++)if(n.type!==1)o[C]=K(o[C],I,1);else{const R=[];for(const k of o[C])k.x<0||k.x>=l||k.y<0||k.y>=l||(I(k),R.push(k));o[C]=R}}for(const f of o)for(const _ of f)te(_,d);return o}function we(n,e){return{type:n.type,id:n.id,properties:n.properties,geometry:e?he(n):[]}}class ye{constructor(e,i,o,l,d){this.properties={},this.extent=o,this.type=0,this.id=void 0,this._pbf=e,this._geometry=-1,this._keys=l,this._values=d,e.readFields(ze,this,i)}loadGeometry(){const e=this._pbf;e.pos=this._geometry;const i=e.readVarint()+e.pos,o=[];let l,d=1,f=0,_=0,v=0;for(;e.pos<i;){if(f<=0){const b=e.readVarint();d=7&b,f=b>>3}if(f--,d===1||d===2)_+=e.readSVarint(),v+=e.readSVarint(),d===1&&(l&&o.push(l),l=[]),l&&l.push(new et(_,v));else{if(d!==7)throw new Error(`unknown command ${d}`);l&&l.push(l[0].clone())}}return l&&o.push(l),o}bbox(){const e=this._pbf;e.pos=this._geometry;const i=e.readVarint()+e.pos;let o=1,l=0,d=0,f=0,_=1/0,v=-1/0,b=1/0,E=-1/0;for(;e.pos<i;){if(l<=0){const I=e.readVarint();o=7&I,l=I>>3}if(l--,o===1||o===2)d+=e.readSVarint(),f+=e.readSVarint(),d<_&&(_=d),d>v&&(v=d),f<b&&(b=f),f>E&&(E=f);else if(o!==7)throw new Error(`unknown command ${o}`)}return[_,b,v,E]}toGeoJSON(e,i,o){const l=this.extent*Math.pow(2,o),d=this.extent*e,f=this.extent*i,_=this.loadGeometry();function v(C){return[360*(C.x+d)/l-180,360/Math.PI*Math.atan(Math.exp((1-2*(C.y+f)/l)*Math.PI))-90]}function b(C){return C.map(v)}let E;if(this.type===1){const C=[];for(const k of _)C.push(k[0]);const R=b(C);E=C.length===1?{type:"Point",coordinates:R[0]}:{type:"MultiPoint",coordinates:R}}else if(this.type===2){const C=_.map(b);E=C.length===1?{type:"LineString",coordinates:C[0]}:{type:"MultiLineString",coordinates:C}}else{if(this.type!==3)throw new Error("unknown feature type");{const C=function(k){const F=k.length;if(F<=1)return[k];const U=[];let j,H;for(let W=0;W<F;W++){const Y=Oe(k[W]);Y!==0&&(H===void 0&&(H=Y<0),H===Y<0?(j&&U.push(j),j=[k[W]]):j&&j.push(k[W]))}return j&&U.push(j),U}(_),R=[];for(const k of C)R.push(k.map(b));E=R.length===1?{type:"Polygon",coordinates:R[0]}:{type:"MultiPolygon",coordinates:R}}}const I={type:"Feature",geometry:E,properties:this.properties};return this.id!=null&&(I.id=this.id),I}}function ze(n,e,i){n===1?e.id=i.readVarint():n===2?function(o,l){const d=o.readVarint()+o.pos;for(;o.pos<d;){const f=l._keys[o.readVarint()],_=l._values[o.readVarint()];l.properties[f]=_}}(i,e):n===3?e.type=i.readVarint():n===4&&(e._geometry=i.pos)}function Oe(n){let e=0;for(let i,o,l=0,d=n.length,f=d-1;l<d;f=l++)i=n[l],o=n[f],e+=(o.x-i.x)*(i.y+o.y);return e}ye.types=["Unknown","Point","LineString","Polygon"];class $e{constructor(e,i){this.version=1,this.name="",this.extent=4096,this.length=0,this._pbf=e,this._keys=[],this._values=[],this._features=[],e.readFields(ot,this,i),this.length=this._features.length}feature(e){if(e<0||e>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[e];const i=this._pbf.readVarint()+this._pbf.pos;return new ye(this._pbf,i,this.extent,this._keys,this._values)}}function ot(n,e,i){n===15?e.version=i.readVarint():n===1?e.name=i.readString():n===5?e.extent=i.readVarint():n===2?e._features.push(i.pos):n===3?e._keys.push(i.readString()):n===4&&e._values.push(function(o){let l=null;const d=o.readVarint()+o.pos;for(;o.pos<d;){const f=o.readVarint()>>3;l=f===1?o.readString():f===2?o.readFloat():f===3?o.readDouble():f===4?o.readVarint64():f===5?o.readVarint():f===6?o.readSVarint():f===7?o.readBoolean():null}if(l==null)throw new Error("unknown feature value");return l}(i))}class Ae{constructor(e,i){this.layers=e.readFields(_e,{},i)}}function _e(n,e,i){if(n===3){const o=new $e(i,i.readVarint()+i.pos);o.length&&(e[o.name]=o)}}const Ne="3d_elevation_id",Re="level";class Ke{constructor(){this._valid=!1}reset(e){return this.feature=e,this._valid=!0,this._geometry=e.loadGeometry(),this._geometry.length!==0&&this._geometry[0].length!==0||(this._valid=!1),this}geometry(e,i){return this._valid&&e(i(this._geometry)),this}require(e,i,o){return this.get(e,!0,i,o)}optional(e,i,o){return this.get(e,!1,i,o)}success(){return this._valid}get(e,i,o,l){const d=this.feature.properties.hasOwnProperty(e)?+this.feature.properties[e]:void 0;return this._valid&&d!==void 0&&!Number.isNaN(d)?o(l?l(d):d):i&&(this._valid=!1),this}}class pt{constructor(e,i){this.featureFunc=e,this.vertexFunc=i}parseFeature(e,i,o){return this.featureFunc(e,i,o)}parseVertex(e,i,o){return this.vertexFunc(e,i,o)}}const wt=new pt((n,e,i)=>n.reset(e).require(Ne,o=>{i.id=o}).optional("fixed_height_relative",o=>{i.constantHeight=o},st.decodeRelativeHeight).geometry(o=>{i.bounds=o},ua).success(),(n,e,i)=>n.reset(e).require(Ne,o=>{i.id=o}).require("elevation_idx",o=>{i.idx=o}).require("extent",o=>{i.extent=o}).require("height_relative",o=>{i.height=o},st.decodeRelativeHeight).geometry(o=>{i.position=o},st.getPoint).success()),ht=new pt((n,e,i)=>n.reset(e).require(Ne,o=>{i.id=o}).optional("fixed_height",o=>{i.constantHeight=o},st.decodeMetricHeight).geometry(o=>{i.bounds=o},ua).success(),(n,e,i)=>n.reset(e).require(Ne,o=>{i.id=o}).require("elevation_idx",o=>{i.idx=o}).require("extent",o=>{i.extent=o}).require("height",o=>{i.height=o},st.decodeMetricHeight).geometry(o=>{i.position=o},st.getPoint).success());class st{static getPoint(e){return po(e[0][0].x,e[0][0].y)}static decodeRelativeHeight(e){return 1e-4*e*5}static decodeMetricHeight(e){return 1e-4*e}static getVersionSchema(e){return e?e==="1.0.1"?ht:void 0:wt}static parse(e){const i=[],o=[],l=e.length,d=new Ke;for(let f=0;f<l;f++){const _=e.feature(f),v=_.properties.version,b=st.getVersionSchema(v);if(b===void 0){bt(`Unknown elevation feature version number ${v||"(unknown)"}`);continue}const E=_.properties.type;if(!E)continue;const I=ye.types[_.type];if(I==="Point"&&E==="curve_point"){const C={};b.parseVertex(d,_,C)&&i.push(C)}else if(I==="Polygon"&&E==="curve_meta"){const C={};b.parseFeature(d,_,C)&&o.push(C)}}return{vertices:i,features:o}}}class Rt{constructor(e,i){this.pos=e,this.dir=i}intersectsPlane(e,i,o){const l=Al(i,this.dir);if(Math.abs(l)<1e-6)return!1;const d=((e[0]-this.pos[0])*i[0]+(e[1]-this.pos[1])*i[1])/l;return o[0]=this.pos[0]+this.dir[0]*d,o[1]=this.pos[1]+this.dir[1]*d,!0}}class At{constructor(e,i){this.pos=e,this.dir=i}intersectsPlane(e,i,o){const l=qn(i,this.dir);if(Math.abs(l)<1e-6)return!1;const d=((e[0]-this.pos[0])*i[0]+(e[1]-this.pos[1])*i[1]+(e[2]-this.pos[2])*i[2])/l;return o[0]=this.pos[0]+this.dir[0]*d,o[1]=this.pos[1]+this.dir[1]*d,o[2]=this.pos[2]+this.dir[2]*d,!0}closestPointOnSphere(e,i,o){if(function(R,k){var F=R[0],U=R[1],j=R[2],H=k[0],W=k[1],Y=k[2];return Math.abs(F-H)<=Z*Math.max(1,Math.abs(F),Math.abs(H))&&Math.abs(U-W)<=Z*Math.max(1,Math.abs(U),Math.abs(W))&&Math.abs(j-Y)<=Z*Math.max(1,Math.abs(j),Math.abs(Y))}(this.pos,e)||i===0)return o[0]=o[1]=o[2]=0,!1;const[l,d,f]=this.dir,_=this.pos[0]-e[0],v=this.pos[1]-e[1],b=this.pos[2]-e[2],E=l*l+d*d+f*f,I=2*(_*l+v*d+b*f),C=I*I-4*E*(_*_+v*v+b*b-i*i);if(C<0){const R=Math.max(-I/2,0),k=_+l*R,F=v+d*R,U=b+f*R,j=Math.hypot(k,F,U);return o[0]=k*i/j,o[1]=F*i/j,o[2]=U*i/j,!1}{const R=(-I-Math.sqrt(C))/(2*E);if(R<0){const k=Math.hypot(_,v,b);return o[0]=_*i/k,o[1]=v*i/k,o[2]=b*i/k,!1}return o[0]=_+l*R,o[1]=v+d*R,o[2]=b+f*R,!0}}}class vt{constructor(e,i,o,l,d){this.TL=e,this.TR=i,this.BR=o,this.BL=l,this.horizon=d}static fromInvProjectionMatrix(e,i,o){const l=[-1,1,1],d=[1,1,1],f=[1,-1,1],_=[-1,-1,1],v=Kn(l,l,e),b=Kn(d,d,e),E=Kn(f,f,e),I=Kn(_,_,e);return new vt(v,b,E,I,i/o)}}function Tt(n,e,i){let o=1/0,l=-1/0;const d=[];for(const f of n){Qn(d,f,e);const _=qn(d,i);o=Math.min(o,_),l=Math.max(l,_)}return[o,l]}function Ut(n,e){let i=!0;for(let o=0;o<n.planes.length;o++){const l=n.planes[o];let d=0;for(let f=0;f<e.length;f++)d+=+(qn(l,e[f])+l[3]>=0);if(d===0)return 0;d!==e.length&&(i=!1)}return i?2:1}function ii(n,e){for(const i of n.projections){const o=Tt(e,n.points[0],i.axis);if(i.projection[1]<o[0]||i.projection[0]>o[1])return 0}return 1}function wi(n,e){let i=0;const o=[0,0,0,0];for(let f=0;f<n.length;f++)o[0]=n[f][0],o[1]=n[f][1],o[2]=n[f][2],o[3]=1,(l=o)[0]*(d=e)[0]+l[1]*d[1]+l[2]*d[2]+l[3]*d[3]>=0&&i++;var l,d;return i}class Ui{constructor(e,i){this.points=e||new Array(8).fill([0,0,0]),this.planes=i||new Array(6).fill([0,0,0,0]),this.bounds=Lt.fromPoints(this.points),this.projections=[],this.frustumEdges=[Qn([],this.points[2],this.points[3]),Qn([],this.points[0],this.points[3]),Qn([],this.points[4],this.points[0]),Qn([],this.points[5],this.points[1]),Qn([],this.points[6],this.points[2]),Qn([],this.points[7],this.points[3])];for(const o of this.frustumEdges){const l=[0,-o[2],o[1]],d=[o[2],0,-o[0]];this.projections.push({axis:l,projection:Tt(this.points,this.points[0],l)}),this.projections.push({axis:d,projection:Tt(this.points,this.points[0],d)})}}static fromInvProjectionMatrix(e,i,o,l){const d=Math.pow(2,o),f=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(b=>{const E=Ur([],b,e),I=1/E[3]/i*d;return(C=E)[0]=(R=E)[0]*(k=[I,I,l?1/E[3]:I,I])[0],C[1]=R[1]*k[1],C[2]=R[2]*k[2],C[3]=R[3]*k[3],C;var C,R,k}),_=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(b=>{const E=yn([],jr([],Qn([],f[b[0]],f[b[1]]),Qn([],f[b[2]],f[b[1]]))),I=-qn(E,f[b[1]]);return E.concat(I)}),v=[];for(let b=0;b<f.length;b++)v.push([f[b][0],f[b][1],f[b][2]]);return new Ui(v,_)}intersectsPrecise(e,i,o){for(let l=0;l<i.length;l++)if(!wi(e,i[l]))return 0;for(let l=0;l<this.planes.length;l++)if(!wi(e,this.planes[l]))return 0;for(const l of o)for(const d of this.frustumEdges){const f=jr([],l,d),_=pr(f);if(_===0)continue;gn(f,f,1/_);const v=Tt(this.points,this.points[0],f),b=Tt(e,this.points[0],f);if(v[0]>b[1]||b[0]>v[1])return 0}return 1}containsPoint(e){for(const i of this.planes){const o=i[3];if(qn([i[0],i[1],i[2]],e)+o<0)return!1}return!0}}class Lt{static fromPoints(e){const i=[1/0,1/0,1/0],o=[-1/0,-1/0,-1/0];for(const l of e)On(i,i,l),Un(o,o,l);return new Lt(i,o)}static fromTileIdAndHeight(e,i,o){const l=1<<e.canonical.z,d=e.canonical.x,f=e.canonical.y;return new Lt([d/l,f/l,i],[(d+1)/l,(f+1)/l,o])}static applyTransform(e,i){const o=e.getCorners();for(let l=0;l<o.length;++l)Kn(o[l],o[l],i);return Lt.fromPoints(o)}static applyTransformFast(e,i){const o=[i[12],i[13],i[14]],l=[...o];for(let d=0;d<3;d++)for(let f=0;f<3;f++){const _=i[4*f+d],v=_*e.min[f],b=_*e.max[f];o[d]+=Math.min(v,b),l[d]+=Math.max(v,b)}return new Lt(o,l)}static projectAabbCorners(e,i){const o=e.getCorners();for(let l=0;l<o.length;++l)Kn(o[l],o[l],i);return o}constructor(e,i){this.min=e,this.max=i,this.center=gn([],$t([],this.min,this.max),.5)}quadrant(e){const i=[e%2==0,e<2],o=wl(this.min),l=wl(this.max);for(let d=0;d<i.length;d++)o[d]=i[d]?this.min[d]:this.center[d],l[d]=i[d]?this.center[d]:this.max[d];return l[2]=this.max[2],new Lt(o,l)}distanceX(e){return Math.max(Math.min(this.max[0],e[0]),this.min[0])-e[0]}distanceY(e){return Math.max(Math.min(this.max[1],e[1]),this.min[1])-e[1]}distanceZ(e){return Math.max(Math.min(this.max[2],e[2]),this.min[2])-e[2]}getCorners(){const e=this.min,i=this.max;return[[e[0],e[1],e[2]],[i[0],e[1],e[2]],[i[0],i[1],e[2]],[e[0],i[1],e[2]],[e[0],e[1],i[2]],[i[0],e[1],i[2]],[i[0],i[1],i[2]],[e[0],i[1],i[2]]]}intersects(e){return this.intersectsAabb(e.bounds)?Ut(e,this.getCorners()):0}intersectsFlat(e){return this.intersectsAabb(e.bounds)?Ut(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(e,i){return i||this.intersects(e)?ii(e,this.getCorners()):0}intersectsPreciseFlat(e,i){return i||this.intersectsFlat(e)?ii(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(e){for(let i=0;i<3;++i)if(this.min[i]>e.max[i]||e.min[i]>this.max[i])return!1;return!0}intersectsAabbXY(e){return!(this.min[0]>e.max[0]||e.min[0]>this.max[0]||this.min[1]>e.max[1]||e.min[1]>this.max[1])}encapsulate(e){for(let i=0;i<3;i++)this.min[i]=Math.min(this.min[i],e.min[i]),this.max[i]=Math.max(this.max[i],e.max[i])}encapsulatePoint(e){for(let i=0;i<3;i++)this.min[i]=Math.min(this.min[i],e[i]),this.max[i]=Math.max(this.max[i],e[i])}closestPoint(e){return[Math.max(Math.min(this.max[0],e[0]),this.min[0]),Math.max(Math.min(this.max[1],e[1]),this.min[1]),Math.max(Math.min(this.max[2],e[2]),this.min[2])]}}It(Lt,"Aabb");class Fi{constructor(e,i){this.feature=e,this.metersToTile=i,this.index=0}get(){const e=this.feature.vertices[this.index],i=this.feature.vertexProps[this.index].dir,o=i[1],l=-i[0],d=(e.extent+1)*this.metersToTile;return[new et(Math.trunc(e.position[0]+o*d),Math.trunc(e.position[1]+l*d)),new et(Math.trunc(e.position[0]-o*d),Math.trunc(e.position[1]-l*d))]}next(){this.index++}valid(){return this.index<this.feature.vertices.length}}class ti{constructor(e,i,o,l,d,f){if(this.vertices=new Array,this.vertexProps=new Array,this.edges=new Array,this.edgeProps=new Array,this._tmpVec2=[Ir(),Ir(),Ir(),Ir(),Ir(),Ir(),Ir()],this.id=e,this.heightRange={min:o,max:o},this.safeArea=i,this.constantHeight=o,this.constantHeight==null&&(this.constantHeight!=null||l.length!==0)){this.vertices=l,this.edges=d,this.edges=this.edges.filter(_=>{return _.a<this.vertices.length&&_.b<this.vertices.length&&!((v=this.vertices[_.a].position)[0]===(b=this.vertices[_.b].position)[0]&&v[1]===b[1]);var v,b}),this.heightRange={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(const _ of this.vertices)this.vertexProps.push({dir:po(0,0)}),this.heightRange.min=Math.min(this.heightRange.min,_.height),this.heightRange.max=Math.max(this.heightRange.max,_.height);for(const _ of this.edges){const v=this.vertices[_.a].position,b=this.vertices[_.b].position,E=Ls(Ir(),b,v),I=ds(E),C=oa(Ir(),E,1/I);this.edgeProps.push({vec:E,dir:C,len:I});const R=this.vertexProps[_.a].dir,k=this.vertexProps[_.b].dir;qa(R,R,C),qa(k,k,C)}for(const _ of this.vertexProps)_.dir[0]===0&&_.dir[1]===0||bu(_.dir,_.dir);this.tessellate(f)}}pointElevation(e){if(this.constantHeight!=null)return this.constantHeight;const i=this.getClosestEdge(e);if(i==null)return 0;const[o,l]=i;return Kt(this.vertices[this.edges[o].a].height,this.vertices[this.edges[o].b].height,l)}computeSlopeNormal(e,i){const o=this.getClosestEdge(e);if(!o)return In(0,0,1);const l=o[0],d=this.edges[l],f=this.edgeProps[l].vec,_=In(f[0],f[1],(this.vertices[d.b].height-this.vertices[d.a].height)*i),v=In(_[1],-_[0],0);jr(v,v,_);const b=pr(v);return b>0?gn(v,v,1/b):dn(v,0,0,1)}getSafeArea(){return this.safeArea}isTunnel(){return this.heightRange.max<=-5}getClosestEdge(e){if(this.edges.length===0)return;let i=0,o=Number.POSITIVE_INFINITY,l=0;const[d,f,_,v,b,E,I]=this._tmpVec2;wu(I,e.x,e.y);const C=new Rt(I,null);for(let R=0;R<this.edges.length;R++){const k=this.edges[R],F=this.edgeProps[R].dir;C.dir=F;const U=this.vertices[k.a].position,j=this.vertices[k.b].position,H=C.intersectsPlane(U,this.vertexProps[k.a].dir,d),W=C.intersectsPlane(j,this.vertexProps[k.b].dir,f);if(!H||!W)continue;Ls(_,f,d),Ls(v,I,d);const Y=Al(_,_),se=Y>0?Al(v,_)/Y:0,ie=V(se,0,1),ce=Math.abs((se-ie)*this.edgeProps[R].len);Ls(b,I,U),wu(E,F[1],-F[0]);const fe=ce+Math.abs(Al(b,E));fe<o&&(i=R,o=fe,l=ie)}return[i,l]}tessellate(e){const i=Ri(),o=Ri(),l=Ri(),d=Ri();for(let f=this.edges.length-1;f>=0;--f){const _=this.edges[f].a,v=this.edges[f].b,{position:b,height:E,extent:I}=this.vertices[_],{position:C,height:R,extent:k}=this.vertices[v],F=this.vertexProps[_].dir,U=this.vertexProps[v].dir;if(dn(i,b[0]/e,b[1]/e,E),dn(o,C[0]/e,C[1]/e,R),dn(l,F[1],-F[0],0),gn(l,l,I),dn(d,U[1],-U[0],0),gn(d,d,k),this.distSqLines(In(i[0]+.5*l[0],i[1]+.5*l[1],i[2]+.5*l[2]),In(o[0]-.5*d[0],o[1]-.5*d[1],o[2]-.5*d[2]),In(i[0]-.5*l[0],i[1]-.5*l[1],i[2]-.5*l[2]),In(o[0]+.5*d[0],o[1]+.5*d[1],o[2]+.5*d[2]))<=.0025000000000000005)continue;const j=this.vertices.length,H=qa(Ir(),b,C);this.vertices.push({position:oa(H,H,.5),height:.5*(E+R),extent:.5*(I+k)});const W=qa(Ir(),F,U);this.vertexProps.push({dir:bu(W,W)}),this.edges.splice(f,1),this.edgeProps.splice(f,1),this.edges.push({a:_,b:j}),this.edges.push({a:j,b:v});const Y=Ls(Ir(),this.vertices[j].position,b),se=ds(Y),ie={vec:Y,dir:oa(Ir(),Y,1/se),len:se};this.edgeProps.push(ie),this.edgeProps.push(ie)}}distSqLines(e,i,o,l){const d=ki(Ri(),i,e),f=ki(Ri(),l,o),_=ki(Ri(),e,o),v=qn(d,d),b=qn(d,f),E=qn(d,_),I=qn(f,f),C=qn(f,_),R=v*I-b*b;if(R===0)return Lo(bl(d,o,l,qn(_,f)/qn(f,f)),e);const k=(v*C-b*E)/R;return Lo(bl(d,e,i,(b*C-E*I)/R),bl(f,o,l,k))}}class Gi{static parseFrom(e,i){const o=st.parse(e);if(!o)return[];let{vertices:l,features:d}=o;const f=1/$(i);d.sort((E,I)=>E.id-I.id),l.sort((E,I)=>E.id-I.id||E.idx-I.idx),l=l.filter((E,I,C)=>I===C.findIndex(R=>R.id===E.id&&R.idx===E.idx));const _=new Array;let v=0;const b=l.length;for(const E of d){if(E.constantHeight){_.push(new ti(E.id,E.bounds,E.constantHeight));continue}for(;v!==b&&l[v].id<E.id;)v++;if(v===b||l[v].id!==E.id)continue;const I=new Array,C=new Array,R=v;for(;v!==b&&l[v].id===E.id;){const k=l[v];if(I.push({position:k.position,height:k.height,extent:k.extent}),v!==R&&l[v-1].idx===k.idx-1){const F=v-R;C.push({a:F-1,b:F})}v++}_.push(new ti(E.id,E.bounds,void 0,I,C,f))}return _}static getElevationFeature(e,i){if(!i)return;const o=+e.properties[Ne];return Number.isNaN(o)?void 0:i.find(l=>l.id===o)}}class Qi{constructor(e,i){this.zScale=1,this.xOffset=0,this.yOffset=0,e.equals(i)||(this.zScale=Math.pow(2,i.z-e.z),this.xOffset=(e.x*this.zScale-i.x)*dt,this.yOffset=(e.y*this.zScale-i.y)*dt)}constantElevation(e,i){if(e.constantHeight!=null)return this.computeBiasedHeight(e.constantHeight,i)}pointElevation(e,i,o){const l=this.constantElevation(i,o);return l??(e.x=e.x*this.zScale+this.xOffset,e.y=e.y*this.zScale+this.yOffset,this.computeBiasedHeight(i.pointElevation(e),o))}computeBiasedHeight(e,i){return i<=0?e:e+i*q(0,i,e>=0?e:Math.abs(.5*e))}}It(ti,"ElevationFeature");class Xi{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.projection=e.projection,this.layoutVertexArray=new al,this.indexArray=new sr,this.segments=new An,this.programConfigurations=new ws(e.layers,{zoom:e.zoom,lut:e.lut}),this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.elevationMode=this.layers[0].layout.get("circle-elevation-reference"),this.hasElevation=!1,this.elevationMode!=="none"&&(this.elevatedLayoutVertexArray=new _a),this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,i){}updateAppearances(e,i,o,l){}populate(e,i,o,l){const d=this.layers[0],f=[];let _=null;d.type==="circle"&&(_=d.layout.get("circle-sort-key"));for(const{feature:b,id:E,index:I,sourceLayerIndex:C}of e){const R=this.layers[0]._featureFilter.needGeometry,k=we(b,R);if(!this.layers[0]._featureFilter.filter(new fn(this.zoom,{worldview:this.worldview,activeFloors:i.activeFloors}),k,o))continue;const F=_?_.evaluate(k,{},o):void 0,U={id:E,properties:b.properties,type:b.type,sourceLayerIndex:C,index:I,geometry:R?k.geometry:he(b,o,l),patterns:{},sortKey:F};f.push(U)}_&&f.sort((b,E)=>b.sortKey-E.sortKey);let v=null;l.projection.name==="globe"&&(this.globeExtVertexArray=new Nd,v=l.projection);for(const b of f){const{geometry:E,index:I,sourceLayerIndex:C}=b,R=e[I].feature;this.addFeature(b,E,I,i.availableImages,o,v,i.brightness,i.elevationFeatures),i.featureIndex.insert(R,E,I,C,this.index)}this.hasElevation||(this.elevatedLayoutVertexArray=void 0)}update(e,i,o,l,d,f,_){this.programConfigurations.updatePaintArrays(e,i,d,o,l,f,_,this.worldview)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,uy.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,hy.members)),this.elevatedLayoutVertexArray&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,ex.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy())}addFeature(e,i,o,l,d,f,_,v){let b;this.elevationMode!=="none"&&(b=Gi.getElevationFeature(e,v));for(const E of i)for(const I of E){const C=I.x,R=I.y;if(C<0||C>=dt||R<0||R>=dt)continue;if(f){const U=f.projectTilePoint(C,R,d),j=f.upVector(d,C,R);this.addGlobeExtVertex(U,j),this.addGlobeExtVertex(U,j),this.addGlobeExtVertex(U,j),this.addGlobeExtVertex(U,j)}const k=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,e.sortKey),F=k.vertexLength;if(this.addCircleVertex(C,R,-1,-1),this.addCircleVertex(C,R,1,-1),this.addCircleVertex(C,R,1,1),this.addCircleVertex(C,R,-1,1),this.elevationMode!=="none"){const U=b?b.pointElevation(new et(C,R)):0;this.hasElevation=this.hasElevation||U!==0;for(let j=0;j<4;j++)this.elevatedLayoutVertexArray.emplaceBack(U)}this.indexArray.emplaceBack(F,F+1,F+2),this.indexArray.emplaceBack(F,F+2,F+3),k.vertexLength+=4,k.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,o,{},l,d,_,void 0,this.worldview)}addCircleVertex(e,i,o,l){this.layoutVertexArray.emplaceBack(2*e+(o+1)/2,2*i+(l+1)/2)}addGlobeExtVertex(e,i){this.globeExtVertexArray.emplaceBack(e.x,e.y,e.z,i[0]*16384,i[1]*16384,i[2]*16384)}}function Di(n,e){for(let i=0;i<n.length;i++)if(rn(e,n[i]))return!0;for(let i=0;i<e.length;i++)if(rn(n,e[i]))return!0;return!!xn(n,e)}function ci(n,e,i){return!!rn(n,e)||!!_n(e,n,i)}function $i(n,e){if(n.length===1)return Cn(e,n[0]);for(let i=0;i<e.length;i++){const o=e[i];for(let l=0;l<o.length;l++)if(rn(n,o[l]))return!0}for(let i=0;i<n.length;i++)if(Cn(e,n[i]))return!0;for(let i=0;i<e.length;i++)if(xn(n,e[i]))return!0;return!1}function zn(n,e,i){if(n.length>1){if(xn(n,e))return!0;for(let o=0;o<e.length;o++)if(_n(e[o],n,i))return!0}for(let o=0;o<n.length;o++)if(_n(n[o],e,i))return!0;return!1}function xn(n,e){if(n.length===0||e.length===0)return!1;for(let i=0;i<n.length-1;i++){const o=n[i],l=n[i+1];for(let d=0;d<e.length-1;d++)if(Hi(o,l,e[d],e[d+1]))return!0}return!1}function Hi(n,e,i,o){return li(n,i,o)!==li(e,i,o)&&li(n,e,i)!==li(n,e,o)}function Ci(n,e,i){return(n.x-i.x)*(e.y-i.y)-(n.y-i.y)*(e.x-i.x)}function ui(n,e,i,o){const l=Ci(n,e,o),d=Ci(n,e,i);if(Math.sign(l)===Math.sign(d))return;const f=Ci(i,o,n),_=f+d-l;return Math.sign(f)!==Math.sign(_)?[f/(f-_),d/(d-l)]:void 0}function _n(n,e,i){const o=i*i;if(e.length===1)return n.distSqr(e[0])<o;for(let l=1;l<e.length;l++)if(Gn(n,e[l-1],e[l])<o)return!0;return!1}function Gn(n,e,i){const o=e.distSqr(i);if(o===0)return n.distSqr(e);const l=((n.x-e.x)*(i.x-e.x)+(n.y-e.y)*(i.y-e.y))/o;return n.distSqr(l<0?e:l>1?i:i.sub(e)._mult(l)._add(e))}function Cn(n,e){let i,o,l,d=!1;for(let f=0;f<n.length;f++){i=n[f];for(let _=0,v=i.length-1;_<i.length;v=_++)o=i[_],l=i[v],o.y>e.y!=l.y>e.y&&e.x<(l.x-o.x)*(e.y-o.y)/(l.y-o.y)+o.x&&(d=!d)}return d}function rn(n,e){let i=!1;for(let o=0,l=n.length-1;o<n.length;l=o++){const d=n[o],f=n[l];d.y>e.y!=f.y>e.y&&e.x<(f.x-d.x)*(e.y-d.y)/(f.y-d.y)+d.x&&(i=!i)}return i}function co(n,e,i,o,l){for(const f of n)if(e<=f.x&&i<=f.y&&o>=f.x&&l>=f.y)return!0;const d=[new et(e,i),new et(e,l),new et(o,l),new et(o,i)];if(n.length>2){for(const f of d)if(rn(n,f))return!0}for(let f=0;f<n.length-1;f++)if(Fr(n[f],n[f+1],d))return!0;return!1}function Fr(n,e,i){const o=i[0],l=i[2];if(n.x<o.x&&e.x<o.x||n.x>l.x&&e.x>l.x||n.y<o.y&&e.y<o.y||n.y>l.y&&e.y>l.y)return!1;const d=li(n,e,i[0]);return d!==li(n,e,i[1])||d!==li(n,e,i[2])||d!==li(n,e,i[3])}function lr(n,e,i,o,l,d){let f=e.y-n.y,_=n.x-e.x;if(d=d||0){const v=f*f+_*_;if(v===0)return!0;const b=Math.sqrt(v);f/=b,_/=b}return!((i.x-n.x)*f+(i.y-n.y)*_-d<0||(o.x-n.x)*f+(o.y-n.y)*_-d<0||(l.x-n.x)*f+(l.y-n.y)*_-d<0)}function Hr(n,e,i,o,l,d,f){return!(lr(n,e,o,l,d,f)||lr(e,i,o,l,d,f)||lr(i,n,o,l,d,f)||lr(o,l,n,e,i,f)||lr(l,d,n,e,i,f)||lr(d,o,n,e,i,f))}function qr(n,e,i){const o=e.paint.get(n).value;return o.kind==="constant"?o.value:i.programConfigurations.get(e.id).getMaxValue(n)}function zr(n){return Math.sqrt(n[0]*n[0]+n[1]*n[1])}function No(n,e,i,o,l){if(!e[0]&&!e[1])return n;const d=et.convert(e)._mult(l);i==="viewport"&&d._rotate(-o);const f=[];for(let _=0;_<n.length;_++)f.push(n[_].sub(d));return f}function ns(n,e,i,o){const l=et.convert(n)._mult(o);return e==="viewport"&&l._rotate(-i),l}let xo,Nn;function Wn(n,e,i){var o=2*Math.PI*6378137/256/Math.pow(2,i);return[n*o-2*Math.PI*6378137/2,e*o-2*Math.PI*6378137/2]}It(Xi,"CircleBucket",{omit:["layers"]});class on{constructor(e,i,o){this.z=e,this.x=i,this.y=o,this.key=Pn(0,e,e,i,o)}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y}isChildOf(e){const i=this.z-e.z;return e.z===0||e.z<this.z&&e.x===this.x>>i&&e.y===this.y>>i}url(e,i){const o=function(d,f,_){var v=Wn(256*d,256*(f=Math.pow(2,_)-f-1),_),b=Wn(256*(d+1),256*(f+1),_);return v[0]+","+v[1]+","+b[0]+","+b[1]}(this.x,this.y,this.z),l=function(d,f,_){let v,b="";for(let E=d;E>0;E--)v=1<<E-1,b+=(f&v?1:0)+(_&v?2:0);return b}(this.z,this.x,this.y);return e[(this.x+this.y)%e.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(i==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",l).replace("{bbox-epsg-3857}",o)}toString(){return`${this.z}/${this.x}/${this.y}`}}class Yn{constructor(e,i){this.wrap=e,this.canonical=i,this.key=Pn(e,i.z,i.z,i.x,i.y)}}class Dn{constructor(e,i,o,l,d){this.overscaledZ=e,this.wrap=i,this.canonical=new on(o,+l,+d),this.key=i===0&&e===o?this.canonical.key:Pn(i,e,o,l,d)}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical)}scaledTo(e){const i=this.canonical.z-e;return e>this.canonical.z?new Dn(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new Dn(e,this.wrap,e,this.canonical.x>>i,this.canonical.y>>i)}calculateScaledKey(e,i=!0){if(this.overscaledZ===e&&i)return this.key;if(e>this.canonical.z)return Pn(this.wrap*+i,e,this.canonical.z,this.canonical.x,this.canonical.y);{const o=this.canonical.z-e;return Pn(this.wrap*+i,e,e,this.canonical.x>>o,this.canonical.y>>o)}}isChildOf(e){if(e.wrap!==this.wrap)return!1;const i=this.canonical.z-e.canonical.z;return e.overscaledZ===0||e.overscaledZ<this.overscaledZ&&e.canonical.z<this.canonical.z&&e.canonical.x===this.canonical.x>>i&&e.canonical.y===this.canonical.y>>i}children(e){if(this.overscaledZ>=e)return[new Dn(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const i=this.canonical.z+1,o=2*this.canonical.x,l=2*this.canonical.y;return[new Dn(i,this.wrap,i,o,l),new Dn(i,this.wrap,i,o+1,l),new Dn(i,this.wrap,i,o,l+1),new Dn(i,this.wrap,i,o+1,l+1)]}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y))}wrapped(){return new Dn(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(e){return new Dn(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new Yn(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function Pn(n,e,i,o,l){const d=1<<Math.min(i,22);let f=d*(l%d)+o%d;return n&&i<22&&(f+=d*d*((n<0?-2*n-1:2*n)%(1<<2*(22-i)))),16*(32*f+i)+(e-i)}const rs=[n=>{let e=n.canonical.x-1,i=n.wrap;return e<0&&(e=(1<<n.canonical.z)-1,i--),new Dn(n.overscaledZ,i,n.canonical.z,e,n.canonical.y)},n=>{let e=n.canonical.x+1,i=n.wrap;return e===1<<n.canonical.z&&(e=0,i++),new Dn(n.overscaledZ,i,n.canonical.z,e,n.canonical.y)},n=>new Dn(n.overscaledZ,n.wrap,n.canonical.z,n.canonical.x,(n.canonical.y===0?1<<n.canonical.z:n.canonical.y)-1),n=>new Dn(n.overscaledZ,n.wrap,n.canonical.z,n.canonical.x,n.canonical.y===(1<<n.canonical.z)-1?0:n.canonical.y+1)];It(on,"CanonicalTileID"),It(Dn,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});const ah=_i([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:bs}=ah,lh=_i([{name:"a_pos_3",components:3,type:"Int16"}]);var Vc=_i([{name:"a_pos",type:"Int16",components:2}]);function Ws(n){return n*Gr/u}const wa=[new Lt([ts,ts,ts],[is,is,is]),new Lt([ts,ts,ts],[0,0,is]),new Lt([0,ts,ts],[is,0,is]),new Lt([ts,0,ts],[0,is,is]),new Lt([0,0,ts],[is,is,is])];function $c(n,e,i,o=!0){const l=gn([],n._camera.position,n.worldSize),d=[e,i,1,1];Ur(d,d,n.pixelMatrixInverse),Ga(d,d,1/d[3]);const f=yn([],Qn([],d,l)),_=n.globeMatrix,v=[_[12],_[13],_[14]],b=Qn([],v,l),E=pr(b),I=yn([],b),C=n.worldSize/(2*Math.PI),R=qn(I,f),k=Math.asin(C/E);if(k<Math.acos(R)){if(!o)return null;const Fe=[],be=[];gn(Fe,f,E/R),yn(be,Qn(be,Fe,b)),yn(f,$t(f,b,gn(f,be,Math.tan(k)*E)))}const F=[];new At(l,f).closestPointOnSphere(v,C,F);const U=yn([],Vn(_,0)),j=yn([],Vn(_,1)),H=yn([],Vn(_,2)),W=qn(U,F),Y=qn(j,F),se=qn(H,F),ie=Kr(Math.asin(-Y/C));let ce=Kr(Math.atan2(W,se));ce=n.center.lng+function(Fe,be){const Ue=(be-Fe+180)%360-180;return Ue<-180?Ue+360:Ue}(n.center.lng,ce);const fe=w(ce),ge=V(T(ie),0,1);return new X(fe,ge)}class hl{constructor(e,i,o){this.a=Qn([],e,o),this.b=Qn([],i,o),this.center=o;const l=yn([],this.a),d=yn([],this.b);this.angle=Math.acos(qn(l,d))}}function ba(n,e){if(n.angle===0)return null;let i;return i=n.a[e]===0?1/n.angle*.5*Math.PI:1/n.angle*Math.atan(n.b[e]/n.a[e]/Math.sin(n.angle)-1/Math.tan(n.angle)),i<0||i>1?null:function(o,l,d,f){const _=Math.sin(d);return o*(Math.sin((1-f)*d)/_)+l*(Math.sin(f*d)/_)}(n.a[e],n.b[e],n.angle,V(i,0,1))+n.center[e]}function Ts(n){if(n.z<=1)return wa[n.z+2*n.y+n.x];const e=hx(dy(n));return Lt.fromPoints(e)}function Ta(n,e,i){return gn(n,n,1-i),Er(n,n,e,i)}function fT(n,e,i){for(const o of n)Kn(o,o,e),gn(o,o,i)}function pT(n,e,i,o){const l=e/n.worldSize,d=n.globeMatrix;if(i.z<=1){const ge=Ts(i).getCorners();return fT(ge,d,l),Lt.fromPoints(ge)}const f=dy(i,o),_=hx(f,Gr+Ws(n._tileCoverLift));fT(_,d,l);const v=Number.MAX_VALUE,b=[-v,-v,-v],E=[v,v,v];if(f.contains(n.center)){for(const be of _)On(E,E,be),Un(b,b,be);b[2]=0;const ge=n.point,Fe=[ge.x*l,ge.y*l,0];return On(E,E,Fe),Un(b,b,Fe),new Lt(E,b)}if(n._tileCoverLift>0){for(const ge of _)On(E,E,ge),Un(b,b,ge);return new Lt(E,b)}const I=[d[12]*l,d[13]*l,d[14]*l],C=f.getCenter(),R=V(n.center.lat,-D,D),k=V(C.lat,-D,D),F=w(n.center.lng),U=T(R);let j=F-w(C.lng);const H=U-T(k);j>.5?j-=1:j<-.5&&(j+=1);let W=0;Math.abs(j)>Math.abs(H)?W=j>=0?1:3:(W=H>=0?0:2,Er(I,I,[d[4]*l,d[5]*l,d[6]*l],-Math.sin(Oi(H>=0?f.getSouth():f.getNorth()))*Gr));const Y=_[W],se=_[(W+1)%4],ie=new hl(Y,se,I),ce=[ba(ie,0)||Y[0],ba(ie,1)||Y[1],ba(ie,2)||Y[2]],fe=Gc(n.zoom);if(fe>0){const ge=function({x:be,y:Ue,z:He},qe,tt,nt,Ye){const Je=1/(1<<He);let je=be*Je,Be=je+Je,Qe=Ue*Je,ft=Qe+Je,at=0;const Ot=(je+Be)/2-nt;return Ot>.5?at=-1:Ot<-.5&&(at=1),je=((je+at)*qe-(nt*=qe))*tt+nt,Be=((Be+at)*qe-nt)*tt+nt,Qe=(Qe*qe-(Ye*=qe))*tt+Ye,ft=(ft*qe-Ye)*tt+Ye,[[je,ft,0],[Be,ft,0],[Be,Qe,0],[je,Qe,0]]}(i,e,n._pixelsPerMercatorPixel,F,U);for(let be=0;be<_.length;be++)Ta(_[be],ge[be],fe);const Fe=$t([],ge[W],ge[(W+1)%4]);gn(Fe,Fe,.5),Ta(ce,Fe,fe)}for(const ge of _)On(E,E,ge),Un(b,b,ge);return E[2]=Math.min(Y[2],se[2]),On(E,E,ce),Un(b,b,ce),new Lt(E,b)}function dy({x:n,y:e,z:i},o=!1){const l=1/(1<<i),d=new r(M(n*l),e===(1<<i)-1&&o?-90:z((e+1)*l)),f=new r(M((n+1)*l),e===0&&o?90:z(e*l));return new h(d,f)}function hx(n,e=Gr){const i=Oi(n.getNorth()),o=Oi(n.getSouth()),l=Math.cos(i),d=Math.cos(o),f=Math.sin(i),_=Math.sin(o),v=n.getWest(),b=n.getEast();return[Yl(d,_,v,e),Yl(d,_,b,e),Yl(l,f,b,e),Yl(l,f,v,e)]}function xm(n,e,i,o){const l=1<<i.z,d=(n/dt+i.x)/l;return Uc(z((e/dt+i.y)/l),M(d),o)}function fy({min:n,max:e}){return ux/Math.max(e[0]-n[0],e[1]-n[1],e[2]-n[2])}const mT=new Float64Array(16);function py(n){const e=fy(n),i=Zt(mT,[e,e,e]);return Pe(i,i,Ua([],n.min))}function dx(n){const e=(o=n.min,(i=mT)[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=o[0],i[13]=o[1],i[14]=o[2],i[15]=1,i);var i,o;const l=1/fy(n);return Ze(e,e,[l,l,l])}function fx(n){const e=dt/(2*Math.PI);return n/(2*Math.PI)/e}function _T(n,e){return dt/(512*Math.pow(2,n))*fy(Ts(e))}function gT(n,e,i,o,l){const d=fx(i),f=[n,e,-i/(2*Math.PI)],_=ct(new Float64Array(16));return Pe(_,_,f),Ze(_,_,[d,d,d]),Ct(_,_,Oi(-l)),kt(_,_,Oi(-o)),_}function Gc(n){return q(es,nf,n)}function yT(n,e){const i=Uc(e.lat,e.lng),o=function(k){const F=Uc(k._center.lat,k._center.lng);let U=jr([],In(0,1,0),F);const j=mn([],-k.angle,F);U=Kn(U,U,j),mn(j,-k._pitch,U);const H=yn([],F);return gn(H,H,Ws(k.cameraToCenterDistance/k.pixelsPerMeter)),Kn(H,H,j),$t([],F,H)}(n);return f=(l=ki([],o,i))[0],_=l[1],v=l[2],b=(d=i)[0],E=d[1],I=d[2],R=(C=Math.sqrt((f*f+_*_+v*v)*(b*b+E*E+I*I)))&&qn(l,d)/C,Math.acos(Math.min(Math.max(R,-1),1));var l,d,f,_,v,b,E,I,C,R}function px(n,e){return yT(n,e)>Math.PI/2*1.01}const vT=Oi(85),TM=Math.cos(vT),SM=Math.sin(vT),EM=mt(),xT=n=>{const e=[];return n.paint.get("circle-pitch-alignment")==="map"&&e.push("PITCH_WITH_MAP"),n.paint.get("circle-pitch-scale")==="map"&&e.push("SCALE_WITH_MAP"),e};function wT(n,e,i,o,l,d,f,_,v){if(d&&n.queryGeometry.isAboveHorizon)return!1;d&&(v*=n.pixelToTileUnitsFactor);const b=n.tileID.canonical,E=i.projection.upVectorScale(b,i.center.lat,i.worldSize).metersToTile;for(const I of e)for(const C of I){const R=C.add(_),k=l&&i.elevation?i.elevation.exaggeration()*l.getElevationAt(R.x,R.y,!0):0,F=i.projection.projectTilePoint(R.x,R.y,b);if(k>0){const W=i.projection.upVector(b,R.x,R.y);F.x+=W[0]*E*k,F.y+=W[1]*E*k,F.z+=W[2]*E*k}const U=d?R:IM(F.x,F.y,F.z,o),j=d?n.tilespaceRays.map(W=>CM(W,k)):n.queryGeometry.screenGeometry,H=Ur([],[F.x,F.y,F.z,1],o);if(!f&&d?v*=H[3]/i.cameraToCenterDistance:f&&!d&&(v*=i.cameraToCenterDistance/H[3]),d){const W=z((C.y/dt+b.y)/(1<<b.z));v/=i.projection.pixelsPerMeter(W,1)/A(1,W)}if(ci(j,U,v))return!0}return!1}function IM(n,e,i,o){const l=Ur([],[n,e,i,1],o);return new et(l[0]/l[3],l[1]/l[3])}const bT=In(0,0,0),AM=In(0,0,1);function CM(n,e){const i=Ri();return bT[2]=e,n.intersectsPlane(bT,AM,i),new et(i[0],i[1])}class TT extends Xi{}let ST,ET,IT,AT;function CT(n,{width:e,height:i},o,l){if(l){if(l instanceof Uint8ClampedArray)l=new Uint8Array(l.buffer);else if(l.length!==e*i*o)throw new RangeError("mismatched image size")}else l=new Uint8Array(e*i*o);return n.width=e,n.height=i,n.data=l,n}function PT(n,e,i){const{width:o,height:l}=e;o===n.width&&l===n.height||(mx(n,e,{x:0,y:0},{x:0,y:0},{width:Math.min(n.width,o),height:Math.min(n.height,l)},i,null),n.width=o,n.height=l,n.data=e.data)}function mx(n,e,i,o,l,d,f,_){if(l.width===0||l.height===0)return e;if(l.width>n.width||l.height>n.height||i.x>n.width-l.width||i.y>n.height-l.height)throw new RangeError("out of range source coordinates for image copy");if(l.width>e.width||l.height>e.height||o.x>e.width-l.width||o.y>e.height-l.height)throw new RangeError("out of range destination coordinates for image copy");const v=n.data,b=e.data,E=d===4&&_;for(let I=0;I<l.height;I++){const C=((i.y+I)*n.width+i.x)*d,R=((o.y+I)*e.width+o.x)*d;if(E)for(let k=0;k<l.width;k++){const F=C+k*d+3,U=R+k*d;b[U+0]=255,b[U+1]=255,b[U+2]=255,b[U+3]=v[F]}else if(f)for(let k=0;k<l.width;k++){const F=C+k*d,U=R+k*d,j=new Zi(v[F+0]/255,v[F+1]/255,v[F+2]/255,v[F+3]).toNonPremultipliedRenderColor(f).toArray();b[U+0]=j[0],b[U+1]=j[1],b[U+2]=j[2],b[U+3]=j[3]}else for(let k=0;k<l.width*d;k++)b[R+k]=v[C+k]}return e}It(TT,"HeatmapBucket",{omit:["layers"]});class Hc{constructor(e,i){CT(this,e,1,i)}resize(e){PT(this,new Hc(e),1)}clone(){return new Hc({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,i,o,l,d){mx(e,i,o,l,d,1,null)}}class Wr{constructor(e,i){CT(this,e,4,i)}resize(e){PT(this,new Wr(e),4)}replace(e,i){i?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e}clone(){return new Wr({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,i,o,l,d,f,_){mx(e,i,o,l,d,4,f,_)}}class MT{constructor(e,i){this.width=e.width,this.height=e.height,this.data=i instanceof Uint8Array?new Float32Array(i.buffer):i}}function wm(n){const e={},i=n.resolution||256,o=n.clips?n.clips.length:1,l=n.image||new Wr({width:i,height:o}),d=(f,_,v)=>{e[n.evaluationKey]=v;const b=n.expression.evaluate(e),E=b?b.toNonPremultipliedRenderColor(null):null;E&&(l.data[f+_+0]=Math.floor(255*E.r),l.data[f+_+1]=Math.floor(255*E.g),l.data[f+_+2]=Math.floor(255*E.b),l.data[f+_+3]=Math.floor(255*E.a))};if(n.clips)for(let f=0,_=0;f<o;++f,_+=4*i)for(let v=0,b=0;v<i;v++,b+=4){const E=v/(i-1),{start:I,end:C}=n.clips[f];d(_,b,I*(1-E)+C*E)}else for(let f=0,_=0;f<i;f++,_+=4)d(0,_,f/(i-1));return l}It(Hc,"AlphaImage"),It(Wr,"RGBAImage");const PM=_i([{name:"a_pos",components:2,type:"Int16"}],4),MM=_i([{name:"a_road_z_offset",components:1,type:"Float32"}],4),RM=_i([{name:"a_pos",components:2,type:"Int16"},{name:"a_height",components:1,type:"Float32"}],4),kM=_i([{name:"a_pos_normal_3",components:3,type:"Int16"}],4);function rf(n,e,i=2){const o=e&&e.length,l=o?e[0]*i:n.length;let d=RT(n,0,l,i,!0);const f=[];if(!d||d.next===d.prev)return f;let _,v,b;if(o&&(d=function(E,I,C,R){const k=[];for(let F=0,U=I.length;F<U;F++){const j=RT(E,I[F]*R,F<U-1?I[F+1]*R:E.length,R,!1);j===j.next&&(j.steiner=!0),k.push(jM(j))}k.sort(FM);for(let F=0;F<k.length;F++)C=BM(k[F],C);return C}(n,e,d,i)),n.length>80*i){_=n[0],v=n[1];let E=_,I=v;for(let C=i;C<l;C+=i){const R=n[C],k=n[C+1];R<_&&(_=R),k<v&&(v=k),R>E&&(E=R),k>I&&(I=k)}b=Math.max(E-_,I-v),b=b!==0?32767/b:0}return bm(d,f,i,_,v,b,0),f}function RT(n,e,i,o,l){let d;if(l===function(f,_,v,b){let E=0;for(let I=_,C=v-b;I<v;I+=b)E+=(f[C]-f[I])*(f[I+1]+f[C+1]),C=I;return E}(n,e,i,o)>0)for(let f=e;f<i;f+=o)d=DT(f/o|0,n[f],n[f+1],d);else for(let f=i-o;f>=e;f-=o)d=DT(f/o|0,n[f],n[f+1],d);return d&&of(d,d.next)&&(Em(d),d=d.next),d}function ch(n,e){if(!n)return n;e||(e=n);let i,o=n;do if(i=!1,o.steiner||!of(o,o.next)&&Pr(o.prev,o,o.next)!==0)o=o.next;else{if(Em(o),o=e=o.prev,o===o.next)break;i=!0}while(i||o!==e);return e}function bm(n,e,i,o,l,d,f){if(!n)return;!f&&d&&function(v,b,E,I){let C=v;do C.z===0&&(C.z=_x(C.x,C.y,b,E,I)),C.prevZ=C.prev,C.nextZ=C.next,C=C.next;while(C!==v);C.prevZ.nextZ=null,C.prevZ=null,function(R){let k,F=1;do{let U,j=R;R=null;let H=null;for(k=0;j;){k++;let W=j,Y=0;for(let ie=0;ie<F&&(Y++,W=W.nextZ,W);ie++);let se=F;for(;Y>0||se>0&&W;)Y!==0&&(se===0||!W||j.z<=W.z)?(U=j,j=j.nextZ,Y--):(U=W,W=W.nextZ,se--),H?H.nextZ=U:R=U,U.prevZ=H,H=U;j=W}H.nextZ=null,F*=2}while(k>1)}(C)}(n,o,l,d);let _=n;for(;n.prev!==n.next;){const v=n.prev,b=n.next;if(d?zM(n,o,l,d):LM(n))e.push(v.i,n.i,b.i),Em(n),n=b.next,_=b.next;else if((n=b)===_){f?f===1?bm(n=DM(ch(n),e),e,i,o,l,d,2):f===2&&OM(n,e,i,o,l,d):bm(ch(n),e,i,o,l,d,1);break}}}function LM(n){const e=n.prev,i=n,o=n.next;if(Pr(e,i,o)>=0)return!1;const l=e.x,d=i.x,f=o.x,_=e.y,v=i.y,b=o.y,E=Math.min(l,d,f),I=Math.min(_,v,b),C=Math.max(l,d,f),R=Math.max(_,v,b);let k=o.next;for(;k!==e;){if(k.x>=E&&k.x<=C&&k.y>=I&&k.y<=R&&Tm(l,_,d,v,f,b,k.x,k.y)&&Pr(k.prev,k,k.next)>=0)return!1;k=k.next}return!0}function zM(n,e,i,o){const l=n.prev,d=n,f=n.next;if(Pr(l,d,f)>=0)return!1;const _=l.x,v=d.x,b=f.x,E=l.y,I=d.y,C=f.y,R=Math.min(_,v,b),k=Math.min(E,I,C),F=Math.max(_,v,b),U=Math.max(E,I,C),j=_x(R,k,e,i,o),H=_x(F,U,e,i,o);let W=n.prevZ,Y=n.nextZ;for(;W&&W.z>=j&&Y&&Y.z<=H;){if(W.x>=R&&W.x<=F&&W.y>=k&&W.y<=U&&W!==l&&W!==f&&Tm(_,E,v,I,b,C,W.x,W.y)&&Pr(W.prev,W,W.next)>=0||(W=W.prevZ,Y.x>=R&&Y.x<=F&&Y.y>=k&&Y.y<=U&&Y!==l&&Y!==f&&Tm(_,E,v,I,b,C,Y.x,Y.y)&&Pr(Y.prev,Y,Y.next)>=0))return!1;Y=Y.nextZ}for(;W&&W.z>=j;){if(W.x>=R&&W.x<=F&&W.y>=k&&W.y<=U&&W!==l&&W!==f&&Tm(_,E,v,I,b,C,W.x,W.y)&&Pr(W.prev,W,W.next)>=0)return!1;W=W.prevZ}for(;Y&&Y.z<=H;){if(Y.x>=R&&Y.x<=F&&Y.y>=k&&Y.y<=U&&Y!==l&&Y!==f&&Tm(_,E,v,I,b,C,Y.x,Y.y)&&Pr(Y.prev,Y,Y.next)>=0)return!1;Y=Y.nextZ}return!0}function DM(n,e){let i=n;do{const o=i.prev,l=i.next.next;!of(o,l)&&LT(o,i,i.next,l)&&Sm(o,l)&&Sm(l,o)&&(e.push(o.i,i.i,l.i),Em(i),Em(i.next),i=n=l),i=i.next}while(i!==n);return ch(i)}function OM(n,e,i,o,l,d){let f=n;do{let _=f.next.next;for(;_!==f.prev;){if(f.i!==_.i&&UM(f,_)){let v=zT(f,_);return f=ch(f,f.next),v=ch(v,v.next),bm(f,e,i,o,l,d,0),void bm(v,e,i,o,l,d,0)}_=_.next}f=f.next}while(f!==n)}function FM(n,e){let i=n.x-e.x;return i===0&&(i=n.y-e.y,i===0)&&(i=(n.next.y-n.y)/(n.next.x-n.x)-(e.next.y-e.y)/(e.next.x-e.x)),i}function BM(n,e){const i=function(l,d){let f=d;const _=l.x,v=l.y;let b,E=-1/0;if(of(l,f))return f;do{if(of(l,f.next))return f.next;if(v<=f.y&&v>=f.next.y&&f.next.y!==f.y){const F=f.x+(v-f.y)*(f.next.x-f.x)/(f.next.y-f.y);if(F<=_&&F>E&&(E=F,b=f.x<f.next.x?f:f.next,F===_))return b}f=f.next}while(f!==d);if(!b)return null;const I=b,C=b.x,R=b.y;let k=1/0;f=b;do{if(_>=f.x&&f.x>=C&&_!==f.x&&kT(v<R?_:E,v,C,R,v<R?E:_,v,f.x,f.y)){const F=Math.abs(v-f.y)/(_-f.x);Sm(f,l)&&(F<k||F===k&&(f.x>b.x||f.x===b.x&&NM(b,f)))&&(b=f,k=F)}f=f.next}while(f!==I);return b}(n,e);if(!i)return e;const o=zT(i,n);return ch(o,o.next),ch(i,i.next)}function NM(n,e){return Pr(n.prev,n,e.prev)<0&&Pr(e.next,n,n.next)<0}function _x(n,e,i,o,l){return(n=1431655765&((n=858993459&((n=252645135&((n=16711935&((n=(n-i)*l|0)|n<<8))|n<<4))|n<<2))|n<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-o)*l|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function jM(n){let e=n,i=n;do(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next;while(e!==n);return i}function kT(n,e,i,o,l,d,f,_){return(l-f)*(e-_)>=(n-f)*(d-_)&&(n-f)*(o-_)>=(i-f)*(e-_)&&(i-f)*(d-_)>=(l-f)*(o-_)}function Tm(n,e,i,o,l,d,f,_){return!(n===f&&e===_)&&kT(n,e,i,o,l,d,f,_)}function UM(n,e){return n.next.i!==e.i&&n.prev.i!==e.i&&!function(i,o){let l=i;do{if(l.i!==i.i&&l.next.i!==i.i&&l.i!==o.i&&l.next.i!==o.i&&LT(l,l.next,i,o))return!0;l=l.next}while(l!==i);return!1}(n,e)&&(Sm(n,e)&&Sm(e,n)&&function(i,o){let l=i,d=!1;const f=(i.x+o.x)/2,_=(i.y+o.y)/2;do l.y>_!=l.next.y>_&&l.next.y!==l.y&&f<(l.next.x-l.x)*(_-l.y)/(l.next.y-l.y)+l.x&&(d=!d),l=l.next;while(l!==i);return d}(n,e)&&(Pr(n.prev,n,e.prev)||Pr(n,e.prev,e))||of(n,e)&&Pr(n.prev,n,n.next)>0&&Pr(e.prev,e,e.next)>0)}function Pr(n,e,i){return(e.y-n.y)*(i.x-e.x)-(e.x-n.x)*(i.y-e.y)}function of(n,e){return n.x===e.x&&n.y===e.y}function LT(n,e,i,o){const l=_y(Pr(n,e,i)),d=_y(Pr(n,e,o)),f=_y(Pr(i,o,n)),_=_y(Pr(i,o,e));return l!==d&&f!==_||!(l!==0||!my(n,i,e))||!(d!==0||!my(n,o,e))||!(f!==0||!my(i,n,o))||!(_!==0||!my(i,e,o))}function my(n,e,i){return e.x<=Math.max(n.x,i.x)&&e.x>=Math.min(n.x,i.x)&&e.y<=Math.max(n.y,i.y)&&e.y>=Math.min(n.y,i.y)}function _y(n){return n>0?1:n<0?-1:0}function Sm(n,e){return Pr(n.prev,n,n.next)<0?Pr(n,e,n.next)>=0&&Pr(n,n.prev,e)>=0:Pr(n,e,n.prev)<0||Pr(n,n.next,e)<0}function zT(n,e){const i=gx(n.i,n.x,n.y),o=gx(e.i,e.x,e.y),l=n.next,d=e.prev;return n.next=e,e.prev=n,i.next=l,l.prev=i,o.next=i,i.prev=o,d.next=o,o.prev=d,o}function DT(n,e,i,o){const l=gx(n,e,i);return o?(l.next=o.next,l.prev=o,o.next.prev=l,o.next=l):(l.prev=l,l.next=l),l}function Em(n){n.next.prev=n.prev,n.prev.next=n.next,n.prevZ&&(n.prevZ.nextZ=n.nextZ),n.nextZ&&(n.nextZ.prevZ=n.prevZ)}function gx(n,e,i){return{i:n,x:e,y:i,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function Im(n,e){const i=n.length;if(i<=1)return[n];const o=[];let l,d;for(let f=0;f<i;f++){const _=si(n[f]);_!==0&&(n[f].area=Math.abs(_),d===void 0&&(d=_<0),d===_<0?(l&&o.push(l),l=[n[f]]):l.push(n[f]))}if(l&&o.push(l),e>1)for(let f=0;f<o.length;f++)o[f].length<=e||(td(o[f],e,1,o[f].length-1,VM),o[f]=o[f].slice(0,e));return o}function VM(n,e){return e.area-n.area}function OT(n,e,i=1){if(!n)return null;const o=typeof n=="string"?oo.from(n).getPrimary():n.getPrimary(),l=typeof n=="string"?null:n.getSecondary();for(const d of[o,l]){if(!d)continue;const f=d.id.toString();e.has(f)||e.set(f,[]),d.scaleSelf(i),e.get(f).push(d)}return{primary:o.toString(),secondary:l?l.toString():null}}function yx(n,e,i,o){const l=o.patternDependencies;let d=!1;for(const f of e){const _=f.paint.get(`${n}-pattern`);_.isConstant()||(d=!0),OT(_.constantOr(null),l,i)&&(d=!0)}return d}function vx(n,e,i,o,l,d){const f=d.patternDependencies;for(const _ of e){const v=_.paint.get(`${n}-pattern`).value;if(v.kind!=="constant"){let b=v.evaluate({zoom:o},i,{},d.availableImages);b=b&&b.name?b.name:b;const E=OT(b,f,l);if(!E)continue;const{primary:I,secondary:C}=E;I&&(i.patterns[_.id]=[I,C].filter(Boolean))}}return i}class FT{constructor(){this.polygons=new Map}add(e,...i){const o=this.polygons.get(e);o?o.push(...i):this.polygons.set(e,i)}merge(e){for(const[i,o]of e.polygons)this.add(i,...o)}}class Jl{constructor(){this.portals=[]}static isOnBorder(e,i){return e<=0&&i<=0||e>=dt&&i>=dt}static evaluate(e){if(e.length===0)return new Jl;let i=[];for(const v of e)i.push(...v.portals);if(i.length===0)return new Jl;for(const v of i){const b=v.va,E=v.vb;(Jl.isOnBorder(b.x,E.x)||Jl.isOnBorder(b.y,E.y))&&(v.type="border")}const o=i.filter(v=>v.type!=="unevaluated"),l=i.filter(v=>v.type==="unevaluated");if(l.length===0)return new Jl;l.sort((v,b)=>v.hash===b.hash?v.isTunnel===b.isTunnel?0:v.isTunnel?-1:1:v.hash<b.hash?1:-1),i=o.concat(l);let d=o.length,f=d,_=d;do if(f++,f===i.length||i[d].hash!==i[f].hash){if(f-d==2){_<d&&(i[_]=i[d],i[d]=null);const v=i[_],b=i[f-1];v.type=v.isTunnel!==b.isTunnel?"tunnel":"polygon",v.connection={a:v.connection.a,b:b.connection.a},_++}d=f}while(d!==i.length);return i.splice(_),i.sort((v,b)=>v.hash<b.hash?1:-1),{portals:i}}}It(Jl,"ElevationPortalGraph"),It(FT,"ElevationPolygons");class $M{constructor(e,i,o){this.outPositions=e,this.outNormals=i,this.outIndices=o,this.vertexLookup=new Map}addVertex(e,i,o){let l=e[2];o!=null&&(l*=o);const d=`${e[0]},${e[1]},${e[2]},${i[0]},${i[1]},${i[2]}`,f=this.vertexLookup.get(d);if(f!=null)return f;const _=this.outPositions.length;this.vertexLookup.set(d,_);const v=Math.trunc(16384*i[0]),b=Math.trunc(16384*i[1]),E=Math.trunc(16384*i[2]);return this.outPositions.emplaceBack(e[0],e[1],l),this.outNormals.emplaceBack(v,b,E),_}addTriangle(e,i,o){this.outIndices.emplaceBack(e,i,o)}addTriangles(e,i,o){if(e.length===0)return;const l=o.length===1,d=Ri(),f=Ri();for(let _=0;_<e.length;_+=3){const v=i[e[_+0]],b=i[e[_+1]],E=i[e[_+2]],I=l?o[0]:o[e[_+1]],C=l?o[0]:o[e[_+2]];dn(d,v.x,v.y,l?o[0]:o[e[_+0]]);const R=this.addVertex(d,f);dn(d,b.x,b.y,I);const k=this.addVertex(d,f);dn(d,E.x,E.y,C);const F=this.addVertex(d,f);this.outIndices.emplaceBack(R,k,F)}}addQuad(e,i,o,l,d,f){const _=this.addVertex(e,d,f),v=this.addVertex(i,d,f),b=this.addVertex(o,d,f),E=this.addVertex(l,d,f);this.addTriangle(_,v,b),this.addTriangle(b,E,_)}getVertexCount(){return this.outPositions.length}clearVertexLookup(){this.vertexLookup.clear()}}class jo{constructor(e,i,o,l){this.unevaluatedPortals=new Jl,this.portalPolygons=new FT,this.bridgeFeatureSections=[],this.tunnelFeatureSections=[],this.vertexHashLookup=new Map,this.unevalVertices=[],this.unevalHeights=[],this.unevalTriangles=[],this.unevalTunnelTriangles=[],this.unevalEdges=[],this.vertexPositions=new em,this.vertexNormals=new tm,this.indexArray=new sr,this.tileToMeters=$(e),this.bridgeProgramConfigurations=new ws(i,{zoom:o,lut:l},d=>d!=="fill-tunnel-structure-color"),this.tunnelProgramConfigurations=new ws(i,{zoom:o,lut:l},d=>d!=="fill-bridge-guard-rail-color")}addVertices(e,i){const o=this.unevalVertices.length;for(let l=0;l<e.length;l++)this.unevalVertices.push(e[l]),this.unevalHeights.push(i[l]);return o}addTriangles(e,i,o){const l=o?this.unevalTunnelTriangles:this.unevalTriangles;for(const d of e)l.push(d+i)}addRenderableRing(e,i,o,l,d,f){const _=[new et(d.min.x,d.min.y),new et(d.max.x,d.min.y),new et(d.max.x,d.max.y),new et(d.min.x,d.max.y)];for(let v=0;v<o-1;v++){const b=i+v,E=b+1,I=this.unevalVertices[b],C=this.unevalVertices[E];if(!(I.x>=d.min.x&&I.x<=d.max.x&&I.y>=d.min.y&&I.y<=d.max.y||C.x>=d.min.x&&C.x<=d.max.x&&C.y>=d.min.y&&C.y<=d.max.y||Fr(I,C,_))||this.isOnBorder(I.x,C.x)||this.isOnBorder(I.y,C.y))continue;const R=jo.computeEdgeHash(this.unevalVertices[b],this.unevalVertices[E]);let k,F=this.vertexHashLookup.get(jo.computePosHash(I));F!=null?k=F.next:(F=this.vertexHashLookup.get(jo.computePosHash(C)),k=F!=null?F.prev:R),this.unevalEdges.push({polygonIdx:e,a:b,b:E,hash:R,portalHash:k,isTunnel:l,type:"unevaluated",featureInfo:f})}}addPortalCandidates(e,i,o,l,d){if(i.length===0)return;this.portalPolygons.add(e,{geometry:i,zLevel:d});const f=i[0];this.vertexHashLookup.clear();let _=jo.computeEdgeHash(f[f.length-2],f[f.length-1]);for(let v=0;v<f.length-1;v++){const b=f[v+0],E=f[v+1],I=po(E.x-b.x,E.y-b.y),C=ds(I);if(C===0)continue;let R="unevaluated";const k=l.pointElevation(b),F=l.pointElevation(E);Math.abs(k)<.01&&Math.abs(F)<.01?R="entrance":(this.isOnBorder(b.x,E.x)||this.isOnBorder(b.y,E.y))&&(R="border");const U=jo.computeEdgeHash(b,E);this.unevaluatedPortals.portals.push({connection:{a:e,b:void 0},va:b,vb:E,vab:I,length:C,hash:U,isTunnel:o,type:R});const j=jo.computePosHash(b);this.vertexHashLookup.set(j,{prev:_,next:U}),_=U}}construct(e){if(this.unevalVertices.length===0)return;const i=()=>({vertexOffset:0,primitiveOffset:this.indexArray.length}),o=C=>{C.primitiveLength=this.indexArray.length-C.primitiveOffset},l=new $M(this.vertexPositions,this.vertexNormals,this.indexArray);this.prepareEdges(e.portals,this.unevalEdges);const d=i(),f=i(),_=i(),v=(C,R)=>{C.sort((F,U)=>F.type===R&&U.type!==R?-1:F.type!==R&&U.type===R?1:0);const k=C.findIndex(F=>F.type!==R);return k>=0?k:C.length};let b=0;this.unevalEdges.length>0&&(b=v(this.unevalEdges,"none"),this.constructBridgeStructures(l,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:b},this.tileToMeters)),o(_);const E=i(),I=i();if(this.unevalEdges.length>0){const C=this.unevalEdges.splice(b),R=v(C,"tunnel")+b;this.unevalEdges.push(...C),this.constructTunnelStructures(l,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:b},{min:b,max:R})}o(E),l.addTriangles(this.unevalTriangles,this.unevalVertices,this.unevalHeights),o(I),l.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,this.unevalHeights),o(f),l.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,[-.1]),o(d),this.maskSegments=An.simpleSegment(0,I.primitiveOffset,0,I.primitiveLength),this.depthSegments=An.simpleSegment(0,f.primitiveOffset,0,f.primitiveLength),this.renderableBridgeSegments=An.simpleSegment(0,_.primitiveOffset,0,_.primitiveLength),this.renderableTunnelSegments=An.simpleSegment(0,E.primitiveOffset,0,E.primitiveLength),this.shadowCasterSegments=An.simpleSegment(0,d.primitiveOffset,0,d.primitiveLength)}update(e,i,o,l,d,f,_,v){this.bridgeProgramConfigurations.updatePaintArrays(e,i,d,o,l,f,_,v),this.tunnelProgramConfigurations.updatePaintArrays(e,i,d,o,l,f,_,v)}upload(e){this.vertexBuffer||this.vertexPositions.length===0||this.vertexNormals.length===0||this.indexArray.length===0||(this.vertexBuffer=e.createVertexBuffer(this.vertexPositions,RM.members),this.vertexBufferNormal=e.createVertexBuffer(this.vertexNormals,kM.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.bridgeProgramConfigurations.upload(e),this.tunnelProgramConfigurations.upload(e))}destroy(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBufferNormal.destroy(),this.indexBuffer.destroy()),this.maskSegments&&(this.maskSegments.destroy(),this.depthSegments.destroy(),this.renderableBridgeSegments.destroy(),this.renderableTunnelSegments.destroy(),this.shadowCasterSegments.destroy()),this.bridgeProgramConfigurations.destroy(),this.tunnelProgramConfigurations.destroy()}populatePaintArrays(e,i,o,l,d){const f=(_,v)=>{for(let b=0;b<v.length-1;b++){const E=v[b].featureIndex,I=v[b+1].vertexStart,C=e.feature(E);_.populatePaintArrays(I,C,E,{},o,i,l,void 0,d)}};f(this.bridgeProgramConfigurations,this.bridgeFeatureSections),f(this.tunnelProgramConfigurations,this.tunnelFeatureSections)}computeVertexConnections(e,i,o,l,d){const f=new Map;for(let _=l;_<d;_++){const v=o[_],b=v.a,E=v.b,I=jo.computePosHash(e[b]),C=jo.computePosHash(e[E]);let R=f.get(I);R||(R={},f.set(I,R));let k=f.get(C);k||(k={},f.set(C,k)),i[b]<=0&&i[E]<=0||(R.to=E,k.from=b)}return f}isTerminalVertex(e,i){const o=jo.computePosHash(this.unevalVertices[e]),l=i.get(o);return!l||!l.from||!l.to}constructBridgeStructures(e,i,o,l,d,f){e.clearVertexLookup();const _=this.computeVertexConnections(i,o,l,d.min,d.max),v=1/f,b=.5*v,E=(tt,nt)=>dn(tt,i[nt].x,i[nt].y,o[nt]*v),I=Ri(),C=Ri(),R=Ri(),k=Ri(),F=Ri(),U=(tt,nt)=>{const Ye=_.get(jo.computePosHash(i[nt])),Je=Ye.from,je=Ye.to;if(!Je||!je)return;E(I,Je),E(C,nt),E(R,je),Eo(k),Xr(I,C)||(Qn(F,C,I),yn(k,F)),Xr(R,C)||(Qn(F,R,C),$t(k,k,yn(F,F)));const Be=pc(k);return Be>0?gn(tt,k,1/Be):void 0};let j=Number.POSITIVE_INFINITY;this.sortSubarray(l,d.min,d.max,(tt,nt)=>tt.featureInfo.featureIndex-nt.featureInfo.featureIndex);const H=Ri(),W=Ri(),Y=Ri(),se=Ri(),ie=Ri(),ce=Ri(),fe=Ri(),ge=Ri(),Fe=Ri(),be=[Ri(),Ri(),Ri(),Ri()],Ue=[Ri(),Ri(),Ri(),Ri()],He=[{coord:new et(0,0),height:0},{coord:new et(0,0),height:0}],qe=(tt,nt)=>tt>nt;for(let tt=d.min;tt<d.max;tt++){const nt=l[tt];if(!nt.featureInfo.guardRailEnabled||!this.prepareEdgePoints(He,i,o,nt,qe))continue;const[Ye,Je]=He;if(dn(H,Ye.coord.x,Ye.coord.y,v*Ye.height),dn(W,Je.coord.x,Je.coord.y,v*Je.height),Xr(H,W))continue;Qn(Y,W,H),yn(Y,Y);const je=U(ge,nt.a)||Y,Be=U(Fe,nt.b)||Y;dn(se,je[1],-je[0],0),yn(se,se),dn(ie,Be[1],-Be[0],0),yn(ie,ie),jr(ge,se,je),yn(ce,ge),jr(ge,ie,Be),yn(fe,ge),$t(be[0],H,gn(ge,Qn(ge,se,ce),b)),$t(be[1],H,gn(ge,$t(ge,se,ce),b)),$t(be[2],H,gn(ge,ce,b)),be[3]=H,$t(Ue[0],W,gn(ge,Qn(ge,ie,fe),b)),$t(Ue[1],W,gn(ge,$t(ge,ie,fe),b)),$t(Ue[2],W,gn(ge,fe,b)),Ue[3]=W,j=this.addFeatureSection(nt.featureInfo.featureIndex,j,this.bridgeFeatureSections,e);const Qe=e.addVertex(be[0],se,f),ft=e.addVertex(be[1],se,f),at=e.addVertex(Ue[0],ie,f),Ot=e.addVertex(Ue[1],ie,f);e.addTriangle(Qe,ft,at),e.addTriangle(ft,Ot,at);const xt=e.addVertex(be[1],ce,f),St=e.addVertex(be[2],ce,f),Pt=e.addVertex(Ue[1],fe,f),pi=e.addVertex(Ue[2],fe,f);e.addTriangle(xt,St,Pt),e.addTriangle(St,pi,Pt),Ua(se,se),Ua(ie,ie);const lt=e.addVertex(be[2],se,f),Mt=e.addVertex(be[3],se,f),ei=e.addVertex(Ue[2],ie,f),bi=e.addVertex(Ue[3],ie,f);e.addTriangle(lt,Mt,ei),e.addTriangle(Mt,bi,ei);const Si=this.isTerminalVertex(nt.a,_),oi=this.isTerminalVertex(nt.b,_);Ye.height<.01&&Si&&e.addQuad(be[3],be[2],be[1],be[0],Ua(je,je),f),Je.height<.01&&oi&&e.addQuad(Ue[0],Ue[1],Ue[2],Ue[3],Be,f)}this.bridgeFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:e.getVertexCount()})}constructTunnelStructures(e,i,o,l,d,f){e.clearVertexLookup();let _=Number.POSITIVE_INFINITY;const v=(j,H)=>j.featureInfo.featureIndex-H.featureInfo.featureIndex;this.sortSubarray(l,d.min,d.max,v),this.sortSubarray(l,f.min,f.max,v);const b=j=>yn(j,j),E=[{coord:new et(0,0),height:0},{coord:new et(0,0),height:0}],I=(j,H)=>j<H,C=Ri(),R=Ri(),k=Ri(),F=Ri(),U=Ri();for(let j=d.min;j<d.max;j++){if(!this.prepareEdgePoints(E,i,o,l[j],I))continue;const[H,W]=E,Y=b(dn(U,-(W.coord.y-H.coord.y),W.coord.x-H.coord.x,0));_=this.addFeatureSection(l[j].featureInfo.featureIndex,_,this.tunnelFeatureSections,e),e.addQuad(dn(C,H.coord.x,H.coord.y,H.height),dn(R,W.coord.x,W.coord.y,W.height),dn(k,W.coord.x,W.coord.y,l[j].isTunnel?-.1:0),dn(F,H.coord.x,H.coord.y,l[j].isTunnel?-.1:0),Y)}for(let j=f.min;j<f.max;j++){const H=l[j];H.isTunnel&&([H.a,H.b]=[H.b,H.a]);const W=i[H.a],Y=i[H.b],se=b(dn(U,-(Y.y-W.y),Y.x-W.x,0));_=this.addFeatureSection(H.featureInfo.featureIndex,_,this.tunnelFeatureSections,e),e.addQuad(dn(C,Y.x,Y.y,0),dn(R,W.x,W.y,0),dn(k,W.x,W.y,o[H.a]+4),dn(F,Y.x,Y.y,o[H.b]+4),se),e.addQuad(dn(C,W.x,W.y,0),dn(R,Y.x,Y.y,0),dn(k,Y.x,Y.y,o[H.b]+4),dn(F,W.x,W.y,o[H.a]+4),se)}this.tunnelFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:e.getVertexCount()})}setElevatedPoint(e,i,o,l){e.coord.x=i,e.coord.y=o,e.height=l}prepareEdgePoints(e,i,o,l,d){let f=i[l.a].x,_=i[l.a].y,v=i[l.b].x,b=i[l.b].y,E=o[l.a],I=o[l.b];const C=d(E,0),R=d(I,0);if(C&&R)return this.setElevatedPoint(e[0],f,_,E),this.setElevatedPoint(e[1],v,b,I),!0;if(!C&&!R)return!1;if(C){if(!R){const k=I/(I-E);v=Kt(v,f,k),b=Kt(b,_,k),I=Kt(I,E,k)}}else{const k=E/(E-I);f=Kt(f,v,k),_=Kt(_,b,k),E=Kt(E,I,k)}return this.setElevatedPoint(e[0],f,_,E),this.setElevatedPoint(e[1],v,b,I),!0}prepareEdges(e,i){if(i.length===0)return;i.sort((_,v)=>_.hash===v.hash?v.polygonIdx-_.polygonIdx:v.hash>_.hash?1:-1);let o=0,l=0,d=0,f=i[o].polygonIdx;do l++,(l===i.length||i[o].hash!==i[l].hash)&&((l-o==1||i[l-1].polygonIdx!==f)&&(d<o&&(i[d]=i[o],i[o]=null),i[d].type="none",d++),o=l,o!==i.length&&(f=i[o].polygonIdx));while(o!==i.length);if(i.splice(d),i.length!==0&&e.length!==0){i.sort((b,E)=>b.portalHash<E.portalHash?1:-1);let _=0,v=0;for(;_!==i.length&&v!==e.length;){const b=i[_],E=e[v];b.portalHash>E.hash?_++:E.hash>b.portalHash?v++:(b.type=E.type,_++)}}}isOnBorder(e,i){return e<=0&&i<=0||e>=dt&&i>=dt}addFeatureSection(e,i,o,l){return e!==i&&(i=e,o.push({featureIndex:e,vertexStart:l.getVertexCount()}),l.clearVertexLookup()),i}sortSubarray(e,i,o,l){const d=e.slice(i,o);d.sort(l),e.splice(i,d.length,...d)}static computeEdgeHash(e,i){return(e.y===i.y&&e.x>i.x||e.y>i.y)&&([e,i]=[i,e]),BigInt(jo.computePosHash(e))<<32n|BigInt(jo.computePosHash(i))}static computePosHash(e){return((65535&e.x)<<16|65535&e.y)>>>0}}var BT,NT={exports:{}},jT=(BT||(BT=1,function(n){function e(ne,ae){return ne>ae?1:ne<ae?-1:0}var i=function(ne,ae){ne===void 0&&(ne=e),ae===void 0&&(ae=!1),this._compare=ne,this._root=null,this._size=0,this._noDuplicates=!!ae},o={size:{configurable:!0}};function l(ne,ae,Ve,it,gt){var yt=gt-it;if(yt>0){var Ft=it+Math.floor(yt/2),Nt={key:ae[Ft],data:Ve[Ft],parent:ne};return Nt.left=l(Nt,ae,Ve,it,Ft),Nt.right=l(Nt,ae,Ve,Ft+1,gt),Nt}return null}function d(ne,ae,Ve,it,gt){if(!(Ve>=it)){for(var yt=ne[Ve+it>>1],Ft=Ve-1,Nt=it+1;;){do Ft++;while(gt(ne[Ft],yt)<0);do Nt--;while(gt(ne[Nt],yt)>0);if(Ft>=Nt)break;var ni=ne[Ft];ne[Ft]=ne[Nt],ne[Nt]=ni,ni=ae[Ft],ae[Ft]=ae[Nt],ae[Nt]=ni}d(ne,ae,Ve,Nt,gt),d(ne,ae,Nt+1,it,gt)}}i.prototype.rotateLeft=function(ne){var ae=ne.right;ae&&(ne.right=ae.left,ae.left&&(ae.left.parent=ne),ae.parent=ne.parent),ne.parent?ne===ne.parent.left?ne.parent.left=ae:ne.parent.right=ae:this._root=ae,ae&&(ae.left=ne),ne.parent=ae},i.prototype.rotateRight=function(ne){var ae=ne.left;ae&&(ne.left=ae.right,ae.right&&(ae.right.parent=ne),ae.parent=ne.parent),ne.parent?ne===ne.parent.left?ne.parent.left=ae:ne.parent.right=ae:this._root=ae,ae&&(ae.right=ne),ne.parent=ae},i.prototype._splay=function(ne){for(;ne.parent;){var ae=ne.parent;ae.parent?ae.left===ne&&ae.parent.left===ae?(this.rotateRight(ae.parent),this.rotateRight(ae)):ae.right===ne&&ae.parent.right===ae?(this.rotateLeft(ae.parent),this.rotateLeft(ae)):ae.left===ne&&ae.parent.right===ae?(this.rotateRight(ae),this.rotateLeft(ae)):(this.rotateLeft(ae),this.rotateRight(ae)):ae.left===ne?this.rotateRight(ae):this.rotateLeft(ae)}},i.prototype.splay=function(ne){for(var ae,Ve,it,gt,yt;ne.parent;)(Ve=(ae=ne.parent).parent)&&Ve.parent?((it=Ve.parent).left===Ve?it.left=ne:it.right=ne,ne.parent=it):(ne.parent=null,this._root=ne),gt=ne.left,yt=ne.right,ne===ae.left?(Ve&&(Ve.left===ae?(ae.right?(Ve.left=ae.right,Ve.left.parent=Ve):Ve.left=null,ae.right=Ve,Ve.parent=ae):(gt?(Ve.right=gt,gt.parent=Ve):Ve.right=null,ne.left=Ve,Ve.parent=ne)),yt?(ae.left=yt,yt.parent=ae):ae.left=null,ne.right=ae,ae.parent=ne):(Ve&&(Ve.right===ae?(ae.left?(Ve.right=ae.left,Ve.right.parent=Ve):Ve.right=null,ae.left=Ve,Ve.parent=ae):(yt?(Ve.left=yt,yt.parent=Ve):Ve.left=null,ne.right=Ve,Ve.parent=ne)),gt?(ae.right=gt,gt.parent=ae):ae.right=null,ne.left=ae,ae.parent=ne)},i.prototype.replace=function(ne,ae){ne.parent?ne===ne.parent.left?ne.parent.left=ae:ne.parent.right=ae:this._root=ae,ae&&(ae.parent=ne.parent)},i.prototype.minNode=function(ne){if(ne===void 0&&(ne=this._root),ne)for(;ne.left;)ne=ne.left;return ne},i.prototype.maxNode=function(ne){if(ne===void 0&&(ne=this._root),ne)for(;ne.right;)ne=ne.right;return ne},i.prototype.insert=function(ne,ae){var Ve=this._root,it=null,gt=this._compare;if(this._noDuplicates)for(;Ve;){if(it=Ve,gt(Ve.key,ne)===0)return;Ve=gt(Ve.key,ne)<0?Ve.right:Ve.left}else for(;Ve;)it=Ve,Ve=gt(Ve.key,ne)<0?Ve.right:Ve.left;return Ve={key:ne,data:ae,left:null,right:null,parent:it},it?gt(it.key,Ve.key)<0?it.right=Ve:it.left=Ve:this._root=Ve,this.splay(Ve),this._size++,Ve},i.prototype.find=function(ne){for(var ae=this._root,Ve=this._compare;ae;){var it=Ve(ae.key,ne);if(it<0)ae=ae.right;else{if(!(it>0))return ae;ae=ae.left}}return null},i.prototype.contains=function(ne){for(var ae=this._root,Ve=this._compare;ae;){var it=Ve(ne,ae.key);if(it===0)return!0;ae=it<0?ae.left:ae.right}return!1},i.prototype.remove=function(ne){var ae=this.find(ne);if(!ae)return!1;if(this.splay(ae),ae.left)if(ae.right){var Ve=this.minNode(ae.right);Ve.parent!==ae&&(this.replace(Ve,Ve.right),Ve.right=ae.right,Ve.right.parent=Ve),this.replace(ae,Ve),Ve.left=ae.left,Ve.left.parent=Ve}else this.replace(ae,ae.left);else this.replace(ae,ae.right);return this._size--,!0},i.prototype.removeNode=function(ne){if(!ne)return!1;if(this.splay(ne),ne.left)if(ne.right){var ae=this.minNode(ne.right);ae.parent!==ne&&(this.replace(ae,ae.right),ae.right=ne.right,ae.right.parent=ae),this.replace(ne,ae),ae.left=ne.left,ae.left.parent=ae}else this.replace(ne,ne.left);else this.replace(ne,ne.right);return this._size--,!0},i.prototype.erase=function(ne){var ae=this.find(ne);if(ae){this.splay(ae);var Ve=ae.left,it=ae.right,gt=null;Ve&&(Ve.parent=null,gt=this.maxNode(Ve),this.splay(gt),this._root=gt),it&&(Ve?gt.right=it:this._root=it,it.parent=gt),this._size--}},i.prototype.pop=function(){var ne=this._root,ae=null;if(ne){for(;ne.left;)ne=ne.left;ae={key:ne.key,data:ne.data},this.remove(ne.key)}return ae},i.prototype.next=function(ne){var ae=ne;if(ae)if(ae.right)for(ae=ae.right;ae&&ae.left;)ae=ae.left;else for(ae=ne.parent;ae&&ae.right===ne;)ne=ae,ae=ae.parent;return ae},i.prototype.prev=function(ne){var ae=ne;if(ae)if(ae.left)for(ae=ae.left;ae&&ae.right;)ae=ae.right;else for(ae=ne.parent;ae&&ae.left===ne;)ne=ae,ae=ae.parent;return ae},i.prototype.forEach=function(ne){for(var ae=this._root,Ve=[],it=!1,gt=0;!it;)ae?(Ve.push(ae),ae=ae.left):Ve.length>0?(ne(ae=Ve.pop(),gt++),ae=ae.right):it=!0;return this},i.prototype.range=function(ne,ae,Ve,it){for(var gt=[],yt=this._compare,Ft=this._root;gt.length!==0||Ft;)if(Ft)gt.push(Ft),Ft=Ft.left;else{if(yt((Ft=gt.pop()).key,ae)>0)break;if(yt(Ft.key,ne)>=0&&Ve.call(it,Ft))return this;Ft=Ft.right}return this},i.prototype.keys=function(){for(var ne=this._root,ae=[],Ve=[],it=!1;!it;)ne?(ae.push(ne),ne=ne.left):ae.length>0?(ne=ae.pop(),Ve.push(ne.key),ne=ne.right):it=!0;return Ve},i.prototype.values=function(){for(var ne=this._root,ae=[],Ve=[],it=!1;!it;)ne?(ae.push(ne),ne=ne.left):ae.length>0?(ne=ae.pop(),Ve.push(ne.data),ne=ne.right):it=!0;return Ve},i.prototype.at=function(ne){for(var ae=this._root,Ve=[],it=!1,gt=0;!it;)if(ae)Ve.push(ae),ae=ae.left;else if(Ve.length>0){if(ae=Ve.pop(),gt===ne)return ae;gt++,ae=ae.right}else it=!0;return null},i.prototype.load=function(ne,ae,Ve){if(ne===void 0&&(ne=[]),ae===void 0&&(ae=[]),Ve===void 0&&(Ve=!1),this._size!==0)throw new Error("bulk-load: tree is not empty");var it=ne.length;return Ve&&d(ne,ae,0,it-1,this._compare),this._root=l(null,ne,ae,0,it),this._size=it,this},i.prototype.min=function(){var ne=this.minNode(this._root);return ne?ne.key:null},i.prototype.max=function(){var ne=this.maxNode(this._root);return ne?ne.key:null},i.prototype.isEmpty=function(){return this._root===null},o.size.get=function(){return this._size},i.createTree=function(ne,ae,Ve,it,gt){return new i(Ve,gt).load(ne,ae,it)},Object.defineProperties(i.prototype,o);var f=0,_=1,v=2,b=3,E=0,I=1,C=2,R=3;function k(ne,ae,Ve){ae===null?(ne.inOut=!1,ne.otherInOut=!0):(ne.isSubject===ae.isSubject?(ne.inOut=!ae.inOut,ne.otherInOut=ae.otherInOut):(ne.inOut=!ae.otherInOut,ne.otherInOut=ae.isVertical()?!ae.inOut:ae.inOut),ae&&(ne.prevInResult=!F(ae,Ve)||ae.isVertical()?ae.prevInResult:ae));var it=F(ne,Ve);ne.resultTransition=it?function(gt,yt){var Ft,Nt=!gt.inOut,ni=!gt.otherInOut;switch(yt){case E:Ft=Nt&&ni;break;case I:Ft=Nt||ni;break;case R:Ft=Nt^ni;break;case C:Ft=gt.isSubject?Nt&&!ni:ni&&!Nt}return Ft?1:-1}(ne,Ve):0}function F(ne,ae){switch(ne.type){case f:switch(ae){case E:return!ne.otherInOut;case I:return ne.otherInOut;case C:return ne.isSubject&&ne.otherInOut||!ne.isSubject&&!ne.otherInOut;case R:return!0}break;case v:return ae===E||ae===I;case b:return ae===C;case _:return!1}return!1}var U=function(ne,ae,Ve,it,gt){this.left=ae,this.point=ne,this.otherEvent=Ve,this.isSubject=it,this.type=gt||f,this.inOut=!1,this.otherInOut=!1,this.prevInResult=null,this.resultTransition=0,this.otherPos=-1,this.outputContourId=-1,this.isExteriorRing=!0},j={inResult:{configurable:!0}};function H(ne,ae){return ne[0]===ae[0]&&ne[1]===ae[1]}U.prototype.isBelow=function(ne){var ae=this.point,Ve=this.otherEvent.point;return this.left?(ae[0]-ne[0])*(Ve[1]-ne[1])-(Ve[0]-ne[0])*(ae[1]-ne[1])>0:(Ve[0]-ne[0])*(ae[1]-ne[1])-(ae[0]-ne[0])*(Ve[1]-ne[1])>0},U.prototype.isAbove=function(ne){return!this.isBelow(ne)},U.prototype.isVertical=function(){return this.point[0]===this.otherEvent.point[0]},j.inResult.get=function(){return this.resultTransition!==0},U.prototype.clone=function(){var ne=new U(this.point,this.left,this.otherEvent,this.isSubject,this.type);return ne.contourId=this.contourId,ne.resultTransition=this.resultTransition,ne.prevInResult=this.prevInResult,ne.isExteriorRing=this.isExteriorRing,ne.inOut=this.inOut,ne.otherInOut=this.otherInOut,ne},Object.defineProperties(U.prototype,j);var W=11102230246251565e-32,Y=134217729,se=(3+8*W)*W;function ie(ne,ae,Ve,it,gt){var yt,Ft,Nt,ni,hi=ae[0],fi=it[0],gi=0,Wt=0;fi>hi==fi>-hi?(yt=hi,hi=ae[++gi]):(yt=fi,fi=it[++Wt]);var Qt=0;if(gi<ne&&Wt<Ve)for(fi>hi==fi>-hi?(Nt=yt-((Ft=hi+yt)-hi),hi=ae[++gi]):(Nt=yt-((Ft=fi+yt)-fi),fi=it[++Wt]),yt=Ft,Nt!==0&&(gt[Qt++]=Nt);gi<ne&&Wt<Ve;)fi>hi==fi>-hi?(Nt=yt-((Ft=yt+hi)-(ni=Ft-yt))+(hi-ni),hi=ae[++gi]):(Nt=yt-((Ft=yt+fi)-(ni=Ft-yt))+(fi-ni),fi=it[++Wt]),yt=Ft,Nt!==0&&(gt[Qt++]=Nt);for(;gi<ne;)Nt=yt-((Ft=yt+hi)-(ni=Ft-yt))+(hi-ni),hi=ae[++gi],yt=Ft,Nt!==0&&(gt[Qt++]=Nt);for(;Wt<Ve;)Nt=yt-((Ft=yt+fi)-(ni=Ft-yt))+(fi-ni),fi=it[++Wt],yt=Ft,Nt!==0&&(gt[Qt++]=Nt);return yt===0&&Qt!==0||(gt[Qt++]=yt),Qt}function ce(ne){return new Float64Array(ne)}var fe=33306690738754716e-32,ge=22204460492503146e-32,Fe=11093356479670487e-47,be=ce(4),Ue=ce(8),He=ce(12),qe=ce(16),tt=ce(4);function nt(ne,ae,Ve){var it=function(gt,yt,Ft,Nt,ni,hi){var fi=(yt-hi)*(Ft-ni),gi=(gt-ni)*(Nt-hi),Wt=fi-gi;if(fi===0||gi===0||fi>0!=gi>0)return Wt;var Qt=Math.abs(fi+gi);return Math.abs(Wt)>=fe*Qt?Wt:-function(Pi,Bi,Ni,Ki,sn,tn,Vi){var qi,di,Ti,Tn,Ht,yi,nn,ln,pn,Zn,cn,qt,Mn,Yi,wn,cr,Tr,ir,nr=Pi-sn,gr=Ni-sn,wo=Bi-tn,un=Ki-tn;be[0]=(wn=(ln=nr-(nn=(yi=Y*nr)-(yi-nr)))*(Zn=un-(pn=(yi=Y*un)-(yi-un)))-((Yi=nr*un)-nn*pn-ln*pn-nn*Zn))-((cn=wn-(Tr=(ln=wo-(nn=(yi=Y*wo)-(yi-wo)))*(Zn=gr-(pn=(yi=Y*gr)-(yi-gr)))-((cr=wo*gr)-nn*pn-ln*pn-nn*Zn)))+(Ht=wn-cn))+(Ht-Tr),be[1]=(Mn=Yi-((qt=Yi+cn)-(Ht=qt-Yi))+(cn-Ht))-((cn=Mn-cr)+(Ht=Mn-cn))+(Ht-cr),be[2]=qt-((ir=qt+cn)-(Ht=ir-qt))+(cn-Ht),be[3]=ir;var Hn=function(pl,Br){for(var uo=Br[0],Vo=1;Vo<4;Vo++)uo+=Br[Vo];return uo}(0,be),Xn=ge*Vi;if(Hn>=Xn||-Hn>=Xn||(qi=Pi-(nr+(Ht=Pi-nr))+(Ht-sn),Ti=Ni-(gr+(Ht=Ni-gr))+(Ht-sn),di=Bi-(wo+(Ht=Bi-wo))+(Ht-tn),Tn=Ki-(un+(Ht=Ki-un))+(Ht-tn),qi===0&&di===0&&Ti===0&&Tn===0)||(Xn=Fe*Vi+se*Math.abs(Hn),(Hn+=nr*Tn+un*qi-(wo*Ti+gr*di))>=Xn||-Hn>=Xn))return Hn;tt[0]=(wn=(ln=qi-(nn=(yi=Y*qi)-(yi-qi)))*(Zn=un-(pn=(yi=Y*un)-(yi-un)))-((Yi=qi*un)-nn*pn-ln*pn-nn*Zn))-((cn=wn-(Tr=(ln=di-(nn=(yi=Y*di)-(yi-di)))*(Zn=gr-(pn=(yi=Y*gr)-(yi-gr)))-((cr=di*gr)-nn*pn-ln*pn-nn*Zn)))+(Ht=wn-cn))+(Ht-Tr),tt[1]=(Mn=Yi-((qt=Yi+cn)-(Ht=qt-Yi))+(cn-Ht))-((cn=Mn-cr)+(Ht=Mn-cn))+(Ht-cr),tt[2]=qt-((ir=qt+cn)-(Ht=ir-qt))+(cn-Ht),tt[3]=ir;var Co=ie(4,be,4,tt,Ue);tt[0]=(wn=(ln=nr-(nn=(yi=Y*nr)-(yi-nr)))*(Zn=Tn-(pn=(yi=Y*Tn)-(yi-Tn)))-((Yi=nr*Tn)-nn*pn-ln*pn-nn*Zn))-((cn=wn-(Tr=(ln=wo-(nn=(yi=Y*wo)-(yi-wo)))*(Zn=Ti-(pn=(yi=Y*Ti)-(yi-Ti)))-((cr=wo*Ti)-nn*pn-ln*pn-nn*Zn)))+(Ht=wn-cn))+(Ht-Tr),tt[1]=(Mn=Yi-((qt=Yi+cn)-(Ht=qt-Yi))+(cn-Ht))-((cn=Mn-cr)+(Ht=Mn-cn))+(Ht-cr),tt[2]=qt-((ir=qt+cn)-(Ht=ir-qt))+(cn-Ht),tt[3]=ir;var ur=ie(Co,Ue,4,tt,He);tt[0]=(wn=(ln=qi-(nn=(yi=Y*qi)-(yi-qi)))*(Zn=Tn-(pn=(yi=Y*Tn)-(yi-Tn)))-((Yi=qi*Tn)-nn*pn-ln*pn-nn*Zn))-((cn=wn-(Tr=(ln=di-(nn=(yi=Y*di)-(yi-di)))*(Zn=Ti-(pn=(yi=Y*Ti)-(yi-Ti)))-((cr=di*Ti)-nn*pn-ln*pn-nn*Zn)))+(Ht=wn-cn))+(Ht-Tr),tt[1]=(Mn=Yi-((qt=Yi+cn)-(Ht=qt-Yi))+(cn-Ht))-((cn=Mn-cr)+(Ht=Mn-cn))+(Ht-cr),tt[2]=qt-((ir=qt+cn)-(Ht=ir-qt))+(cn-Ht),tt[3]=ir;var Xs=ie(ur,He,4,tt,qe);return qe[Xs-1]}(gt,yt,Ft,Nt,ni,hi,Qt)}(ne[0],ne[1],ae[0],ae[1],Ve[0],Ve[1]);return it>0?-1:it<0?1:0}function Ye(ne,ae){var Ve=ne.point,it=ae.point;return Ve[0]>it[0]?1:Ve[0]<it[0]?-1:Ve[1]!==it[1]?Ve[1]>it[1]?1:-1:function(gt,yt,Ft,Nt){return gt.left!==yt.left?gt.left?1:-1:nt(Ft,gt.otherEvent.point,yt.otherEvent.point)!==0?gt.isBelow(yt.otherEvent.point)?-1:1:!gt.isSubject&&yt.isSubject?1:-1}(ne,ae,Ve)}function Je(ne,ae,Ve){var it=new U(ae,!1,ne,ne.isSubject),gt=new U(ae,!0,ne.otherEvent,ne.isSubject);return H(ne.point,ne.otherEvent.point)&&console.warn("what is that, a collapsed segment?",ne),it.contourId=gt.contourId=ne.contourId,Ye(gt,ne.otherEvent)>0&&(ne.otherEvent.left=!0,gt.left=!1),ne.otherEvent.otherEvent=gt,ne.otherEvent=it,Ve.push(gt),Ve.push(it),Ve}function je(ne,ae){return ne[0]*ae[1]-ne[1]*ae[0]}function Be(ne,ae){return ne[0]*ae[0]+ne[1]*ae[1]}function Qe(ne,ae,Ve){var it=function(ni,hi,fi,gi,Wt){var Qt=[hi[0]-ni[0],hi[1]-ni[1]],Pi=[gi[0]-fi[0],gi[1]-fi[1]];function Bi(yi,nn,ln){return[yi[0]+nn*ln[0],yi[1]+nn*ln[1]]}var Ni=[fi[0]-ni[0],fi[1]-ni[1]],Ki=je(Qt,Pi),sn=Ki*Ki,tn=Be(Qt,Qt);if(sn>0){var Vi=je(Ni,Pi)/Ki;if(Vi<0||Vi>1)return null;var qi=je(Ni,Qt)/Ki;return qi<0||qi>1?null:Vi===0||Vi===1?[Bi(ni,Vi,Qt)]:qi===0||qi===1?[Bi(fi,qi,Pi)]:[Bi(ni,Vi,Qt)]}if((sn=(Ki=je(Ni,Qt))*Ki)>0)return null;var di=Be(Qt,Ni)/tn,Ti=di+Be(Qt,Pi)/tn,Tn=Math.min(di,Ti),Ht=Math.max(di,Ti);return Tn<=1&&Ht>=0?Tn===1?[Bi(ni,Tn>0?Tn:0,Qt)]:Ht===0?[Bi(ni,Ht<1?Ht:1,Qt)]:[Bi(ni,Tn>0?Tn:0,Qt),Bi(ni,Ht<1?Ht:1,Qt)]:null}(ne.point,ne.otherEvent.point,ae.point,ae.otherEvent.point),gt=it?it.length:0;if(gt===0||gt===1&&(H(ne.point,ae.point)||H(ne.otherEvent.point,ae.otherEvent.point))||gt===2&&ne.isSubject===ae.isSubject)return 0;if(gt===1)return H(ne.point,it[0])||H(ne.otherEvent.point,it[0])||Je(ne,it[0],Ve),H(ae.point,it[0])||H(ae.otherEvent.point,it[0])||Je(ae,it[0],Ve),1;var yt=[],Ft=!1,Nt=!1;return H(ne.point,ae.point)?Ft=!0:Ye(ne,ae)===1?yt.push(ae,ne):yt.push(ne,ae),H(ne.otherEvent.point,ae.otherEvent.point)?Nt=!0:Ye(ne.otherEvent,ae.otherEvent)===1?yt.push(ae.otherEvent,ne.otherEvent):yt.push(ne.otherEvent,ae.otherEvent),Ft&&Nt||Ft?(ae.type=_,ne.type=ae.inOut===ne.inOut?v:b,Ft&&!Nt&&Je(yt[1].otherEvent,yt[0].point,Ve),2):Nt?(Je(yt[0],yt[1].point,Ve),3):yt[0]!==yt[3].otherEvent?(Je(yt[0],yt[1].point,Ve),Je(yt[1],yt[2].point,Ve),3):(Je(yt[0],yt[1].point,Ve),Je(yt[3].otherEvent,yt[2].point,Ve),3)}function ft(ne,ae){if(ne===ae)return 0;if(nt(ne.point,ne.otherEvent.point,ae.point)!==0||nt(ne.point,ne.otherEvent.point,ae.otherEvent.point)!==0)return H(ne.point,ae.point)?ne.isBelow(ae.otherEvent.point)?-1:1:ne.point[0]===ae.point[0]?ne.point[1]<ae.point[1]?-1:1:Ye(ne,ae)===1?ae.isAbove(ne.point)?-1:1:ne.isBelow(ae.point)?-1:1;if(ne.isSubject!==ae.isSubject)return ne.isSubject?-1:1;var Ve=ne.point,it=ae.point;return Ve[0]===it[0]&&Ve[1]===it[1]?(Ve=ne.otherEvent.point)[0]===(it=ae.otherEvent.point)[0]&&Ve[1]===it[1]?0:ne.contourId>ae.contourId?1:-1:Ye(ne,ae)===1?1:-1}var at=function(){this.points=[],this.holeIds=[],this.holeOf=null,this.depth=null};function Ot(ne,ae,Ve,it){var gt,yt=ne+1,Ft=ae[ne].point,Nt=ae.length;for(yt<Nt&&(gt=ae[yt].point);yt<Nt&&gt[0]===Ft[0]&&gt[1]===Ft[1];){if(!Ve[yt])return yt;++yt<Nt&&(gt=ae[yt].point)}for(yt=ne-1;Ve[yt]&&yt>it;)yt--;return yt}at.prototype.isExterior=function(){return this.holeOf==null};var xt=Pt,St=Pt;function Pt(ne,ae){if(!(this instanceof Pt))return new Pt(ne,ae);if(this.data=ne||[],this.length=this.data.length,this.compare=ae||pi,this.length>0)for(var Ve=(this.length>>1)-1;Ve>=0;Ve--)this._down(Ve)}function pi(ne,ae){return ne<ae?-1:ne>ae?1:0}Pt.prototype={push:function(ne){this.data.push(ne),this.length++,this._up(this.length-1)},pop:function(){if(this.length!==0){var ne=this.data[0];return this.length--,this.length>0&&(this.data[0]=this.data[this.length],this._down(0)),this.data.pop(),ne}},peek:function(){return this.data[0]},_up:function(ne){for(var ae=this.data,Ve=this.compare,it=ae[ne];ne>0;){var gt=ne-1>>1,yt=ae[gt];if(Ve(it,yt)>=0)break;ae[ne]=yt,ne=gt}ae[ne]=it},_down:function(ne){for(var ae=this.data,Ve=this.compare,it=this.length>>1,gt=ae[ne];ne<it;){var yt=1+(ne<<1),Ft=yt+1,Nt=ae[yt];if(Ft<this.length&&Ve(ae[Ft],Nt)<0&&(yt=Ft,Nt=ae[Ft]),Ve(Nt,gt)>=0)break;ae[ne]=Nt,ne=yt}ae[ne]=gt}},xt.default=St;var lt=Math.max,Mt=Math.min,ei=0;function bi(ne,ae,Ve,it,gt,yt){var Ft,Nt,ni,hi,fi,gi;for(Ft=0,Nt=ne.length-1;Ft<Nt;Ft++)if(hi=ne[Ft+1],fi=new U(ni=ne[Ft],!1,void 0,ae),gi=new U(hi,!1,fi,ae),fi.otherEvent=gi,ni[0]!==hi[0]||ni[1]!==hi[1]){fi.contourId=gi.contourId=Ve,yt||(fi.isExteriorRing=!1,gi.isExteriorRing=!1),Ye(fi,gi)>0?gi.left=!0:fi.left=!0;var Wt=ni[0],Qt=ni[1];gt[0]=Mt(gt[0],Wt),gt[1]=Mt(gt[1],Qt),gt[2]=lt(gt[2],Wt),gt[3]=lt(gt[3],Qt),it.push(fi),it.push(gi)}}var Si=[];function oi(ne,ae,Ve){typeof ne[0][0][0]=="number"&&(ne=[ne]),typeof ae[0][0][0]=="number"&&(ae=[ae]);var it=function(Qt,Pi,Bi){var Ni=null;return Qt.length*Pi.length==0&&(Bi===E?Ni=Si:Bi===C?Ni=Qt:Bi!==I&&Bi!==R||(Ni=Qt.length===0?Pi:Qt)),Ni}(ne,ae,Ve);if(it)return it===Si?null:it;var gt=[1/0,1/0,-1/0,-1/0],yt=[1/0,1/0,-1/0,-1/0],Ft=function(Qt,Pi,Bi,Ni,Ki){var sn,tn,Vi,qi,di,Ti,Tn=new xt(null,Ye);for(Vi=0,qi=Qt.length;Vi<qi;Vi++)for(di=0,Ti=(sn=Qt[Vi]).length;di<Ti;di++)(tn=di===0)&&ei++,bi(sn[di],!0,ei,Tn,Bi,tn);for(Vi=0,qi=Pi.length;Vi<qi;Vi++)for(di=0,Ti=(sn=Pi[Vi]).length;di<Ti;di++)tn=di===0,Ki===C&&(tn=!1),tn&&ei++,bi(sn[di],!1,ei,Tn,Ni,tn);return Tn}(ne,ae,gt,yt,Ve);if(it=function(Qt,Pi,Bi,Ni,Ki){var sn=null;return(Bi[0]>Ni[2]||Ni[0]>Bi[2]||Bi[1]>Ni[3]||Ni[1]>Bi[3])&&(Ki===E?sn=Si:Ki===C?sn=Qt:Ki!==I&&Ki!==R||(sn=Qt.concat(Pi))),sn}(ne,ae,gt,yt,Ve))return it===Si?null:it;for(var Nt=function(Qt){var Pi,Bi,Ni=function(Vi){var qi,di,Ti,Tn,Ht=[];for(di=0,Ti=Vi.length;di<Ti;di++)((qi=Vi[di]).left&&qi.inResult||!qi.left&&qi.otherEvent.inResult)&&Ht.push(qi);for(var yi=!1;!yi;)for(yi=!0,di=0,Ti=Ht.length;di<Ti;di++)di+1<Ti&&Ye(Ht[di],Ht[di+1])===1&&(Tn=Ht[di],Ht[di]=Ht[di+1],Ht[di+1]=Tn,yi=!1);for(di=0,Ti=Ht.length;di<Ti;di++)(qi=Ht[di]).otherPos=di;for(di=0,Ti=Ht.length;di<Ti;di++)(qi=Ht[di]).left||(Tn=qi.otherPos,qi.otherPos=qi.otherEvent.otherPos,qi.otherEvent.otherPos=Tn);return Ht}(Qt),Ki={},sn=[],tn=function(){if(!Ki[Pi]){var Vi=sn.length,qi=function(Ht,yi,nn){var ln=new at;if(Ht.prevInResult!=null){var pn=Ht.prevInResult,Zn=pn.outputContourId;if(pn.resultTransition>0){var cn=yi[Zn];if(cn.holeOf!=null){var qt=cn.holeOf;yi[qt].holeIds.push(nn),ln.holeOf=qt,ln.depth=yi[Zn].depth}else yi[Zn].holeIds.push(nn),ln.holeOf=Zn,ln.depth=yi[Zn].depth+1}else ln.holeOf=null,ln.depth=yi[Zn].depth}else ln.holeOf=null,ln.depth=0;return ln}(Ni[Pi],sn,Vi),di=function(Ht){Ki[Ht]=!0,Ht<Ni.length&&Ni[Ht]&&(Ni[Ht].outputContourId=Vi)},Ti=Pi,Tn=Pi;for(qi.points.push(Ni[Pi].point);di(Ti),di(Ti=Ni[Ti].otherPos),qi.points.push(Ni[Ti].point),!((Ti=Ot(Ti,Ni,Ki,Tn))==Tn||Ti>=Ni.length)&&Ni[Ti];);sn.push(qi)}};for(Pi=0,Bi=Ni.length;Pi<Bi;Pi++)tn();return sn}(function(Qt,Pi,Bi,Ni,Ki,sn){for(var tn,Vi,qi,di=new i(ft),Ti=[],Tn=Math.min(Ni[2],Ki[2]);Qt.length!==0;){var Ht=Qt.pop();if(Ti.push(Ht),sn===E&&Ht.point[0]>Tn||sn===C&&Ht.point[0]>Ni[2])break;if(Ht.left){Vi=tn=di.insert(Ht),tn=tn!==(qi=di.minNode())?di.prev(tn):null,Vi=di.next(Vi);var yi=tn?tn.key:null;if(k(Ht,yi,sn),Vi&&Qe(Ht,Vi.key,Qt)===2&&(k(Ht,yi,sn),k(Vi.key,Ht,sn)),tn&&Qe(tn.key,Ht,Qt)===2){var nn=tn;k(yi,(nn=nn!==qi?di.prev(nn):null)?nn.key:null,sn),k(Ht,yi,sn)}}else Vi=tn=di.find(Ht=Ht.otherEvent),tn&&Vi&&(tn=tn!==qi?di.prev(tn):null,Vi=di.next(Vi),di.remove(Ht),Vi&&tn&&Qe(tn.key,Vi.key,Qt))}return Ti}(Ft,0,0,gt,yt,Ve)),ni=[],hi=0;hi<Nt.length;hi++){var fi=Nt[hi];if(fi.isExterior()){for(var gi=[fi.points],Wt=0;Wt<fi.holeIds.length;Wt++)gi.push(Nt[fi.holeIds[Wt]].points);ni.push(gi)}}return ni}var en={UNION:I,DIFFERENCE:C,INTERSECTION:E,XOR:R};n.diff=function(ne,ae){return oi(ne,ae,C)},n.intersection=function(ne,ae){return oi(ne,ae,E)},n.operations=en,n.union=function(ne,ae){return oi(ne,ae,I)},n.xor=function(ne,ae){return oi(ne,ae,R)},Object.defineProperty(n,"__esModule",{value:!0})}(NT.exports)),NT.exports);/**
 * martinez v0.7.4
 * Martinez polygon clipping algorithm, does boolean operation on polygons (multipolygons, polygons with holes etc): intersection, union, difference, xor
 *
 * @author Alex Milevski <info@w8r.name>
 * @license MIT
 * @preserve
 */function gy(n,e,i,o){const l=[],d=o===0?(f,_,v,b,E,I)=>{f.push(new et(I,v+(I-_)/(b-_)*(E-v)))}:(f,_,v,b,E,I)=>{f.push(new et(_+(I-v)/(E-v)*(b-_),I))};for(const f of n){const _=[];for(const v of f){if(v.length<=2)continue;const b=[];for(let C=0;C<v.length-1;C++){const R=v[C].x,k=v[C].y,F=v[C+1].x,U=v[C+1].y,j=o===0?R:k,H=o===0?F:U;j<e?H>e&&d(b,R,k,F,U,e):j>i?H<i&&d(b,R,k,F,U,i):b.push(v[C]),H<e&&j>=e&&d(b,R,k,F,U,e),H>i&&j<=i&&d(b,R,k,F,U,i)}let E=v[v.length-1];const I=o===0?E.x:E.y;I>=e&&I<=i&&b.push(E),b.length&&(E=b[b.length-1],b[0].x===E.x&&b[0].y===E.y||b.push(b[0]),_.push(b))}_.length&&l.push(_)}return l}function GM(n,e){const i=xx(n),o=xx([e]),l=jT.intersection(i,o);return l==null?[]:UT(l)}function HM(n,e){let o=xx(n,65536);const l=[];for(;e.valid();e.next()){const[d,f]=e.get(),_=d.x*65536,v=d.y*65536,b=f.x*65536,E=f.y*65536,I=b-_,C=E-v,R=Math.hypot(I,C);if(R===0)continue;const k=Math.trunc(C/R*3),F=-Math.trunc(I/R*3);l.push([[[_,v],[b,E],[b+k,E+F],[_+k,v+F],[_,v]]])}return l.length>0&&(o=jT.diff(o,l)),UT(o,1/65536)}function xx(n,e=1){return[n.map(i=>i.map(o=>[o.x*e,o.y*e]))]}function UT(n,e=1){return n.map(i=>i.map((o,l)=>{const d=o.map(f=>new et(f[0]*e,f[1]*e).round());return l>0&&d.reverse(),d}))}class wx{constructor(e,i){this.layoutVertexArray=new al,this.indexArray=new sr,this.lineIndexArray=new Bo,this.triangleSegments=new An,this.lineSegments=new An,this.programConfigurations=new ws(e.layers,{zoom:e.zoom,lut:e.lut}),this.uploaded=!1,i&&(this.elevatedLayoutVertexArray=new _a)}update(e,i,o,l,d,f,_,v){this.programConfigurations.updatePaintArrays(e,i,d,o,l,f,_,v)}isEmpty(){return this.layoutVertexArray.length===0}needsUpload(){return this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,PM.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.lineIndexBuffer=e.createIndexBuffer(this.lineIndexArray),this.elevatedLayoutVertexArray&&this.elevatedLayoutVertexArray.length>0&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,MM.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.lineIndexBuffer.destroy(),this.programConfigurations.destroy(),this.triangleSegments.destroy(),this.lineSegments.destroy())}populatePaintArrays(e,i,o,l,d,f,_){this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,i,o,l,d,f,void 0,_)}}class bx{constructor(e){this.zoom=e.zoom,this.pixelRatio=e.pixelRatio,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.lut=e.lut,this.bufferData=new wx(e,!1),this.elevationBufferData=new wx(e,!0),this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.projection=e.projection,this.elevationMode=this.layers[0].layout.get("fill-elevation-reference"),this.sourceLayerIndex=e.sourceLayerIndex,this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,i){}updateAppearances(e,i,o,l){}populate(e,i,o,l){this.hasPattern=yx("fill",this.layers,this.pixelRatio,i);const d=this.layers[0].layout.get("fill-sort-key"),f=[];for(const{feature:_,id:v,index:b,sourceLayerIndex:E}of e){const I=this.layers[0]._featureFilter.needGeometry,C=we(_,I);if(!this.layers[0]._featureFilter.filter(new fn(this.zoom,{worldview:this.worldview,activeFloors:i.activeFloors}),C,o))continue;const R=d?d.evaluate(C,{},o,i.availableImages):void 0,k={id:v,properties:_.properties,type:_.type,sourceLayerIndex:E,index:b,geometry:I?C.geometry:he(_,o,l),patterns:{},sortKey:R};f.push(k)}d&&f.sort((_,v)=>_.sortKey-v.sortKey);for(const _ of f){const{geometry:v,index:b,sourceLayerIndex:E}=_;if(this.hasPattern){const I=vx("fill",this.layers,_,this.zoom,this.pixelRatio,i);this.patternFeatures.push(I)}else this.addFeature(_,v,b,o,{},i.availableImages,i.brightness,i.elevationFeatures);i.featureIndex.insert(e[b].feature,v,b,E,this.index)}}update(e,i,o,l,d,f,_){this.bufferData.update(e,i,o,l,d,f,_,this.worldview),this.elevationBufferData.update(e,i,o,l,d,f,_,this.worldview),this.elevatedStructures&&this.elevatedStructures.update(e,i,o,l,d,f,_,this.worldview)}addFeatures(e,i,o,l,d,f){for(const _ of this.patternFeatures)this.addFeature(_,_.geometry,_.index,i,o,l,f,e.elevationFeatures)}isEmpty(){return this.bufferData.isEmpty()&&this.elevationBufferData.isEmpty()}uploadPending(){return!this.uploaded||this.bufferData.needsUpload()||this.elevationBufferData.needsUpload()}upload(e){this.bufferData.upload(e),this.elevationBufferData.upload(e),this.elevatedStructures&&this.elevatedStructures.upload(e)}destroy(){this.bufferData.destroy(),this.elevationBufferData.destroy(),this.elevatedStructures&&this.elevatedStructures.destroy()}addFeature(e,i,o,l,d,f=[],_,v){const b=Im(i,500);this.elevationMode!=="none"?this.addElevatedRoadFeature(e,b,l,o,v):this.addGeometry(b,this.bufferData),this.bufferData.populatePaintArrays(e,o,d,f,l,_,this.worldview),this.elevationBufferData.populatePaintArrays(e,o,d,f,l,_,this.worldview)}getUnevaluatedPortalGraph(){return this.elevatedStructures?this.elevatedStructures.unevaluatedPortals:void 0}getElevationPolygons(){return this.elevatedStructures?this.elevatedStructures.portalPolygons:void 0}setEvaluatedPortalGraph(e,i,o,l,d){this.elevatedStructures&&(this.elevatedStructures.construct(e),this.elevatedStructures.populatePaintArrays(i,o,l,d,this.worldview))}addElevatedRoadFeature(e,i,o,l,d){const f=new Array,_=Gi.getElevationFeature(e,d);if(!_)return void this.addGeometry(i,this.bufferData);{const b=this.clipPolygonsToTile(i,1);b.length>0&&f.push({polygons:b,elevationFeature:_,elevationTileID:o})}const v={guardRailEnabled:this.layers[0].layout.get("fill-construct-bridge-guard-rail").evaluate(e,{},o),featureIndex:l};for(const b of f)if(b.elevationFeature){if(this.elevationMode==="hd-road-base"){this.elevatedStructures||(this.elevatedStructures=new jo(b.elevationTileID,this.layers,this.zoom,this.lut));const I=b.elevationFeature.isTunnel();let C=0;e.properties.hasOwnProperty(Re)&&(C=+e.properties[Re]);for(const R of b.polygons)this.elevatedStructures.addPortalCandidates(b.elevationFeature.id,R,I,b.elevationFeature,C)}b.elevationFeature.constantHeight==null&&(b.polygons=this.prepareElevatedPolygons(b.polygons,b.elevationFeature,b.elevationTileID));const E=new Qi(o,b.elevationTileID);this.addElevatedGeometry(b.polygons,E,b.elevationFeature,this.elevationMode==="hd-road-base"?0:.05,l,v)}}addElevatedGeometry(e,i,o,l,d,f){const _={elevation:o,elevationSampler:i,bias:l,index:d,featureInfo:f},[v,b]=this.addGeometry(e,this.elevationBufferData,_);this.elevationBufferData.heightRange==null?this.elevationBufferData.heightRange={min:v,max:b}:(this.elevationBufferData.heightRange.min=Math.min(this.elevationBufferData.heightRange.min,v),this.elevationBufferData.heightRange.max=Math.max(this.elevationBufferData.heightRange.max,b))}addGeometry(e,i,o){let l=Number.POSITIVE_INFINITY,d=Number.NEGATIVE_INFINITY,f=null;o&&(f=o.elevationSampler.constantElevation(o.elevation,o.bias),f!=null&&(l=f,d=f));const _=(v,b,E)=>{if(o!=null)if(b.push(v),f!=null)i.elevatedLayoutVertexArray.emplaceBack(f),E.push(f);else{const I=o.elevationSampler.pointElevation(v,o.elevation,o.bias);i.elevatedLayoutVertexArray.emplaceBack(I),E.push(I),l=Math.min(l,I),d=Math.max(d,I)}};for(const v of e){let b=0;for(const W of v)b+=W.length;const E=i.triangleSegments.prepareSegment(b,i.layoutVertexArray,i.indexArray),I=E.vertexLength,C=[],R=[],k=[],F=[],U=[],j=i.layoutVertexArray.length;for(const W of v){if(W.length===0)continue;W!==v[0]&&R.push(C.length/2);const Y=i.lineSegments.prepareSegment(W.length,i.layoutVertexArray,i.lineIndexArray),se=Y.vertexLength;o&&U.push(i.layoutVertexArray.length-j),_(W[0],k,F),i.layoutVertexArray.emplaceBack(W[0].x,W[0].y),i.lineIndexArray.emplaceBack(se+W.length-1,se),C.push(W[0].x),C.push(W[0].y);for(let ie=1;ie<W.length;ie++)_(W[ie],k,F),i.layoutVertexArray.emplaceBack(W[ie].x,W[ie].y),i.lineIndexArray.emplaceBack(se+ie-1,se+ie),C.push(W[ie].x),C.push(W[ie].y);Y.vertexLength+=W.length,Y.primitiveLength+=W.length}const H=rf(C,R);for(let W=0;W<H.length;W+=3)i.indexArray.emplaceBack(I+H[W],I+H[W+1],I+H[W+2]);if(H.length>0&&o&&this.elevationMode==="hd-road-base"){const W=o.elevation.isTunnel(),Y=o.elevation.safeArea,se=this.elevatedStructures.addVertices(k,F);this.elevatedStructures.addTriangles(H,se,W);const ie=U.length;if(ie>0){for(let ce=0;ce<ie-1;ce++)this.elevatedStructures.addRenderableRing(o.index,U[ce]+se,U[ce+1]-U[ce],W,Y,o.featureInfo);this.elevatedStructures.addRenderableRing(o.index,U[ie-1]+se,k.length-U[ie-1],W,Y,o.featureInfo)}}E.vertexLength+=b,E.primitiveLength+=H.length/3}return[l,d]}prepareElevatedPolygons(e,i,o){const l=1/$(o),d=[];for(const f of e){const _=HM(f,new Fi(i,l));d.push(..._)}return d}clipPolygonsToTile(e,i){const o=-i,l=-i,d=dt+i,f=dt+i;let _=0;const v=[],b=[];for(;_<e.length;_++){const C=e[_],R=ua(C);(R.min.x>=o&&R.max.x<=d&&R.min.y>=l&&R.max.y<=f?v:b).push(C)}if(v.length===e.length)return e;const E=[new et(o,l),new et(d,l),new et(d,f),new et(o,f),new et(o,l)],I=v;for(const C of b)I.push(...GM(C,E));return I}}let VT,$T,GT,HT;It(bx,"FillBucket",{omit:["layers","patternFeatures"]}),It(wx,"FillBufferData"),It(jo,"ElevatedStructures");class yy{constructor(e,i,o,l){if(this.triangleCount=i.length/3,this.min=new et(0,0),this.max=new et(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],this.triangleCount===0||e.length===0)return;const[d,f]=[e[0].clone(),e[0].clone()];for(let I=1;I<e.length;++I){const C=e[I];d.x=Math.min(d.x,C.x),d.y=Math.min(d.y,C.y),f.x=Math.max(f.x,C.x),f.y=Math.max(f.y,C.y)}if(l){const I=Math.ceil(Math.max(f.x-d.x,f.y-d.y)/l);o=Math.max(o,I)}if(o===0)return;this.min=d,this.max=f;const _=this.max.sub(this.min);_.x=Math.max(_.x,1),_.y=Math.max(_.y,1);const v=Math.max(_.x,_.y)/o;this.cellsX=Math.max(1,Math.ceil(_.x/v)),this.cellsY=Math.max(1,Math.ceil(_.y/v)),this.xScale=1/v,this.yScale=1/v;const b=[];for(let I=0;I<this.triangleCount;I++){const C=e[i[3*I+0]].sub(this.min),R=e[i[3*I+1]].sub(this.min),k=e[i[3*I+2]].sub(this.min),F=dl(Math.floor(Math.min(C.x,R.x,k.x)),this.xScale,this.cellsX),U=dl(Math.floor(Math.max(C.x,R.x,k.x)),this.xScale,this.cellsX),j=dl(Math.floor(Math.min(C.y,R.y,k.y)),this.yScale,this.cellsY),H=dl(Math.floor(Math.max(C.y,R.y,k.y)),this.yScale,this.cellsY),W=new et(0,0),Y=new et(0,0),se=new et(0,0),ie=new et(0,0);for(let ce=j;ce<=H;++ce){W.y=Y.y=ce*v,se.y=ie.y=(ce+1)*v;for(let fe=F;fe<=U;++fe)W.x=se.x=fe*v,Y.x=ie.x=(fe+1)*v,(Hr(C,R,k,W,Y,ie)||Hr(C,R,k,W,ie,se))&&b.push({cellIdx:ce*this.cellsX+fe,triIdx:I})}}if(b.length===0)return;b.sort((I,C)=>I.cellIdx-C.cellIdx||I.triIdx-C.triIdx);let E=0;for(;E<b.length;){const I=b[E].cellIdx,C={start:this.payload.length,len:0};for(;E<b.length&&b[E].cellIdx===I;)++C.len,this.payload.push(b[E++].triIdx);this.cells[I]=C}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(e,i){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>e.x||e.y>this.max.y||this.min.y>e.y)return;const o=dl(e.x-this.min.x,this.xScale,this.cellsX),l=dl(e.y-this.min.y,this.yScale,this.cellsY),d=this.cells[l*this.cellsX+o];if(d){this._lazyInitLookup();for(let f=0;f<d.len;f++){const _=this.payload[d.start+f],v=Math.floor(_/8),b=1<<_%8;if(!(this.lookup[v]&b)&&(this.lookup[v]|=b,i.push(_),i.length===this.triangleCount))return}}}query(e,i,o){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>i.x||e.y>this.max.y||this.min.y>i.y)return;this._lazyInitLookup();const l=dl(e.x-this.min.x,this.xScale,this.cellsX),d=dl(i.x-this.min.x,this.xScale,this.cellsX),f=dl(e.y-this.min.y,this.yScale,this.cellsY),_=dl(i.y-this.min.y,this.yScale,this.cellsY);for(let v=f;v<=_;v++)for(let b=l;b<=d;b++){const E=this.cells[v*this.cellsX+b];if(E)for(let I=0;I<E.len;I++){const C=this.payload[E.start+I],R=Math.floor(C/8),k=1<<C%8;if(!(this.lookup[R]&k)&&(this.lookup[R]|=k,o.push(C),o.length===this.triangleCount))return}}}}function dl(n,e,i){return Math.max(0,Math.min(i-1,Math.floor(n*e)))}It(yy,"TriangleGridIndex");class qT{constructor(e){this.zoom=e.zoom,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.footprints=[],this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,i){for(const o of this.footprints)i.push({footprint:o,id:e})}updateAppearances(e,i,o,l){}populate(e,i,o,l){const d=[];for(const{feature:f,id:_,index:v,sourceLayerIndex:b}of e){const E=this.layers[0]._featureFilter.needGeometry,I=we(f,E);if(!this.layers[0]._featureFilter.filter(new fn(this.zoom,{worldview:this.worldview,activeFloors:i.activeFloors}),I,o))continue;const C={id:_,properties:f.properties,type:f.type,sourceLayerIndex:b,index:v,geometry:E?I.geometry:he(f,o,l),patterns:{}};d.push(C)}for(const f of d){const{geometry:_,index:v,sourceLayerIndex:b}=f;this.addFeature(f,_,v,o,{},i.availableImages,i.brightness),i.featureIndex.insert(e[v].feature,_,v,b,this.index)}}isEmpty(){return this.footprints.length===0}uploadPending(){return!1}upload(e){}update(e,i,o,l,d,f,_){}destroy(){}addFeature(e,i,o,l,d,f=[],_){for(const v of Im(i,2)){const b=[],E=[],I=[],C=new et(1/0,1/0),R=new et(-1/0,-1/0);for(const U of v)if(U.length!==0){U!==v[0]&&I.push(E.length/2);for(let j=0;j<U.length;j++)E.push(U[j].x),E.push(U[j].y),b.push(U[j]),C.x=Math.min(C.x,U[j].x),C.y=Math.min(C.y,U[j].y),R.x=Math.max(R.x,U[j].x),R.y=Math.max(R.y,U[j].y)}const k=rf(E,I),F=new yy(b,k,8,256);this.footprints.push({vertices:b,indices:k,grid:F,min:C,max:R})}}}It(qT,"ClipBucket",{omit:["layers"]});const qM=_i([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),WM=_i([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),ZM=_i([{name:"a_flood_light_ground_radius",components:1,type:"Float32"}]),XM=_i([{name:"a_centroid_pos",components:2,type:"Uint16"}]),KM=_i([{name:"a_join_normal_inside",components:3,type:"Int16"}]),YM=_i([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),JM=_i([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:QM}=qM,Am=Number.MAX_SAFE_INTEGER,WT=Am-1;function ZT(n,e,i,o){return n.order<e||n.order===Am||!(n.clipMask&i)||function(l,d){return d.length!==0&&d.find(f=>f===l)===void 0}(o,n.clipScope)}function vy(n,e){return n.x-e.x||n.y-e.y}function XT(n,e){return vy(n.min,e.min)===0&&vy(n.max,e.max)===0}function Tx(n,e){return!(n.min.x>e.max.x||n.max.x<e.min.x||n.min.y>e.max.y||n.max.y<e.min.y)}function xy(n,e){if(n.length!==e.length)return!1;for(let i=0;i<n.length;i++)if(n[i].sourceId!==e[i].sourceId||!XT(n[i],e[i])||n[i].order!==e[i].order||n[i].clipMask!==e[i].clipMask||!sa(n[i].clipScope,e[i].clipScope))return!1;return!0}function KT(n,e,i){const o=1/dt,l=1/(1<<i.canonical.z),d=(e.x*o+i.canonical.x)*l+i.wrap,f=(e.y*o+i.canonical.y)*l;return{min:new et((n.x*o+i.canonical.x)*l+i.wrap,(n.y*o+i.canonical.y)*l),max:new et(d,f)}}function eR(n,e,i){const o=1<<i.canonical.z,l=((e.x-i.wrap)*o-i.canonical.x)*dt,d=(e.y*o-i.canonical.y)*dt;return{min:new et(((n.x-i.wrap)*o-i.canonical.x)*dt,(n.y*o-i.canonical.y)*dt),max:new et(l,d)}}function Sx(n,e,i,o,l,d,f){const _=n.indices,v=n.vertices,b=[];for(let E=o;E<o+l;E+=3){const I=e[i[E+0]+d],C=e[i[E+1]+d],R=e[i[E+2]+d],k=Math.min(I.x,C.x,R.x),F=Math.max(I.x,C.x,R.x),U=Math.min(I.y,C.y,R.y),j=Math.max(I.y,C.y,R.y);b.length=0,n.grid.query(new et(k,U),new et(F,j),b);for(let H=0;H<b.length;H++){const W=b[H];if(Hr(v[_[3*W+0]],v[_[3*W+1]],v[_[3*W+2]],I,C,R,f))return!0}}return!1}function YT(n,e,i,o){if(!n||!i)return!1;let l=n.vertices;if(!e.canonical.equals(o.canonical)||e.wrap!==o.wrap){if(i.vertices.length<n.vertices.length)return YT(i,o,n,e);const d=e.canonical,f=o.canonical,_=Math.pow(2,f.z-d.z);l=n.vertices.map(v=>new et((v.x+d.x*dt)*_-f.x*dt,(v.y+d.y*dt)*_-f.y*dt))}return Sx(i,l,n.indices,0,n.indices.length,0,0)}function JT(n,e,i,o){const l=Math.pow(2,o.z-i.z);return new et((n+i.x*dt)*l-o.x*dt,(e+i.y*dt)*l-o.y*dt)}function QT(n,e){const i=[];e.grid.queryPoint(n,i);const o=e.indices,l=e.vertices;for(let d=0;d<i.length;d++){const f=i[d];if(rn([l[o[3*f+0]],l[o[3*f+1]],l[o[3*f+2]]],n))return!0}return!1}const Ex=[new et(0,0),new et(dt,0),new et(dt,dt),new et(0,dt)];function eS(n,e){const i=[];let o=[];if(!e||n.length<2)return[n];if(n.length===2)return Fr(n[0],n[1],Ex)?[n]:[];for(let l=0;l<n.length+2;l++){const d=n[l%n.length],f=n[(l+1)%n.length],_=Fr(l===0?n[n.length-1]:n[(l-1)%n.length],d,Ex),v=Fr(d,f,Ex),b=_||v;b&&o.push(d),b&&v||o.length>0&&(o.length>1&&i.push(o),o=[])}return o.length>1&&i.push(o),i}const Ix=ye.types,tR=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius","fill-extrusion-line-width","fill-extrusion-emissive-strength"],iR=["fill-extrusion-flood-light-ground-radius"],nR=Math.pow(2,13),rR=Math.pow(2,15)-1,tS=new et(0,1),Ql=2147483648,iS=7,nS=450;function Cm(n,e,i,o,l,d,f,_){n.emplaceBack((e<<1)+f,(i<<1)+d,(Math.floor(o*nR)<<1)+l,Math.round(_))}function Pm(n,e,i){n.emplaceBack(e.x*dt,e.y*dt,i?1:0)}function wy(n,e,i,o,l,d){n.emplaceBack(e.x,e.y,(i.x<<1)+o,(i.y<<1)+l,d)}function Mm(n,e,i){n.emplaceBack(e.x,e.y,e.z,i[0]*16384,i[1]*16384,i[2]*16384)}class rS{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class oS{constructor(){this.centroidXY=new et(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new et(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new et(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0,this.buildingId=0}span(){return new et(this.max.x-this.min.x,this.max.y-this.min.y)}}class sS{constructor(){this.acc=new et(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(e,i){e.min.x===Number.MAX_VALUE&&(e.min.x=e.max.x=i.x,e.min.y=e.max.y=i.y)}appendEdge(e,i,o){this.accCount++,this.acc._add(i);let l=!!this.borders;i.x<e.min.x?(e.min.x=i.x,l=!0):i.x>e.max.x&&(e.max.x=i.x,l=!0),i.y<e.min.y?(e.min.y=i.y,l=!0):i.y>e.max.y&&(e.max.y=i.y,l=!0),((i.x===0||i.x===dt)&&i.x===o.x)!=((i.y===0||i.y===dt)&&i.y===o.y)&&this.processBorderOverlap(i,o),l&&this.checkBorderIntersection(i,o)}checkBorderIntersection(e,i){i.x<0!=e.x<0&&this.addBorderIntersection(0,Kt(i.y,e.y,(0-i.x)/(e.x-i.x))),i.x>dt!=e.x>dt&&this.addBorderIntersection(1,Kt(i.y,e.y,(dt-i.x)/(e.x-i.x))),i.y<0!=e.y<0&&this.addBorderIntersection(2,Kt(i.x,e.x,(0-i.y)/(e.y-i.y))),i.y>dt!=e.y>dt&&this.addBorderIntersection(3,Kt(i.x,e.x,(dt-i.y)/(e.y-i.y)))}addBorderIntersection(e,i){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const o=this.borders[e];i<o[0]&&(o[0]=i),i>o[1]&&(o[1]=i)}processBorderOverlap(e,i){if(e.x===i.x){if(e.y===i.y)return;const o=e.x===0?0:1;this.addBorderIntersection(o,i.y),this.addBorderIntersection(o,e.y)}else{const o=e.y===0?2:3;this.addBorderIntersection(o,i.x),this.addBorderIntersection(o,e.x)}}centroid(){return this.accCount===0?new et(0,0):new et(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce((e,i)=>e+ +(i[0]!==Number.MAX_VALUE),0):0}}function aS(n,e){const i=n.add(e)._unit(),o=V(n.x*i.x+n.y*i.y,-1,1);var l,d,f;return l=Math.acos(o),Math.min(4,Math.max(-4,Math.tan(l)))/4*rR*((d=n).x*(f=e).y-d.y*f.x<0?-1:1)}const oR=[n=>n.x<0,n=>n.x>dt,n=>n.y<0,n=>n.y>dt];function sR(n,e,i,o){const l=[4];if(o===0)return l;i._mult(o);const d=n.sub(i),f=e.sub(i),_=[n,e,d,f];for(let v=0;v<4;v++)for(const b of _)if(oR[v](b)){l.push(v);break}return l}class Ax{constructor(e){this.groundRadiusArray=null,this.groundRadiusBuffer=null,this.vertexArray=new im,this.indexArray=new sr,this.programConfigurations=new ws(e.layers,{zoom:e.zoom,lut:e.lut},i=>iR.includes(i)),this._segments=new An,this.hiddenByLandmarkVertexArray=new Hd,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new An}getDefaultSegment(){return this.regionSegments[4]}hasData(){return this.vertexArray.length!==0}addData(e,i,o,l=!1){const d=e.length;if(d>2){let f=Math.max(0,this._segments.get().length-1);const _=this._segments._prepareSegment(4*d,this.vertexArray.length,2*this._segmentToGroundQuads[f].length);let v;f!==this._segments.get().length-1&&(f++,this._segmentToGroundQuads[f]=[],this._segmentToRegionTriCounts[f]=[0,0,0,0,0]);{const b=e[0],E=e[1];v=aS(b.sub(e[d-1])._perp()._unit(),E.sub(b)._perp()._unit())}for(let b=0;b<d;b++){const E=b===d-1?0:b+1,I=e[b],C=e[E],R=e[E===d-1?0:E+1],k=C.sub(I)._perp()._unit(),F=aS(k,R.sub(C)._perp()._unit()),U=v,j=F;if(Cx(I,C,i)||l&&uS(I,i)&&uS(C,i)){v=F;continue}const H=_.vertexLength;wy(this.vertexArray,I,C,1,1,U),wy(this.vertexArray,I,C,1,0,U),wy(this.vertexArray,I,C,0,1,j),wy(this.vertexArray,I,C,0,0,j),_.vertexLength+=4;const W=sR(I,C,k,o);for(const Y of W)this._segmentToGroundQuads[f].push({id:H,region:Y}),this._segmentToRegionTriCounts[f][Y]+=2,_.primitiveLength+=2;v=F}}}prepareBorderSegments(){if(!this.hasData())return;const e=this._segments.get(),i=e.length;for(let o=0;o<i;o++)this._segmentToGroundQuads[o].sort((l,d)=>l.region-d.region);for(let o=0;o<i;o++){const l=this._segmentToGroundQuads[o],d=e[o],f=this._segmentToRegionTriCounts[o];f.reduce((v,b)=>v+b,0);let _=0;for(let v=0;v<=4;v++){const b=f[v];if(b!==0){let E=this.regionSegments[v];E||(E=this.regionSegments[v]=new An);const I={vertexOffset:d.vertexOffset,primitiveOffset:d.primitiveOffset+_,vertexLength:d.vertexLength,primitiveLength:b};E.get().push(I)}_+=b}for(let v=0;v<l.length;v++){const b=l[v].id;this.indexArray.emplaceBack(b,b+1,b+3),this.indexArray.emplaceBack(b,b+3,b+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(e,i,o,l,d,f,_){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,e,i,o,l,d,f,void 0,_)}upload(e){this.hasData()&&(this.vertexBuffer=e.createVertexBuffer(this.vertexArray,WM.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.groundRadiusArray!=null&&(this.groundRadiusBuffer=e.createVertexBuffer(this.groundRadiusArray,ZM.members)))}uploadPaintProperties(e){this.hasData()&&this.programConfigurations.upload(e)}update(e,i,o,l,d,f,_,v){this.hasData()&&this.programConfigurations.updatePaintArrays(e,i,o,l,d,f,_,v)}updateHiddenByLandmark(e){this.updateHiddenByLandmarkRange(e.groundVertexArrayOffset,e.groundVertexCount,!!(e.flags&Ql))}updateHiddenByLandmarkRange(e,i,o){if(!this.hasData())return;const l=i+e;if(i!==0){for(let d=e;d<l;++d)this.hiddenByLandmarkVertexArray.emplace(d,o?1:0);this._needsHiddenByLandmarkUpdate=!0}}uploadHiddenByLandmark(e){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=e.createVertexBuffer(this.hiddenByLandmarkVertexArray,YM.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this.groundRadiusBuffer&&this.groundRadiusBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let e=0;e<=4;e++){const i=this.regionSegments[e];i&&i.destroy()}}}}class by{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.overscaling=e.overscaling,this.layers=e.layers,this.pixelRatio=e.pixelRatio,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=e.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new sr,this.footprintVertices=new al,this.footprintSegments=[],this.layoutVertexArray=new Oc,this.centroidVertexArray=new cy,this.wallVertexArray=new eh,this.indexArray=new sr,this.programConfigurations=new ws(e.layers,{zoom:e.zoom,lut:e.lut},i=>tR.includes(i)),this.segments=new An,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.groundEffect=new Ax(e),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[],this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,i){}updateAppearances(e,i,o,l){}populate(e,i,o,l){this.features=[],this.hasPattern=yx("fill-extrusion",this.layers,this.pixelRatio,i),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.selfDEMTileTimestamp=Number.MAX_VALUE,this.borderDEMTileTimestamp=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],this.tileToMeter=$(o),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter,this.wallMode=this.layers[0].paint.get("fill-extrusion-line-width").constantOr(1)!==0;for(const{feature:d,id:f,index:_,sourceLayerIndex:v}of e){const b=this.layers[0]._featureFilter.needGeometry,E=we(d,b);if(!this.layers[0]._featureFilter.filter(new fn(this.zoom,{worldview:this.worldview,activeFloors:i.activeFloors}),E,o))continue;const I={id:f,sourceLayerIndex:v,index:_,geometry:b?E.geometry:he(d,o,l),properties:d.properties,type:d.type,patterns:{}},C=this.layoutVertexArray.length,R=Ix[I.type]==="Polygon";if(this.hasPattern)this.features.push({featureId:d.id,feature:vx("fill-extrusion",this.layers,I,this.zoom,this.pixelRatio,i)});else if(this.wallMode)for(const k of I.geometry)for(const F of eS(k,R))this.addFeature(d.id,I,[F],_,o,{},i.availableImages,l,i.brightness);else this.addFeature(d.id,I,I.geometry,_,o,{},i.availableImages,l,i.brightness);i.featureIndex.insert(d,I.geometry,_,v,this.index,C)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(e,i,o,l,d,f){for(const{featureId:_,feature:v}of this.features){const b=Ix[v.type]==="Polygon",{geometry:E}=v;if(this.wallMode)for(const I of E)for(const C of eS(I,b))this.addFeature(_,v,[C],v.index,i,o,l,d,f);else this.addFeature(_,v,E,v.index,i,o,l,d,f)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles()}update(e,i,o,l,d,f,_){this.programConfigurations.updatePaintArrays(e,i,d,o,l,f,_,this.worldview),this.groundEffect.update(e,i,d,o,l,f,_,this.worldview)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,QM),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.wallVertexBuffer=e.createVertexBuffer(this.wallVertexArray,KM.members),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=e.createVertexBuffer(this.layoutVertexExtArray,JM.members,!0)),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}uploadCentroid(e){this.groundEffect.uploadHiddenByLandmark(e),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,XM.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,i,o,l,d,f,_,v,b){const E=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(i,{})/this.tileToMeter,I=[new et(0,0),new et(dt,dt)],C=v.projection,R=C.name==="globe",k=this.wallMode||Ix[i.type]==="Polygon",F=new sS;F.centroidDataIndex=this.centroidData.length;const U=new oS;U.buildingId=e,i.properties&&i.properties.hasOwnProperty("building_id")&&(U.buildingId=i.properties.building_id);const j=this.layers[0].paint.get("fill-extrusion-base").evaluate(i,{},d)<=0,H=this.layers[0].paint.get("fill-extrusion-height").evaluate(i,{},d);let W;if(U.height=H,U.vertexArrayOffset=this.layoutVertexArray.length,U.groundVertexArrayOffset=this.groundEffect.vertexArray.length,R&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new Nd),this.wallMode){if(R)return void bt("Non zero fill-extrusion-line-width is not yet supported on globe.");if(o.length!==1)return;W=function(be){const Ue=be[0].x===be[be.length-1].x&&be[0].y===be[be.length-1].y;(function(St){let Pt=0;const pi=St.length;for(let lt=0;lt<pi;lt++)Pt+=(St[(lt+1)%pi].x-St[lt].x)*(St[(lt+1)%pi].y+St[lt].y);return Pt>=0})(be)||(be=be.reverse());const qe={geometry:[],joinNormals:[],indices:[]},tt=[],nt=[],Ye=[];let Je=be.length;for(;Je>=2&&be[Je-1].equals(be[Je-2]);)Je--;if(Je<(Ue?3:2))return qe;let je,Be,Qe,ft,at,Ot=0;for(;Ot<Je-1&&be[Ot].equals(be[Ot+1]);)Ot++;Ue&&(je=be[Je-2],at=be[Ot].sub(je)._unit()._perp());for(let St=Ot;St<Je;St++){if(Qe=St===Je-1?Ue?be[Ot+1]:void 0:be[St+1],Qe&&be[St].equals(Qe))continue;at&&(ft=at),je&&(Be=je),je=be[St],at=Qe?Qe.sub(je)._unit()._perp():ft,ft=ft||at;let Pt=ft.add(at);Pt.x===0&&Pt.y===0||Pt._unit();const pi=Pt.x*at.x+Pt.y*at.y,lt=pi!==0?1/pi:1/0,Mt=ft.x*at.y-ft.y*at.x>0;let ei="miter";const bi=2;ei==="miter"&&lt>bi&&(ei="bevel"),ei==="bevel"&&(lt>100&&(ei="flipbevel"),lt<bi&&(ei="miter"));const Si=(oi,en,ne,ae)=>{const Ve=new et(oi.x,oi.y),it=new et(oi.x,oi.y);Ve.x+=en.x*ae,Ve.y+=en.y*ae,it.x-=en.x*Math.max(ne,1),it.y-=en.y*Math.max(ne,1),Ye.push(en),tt.push(Ve),nt.push(it)};if(ei==="miter")Pt._mult(lt),Si(je,Pt,0,0);else if(ei==="flipbevel")Pt=at.mult(-1),Si(je,Pt,0,0),Si(je,Pt.mult(-1),0,0);else{const oi=-Math.sqrt(lt*lt-1),en=Mt?oi:0,ne=Mt?0:oi;Be&&Si(je,ft,en,ne),Qe&&Si(je,at,en,ne)}}qe.geometry=[...tt,...nt.reverse(),tt[0]],qe.joinNormals=[...Ye,...Ye.reverse(),Ye[Ye.length-1]];const xt=qe.geometry.length-1;for(let St=0;St<xt/2;St++)if(St+1<xt/2){let Pt=St,pi=St+1,lt=xt-1-St,Mt=xt-2-St;Pt=Pt===0?xt-1:Pt-1,pi=pi===0?xt-1:pi-1,lt=lt===0?xt-1:lt-1,Mt=Mt===0?xt-1:Mt-1,qe.indices.push(lt),qe.indices.push(pi),qe.indices.push(Pt),qe.indices.push(lt),qe.indices.push(Mt),qe.indices.push(pi)}return qe}(o[0]),o=[W.geometry]}const Y=(be,Ue)=>be<(Ue.length-1)/2||be===Ue.length-1,se=this.wallMode?[o]:Im(o,500);for(let be=se.length-1;be>=0;be--){const Ue=se[be];(Ue.length===0||(ie=Ue[0]).every(He=>He.x<=0)||ie.every(He=>He.x>=dt)||ie.every(He=>He.y<=0)||ie.every(He=>He.y>=dt))&&se.splice(be,1)}var ie;let ce;if(R)ce=pS(se,I,d);else{ce=[];for(const be of se)ce.push({polygon:be,bounds:I})}const fe=k?this.edgeRadius:0,ge=fe>0&&this.zoom<17,Fe=(be,Ue)=>{if(be.length===0)return!1;const He=be[be.length-1];return Ue.x===He.x&&Ue.y===He.y};for(const{polygon:be,bounds:Ue}of ce){let He=0,qe=0;for(const Je of be)k&&!Je[0].equals(Je[Je.length-1])&&Je.push(Je[0]),qe+=k?Je.length-1:Je.length;const tt=this.segments.prepareSegment((k?5:4)*qe,this.layoutVertexArray,this.indexArray);U.footprintSegIdx<0&&(U.footprintSegIdx=this.footprintSegments.length),U.polygonSegIdx<0&&(U.polygonSegIdx=this.polygonSegments.length);const nt={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},Ye=new rS;if(Ye.vertexOffset=this.footprintVertices.length,Ye.indexOffset=3*this.footprintIndices.length,Ye.ringIndices=[],k){const Je=[],je=[];He=tt.vertexLength;for(let Qe=0;Qe<be.length;Qe++){const ft=be[Qe];ft.length&&Qe!==0&&je.push(Je.length/2);const at=[];let Ot,xt;Ot=ft[1].sub(ft[0])._perp()._unit(),Ye.ringIndices.push(ft.length-1);for(let St=1;St<ft.length;St++){const Pt=ft[St],pi=ft[St===ft.length-1?1:St+1],lt=Pt.clone();if(fe){xt=pi.sub(Pt)._perp()._unit();const Mt=Ot.add(xt)._unit(),ei=fe*Math.min(4,1/(Ot.x*Mt.x+Ot.y*Mt.y));lt.x+=ei*Mt.x,lt.y+=ei*Mt.y,lt.x=Math.round(lt.x),lt.y=Math.round(lt.y),Ot=xt}if(!j||fe!==0&&!ge||Fe(at,lt)||at.push(lt),Cm(this.layoutVertexArray,lt.x,lt.y,0,0,1,1,0),this.wallMode){const Mt=Y(St,ft);Pm(this.wallVertexArray,W.joinNormals[St],!Mt)}tt.vertexLength++,this.footprintVertices.emplaceBack(Pt.x,Pt.y),Je.push(Pt.x,Pt.y),R&&Mm(this.layoutVertexExtArray,C.projectTilePoint(lt.x,lt.y,d),C.upVector(d,lt.x,lt.y))}j&&(fe===0||ge)&&(at.length!==0&&Fe(at,at[0])&&at.pop(),this.groundEffect.addData(at,Ue,E))}const Be=this.wallMode?W.indices:rf(Je,je);for(let Qe=0;Qe<Be.length;Qe+=3)this.footprintIndices.emplaceBack(Ye.vertexOffset+Be[Qe+0],Ye.vertexOffset+Be[Qe+1],Ye.vertexOffset+Be[Qe+2]),this.indexArray.emplaceBack(He+Be[Qe],He+Be[Qe+2],He+Be[Qe+1]),tt.primitiveLength++;Ye.indexCount+=Be.length,Ye.vertexCount+=this.footprintVertices.length-Ye.vertexOffset}for(let Je=0;Je<be.length;Je++){const je=be[Je];F.startRing(U,je[0]);let Be=je.length>4&&hS(je[je.length-2],je[0],je[1]),Qe=fe?aR(je[je.length-2],je[0],je[1],fe):0;const ft=[];let at,Ot,xt;Ot=je[1].sub(je[0])._perp()._unit();let St=!0;for(let Pt=1,pi=0;Pt<je.length;Pt++){let lt=je[Pt-1],Mt=je[Pt];const ei=je[Pt===je.length-1?1:Pt+1];if(F.appendEdge(U,Mt,lt),Cx(Mt,lt,Ue)){fe&&(Ot=ei.sub(Mt)._perp()._unit(),St=!St);continue}const bi=Mt.sub(lt)._perp(),Si=bi.x/(Math.abs(bi.x)+Math.abs(bi.y)),oi=bi.y>0?1:0,en=lt.dist(Mt);if(pi+en>32768&&(pi=0),fe){xt=ei.sub(Mt)._perp()._unit();let it=cS(lt,Mt,ei,lS(Ot,xt),fe);isNaN(it)&&(it=0);const gt=Mt.sub(lt)._unit();lt=lt.add(gt.mult(Qe))._round(),Mt=Mt.add(gt.mult(-it))._round(),Qe=it,Ot=xt,j&&this.zoom>=17&&(Fe(ft,lt)||ft.push(lt),Fe(ft,Mt)||ft.push(Mt))}const ne=tt.vertexLength,ae=je.length>4&&hS(lt,Mt,ei);let Ve=dS(pi,Be,St);if(Cm(this.layoutVertexArray,lt.x,lt.y,Si,oi,0,0,Ve),Cm(this.layoutVertexArray,lt.x,lt.y,Si,oi,0,1,Ve),this.wallMode){const it=Y(Pt-1,je),gt=W.joinNormals[Pt-1];Pm(this.wallVertexArray,gt,it),Pm(this.wallVertexArray,gt,it)}if(pi+=en,Ve=dS(pi,ae,!St),Be=ae,Cm(this.layoutVertexArray,Mt.x,Mt.y,Si,oi,0,0,Ve),Cm(this.layoutVertexArray,Mt.x,Mt.y,Si,oi,0,1,Ve),this.wallMode){const it=Y(Pt,je),gt=W.joinNormals[Pt];Pm(this.wallVertexArray,gt,it),Pm(this.wallVertexArray,gt,it)}if(tt.vertexLength+=4,this.indexArray.emplaceBack(ne+0,ne+1,ne+2),this.indexArray.emplaceBack(ne+1,ne+3,ne+2),tt.primitiveLength+=2,fe){const it=He+(Pt===1?je.length-2:Pt-2),gt=Pt===1?He:it+1;if(this.indexArray.emplaceBack(ne+1,it,ne+3),this.indexArray.emplaceBack(it,gt,ne+3),tt.primitiveLength+=2,at===void 0&&(at=ne),!Cx(ei,je[Pt],Ue)){const yt=Pt===je.length-1?at:tt.vertexLength;this.indexArray.emplaceBack(ne+2,ne+3,yt),this.indexArray.emplaceBack(ne+3,yt+1,yt),this.indexArray.emplaceBack(ne+3,gt,yt+1),tt.primitiveLength+=3}St=!St}if(R){const it=this.layoutVertexExtArray,gt=C.projectTilePoint(lt.x,lt.y,d),yt=C.projectTilePoint(Mt.x,Mt.y,d),Ft=C.upVector(d,lt.x,lt.y),Nt=C.upVector(d,Mt.x,Mt.y);Mm(it,gt,Ft),Mm(it,gt,Ft),Mm(it,yt,Nt),Mm(it,yt,Nt)}}k&&(He+=je.length-1),j&&fe&&this.zoom>=17&&(ft.length!==0&&Fe(ft,ft[0])&&ft.pop(),this.groundEffect.addData(ft,Ue,E,fe>0))}this.footprintSegments.push(Ye),nt.triangleCount=this.indexArray.length-nt.triangleArrayOffset,this.polygonSegments.push(nt),++U.footprintSegLen,++U.polygonSegLen}if(U.vertexCount=this.layoutVertexArray.length-U.vertexArrayOffset,U.groundVertexCount=this.groundEffect.vertexArray.length-U.groundVertexArrayOffset,U.vertexCount!==0){if(U.centroidXY=F.borders?tS:this.encodeCentroid(F,U),this.centroidData.push(U),F.borders){this.featuresOnBorder.push(F);const be=this.featuresOnBorder.length-1;for(let Ue=0;Ue<F.borders.length;Ue++)F.borders[Ue][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[Ue].push(be)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,i,l,f,_,d,b,void 0,this.worldview),this.groundEffect.addPaintPropertiesData(i,l,f,_,d,b,this.worldview),this.maxHeight=Math.max(this.maxHeight,H)}}sortBorders(){for(let e=0;e<this.borderFeatureIndices.length;e++)this.borderFeatureIndices[e].sort((i,o)=>this.featuresOnBorder[i].borders[e][0]-this.featuresOnBorder[o].borders[e][0])}splitToSubtiles(){const e=[];for(let _=0;_<this.centroidData.length;_++){const v=this.centroidData[_],b=+(v.min.y+v.max.y>dt),E=2*b+(+(v.min.x+v.max.x>dt)^b);for(let I=0;I<v.polygonSegLen;I++){const C=v.polygonSegIdx+I;e.push({centroidIdx:_,subtile:E,polygonSegmentIdx:C,triangleSegmentIdx:this.polygonSegments[C].triangleSegIdx})}}const i=new sr;e.sort((_,v)=>_.triangleSegmentIdx===v.triangleSegmentIdx?_.subtile-v.subtile:_.triangleSegmentIdx-v.triangleSegmentIdx);let o=0,l=0,d=0;for(const _ of e){if(_.triangleSegmentIdx!==o)break;d++}const f=e.length;for(;l!==e.length;){o=e[l].triangleSegmentIdx;let _=0,v=l,b=l;for(let E=v;E<d&&e[E].subtile===_;E++)b++;for(;v!==d;){const E=e[v];_=E.subtile;const I=this.centroidData[E.centroidIdx].min.clone(),C=this.centroidData[E.centroidIdx].max.clone(),R={vertexOffset:this.segments.segments[o].vertexOffset,primitiveOffset:i.length,vertexLength:this.segments.segments[o].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let k=v;k<b;k++){const F=e[k],U=this.polygonSegments[F.polygonSegmentIdx],j=this.centroidData[F.centroidIdx].min,H=this.centroidData[F.centroidIdx].max,W=this.indexArray.uint16;for(let Y=U.triangleArrayOffset;Y<U.triangleArrayOffset+U.triangleCount;Y++)i.emplaceBack(W[3*Y],W[3*Y+1],W[3*Y+2]);R.primitiveLength+=U.triangleCount,I.x=Math.min(I.x,j.x),I.y=Math.min(I.y,j.y),C.x=Math.max(C.x,H.x),C.y=Math.max(C.y,H.y)}R.primitiveLength>0&&this.triangleSubSegments.push({segment:R,min:I,max:C}),v=b;for(let k=v;k<d&&e[k].subtile===e[v].subtile;k++)b++}l=d;for(let E=l;E<f&&e[E].triangleSegmentIdx===e[l].triangleSegmentIdx;E++)d++}i._trim(),this.indexArray=i}getVisibleSegments(e,i,o){const l=new An;if(this.wallMode){for(const F of this.triangleSubSegments)l.segments.push(F.segment);return l}let d=0,f=0;const _=1<<e.canonical.z;if(i){const F=i.getMinMaxForTile(e);F&&(d=F.min,f=F.max)}f+=this.maxHeight;const v=e.toUnwrapped();let b;const E=[v.canonical.x/_+v.wrap,v.canonical.y/_],I=[(v.canonical.x+1)/_+v.wrap,(v.canonical.y+1)/_],C=(F,U,j)=>[F[0]*(1-j[0])+U[0]*j[0],F[1]*(1-j[1])+U[1]*j[1]],R=[],k=[];for(const F of this.triangleSubSegments){R[0]=F.min.x/dt,R[1]=F.min.y/dt,k[0]=F.max.x/dt,k[1]=F.max.y/dt;const U=C(E,I,R),j=C(E,I,k);if(new Lt([U[0],U[1],d],[j[0],j[1],f]).intersectsPrecise(o)===0){b&&(l.segments.push(b),b=void 0);continue}const H=F.segment;b&&b.vertexOffset!==H.vertexOffset&&(l.segments.push(b),b=void 0),b?(b.vertexLength+=H.vertexLength,b.primitiveLength+=H.primitiveLength):b={vertexOffset:H.vertexOffset,primitiveLength:H.primitiveLength,vertexLength:H.vertexLength,primitiveOffset:H.primitiveOffset,sortKey:void 0,vaos:{}}}return b&&l.segments.push(b),l}encodeCentroid(e,i){const o=e.centroid(),l=i.span(),d=Math.min(7,Math.round(l.x*this.tileToMeter/10)),f=Math.min(7,Math.round(l.y*this.tileToMeter/10));return new et(V(o.x,1,dt-1)<<3|d,V(o.y,1,dt-1)<<3|f)}encodeBorderCentroid(e){if(!e.borders)return new et(0,0);const i=e.borders,o=Number.MAX_VALUE;if(i[0][0]!==o||i[1][0]!==o){const l=i[0][0]!==o?0:1;return new et(6|(i[0][0]!==o?0:65528),(i[l][0]+i[l][1])/2<<3|6)}{const l=i[2][0]!==o?2:3;return new et((i[l][0]+i[l][1])/2<<3|6,6|(i[2][0]!==o?0:65528))}}showCentroid(e){const i=this.centroidData[e.centroidDataIndex];i.flags&=2147483647,i.centroidXY.x=0,i.centroidXY.y=0,this.writeCentroidToBuffer(i)}writeCentroidToBuffer(e){this.groundEffect.updateHiddenByLandmark(e);const i=e.vertexArrayOffset,o=e.vertexCount+e.vertexArrayOffset,l=e.flags&Ql?tS:e.centroidXY,d=this.centroidVertexArray.geta_centroid_pos0(i);if(this.centroidVertexArray.geta_centroid_pos1(i)!==l.y||d!==l.x){for(let f=i;f<o;++f)this.centroidVertexArray.emplace(f,l.x,l.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const e of this.centroidData)this.writeCentroidToBuffer(e)}updateReplacement(e,i,o){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;const l=i.getReplacementRegionsForTile(e.toUnwrapped());if(xy(this.activeReplacements,l))return;if(this.activeReplacements=l,this.centroidVertexArray.length===0)this.createCentroidsBuffer();else for(const f of this.centroidData)f.flags&=2147483647;const d=[];for(const f of this.activeReplacements){if(f.order<o)continue;const _=Math.max(1,Math.pow(2,f.footprintTileId.canonical.z-e.canonical.z));if(f.footprint.buildingIds)for(const v of this.centroidData)v.flags&Ql||f.min.x>v.max.x||v.min.x>f.max.x||f.min.y>v.max.y||v.min.y>f.max.y||f.footprint.buildingIds.has(v.buildingId)&&(v.flags|=Ql);else for(const v of this.centroidData)if(!(v.flags&Ql||f.min.x>v.max.x||v.min.x>f.max.x||f.min.y>v.max.y||v.min.y>f.max.y))for(let b=0;b<v.footprintSegLen;b++){const E=this.footprintSegments[v.footprintSegIdx+b];if(d.length=0,lR(this.footprintVertices,E.vertexOffset,E.vertexCount,f.footprintTileId.canonical,e.canonical,d),Sx(f.footprint,d,this.footprintIndices.uint16,E.indexOffset,E.indexCount,-E.vertexOffset,-_)){v.flags|=Ql;break}}}for(const f of this.centroidData)this.writeCentroidToBuffer(f);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(e,i,o){let l=!1;for(let d=0;d<o.footprintSegLen;d++){const f=this.footprintSegments[o.footprintSegIdx+d];let _=0;for(const v of f.ringIndices){for(let b=_,E=v+_-1;b<v+_;E=b++){const I=this.footprintVertices.int16[2*(b+f.vertexOffset)+0],C=this.footprintVertices.int16[2*(b+f.vertexOffset)+1],R=this.footprintVertices.int16[2*(E+f.vertexOffset)+1];C>i!=R>i&&e<(this.footprintVertices.int16[2*(E+f.vertexOffset)+0]-I)*(i-C)/(R-C)+I&&(l=!l)}_=v}}return l}getHeightAtTileCoord(e,i){let o=Number.NEGATIVE_INFINITY,l=!0;const d=4*(e+dt)*dt+(i+dt);if(this.partLookup.hasOwnProperty(d)){const f=this.partLookup[d];return f?{height:f.height,hidden:!!(f.flags&Ql)}:void 0}for(const f of this.centroidData)e>f.max.x||f.min.x>e||i>f.max.y||f.min.y>i||f.height<=o||this.footprintContainsPoint(e,i,f)&&(o=f.height,this.partLookup[d]=f,l=!!(f.flags&Ql));if(o!==Number.NEGATIVE_INFINITY)return{height:o,hidden:l};this.partLookup[d]=void 0}}function lS(n,e){const i=n.add(e)._unit();return n.x*i.x+n.y*i.y}function aR(n,e,i,o){const l=e.sub(n)._perp()._unit(),d=i.sub(e)._perp()._unit();return cS(n,e,i,lS(l,d),o)}function cS(n,e,i,o,l){const d=Math.sqrt(1-o*o);return Math.min(n.dist(e)/3,e.dist(i)/3,l*d/o)}function Cx(n,e,i){return n.x<i[0].x&&e.x<i[0].x||n.x>i[1].x&&e.x>i[1].x||n.y<i[0].y&&e.y<i[0].y||n.y>i[1].y&&e.y>i[1].y}function uS(n,e){return n.x<e[0].x||n.x>e[1].x||n.y<e[0].y||n.y>e[1].y}function hS(n,e,i){if(n.x<0||n.x>=dt||e.x<0||e.x>=dt||i.x<0||i.x>=dt)return!1;const o=i.sub(e),l=o.perp(),d=n.sub(e);return(o.x*d.x+o.y*d.y)/Math.sqrt((o.x*o.x+o.y*o.y)*(d.x*d.x+d.y*d.y))>-.866&&l.x*d.x+l.y*d.y<0}function dS(n,e,i){const o=e?2|n:-3&n;return i?1|o:-2&o}function fS(){const n=Math.PI/32,e=Math.tan(n),i=u;return i*Math.sqrt(1+2*e*e)-i}function pS(n,e,i){const o=1<<i.z,l=M(i.x/o),d=M((i.x+1)/o),f=z(i.y/o),_=z((i.y+1)/o);return function(v,b,E,I,C=0,R){const k=[];if(!v.length||!E||!I)return k;const F=(ie,ce)=>{for(const fe of ie)k.push({polygon:fe,bounds:ce})},U=Math.ceil(Math.log2(E)),j=Math.ceil(Math.log2(I)),H=U-j,W=[];for(let ie=0;ie<Math.abs(H);ie++)W.push(H>0?0:1);for(let ie=0;ie<Math.min(U,j);ie++)W.push(0),W.push(1);let Y=v;if(Y=gy(Y,b[0].y-C,b[1].y+C,1),Y=gy(Y,b[0].x-C,b[1].x+C,0),!Y.length)return k;const se=[];for(W.length?se.push({polygons:Y,bounds:b,depth:0}):F(Y,b);se.length;){const ie=se.pop(),ce=ie.depth,fe=W[ce],ge=ie.bounds[0],Fe=ie.bounds[1],be=fe===0?ge.x:ge.y,Ue=fe===0?Fe.x:Fe.y,He=R?R(fe,be,Ue):.5*(be+Ue),qe=gy(ie.polygons,be-C,He+C,fe),tt=gy(ie.polygons,He-C,Ue+C,fe);if(qe.length){const nt=[ge,new et(fe===0?He:Fe.x,fe===1?He:Fe.y)];W.length>ce+1?se.push({polygons:qe,bounds:nt,depth:ce+1}):F(qe,nt)}if(tt.length){const nt=[new et(fe===0?He:ge.x,fe===1?He:ge.y),Fe];W.length>ce+1?se.push({polygons:tt,bounds:nt,depth:ce+1}):F(tt,nt)}}return k}(n,e,Math.ceil((d-l)/11.25),Math.ceil((f-_)/11.25),1,(v,b,E)=>{if(v===0)return .5*(b+E);{const I=z((i.y+b/dt)/o);return(T(.5*(z((i.y+E/dt)/o)+I))*o-i.y)*dt}})}function lR(n,e,i,o,l,d){const f=Math.pow(2,o.z-l.z);for(let _=0;_<i;_++){let v=n.int16[2*(_+e)+0],b=n.int16[2*(_+e)+1];v=(v+l.x*dt)*f-o.x*dt,b=(b+l.y*dt)*f-o.y*dt,d.push(new et(v,b))}}let mS,_S;It(by,"FillExtrusionBucket",{omit:["layers","features"]}),It(oS,"PartData"),It(rS,"FootprintSegment"),It(sS,"BorderCentroidData"),It(Ax,"GroundEffect");class uh extends et{constructor(e,i,o){super(e,i),this.z=o}}class gS extends uh{constructor(e,i,o,l){super(e,i,o),this.w=l}}function yS(n,e,i,o){const l=i==="x"?"y":"x",d=(o-n[i])/(e[i]-n[i]);n[l]=Math.round(n[l]+(e[l]-n[l])*d),n[i]=o,n.hasOwnProperty("z")&&(n.z=Kt(n.z,e.z,d)),n.hasOwnProperty("w")&&(n.w=Kt(n.w,e.w,d))}function vS(n,e,i,o){const l=i,d=o;for(const f of["x","y"]){let _=n,v=e;_[f]>=v[f]&&(_=e,v=n),_[f]<l&&v[f]>l&&yS(_,v,f,l),_[f]<d&&v[f]>d&&yS(v,_,f,d)}}function Ty(n,e,i,o,l,d){const f=[];for(let _=0;_<n.length;_++){const v=n[_];let b;const E=f.length;let I=0;for(let C=0;C<v.length-1;C++){let R=v[C],k=v[C+1],F=0;const U=I;let j,H;d&&(F=Math.hypot(k.x-R.x,k.y-R.y),I+=F,j=R,H=k),R.x<e&&k.x<e||(R.x<e?R=new et(e,R.y+(e-R.x)/(k.x-R.x)*(k.y-R.y))._round():k.x<e&&(k=new et(e,R.y+(e-R.x)/(k.x-R.x)*(k.y-R.y))._round()),R.y<i&&k.y<i||(R.y<i?R=new et(R.x+(i-R.y)/(k.y-R.y)*(k.x-R.x),i)._round():k.y<i&&(k=new et(R.x+(i-R.y)/(k.y-R.y)*(k.x-R.x),i)._round()),R.x>=o&&k.x>=o||(R.x>=o?R=new et(o,R.y+(o-R.x)/(k.x-R.x)*(k.y-R.y))._round():k.x>=o&&(k=new et(o,R.y+(o-R.x)/(k.x-R.x)*(k.y-R.y))._round()),R.y>=l&&k.y>=l||(R.y>=l?R=new et(R.x+(l-R.y)/(k.y-R.y)*(k.x-R.x),l)._round():k.y>=l&&(k=new et(R.x+(l-R.y)/(k.y-R.y)*(k.x-R.x),l)._round()),b&&R.equals(b[b.length-1])||(b=[R],f.push(b),d&&d.push({progress:{min:U+xS(j,H,R)*F,max:1},parentIndex:_,prevPoint:j,nextPoint:H})),b.push(k),d&&(d[d.length-1].progress.max=U+xS(j,H,k)*F,d[d.length-1].nextPoint=H)))))}if(d&&I>0)for(let C=E;C<f.length;C++)d[C].progress.min/=I,d[C].progress.max/=I}return f}function cR(n,e,i,o,l){if(n.length<2)return void o.push(n);const d=[];for(;e.valid();){const[b,E]=e.get();for(let I=0;I<n.length-1;I++){const C=n[I],R=n[I+1],k=ui(C,R,b,E);if(k){const[F]=k,U=new et(Kt(C.x,R.x,F),Kt(C.y,R.y,F));d.push({t:I+F,distance:0,point:U})}}e.next()}if(d.length===0)return void o.push(n);d.sort((b,E)=>b.t-E.t);let f=0,_=0,v=[];for(o.push(v);f!==n.length;){if(_===d.length){for(;f!==n.length;)v.length!==0&&v[v.length-1].equals(n[f])||v.push(n[f]),f++;break}d[_].t<=f?(v.length!==0&&v[v.length-1].equals(d[_].point)||v.push(d[_].point),Math.trunc(d[_].t),_++):(v.length!==0&&v[v.length-1].equals(n[f])||v.push(n[f]),f++)}}function xS(n,e,i){return n.x!==e.x?(i.x-n.x)/(e.x-n.x):n.y!==e.y?(i.y-n.y)/(e.y-n.y):0}function Rm(n,e){return n.x*e.x+n.y*e.y}function wS(n,e){if(n.length===1){let i=0;const o=e[i++];let l;for(;!l||o.equals(l);)if(l=e[i++],!l)return 1/0;for(;i<e.length;i++){const d=e[i],f=n[0],_=l.sub(o),v=d.sub(o),b=f.sub(o),E=Rm(_,_),I=Rm(_,v),C=Rm(v,v),R=Rm(b,_),k=Rm(b,v),F=E*C-I*I,U=(C*R-I*k)/F,j=(E*k-I*R)/F,H=o.z*(1-U-j)+l.z*U+d.z*j;if(isFinite(H))return H}return 1/0}{let i=1/0;for(const o of e)i=Math.min(i,o.z);return i}}function bS(n,e,i){let o=1/0;$i(i,e)&&(o=wS(i,e[0]));for(let l=0;l<e.length;l++){const d=e[l],f=n[l];for(let _=0;_<d.length-1;_++){const v=d[_],b=[v,d[_+1],f[_+1],f[_],v];Di(i,b)&&(o=Math.min(o,wS(i,b)))}}return o!==1/0&&o}function TS(n,e,i,o,l,d,f,_,v,b,E){return n.projection.name==="globe"?function(I,C,R,k,F,U,j,H,W,Y,se){const ie=[],ce=[],fe=I.projection.upVectorScale(se,I.center.lat,I.worldSize).metersToTile,ge=[0,0,0,1],Fe=[0,0,0,1],be=(He,qe,tt,nt)=>{He[0]=qe,He[1]=tt,He[2]=nt,He[3]=1},Ue=fS();R>0&&(R+=Ue),k+=Ue;for(const He of C){const qe=[],tt=[];for(const nt of He){const Ye=nt.x+F.x,Je=nt.y+F.y,je=I.projection.projectTilePoint(Ye,Je,se),Be=I.projection.upVector(se,nt.x,nt.y);let Qe=R,ft=k;if(j){const at=SS(Ye,Je,R,k,j,H,W,Y);Qe+=at.base,ft+=at.top}R!==0?be(ge,je.x+Be[0]*fe*Qe,je.y+Be[1]*fe*Qe,je.z+Be[2]*fe*Qe):be(ge,je.x,je.y,je.z),be(Fe,je.x+Be[0]*fe*ft,je.y+Be[1]*fe*ft,je.z+Be[2]*fe*ft),Kn(ge,ge,U),Kn(Fe,Fe,U),qe.push(new uh(ge[0],ge[1],ge[2])),tt.push(new uh(Fe[0],Fe[1],Fe[2]))}ie.push(qe),ce.push(tt)}return[ie,ce]}(n,e,i,o,l,d,f,_,v,b,E):f?function(I,C,R,k,F,U,j,H,W){const Y=[],se=[],ie=[0,0,0,1];for(const ce of I){const fe=[],ge=[];for(const Fe of ce){const be=Fe.x+k.x,Ue=Fe.y+k.y,He=SS(be,Ue,C,R,U,j,H,W);ie[0]=be,ie[1]=Ue,ie[2]=He.base,ie[3]=1,Ur(ie,ie,F),ie[3]=Math.max(ie[3],1e-5);const qe=new uh(ie[0]/ie[3],ie[1]/ie[3],ie[2]/ie[3]);ie[0]=be,ie[1]=Ue,ie[2]=He.top,ie[3]=1,Ur(ie,ie,F),ie[3]=Math.max(ie[3],1e-5);const tt=new uh(ie[0]/ie[3],ie[1]/ie[3],ie[2]/ie[3]);fe.push(qe),ge.push(tt)}Y.push(fe),se.push(ge)}return[Y,se]}(e,i,o,l,d,f,_,v,b):function(I,C,R,k,F){const U=[],j=[],H=F[8]*C,W=F[9]*C,Y=F[10]*C,se=F[11]*C,ie=F[8]*R,ce=F[9]*R,fe=F[10]*R,ge=F[11]*R;for(const Fe of I){const be=[],Ue=[];for(const He of Fe){const qe=He.x+k.x,tt=He.y+k.y,nt=F[0]*qe+F[4]*tt+F[12],Ye=F[1]*qe+F[5]*tt+F[13],Je=F[2]*qe+F[6]*tt+F[14],je=F[3]*qe+F[7]*tt+F[15],Be=nt+H,Qe=Ye+W,ft=Je+Y,at=Math.max(je+se,1e-5),Ot=nt+ie,xt=Ye+ce,St=Je+fe,Pt=Math.max(je+ge,1e-5);be.push(new uh(Be/at,Qe/at,ft/at)),Ue.push(new uh(Ot/Pt,xt/Pt,St/Pt))}U.push(be),j.push(Ue)}return[U,j]}(e,i,o,l,d)}function SS(n,e,i,o,l,d,f,_){const v=f*l.getElevationAt(n,e,!0,!0),b=d[0]!==0,E=b?d[1]===0?f*(d[0]/iS-nS):f*function(I,C,R){const k=Math.floor(C[0]/8),F=Math.floor(C[1]/8),U=10*(C[0]-8*k),j=10*(C[1]-8*F),H=I.getElevationAt(k,F,!0,!0),W=I.getMeterToDEM(R),Y=Math.floor(.5*(U*W-1)),se=Math.floor(.5*(j*W-1)),ie=I.tileCoordToPixel(k,F),ce=2*Y+1,fe=2*se+1,ge=function(tt,nt,Ye,Je,je){return[tt.getElevationAtPixel(nt,Ye,!0),tt.getElevationAtPixel(nt+je,Ye,!0),tt.getElevationAtPixel(nt,Ye+je,!0),tt.getElevationAtPixel(nt+Je,Ye+je,!0)]}(I,ie.x-Y,ie.y-se,ce,fe),Fe=Math.abs(ge[0]-ge[1]),be=Math.abs(ge[2]-ge[3]),Ue=Math.abs(ge[0]-ge[2])+Math.abs(ge[1]-ge[3]),He=Math.min(.25,.5*W*(Fe+be)/ce),qe=Math.min(.25,.5*W*Ue/fe);return H+Math.max(He*U,qe*j)}(l,d,_):v;return{base:v+(i===0?-1:i),top:b?Math.max(E+o,v+i+2):v+o}}class uR{constructor(e){this._callback=e,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}class hR{constructor(){this.tasks={},this.taskQueue=[],Te(["process"],this),this.invoker=new uR(this.process),this.nextId=0}add(e,i){const o=this.nextId++,l=function({type:d,isSymbolTile:f,zoom:_}){return _=_||0,d==="message"?0:d!=="maybePrepare"||f?d!=="parseTile"||f?d==="parseTile"&&f?300-_:d==="maybePrepare"&&f?400-_:500:200-_:100-_}(i);if(l===0){try{e()}finally{}return null}return this.tasks[o]={fn:e,metadata:i,priority:l,id:o},this.taskQueue.push(o),this.invoker.trigger(),{cancel:()=>{delete this.tasks[o]}}}process(){try{if(this.taskQueue=this.taskQueue.filter(o=>!!this.tasks[o]),!this.taskQueue.length)return;const e=this.pick();if(e===null)return;const i=this.tasks[e];if(delete this.tasks[e],this.taskQueue.length&&this.invoker.trigger(),!i)return;i.fn()}finally{}}pick(){let e=null,i=1/0;for(let l=0;l<this.taskQueue.length;l++){const d=this.tasks[this.taskQueue[l]];d.priority<i&&(i=d.priority,e=l)}if(e===null)return null;const o=this.taskQueue[e];return this.taskQueue.splice(e,1),o}remove(){this.invoker.remove()}}class ES{constructor(e,i,o){this.target=e,this.parent=i,this.mapId=o,this.callbacks={},this.cancelCallbacks={},Te(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new hR}send(e,i,o,l,d=!1,f){const _=Math.round(1e18*Math.random()).toString(36).substring(0,10);o&&(o.metadata=f,this.callbacks[_]=o);const v=new Set;return this.target.postMessage({id:_,type:e,hasCallback:!!o,targetMapId:l,mustQueue:d,sourceMapId:this.mapId,data:da(i,v)},v),{cancel:()=>{o&&delete this.callbacks[_],this.target.postMessage({id:_,type:"<cancel>",targetMapId:l,sourceMapId:this.mapId})}}}receive(e){const i=e.data;if(!i)return;const o=i.id;if(o&&(!i.targetMapId||this.mapId===i.targetMapId))if(i.type==="<cancel>"){const l=this.cancelCallbacks[o];delete this.cancelCallbacks[o],l&&l.cancel()}else if(i.mustQueue||Ii(self)){const l=this.callbacks[o],d=this.scheduler.add(()=>this.processTask(o,i),l&&l.metadata||{type:"message"});d&&(this.cancelCallbacks[o]=d)}else this.processTask(o,i)}processTask(e,i){if(delete this.cancelCallbacks[e],i.type==="<response>"){const o=this.callbacks[e];delete this.callbacks[e],o&&(i.error?o(sl(i.error)):o(null,sl(i.data)))}else{const o=new Set,l=i.hasCallback?(f,_)=>{this.target.postMessage({id:e,type:"<response>",sourceMapId:this.mapId,error:f?da(f):null,data:da(_,o)},o)}:()=>{},d=sl(i.data);if(this.parent[i.type])this.parent[i.type](i.sourceMapId,d,l);else if(this.parent.getWorkerSource){const f=i.type.split("."),{source:_,scope:v}=d;this.parent.getWorkerSource(i.sourceMapId,f[0],_,v)[f[1]](d,l)}else l(new Error(`Could not find function ${i.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}var km={workerUrl:"",workerClass:null,workerParams:void 0};const Px="mapboxgl_preloaded_worker_pool";class hh{constructor(e){this.active={},this.name=e}acquire(e,i=hh.workerCount){if(!this.workers)for(this.workers=[];this.workers.length<i;){const l=(o=`${this.name||""}WorkerPool: ${e}-${this.workers.length}`,km.workerClass!=null?new km.workerClass:new self.Worker(km.workerUrl,Object.assign({name:o},km.workerParams)));this.workers.push(l)}var o;return this.active[e]=!0,this.workers.slice()}release(e){delete this.active[e],this.workers&&this.numActive()===0&&(this.workers.forEach(i=>{i.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[Px]}numActive(){return Object.keys(this.active).length}}hh.workerCount=2;class sf{constructor(e,i,o="Worker",l=hh.workerCount){this.workerPool=e,this.actors=[],this.currentActor=0,this.id=ve();const d=this.workerPool.acquire(this.id,l);for(let f=0;f<d.length;f++){const _=new sf.Actor(d[f],i,this.id);_.name=`${o} ${f}`,this.actors.push(_)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(e,i,o){pe(this.actors,(l,d)=>{l.send(e,i,d)},o=o||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(e=>{e.remove()}),this.actors=[],this.workerPool.release(this.id)}}let Lm,Mx;function Sy(){return Lm||(Lm=new hh),Lm}sf.Actor=ES;const Rx=4096;class dR{constructor(e){this.module=e,this.memoryStack=this.module.malloc(Rx),this.memoryStackNextFree=this.memoryStack}createIntArray(e){const i=this.memoryStackNextFree;return this.memoryStackNextFree+=e.length*Int32Array.BYTES_PER_ELEMENT,this.memoryStackNextFree-this.memoryStack>Rx?-1:(new Int32Array(this.module.heap32.buffer,i,e.length).set(e),i)}createFloatArray(e){const i=this.memoryStackNextFree;return this.memoryStackNextFree+=e.length*Float32Array.BYTES_PER_ELEMENT,this.memoryStackNextFree-this.memoryStack>Rx?-1:(new Float32Array(this.module.heapF32.buffer,i,e.length).set(e),i)}readStringBuffer(e){let i="";for(;this.module.heapU8[e]!==0;)i+=String.fromCharCode(this.module.heapU8[e]),++e;return i}setStyle(e){const i=e.normalScale;this.module.setStyle(i[0],i[1],i[2],e.tileToMeters)}setAOOptions(e,i){this.module.setAOOptions(e?1:0,i)}setMetricOptions(e,i){this.module.setMetricOptions(e?1:0,i)}setStructuralOptions(e){this.module.setStructuralOptions(e?1:0)}setFacadeOptions(e,i){this.module.setFacadeOptions(e,i?1:0)}setFauxFacadeOptions(e,i,o){this.module.setFauxFacadeOptions(e?1:0,i?1:0,o)}setFacadeClassifierOptions(e){this.module.setFacadeClassifierOptions(e)}generateMesh(e,i){this.memoryStackNextFree=this.memoryStack;for(const _ of e){const v=this.createIntArray(_.ringIndices),b=this.createFloatArray(_.coordinates);if(v===-1||b===-1)return`building_gen: Out of stack memory: ${this.memoryStackNextFree-this.memoryStack}/4096`;this.module.addFeature(_.id,_.sourceId,_.minHeight,_.height,_.roofType,b,v,_.ringIndices.length-1)}for(const _ of i){let v;v=_.entrances?JSON.parse(_.entrances):[];const b=this.createFloatArray(v),E=this.createFloatArray(_.coordinates);if(b===-1||E===-1)return`building_gen: Out of stack memory: ${this.memoryStackNextFree-this.memoryStack}/4096`;this.module.addFacade(_.sourceId,_.crossPerc,_.distanceToRoad,b,v.length,E,_.coordinates.length)}if(!this.module.generateMesh()){const _=this.module.getLastError();return this.readStringBuffer(_)}const o=this.module.getMeshCount(),l=new Array(o);for(let _=0;_<o;_++){const v=this.module.getPositionsPtr(_),b=this.module.getPositionsLength(_),E=new Float32Array(this.module.heapF32.buffer,v,b),I=this.module.getNormalsPtr(_),C=this.module.getNormalsLength(_),R=new Float32Array(this.module.heapF32.buffer,I,C),k=this.module.getAOPtr(_),F=this.module.getAOLength(_),U=new Float32Array(this.module.heapF32.buffer,k,F),j=this.module.getUVPtr(_),H=this.module.getUVLength(_),W=new Float32Array(this.module.heapF32.buffer,j,H),Y=this.module.getFauxFacadePtr(_),se=this.module.getFauxFacadeLength(_),ie=new Uint8Array(this.module.heapU8.buffer,Y,se),ce=this.module.getIndicesPtr(_),fe=this.module.getIndicesLength(_),ge=new Int16Array(this.module.heap16.buffer,ce,fe),Fe=this.module.getBuildingPart(_);l[_]={positions:E,normals:R,ao:U,uv:W,isFauxFacade:ie,indices:ge,buildingPart:Fe}}const d=this.module.getRingCount(),f=[];for(let _=0;_<d;_++){const v=this.module.getRingPtr(_),b=this.module.getRingLength(_),E=new Float32Array(this.module.heapF32.buffer,v,b);f.push(E)}return{meshes:l,outerRingLength:this.module.getOuterRingLength(),modifiedPolygonRings:f}}}let zm,kx,Sa,af,Lx,lf=null,cf=null,IS=null,Ey=null;function AS(){return Ii(self)&&self.worker.dracoUrl?self.worker.dracoUrl:kx||xi.DRACO_URL}function CS(){if(Ii(self)&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(af)return af;const n=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if(typeof WebAssembly!="object")throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return af=WebAssembly.validate(n)?xi.MESHOPT_SIMD_URL:xi.MESHOPT_URL,af}function fR(){return Ey}const Iy={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},pR={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},Dm={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function PS(n,e,i){const o=i.json.bufferViews.length,l=i.buffers.length;e.bufferView=o,i.json.bufferViews[o]={buffer:l,byteLength:n.byteLength},i.buffers[l]=n}const zx="KHR_draco_mesh_compression";function mR(n,e){const i=n.extensions&&n.extensions[zx];if(!i)return;const o=new Sa.Decoder,l=LS(e,i.bufferView),d=new Sa.Mesh;if(!o.DecodeArrayToMesh(l,l.byteLength,d))throw new Error("Failed to decode Draco mesh");const f=e.json.accessors[n.indices],_=Iy[f.componentType],v=f.count*_.BYTES_PER_ELEMENT,b=Sa._malloc(v);_===Uint16Array?o.GetTrianglesUInt16Array(d,v,b):o.GetTrianglesUInt32Array(d,v,b),PS(Sa.memory.buffer.slice(b,b+v),f,e),Sa._free(b);for(const E of Object.keys(i.attributes)){const I=o.GetAttributeByUniqueId(d,i.attributes[E]),C=e.json.accessors[n.attributes[E]],R=pR[C.componentType],k=C.count*Dm[C.type]*Iy[C.componentType].BYTES_PER_ELEMENT,F=Sa._malloc(k);o.GetAttributeDataArrayForAllPoints(d,I,Sa[R],k,F),PS(Sa.memory.buffer.slice(F,F+k),C,e),Sa._free(F)}o.destroy(),d.destroy(),delete n.extensions[zx]}const Ay="EXT_meshopt_compression";function _R(n,e){if(!n.extensions||!n.extensions[Ay])return;const i=n.extensions[Ay],o=new Uint8Array(e.buffers[i.buffer],i.byteOffset||0,i.byteLength||0),l=new Uint8Array(i.count*i.byteStride);Lx.decodeGltfBuffer(l,i.count,i.byteStride,o,i.mode,i.filter),n.buffer=e.buffers.length,n.byteOffset=0,e.buffers[n.buffer]=l.buffer,delete n.extensions[Ay]}const MS=1179937895,RS=new TextDecoder("utf8");function kS(n,e){return new URL(n,e).href}function gR(n,e,i,o){return fetch(kS(n.uri,o)).then(l=>l.arrayBuffer()).then(l=>{e.buffers[i]=l})}function LS(n,e){const i=n.json.bufferViews[e];return new Uint8Array(n.buffers[i.buffer],i.byteOffset||0,i.byteLength)}function yR(n,e,i,o){if(n.uri){const l=kS(n.uri,o);return fetch(l).then(d=>d.blob()).then(d=>createImageBitmap(d)).then(d=>{e.images[i]=d})}if(n.bufferView!==void 0){const l=LS(e,n.bufferView),d=new Blob([l],{type:n.mimeType});return createImageBitmap(d).then(f=>{e.images[i]=f})}}function zS(n,e=0,i){const o={json:null,images:[],buffers:[]};if(new Uint32Array(n,e,1)[0]===MS){const E=new Uint32Array(n,e);let I=2;const C=(E[I++]>>2)-3,R=E[I++]>>2;if(I++,o.json=JSON.parse(RS.decode(E.subarray(I,I+R))),I+=R,I<C){const k=E[I++];I++;const F=e+(I<<2);o.buffers[0]=n.slice(F,F+k)}}else o.json=JSON.parse(RS.decode(new Uint8Array(n,e)));const{buffers:l,images:d,meshes:f,extensionsUsed:_,bufferViews:v}=o.json;let b=Promise.resolve();if(l){const E=[];for(let I=0;I<l.length;I++){const C=l[I];C.uri?E.push(gR(C,o,I,i)):o.buffers[I]||(o.buffers[I]=null)}b=Promise.all(E)}return b.then(()=>{const E=[],I=_&&_.includes(zx),C=_&&_.includes(Ay);if(I&&E.push(function(){if(!Sa)return zm??(zm=function(R){let k,F=null;function U(){k=new Uint8Array(F.buffer)}function j(){throw new Error("Unexpected Draco error.")}const H={a:{a:j,d:function(W,Y,se){return k.copyWithin(W,Y,Y+se)},c:function(W){const Y=k.length,se=Math.max(W>>>0,Math.ceil(1.2*Y)),ie=Math.ceil((se-Y)/65536);try{return F.grow(ie),U(),!0}catch{return!1}},b:j}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(R,H):R.then(W=>W.arrayBuffer()).then(W=>WebAssembly.instantiate(W,H))).then(W=>{const{Rb:Y,Qb:se,P:ie,T:ce,X:fe,Ja:ge,La:Fe,Qa:be,Va:Ue,Wa:He,eb:qe,jb:tt,f:nt,e:Ye,yb:Je,zb:je,Ab:Be,Bb:Qe,Db:ft,Gb:at}=W.instance.exports;F=Ye;const Ot=(()=>{let xt=0,St=0,Pt=0,pi=0;return lt=>{Pt&&(Y(pi),Y(xt),St+=Pt,Pt=xt=0),xt||(St+=128,xt=se(St));const Mt=lt.length+7&-8;let ei=xt;Mt>=St&&(Pt=Mt,ei=pi=se(Mt));for(let bi=0;bi<lt.length;bi++)k[ei+bi]=lt[bi];return ei}})();return U(),nt(),{memory:Ye,_free:Y,_malloc:se,Mesh:class{constructor(){this.ptr=ie()}destroy(){ce(this.ptr)}},Decoder:class{constructor(){this.ptr=ge()}destroy(){tt(this.ptr)}DecodeArrayToMesh(xt,St,Pt){const pi=Ot(xt),lt=Fe(this.ptr,pi,St,Pt.ptr);return!!fe(lt)}GetAttributeByUniqueId(xt,St){return{ptr:be(this.ptr,xt.ptr,St)}}GetTrianglesUInt16Array(xt,St,Pt){Ue(this.ptr,xt.ptr,St,Pt)}GetTrianglesUInt32Array(xt,St,Pt){He(this.ptr,xt.ptr,St,Pt)}GetAttributeDataArrayForAllPoints(xt,St,Pt,pi,lt){qe(this.ptr,xt.ptr,St.ptr,Pt,pi,lt)}},DT_INT8:Je(),DT_UINT8:je(),DT_INT16:Be(),DT_UINT16:Qe(),DT_UINT32:ft(),DT_FLOAT32:at()}})}(fetch(AS())),zm.then(R=>{Sa=R,zm=void 0}))}()),C&&E.push(function(){if(Lx)return;const R=function(k){let F;const U=WebAssembly.instantiateStreaming(k,{}).then(W=>{F=W.instance,F.exports.__wasm_call_ctors()}),j={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},H={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:U,supported:!0,decodeGltfBuffer(W,Y,se,ie,ce,fe){(function(ge,Fe,be,Ue,He,qe,tt){const nt=ge.exports.sbrk,Ye=Ue+3&-4,Je=nt(Ye*He),je=nt(qe.length),Be=new Uint8Array(ge.exports.memory.buffer);Be.set(qe,je);const Qe=Fe(Je,Ue,He,je,qe.length);if(Qe===0&&tt&&tt(Je,Ye,He),be.set(Be.subarray(Je,Je+Ue*He)),nt(Je-nt(0)),Qe!==0)throw new Error(`Malformed buffer data: ${Qe}`)})(F,F.exports[H[ce]],W,Y,se,ie,F.exports[j[fe]])}}}(fetch(CS()));return R.ready.then(()=>{Lx=R})}()),d)for(let R=0;R<d.length;R++)E.push(yR(d[R],o,R,i));return(E.length?Promise.all(E):Promise.resolve()).then(()=>{if(I&&f)for(const{primitives:R}of f)for(const k of R)mR(k,o);if(C&&f&&v)for(const R of v)_R(R,o);return o})})}function DS(n){return fetch(n).then(e=>e.arrayBuffer()).then(e=>zS(e,0,n))}function Dx(n){switch(n){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.RGBA;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.DEPTH_COMPONENT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.DEPTH_STENCIL;case WebGL2RenderingContext.R8:case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.RED}}function Ox(n){switch(n){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.UNSIGNED_SHORT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.UNSIGNED_INT_24_8;case WebGL2RenderingContext.R8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.FLOAT}}class Fx{constructor(e,i,o,l){this.context=e,this.format=o,this.useMipmap=l&&l.useMipmap,this.texture=e.gl.createTexture(),this.update(i,{premultiply:l&&l.premultiply})}update(e,i){const o=e&&e instanceof HTMLVideoElement&&e.width===0?e.videoWidth:e.width,l=e&&e instanceof HTMLVideoElement&&e.height===0?e.videoHeight:e.height,{context:d}=this,{gl:f}=d,{x:_,y:v}=i&&i.position?i.position:{x:0,y:0},b=_+o,E=v+l;!this.size||this.size[0]===b&&this.size[1]===E||(f.bindTexture(f.TEXTURE_2D,null),f.deleteTexture(this.texture),this.texture=f.createTexture(),this.size=null),f.bindTexture(f.TEXTURE_2D,this.texture),d.pixelStoreUnpackFlipY.set(!1),d.pixelStoreUnpack.set(1),d.pixelStoreUnpackPremultiplyAlpha.set(this.format===f.RGBA8&&(!i||i.premultiply!==!1));const I=e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||ImageBitmap&&e instanceof ImageBitmap;if(!this.size&&b>0&&E>0){const C=this.useMipmap?Math.floor(Math.log2(Math.max(b,E)))+1:1;f.texStorage2D(f.TEXTURE_2D,C,this.format,b,E),this.size=[b,E]}this.size&&(I?f.texSubImage2D(f.TEXTURE_2D,0,_,v,Dx(this.format),Ox(this.format),e):"data"in e&&e.data&&f.texSubImage2D(f.TEXTURE_2D,0,_,v,o,l,Dx(this.format),Ox(this.format),e.data)),this.useMipmap&&f.generateMipmap(f.TEXTURE_2D)}bind(e,i,o=!1){const{context:l}=this,{gl:d}=l;d.bindTexture(d.TEXTURE_2D,this.texture),e!==this.minFilter&&(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,e),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,this.useMipmap&&!o?e===d.NEAREST?d.NEAREST_MIPMAP_NEAREST:d.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),i!==this.wrapS&&(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,i),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,i),this.wrapS=i)}bindExtraParam(e,i,o,l,d){const{context:f}=this,{gl:_}=f;_.bindTexture(_.TEXTURE_2D,this.texture),i!==this.magFilter&&(_.texParameteri(_.TEXTURE_2D,_.TEXTURE_MAG_FILTER,i),this.magFilter=i),e!==this.minFilter&&(_.texParameteri(_.TEXTURE_2D,_.TEXTURE_MIN_FILTER,this.useMipmap?e===_.NEAREST?_.NEAREST_MIPMAP_NEAREST:_.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),o!==this.wrapS&&(_.texParameteri(_.TEXTURE_2D,_.TEXTURE_WRAP_S,o),this.wrapS=o),l!==this.wrapT&&(_.texParameteri(_.TEXTURE_2D,_.TEXTURE_WRAP_T,l),this.wrapT=l),d!==this.compareMode&&(d?(_.texParameteri(_.TEXTURE_2D,_.TEXTURE_COMPARE_MODE,_.COMPARE_REF_TO_TEXTURE),_.texParameteri(_.TEXTURE_2D,_.TEXTURE_COMPARE_FUNC,d)):_.texParameteri(_.TEXTURE_2D,_.TEXTURE_COMPARE_MODE,_.NONE),this.compareMode=d)}destroy(){const{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}}class Om{constructor(e,i){this.context=e,this.texture=i}bind(e,i){const{context:o}=this,{gl:l}=o;l.bindTexture(l.TEXTURE_2D,this.texture),e!==this.minFilter&&(l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,e),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,e),this.minFilter=e),i!==this.wrapS&&(l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,i),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_T,i),this.wrapS=i)}}const vR=_i([{name:"a_pos_3f",components:3,type:"Float32"}]),xR=_i([{name:"a_color_3f",components:3,type:"Float32"}]),wR=_i([{name:"a_color_4f",components:4,type:"Float32"}]),bR=_i([{name:"a_uv_2f",components:2,type:"Float32"}]),TR=_i([{name:"a_normal_3f",components:3,type:"Float32"}]),SR=_i([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),ER=_i([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]);function OS(n,e){const i=Cy(n.projection,n.zoom,n.width,n.height),o=function(d,f,_,v,b){const E=new r(_.lng-180*qc,_.lat),I=new r(_.lng+180*qc,_.lat),C=d.project(E.lng,E.lat),R=d.project(I.lng,I.lat),k=-Math.atan2(R.y-C.y,R.x-C.x),F=X.fromLngLat(_);F.y=V(F.y,-1+qc,1-qc);const U=F.toLngLat(),j=d.project(U.lng,U.lat),H=X.fromLngLat(U);H.x+=qc;const W=H.toLngLat(),Y=d.project(W.lng,W.lat),se=BS(Y.x-j.x,Y.y-j.y,k),ie=X.fromLngLat(U);ie.y+=qc;const ce=ie.toLngLat(),fe=d.project(ce.lng,ce.lat),ge=BS(fe.x-j.x,fe.y-j.y,k),Fe=Math.abs(se.x)/Math.abs(ge.y),be=ct([]);zt(be,be,-k*(1-(b?0:v)));const Ue=ct([]);return Ze(Ue,Ue,[1,1-(1-Fe)*v,1]),Ue[4]=-ge.x/ge.y*v,zt(Ue,Ue,k),xe(Ue,be,Ue),Ue}(n.projection,0,n.center,i,e),l=FS(n);return Ze(o,o,[l,l,1]),o}function FS(n){const e=n.projection,i=Cy(n.projection,n.zoom,n.width,n.height),o=Bx(e,n.center),l=Bx(e,r.convert(e.center));return Math.pow(2,o*i+(1-i)*l)}function Cy(n,e,i,o,l=1/0){const d=n.range;if(!d)return 0;const f=Math.min(l,Math.max(i,o)),_=Math.log2(f/1024);return q(d[0]+_,d[1]+_,e)}const qc=1/4e4;function Bx(n,e){const i=V(e.lat,-D,D),o=new r(e.lng-180*qc,i),l=new r(e.lng+180*qc,i),d=n.project(o.lng,i),f=n.project(l.lng,i),_=X.fromLngLat(o),v=X.fromLngLat(l),b=f.x-d.x,E=f.y-d.y,I=v.x-_.x,C=v.y-_.y,R=Math.sqrt((I*I+C*C)/(b*b+E*E));return Math.log2(R)}function BS(n,e,i){const o=Math.cos(i),l=Math.sin(i);return{x:n*o-e*l,y:n*l+e*o}}function NS(n,e,i){ct(n),zt(n,n,Oi(e[2])),Ct(n,n,Oi(e[0])),kt(n,n,Oi(e[1])),Ze(n,n,i),xe(n,n,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function Py(n,e,i,o,l,d,f,_){const v=[i[0]-e[0],i[1]-e[1],0],b=[o[0]-e[0],o[1]-e[1],0];if(pr(v)<1e-12||pr(b)<1e-12)return mc(n);const E=jr([],v,b);yn(E,E),ki(b,o,e),v[2]=(d-l)*_,b[2]=(f-l)*_;const I=v;return jr(I,v,b),yn(I,I),_c(n,E,I)}function My(n,e,i=!1){const o=Gc(e.zoom),l=function(d,f,_){const v=f.worldSize,b=[d[12],d[13],d[14]],E=z(b[1]/v),I=M(b[0]/v),C=ct([]),R=A(1,E)*v,k=A(1,0)*v*B(E,f.zoom),F=1/fx(v);let U=k*F;if(_){const Y=Cy(f.projection,f.zoom,f.width,f.height,1024);U=F*f.projection.pixelSpaceConversion(f.center.lat,v,Y)}const j=Uc(E,I);$t(j,j,gn([],yn([],j),R*U*b[2]));const H=function(Y){const se=[Y[0],Y[1],Y[2]];let ie=[0,1,0];const ce=jr([],ie,se);return jr(ie,se,ce),ia(ie)===0&&(ie=[0,1,0],jr(ce,se,ie)),yn(ce,ce),yn(ie,ie),yn(se,se),[ce[0],ce[1],ce[2],0,ie[0],ie[1],ie[2],0,se[0],se[1],se[2],0,Y[0],Y[1],Y[2],1]}(j);Ze(C,C,[U,U,U*R]),Pe(C,C,[-b[0],-b[1],-b[2]]);const W=xe([],f.globeMatrix,H);return xe(W,W,C),xe(W,W,d),W}(n,e,i);if(o>0){const d=function(f,_){const v=_.worldSize,b=A(1,0)*v*B(_.center.lat,_.zoom)/fx(v),E=A(1,_.center.lat)*v,I=ct([]);kt(I,I,Oi(_.center.lng)),Ct(I,I,Oi(_.center.lat)),Pe(I,I,[0,0,Gr]),Ze(I,I,[b,b,b*E]);const C=_.point;return Pe(I,I,[-C.x,-C.y,0]),xe(I,I,f),xe(I,_.globeMatrix,I)}(n,e);return function(f,_,v){const b=(k,F,U)=>{const j=pr(k),H=pr(F),W=Ta(k,F,U);return gn(W,W,1/pr(W)*Kt(j,H,U))},E=b([f[0],f[1],f[2]],[_[0],_[1],_[2]],v),I=b([f[4],f[5],f[6]],[_[4],_[5],_[6]],v),C=b([f[8],f[9],f[10]],[_[8],_[9],_[10]],v),R=Ta([f[12],f[13],f[14]],[_[12],_[13],_[14]],v);return[E[0],E[1],E[2],0,I[0],I[1],I[2],0,C[0],C[1],C[2],0,R[0],R[1],R[2],1]}(l,d,o)}return l}function Nx(n,e,i,o){const l=Lt.projectAabbCorners(o,i);let d=Number.MAX_VALUE;for(let _=0;_<l.length;++_){const v=l[_];v[0]=(.5*v[0]+.5)*e.width,v[1]=(.5-.5*v[1])*e.height,v[2]<d&&(d=v[2])}const f=function(_){const v=[];let b=0;for(let R=1;R<_.length;R++)(_[R][0]<_[b][0]||_[R][0]===_[b][0]&&_[R][1]<_[b][1])&&(b=R);let E,I=b;const C=new Uint8Array(_.length);do{if(C[I])break;v.push(new et(_[I][0],_[I][1])),C[I]=1,E=(I+1)%_.length;for(let R=0;R<_.length;R++){if(_[R][0]===_[E][0]&&_[R][1]===_[E][1]||_[R][0]===_[I][0]&&_[R][1]===_[I][1])continue;const k=[_[R][0]-_[I][0],_[R][1]-_[I][1]],F=[_[E][0]-_[I][0],_[E][1]-_[I][1]],U=k[0]*F[1]-k[1]*F[0];(U>0||U===0&&k[0]*F[0]+k[1]*F[1]>=0&&k[0]*k[0]+k[1]*k[1]>F[0]*F[0]+F[1]*F[1])&&(E=R)}I=E}while(I!==b);return v.length>0&&v.push(v[0]),v}(l);if(Di(n,f))return d}const dh=64,uf={CoordinateSpaceTile:1,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function Ry(n,e,i,o,l,d,f,_,v,b=!1){const E=i.zoom,I=i.project(o),C=B(o.lat,E),R=1/C;ct(n),Pe(n,n,[I.x+f[0]*R,I.y+f[1]*R,f[2]]);let k=1,F=1;const U=i.worldSize;if(b){if(i.projection.name==="mercator"){let Y=0;i.elevation&&(Y=i.elevation.getAtPointOrZero(new X(I.x/U,I.y/U),0));const se=Ur([],[I.x,I.y,Y,1],i.projMatrix)[3]/i.cameraToCenterDistance;k=se,F=se*B(i.center.lat,E)}else if(i.projection.name==="globe"){const Y=My(n,i),se=[0,0,0,1];Ur(se,se,xe([],i.projMatrix,Y));const ie=se[3]/i.cameraToCenterDistance,ce=Gc(E),fe=i.projection.pixelsPerMeter(o.lat,U)*B(o.lat,E),ge=i.projection.pixelsPerMeter(i.center.lat,U)*B(i.center.lat,E);k=ie/Kt(fe,N(i.center.lat),ce),F=ie*C/fe,k*=ge,F*=ge}}else k=R;Ze(n,n,[k,k,F]);const j=[...n],H=e.orientation,W=[];if(NS(W,[H[0]+(l?l[0]:0),H[1]+(l?l[1]:0),H[2]+(l?l[2]:0)],d),xe(n,j,W),_&&i.elevation){let Y=0;const se=[];if(v&&i.elevation){Y=function(ce,fe,ge,Fe,be){const Ue=fe.elevation;if(!Ue)return 0;const He=Lt.projectAabbCorners(ge,Fe),qe=A(1,be.lat)*fe.worldSize,tt=function(St,Pt){const pi=[0,0,1],lt=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const Mt of lt){const ei=St[Mt.corners[0]],bi=St[Mt.corners[1]],Si=St[Mt.corners[2]],oi=[bi[0]-ei[0],bi[1]-ei[1],Pt*(bi[2]-ei[2])],en=jr(oi,oi,[Si[0]-ei[0],Si[1]-ei[1],Pt*(Si[2]-ei[2])]);yn(en,en),Mt.dotProductWithUp=qn(en,pi)}return lt.sort((Mt,ei)=>Mt.dotProductWithUp-ei.dotProductWithUp),lt[0].corners}(He,qe),nt=He[tt[0]],Ye=He[tt[1]],Je=He[tt[2]],je=He[tt[3]],Be=Ue.getAtPointOrZero(new X(nt[0]/fe.worldSize,nt[1]/fe.worldSize),0),Qe=Ue.getAtPointOrZero(new X(Ye[0]/fe.worldSize,Ye[1]/fe.worldSize),0),ft=Ue.getAtPointOrZero(new X(Je[0]/fe.worldSize,Je[1]/fe.worldSize),0),at=Ue.getAtPointOrZero(new X(je[0]/fe.worldSize,je[1]/fe.worldSize),0),Ot=(Be+at)/2,xt=(Qe+ft)/2;return Ot>xt?Qe<ft?Py(ce,Ye,je,nt,Qe,at,Be,qe):Py(ce,Je,nt,je,ft,Be,at,qe):Be<at?Py(ce,nt,Ye,Je,Be,Qe,ft,qe):Py(ce,je,Je,Ye,at,ft,Qe,qe),Math.max(Ot,xt)}(se,i,e.aabb,n,o);const ie=xe([],Mi([],se),W);xe(n,j,ie)}else Y=i.elevation.getAtPointOrZero(new X(I.x/U,I.y/U),0);Y!==0&&(n[14]+=Y)}}class jS{constructor(e,i,o,l,d){this.materialOverrides=new Map,this.nodeOverrides=new Map,this.materialOverrideNames=[],this.nodeOverrideNames=[],this.featureProperties={},this.id=e,this.uri=i,this.position=o!=null?new r(o[0],o[1]):new r(0,0),this.orientation=l??[0,0,0],this.nodes=d,this.uploaded=!1,this.aabb=new Lt([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(e,i){xe(e.globalMatrix,i,e.localMatrix);const o=this.nodeOverrides.get(e.name);if(o!==void 0){const f=[];d=o.orientation,ct(l=f),kt(l,l,Oi(d[1])),zt(l,l,Oi(d[2])),Ct(l,l,Oi(d[0])),xe(e.globalMatrix,e.globalMatrix,f)}var l,d;if(e.meshes)for(const f of e.meshes){const _=Lt.applyTransformFast(f.aabb,e.globalMatrix);this.aabb.encapsulate(_)}if(e.children)for(const f of e.children)this._applyTransformations(f,e.globalMatrix)}computeBoundsAndApplyParent(){const e=ct([]);this.aabb=new Lt([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const i of this.nodes)this._applyTransformations(i,e)}computeModelMatrix(e,i,o,l,d,f,_=!1){Ry(this.matrix,this,e.transform,this.position,i,o,l,d,f,_)}upload(e){if(!this.uploaded){for(const i of this.nodes)jx(i,e);for(const i of this.nodes)ky(i);this.uploaded=!0}}destroy(){for(const e of this.nodes)Ux(e)}}function Fm(n,e,i=!1){n.uploaded||(n.gfxTexture=new Fx(e,n.image,i?e.gl.R8:e.gl.RGBA8,{useMipmap:n.sampler.minFilter>=e.gl.NEAREST_MIPMAP_NEAREST}),n.uploaded=!0,n.image=null)}function IR(n,e,i){n.indexBuffer=e.createIndexBuffer(n.indexArray,!1,!0),n.vertexBuffer=e.createVertexBuffer(n.vertexArray,vR.members,!1,!0),n.normalArray&&(n.normalBuffer=e.createVertexBuffer(n.normalArray,TR.members,!1,!0)),n.texcoordArray&&(n.texcoordBuffer=e.createVertexBuffer(n.texcoordArray,bR.members,!1,!0)),n.colorArray&&(n.colorBuffer=e.createVertexBuffer(n.colorArray,(n.colorArray.bytesPerElement===12?xR:wR).members,!1,!0)),n.featureArray&&(n.pbrBuffer=e.createVertexBuffer(n.featureArray,ER.members,!0)),n.segments=An.simpleSegment(0,0,n.vertexArray.length,n.indexArray.length);const o=n.material;o.pbrMetallicRoughness.baseColorTexture&&Fm(o.pbrMetallicRoughness.baseColorTexture,e),o.pbrMetallicRoughness.metallicRoughnessTexture&&Fm(o.pbrMetallicRoughness.metallicRoughnessTexture,e),o.normalTexture&&Fm(o.normalTexture,e),o.occlusionTexture&&Fm(o.occlusionTexture,e,i),o.emissionTexture&&Fm(o.emissionTexture,e)}function jx(n,e,i){if(n.meshes)for(const o of n.meshes)IR(o,e,i);if(n.children)for(const o of n.children)jx(o,e,i)}function ky(n){if(n.meshes)for(const e of n.meshes)e.indexArray.destroy(),e.vertexArray.destroy(),e.colorArray&&e.colorArray.destroy(),e.normalArray&&e.normalArray.destroy(),e.texcoordArray&&e.texcoordArray.destroy(),e.featureArray&&e.featureArray.destroy();if(n.children)for(const e of n.children)ky(e)}function Ux(n){if(n.meshes)for(const i of n.meshes)i.vertexBuffer&&(i.vertexBuffer.destroy(),i.indexBuffer.destroy(),i.normalBuffer&&i.normalBuffer.destroy(),i.texcoordBuffer&&i.texcoordBuffer.destroy(),i.colorBuffer&&i.colorBuffer.destroy(),i.pbrBuffer&&i.pbrBuffer.destroy(),i.segments.destroy(),i.material&&((e=i.material).pbrMetallicRoughness.baseColorTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),e.pbrMetallicRoughness.metallicRoughnessTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),e.normalTexture&&e.normalTexture.gfxTexture&&e.normalTexture.gfxTexture.destroy(),e.emissionTexture&&e.emissionTexture.gfxTexture&&e.emissionTexture.gfxTexture.destroy(),e.occlusionTexture&&e.occlusionTexture.gfxTexture&&e.occlusionTexture.gfxTexture.destroy()));var e;if(n.children)for(const i of n.children)Ux(i)}function fh(n,e){const i=n.json.bufferViews[e.bufferView],o=Iy[e.componentType];return new o(n.buffers[i.buffer],(e.byteOffset||0)+(i.byteOffset||0),e.count*(i.byteStride&&i.byteStride!==Dm[e.type]*o.BYTES_PER_ELEMENT?i.byteStride/o.BYTES_PER_ELEMENT:Dm[e.type]))}function Vx(n,e,i,o){const l=Iy[e.componentType],d=function(E){switch(E){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}}(l),f=n.json.bufferViews[e.bufferView],_=f.byteStride?f.byteStride/l.BYTES_PER_ELEMENT:Dm[e.type],v=i.float32,b=v.length/i.capacity;for(let E=0,I=0;E<e.count*_;E+=_,I+=b)for(let C=0;C<b;C++)v[I+C]=o[E+C]*d;i._trim()}function AR(n,e,i){const o=n.indices,l=n.attributes,d={};d.indexArray=new sr;const f=e.json.accessors[o],_=f.count/3;d.indexArray.reserve(_);const v=fh(e,f);for(let C=0;C<_;C++)d.indexArray.emplaceBack(v[3*C],v[3*C+1],v[3*C+2]);d.indexArray._trim(),d.vertexArray=new Fo;const b=e.json.accessors[l.POSITION];d.vertexArray.reserve(b.count);const E=fh(e,b);for(let C=0;C<b.count;C++)d.vertexArray.emplaceBack(E[3*C],E[3*C+1],E[3*C+2]);if(d.vertexArray._trim(),d.aabb=new Lt(b.min,b.max),d.centroid=function(C,R){const k=[0,0,0],F=C.length;if(F>0){for(let U=0;U<F;U++){const j=3*C[U];k[0]+=R[j],k[1]+=R[j+1],k[2]+=R[j+2]}k[0]/=F,k[1]/=F,k[2]/=F}return k}(v,E),l.COLOR_0!==void 0){const C=e.json.accessors[l.COLOR_0],R=Dm[C.type],k=fh(e,C);d.colorArray=R===3?new Fo:new ll,d.colorArray.resize(C.count),Vx(e,C,d.colorArray,k)}if(l.NORMAL!==void 0){d.normalArray=new Fo;const C=e.json.accessors[l.NORMAL];d.normalArray.resize(C.count);const R=fh(e,C);Vx(e,C,d.normalArray,R)}if(l.TEXCOORD_0!==void 0&&i.length>0){d.texcoordArray=new Hs;const C=e.json.accessors[l.TEXCOORD_0];d.texcoordArray.resize(C.count);const R=fh(e,C);Vx(e,C,d.texcoordArray,R)}if(l._FEATURE_ID_RGBA4444!==void 0){const C=e.json.accessors[l._FEATURE_ID_RGBA4444];e.json.extensionsUsed&&e.json.extensionsUsed.includes("EXT_meshopt_compression")&&(d.featureData=fh(e,C))}l._FEATURE_RGBA4444!==void 0&&(d.featureData=new Uint32Array(fh(e,e.json.accessors[l._FEATURE_RGBA4444]).buffer));const I=n.material;return d.material=function(C,R){const{emissiveFactor:k=[0,0,0],alphaMode:F="OPAQUE",alphaCutoff:U=.5,normalTexture:j,occlusionTexture:H,emissiveTexture:W,doubleSided:Y,name:se}=C,{baseColorFactor:ie=[1,1,1,1],metallicFactor:ce=1,roughnessFactor:fe=1,baseColorTexture:ge,metallicRoughnessTexture:Fe}=C.pbrMetallicRoughness||{},be=H?R[H.index]:void 0;if(H&&H.extensions&&H.extensions.KHR_texture_transform&&be){const Ue=H.extensions.KHR_texture_transform;be.offsetScale=[Ue.offset[0],Ue.offset[1],Ue.scale[0],Ue.scale[1]]}return{name:se,pbrMetallicRoughness:{baseColorFactor:new Zi(...ie),metallicFactor:ce,roughnessFactor:fe,baseColorTexture:ge?R[ge.index]:void 0,metallicRoughnessTexture:Fe?R[Fe.index]:void 0},doubleSided:Y,emissiveFactor:new Zi(...k),alphaMode:F,alphaCutoff:U,normalTexture:j?R[j.index]:void 0,occlusionTexture:be,emissionTexture:W?R[W.index]:void 0,defined:C.defined===void 0}}(I!==void 0?e.json.materials[I]:{defined:!1},i),d}function US(n,e,i){const{matrix:o,rotation:l,translation:d,scale:f,mesh:_,extras:v,children:b,name:E}=n,I={};if(I.name=E,I.localMatrix=o||function(C,R,k,F){var U=R[0],j=R[1],H=R[2],W=R[3],Y=U+U,se=j+j,ie=H+H,ce=U*Y,fe=U*se,ge=U*ie,Fe=j*se,be=j*ie,Ue=H*ie,He=W*Y,qe=W*se,tt=W*ie,nt=F[0],Ye=F[1],Je=F[2];return C[0]=(1-(Fe+Ue))*nt,C[1]=(fe+tt)*nt,C[2]=(ge-qe)*nt,C[3]=0,C[4]=(fe-tt)*Ye,C[5]=(1-(ce+Ue))*Ye,C[6]=(be+He)*Ye,C[7]=0,C[8]=(ge+qe)*Je,C[9]=(be-He)*Je,C[10]=(1-(ce+Fe))*Je,C[11]=0,C[12]=k[0],C[13]=k[1],C[14]=k[2],C[15]=1,C}([],l||[0,0,0,1],d||[0,0,0],f||[1,1,1]),I.globalMatrix=We(I.localMatrix),_!==void 0){I.meshes=i[_];const C=I.anchor=[0,0];for(const R of I.meshes){const{min:k,max:F}=R.aabb;C[0]+=k[0]+F[0],C[1]+=k[1]+F[1]}C[0]=Math.floor(C[0]/I.meshes.length/2),C[1]=Math.floor(C[1]/I.meshes.length/2)}if(v&&(v.id&&(I.id=v.id),v.lights&&(I.lights=function(C){if(!C.length)return[];const R=function(H){const W=atob(H),Y=new Uint8Array(W.length);for(let se=0;se<W.length;se++)Y[se]=W.codePointAt(se);return Y}(C),k=[],F=R.length/24,U=new Uint16Array(R.buffer),j=new Float32Array(R.buffer);for(let H=0;H<F;H++){const W=U[2*H*6]/30,Y=U[2*H*6+1]/30,se=U[2*H*6+10]/100,ie=j[6*H+1],ce=j[6*H+2],fe=j[6*H+3],ge=j[6*H+4],Fe=fe-ie,be=ge-ce,Ue=Math.hypot(Fe,be);k.push({pos:[ie+.5*Fe,ce+.5*be,Y],normal:[be/Ue,-Fe/Ue,0],width:Ue,height:W,depth:se,points:[ie,ce,fe,ge]})}return k}(v.lights)),v.MAPBOX_geometry_bloom&&(I.isGeometryBloom=v.MAPBOX_geometry_bloom)),b){const C=[];for(const R of b)C.push(US(e.json.nodes[R],e,i));I.children=C}return I}function CR(n){if(n.vertices.length===0||n.indices.length===0)return null;const e=new yy(n.vertices,n.indices,8,256),[i,o]=[e.min.clone(),e.max.clone()];return{vertices:n.vertices,indices:n.indices,grid:e,min:i,max:o}}function PR(n){if(!n.extras||!n.extras.ground)return null;const e=n.extras.ground;if(!e||!Array.isArray(e)||e.length===0)return null;const i=e[0];if(!i||!Array.isArray(i)||i.length===0)return null;const o=[];for(const f of i){if(!Array.isArray(f)||f.length!==2)continue;const _=f[0],v=f[1];typeof _=="number"&&typeof v=="number"&&o.push(new et(_,v))}if(o.length<3)return null;o.length>1&&o[o.length-1].equals(o[0])&&o.pop();let l=0;for(let f=0;f<o.length;f++){const _=o[f],v=o[(f+1)%o.length],b=o[(f+2)%o.length];l+=(_.x-v.x)*(b.y-v.y)-(b.x-v.x)*(_.y-v.y)}l>0&&o.reverse();const d=rf(o.flatMap(f=>[f.x,f.y]),[]);return d.length===0?null:{vertices:o,indices:d}}function MR(n,e){const i=[],o=[];let l=0;const d=[];for(const f of n){l=i.length;const _=f.vertexArray.float32,v=f.indexArray.uint16;for(let b=0;b<f.vertexArray.length;b++)d[0]=_[3*b+0],d[1]=_[3*b+1],d[2]=_[3*b+2],Kn(d,d,e),i.push(new et(d[0],d[1]));for(let b=0;b<3*f.indexArray.length;b++)o.push(v[b]+l)}if(o.length%3!=0)return null;for(let f=0;f<o.length;f+=3){const _=i[o[f+0]],v=i[o[f+1]],b=i[o[f+2]];(_.x-v.x)*(b.y-v.y)-(b.x-v.x)*(_.y-v.y)>0&&([o[f+1],o[f+2]]=[o[f+2],o[f+1]])}return{vertices:i,indices:o}}function $x(n){const e=function(v,b){const E=[],I=WebGL2RenderingContext;if(v.json.textures)for(const C of v.json.textures){const R={magFilter:I.LINEAR,minFilter:I.NEAREST,wrapS:I.REPEAT,wrapT:I.REPEAT};C.sampler!==void 0&&Object.assign(R,v.json.samplers[C.sampler]),E.push({image:b[C.source],sampler:R,uploaded:!1})}return E}(n,n.images),i=function(v,b){const E=[];for(const I of v.json.meshes){const C=[];for(const R of I.primitives)C.push(AR(R,v,b));E.push(C)}return E}(n,e),{scenes:o,scene:l,nodes:d}=n.json,f=o?o[l||0].nodes:[...d.keys()],_=[];for(const v of f)_.push(US(d[v],n,i));return function(v,b,E){const I={},C=new Set;for(let R=0;R<v.length;R++){const k=E[b[R]];if(!k.extras)continue;const F=k.extras["mapbox:footprint:version"],U=k.extras["mapbox:footprint:id"];(F||U)&&C.add(R),F==="1.0.0"&&U&&(I[U]=R)}for(let R=0;R<v.length;R++){if(C.has(R))continue;const k=v[R],F=E[b[R]];if(!F.extras)continue;let U=null;k.id in I&&(U=MR(v[I[k.id]].meshes,k.localMatrix)),U||(U=PR(F)),U&&(k.footprint=CR(U))}if(C.size>0){const R=Array.from(C.values()).sort((k,F)=>k-F);for(let k=R.length-1;k>=0;k--)v.splice(R[k],1)}}(_,f,n.json.nodes),_}function RR(n){n.heightmap=new Float32Array(4096),n.heightmap.fill(-1);const e=n.vertexArray.float32,i=n.aabb.min[0]-1,o=n.aabb.min[1]-1,l=dh/(n.aabb.max[0]-i+2),d=dh/(n.aabb.max[1]-o+2);for(let f=0;f<e.length;f+=3){const _=e[f+2],v=(e[f+0]-i)*l|0,b=(e[f+1]-o)*d|0;_>n.heightmap[b*dh+v]&&(n.heightmap[b*dh+v]=_)}}function VS(n,e,i,o,l){i.reserve(i.length+4*n.length),o.reserve(o.length+10*n.length),l.reserve(l.length+10*n.length);let d=o.length;for(const f of n){const _=Math.min(10,Math.max(4,1.3*f.height))*e,v=[-f.normal[1],f.normal[0],0],b=Math.min(.29,.1*f.width/f.depth),E=f.width-2*f.depth*e*(b+.01),I=Er([],f.pos,v,E/2),C=Er([],f.pos,v,-E/2),R=[I[0],I[1],I[2]+f.height],k=[C[0],C[1],C[2]+f.height],F=Er([],f.normal,v,b);gn(F,F,_);const U=Er([],f.normal,v,-b);gn(U,U,_),$t(F,I,F),$t(U,C,U),I[2]+=.1,C[2]+=.1,o.emplaceBack(F[0],F[1],F[2]),o.emplaceBack(U[0],U[1],U[2]),o.emplaceBack(I[0],I[1],I[2]),o.emplaceBack(C[0],C[1],C[2]),o.emplaceBack(R[0],R[1],R[2]),o.emplaceBack(k[0],k[1],k[2]),o.emplaceBack(I[0],I[1],I[2]),o.emplaceBack(C[0],C[1],C[2]),o.emplaceBack(F[0],F[1],F[2]),o.emplaceBack(U[0],U[1],U[2]);const j=E/_/2;l.emplaceBack(-j-b,-1,j,.8),l.emplaceBack(j+b,-1,j,.8),l.emplaceBack(-j,0,j,1.3),l.emplaceBack(j,0,j,1.3),l.emplaceBack(j+b,-.8,j,.7),l.emplaceBack(j+b,-.8,j,.7),l.emplaceBack(0,0,j,1.3),l.emplaceBack(0,0,j,1.3),l.emplaceBack(j+b,-1.2,j,.8),l.emplaceBack(j+b,-1.2,j,.8),i.emplaceBack(6+d,4+d,8+d),i.emplaceBack(7+d,9+d,5+d),i.emplaceBack(0+d,1+d,2+d),i.emplaceBack(1+d,3+d,2+d),d+=10}}function kR(n,e){const i={};i.indexArray=new sr,i.vertexArray=new Fo,i.colorArray=new ll,VS(n,e,i.indexArray,i.vertexArray,i.colorArray);const o={defined:!0};o.emissiveFactor=Zi.black;const l={};return l.baseColorFactor=Zi.white,o.pbrMetallicRoughness=l,i.material=o,i.aabb=new Lt([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),i}const $S=_i([{name:"a_pos_3f",components:3,type:"Float32"}]),LR=_i([{name:"a_normal_3",components:3,type:"Int16"}]),zR=_i([{name:"a_centroid_3",components:3,type:"Int16"}]),GS=_i([{name:"a_part_color_emissive",components:2,type:"Uint16"}]),DR=_i([{name:"a_faux_facade_color_emissive",components:2,type:"Uint16"}]),OR=_i([{name:"a_faux_facade_data",components:4,type:"Uint16"}]),FR=_i([{name:"a_faux_facade_vertical_range",components:2,type:"Uint16"}]),BR=_i([{name:"a_bloom_attenuation",components:4,type:"Float32"}]),NR=_i([{name:"a_flood_light_wall_radius_1i16",components:1,type:"Uint16"}]),HS=ye.types,Ly=32767;function jR(n,e){const i=dt+e;for(const o of n)for(const l of o)if(l.x<-e||l.x>i||l.y<-e||l.y>i)return!1;return!0}function UR(n){switch(n){case"flat":return 3;case"hipped":return 1;case"gabled":return 2;case"parapet":return 0;case"mansard":return 4;case"skillion":return 5;case"pyramidal":return 6;default:throw new Error(`Unknown roof shape: ${n}`)}}class Gx{constructor(){this.layoutVertexArray=new Fo,this.layoutAttenuationArray=new ll,this.layoutColorArray=new Bo,this.indexArray=new sr,this.indexArrayForConflation=new sr,this.segmentsBucket=new An}}class Hx{constructor(e){this.layoutFacadePaintArray=null,this.layoutFacadeDataArray=null,this.layoutFacadeVerticalRangeArray=null,this.segmentsBucket=new An,this.entranceBloom=new Gx;const i=66560;this.layoutVertexArray=new Fo,this.layoutVertexArray.reserve(i),this.layoutNormalArray=new Dc,this.layoutNormalArray.reserve(i),this.layoutCentroidArray=new Dc,this.layoutCentroidArray.reserve(i),this.layoutColorArray=new Bo,this.layoutColorArray.reserve(i),this.layoutFloodLightDataArray=new cl,this.layoutFloodLightDataArray.reserve(i),this.layoutAOArray=new Hd,this.layoutAOArray.reserve(i),this.indexArray=new sr,this.indexArray.reserve(66560),this.indexArrayForConflation=new sr,this.segmentsBucket=new An,this.entranceBloom=new Gx,e&&(this.layoutFacadePaintArray=new Bo,this.layoutFacadeDataArray=new Xl,this.layoutFacadeVerticalRangeArray=new Bo)}reserve(e,i,o){this.layoutVertexArray.reserveForAdditional(e),this.layoutCentroidArray.reserveForAdditional(e),this.layoutFloodLightDataArray.reserveForAdditional(e),this.layoutNormalArray.reserveForAdditional(e),this.layoutAOArray.reserveForAdditional(e),this.layoutColorArray.reserveForAdditional(e),this.indexArray.reserveForAdditional(i),o&&(this.layoutFacadePaintArray.reserveForAdditional(e),this.layoutFacadeDataArray.reserveForAdditional(e),this.layoutFacadeVerticalRangeArray.reserveForAdditional(e))}}class qS{constructor(e){this.colorBufferUploaded=!1,this.maxHeight=0,this.replacementUpdateTime=0,this.activeReplacements=[],this.footprints=[],this.footprintsVertices=new Hs,this.footprintsIndices=new cl,this.footprintsMin=new et(1/0,1/0),this.footprintsMax=new et(-1/0,-1/0),this.featuresOnBorder=[],this.buildingWithoutFacade=new Hx(!1),this.buildingWithFacade=new Hx(!0),this.indexArrayForConflationUploaded=!1,this.featureFootprintLookup=new Map,this.buildingIds=new Set,this.footprintLookup={},this.zoom=e.zoom,this.canonical=e.canonical,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.worldview=e.worldview,this.lut=e.lut,this.programConfigurations=new ws(e.layers,{zoom:e.zoom,lut:e.lut}),this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.projection=e.projection,this.groundEffect=new Ax(e),this.groundEffect.groundRadiusArray=new _a,this.hasAppearances=null}updateFootprints(e,i){const o=new yy([],[],1),l={vertices:[],indices:new Uint32Array(0),grid:o,min:this.footprintsMin,max:this.footprintsMax,buildingIds:this.buildingIds};i.push({footprint:l,id:e})}updateAppearances(e,i,o,l){}prepare(){return function(){if(Ey!=null||IS!=null)return null;if(cf!=null)return cf;const e=fetch(xi.BUILDING_GEN_URL);return cf=function(i){let o,l,d,f,_;function v(){o=new Uint8Array(_.buffer),l=new Int16Array(_.buffer),d=new Int32Array(_.buffer),f=new Float32Array(_.buffer)}function b(){throw new Error("Unexpected BuildingGen error.")}const E=()=>{},I={a:{a:b,f:function(C){const R=o.length,k=Math.max(C>>>0,Math.ceil(1.2*R)),F=Math.ceil((k-R)/65536);try{return _.grow(F),v(),!0}catch{return!1}},g:b,b:E,c:E,d:E,e:E}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(i,I):i.then(C=>C.arrayBuffer()).then(C=>WebAssembly.instantiate(C,I))).then(C=>{const R=C.instance.exports;return(0,R.g)(),_=R.f,v(),new dR({setStyle:R.h,setAOOptions:R.i,setMetricOptions:R.j,setStructuralOptions:R.k,setFacadeOptions:R.l,setFauxFacadeOptions:R.m,setFacadeClassifierOptions:R.n,addFeature:R.o,addFacade:R.p,generateMesh:R.q,getLastError:R.r,getOuterRingLength:R.s,getMeshCount:R.t,getPositionsPtr:R.u,getPositionsLength:R.v,getNormalsPtr:R.w,getNormalsLength:R.x,getAOPtr:R.y,getAOLength:R.z,getUVPtr:R.A,getUVLength:R.B,getFauxFacadePtr:R.C,getFauxFacadeLength:R.D,getIndicesPtr:R.E,getIndicesLength:R.F,getBuildingPart:R.G,getRingCount:R.H,getRingPtr:R.I,getRingLength:R.J,malloc:R.K,free:R.L,heapU8:o,heap16:l,heap32:d,heapF32:f})})}(e).then(i=>(cf=null,Ey=i,Ey)).catch(i=>{bt("Could not load building-gen"),cf=null,IS=i}),cf}()}populate(e,i,o,l){const d=fR();if(!d)return;const f=$(o);this.tileToMeter=f,this.brightness=i.brightness,d.setStyle({normalScale:[1,-1,f],tileToMeters:f}),d.setAOOptions(!1,.3),d.setMetricOptions(!1,16),d.setStructuralOptions(!0),d.setFacadeClassifierOptions(3);const _=new Map,v=new Map;let b=0;for(const{feature:j}of e){if(HS[j.type]!=="LineString"){_.set(j.id,j.properties.source_id);continue}const H=this.layers[0]._featureFilter.needGeometry;if(H&&!this.layers[0]._featureFilter.filter(new fn(this.zoom),j,o))continue;const W=we(j,H);if(!H&&!this.layers[0]._featureFilter.filter(new fn(this.zoom),W,o))continue;const Y=H?W.geometry:he(j,o,l),se=[];for(const ge of Y)for(const Fe of ge)se.push(Fe.x),se.push(Fe.y);const ie={coordinates:se,crossPerc:j.properties.cross_perc,distanceToRoad:j.properties.distance_to_road,entrances:j.properties.entrances,sourceId:0},ce=j.properties.source_id;let fe=v.get(ce);fe||(fe=[],v.set(ce,fe)),fe.push(ie),++b}this.maxHeight=0;const E=new Array,I=new Set,C=j=>{j!=null&&I.add(j)},R=(j,H)=>{j!=null&&E.push({buildingId:j,footprintIndex:H})},k=64*(e.length-b),F=k/2;this.buildingWithFacade.reserve(k,F,!0),this.buildingWithoutFacade.reserve(2*k,2*F,!1),this.footprintsIndices.reserve(16*(e.length-b)),this.footprintsVertices.reserve(8*(e.length-b));for(const{feature:j,id:H,index:W,sourceLayerIndex:Y}of e){if(HS[j.type]==="LineString")continue;const se=this.layers[0]._featureFilter.needGeometry;if(se&&!this.layers[0]._featureFilter.filter(new fn(this.zoom),j,o))continue;let ie=null;if(j.properties&&j.properties.hasOwnProperty("building_id")&&(ie=j.properties.building_id,I.has(ie)))continue;const ce=we(j,se);if(!se&&!this.layers[0]._featureFilter.filter(new fn(this.zoom),ce,o))continue;const fe=se?ce.geometry:he(j,o,l),ge=Im(fe,500);let Fe=!1;for(const qt of ge)if(qt.length!==1){Fe=!0;break}if(Fe){C(ie);continue}if(!jR(fe,163)){C(ie);continue}const be=this.layers[0],Ue=UR(be.layout.get("building-roof-shape").evaluate(j,{},o)),He=be.layout.get("building-base").evaluate(j,{},o),qe=be.layout.get("building-height").evaluate(j,{},o),tt=be.layout.get("building-flood-light-ground-radius").evaluate(j,{},o),nt=be.paint.get("building-ambient-occlusion-intensity"),Ye=tt/this.tileToMeter;j.properties["building-part"]="roof";const Je=be.paint.get("building-color").evaluate(j,{},this.canonical).toPremultipliedRenderColor(this.lut),je=be.paint.get("building-emissive-strength").evaluate(j,{},this.canonical);j.properties["building-part"]="wall";const Be=be.paint.get("building-color").evaluate(j,{},this.canonical).toPremultipliedRenderColor(this.lut),Qe=be.paint.get("building-emissive-strength").evaluate(j,{},this.canonical);j.properties["building-part"]="window";const ft=be.paint.get("building-color").evaluate(j,{},this.canonical).toPremultipliedRenderColor(this.lut),at=be.paint.get("building-emissive-strength").evaluate(j,{},this.canonical);j.properties["building-part"]="door";const Ot=be.paint.get("building-color").evaluate(j,{},this.canonical).toPremultipliedRenderColor(this.lut),xt=be.paint.get("building-emissive-strength").evaluate(j,{},this.canonical);let St=be.layout.get("building-flood-light-wall-radius").evaluate(j,{},o);St=V(St,0,2048);const Pt=St/2048*Ly,pi=_.get(H),lt=v.get(pi)||[],Mt=lt.length!==0&&be.layout.get("building-facade").evaluate(j,{},o);d.setFacadeOptions(4,!0),d.setFauxFacadeOptions(Mt,!1,1);let ei=0,bi=0,Si=0,oi=0,en=0,ne=0,ae=0,Ve=0,it=0,gt=0,yt=0;if(Mt){let qt=Math.round(be.layout.get("building-facade-floors").evaluate(j,{},o));if(He===0){qt=Math.max(1,qt-(lt.length>0?1:0));let Yi=4;if(qe>100){const wn=[10,13,15];Yi=wn[j.id?j.id%wn.length:0]}else qe<=10&&(Yi=3);d.setFacadeOptions(Yi,!0),en=(qe<15?1.3:1.61803)*Yi/f}else en=He/f;ne=qe/f,en=Math.min(en,ne),Si=be.layout.get("building-facade-unit-width").evaluate(j,{},o)/f,oi=(ne-en)/qt,d.setFauxFacadeOptions(!0,!0,Si);const Mn=be.layout.get("building-facade-window").evaluate(j,{},o);ei=Mn[0],bi=Mn[1],ae=Math.floor(65535*Math.min(1,en/dt)),Ve=Math.floor(65535*Math.min(1,ne/dt)),it=Math.floor(255*ei)<<8|Math.floor(255*bi),gt=Math.floor(65535*Math.min(1,Si/dt)),yt=Math.floor(65535*Math.min(1,oi/dt))}const Ft=Array(ge.length),Nt={x:1/0,y:1/0},ni={x:-1/0,y:-1/0},hi={x:0,y:0};let fi=0;for(let qt=0;qt<ge.length;qt++){const Mn=ge[qt];if(Mn.length>0){const Yi=[],wn=Array(Mn.length+1);wn[0]=0;for(let cr=0;cr<Mn.length;cr++){const Tr=Mn[cr];for(let ir=0;ir<Tr.length;ir++){const nr=Tr[Tr.length-ir-1];Nt.x=Math.min(Nt.x,nr.x),Nt.y=Math.min(Nt.y,nr.y),ni.x=Math.max(ni.x,nr.x),ni.y=Math.max(ni.y,nr.y),hi.x+=nr.x,hi.y+=nr.y,fi++,Yi.push(nr.x),Yi.push(nr.y)}wn[cr+1]=Yi.length}Ft[qt]={id:j.id?j.id:0,height:qe,minHeight:He,sourceId:0,roofType:Ue,coordinates:Yi,ringIndices:wn}}}hi.x/=fi||1,hi.y/=fi||1;const gi=d.generateMesh(Ft,lt);if(typeof gi=="string"){bt(`Unable to generate building ${j.id}: ${gi}`),C(ie);continue}if(gi.meshes.length===0||gi.modifiedPolygonRings.length===0){C(ie);continue}const Wt=Mt?this.buildingWithFacade:this.buildingWithoutFacade;let Qt=0;for(const qt of gi.meshes)Qt+=qt.positions.length/3;const Pi=Wt.segmentsBucket.prepareSegment(Qt,Wt.layoutVertexArray,Wt.indexArray),Bi=[];let Ni=null,Ki=0,sn=-1;const tn=Wt.layoutVertexArray.length,Vi=tn+Qt;Wt.layoutVertexArray.resize(Vi),Wt.layoutCentroidArray.resize(Vi),Wt.layoutNormalArray.resize(Vi),Wt.layoutAOArray.resize(Vi),Wt.layoutColorArray.resize(Vi),Wt.layoutFloodLightDataArray.resize(Vi),Mt&&(Wt.layoutFacadePaintArray.resize(Vi),Wt.layoutFacadeDataArray.resize(Vi),Wt.layoutFacadeVerticalRangeArray.resize(Vi));const qi=Wt.indexArray.length;let di=0,Ti=tn;for(const qt of gi.meshes){let Mn,Yi;if(qt.buildingPart===1)Mn=Je,Yi=je;else if(qt.buildingPart===0)Mn=Be,Yi=Qe;else if(qt.buildingPart===2)Mn=ft,Yi=at;else{if(qt.buildingPart!==3)continue;Mn=Ot,Yi=xt}if(Yi=V(Yi,0,1),qt.buildingPart===3){const un=new Array;for(let ur=0;ur<qt.positions.length;ur+=12){const Xs=qt.positions[ur+0],pl=qt.positions[ur+1],Br=qt.positions[ur+3],uo=qt.positions[ur+4],Vo=qt.positions[ur+2],Kc=qt.positions[ur+8]-Vo,Tf=1,Pa=Br-Xs,Ma=uo-pl,a_=Math.hypot(Pa,Ma);un.push({pos:[Xs+.5*Pa,pl+.5*Ma,Vo],normal:[Ma/a_,-Pa/a_,0],width:a_,height:Kc,depth:Tf,points:[Xs,pl,Br,uo]})}const Hn=Wt.entranceBloom.segmentsBucket.prepareSegment(10*un.length,Wt.entranceBloom.layoutVertexArray,Wt.entranceBloom.indexArray),Xn=Wt.entranceBloom.layoutVertexArray.length;Ki=Wt.entranceBloom.indexArray.length,VS(un,.5/this.tileToMeter,Wt.entranceBloom.indexArray,Wt.entranceBloom.layoutVertexArray,Wt.entranceBloom.layoutAttenuationArray);const Co=Wt.entranceBloom.layoutVertexArray.length-Xn;sn=Wt.entranceBloom.indexArray.length-Ki;for(let ur=0;ur<Co;ur++)Wt.entranceBloom.layoutColorArray.emplaceBack(255*Ot.r<<8|255*Ot.g,255*Ot.b<<8|51*xt);Hn.vertexLength+=Co,Hn.primitiveLength+=sn,Ni={part:qt.buildingPart,vertexOffset:Xn,vertexLength:Co}}Wt.layoutVertexArray.float32.set(qt.positions,3*Ti);const wn=qt.positions.length/3;for(let un=0;un<wn;++un){const Hn=3*un;di=Math.max(di,qt.positions[Hn+2]);const Xn=qt.normals[Hn+1]*Ly,Co=qt.normals[Hn+2]*Ly,ur=3*(Ti+un);Wt.layoutNormalArray.int16[ur]=qt.normals[Hn]*Ly,Wt.layoutNormalArray.int16[ur+1]=Xn,Wt.layoutNormalArray.int16[ur+2]=Co;const Xs=qt.ao[un];Wt.layoutAOArray.uint8[Ti+un]=255*Xs;const pl=1+(Xs-1)*nt,Br=255*Mn.b*pl<<8|255*Yi;Wt.layoutColorArray.uint16[2*(Ti+un)]=255*Mn.r*pl<<8|255*Mn.g*pl,Wt.layoutColorArray.uint16[2*(Ti+un)+1]=Br}const cr=Math.floor(hi.x),Tr=Math.floor(hi.y),ir=Math.floor(qe);for(let un=0;un<wn;++un){const Hn=3*(Ti+un);Wt.layoutCentroidArray.int16[Hn]=cr,Wt.layoutCentroidArray.int16[Hn+1]=Tr,Wt.layoutCentroidArray.int16[Hn+2]=ir}if(Wt.layoutFloodLightDataArray.uint16.fill(qt.buildingPart===0?Pt:0,Ti,Ti+wn),Mt){const un=255*ft.r<<8|255*ft.g,Hn=255*ft.b<<8|255*at;for(let Xn=0;Xn<wn;++Xn){const Co=2*(Ti+Xn);Wt.layoutFacadePaintArray.uint16[Co]=un,Wt.layoutFacadePaintArray.uint16[Co+1]=Hn}for(let Xn=0;Xn<wn;++Xn)if(qt.isFauxFacade[Xn]){const Co=Math.min(65535,Math.floor(qt.uv[2*Xn]*gi.outerRingLength));Wt.layoutFacadeDataArray.emplace(Ti+Xn,1|Co,it,gt,yt),Wt.layoutFacadeVerticalRangeArray.emplace(Ti+Xn,ae,Ve)}else Wt.layoutFacadeDataArray.emplace(Ti+Xn,0,0,0,0),Wt.layoutFacadeVerticalRangeArray.emplace(Ti+Xn,0,0)}const nr=Pi.vertexLength,gr=qt.indices.length/3,wo=Wt.indexArray.length;Wt.indexArray.resize(wo+gr);for(let un=0;un<gr;++un){const Hn=3*un,Xn=3*wo+Hn;Wt.indexArray.uint16[Xn]=nr+qt.indices[Hn],Wt.indexArray.uint16[Xn+1]=nr+qt.indices[Hn+1],Wt.indexArray.uint16[Xn+2]=nr+qt.indices[Hn+2]}qt.buildingPart!==1&&qt.buildingPart!==0&&qt.buildingPart!==2&&qt.buildingPart!==3||Bi.push({part:qt.buildingPart,vertexOffset:Ti,vertexLength:qt.positions.length/3}),Ti+=wn,Pi.vertexLength+=wn,Pi.primitiveLength+=qt.indices.length/3}this.maxHeight=Math.max(this.maxHeight,di);const Tn=Wt.indexArray.length-qi,Ht=this.footprintsIndices.length,yi=this.footprintsVertices.length,nn=[],ln=new et(1/0,1/0),pn=new et(-1/0,-1/0),Zn=this.groundEffect.vertexArray.length;for(const qt of gi.modifiedPolygonRings){const Mn=[],Yi=new et(1/0,1/0),wn=new et(-1/0,-1/0);for(let cr=0;cr<qt.length;cr+=2){const Tr=qt.length-cr-2;Yi.x=Math.min(Yi.x,qt[Tr]),Yi.y=Math.min(Yi.y,qt[Tr+1]),wn.x=Math.max(wn.x,qt[Tr]),wn.y=Math.max(wn.y,qt[Tr+1]);const ir=new et(qt[Tr],qt[Tr+1]);Mn.push(ir),nn.push(ir.x,ir.y),this.footprintsVertices.emplaceBack(ir.x,ir.y)}ln.x=Math.min(ln.x,Yi.x),ln.y=Math.min(ln.y,Yi.y),pn.x=Math.max(pn.x,wn.x),pn.y=Math.max(pn.y,wn.y),this.groundEffect.addData(Mn,[Yi,wn],Ye)}const cn=this.groundEffect.vertexArray.length-Zn;this.groundEffect.groundRadiusArray.reserveForAdditional(cn);for(let qt=0;qt<cn;qt++)this.groundEffect.groundRadiusArray.emplaceBack(tt);(Nt.x<0||ni.x>dt||Nt.y<0||ni.y>dt)&&this.featuresOnBorder.push({featureId:j.id,footprintIndex:this.footprints.length});{const qt=rf(nn,null,2);this.footprintsIndices.resize(this.footprintsIndices.length+qt.length),this.footprintsIndices.uint16.set(qt,Ht),this.buildingIds.add(ie??j.id),this.footprintsMin.x=Math.min(this.footprintsMin.x,ln.x),this.footprintsMin.y=Math.min(this.footprintsMin.y,ln.y),this.footprintsMax.x=Math.max(this.footprintsMax.x,pn.x),this.footprintsMax.y=Math.max(this.footprintsMax.y,pn.y);const Mn={footprintVertexOffset:yi,footprintVertexLength:this.footprintsVertices.length-yi,footprintIndexOffset:Ht,footprintIndexLength:this.footprintsIndices.length-Ht,min:ln,max:pn,hiddenFlags:0,indicesOffset:qi,indicesLength:Tn,bloomIndicesOffset:Ki,bloomIndicesLength:sn,groundEffectVertexOffset:Zn,groundEffectVertexLength:cn,hasFauxFacade:Mt,height:di,promoteId:H,feature:ce,parts:Bi,buildingBloom:Ni},Yi=this.footprints.length;j.id!==void 0&&this.featureFootprintLookup.set(j.id,Yi),R(ie,Yi),this.footprints.push(Mn)}this.programConfigurations.populatePaintArrays(Wt.layoutVertexArray.length,j,W,{},i.availableImages,o,i.brightness),this.groundEffect.addPaintPropertiesData(j,W,{},i.availableImages,o,i.brightness),i.featureIndex.insert(j,fe,W,Y,this.index,tn)}E.forEach(({buildingId:j,footprintIndex:H})=>{I.has(j)&&(this.footprints[H].hiddenFlags|=4)});const U=new Set;this.buildingIds.forEach((j,H,W)=>{I.has(j)||U.add(j)}),this.buildingIds=U,this.groundEffect.prepareBorderSegments()}update(e,i,o,l,d,f,_){this.programConfigurations.updatePaintArrays(e,i,d,o,l,f,_),this.groundEffect.update(e,i,d,o,l,f,_),this.evaluate(this.layers[0],e),this.colorBufferUploaded=!1}isEmpty(){return this.buildingWithoutFacade.layoutVertexArray.length===0&&this.buildingWithFacade.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){const i=o=>{o.layoutVertexBuffer=e.createVertexBuffer(o.layoutVertexArray,$S.members),o.layoutNormalBuffer=e.createVertexBuffer(o.layoutNormalArray,LR.members),o.layoutCentroidBuffer=e.createVertexBuffer(o.layoutCentroidArray,zR.members),o.layoutFloodLightDataBuffer=e.createVertexBuffer(o.layoutFloodLightDataArray,NR.members),o.layoutFacadeDataArray&&o.layoutFacadeDataArray.length&&(o.layoutFacadeDataBuffer=e.createVertexBuffer(o.layoutFacadeDataArray,OR.members)),o.layoutFacadeVerticalRangeArray&&o.layoutFacadeVerticalRangeArray.length&&(o.layoutFacadeVerticalRangeBuffer=e.createVertexBuffer(o.layoutFacadeVerticalRangeArray,FR.members)),o.entranceBloom.layoutVertexArray.length&&(o.entranceBloom.layoutVertexBuffer=e.createVertexBuffer(o.entranceBloom.layoutVertexArray,$S.members),o.entranceBloom.layoutAttenuationBuffer=e.createVertexBuffer(o.entranceBloom.layoutAttenuationArray,BR.members)),this.uploadUpdatedColorBuffer(e),this.uploadUpdatedIndexBuffer(e)};this.uploaded||(i(this.buildingWithoutFacade),i(this.buildingWithFacade),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){const e=i=>{i.layoutVertexBuffer&&(i.layoutVertexBuffer.destroy(),i.layoutNormalBuffer.destroy(),i.layoutColorBuffer.destroy(),i.segmentsBucket.destroy(),i.indexBuffer&&i.indexBuffer.destroy(),i.entranceBloom.layoutVertexBuffer&&(i.entranceBloom.layoutVertexBuffer.destroy(),i.entranceBloom.layoutColorBuffer.destroy(),i.entranceBloom.layoutAttenuationBuffer.destroy(),i.entranceBloom.indexBuffer.destroy(),i.entranceBloom.segmentsBucket.destroy()))};e(this.buildingWithoutFacade),e(this.buildingWithFacade),this.groundEffect.destroy(),this.programConfigurations.destroy()}updateFootprintHiddenFlags(e,i,o=!0){let l=!1;const d=o?i:0,f=0|(o?-1:~i);this.groundEffect.hiddenByLandmarkVertexArray.length===0&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const _ of e){const v=this.footprints[_],b=v.hiddenFlags&f|d;v.hiddenFlags!==b&&(v.hiddenFlags=b,l=!0,this.groundEffect.updateHiddenByLandmarkRange(v.groundEffectVertexOffset,v.groundEffectVertexLength,v.hiddenFlags!==0))}return l&&(this.indexArrayForConflationUploaded=!1),l}uploadUpdatedIndexBuffer(e){if(this.groundEffect.uploadHiddenByLandmark(e),this.indexArrayForConflationUploaded)return;const i=l=>{l.indexArray.length!==0&&(l.indexArrayForConflation.resize(l.indexArray.length),l.indexArrayForConflation.uint16.set(l.indexArray.uint16),l.entranceBloom.indexArrayForConflation.resize(l.entranceBloom.indexArray.length),l.entranceBloom.indexArrayForConflation.uint16.set(l.entranceBloom.indexArray.uint16))};i(this.buildingWithoutFacade),i(this.buildingWithFacade);for(const l of this.footprints){const d=l.hasFauxFacade?this.buildingWithFacade:this.buildingWithoutFacade,f=l.indicesOffset+l.indicesLength;if(l.hiddenFlags!==0){for(let v=l.indicesOffset;v<f;v++)d.indexArrayForConflation.uint16[3*v+0]=0,d.indexArrayForConflation.uint16[3*v+1]=0,d.indexArrayForConflation.uint16[3*v+2]=0;const _=l.bloomIndicesOffset+l.bloomIndicesLength;for(let v=l.bloomIndicesOffset;v<_;v++)d.entranceBloom.indexArrayForConflation.uint16[3*v+0]=0,d.entranceBloom.indexArrayForConflation.uint16[3*v+1]=0,d.entranceBloom.indexArrayForConflation.uint16[3*v+2]=0}}const o=l=>{l.indexArray.length!==0&&(l.indexBuffer?l.indexBuffer.updateData(l.indexArrayForConflation):l.indexBuffer=e.createIndexBuffer(l.indexArrayForConflation,!0),l.entranceBloom.indexBuffer?l.entranceBloom.indexBuffer.updateData(l.entranceBloom.indexArrayForConflation):l.entranceBloom.indexBuffer=e.createIndexBuffer(l.entranceBloom.indexArrayForConflation,!0))};o(this.buildingWithoutFacade),o(this.buildingWithFacade),this.indexArrayForConflationUploaded=!0}uploadUpdatedColorBuffer(e){const i=o=>{o.layoutColorBuffer?o.layoutColorBuffer.updateData(o.layoutColorArray):o.layoutColorBuffer=e.createVertexBuffer(o.layoutColorArray,GS.members,!0),o.layoutFacadePaintArray&&(o.layoutFacadePaintBuffer?o.layoutFacadePaintBuffer.updateData(o.layoutFacadePaintArray):o.layoutFacadePaintBuffer=e.createVertexBuffer(o.layoutFacadePaintArray,DR.members,!0)),o.entranceBloom.layoutColorBuffer?o.entranceBloom.layoutColorBuffer.updateData(o.entranceBloom.layoutColorArray):o.entranceBloom.layoutColorBuffer=e.createVertexBuffer(o.entranceBloom.layoutColorArray,GS.members,!0)};i(this.buildingWithoutFacade),i(this.buildingWithFacade),this.colorBufferUploaded=!0}evaluate(e,i){const o=e.paint.get("building-ambient-occlusion-intensity");for(const l of this.footprints){if(4&l.hiddenFlags)continue;const d=i[l.promoteId],f=l.feature;f.properties["building-part"]="roof";const _=e.paint.get("building-color").evaluate(f,d,this.canonical).toPremultipliedRenderColor(this.lut),v=e.paint.get("building-emissive-strength").evaluate(f,d,this.canonical);f.properties["building-part"]="wall";const b=e.paint.get("building-color").evaluate(f,d,this.canonical).toPremultipliedRenderColor(this.lut),E=e.paint.get("building-emissive-strength").evaluate(f,d,this.canonical);f.properties["building-part"]="window";const I=e.paint.get("building-color").evaluate(f,d,this.canonical).toPremultipliedRenderColor(this.lut),C=e.paint.get("building-emissive-strength").evaluate(f,d,this.canonical);f.properties["building-part"]="door";const R=e.paint.get("building-color").evaluate(f,d,this.canonical).toPremultipliedRenderColor(this.lut),k=e.paint.get("building-emissive-strength").evaluate(f,d,this.canonical),F=l.hasFauxFacade?this.buildingWithFacade:this.buildingWithoutFacade;for(const j of l.parts){let H,W=_;j.part===1?(W=_,H=v):j.part===0?(W=b,H=E):j.part===2?(W=I,H=C):j.part===3&&(W=R,H=k),H=V(H,0,1);for(let Y=0;Y<j.vertexLength;Y++){const se=j.vertexOffset+Y,ie=1+(F.layoutAOArray.uint8[se]/255-1)*o;F.layoutColorArray.emplace(se,W.r*ie*255<<8|W.g*ie*255,W.b*ie*255<<8|255*H),l.hasFauxFacade&&F.layoutFacadePaintArray.emplace(se,255*I.r<<8|255*I.g,255*I.b<<8|255*C)}}const U=l.buildingBloom;if(U)for(let j=0;j<U.vertexLength;j++)F.entranceBloom.layoutColorArray.emplace(U.vertexOffset+j,255*R.r<<8|255*R.g,255*R.b<<8|51*k)}}needsEvaluation(){return!this.colorBufferUploaded}updateReplacement(e,i,o){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;const l=i.getReplacementRegionsForTile(e.toUnwrapped());if(xy(this.activeReplacements,l))return;this.activeReplacements=l;for(const f of this.footprints)f.hiddenFlags&=-2;const d=[];for(const f of this.activeReplacements){if(f.order<=WT)continue;const _=Math.max(1,Math.pow(2,f.footprintTileId.canonical.z-e.canonical.z));for(const v of this.footprints)v.min.x>f.max.x||v.max.x<f.min.x||v.min.y>f.max.y||v.max.y<f.min.y||(d.length=0,$R(this.footprintsVertices,v.footprintVertexOffset,v.footprintVertexLength,f.footprintTileId.canonical,e.canonical,d),Sx(f.footprint,d,this.footprintsIndices.uint16,v.footprintIndexOffset,v.footprintIndexLength,0,-_)&&(v.hiddenFlags|=1))}this.groundEffect.hiddenByLandmarkVertexArray.length===0&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const f of this.footprints)this.groundEffect.updateHiddenByLandmarkRange(f.groundEffectVertexOffset,f.groundEffectVertexLength,f.hiddenFlags!==0);this.indexArrayForConflationUploaded=!1}getFootprint(e){if(e.id!==void 0){const i=this.featureFootprintLookup.get(e.id);return this.footprints[i]}return null}getHeightAtTileCoord(e,i){let o=Number.NEGATIVE_INFINITY,l=!0;const d=4*(e+dt)*dt+(i+dt);if(this.footprintLookup.hasOwnProperty(d)){const _=this.footprintLookup[d];return _?{height:_.height,hidden:_.hiddenFlags!==0}:void 0}const f=new et(e,i);for(const _ of this.footprints)e>_.max.x||_.min.x>e||i>_.max.y||_.min.y>i||_.height<=o||VR(f,this.footprintsVertices.float32.subarray(2*_.footprintVertexOffset,2*(_.footprintVertexOffset+_.footprintVertexLength)),this.footprintsIndices.uint16.subarray(_.footprintIndexOffset,_.footprintIndexOffset+_.footprintIndexLength))&&(o=_.height,this.footprintLookup[d]=_,l=_.hiddenFlags!==0);if(o!==Number.NEGATIVE_INFINITY)return{height:o,hidden:l};this.footprintLookup[d]=void 0}}function VR(n,e,i){for(let o=0;o<i.length;o+=3){const l=i[o],d=i[o+1],f=i[o+2],_=e[2*l+0],v=e[2*l+1],b=e[2*d+0],E=e[2*d+1],I=e[2*f+0],C=e[2*f+1],R=(_-I)*(n.y-C)-(v-C)*(n.x-I),k=(b-_)*(n.y-v)-(E-v)*(n.x-_);if(R<0!=k<0&&R!==0&&k!==0)continue;const F=(I-b)*(n.y-E)-(C-E)*(n.x-b);if(F===0||F<0==R+k<=0)return!0}return!1}function $R(n,e,i,o,l,d){const f=Math.pow(2,o.z-l.z);for(let _=0;_<i;_++){let v=n.float32[2*(_+e)+0],b=n.float32[2*(_+e)+1];v=(v+l.x*dt)*f-o.x*dt,b=(b+l.y*dt)*f-o.y*dt,d.push(new et(v,b))}}let WS,ZS;It(qS,"BuildingBucket",{omit:["layers"]}),It(Hx,"BuildingGeometry"),It(Gx,"BuildingBloomGeometry");const GR=_i([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),HR=_i([{name:"a_z_offset_width",components:3,type:"Float32"}],4),{members:qR}=GR,WR=_i([{name:"a_packed",components:3,type:"Float32"}]),{members:ZR}=WR,XR=_i([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:KR}=XR;class XS{constructor(e,i){this.width=e,this.height=i,this.nextRow=0,this.image=new Hc({width:e,height:i}),this.positions={},this.uploaded=!1}getDash(e,i){const o=this.getKey(e,i);return this.positions[o]}trim(){const e=this.width,i=this.height=Le(this.nextRow);this.image.resize({width:e,height:i})}getKey(e,i){return e.join(",")+i}getDashRanges(e,i,o){const l=[];let d=e.length%2==1?-e[e.length-1]*o:0,f=e[0]*o,_=!0;l.push({left:d,right:f,isDash:_,zeroLength:e[0]===0});let v=e[0];for(let b=1;b<e.length;b++){_=!_;const E=e[b];d=v*o,v+=E,f=v*o,l.push({left:d,right:f,isDash:_,zeroLength:E===0})}return l}addRoundDash(e,i,o){const l=i/2;for(let d=-o;d<=o;d++){const f=this.width*(this.nextRow+o+d);let _=0,v=e[_];for(let b=0;b<this.width;b++){b/v.right>1&&(v=e[++_]);const E=Math.abs(b-v.left),I=Math.abs(b-v.right),C=Math.min(E,I);let R;const k=d/o*(l+1);if(v.isDash){const F=l-Math.abs(k);R=Math.sqrt(C*C+F*F)}else R=l-Math.sqrt(C*C+k*k);this.image.data[f+b]=Math.max(0,Math.min(255,R+128))}}}addRegularDash(e,i){for(let v=e.length-1;v>=0;--v){const b=e[v],E=e[v+1];b.zeroLength?e.splice(v,1):E&&E.isDash===b.isDash&&(E.left=b.left,e.splice(v,1))}const o=e[0],l=e[e.length-1];o.isDash===l.isDash&&(o.left=l.left-this.width,l.right=o.right+this.width);const d=this.width*this.nextRow;let f=0,_=e[f];for(let v=0;v<this.width;v++){v/_.right>1&&(_=e[++f]);const b=Math.abs(v-_.left),E=Math.abs(v-_.right),I=Math.min(b,E);this.image.data[d+v]=Math.max(0,Math.min(255,(_.isDash?I:-I)+i+128))}}addDash(e,i){const o=this.getKey(e,i);if(this.positions[o])return this.positions[o];const l=i==="round",d=l?7:0,f=2*d+1;if(this.nextRow+f>this.height)return bt("LineAtlas out of space"),null;e.length===0&&e.push(1);let _=0;for(let E=0;E<e.length;E++)e[E]<0&&(bt("Negative value is found in line dasharray, replacing values with 0"),e[E]=0),_+=e[E];if(_!==0){const E=this.width/_,I=this.getDashRanges(e,this.width,E);l?this.addRoundDash(I,E,d):this.addRegularDash(I,i==="square"?.5*E:0)}const v=this.nextRow+d;this.nextRow+=f;const b={tl:[v,d],br:[_,0]};return this.positions[o]=b,b}}It(XS,"LineAtlas");const YR=ye.types,JR=Math.cos(Math.PI/180*37.5),QR=Math.cos(Math.PI/180*5);class qx{constructor(e){this.evaluationGlobals={zoom:0,lineProgress:void 0},this.elevationType="none",this.zoom=e.zoom,this.evaluationGlobals.zoom=this.zoom,this.overscaling=e.overscaling,this.pixelRatio=e.pixelRatio,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.projection=e.projection,this.hasPattern=!1,this.hasCrossSlope=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(i=>{this.gradients[i.id]={}}),this.layoutVertexArray=new Bd,this.layoutVertexArray2=new Fo,this.patternVertexArray=new Fo,this.indexArray=new sr,this.programConfigurations=new ws(e.layers,{zoom:e.zoom,lut:e.lut}),this.segments=new An,this.maxLineLength=0,this.zOffsetVertexArray=new Fo,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.tessellationStep=e.tessellationStep?e.tessellationStep:dt/64,this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,i){}updateAppearances(e,i,o,l){}populate(e,i,o,l){this.hasPattern=yx("line",this.layers,this.pixelRatio,i);const d=this.layers[0].layout.get("line-sort-key");this.tileToMeter=$(o);const f=this.layers[0].layout.get("line-elevation-reference");if(f==="hd-road-markup")this.elevationType="road";else{const C=this.layers[0].layout.get("line-z-offset"),R=C.isConstant()&&!C.constantOr(0);this.elevationType=f!=="sea"&&f!=="ground"&&R?"none":"offset",this.elevationType==="offset"&&f==="none"&&bt(`line-elevation-reference: ground is used for the layer ${this.layerIds[0]} because non-zero line-z-offset value was found.`)}const _=this.layers[0].layout.get("line-cross-slope");this.hasCrossSlope=this.elevationType==="offset"&&_!==void 0;const v=[];for(const{feature:C,id:R,index:k,sourceLayerIndex:F}of e){const U=this.layers[0]._featureFilter.needGeometry,j=we(C,U);if(!this.layers[0]._featureFilter.filter(new fn(this.zoom,{worldview:this.worldview,activeFloors:i.activeFloors}),j,o))continue;const H=d?d.evaluate(j,{},o):void 0,W={id:R,properties:C.properties,type:C.type,sourceLayerIndex:F,index:k,geometry:U?j.geometry:he(C,o,l),patterns:{},sortKey:H};v.push(W)}d&&v.sort((C,R)=>C.sortKey-R.sortKey);const{lineAtlas:b,featureIndex:E}=i,I=this.addConstantDashes(b);for(const C of v){const{geometry:R,index:k,sourceLayerIndex:F}=C;if(I&&this.addFeatureDashes(C,b),this.hasPattern){const U=vx("line",this.layers,C,this.zoom,this.pixelRatio,i);this.patternFeatures.push(U)}else this.addFeature(C,R,k,o,b.positions,i.availableImages,i.brightness,i.elevationFeatures);E.insert(e[k].feature,R,k,F,this.index)}}addConstantDashes(e){let i=!1;for(const o of this.layers){const l=o.paint.get("line-dasharray").value,d=o.layout.get("line-cap").value;if(l.kind!=="constant"||d.kind!=="constant")i=!0;else{const f=d.value,_=l.value;if(!_)continue;e.addDash(_,f)}}return i}addFeatureDashes(e,i){const o=this.zoom;for(const l of this.layers){const d=l.paint.get("line-dasharray").value,f=l.layout.get("line-cap").value;if(d.kind==="constant"&&f.kind==="constant")continue;let _,v;if(d.kind==="constant"){if(_=d.value,!_)continue}else _=d.evaluate({zoom:o},e);v=f.kind==="constant"?f.value:f.evaluate({zoom:o},e),i.addDash(_,v),e.patterns[l.id]=[i.getKey(_,v)]}}update(e,i,o,l,d,f,_,v){this.programConfigurations.updatePaintArrays(e,i,d,o,l,f,_,v)}addFeatures(e,i,o,l,d,f){for(const _ of this.patternFeatures)this.addFeature(_,_.geometry,_.index,i,o,l,f,e.elevationFeatures)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,ZR)),this.patternVertexArray.length!==0&&(this.patternVertexBuffer=e.createVertexBuffer(this.patternVertexArray,KR)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,HR.members,!0)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,qR),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(e,i){let o,l;if(i&&i>0?(o=`mapbox_clip_start_${i}`,l=`mapbox_clip_end_${i}`):(o="mapbox_clip_start",l="mapbox_clip_end"),e.properties&&e.properties.hasOwnProperty(o)&&e.properties.hasOwnProperty(l))return{start:+e.properties[o],end:+e.properties[l]}}addFeature(e,i,o,l,d,f,_,v){const b=this.layers[0].layout,E=b.get("line-join").evaluate(e,{}),I=b.get("line-cap").evaluate(e,{}),C=b.get("line-miter-limit"),R=b.get("line-round-limit");this.lineClips=this.lineFeatureClips(e),this.lineFeature=e;const k=!(!e.properties||!e.properties.hasOwnProperty("mapbox_line_metrics"))&&e.properties.mapbox_line_metrics;this.zOffsetValue=b.get("line-z-offset").value;const F=this.layers[0].paint.get("line-width").value;if(F.kind!=="constant"&&F.isLineProgressConstant===!1&&(this.variableWidthValue=F),this.elevationType==="road"){const U=this.layoutVertexArray.length;if(!this.addElevatedRoadFeature(e,i,l,v,E,I,C,R)){const[j,H]=this.clipRuntimeLinesToTile(i,1);for(let W=0;W<j.length;W++){const Y=j[W],se=H[W],ie={progress:{min:se.progress.min,max:se.progress.max},nextDir:this.computeSegNextDir(se,Y),prevDir:this.computeSegPrevDir(se,Y)};this.addLine(Y,e,l,E,I,C,R,ie,k&&se.parentIndex>0?se.parentIndex:null)}this.fillNonElevatedRoadSegment(U)}}else for(let U=0;U<i.length;U++)this.addLine(i[U],e,l,E,I,C,R,void 0,k&&U>0?U:null);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,o,d,f,l,_,void 0,this.worldview)}computeSegNextDir(e,i){return e.nextPoint.sub(i.at(-2)).unit()}computeSegPrevDir(e,i){return i[1].sub(e.prevPoint).unit()}clipLinesToTile(e,i){return Ty(e,-i,-i,dt+i,dt+i)}clipRuntimeLinesToTile(e,i){const o=[];return[Ty(e,-i,-i,dt+i,dt+i,o),o]}addElevatedRoadFeature(e,i,o,l,d,f,_,v){const b=[],E=Gi.getElevationFeature(e,l);if(E){const I=this.clipLinesToTile(i,1),C=this.prepareElevatedLines(I,E,o);for(const R of C)b.push({geometry:R,elevation:E,elevationTileID:o,segment:{progress:{min:0,max:1},nextDir:void 0,prevDir:void 0}})}if(b.length===0)return!1;for(const I of b){const C=this.layoutVertexArray.length;this.addLine(I.geometry,e,o,d,f,_,v);const R=new Qi(o,I.elevationTileID);if(I.elevation)for(let k=C;k<this.layoutVertexArray.length;k++){const F=new et(this.layoutVertexArray.int16[6*k]>>1,this.layoutVertexArray.int16[6*k+1]>>1),U=R.pointElevation(F,I.elevation,.05);this.updateHeightRange(U),this.zOffsetVertexArray.emplaceBack(U,0,0)}else this.fillNonElevatedRoadSegment(C)}return!0}prepareElevatedLines(e,i,o){if(i.constantHeight!=null)return e;const l=[],d=1/$(o);for(const f of e)cR(f,new Fi(i,d),0,l);return l}fillNonElevatedRoadSegment(e){for(let i=e;i<this.layoutVertexArray.length;i++)this.zOffsetVertexArray.emplaceBack(0,0,0)}updateHeightRange(e){this.heightRange?(this.heightRange.min=Math.min(this.heightRange.min,e),this.heightRange.max=Math.max(this.heightRange.max,e)):this.heightRange={min:e,max:e}}addLine(e,i,o,l,d,f,_,v,b){this.distance=0,this.prevDistance=0,this.scaledDistance=0,this.totalDistance=0,this.totalFeatureLength=0,this.lineSoFar=0,this.currentVertex=void 0,this.lineClips=b?this.lineFeatureClips(i,b):this.lineClips;const E=l==="none";this.patternJoinNone=this.hasPattern&&E,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[];const I=v&&v.progress.min>0,C=v&&v.progress.max<1;if(this.lineClips){let ge={min:this.lineClips.start,max:this.lineClips.end},Fe=1;if(v){const He=this.lineClips.end-this.lineClips.start;ge=function(qe,tt,nt){return{min:an(qe.min,tt,nt),max:an(qe.max,tt,nt)}}(v.progress,{min:0,max:1},ge),He>0&&(Fe=(ge.max-ge.min)/He)}const be=+i.properties.mapbox_clip_feature_len,Ue=+i.properties.mapbox_clip_seg_len;if(Number.isNaN(be)||Number.isNaN(Ue)){for(let qe=0;qe<e.length-1;qe++)this.totalDistance+=e[qe].dist(e[qe+1]);const He=this.totalDistance/(ge.max-ge.min);this.totalFeatureLength=Number.isFinite(He)?He:0,this.lineClips.start=ge.min,this.lineClips.end=ge.max,this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}else this.totalFeatureLength=be,this.distance=Ue*Fe,this.lineClips.start=ge.min,this.lineClips.end=ge.max,this.maxLineLength=Math.max(this.maxLineLength,this.distance);this.lineClipsArray.push(this.lineClips),this.updateScaledDistance()}const R=YR[i.type]==="Polygon";let k=e.length;for(;k>=2&&e[k-1].equals(e[k-2]);)k--;let F=0;for(;F<k-1&&e[F].equals(e[F+1]);)F++;if(k<(R?3:2))return;l==="bevel"&&(f=1.05);const U=this.segments.prepareSegment(10*k,this.layoutVertexArray,this.indexArray);let j,H,W,Y,se,ie,ce,fe;v&&v.prevDir&&(ie=v.prevDir.perp()),v&&v.nextDir&&(ce=v.nextDir.perp()),this.e1=this.e2=-1,R&&(j=e[k-2],se=e[F].sub(j)._unit()._perp());for(let ge=F;ge<k;ge++){if(W=ge===k-1?R?e[F+1]:void 0:e[ge+1],W&&e[ge].equals(W))continue;se&&(Y=se),j&&(H=j),j=e[ge],fe=this.evaluateLineProgressFeatures(H?H.dist(j):0),se=W?W.sub(j)._unit()._perp():Y,Y=Y||se;const Fe=H&&W;let be=Fe?l:R||E?"butt":d;const Ue=Y.x*se.x+Y.y*se.y;if(E){const Be=function(Qe){if(Qe.patternJoinNone){const ft=Qe.segmentPoints.length/2,at=Qe.lineSoFar-Qe.segmentStart;for(let Ot=0;Ot<ft;++Ot){const xt=Qe.segmentPoints[2*Ot+1],St=Math.round(Qe.segmentPoints[2*Ot])+.5+.25*xt;Qe.patternVertexArray.emplaceBack(St,at,Qe.segmentStart),Qe.patternVertexArray.emplaceBack(St,at,Qe.segmentStart)}Qe.segmentPoints.length=0}Qe.e1=Qe.e2=-1};if(Fe&&Ue<QR){this.updateDistance(H,j),this.addCurrentVertex(j,Y,1,1,U,fe),Be(this),this.addCurrentVertex(j,se,-1,-1,U,fe);continue}if(H){if(!W){this.updateDistance(H,j),this.addCurrentVertex(j,Y,1,1,U,fe),Be(this);continue}be="miter"}}let He=Y.add(se);He.x===0&&He.y===0||He._unit();const qe=He.x*se.x+He.y*se.y,tt=qe!==0?1/qe:1/0,nt=2*Math.sqrt(2-2*qe),Ye=qe<JR&&H&&W,Je=Y.x*se.y-Y.y*se.x>0,je=this.overscaling<=16?15*dt/(512*this.overscaling):0;if(Fe&&be==="round"){if(tt<_)be="miter";else if(tt<=2){const Be=Wx(j,-10,dt+10);be=this.elevationType==="offset"&&(Be||this.hasCrossSlope)?"miter":"fakeround"}}if(be==="miter"&&tt>f&&(be="bevel"),be==="bevel"&&(tt>2&&(be="flipbevel"),tt<f&&(be="miter")),H&&!(be==="miter"&&Ye)&&this.updateDistance(H,j),be==="miter")if(Ye){const Be=j.dist(H);if(Be>2*je){const ft=j.sub(j.sub(H)._mult(je/Be)._round());this.updateDistance(H,ft),this.addCurrentVertex(ft,Y,0,0,U,fe),H=ft}this.updateDistance(H,j),He._mult(tt),this.addCurrentVertex(j,He,0,0,U,fe);const Qe=j.dist(W);if(Qe>2*je){const ft=j.add(W.sub(j)._mult(je/Qe)._round());this.updateDistance(j,ft),this.addCurrentVertex(ft,se,0,0,U,fe),j=ft}}else He._mult(tt),this.addCurrentVertex(j,He,0,0,U,fe);else if(be==="flipbevel"){if(tt>100)He=se.mult(-1);else{const Be=tt*Y.add(se).mag()/Y.sub(se).mag();He._perp()._mult(Be*(Je?-1:1))}this.addCurrentVertex(j,He,0,0,U,fe),this.addCurrentVertex(j,He.mult(-1),0,0,U,fe)}else if(be==="bevel"||be==="fakeround"){fe!=null&&H&&this.addCurrentVertex(j,ce||Y,-1,-1,U,fe);const Be=j.dist(H)<=2*je&&be!=="bevel",Qe=He.mult(Je?1:-1);Qe._mult(tt);const ft=se.mult(Je?-1:1),at=Y.mult(Je?-1:1),Ot=this.evaluateLineProgressFeatures(this.distance);if(fe==null&&(this.addHalfVertex(j,Qe.x,Qe.y,!1,!Je,0,U,Ot),Be||this.addHalfVertex(j,Qe.x+2*at.x,Qe.y+2*at.y,!1,Je,0,U,Ot)),be==="fakeround"){const xt=Math.round(180*nt/Math.PI/20);this.addHalfVertex(j,at.x,at.y,!1,Je,0,U,Ot);for(let St=0;St<xt;St++){let Pt=St/xt;if(Pt!==.5){const lt=Pt-.5;Pt+=Pt*lt*(Pt-1)*((1.0904+Ue*(Ue*(3.55645-1.43519*Ue)-3.2452))*lt*lt+(.848013+Ue*(.215638*Ue-1.06021)))}const pi=ft.sub(at)._mult(Pt)._add(at)._unit();this.addHalfVertex(j,pi.x,pi.y,!1,Je,0,U,Ot)}this.addHalfVertex(j,ft.x,ft.y,!1,Je,0,U,Ot)}Be||fe!=null||this.addHalfVertex(j,Qe.x+2*ft.x,Qe.y+2*ft.y,!1,Je,0,U,Ot),fe!=null&&W&&this.addCurrentVertex(j,ie||se,1,1,U,fe)}else if(be==="butt")this.addCurrentVertex(j,He,0,0,U,fe);else if(be==="square"){if(!H){const Be=I?0:-1;this.addCurrentVertex(j,He,Be,Be,U,fe)}if(this.addCurrentVertex(j,He,0,0,U,fe),H){const Be=C?0:1;this.addCurrentVertex(j,He,Be,Be,U,fe)}}else if(be==="round"){if(H){const Be=!Fe&&ce?ce:Y;this.addCurrentVertex(j,Be,0,0,U,fe),!Fe&&C||this.addCurrentVertex(j,Be,1,1,U,fe,!0)}if(W){const Be=!Fe&&ie?ie:se;!Fe&&I||this.addCurrentVertex(j,Be,-1,-1,U,fe,!0),this.addCurrentVertex(j,Be,0,0,U,fe)}}}}addVerticesTo(e,i,o,l,d,f,_,v,b,E){const I=(i.w-e.w)/this.tessellationStep|0;let C=0;const R=this.scaledDistance;if(I>1){this.lineSoFar=e.w;const F=(i.x-e.x)/I,U=(i.y-e.y)/I,j=(i.z-e.z)/I,H=(i.w-e.w)/I;for(let W=1;W<I;++W){e.x+=F,e.y+=U,e.z+=j,this.lineSoFar+=H,C+=H;const Y=this.evaluateLineProgressFeatures(this.prevDistance+C);this.scaledDistance=(this.prevDistance+C)/this.totalDistance,this.addHalfVertex(e,o,l,E,!1,_,b,Y),this.addHalfVertex(e,d,f,E,!0,-v,b,Y)}}this.lineSoFar=i.w,this.scaledDistance=R;const k=this.evaluateLineProgressFeatures(this.distance);this.addHalfVertex(i,o,l,E,!1,_,b,k),this.addHalfVertex(i,d,f,E,!0,-v,b,k)}evaluateLineProgressFeatures(e){if(!this.variableWidthValue&&this.elevationType!=="offset")return null;this.evaluationGlobals.lineProgress=0,this.lineClips?this.evaluationGlobals.lineProgress=Math.min(1,(this.totalFeatureLength*this.lineClips.start+e)/this.totalFeatureLength):bt(`line-progress evaluation for ${this.layerIds[0]} requires enabling 'lineMetrics' for the source.`);let i=0;return this.variableWidthValue&&this.variableWidthValue.kind!=="constant"&&(i=this.variableWidthValue.evaluate(this.evaluationGlobals,this.lineFeature)||0),this.elevationType!=="offset"?{zOffset:0,variableWidth:i}:this.zOffsetValue.kind==="constant"?{zOffset:this.zOffsetValue.value,variableWidth:i}:{zOffset:this.zOffsetValue.evaluate(this.evaluationGlobals,this.lineFeature)||0,variableWidth:i}}addCurrentVertex(e,i,o,l,d,f,_=!1){const v=i.x+i.y*o,b=i.y-i.x*o,E=i.y*l-i.x,I=-i.y-i.x*l;if(f!=null){const C=this.elevationType==="offset",R=-10,k=dt+10,F=f.zOffset,U=new gS(e.x,e.y,F,this.lineSoFar),j=!!C&&Wx(e,R,k),H=this.lineSoFar,W=this.distance;if(this.currentVertex)if(j){const Y=this.currentVertexIsOutside,se=this.currentVertex,ie=new gS(e.x,e.y,F,this.lineSoFar);if(vS(se,ie,R,k),!Wx(ie,R,k)){if(Y){this.e1=this.e2=-1,this.distance-=se.dist(U),this.lineSoFar=se.w;const ce=this.evaluateLineProgressFeatures(se.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(se,v,b,_,!1,o,d,ce),this.addHalfVertex(se,E,I,_,!0,-l,d,ce),this.prevDistance=this.distance}this.distance=this.prevDistance+se.dist(ie),this.scaledDistance=this.distance/this.totalDistance,this.addVerticesTo(se,ie,v,b,E,I,o,l,d,_),this.distance=W,this.scaledDistance=this.distance/this.totalDistance}}else{const Y=this.currentVertex;if(this.currentVertexIsOutside){vS(Y,U,R,k),this.e1=this.e2=-1,this.distance-=Y.dist(U),this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=Y.w;const se=this.evaluateLineProgressFeatures(Y.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(Y,v,b,_,!1,o,d,se),this.addHalfVertex(Y,E,I,_,!0,-l,d,se),this.prevDistance=this.distance,this.distance=W,this.scaledDistance=this.distance/this.totalDistance}this.addVerticesTo(Y,U,v,b,E,I,o,l,d,_)}else j||(this.addHalfVertex(e,v,b,_,!1,o,d,f),this.addHalfVertex(e,E,I,_,!0,-l,d,f));this.currentVertex=U,this.currentVertexIsOutside=j,this.lineSoFar=H}else this.addHalfVertex(e,v,b,_,!1,o,d,f),this.addHalfVertex(e,E,I,_,!0,-l,d,f)}addHalfVertex({x:e,y:i},o,l,d,f,_,v,b){if(this.patternJoinNone&&(this.segmentPoints.length===0&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),f||this.segmentPoints.push(this.lineSoFar-this.segmentStart,_)),this.layoutVertexArray.emplaceBack((e<<1)+(d?1:0),(i<<1)+(f?1:0),Math.round(63*o)+128,Math.round(63*l)+128,1+(_===0?0:_<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips){const I=Kt(this.lineClips.start,this.lineClips.end,this.scaledDistance);this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,I)}const E=v.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,E),v.primitiveLength++),f?this.e2=E:this.e1=E,b!=null&&this.zOffsetVertexArray.emplaceBack(b.zOffset,b.variableWidth,b.variableWidth)}updateScaledDistance(){this.lineClips?(this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=this.totalFeatureLength*this.lineClips.start+this.distance):this.lineSoFar=this.distance}updateDistance(e,i){this.prevDistance=this.distance,this.distance+=e.dist(i),this.updateScaledDistance()}}function Wx(n,e,i){return n.x<e||n.x>i||n.y<e||n.y>i}let KS,YS;function JS(n,e,i){return e*(dt/(n.tileSize*Math.pow(2,i-n.tileID.overscaledZ)))}It(qx,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});const QS=(n,e,i)=>(1-i)*n+i*e;function e2(n,e){return 1/JS(n,1,e.tileZoom)}function t2(n,e,i,o){return n.translatePosMatrix(o||e.tileID.projMatrix,e,i.paint.get("line-translate"),i.paint.get("line-translate-anchor"))}const i2=n=>{const e=[];n2(n)&&e.push("RENDER_LINE_DASH"),n.paint.get("line-gradient")&&e.push("RENDER_LINE_GRADIENT");const i=n.paint.get("line-trim-offset");i[0]===0&&i[1]===0||e.push("RENDER_LINE_TRIM_OFFSET"),n.paint.get("line-border-width").constantOr(1)!==0&&e.push("RENDER_LINE_BORDER");const o=n.layout.get("line-join").constantOr("miter")==="none",l=!!n.paint.get("line-pattern").constantOr(1);return o&&l&&e.push("LINE_JOIN_NONE"),e};function n2(n){const e=n.paint.get("line-dasharray").value;return e.kind!=="constant"||e.value}let Zx;const r2=()=>Zx||(Zx={layout:KS||(KS=new Bn({"line-cap":new _t(Se.layout_line["line-cap"]),"line-join":new _t(Se.layout_line["line-join"]),"line-miter-limit":new ut(Se.layout_line["line-miter-limit"]),"line-round-limit":new ut(Se.layout_line["line-round-limit"]),"line-sort-key":new _t(Se.layout_line["line-sort-key"]),"line-z-offset":new _t(Se.layout_line["line-z-offset"]),"line-elevation-reference":new ut(Se.layout_line["line-elevation-reference"]),"line-cross-slope":new ut(Se.layout_line["line-cross-slope"]),visibility:new ut(Se.layout_line.visibility),"line-width-unit":new ut(Se.layout_line["line-width-unit"])})),paint:YS||(YS=new Bn({"line-opacity":new _t(Se.paint_line["line-opacity"]),"line-color":new _t(Se.paint_line["line-color"]),"line-translate":new ut(Se.paint_line["line-translate"]),"line-translate-anchor":new ut(Se.paint_line["line-translate-anchor"]),"line-width":new _t(Se.paint_line["line-width"]),"line-gap-width":new _t(Se.paint_line["line-gap-width"]),"line-offset":new _t(Se.paint_line["line-offset"]),"line-blur":new _t(Se.paint_line["line-blur"]),"line-dasharray":new _t(Se.paint_line["line-dasharray"]),"line-pattern":new _t(Se.paint_line["line-pattern"]),"line-pattern-cross-fade":new ut(Se.paint_line["line-pattern-cross-fade"]),"line-gradient":new ql(Se.paint_line["line-gradient"]),"line-trim-offset":new ut(Se.paint_line["line-trim-offset"]),"line-trim-fade-range":new ut(Se.paint_line["line-trim-fade-range"]),"line-trim-color":new ut(Se.paint_line["line-trim-color"]),"line-emissive-strength":new _t(Se.paint_line["line-emissive-strength"]),"line-border-width":new _t(Se.paint_line["line-border-width"]),"line-border-color":new _t(Se.paint_line["line-border-color"]),"line-occlusion-opacity":new ut(Se.paint_line["line-occlusion-opacity"]),"line-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"line-gradient-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"line-trim-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"line-border-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},Zx);class ek extends _t{possiblyEvaluate(e,i){return i=new fn(Math.floor(i.zoom),{now:i.now,fadeDuration:i.fadeDuration,transition:i.transition,worldview:i.worldview}),super.possiblyEvaluate(e,i)}evaluate(e,i,o,l){return i=Object.assign({},i,{zoom:Math.floor(i.zoom)}),super.evaluate(e,i,o,l)}}let Bm;function o2(n,e){return e>0?e+2*n:n}const tk=_i([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),ik=_i([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),nk=_i([{name:"a_projected_pos",components:4,type:"Float32"}],4);_i([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const rk=_i([{name:"a_auto_z_offset",components:1,type:"Float32"}],4),ok=_i([{name:"a_x_axis",components:3,type:"Float32"},{name:"a_y_axis",components:3,type:"Float32"}]),sk=_i([{name:"a_texb",components:2,type:"Uint16"}]),ak=_i([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_elevation_from_sea",components:2,type:"Float32"}]),lk=_i([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_auto_z_offset",components:1,type:"Float32"}]);_i([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const s2=_i([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),ck=_i([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);_i([{name:"triangle",components:3,type:"Uint16"}]),_i([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),_i([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"},{type:"Uint16",name:"elevationFeatureIndex"}]),_i([{type:"Float32",name:"offsetX"}]),_i([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var br=24;function uk(n,e,i){return n.sections.forEach(o=>{o.text=function(l,d,f){const _=d.layout.get("text-transform").evaluate(f,{});return _==="uppercase"?l=l.toLocaleUpperCase():_==="lowercase"&&(l=l.toLocaleLowerCase()),ma.applyArabicShaping&&(l=ma.applyArabicShaping(l)),l}(o.text,e,i)}),n}const Nm={"!":"","#":"",$:"","%":"","&":"","(":"",")":"","*":"","+":"",",":"","-":"",".":"","/":"",":":"",";":"","<":"","=":"",">":"","?":"","@":"","[":"","\\":"","]":"","^":"",_:"","`":"","{":"","|":"","}":"","~":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""};function hk(n){return n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""}function dk(n){return n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""}const Xx=4294967296,a2=1/Xx,l2=typeof TextDecoder>"u"?null:new TextDecoder("utf-8");let zy=class{constructor(n=new Uint8Array(16)){this.buf=ArrayBuffer.isView(n)?n:new Uint8Array(n),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(n,e,i=this.length){for(;this.pos<i;){const o=this.readVarint(),l=o>>3,d=this.pos;this.type=7&o,n(l,e,this),this.pos===d&&this.skip(o)}return e}readMessage(n,e){return this.readFields(n,e,this.readVarint()+this.pos)}readFixed32(){const n=this.dataView.getUint32(this.pos,!0);return this.pos+=4,n}readSFixed32(){const n=this.dataView.getInt32(this.pos,!0);return this.pos+=4,n}readFixed64(){const n=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*Xx;return this.pos+=8,n}readSFixed64(){const n=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*Xx;return this.pos+=8,n}readFloat(){const n=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,n}readDouble(){const n=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,n}readVarint(n){const e=this.buf;let i,o;return o=e[this.pos++],i=127&o,o<128?i:(o=e[this.pos++],i|=(127&o)<<7,o<128?i:(o=e[this.pos++],i|=(127&o)<<14,o<128?i:(o=e[this.pos++],i|=(127&o)<<21,o<128?i:(o=e[this.pos],i|=(15&o)<<28,function(l,d,f){const _=f.buf;let v,b;if(b=_[f.pos++],v=(112&b)>>4,b<128||(b=_[f.pos++],v|=(127&b)<<3,b<128)||(b=_[f.pos++],v|=(127&b)<<10,b<128)||(b=_[f.pos++],v|=(127&b)<<17,b<128)||(b=_[f.pos++],v|=(127&b)<<24,b<128)||(b=_[f.pos++],v|=(1&b)<<31,b<128))return hf(l,v,d);throw new Error("Expected varint not more than 10 bytes")}(i,n,this)))))}readVarint64(){return this.readVarint(!0)}readSVarint(){const n=this.readVarint();return n%2==1?(n+1)/-2:n/2}readBoolean(){return!!this.readVarint()}readString(){const n=this.readVarint()+this.pos,e=this.pos;return this.pos=n,n-e>=12&&l2?l2.decode(this.buf.subarray(e,n)):function(i,o,l){let d="",f=o;for(;f<l;){const _=i[f];let v,b,E,I=null,C=_>239?4:_>223?3:_>191?2:1;if(f+C>l)break;C===1?_<128&&(I=_):C===2?(v=i[f+1],(192&v)==128&&(I=(31&_)<<6|63&v,I<=127&&(I=null))):C===3?(v=i[f+1],b=i[f+2],(192&v)==128&&(192&b)==128&&(I=(15&_)<<12|(63&v)<<6|63&b,(I<=2047||I>=55296&&I<=57343)&&(I=null))):C===4&&(v=i[f+1],b=i[f+2],E=i[f+3],(192&v)==128&&(192&b)==128&&(192&E)==128&&(I=(15&_)<<18|(63&v)<<12|(63&b)<<6|63&E,(I<=65535||I>=1114112)&&(I=null))),I===null?(I=65533,C=1):I>65535&&(I-=65536,d+=String.fromCharCode(I>>>10&1023|55296),I=56320|1023&I),d+=String.fromCharCode(I),f+=C}return d}(this.buf,e,n)}readBytes(){const n=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,n);return this.pos=n,e}readPackedVarint(n=[],e){const i=this.readPackedEnd();for(;this.pos<i;)n.push(this.readVarint(e));return n}readPackedSVarint(n=[]){const e=this.readPackedEnd();for(;this.pos<e;)n.push(this.readSVarint());return n}readPackedBoolean(n=[]){const e=this.readPackedEnd();for(;this.pos<e;)n.push(this.readBoolean());return n}readPackedFloat(n=[]){const e=this.readPackedEnd();for(;this.pos<e;)n.push(this.readFloat());return n}readPackedDouble(n=[]){const e=this.readPackedEnd();for(;this.pos<e;)n.push(this.readDouble());return n}readPackedFixed32(n=[]){const e=this.readPackedEnd();for(;this.pos<e;)n.push(this.readFixed32());return n}readPackedSFixed32(n=[]){const e=this.readPackedEnd();for(;this.pos<e;)n.push(this.readSFixed32());return n}readPackedFixed64(n=[]){const e=this.readPackedEnd();for(;this.pos<e;)n.push(this.readFixed64());return n}readPackedSFixed64(n=[]){const e=this.readPackedEnd();for(;this.pos<e;)n.push(this.readSFixed64());return n}readPackedEnd(){return this.type===2?this.readVarint()+this.pos:this.pos+1}skip(n){const e=7&n;if(e===0)for(;this.buf[this.pos++]>127;);else if(e===2)this.pos=this.readVarint()+this.pos;else if(e===5)this.pos+=4;else{if(e!==1)throw new Error(`Unimplemented type: ${e}`);this.pos+=8}}writeTag(n,e){this.writeVarint(n<<3|e)}realloc(n){let e=this.length||16;for(;e<this.pos+n;)e*=2;if(e!==this.length){const i=new Uint8Array(e);i.set(this.buf),this.buf=i,this.dataView=new DataView(i.buffer),this.length=e}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(n){this.realloc(4),this.dataView.setInt32(this.pos,n,!0),this.pos+=4}writeSFixed32(n){this.realloc(4),this.dataView.setInt32(this.pos,n,!0),this.pos+=4}writeFixed64(n){this.realloc(8),this.dataView.setInt32(this.pos,-1&n,!0),this.dataView.setInt32(this.pos+4,Math.floor(n*a2),!0),this.pos+=8}writeSFixed64(n){this.realloc(8),this.dataView.setInt32(this.pos,-1&n,!0),this.dataView.setInt32(this.pos+4,Math.floor(n*a2),!0),this.pos+=8}writeVarint(n){(n=+n||0)>268435455||n<0?function(e,i){let o,l;if(e>=0?(o=e%4294967296|0,l=e/4294967296|0):(o=~(-e%4294967296),l=~(-e/4294967296),4294967295^o?o=o+1|0:(o=0,l=l+1|0)),e>=18446744073709552e3||e<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");i.realloc(10),function(d,f,_){_.buf[_.pos++]=127&d|128,d>>>=7,_.buf[_.pos++]=127&d|128,d>>>=7,_.buf[_.pos++]=127&d|128,d>>>=7,_.buf[_.pos++]=127&d|128,_.buf[_.pos]=127&(d>>>=7)}(o,0,i),function(d,f){const _=(7&d)<<4;f.buf[f.pos++]|=_|((d>>>=3)?128:0),d&&(f.buf[f.pos++]=127&d|((d>>>=7)?128:0),d&&(f.buf[f.pos++]=127&d|((d>>>=7)?128:0),d&&(f.buf[f.pos++]=127&d|((d>>>=7)?128:0),d&&(f.buf[f.pos++]=127&d|((d>>>=7)?128:0),d&&(f.buf[f.pos++]=127&d)))))}(l,i)}(n,this):(this.realloc(4),this.buf[this.pos++]=127&n|(n>127?128:0),n<=127||(this.buf[this.pos++]=127&(n>>>=7)|(n>127?128:0),n<=127||(this.buf[this.pos++]=127&(n>>>=7)|(n>127?128:0),n<=127||(this.buf[this.pos++]=n>>>7&127))))}writeSVarint(n){this.writeVarint(n<0?2*-n-1:2*n)}writeBoolean(n){this.writeVarint(+n)}writeString(n){n=String(n),this.realloc(4*n.length),this.pos++;const e=this.pos;this.pos=function(o,l,d){for(let f,_,v=0;v<l.length;v++){if(f=l.charCodeAt(v),f>55295&&f<57344){if(!_){f>56319||v+1===l.length?(o[d++]=239,o[d++]=191,o[d++]=189):_=f;continue}if(f<56320){o[d++]=239,o[d++]=191,o[d++]=189,_=f;continue}f=_-55296<<10|f-56320|65536,_=null}else _&&(o[d++]=239,o[d++]=191,o[d++]=189,_=null);f<128?o[d++]=f:(f<2048?o[d++]=f>>6|192:(f<65536?o[d++]=f>>12|224:(o[d++]=f>>18|240,o[d++]=f>>12&63|128),o[d++]=f>>6&63|128),o[d++]=63&f|128)}return d}(this.buf,n,this.pos);const i=this.pos-e;i>=128&&c2(e,i,this),this.pos=e-1,this.writeVarint(i),this.pos+=i}writeFloat(n){this.realloc(4),this.dataView.setFloat32(this.pos,n,!0),this.pos+=4}writeDouble(n){this.realloc(8),this.dataView.setFloat64(this.pos,n,!0),this.pos+=8}writeBytes(n){const e=n.length;this.writeVarint(e),this.realloc(e);for(let i=0;i<e;i++)this.buf[this.pos++]=n[i]}writeRawMessage(n,e){this.pos++;const i=this.pos;n(e,this);const o=this.pos-i;o>=128&&c2(i,o,this),this.pos=i-1,this.writeVarint(o),this.pos+=o}writeMessage(n,e,i){this.writeTag(n,2),this.writeRawMessage(e,i)}writePackedVarint(n,e){e.length&&this.writeMessage(n,fk,e)}writePackedSVarint(n,e){e.length&&this.writeMessage(n,pk,e)}writePackedBoolean(n,e){e.length&&this.writeMessage(n,gk,e)}writePackedFloat(n,e){e.length&&this.writeMessage(n,mk,e)}writePackedDouble(n,e){e.length&&this.writeMessage(n,_k,e)}writePackedFixed32(n,e){e.length&&this.writeMessage(n,yk,e)}writePackedSFixed32(n,e){e.length&&this.writeMessage(n,vk,e)}writePackedFixed64(n,e){e.length&&this.writeMessage(n,xk,e)}writePackedSFixed64(n,e){e.length&&this.writeMessage(n,wk,e)}writeBytesField(n,e){this.writeTag(n,2),this.writeBytes(e)}writeFixed32Field(n,e){this.writeTag(n,5),this.writeFixed32(e)}writeSFixed32Field(n,e){this.writeTag(n,5),this.writeSFixed32(e)}writeFixed64Field(n,e){this.writeTag(n,1),this.writeFixed64(e)}writeSFixed64Field(n,e){this.writeTag(n,1),this.writeSFixed64(e)}writeVarintField(n,e){this.writeTag(n,0),this.writeVarint(e)}writeSVarintField(n,e){this.writeTag(n,0),this.writeSVarint(e)}writeStringField(n,e){this.writeTag(n,2),this.writeString(e)}writeFloatField(n,e){this.writeTag(n,5),this.writeFloat(e)}writeDoubleField(n,e){this.writeTag(n,1),this.writeDouble(e)}writeBooleanField(n,e){this.writeVarintField(n,+e)}};function hf(n,e,i){return i?4294967296*e+(n>>>0):4294967296*(e>>>0)+(n>>>0)}function c2(n,e,i){const o=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(7*Math.LN2));i.realloc(o);for(let l=i.pos-1;l>=n;l--)i.buf[l+o]=i.buf[l]}function fk(n,e){for(let i=0;i<n.length;i++)e.writeVarint(n[i])}function pk(n,e){for(let i=0;i<n.length;i++)e.writeSVarint(n[i])}function mk(n,e){for(let i=0;i<n.length;i++)e.writeFloat(n[i])}function _k(n,e){for(let i=0;i<n.length;i++)e.writeDouble(n[i])}function gk(n,e){for(let i=0;i<n.length;i++)e.writeBoolean(n[i])}function yk(n,e){for(let i=0;i<n.length;i++)e.writeFixed32(n[i])}function vk(n,e){for(let i=0;i<n.length;i++)e.writeSFixed32(n[i])}function xk(n,e){for(let i=0;i<n.length;i++)e.writeFixed64(n[i])}function wk(n,e){for(let i=0;i<n.length;i++)e.writeSFixed64(n[i])}const Kx=3;function bk(n,e,i){e.glyphs=[],n===1&&i.readMessage(Tk,e)}function Tk(n,e,i){if(n===3){const{id:o,bitmap:l,width:d,height:f,left:_,top:v,advance:b}=i.readMessage(Sk,{});e.glyphs.push({id:o,bitmap:new Hc({width:d+2*Kx,height:f+2*Kx},l),metrics:{width:d,height:f,left:_,top:v,advance:b}})}else n===4?e.ascender=i.readSVarint():n===5&&(e.descender=i.readSVarint())}function Sk(n,e,i){n===1?e.id=i.readVarint():n===2?e.bitmap=i.readBytes():n===3?e.width=i.readVarint():n===4?e.height=i.readVarint():n===5?e.left=i.readSVarint():n===6?e.top=i.readSVarint():n===7&&(e.advance=i.readVarint())}const u2=Kx,Uo={horizontal:1,vertical:2,horizontalOnly:3};class jm{constructor(){this.scale=1,this.fontStack="",this.image=null}static forText(e,i){const o=new jm;return o.scale=e||1,o.fontStack=i,o}static forImage(e){const i=new jm;return i.image=e,i}}class df{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(e,i,o){const l=new df;for(let d=0;d<e.sections.length;d++){const f=e.sections[d];f.image?l.addImageSection(f,o):l.addTextSection(f,i)}return l}length(){return this.text.length}getSection(e){return this.sections[this.sectionIndex[e]]}getSections(){return this.sections}getSectionIndex(e){return this.sectionIndex[e]}getCodePoint(e){return this.text.codePointAt(e)}verticalizePunctuation(e){this.text=function(i,o){let l="";for(let d=0;d<i.length;d++){const f=i.charCodeAt(d+1)||null,_=i.charCodeAt(d-1)||null;l+=!o&&(f&&Ad(f)&&!Nm[i[d+1]]||_&&Ad(_)&&!Nm[i[d-1]])||!Nm[i[d]]?i[d]:Nm[i[d]]}return l}(this.text,e)}trim(){let e=0;for(let o=0;o<this.text.length&&Dy[this.text.charCodeAt(o)];o++)e++;let i=this.text.length;for(let o=this.text.length-1;o>=0&&o>=e&&Dy[this.text.charCodeAt(o)];o--)i--;this.text=this.text.substring(e,i),this.sectionIndex=this.sectionIndex.slice(e,i)}substring(e,i){const o=new df;return o.text=this.text.substring(e,i),o.sectionIndex=this.sectionIndex.slice(e,i),o.sections=this.sections,o}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((e,i)=>Math.max(e,this.sections[i].scale),0)}addTextSection(e,i){this.text+=e.text,this.sections.push(jm.forText(e.scale,e.fontStack||i));const o=this.sections.length-1;for(let l=0;l<e.text.length;++l)this.sectionIndex.push(o)}addImageSection(e,i){const o=e.image?e.image.getPrimary():null;if(!o)return void bt("Can't add FormattedSection with an empty image.");o.scaleSelf(i);const l=this.getNextImageSectionCharCode();l?(this.text+=String.fromCodePoint(l),this.sections.push(jm.forImage(o)),this.sectionIndex.push(this.sections.length-1)):bt("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function Yx(n,e,i,o,l,d,f,_,v,b,E,I,C,R,k,F=1){const U=df.fromFeature(n,l,F);I===Uo.vertical&&U.verticalizePunctuation(C);let j=[];const H=function(ce,fe,ge,Fe,be,Ue){if(!ce)return[];const He=[],qe=function(Je,je,Be,Qe,ft,at){let Ot=0;for(let xt=0;xt<Je.length();xt++){const St=Je.getSection(xt);Ot+=h2(Je.getCodePoint(xt),St,Qe,ft,je,at)}return Ot/Math.max(1,Math.ceil(Ot/Be))}(ce,fe,ge,Fe,be,Ue),tt=ce.text.indexOf("")>=0;let nt=0;for(let Je=0;Je<ce.length();Je++){const je=ce.getSection(Je),Be=ce.getCodePoint(Je);if(Dy[Be]||(nt+=h2(Be,je,Fe,be,fe,Ue)),Je<ce.length()-1){const Qe=!((Ye=Be)<11904||!(Gt["Bopomofo Extended"](Ye)||Gt.Bopomofo(Ye)||Gt["CJK Compatibility Forms"](Ye)||Gt["CJK Compatibility Ideographs"](Ye)||Gt["CJK Compatibility"](Ye)||Gt["CJK Radicals Supplement"](Ye)||Gt["CJK Strokes"](Ye)||Gt["CJK Symbols and Punctuation"](Ye)||Gt["CJK Unified Ideographs Extension A"](Ye)||Gt["CJK Unified Ideographs"](Ye)||Gt["Enclosed CJK Letters and Months"](Ye)||Gt["Halfwidth and Fullwidth Forms"](Ye)||Gt.Hiragana(Ye)||Gt["Ideographic Description Characters"](Ye)||Gt["Kangxi Radicals"](Ye)||Gt["Katakana Phonetic Extensions"](Ye)||Gt.Katakana(Ye)||Gt["Vertical Forms"](Ye)||Gt["Yi Radicals"](Ye)||Gt["Yi Syllables"](Ye)));(Ek[Be]||Qe||je.image)&&He.push(f2(Je+1,nt,qe,He,Ik(Be,ce.getCodePoint(Je+1),Qe&&tt),!1))}}var Ye;return p2(f2(ce.length(),nt,qe,He,0,!0))}(U,b,d,e,o,R),{processBidirectionalText:W,processStyledBidirectionalText:Y}=ma;if(W&&U.sections.length===1){const ce=W(U.toString(),H);for(const fe of ce){const ge=new df;ge.text=fe,ge.sections=U.sections;for(let Fe=0;Fe<fe.length;Fe++)ge.sectionIndex.push(0);j.push(ge)}}else if(Y){const ce=Y(U.text,U.sectionIndex,H);for(const fe of ce){const ge=new df;ge.text=fe[0],ge.sectionIndex=fe[1],ge.sections=U.sections,j.push(ge)}}else j=function(ce,fe){const ge=[],Fe=ce.text;let be=0;for(const Ue of fe)ge.push(ce.substring(be,Ue)),be=Ue;return be<Fe.length&&ge.push(ce.substring(be,Fe.length)),ge}(U,H);const se=[],ie={positionedLines:se,text:U.toString(),top:E[1],bottom:E[1],left:E[0],right:E[0],writingMode:I,iconsInText:!1,verticalizable:!1,hasBaseline:!1};if(function(ce,fe,ge,Fe,be,Ue,He,qe,tt,nt,Ye,Je){let je=0,Be=0,Qe=0;const ft=qe==="right"?1:qe==="left"?0:.5;let at=!1;for(const lt of be){const Mt=lt.getSections();for(const ei of Mt){if(ei.image)continue;const bi=fe[ei.fontStack];if(bi&&(at=bi.ascender!==void 0&&bi.descender!==void 0,!at))break}if(!at)break}let Ot=0;for(const lt of be){lt.trim();const Mt=lt.getMaxScale(),ei=(Mt-1)*br,bi={positionedGlyphs:[],lineOffset:0};ce.positionedLines[Ot]=bi;const Si=bi.positionedGlyphs;let oi=0;if(!lt.length()){Be+=Ue,++Ot;continue}let en=0,ne=0;for(let Ve=0;Ve<lt.length();Ve++){const it=lt.getSection(Ve),gt=lt.getSectionIndex(Ve),yt=lt.getCodePoint(Ve);let Ft=it.scale,Nt=null,ni=null,hi=null,fi=br,gi=0,Wt=tt;Wt===Uo.vertical&&((xt=yt)===12312||xt===12313||xt===12316||xt===12540||xt===12448)&&(Wt=Uo.horizontal);const Qt=!(Wt===Uo.horizontal||!Ye&&!Id(yt)||Ye&&(Dy[yt]||Cd(yt)));if(it.image){const Pi=Fe.get(it.image.toString());if(!Pi)continue;hi=it.image,ce.iconsInText=ce.iconsInText||!0,ni=Pi.paddedRect;const Bi=Pi.displaySize;Ft=Ft*br/Je,Nt={width:Bi[0],height:Bi[1],left:0,top:-u2,advance:Qt?Bi[1]:Bi[0],localGlyph:!1},gi=at?-Nt.height*Ft:Mt*br-17-Bi[1]*Ft,fi=Nt.advance;const Ni=(Qt?Bi[0]:Bi[1])*Ft-br*Mt;Ni>0&&Ni>oi&&(oi=Ni)}else{const Pi=ge[it.fontStack];if(!Pi)continue;Pi[yt]&&(ni=Pi[yt]);const Bi=fe[it.fontStack];if(!Bi)continue;const Ni=Bi.glyphs[yt];if(!Ni)continue;if(Nt=Ni.metrics,fi=yt!==8203?br:0,at){const Ki=Bi.ascender!==void 0?Math.abs(Bi.ascender):0,sn=Bi.descender!==void 0?Math.abs(Bi.descender):0,tn=(Ki+sn)*Ft;en<tn&&(en=tn,ne=(Ki-sn)/2*Ft),gi=-Ki*Ft}else gi=(Mt-Ft)*br-17}Qt?(ce.verticalizable=!0,Si.push({glyph:yt,image:hi,x:je,y:Be+gi,vertical:Qt,scale:Ft,localGlyph:Nt.localGlyph,fontStack:it.fontStack,sectionIndex:gt,metrics:Nt,rect:ni}),je+=fi*Ft+nt):(Si.push({glyph:yt,image:hi,x:je,y:Be+gi,vertical:Qt,scale:Ft,localGlyph:Nt.localGlyph,fontStack:it.fontStack,sectionIndex:gt,metrics:Nt,rect:ni}),je+=Nt.advance*Ft+nt)}Si.length!==0&&(Qe=Math.max(je-nt,Qe),at?m2(Si,ft,oi,ne,Ue*Mt/2):m2(Si,ft,oi,0,Ue/2)),je=0;const ae=Ue*Mt+oi;bi.lineOffset=Math.max(oi,ei),Be+=ae,++Ot}var xt;const St=Be,{horizontalAlign:Pt,verticalAlign:pi}=Jx(He);(function(lt,Mt,ei,bi,Si,oi){const en=(Mt-ei)*Si,ne=-oi*bi;for(const ae of lt)for(const Ve of ae.positionedGlyphs)Ve.x+=en,Ve.y+=ne})(ce.positionedLines,ft,Pt,pi,Qe,St),ce.top+=-pi*St,ce.bottom=ce.top+St,ce.left+=-Pt*Qe,ce.right=ce.left+Qe,ce.hasBaseline=at}(ie,e,i,o,j,f,_,v,I,b,C,k),!function(ce){for(const fe of ce)if(fe.positionedGlyphs.length!==0)return!1;return!0}(se))return ie}const Dy={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},Ek={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function h2(n,e,i,o,l,d){if(e.image){const f=o.get(e.image.toString());return f?f.displaySize[0]*e.scale*br/d+l:0}{const f=i[e.fontStack],_=f&&f.glyphs[n];return _?_.metrics.advance*e.scale+l:0}}function d2(n,e,i,o){const l=Math.pow(n-e,2);return o?n<e?l/2:2*l:l+Math.abs(i)*i}function Ik(n,e,i){let o=0;return n===10&&(o-=1e4),i&&(o+=150),n!==40&&n!==65288||(o+=50),e!==41&&e!==65289||(o+=50),o}function f2(n,e,i,o,l,d){let f=null,_=d2(e,i,l,d);for(const v of o){const b=d2(e-v.x,i,l,d)+v.badness;b<=_&&(f=v,_=b)}return{index:n,x:e,priorBreak:f,badness:_}}function p2(n){return n?p2(n.priorBreak).concat(n.index):[]}function Jx(n){let e=.5,i=.5;switch(n){case"right":case"top-right":case"bottom-right":e=1;break;case"left":case"top-left":case"bottom-left":e=0}switch(n){case"bottom":case"bottom-right":case"bottom-left":i=1;break;case"top":case"top-right":case"top-left":i=0}return{horizontalAlign:e,verticalAlign:i}}function m2(n,e,i,o,l){if(!(e||i||o||l))return;const d=n.length-1,f=n[d],_=(f.x+f.metrics.advance*f.scale)*e;for(let v=0;v<=d;v++)n[v].x-=_,n[v].y+=i+o+l}function Qx(n){return n.imagePrimary!==void 0&&n.top!==void 0&&n.bottom!==void 0&&n.left!==void 0&&n.right!==void 0}function Oy(n,e,i,o){const{horizontalAlign:l,verticalAlign:d}=Jx(o),f=i[0]-n.displaySize[0]*l,_=i[1]-n.displaySize[1]*d;return{imagePrimary:n,imageSecondary:e,top:_,bottom:_+n.displaySize[1],left:f,right:f+n.displaySize[0]}}function e1(n,e,i,o,l,d){const f=n.imagePrimary;let _;if(f.content){const U=f.content,j=f.pixelRatio||1;_=[U[0]/j,U[1]/j,f.displaySize[0]-U[2]/j,f.displaySize[1]-U[3]/j]}const v=e.left*d,b=e.right*d;let E,I,C,R;i==="width"||i==="both"?(R=l[0]+v-o[3],I=l[0]+b+o[1]):(R=l[0]+(v+b-f.displaySize[0])/2,I=R+f.displaySize[0]);const k=e.top*d,F=e.bottom*d;return i==="height"||i==="both"?(E=l[1]+k-o[0],C=l[1]+F+o[2]):(E=l[1]+(k+F-f.displaySize[1])/2,C=E+f.displaySize[1]),{imagePrimary:f,imageSecondary:void 0,top:E,right:I,bottom:C,left:R,collisionPadding:_}}function _2(n){return!n.imagePrimary.stretchX}function g2(n){return!n.imagePrimary.stretchY}function y2(n){return{width:n.right-n.left,height:n.bottom-n.top}}const Ea=128;function ff(n,e,i){const{expression:o}=e;if(o.kind==="constant")return{kind:"constant",layoutSize:o.evaluate(new fn(n+1,{worldview:i}))};if(o.kind==="source")return{kind:"source"};{const{zoomStops:l,interpolationType:d}=o;let f=0;for(;f<l.length&&l[f]<=n;)f++;f=Math.max(0,f-1);let _=f;for(;_<l.length&&l[_]<n+1;)_++;_=Math.min(l.length-1,_);const v=l[f],b=l[_];return o.kind==="composite"?{kind:"composite",minZoom:v,maxZoom:b,interpolationType:d}:{kind:"camera",minZoom:v,maxZoom:b,minSize:o.evaluate(new fn(v,{worldview:i})),maxSize:o.evaluate(new fn(b,{worldview:i})),interpolationType:d}}}function t1(n,{uSize:e,uSizeT:i},{lowerSize:o,upperSize:l}){return n.kind==="source"?o/Ea:n.kind==="composite"?Kt(o/Ea,l/Ea,i):e}function pf(n,e,i=1){let o=0,l=0;if(n.kind==="constant")l=n.layoutSize*i;else if(n.kind!=="source"){const{interpolationType:d,minZoom:f,maxZoom:_}=n,v=d?V(Oo.interpolationFactor(d,e,f,_),0,1):0;n.kind==="camera"?l=Kt(n.minSize,n.maxSize,v)*i:o=v*i}return{uSizeT:o,uSize:l}}class ec extends et{constructor(e,i,o,l,d){super(e,i),this.angle=l,this.z=o,d!==void 0&&(this.segment=d)}clone(){return new ec(this.x,this.y,this.z,this.angle,this.segment)}}function v2(n,e,i,o,l){if(e.segment===void 0)return!0;let d=e,f=e.segment+1,_=0;for(;_>-i/2;){if(f--,f<0)return!1;_-=n[f].dist(d),d=n[f]}_+=n[f].dist(n[f+1]),f++;const v=[];let b=0;for(;_<i/2;){const E=n[f],I=n[f+1];if(!I)return!1;let C=n[f-1].angleTo(E)-E.angleTo(I);for(C=Math.abs((C+3*Math.PI)%(2*Math.PI)-Math.PI),v.push({distance:_,angleDelta:C}),b+=C;_-v[0].distance>o;)b-=v.shift().angleDelta;if(b>l)return!1;f++,_+=E.dist(I)}return!0}function x2(n){let e=0;for(let i=0;i<n.length-1;i++)e+=n[i].dist(n[i+1]);return e}function w2(n,e,i){return n?.6*e*i:0}function b2(n,e){return Math.max(n?n.right-n.left:0,e?e.right-e.left:0)}function Ak(n,e,i,o,l,d){const f=w2(i,l,d),_=b2(i,o)*d;let v=0;const b=x2(n)/2;for(let E=0;E<n.length-1;E++){const I=n[E],C=n[E+1],R=I.dist(C);if(v+R>b){const k=(b-v)/R,F=Kt(I.x,C.x,k),U=Kt(I.y,C.y,k),j=new ec(F,U,0,C.angleTo(I),E);return!f||v2(n,j,_,f,e)?j:void 0}v+=R}}function Ck(n,e,i,o,l,d,f,_,v){const b=w2(o,d,f),E=b2(o,l),I=E*f,C=n[0].x===0||n[0].x===v||n[0].y===0||n[0].y===v;return e-I<e/4&&(e=I+e/4),T2(n,C?e/2*_%e:(E/2+2*d)*f*_%e,e,b,i,I,C,!1,v)}function T2(n,e,i,o,l,d,f,_,v){const b=d/2,E=x2(n);let I=0,C=e-i,R=[];for(let k=0;k<n.length-1;k++){const F=n[k],U=n[k+1],j=F.dist(U),H=U.angleTo(F);for(;C+i<I+j;){C+=i;const W=(C-I)/j,Y=Kt(F.x,U.x,W),se=Kt(F.y,U.y,W);if(Y>=0&&Y<v&&se>=0&&se<v&&C-b>=0&&C+b<=E){const ie=new ec(Y,se,0,H,k);o&&!v2(n,ie,d,o,l)||R.push(ie)}}I+=j}return _||R.length||f||(R=T2(n,I/2,i,o,l,d,f,!0,v)),R}function S2(n){let e=0,i=0;for(const f of n)e+=f.w*f.h,i=Math.max(i,f.w);n.sort((f,_)=>_.h-f.h);const o=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),i),h:1/0}];let l=0,d=0;for(const f of n)for(let _=o.length-1;_>=0;_--){const v=o[_];if(!(f.w>v.w||f.h>v.h)){if(f.x=v.x,f.y=v.y,d=Math.max(d,f.y+f.h),l=Math.max(l,f.x+f.w),f.w===v.w&&f.h===v.h){const b=o.pop();b&&_<o.length&&(o[_]=b)}else f.h===v.h?(v.x+=f.w,v.w-=f.w):f.w===v.w?(v.y+=f.h,v.h-=f.h):(o.push({x:v.x+f.w,y:v.y,w:v.w-f.w,h:f.h}),v.y+=f.h,v.h-=f.h);break}}return{w:l,h:d,fill:e/(l*d)||0}}It(ec,"Anchor");const ph=1;class Um{static getImagePositionScale(e,i,o){if(i&&e){const{sx:l,sy:d}=e;return{x:l,y:d}}return{x:o,y:o}}constructor(e,i,o,l){this.paddedRect=e;const{pixelRatio:d,version:f,stretchX:_,stretchY:v,content:b,sdf:E,usvg:I}=i;this.pixelRatio=d,this.stretchX=_,this.stretchY=v,this.content=b,this.version=f,this.padding=o,this.sdf=E,this.usvg=I,this.scale=Um.getImagePositionScale(l,I,d)}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.scale.x,(this.paddedRect.h-2*this.padding)/this.scale.y]}}function i1(n,e,i){const o=la.parse(n),l=function(d,f,_=[1,1]){return{x:0,y:0,w:(d.data?d.data.width:d.width*_[0])+2*f,h:(d.data?d.data.height:d.height*_[1])+2*f}}(e,i,[o.sx,o.sy]);return{bin:l,imagePosition:new Um(l,e,i,o),imageVariant:o}}class E2{constructor(e,i,o){const l=new Map,d=new Map;this.haveRenderCallbacks=[];const f=[];this.addImages(e,l,ph,f),this.addImages(i,d,2,f);const{w:_,h:v}=S2(f),b=new Wr({width:_||1,height:v||1});for(const[E,I]of e.entries()){const C=l.get(E).paddedRect;Wr.copy(I.data,b,{x:0,y:0},{x:C.x+ph,y:C.y+ph},I.data,null,I.sdf)}for(const[E,I]of i.entries()){const C=d.get(E),R=C.paddedRect;let k=C.padding;const F=R.x+k,U=R.y+k,j=I.data.width,H=I.data.height;k=k>1?k-1:k,Wr.copy(I.data,b,{x:0,y:0},{x:F,y:U},I.data,o),Wr.copy(I.data,b,{x:0,y:H-k},{x:F,y:U-k},{width:j,height:k},o),Wr.copy(I.data,b,{x:0,y:0},{x:F,y:U+H},{width:j,height:k},o),Wr.copy(I.data,b,{x:j-k,y:0},{x:F-k,y:U},{width:k,height:H},o),Wr.copy(I.data,b,{x:0,y:0},{x:F+j,y:U},{width:k,height:H},o),Wr.copy(I.data,b,{x:j-k,y:H-k},{x:F-k,y:U-k},{width:k,height:k},o),Wr.copy(I.data,b,{x:0,y:H-k},{x:F+j,y:U-k},{width:k,height:k},o),Wr.copy(I.data,b,{x:0,y:0},{x:F+j,y:U+H},{width:k,height:k},o),Wr.copy(I.data,b,{x:j-k,y:0},{x:F-k,y:U+H},{width:k,height:k},o)}this.lut=o,this.image=b,this.iconPositions=l,this.patternPositions=d}addImages(e,i,o,l){for(const[d,f]of e.entries()){const{bin:_,imagePosition:v,imageVariant:b}=i1(d,f,o);i.set(d,v),l.push(_),f.hasRenderCallback&&this.haveRenderCallbacks.push(b.id)}}patchUpdatedImages(e,i,o){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(l=>e.hasImage(l,o)),e.dispatchRenderCallbacks(this.haveRenderCallbacks,o);for(const l of e.getUpdatedImages(o)){for(const d of this.iconPositions.keys()){const f=la.parse(d);if(Jr.isEqual(f.id,l)){const _=e.getImage(l,o);this.patchUpdatedImage(this.iconPositions.get(d),_,i,null)}}for(const d of this.patternPositions.keys()){const f=la.parse(d);if(Jr.isEqual(f.id,l)){const _=e.getImage(l,o);this.patchUpdatedImage(this.patternPositions.get(d),_,i,this.lut)}}}}patchUpdatedImage(e,i,o,l=null){if(!e||!i||e.version===i.version)return;e.version=i.version;const[d,f]=e.tl,_=e.sdf;if(this.lut||_){const v={width:i.data.width,height:i.data.height},b=new Wr(v);Wr.copy(i.data,b,{x:0,y:0},{x:0,y:0},v,l,_),o.update(b,{position:{x:d,y:f}})}else o.update(i.data,{position:{x:d,y:f}})}}It(Um,"ImagePosition"),It(E2,"ImageAtlas");const Vm=1e20;function I2(n,e,i,o,l,d,f,_,v){for(let b=e;b<e+o;b++)A2(n,i*d+b,d,l,f,_,v);for(let b=i;b<i+l;b++)A2(n,b*d+e,1,o,f,_,v)}function A2(n,e,i,o,l,d,f){d[0]=0,f[0]=-Vm,f[1]=Vm,l[0]=n[e];for(let _=1,v=0,b=0;_<o;_++){l[_]=n[e+_*i];const E=_*_;do{const I=d[v];b=(l[_]-l[I]+E-I*I)/(_-I)/2}while(b<=f[v]&&--v>-1);v++,d[v]=_,f[v]=b,f[v+1]=Vm}for(let _=0,v=0;_<o;_++){for(;f[v+1]<_;)v++;const b=d[v],E=_-b;n[e+_*i]=l[b]+E*E}}const Ia=2,n1={none:0,ideographs:1,all:2};class mf{constructor(e,i,o){this.requestManager=e,this.localGlyphMode=i,this.localFontFamily=o,this.url="",this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(e){this.url=e}getGlyphs(e,i){const o=[],l=this.url||xi.GLYPHS_URL;for(const d in e)for(const f of e[d])o.push({stack:d,id:f});pe(o,({stack:d,id:f},_)=>{let v=this.entries[d];v||(v=this.entries[d]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let b=v.glyphs[f];if(b!==void 0)return void _(null,{stack:d,id:f,glyph:b});if(b=this._tinySDF(v,d,f),b)return v.glyphs[f]=b,void _(null,{stack:d,id:f,glyph:b});const E=Math.floor(f/256);if(256*E>65535)return bt("glyphs > 65535 not supported"),void _(null,{stack:d,id:f,glyph:b});if(v.ranges[E])return void _(null,{stack:d,id:f,glyph:b});let I=v.requests[E];I||(I=v.requests[E]=[],mf.loadGlyphRange(d,E,l,this.requestManager,(C,R)=>{if(R){v.ascender=R.ascender,v.descender=R.descender;for(const k in R.glyphs)this._doesCharSupportLocalGlyph(+k)||(v.glyphs[+k]=R.glyphs[+k]);v.ranges[E]=!0}for(const k of I)k(C,R);delete v.requests[E]})),I.push((C,R)=>{C?_(C):R&&_(null,{stack:d,id:f,glyph:R.glyphs[f]||null})})},(d,f)=>{if(d)i(d);else if(f){const _={};for(const{stack:v,id:b,glyph:E}of f)_[v]===void 0&&(_[v]={}),_[v].glyphs===void 0&&(_[v].glyphs={}),_[v].glyphs[b]=E&&{id:E.id,bitmap:E.bitmap.clone(),metrics:E.metrics},_[v].ascender=this.entries[v].ascender,_[v].descender=this.entries[v].descender;i(null,_)}})}_doesCharSupportLocalGlyph(e){return this.localGlyphMode!==n1.none&&(this.localGlyphMode===n1.all?!!this.localFontFamily:!!this.localFontFamily&&(Gt["CJK Unified Ideographs"](e)||Gt["Hangul Syllables"](e)||Gt.Hiragana(e)||Gt.Katakana(e)||Gt["CJK Symbols and Punctuation"](e)||Gt["CJK Unified Ideographs Extension A"](e)||Gt["CJK Unified Ideographs Extension B"](e)||Gt.Osage(e)))}_tinySDF(e,i,o){const l=this.localFontFamily;if(!l||!this._doesCharSupportLocalGlyph(o))return;let d=e.tinySDF;if(!d){let F="400";/bold/i.test(i)?F="900":/medium/i.test(i)?F="500":/light/i.test(i)&&(F="200"),d=e.tinySDF=new mf.TinySDF({fontFamily:l,fontWeight:F,fontSize:24*Ia,buffer:3*Ia,radius:8*Ia}),d.fontWeight=F}if(this.localGlyphs[d.fontWeight][o])return this.localGlyphs[d.fontWeight][o];const f=String.fromCodePoint(o),{data:_,width:v,height:b,glyphWidth:E,glyphHeight:I,glyphLeft:C,glyphTop:R,glyphAdvance:k}=d.draw(f);return this.localGlyphs[d.fontWeight][o]={id:o,bitmap:new Hc({width:v,height:b},_),metrics:{width:E/Ia,height:I/Ia,left:C/Ia,top:R/Ia-27,advance:k/Ia,localGlyph:!0}}}}mf.loadGlyphRange=function(n,e,i,o,l){const d=256*e,f=d+255,_=o.transformRequest(o.normalizeGlyphsURL(i).replace("{fontstack}",n).replace("{range}",`${d}-${f}`),Eu.Glyphs);aa(_,(v,b)=>{if(v)l(v);else if(b){const E={},I=function(C){return new zy(C).readFields(bk,{})}(b);for(const C of I.glyphs)E[C.id]=C;l(null,{glyphs:E,ascender:I.ascender,descender:I.descender})}})},mf.TinySDF=class{constructor({fontSize:n=24,buffer:e=3,radius:i=8,cutoff:o=.25,fontFamily:l="sans-serif",fontWeight:d="normal",fontStyle:f="normal",lang:_=null}={}){this.buffer=e,this.cutoff=o,this.radius=i,this.lang=_;const v=this.size=n+4*e,b=this._createCanvas(v),E=this.ctx=b.getContext("2d",{willReadFrequently:!0});E.font=`${f} ${d} ${n}px ${l}`,E.textBaseline="alphabetic",E.textAlign="left",E.fillStyle="black",this.gridOuter=new Float64Array(v*v),this.gridInner=new Float64Array(v*v),this.f=new Float64Array(v),this.z=new Float64Array(v+1),this.v=new Uint16Array(v)}_createCanvas(n){const e=document.createElement("canvas");return e.width=e.height=n,e}draw(n){const{width:e,actualBoundingBoxAscent:i,actualBoundingBoxDescent:o,actualBoundingBoxLeft:l,actualBoundingBoxRight:d}=this.ctx.measureText(n),f=Math.ceil(i),_=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(d-l))),v=Math.min(this.size-this.buffer,f+Math.ceil(o)),b=_+2*this.buffer,E=v+2*this.buffer,I=Math.max(b*E,0),C=new Uint8ClampedArray(I),R={data:C,width:b,height:E,glyphWidth:_,glyphHeight:v,glyphTop:f,glyphLeft:0,glyphAdvance:e};if(_===0||v===0)return R;const{ctx:k,buffer:F,gridInner:U,gridOuter:j}=this;this.lang&&(k.lang=this.lang),k.clearRect(F,F,_,v),k.fillText(n,F,F+f);const H=k.getImageData(F,F,_,v);j.fill(Vm,0,I),U.fill(0,0,I);for(let W=0;W<v;W++)for(let Y=0;Y<_;Y++){const se=H.data[4*(W*_+Y)+3]/255;if(se===0)continue;const ie=(W+F)*b+Y+F;if(se===1)j[ie]=0,U[ie]=Vm;else{const ce=.5-se;j[ie]=ce>0?ce*ce:0,U[ie]=ce<0?ce*ce:0}}I2(j,0,0,b,E,b,this.f,this.v,this.z),I2(U,F,F,_,v,b,this.f,this.v,this.z);for(let W=0;W<I;W++){const Y=Math.sqrt(j[W])-Math.sqrt(U[W]);C[W]=Math.round(255-255*(Y/this.radius+this.cutoff))}return R}};const fl=ph;function C2(n,e){return n+e[1]-e[0]}function r1(n,e,i,o,l=1){const d=[],f=n.imagePrimary,_=f.pixelRatio,v=f.paddedRect.w-2*fl,b=f.paddedRect.h-2*fl,E=(n.right-n.left)*l,I=(n.bottom-n.top)*l,C=f.stretchX||[[0,v]],R=f.stretchY||[[0,b]],k=C.reduce(C2,0),F=R.reduce(C2,0),U=v-k,j=b-F;let H=0,W=k,Y=0,se=F,ie=0,ce=U,fe=0,ge=j;if(f.content&&o){const be=f.content;H=Fy(C,0,be[0]),Y=Fy(R,0,be[1]),W=Fy(C,be[0],be[2]),se=Fy(R,be[1],be[3]),ie=be[0]-H,fe=be[1]-Y,ce=be[2]-be[0]-W,ge=be[3]-be[1]-se}const Fe=(be,Ue,He,qe)=>{const tt=By(be.stretch-H,W,E,n.left*l),nt=Ny(be.fixed-ie,ce,be.stretch,k),Ye=By(Ue.stretch-Y,se,I,n.top*l),Je=Ny(Ue.fixed-fe,ge,Ue.stretch,F),je=By(He.stretch-H,W,E,n.left*l),Be=Ny(He.fixed-ie,ce,He.stretch,k),Qe=By(qe.stretch-Y,se,I,n.top*l),ft=Ny(qe.fixed-fe,ge,qe.stretch,F),at=new et(tt,Ye),Ot=new et(je,Ye),xt=new et(je,Qe),St=new et(tt,Qe),Pt=new et(nt/_,Je/_),pi=new et(Be/_,ft/_),lt=e*Math.PI/180;if(lt){const en=Math.sin(lt),ne=Math.cos(lt),ae=[ne,-en,en,ne];at._matMult(ae),Ot._matMult(ae),St._matMult(ae),xt._matMult(ae)}const Mt=be.stretch+be.fixed,ei=He.stretch+He.fixed,bi=Ue.stretch+Ue.fixed,Si=qe.stretch+qe.fixed,oi=n.imageSecondary;return{tl:at,tr:Ot,bl:St,br:xt,texPrimary:{x:f.paddedRect.x+fl+Mt,y:f.paddedRect.y+fl+bi,w:ei-Mt,h:Si-bi},texSecondary:oi?{x:oi.paddedRect.x+fl+Mt,y:oi.paddedRect.y+fl+bi,w:ei-Mt,h:Si-bi}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:Pt,pixelOffsetBR:pi,minFontScaleX:ce/_/E,minFontScaleY:ge/_/I,isSDF:i}};if(o&&(f.stretchX||f.stretchY)){const be=P2(C,U,k),Ue=P2(R,j,F);for(let He=0;He<be.length-1;He++){const qe=be[He],tt=be[He+1];for(let nt=0;nt<Ue.length-1;nt++)d.push(Fe(qe,Ue[nt],tt,Ue[nt+1]))}}else d.push(Fe({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:v+1},{fixed:0,stretch:b+1}));return d}function Pk(n,e){const i=n.stretchY||[[0,n.paddedRect.h-2*fl]];return e&&(n.stretchX||n.stretchY)?M2(n.stretchX||[[0,n.paddedRect.w-2*fl]])*M2(i):1}function Fy(n,e,i){let o=0;for(const l of n)o+=Math.max(e,Math.min(i,l[1]))-Math.max(e,Math.min(i,l[0]));return o}function P2(n,e,i){const o=[{fixed:-fl,stretch:0}];for(const[l,d]of n){const f=o[o.length-1];o.push({fixed:l-f.stretch,stretch:f.stretch}),o.push({fixed:l-f.stretch,stretch:f.stretch+(d-l)})}return o.push({fixed:e+fl,stretch:i}),o}function M2(n){return 2*n.length+1}function By(n,e,i,o){return n/e*i+o}function Ny(n,e,i,o){return n-e*i/o}function Mk(n,e,i,o){const l=e+n.positionedLines[o].lineOffset;return o===0?i+l/2:i+(l+(e+n.positionedLines[o-1].lineOffset))/2}function Rk(n,e=1,i=!1){let o=1/0,l=1/0,d=-1/0,f=-1/0;const _=n[0];for(let R=0;R<_.length;R++){const k=_[R];(!R||k.x<o)&&(o=k.x),(!R||k.y<l)&&(l=k.y),(!R||k.x>d)&&(d=k.x),(!R||k.y>f)&&(f=k.y)}const v=Math.min(d-o,f-l);let b=v/2;const E=new rd([],kk);if(v===0)return new et(o,l);for(let R=o;R<d;R+=v)for(let k=l;k<f;k+=v)E.push(new _f(R+b,k+b,b,n));let I=function(R){let k=0,F=0,U=0;const j=R[0];for(let H=0,W=j.length,Y=W-1;H<W;Y=H++){const se=j[H],ie=j[Y],ce=se.x*ie.y-ie.x*se.y;F+=(se.x+ie.x)*ce,U+=(se.y+ie.y)*ce,k+=3*ce}return new _f(F/k,U/k,0,R)}(n),C=E.length;for(;E.length;){const R=E.pop();(R.d>I.d||!I.d)&&(I=R,i&&console.log("found best %d after %d probes",Math.round(1e4*R.d)/1e4,C)),R.max-I.d<=e||(b=R.h/2,E.push(new _f(R.p.x-b,R.p.y-b,b,n)),E.push(new _f(R.p.x+b,R.p.y-b,b,n)),E.push(new _f(R.p.x-b,R.p.y+b,b,n)),E.push(new _f(R.p.x+b,R.p.y+b,b,n)),C+=4)}return i&&(console.log(`num probes: ${C}`),console.log(`best distance: ${I.d}`)),I.p}function kk(n,e){return e.max-n.max}class _f{constructor(e,i,o,l){this.p=new et(e,i),this.h=o,this.d=function(d,f){let _=!1,v=1/0;for(let b=0;b<f.length;b++){const E=f[b];for(let I=0,C=E.length,R=C-1;I<C;R=I++){const k=E[I],F=E[R];k.y>d.y!=F.y>d.y&&d.x<(F.x-k.x)*(d.y-k.y)/(F.y-k.y)+k.x&&(_=!_),v=Math.min(v,Gn(d,k,F))}}return(_?1:-1)*Math.sqrt(v)}(this.p,l),this.max=this.d+this.h*Math.SQRT2}}const Lk=Object.keys,o1=Number.POSITIVE_INFINITY,zk=Math.sqrt(2);function Wc(n,e,i,o,l){const d=Qx(n)&&n.collisionPadding?n.collisionPadding:[0,0,0,0],f={top:n.top-d[1],bottom:n.bottom+d[3],left:n.left-d[0],right:n.right+d[2],scaled:!1};return o!==void 0&&function(_,v){_.top*=v,_.bottom*=v,_.left*=v,_.right*=v,_.scaled=!0}(f,o),i&&function(_,v){if(!v)return;const b=Oi(v),E=new et(_.left,_.top),I=new et(_.right,_.top),C=new et(_.left,_.bottom),R=new et(_.right,_.bottom),k=new et(0,0);E._rotateAround(b,k),I._rotateAround(b,k),C._rotateAround(b,k),R._rotateAround(b,k),_.left=Math.min(E.x,I.x,C.x,R.x),_.right=Math.max(E.x,I.x,C.x,R.x),_.top=Math.min(E.y,I.y,C.y,R.y),_.bottom=Math.max(E.y,I.y,C.y,R.y)}(f,i),l&&(f.left+=l[0],f.right+=l[0],f.top+=l[1],f.bottom+=l[1]),e?{top:Math.min(e.top,f.top),bottom:Math.max(e.bottom,f.bottom),left:Math.min(e.left,f.left),right:Math.max(e.right,f.right),scaled:e.scaled||f.scaled}:f}function R2(n,[e,i]){let o=0,l=0;if(i===o1){e<0&&(e=0);const d=e/zk;switch(n){case"top-right":case"top-left":l=d-7;break;case"bottom-right":case"bottom-left":l=7-d;break;case"bottom":l=7-e;break;case"top":l=e-7}switch(n){case"top-right":case"bottom-right":o=-d;break;case"top-left":case"bottom-left":o=d;break;case"left":o=e;break;case"right":o=-e}}else{switch(e=Math.abs(e),i=Math.abs(i),n){case"top-right":case"top-left":case"top":l=i-7;break;case"bottom-right":case"bottom-left":case"bottom":l=7-i}switch(n){case"top-right":case"bottom-right":case"right":o=-e;break;case"top-left":case"bottom-left":case"left":o=e}}return[o,l]}function Dk(n,e,i,o,l,d,f,_,v,b,E,I,C,R){const k=n.layers[0],F=k.appearances;if(F.length===0)return{iconBBox:null,iconVerticalBBox:null,textBBox:null,textVerticalBBox:null};const U={iconBBox:null,iconVerticalBBox:null},j={textBBox:null,textVerticalBBox:null},{baseIconRotate:H,baseTextRotate:W,iconScaleFactor:Y}=function(ie,ce,fe){const ge=ie.get("icon-rotate").evaluate(ce,{},fe),Fe=ie.get("text-rotate").evaluate(ce,{},fe),[be,Ue]=ie.get("icon-size-scale-range");return{baseIconRotate:ge,baseTextRotate:Fe,iconScaleFactor:V(1,be,Ue)}}(o,l,d);e&&(U.iconBBox=Wc(e,U.iconBBox,H,f),i)&&(U.iconVerticalBBox=Wc(i,U.iconVerticalBBox,H+90,f));const se=Uy(I.horizontal);se&&(j.textBBox=Wc(se,j.textBBox,W,1,R)),I.vertical&&(j.textVerticalBBox=Wc(I.vertical,j.textVerticalBBox,W+90,1,R));for(const ie of F)ie.hasIconProperties()&&Ok(U,n,k,ie,l,d,_,H,f,v,e,b,Y,E),ie.hasTextProperties()&&Fk(j,k,ie,l,d,R,W,C,se,I.vertical);return{iconBBox:U.iconBBox,iconVerticalBBox:U.iconVerticalBBox,textBBox:j.textBBox,textVerticalBBox:j.textVerticalBBox}}function Ok(n,e,i,o,l,d,f,_,v,b,E,I,C,R){const{appearanceIconOffset:k,appearanceIconRotate:F,appearanceIconSize:U}=function(Y,se,ie,ce,fe,ge,Fe,be){const Ue=Y.hasProperty("icon-offset")?se.getAppearanceValueAndResolveTokens(Y,"icon-offset",ie,ce,[]):null,He=Ue&&Array.isArray(Ue)?Ue:fe,qe=Y.hasProperty("icon-rotate")?se.getAppearanceValueAndResolveTokens(Y,"icon-rotate",ie,ce,[]):null,tt=typeof qe=="number"?qe:ge,nt=Y.hasProperty("icon-size")?se.getAppearanceValueAndResolveTokens(Y,"icon-size",ie,ce,[]):null;return{appearanceIconOffset:He,appearanceIconRotate:tt,appearanceIconSize:typeof nt=="number"?nt*be.iconScaleFactor:Fe}}(o,i,l,d,f,_,v,b);let j=null,H=null,W=null;o.hasProperty("icon-image")?W=function(Y,se,ie,ce,fe,ge,Fe){let be=null;const Ue=se.getAppearanceValueAndResolveTokens(ie,"icon-image",ce,fe,[]);if(Ue){const He=Y.getResolvedImageFromTokens(Ue),qe=ie.getUnevaluatedProperty("icon-size"),tt=$m(He,ff(Y.zoom,qe,Y.worldview),qe,fe,Y.zoom,ce,Y.pixelRatio,Fe,Y.worldview);be=ge.get(tt.iconPrimary.toString())}return be}(e,i,o,l,d,I,C):E&&(W=E.imagePrimary),W&&(j=Oy(W,null,k,R),e.allowVerticalPlacement&&(H=Oy(W,null,k,R))),j&&(n.iconBBox=Wc(j,n.iconBBox,F,U)),H&&(n.iconVerticalBBox=Wc(H,n.iconVerticalBBox,F+90,U))}function Fk(n,e,i,o,l,d,f,_,v,b){const{appearanceTextOffset:E,appearanceTextRotate:I,appearanceTextSize:C}=function(k,F,U,j,H,W,Y){const se=k.hasProperty("text-offset")?F.getAppearanceValueAndResolveTokens(k,"text-offset",U,j,[]):null,ie=se&&Array.isArray(se)?[se[0]*br,se[1]*br]:H,ce=k.hasProperty("text-rotate")?F.getAppearanceValueAndResolveTokens(k,"text-rotate",U,j,[]):null,fe=typeof ce=="number"?ce:W,ge=k.hasProperty("text-size")?F.getAppearanceValueAndResolveTokens(k,"text-size",U,j,[]):null;return{appearanceTextOffset:ie,appearanceTextRotate:fe,appearanceTextSize:typeof ge=="number"?ge:Y}}(i,e,o,l,d,f,_),R=C/_;v&&(n.textBBox=Wc(v,n.textBBox,I,R,E)),b&&(n.textVerticalBBox=Wc(b,n.textVerticalBBox,I+90,R,E))}function jy(n,e,i,o,l,d,f,_,v){if(!e||!e.usvg)return;const b=y2(o),E=y2(l),I=d!=="both"&&d!=="width"||!_2(o)?1:E.width/b.width,C=d!=="both"&&d!=="height"||!g2(o)?1:E.height/b.height;i.scaleSelf(I,C);const R=i.toString();f.set(R,i),_.set(R,e);const{imagePosition:k}=i1(R,e,ph);v.set(R,k)}function k2(n,e,i,o,l,d,f,_,v){if(!n)return;const b=function(E,I,C,R,k,F){if(E.kind==="camera")return E.maxSize;if(E.kind==="composite"){const U=I.possiblyEvaluate(new fn(E.maxZoom,{worldview:F}),C).evaluate(k,{},C),j=I.possiblyEvaluate(new fn(E.minZoom,{worldview:F}),C).evaluate(k,{},C);return Math.max(U,j)}return I.possiblyEvaluate(new fn(R,{worldview:F})).evaluate(k,{},C)}(e,i,o,l,d,v);return n.scaleSelf(b*_*f)}function $m(n,e,i,o,l,d,f,_,v){return{iconPrimary:k2(n.getPrimary(),e,i,o,l,d,f,_,v),iconSecondary:k2(n.getSecondary(),e,i,o,l,d,f,_,v)}}function Bk(n,e,i){if(!e)return;const o=i.get(n.toString()),l=i.get(e.toString());o&&l&&(o.paddedRect.w===l.paddedRect.w&&o.paddedRect.h===l.paddedRect.h||bt(`Mismatch in icon variant sizes: ${n.toString()} and ${e.toString()}`),o.usvg!==l.usvg&&bt(`Mismatch in icon variant image types: ${n.id} and ${e.id}`))}function L2(n,e,i,o){if(!n)return;const l=e.get(i.toString());if(n.imagePrimary=l,o){const d=e.get(o.toString());n.imageSecondary=d}}function Nk(n,e){for(const i in n.horizontal)z2(n.horizontal[i],e);z2(n.vertical,e)}function z2(n,e){if(n){for(const i of n.positionedLines)for(const o of i.positionedGlyphs)if(o.image!==null){const l=o.image.toString();o.rect=e.get(l).paddedRect}}}function s1(n){switch(n){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function jk(n,e,i,o,l,d,f,_,v){const b=Uy(d.horizontal)||d.vertical,E=i.get("icon-text-fit-padding").evaluate(o,{},l);let I,C=e;return e&&v!=="none"&&(n.allowVerticalPlacement&&d.vertical&&(I=e1(e,d.vertical,v,E,_,f)),b&&(C=e1(e,b,v,E,_,f))),{defaultShapedIcon:C,verticallyShapedIcon:I}}function Uk(n,e,i,o,l,d,f,_,v,b,E,I,C,R,k,F,U,j,H,W,Y,se,ie,ce){let fe=f.textMaxSize.evaluate(e,{},C);fe===void 0?fe=_*f.textScaleFactor:fe*=f.textScaleFactor;const ge=n.layers[0].layout,Fe=br,be=_*f.textScaleFactor/Fe,Ue=Uy(i.horizontal)||i.vertical;if(U!=="none"&&n.appearanceFeatureData&&e.index<n.appearanceFeatureData.length){const xt=n.appearanceFeatureData[e.index];xt&&(xt.textShaping=Ue,xt.iconTextFitPadding=ge.get("icon-text-fit-padding").evaluate(e,{},C),xt.fontScale=be)}const He=R.name==="globe",qe=n.tilePixelRatio*fe/Fe,tt=(Qe=n.overscaling,n.zoom>18&&Qe>2&&(Qe>>=1),Math.max(dt/(512*Qe),1)*ge.get("symbol-spacing")),nt=ge.get("text-padding")*n.tilePixelRatio,Ye=ge.get("icon-padding")*n.tilePixelRatio,Je=Oi(ge.get("text-max-angle")),je=ge.get("icon-rotation-alignment")==="map"&&W!=="point",Be=tt/2;var Qe;n.hasAnyIconTextFit===!1&&U!=="none"&&(n.hasAnyIconTextFit=!0);const ft=e.properties?+e.properties[Ne]:null,at=ft&&n.elevationFeatureIdToIndex?n.elevationFeatureIdToIndex.get(ft):65535,Ot=(xt,St,Pt)=>{if(St.x<0||St.x>=dt||St.y<0||St.y>=dt)return;let pi=null;if(He){const{x:lt,y:Mt,z:ei}=R.projectTilePoint(St.x,St.y,Pt);pi={anchor:new ec(lt,Mt,ei,0,void 0),up:R.upVector(Pt,St.x,St.y)}}(function(lt,Mt,ei,bi,Si,oi,en,ne,ae,Ve,it,gt,yt,Ft,Nt,ni,hi,fi,gi,Wt,Qt,Pi,Bi,Ni,Ki,sn,tn,Vi,qi,di,Ti,Tn,Ht){const yi=lt.addToLineVertexArray(Mt,bi);let nn,ln,pn,Zn,cn,qt,Mn,Yi=0,wn=0,cr=0,Tr=0,ir=-1,nr=-1;const gr={};let wo=qh("");const un=ei?ei.anchor:Mt,Hn=Vi!=="none";let Xn=0,Co=0;if(ae._unevaluatedLayout.getValue("text-radial-offset")===void 0){const Br=ae.layout.get("text-offset").evaluate(Qt,{},Ki);Xn=Br[0]*br,Co=Br[1]*br}else Xn=ae.layout.get("text-radial-offset").evaluate(Qt,{},Ki)*br,Co=o1;if(lt.allowVerticalPlacement&&Si.vertical){const Br=Si.vertical;if(Nt)qt=a1(Br),ne&&(Mn=a1(ne));else{const uo=ae.layout.get("text-rotate").evaluate(Qt,{},Ki)+90;pn=Vy(Ve,un,Mt,it,gt,yt,Br,Ft,uo,ni,Tn),ne&&(Zn=Vy(Ve,un,Mt,it,gt,yt,ne,fi,uo,null,Ti))}}if(oi){const Br=lt.iconSizeData,uo=ae.layout.get("icon-rotate").evaluate(Qt,{},Ki),Vo=r1(oi,uo,Bi,Hn,Pi.iconScaleFactor),Kc=ne?r1(ne,uo,Bi,Hn,Pi.iconScaleFactor):void 0;ln=Vy(Ve,un,Mt,it,gt,yt,oi,fi,uo,null,di);const Tf=function(Ma,a_,QE,QL,eI,tI,ez,tz){const iI=Ma.layers[0],nI=iI.appearances;let Sf=a_.length;if(QE&&(Sf=Math.max(Sf,QE.length)),nI.length===0)return Sf;const[iz,nz]=QL.get("icon-size-scale-range"),rz=V(1,iz,nz);for(const rI of nI){const oI=rI.getUnevaluatedProperties();if(oI._values["icon-image"].value!==void 0){const sI=iI.getAppearanceValueAndResolveTokens(rI,"icon-image",eI,tI,[]);if(sI){const aI=Ma.getResolvedImageFromTokens(sI);if(aI){const lI=oI._values["icon-size"],oz=$m(aI,ff(Ma.zoom,lI,Ma.worldview),lI,tI,Ma.zoom,eI,Ma.pixelRatio,rz,Ma.worldview),sz=ez.get(oz.iconPrimary.toString());Sf=Math.max(Sf,Pk(sz,tz))}}}}return Sf}(lt,Vo,Kc,ae.layout,Qt,Ki,lt.iconAtlasPositions,Hn);Yi=4*Tf;let Pa=null;Br.kind==="source"?(Pa=[Ea*ae.layout.get("icon-size").evaluate(Qt,{},Ki)*Pi.iconScaleFactor],Pa[0]>tc&&bt(`${lt.layerIds[0]}: Value for "icon-size" is >= ${Gm}. Reduce your "icon-size".`)):Br.kind==="composite"&&(Pa=[Ea*Pi.compositeIconSizes[0].evaluate(Qt,{},Ki)*Pi.iconScaleFactor,Ea*Pi.compositeIconSizes[1].evaluate(Qt,{},Ki)*Pi.iconScaleFactor],(Pa[0]>tc||Pa[1]>tc)&&bt(`${lt.layerIds[0]}: Value for "icon-size" is >= ${Gm}. Reduce your "icon-size".`)),lt.addSymbols(lt.icon,Vo,Pa,Wt,gi,Qt,void 0,ei,Mt,yi.lineStartIndex,yi.lineLength,-1,Ni,Ki,sn,tn,lt.symbolInstances.length,Tf),ir=lt.icon.placedSymbolArray.length-1,Kc&&(wn=4*Tf,lt.addSymbols(lt.icon,Kc,Pa,Wt,gi,Qt,Uo.vertical,ei,Mt,yi.lineStartIndex,yi.lineLength,-1,Ni,Ki,sn,tn,lt.symbolInstances.length,Tf),nr=lt.icon.placedSymbolArray.length-1)}for(const Br in Si.horizontal){const uo=Br,Vo=Si.horizontal[uo];nn||(wo=qh(Vo.text),Nt?cn=a1(Vo):nn=Vy(Ve,un,Mt,it,gt,yt,Vo,Ft,ae.layout.get("text-rotate").evaluate(Qt,{},Ki),ni,Tn));const Kc=Vo.positionedLines.length===1;if(cr+=D2(lt,ei,Mt,Vo,en,ae,Nt,Qt,ni,yi,Si.vertical?Uo.horizontal:Uo.horizontalOnly,Kc?Lk(Si.horizontal):[uo],gr,ir,Pi,Ni,Ki,lt.symbolInstances.length,sn),Kc)break}Si.vertical&&(Tr+=D2(lt,ei,Mt,Si.vertical,en,ae,Nt,Qt,ni,yi,Uo.vertical,["vertical"],gr,nr,Pi,Ni,Ki,lt.symbolInstances.length,sn));let ur=-1;const Xs=(Br,uo)=>Br?Math.max(Br,uo):uo;ur=Xs(cn,ur),ur=Xs(qt,ur),ur=Xs(Mn,ur);const pl=ur>-1?1:0;lt.glyphOffsetArray.length>=65535&&bt("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),Qt.sortKey!==void 0&&lt.addToSortKeyRanges(lt.symbolInstances.length,Qt.sortKey),lt.symbolInstances.emplaceBack(Mt.x,Mt.y,un.x,un.y,un.z,gr.right>=0?gr.right:-1,gr.center>=0?gr.center:-1,gr.left>=0?gr.left:-1,gr.vertical>=0?gr.vertical:-1,ir,nr,wo,nn!==void 0?nn:lt.collisionBoxArray.length,nn!==void 0?nn+1:lt.collisionBoxArray.length,pn!==void 0?pn:lt.collisionBoxArray.length,pn!==void 0?pn+1:lt.collisionBoxArray.length,ln!==void 0?ln:lt.collisionBoxArray.length,ln!==void 0?ln+1:lt.collisionBoxArray.length,Zn||lt.collisionBoxArray.length,Zn?Zn+1:lt.collisionBoxArray.length,it,cr,Tr,Yi,wn,pl,0,Xn,Co,ur,0,Hn?1:0,qi)})(n,St,pi,xt,i,o,d,l,n.layers[0],n.collisionBoxArray,e.index,e.sourceLayerIndex,n.index,nt,H,b,0,Ye,je,j,e,f,E,I,C,k,F,U,at,Y,se,ie)};if(W==="line")for(const xt of Ty(e.geometry,0,0,dt,dt)){const St=Ck(xt,tt,Je,i.vertical||Ue,o,Fe,qe,n.overscaling,dt);for(const Pt of St)Ue&&Vk(n,Ue.text,Be,Pt)||Ot(xt,Pt,C)}else if(W==="line-center"){for(const xt of e.geometry)if(xt.length>1){const St=Ak(xt,Je,i.vertical||Ue,o,Fe,qe);St&&Ot(xt,St,C)}}else if(e.type==="Polygon")for(const xt of Im(e.geometry,0)){const St=Rk(xt,16);Ot(xt[0],new ec(St.x,St.y,0,0,void 0),C)}else if(e.type==="LineString")for(const xt of e.geometry)Ot(xt,new ec(xt[0].x,xt[0].y,0,0,void 0),C);else if(e.type==="Point")for(const xt of e.geometry)for(const St of xt)Ot([St],new ec(St.x,St.y,0,0,void 0),C)}const Gm=255,tc=Gm*Ea;function D2(n,e,i,o,l,d,f,_,v,b,E,I,C,R,k,F,U,j,H){const W=function(ie,ce,fe,ge,Fe,be,Ue,He){const qe=[];if(ce.positionedLines.length===0)return qe;const tt=ge.layout.get("text-rotate").evaluate(be,{})*Math.PI/180,nt=function(Qe){const ft=Qe[0],at=Qe[1],Ot=ft*at;return Ot>0?[ft,-at]:Ot<0?[-ft,at]:ft===0?[at,ft]:[at,-ft]}(fe);let Ye=Math.abs(ce.top-ce.bottom);for(const Qe of ce.positionedLines)Ye-=Qe.lineOffset;const Je=ce.positionedLines.length,je=Ye/Je;let Be=ce.top-fe[1];for(let Qe=0;Qe<Je;++Qe){const ft=ce.positionedLines[Qe];Be=Mk(ce,je,Be,Qe);for(const at of ft.positionedGlyphs){if(!at.rect)continue;const Ot=at.rect||{};let xt=u2+1,St=!0,Pt=1,pi=0;if(at.image){const hi=Ue.get(at.image.toString());if(!hi)continue;if(hi.sdf){bt("SDF images are not supported in formatted text and will be ignored.");continue}St=!1,Pt=hi.pixelRatio,xt=ph/Pt}const lt=(Fe||He)&&at.vertical,Mt=at.metrics.advance*at.scale/2,ei=at.metrics,bi=at.rect;if(bi===null)continue;He&&ce.verticalizable&&(pi=at.image?Mt-at.metrics.width*at.scale/2:0);const Si=Fe?[at.x+Mt,at.y]:[0,0];let oi=[0,0],en=[0,0],ne=!1;Fe||(lt?(en=[at.x+Mt+nt[0],at.y+nt[1]-pi],ne=!0):oi=[at.x+Mt+fe[0],at.y+fe[1]-pi]);const ae=bi.w*at.scale/(Pt*(at.localGlyph?Ia:1)),Ve=bi.h*at.scale/(Pt*(at.localGlyph?Ia:1));let it,gt,yt,Ft;if(lt){const hi=at.y-Be,fi=new et(-Mt,Mt-hi),gi=-Math.PI/2,Wt=new et(...en);it=new et(-Mt+oi[0],oi[1]),it._rotateAround(gi,fi)._add(Wt),it.x+=-hi+Mt,it.y-=(ei.left-xt)*at.scale;const Qt=at.image?ei.advance*at.scale:br*at.scale,Pi=String.fromCodePoint(at.glyph);hk(Pi)?it.x+=(1-xt)*at.scale:dk(Pi)?it.x+=Qt-ei.height*at.scale+(-xt-1)*at.scale:it.x+=at.image||ei.width+2*xt===bi.w&&ei.height+2*xt===bi.h?(Qt-Ve)/2:(Qt-(ei.height+2*xt)*at.scale)/2,gt=new et(it.x,it.y-ae),yt=new et(it.x+Ve,it.y),Ft=new et(it.x+Ve,it.y-ae)}else{const hi=(ei.left-xt)*at.scale-Mt+oi[0],fi=(-ei.top-xt)*at.scale+oi[1],gi=hi+ae,Wt=fi+Ve;it=new et(hi,fi),gt=new et(gi,fi),yt=new et(hi,Wt),Ft=new et(gi,Wt)}if(tt){let hi;hi=Fe?new et(0,0):ne?new et(nt[0],nt[1]):new et(fe[0],fe[1]),it._rotateAround(tt,hi),gt._rotateAround(tt,hi),yt._rotateAround(tt,hi),Ft._rotateAround(tt,hi)}const Nt=new et(0,0),ni=new et(0,0);qe.push({tl:it,tr:gt,bl:yt,br:Ft,texPrimary:Ot,texSecondary:void 0,writingMode:ce.writingMode,glyphOffset:Si,sectionIndex:at.sectionIndex,isSDF:St,pixelOffsetTL:Nt,pixelOffsetBR:ni,minFontScaleX:0,minFontScaleY:0})}}return qe}(0,o,v,d,f,_,l,n.allowVerticalPlacement),Y=n.textSizeData;let se=null;Y.kind==="source"?(se=[Ea*d.layout.get("text-size").evaluate(_,{},U)*k.textScaleFactor],se[0]>tc&&bt(`${n.layerIds[0]}: Value for "text-size" is >= ${Gm}. Reduce your "text-size".`)):Y.kind==="composite"&&(se=[Ea*k.compositeTextSizes[0].evaluate(_,{},U)*k.textScaleFactor,Ea*k.compositeTextSizes[1].evaluate(_,{},U)*k.textScaleFactor],(se[0]>tc||se[1]>tc)&&bt(`${n.layerIds[0]}: Value for "text-size" is >= ${Gm}. Reduce your "text-size".`)),n.addSymbols(n.text,W,se,v,f,_,E,e,i,b.lineStartIndex,b.lineLength,R,F,U,H,!1,j,W.length);for(const ie of I)C[ie]=n.text.placedSymbolArray.length-1;return 4*W.length}function Uy(n){for(const e in n)return n[e];return null}function Vy(n,e,i,o,l,d,f,_,v,b,E){let I,C,R,k;if(I=E?E.top:f.top,C=E?E.bottom:f.bottom,R=E?E.left:f.left,k=E?E.right:f.right,Qx(f)&&f.collisionPadding){const F=f.collisionPadding;R-=F[0],I-=F[1],k+=F[2],C+=F[3]}if(v){const F=new et(R,I),U=new et(k,I),j=new et(R,C),H=new et(k,C),W=Oi(v);let Y=new et(0,0);b&&(Y=new et(b[0],b[1])),F._rotateAround(W,Y),U._rotateAround(W,Y),j._rotateAround(W,Y),H._rotateAround(W,Y),R=Math.min(F.x,U.x,j.x,H.x),k=Math.max(F.x,U.x,j.x,H.x),I=Math.min(F.y,U.y,j.y,H.y),C=Math.max(F.y,U.y,j.y,H.y)}return n.emplaceBack(e.x,e.y,e.z,i.x,i.y,R,I,k,C,_,o,l,d),n.length-1}function a1(n){Qx(n)&&n.collisionPadding&&(n.top-=n.collisionPadding[1],n.bottom+=n.collisionPadding[3]);const e=n.bottom-n.top;return e>0?Math.max(10,e):null}function Vk(n,e,i,o){const l=n.compareText;if(e in l){const d=l[e];for(let f=d.length-1;f>=0;f--)if(o.dist(d[f])<i)return!0}else l[e]=[];return l[e].push(o),!1}function O2(n,e){const i=n.fovAboveCenter,o=n.elevation?n.elevation.getMinElevationBelowMSL()*e:0,l=(n._camera.position[2]*n.worldSize-o)/Math.cos(n._pitch),d=Math.sin(i)*l/Math.sin(Math.max(Math.PI/2-n._pitch-i,.01));let f=Math.sin(n._pitch)*d+l;const _=l*(1/n._horizonShift);if(!n.elevation||n.elevation.exaggeration()===0){let v=Math.max(n.zoom-17,0);n.isOrthographic&&(v/=10),f*=1+v}return Math.min(1.01*f,_)}function Hm(n,e){if(!e.isReprojectedInTileSpace)return{scale:1<<n.z,x:n.x,y:n.y,x2:n.x+1,y2:n.y+1,projection:e};const i=Math.pow(2,-n.z),o=n.x*i,l=(n.x+1)*i,d=n.y*i,f=(n.y+1)*i,_=M(o),v=M(l),b=z(d),E=z(f),I=e.project(_,b),C=e.project(v,b),R=e.project(v,E),k=e.project(_,E);let F=Math.min(I.x,C.x,R.x,k.x),U=Math.min(I.y,C.y,R.y,k.y),j=Math.max(I.x,C.x,R.x,k.x),H=Math.max(I.y,C.y,R.y,k.y);const W=i/16;function Y(ie,ce,fe,ge,Fe,be){const Ue=(fe+Fe)/2,He=(ge+be)/2,qe=e.project(M(Ue),z(He)),tt=Math.max(0,F-qe.x,U-qe.y,qe.x-j,qe.y-H);F=Math.min(F,qe.x),j=Math.max(j,qe.x),U=Math.min(U,qe.y),H=Math.max(H,qe.y),tt>W&&(Y(ie,qe,fe,ge,Ue,He),Y(qe,ce,Ue,He,Fe,be))}Y(I,C,o,d,l,d),Y(C,R,l,d,l,f),Y(R,k,l,f,o,f),Y(k,I,o,f,o,d),F-=W,U-=W,j+=W,H+=W;const se=1/Math.max(j-F,H-U);return{scale:se,x:F*se,y:U*se,x2:j*se,y2:H*se,projection:e}}function F2(n,{x:e,y:i},o=0){return new et(((e-o)*n.scale-n.x)*dt,(i*n.scale-n.y)*dt)}const $k=ct(new Float32Array(16));class Zc{constructor(e){this.spec=e,this.name=e.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(e,i){return{x:0,y:0,z:0}}unproject(e,i){return new r(0,0)}projectTilePoint(e,i,o){return{x:e,y:i,z:0}}locationPoint(e,i,o,l=!0){return e._coordinatePoint(e.locationCoordinate(i,o),l)}pixelsPerMeter(e,i){return A(1,e)*i}pixelSpaceConversion(e,i,o){return 1}farthestPixelDistance(e){return O2(e,e.pixelsPerMeter)}pointCoordinate(e,i,o,l){const d=e.horizonLineFromTop(!1),f=new et(i,Math.max(d,o));return e.rayIntersectionCoordinate(e.pointRayIntersection(f,l))}pointCoordinate3D(e,i,o){const l=new et(i,o);if(e.elevation)return e.elevation.pointCoordinate(l);{const d=this.pointCoordinate(e,l.x,l.y,0);return[d.x,d.y,d.z]}}isPointAboveHorizon(e,i){if(e.elevation&&e.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(e,i.x,i.y);const o=e.horizonLineFromTop();return i.y<o}createInversionMatrix(e,i){return $k}createTileMatrix(e,i,o){let l,d,f;const _=o.canonical,v=ct(new Float64Array(16));if(this.isReprojectedInTileSpace){const b=Hm(_,this);l=1,d=b.x+o.wrap*b.scale,f=b.y,Ze(v,v,[l/b.scale,l/b.scale,e.pixelsPerMeter/i])}else l=i/e.zoomScale(_.z),d=(_.x+Math.pow(2,_.z)*o.wrap)*l,f=_.y*l;return Pe(v,v,[d,f,0]),Ze(v,v,[l/dt,l/dt,1]),v}upVector(e,i,o){return[0,0,1]}upVectorScale(e,i,o){return{metersToTile:1}}}class Gk extends Zc{constructor(e){super(e),this.range=[4,7],this.center=e.center||[-96,37.5];const[i,o]=this.parallels=e.parallels||[29.5,45.5],l=Math.sin(Oi(i));this.n=(l+Math.sin(Oi(o)))/2,this.c=1+l*(2*this.n-l),this.r0=Math.sqrt(this.c)/this.n}project(e,i){const{n:o,c:l,r0:d}=this,f=Oi(e-this.center[0]),_=Oi(i),v=Math.sqrt(l-2*o*Math.sin(_))/o;return{x:v*Math.sin(f*o),y:v*Math.cos(f*o)-d,z:0}}unproject(e,i){const{n:o,c:l,r0:d}=this,f=d+i;let _=Math.atan2(e,Math.abs(f))*Math.sign(f);f*o<0&&(_-=Math.PI*Math.sign(e)*Math.sign(f));const v=Oi(this.center[0])*o;_=ee(_,-Math.PI-v,Math.PI-v);const b=V(Kr(_/o)+this.center[0],-180,180),E=Math.asin(V((l-(e*e+f*f)*o*o)/(2*o),-1,1)),I=V(Kr(E),-D,D);return new r(b,I)}}const qm=1.340264,Wm=-.081106,Zm=893e-6,Xm=.003796,$y=Math.sqrt(3)/2;class Hk extends Zc{project(e,i){i=i/180*Math.PI,e=e/180*Math.PI;const o=Math.asin($y*Math.sin(i)),l=o*o,d=l*l*l;return{x:.5*(e*Math.cos(o)/($y*(qm+3*Wm*l+d*(7*Zm+9*Xm*l)))/Math.PI+.5),y:1-.5*(o*(qm+Wm*l+d*(Zm+Xm*l))/Math.PI+1),z:0}}unproject(e,i){e=(2*e-.5)*Math.PI;let o=i=(2*(1-i)-1)*Math.PI,l=o*o,d=l*l*l;for(let E,I,C,R=0;R<12&&(I=o*(qm+Wm*l+d*(Zm+Xm*l))-i,C=qm+3*Wm*l+d*(7*Zm+9*Xm*l),E=I/C,o=V(o-E,-Math.PI/3,Math.PI/3),l=o*o,d=l*l*l,!(Math.abs(E)<1e-12));++R);const f=$y*e*(qm+3*Wm*l+d*(7*Zm+9*Xm*l))/Math.cos(o),_=Math.asin(Math.sin(o)/$y),v=V(180*f/Math.PI,-180,180),b=V(180*_/Math.PI,-D,D);return new r(v,b)}}class qk extends Zc{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0}project(e,i){return{x:.5+e/360,y:.5-i/360,z:0}}unproject(e,i){const o=360*(e-.5),l=V(360*(.5-i),-D,D);return new r(o,l)}}const gf=Math.PI/2;function Gy(n){return Math.tan((gf+n)/2)}class Wk extends Zc{constructor(e){super(e),this.center=e.center||[0,30];const[i,o]=this.parallels=e.parallels||[30,30];let l=Oi(i),d=Oi(o);this.southernCenter=l+d<0,this.southernCenter&&(l=-l,d=-d);const f=Math.cos(l),_=Gy(l);this.n=l===d?Math.sin(l):Math.log(f/Math.cos(d))/Math.log(Gy(d)/_),this.f=f*Math.pow(Gy(l),this.n)/this.n}project(e,i){i=Oi(i),this.southernCenter&&(i=-i),e=Oi(e-this.center[0]);const o=1e-6,{n:l,f:d}=this;d>0?i<-gf+o&&(i=-gf+o):i>gf-o&&(i=gf-o);const f=d/Math.pow(Gy(i),l);let _=f*Math.sin(l*e),v=d-f*Math.cos(l*e);return _=.5*(_/Math.PI+.5),v=.5*(v/Math.PI+.5),{x:_,y:this.southernCenter?v:1-v,z:0}}unproject(e,i){e=(2*e-.5)*Math.PI,this.southernCenter&&(i=1-i),i=(2*(1-i)-.5)*Math.PI;const{n:o,f:l}=this,d=l-i,f=Math.sign(d),_=Math.sign(o)*Math.sqrt(e*e+d*d);let v=Math.atan2(e,Math.abs(d))*f;d*o<0&&(v-=Math.PI*Math.sign(e)*f);const b=V(Kr(v/o)+this.center[0],-180,180),E=V(Kr(2*Math.atan(Math.pow(l/_,1/o))-gf),-D,D);return new r(b,this.southernCenter?-E:E)}}class B2 extends Zc{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(e,i){return{x:w(e),y:T(i),z:0}}unproject(e,i){const o=M(e),l=z(i);return new r(o,l)}}const N2=Oi(D);class Zk extends Zc{project(e,i){const o=(i=Oi(i))*i,l=o*o;return{x:.5*((e=Oi(e))*(.8707-.131979*o+l*(l*(.003971*o-.001529*l)-.013791))/Math.PI+.5),y:1-.5*(i*(1.007226+o*(.015085+l*(.028874*o-.044475-.005916*l)))/Math.PI+1),z:0}}unproject(e,i){e=(2*e-.5)*Math.PI;let o=i=(2*(1-i)-1)*Math.PI,l=25,d=0,f=o*o;do{f=o*o;const b=f*f;d=(o*(1.007226+f*(.015085+b*(.028874*f-.044475-.005916*b)))-i)/(1.007226+f*(.045255+b*(.259866*f-.311325-.005916*11*b))),o=V(o-d,-N2,N2)}while(Math.abs(d)>1e-6&&--l>0);f=o*o;const _=V(Kr(e/(.8707+f*(f*(f*f*f*(.003971-.001529*f)-.013791)-.131979))),-180,180),v=Kr(o);return new r(_,v)}}const j2=Oi(D);class Xk extends Zc{project(e,i){i=Oi(i),e=Oi(e);const o=Math.cos(i),l=2/Math.PI,d=Math.acos(o*Math.cos(e/2)),f=Math.sin(d)/d,_=.5*(e*l+2*o*Math.sin(e/2)/f)||0,v=.5*(i+Math.sin(i)/f)||0;return{x:.5*(_/Math.PI+.5),y:1-.5*(v/Math.PI+1),z:0}}unproject(e,i){let o=e=(2*e-.5)*Math.PI,l=i=(2*(1-i)-1)*Math.PI,d=25;const f=1e-6;let _=0,v=0;do{const b=Math.cos(l),E=Math.sin(l),I=2*E*b,C=E*E,R=b*b,k=Math.cos(o/2),F=Math.sin(o/2),U=2*k*F,j=F*F,H=1-R*k*k,W=H?1/H:0,Y=H?Math.acos(b*k)*Math.sqrt(1/H):0,se=.5*(2*Y*b*F+2*o/Math.PI)-e,ie=.5*(Y*E+l)-i,ce=.5*W*(R*j+Y*b*k*C)+1/Math.PI,fe=W*(U*I/4-Y*E*F),ge=.125*W*(I*F-Y*E*R*U),Fe=.5*W*(C*k+Y*j*b)+.5,be=fe*ge-Fe*ce;_=(ie*fe-se*Fe)/be,v=(se*ge-ie*ce)/be,o=V(o-_,-Math.PI,Math.PI),l=V(l-v,-j2,j2)}while((Math.abs(_)>f||Math.abs(v)>f)&&--d>0);return new r(Kr(o),Kr(l))}}class U2 extends Zc{constructor(e){super(e),this.center=e.center||[0,0],this.parallels=e.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(Oi(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(e,i){const{scale:o,cosPhi:l}=this;return{x:Oi(e)*l*o+.5,y:-Math.sin(Oi(i))/l*o+.5,z:0}}unproject(e,i){const{scale:o,cosPhi:l}=this,d=-(i-.5)/o,f=V(Kr((e-.5)/o)/l,-180,180),_=Math.asin(V(d*l,-1,1)),v=V(Kr(_),-D,D);return new r(f,v)}}class Kk extends B2{constructor(e){super(e),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(e,i,o){const l=xm(e,i,o);return Kn(l,l,py(Ts(o))),{x:l[0],y:l[1],z:l[2]}}locationPoint(e,i,o){const l=Uc(i.lat,i.lng),d=yn([],l),f=o?e._centerAltitude+o:e.elevation?e.elevation.getAtPointOrZero(e.locationCoordinate(i),e._centerAltitude):e._centerAltitude;Er(l,l,d,A(1,0)*dt*f);const _=ct(new Float64Array(16));return xe(_,e.pixelMatrix,e.globeMatrix),Kn(l,l,_),new et(l[0],l[1])}pixelsPerMeter(e,i){return A(1,0)*i}pixelSpaceConversion(e,i,o){const l=A(1,e)*i,d=Kt(A(1,45)*i,l,o);return this.pixelsPerMeter(e,i)/d}createTileMatrix(e,i,o){const l=dx(Ts(o.canonical));return xe(new Float64Array(16),e.globeMatrix,l)}createInversionMatrix(e,i){const{center:o}=e,l=py(Ts(i));return kt(l,l,Oi(o.lng)),Ct(l,l,Oi(o.lat)),Ze(l,l,[e._pixelsPerMercatorPixel,e._pixelsPerMercatorPixel,1]),Float32Array.from(l)}pointCoordinate(e,i,o,l){return $c(e,i,o,!0)||new X(0,0)}pointCoordinate3D(e,i,o){const l=this.pointCoordinate(e,i,o,0);return[l.x,l.y,l.z]}isPointAboveHorizon(e,i){return!$c(e,i.x,i.y,!1)}farthestPixelDistance(e){const i=function(l,d){const f=l.cameraToCenterDistance,_=l._centerAltitude*d,v=l._camera,b=l._camera.forward(),E=$t([],gn([],b,-f),[0,0,_]),I=l.worldSize/(2*Math.PI),C=[0,0,-I],R=l.width/l.height,k=Math.tan(l.fovAboveCenter),F=gn([],v.up(),k),U=gn([],v.right(),k*R),j=yn([],$t([],$t([],b,F),U)),H=[];let W;if(new At(E,j).closestPointOnSphere(C,I,H)){const Y=$t([],H,C),se=Qn([],Y,E);W=Math.cos(l.fovAboveCenter)*pr(se)}else{const Y=Qn([],E,C),se=Qn([],C,E);yn(se,se);const ie=pr(Y)-I;W=Math.sqrt(ie*(ie+2*I));const ce=Math.acos(W/(I+ie))-Math.acos(qn(b,se));W*=Math.cos(ce)}return 1.01*W}(e,this.pixelsPerMeter(e.center.lat,e.worldSize)),o=Gc(e.zoom);if(o>0){const l=O2(e,A(1,e.center.lat)*e.worldSize),d=e.worldSize/(2*Math.PI),f=Math.max(e.width,e.height)/e.worldSize*Math.PI;return Kt(i,l+d*(1-Math.cos(f)),Math.pow(o,10))}return i}upVector(e,i,o){return xm(i,o,e,1)}upVectorScale(e){return{metersToTile:Ws(fy(Ts(e)))}}}function V2(n){const e=n.parallels,i=!!e&&Math.abs(e[0]+e[1])<.01;switch(n.name){case"mercator":return new B2(n);case"equirectangular":return new qk(n);case"naturalEarth":return new Zk(n);case"equalEarth":return new Hk(n);case"winkelTripel":return new Xk(n);case"albers":return i?new U2(n):new Gk(n);case"lambertConformalConic":return i?new U2(n):new Wk(n);case"globe":return new Kk(n)}throw new Error(`Invalid projection name: ${n.name}`)}const Yk=ye.types,Jk=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Km(n,e,i,o,l,d,f,_,v,b,E,I,C){const R=_?Math.min(tc,Math.round(_[0])):0,k=_?Math.min(tc,Math.round(_[1])):0;n.emplaceBack(e,i,Math.round(32*o),Math.round(32*l),d,f,(R<<1)+(v?1:0),0+(k<<1),16*b,16*E,256*I,256*C)}function Ym(n,e,i){n.emplaceBack(e,i)}function Jm(n,e,i,o,l,d,f){n.emplaceBack(e,i,o,l,d,f)}const Hy=(n,e,i,o)=>{for(let l=0;l<e;l++)n.emplaceBack(i[0],i[1],i[2],o[0],o[1],o[2])};function yf(n,e,i,o,l){n.emplaceBack(e,i,o,l),n.emplaceBack(e,i,o,l),n.emplaceBack(e,i,o,l),n.emplaceBack(e,i,o,l)}function Qk(n){for(const e of n.sections)if(Kv(e.text))return!0;return!1}class l1{constructor(e){this.layoutVertexArray=new nm,this.indexArray=new sr,this.programConfigurations=e,this.segments=new An,this.dynamicLayoutVertexArray=new ll,this.opacityVertexArray=new jd,this.placedSymbolArray=new sy,this.iconTransitioningVertexArray=new Bo,this.globeExtVertexArray=new rm,this.zOffsetVertexArray=new _a,this.orientationVertexArray=new am,this.symbolInstanceIndices=[]}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0&&this.iconTransitioningVertexArray.length===0}getIconVertexData(e,i){const o=[],l=this.layoutVertexArray.uint16;for(let d=0;d<i;++d){const f=12*(e+d);o.push(...l.slice(f,f+12))}return o}updateIconVertexData(e,i,o,l,d,f,_,v,b,E,I,C,R){const k=this.layoutVertexArray.uint16,F=12*e;k[F]=i,k[F+1]=o,k[F+2]=l,k[F+3]=d,k[F+4]=f,k[F+5]=_,k[F+6]=v,k[F+7]=b,k[F+8]=E,k[F+9]=I,k[F+10]=C,k[F+11]=R}upload(e,i,o,l,d,f){this.isEmpty()||(o&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,tk.members,!!f),this.indexBuffer=e.createIndexBuffer(this.indexArray,i),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,nk.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,Jk,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=e.createVertexBuffer(this.iconTransitioningVertexArray,sk.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,ik.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||d)&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,rk.members,!0)),!this.orientationVertexBuffer&&this.orientationVertexArray&&this.orientationVertexArray.length>0&&(this.orientationVertexBuffer=e.createVertexBuffer(this.orientationVertexArray,ok.members,!0)),this.opacityVertexBuffer.itemSize=1),(o||l)&&this.programConfigurations.upload(e))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.orientationVertexBuffer&&this.orientationVertexBuffer.destroy())}}It(l1,"SymbolBuffers");class c1{constructor(e,i,o){this.layoutVertexArray=new e,this.layoutAttributes=i,this.indexArray=new o,this.segments=new An,this.collisionVertexArray=new om,this.collisionVertexArrayExt=new ll}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,ak.members,!0),this.collisionVertexBufferExt=e.createVertexBuffer(this.collisionVertexArrayExt,lk.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}It(c1,"CollisionBuffers");class qy{constructor(e){this.collisionBoxArray=e.collisionBoxArray,this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(f=>f.fqid),this.index=e.index,this.pixelRatio=e.pixelRatio,this.sourceLayerIndex=e.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=ct([]),this.placementViewportMatrix=ct([]);const i=this.layers[0]._unevaluatedLayout._values;this.worldview=e.worldview,this.localizable=e.localizable,this.textSizeData=ff(this.zoom,i["text-size"],this.worldview),this.iconSizeData=ff(this.zoom,i["icon-size"],this.worldview);const o=this.layers[0].layout,l=o.get("symbol-sort-key"),d=o.get("symbol-z-order");this.lut=e.lut,this.canOverlap=o.get("text-allow-overlap")||o.get("icon-allow-overlap")||o.get("text-ignore-placement")||o.get("icon-ignore-placement"),this.sortFeaturesByKey=d!=="viewport-y"&&l.constantOr(1)!==void 0,this.sortFeaturesByY=(d==="viewport-y"||d==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=o.get("text-writing-mode").map(f=>Uo[f]),this.stateDependentLayerIds=this.layers.filter(f=>f.isStateDependent()).map(f=>f.id),this.sourceID=e.sourceID,this.projection=e.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=!1,this.elevationType="none",this.elevationStateComplete=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.hasAnySecondaryIcon=!1,this.hasAppearances=null,this.lastActiveApperance=null,this.featureToAppearanceIndex={}}hasAnyAppearanceProperty(e){const i=this.layers[0].getAppearances();return!(!i||i.length===0)&&i.some(o=>o.getProperty(e)!=null)}createArrays(){this.text=new l1(new ws(this.layers,{zoom:this.zoom,lut:this.lut},e=>e.startsWith("text")||e.startsWith("symbol"))),this.icon=new l1(new ws(this.layers,{zoom:this.zoom,lut:this.lut},e=>e.startsWith("icon")||e.startsWith("symbol"))),this.glyphOffsetArray=new Zd,this.lineVertexArray=new ly,this.symbolInstances=new dm}calculateGlyphDependencies(e,i,o,l,d){for(const f of e){const _=f.codePointAt(0);if(_===void 0)break;if(i[_]=!0,l&&d&&_<=65535){const v=Nm[f];v&&(i[v.charCodeAt(0)]=!0)}}}calculateEffectiveAppearanceIconSize(e,i,o,l,d,f){let _=1;const v=e.getUnevaluatedProperties()._values["icon-size"],b=ff(this.zoom,v,this.worldview),E=pf(b,i);if(b.kind!=="constant"&&b.kind!=="camera"||(_=E.uSize),b.kind==="composite"){const{minZoom:I,maxZoom:C}=b,R=v.possiblyEvaluate(new fn(I,{worldview:this.worldview}),l),k=v.possiblyEvaluate(new fn(C,{worldview:this.worldview}),l),F=R.evaluate(o,{},l,d);_=F+(k.evaluate(o,{},l,d)-F)*E.uSizeT}return b.kind==="source"&&(_=v.possiblyEvaluate(new fn(this.zoom,{worldview:this.worldview}),l).evaluate(o,{},l,d)),_*f}updateFootprints(e,i){}updateReplacement(e,i){if(i.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=i.updateTime;const o=i.getReplacementRegionsForTile(e.toUnwrapped(),!0);return!xy(this.activeReplacements,o)&&(this.activeReplacements=o,!0)}getResolvedImageFromTokens(e){return typeof e=="string"?oo.build(e):e}populate(e,i,o,l){const d=this.layers[0],f=d.layout,_=this.projection.name==="globe",v=f.get("text-font"),b=f.get("text-field"),E=f.get("icon-image"),[I,C]=f.get("icon-size-scale-range"),R=V(i.scaleFactor||1,I,C),k=(b.value.kind!=="constant"||b.value.value instanceof ro&&!b.value.value.isEmpty()||b.value.value.toString().length>0)&&(v.value.kind!=="constant"||v.value.value.length>0),F=E.value.kind!=="constant"||!!E.value.value||Object.keys(E.parameters).length>0,U=this.hasAnyAppearanceProperty("icon-image"),j=f.get("symbol-sort-key");if(this.features=[],this.appearanceFeatureData=[],!k&&!F&&!U)return;const H=i.iconDependencies,W=i.glyphDependencies,Y=i.availableImages,se=new fn(this.zoom,{worldview:this.worldview,activeFloors:i.activeFloors}),ie=ce=>{const fe=ce.id.toString();H.has(fe)?H.get(fe).push(ce):H.set(fe,[ce])};for(const ce of e){const{feature:fe,id:ge,index:Fe,sourceLayerIndex:be}=ce,Ue=d._featureFilter.needGeometry,He=we(fe,Ue);if(!d._featureFilter.filter(se,He,o))continue;if(Ue||(He.geometry=he(fe,o,l)),_&&fe.type!==1&&o.z<=5){const Qe=He.geometry,ft=.98078528056,at=(Ot,xt)=>qn(xm(Ot.x,Ot.y,o,1),xm(xt.x,xt.y,o,1))<ft;for(let Ot=0;Ot<Qe.length;Ot++)Qe[Ot]=oe(Qe[Ot],at)}let qe,tt;if(k){const Qe=d.getValueAndResolveTokens("text-field",He,o,Y),ft=ro.factory(Qe);Qk(ft)&&(this.hasRTLText=!0),(!this.hasRTLText||Yu()==="unavailable"||this.hasRTLText&&ma.isParsed())&&(qe=uk(ft,d,He))}if(F){const Qe=d.getValueAndResolveTokens("icon-image",He,o,Y);tt=this.getResolvedImageFromTokens(Qe)}const nt=this.layers[0];let Ye=!1;if(!tt&&U){const Qe=nt.getAppearances();for(const ft of Qe)if(ft.getProperty("icon-image")){const at=nt.getAppearanceValueAndResolveTokens(ft,"icon-image",He,o,Y);if(at){tt=this.getResolvedImageFromTokens(at),Ye=!0;break}}}if(!qe&&!tt)continue;const Je=this.sortFeaturesByKey?j.evaluate(He,{},o):void 0,je={id:ge,text:qe,icon:tt,index:Fe,sourceLayerIndex:be,geometry:He.geometry,properties:fe.properties,type:Yk[fe.type],sortKey:Je};if(this.features.push(je),this.featureToAppearanceIndex[Fe]=this.appearanceFeatureData.length,this.appearanceFeatureData.push({id:ge,properties:fe.properties,usesAppearanceIconAsPlaceholder:Ye,isUsingAppearanceVertexData:!1,layoutBasedVertexData:[],activeAppearance:null}),tt){const Qe=nt._unevaluatedLayout._values,{iconPrimary:ft,iconSecondary:at}=$m(tt,this.iconSizeData,Qe["icon-size"],o,this.zoom,je,this.pixelRatio,R,this.worldview);ie(ft),at&&(this.hasAnySecondaryIcon=!0,ie(at))}const Be=nt.getAppearances();if(Be.length!==0&&Be.forEach(Qe=>{if(!Qe.getProperty("icon-image"))return;const ft=this.getCombinedIconPrimary(Qe,nt,He,o,Y,je,R);ft&&ie(ft)}),qe){const Qe=v.evaluate(He,{},o).join(","),ft=f.get("text-rotation-alignment")==="map"&&f.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(Uo.vertical)>=0;for(const at of qe.sections)if(at.image){const Ot=at.image.getPrimary().scaleSelf(this.pixelRatio),xt=Ot.id.toString(),St=H.get(xt)||[];St.push(Ot),H.set(xt,St)}else{const Ot=Xu(qe.toString()),xt=at.fontStack||Qe,St=W[xt]=W[xt]||{};this.calculateGlyphDependencies(at.text,St,ft,this.allowVerticalPlacement,Ot)}}}if(f.get("symbol-placement")==="line"&&(this.features=function(ce){const fe={},ge={},Fe=[];let be=0;function Ue(nt){Fe.push(ce[nt]),be++}function He(nt,Ye,Je){const je=ge[nt];return delete ge[nt],ge[Ye]=je,Fe[je].geometry[0].pop(),Fe[je].geometry[0]=Fe[je].geometry[0].concat(Je[0]),je}function qe(nt,Ye,Je){const je=fe[Ye];return delete fe[Ye],fe[nt]=je,Fe[je].geometry[0].shift(),Fe[je].geometry[0]=Je[0].concat(Fe[je].geometry[0]),je}function tt(nt,Ye,Je){const je=Je?Ye[0][Ye[0].length-1]:Ye[0][0];return`${nt}:${je.x}:${je.y}`}for(let nt=0;nt<ce.length;nt++){const Ye=ce[nt],Je=Ye.geometry,je=Ye.text?Ye.text.toString():null;if(!je){Ue(nt);continue}const Be=tt(je,Je),Qe=tt(je,Je,!0);if(Be in ge&&Qe in fe&&ge[Be]!==fe[Qe]){const ft=qe(Be,Qe,Je),at=He(Be,Qe,Fe[ft].geometry);delete fe[Be],delete ge[Qe],ge[tt(je,Fe[at].geometry,!0)]=at,Fe[ft].geometry=null}else Be in ge?He(Be,Qe,Je):Qe in fe?qe(Be,Qe,Je):(Ue(nt),fe[Be]=be-1,ge[Qe]=be-1)}return Fe.filter(nt=>nt.geometry)}(this.features)),f.get("symbol-elevation-reference")==="hd-road-markup"){if(this.elevationType="road",i.elevationFeatures){!this.elevationFeatures&&i.elevationFeatures.length>0&&(this.elevationFeatures=[],this.elevationFeatureIdToIndex=new Map);for(const ce of i.elevationFeatures)this.elevationFeatureIdToIndex.set(ce.id,this.elevationFeatures.length),this.elevationFeatures.push(ce)}}else f.get("symbol-z-elevate")&&(this.elevationType="offset");this.elevationType!=="none"&&(this.zOffsetBuffersNeedUpload=!0),this.sortFeaturesByKey&&this.features.sort((ce,fe)=>ce.sortKey-fe.sortKey)}getCombinedIconPrimary(e,i,o,l,d,f,_){let v,b;const E=e.getUnevaluatedProperties();if(E._values["icon-image"].value!==void 0){const I=i.getAppearanceValueAndResolveTokens(e,"icon-image",o,l,d);v=this.getResolvedImageFromTokens(I)}else{const I=i.getValueAndResolveTokens("icon-image",o,l,d);v=this.getResolvedImageFromTokens(I)}if(v){const I=E._values["icon-size"]||i._unevaluatedLayout._values["icon-size"];b=$m(v,ff(this.zoom,I,this.worldview),I,l,this.zoom,f,this.pixelRatio,_,this.worldview).iconPrimary}return b}updateAppearanceBasedIconTextures(e,i,o,l){if(!this.appearanceFeatureData||!this.icon.layoutVertexArray||this.icon.layoutVertexArray.length===0)return!1;const d=this.layers[0];let f=!1,_=0;const v=d.layout,[b,E]=v.get("icon-size-scale-range"),I=V(1,b,E);for(let C=0;C<this.symbolInstances.length;C++){const R=this.symbolInstances.get(C),k=this.featureToAppearanceIndex[R.featureIndex],F=k!==void 0?this.appearanceFeatureData[k]:void 0;if(F&&R.placedIconSymbolIndex>=0){const U=F.id,j=i&&U!==void 0?i[String(U)]:void 0,H={type:"Point",id:F.id,properties:F.properties,geometry:[]},W=this.layers[0].appearances&&this.layers[0].appearances.find(Y=>Y.isActive({globals:l,feature:H,canonical:e,featureState:j}));if(F.activeAppearance===W){_+=R.numIconVertices;continue}if(W){F.activeAppearance=W;const Y=this.getCombinedIconPrimary(W,d,H,e,o,{sortKey:void 0,text:void 0,icon:null,index:R.featureIndex,sourceLayerIndex:R.featureIndex,geometry:[],properties:F.properties,type:"Point",id:F.id},I);if(!Y)continue;const se=Y.toString(),ie=this.iconAtlasPositions&&this.iconAtlasPositions.get(se);if(ie){const ce=d.getAppearanceValueAndResolveTokens(W,"icon-offset",H,e,o),fe=ce&&Array.isArray(ce)?ce:[0,0];let ge=Oy(ie,void 0,fe,d.layout.get("icon-anchor").evaluate(H,{},e));const Fe=d.getAppearanceValueAndResolveTokens(W,"icon-rotate",H,e,o),be=typeof Fe=="number"?Fe:0,Ue=ie.sdf,He=d.layout.get("icon-text-fit").constantOr("none");He!=="none"&&F.textShaping&&F.iconTextFitPadding&&F.fontScale&&(ge=e1(ge,F.textShaping,He,F.iconTextFitPadding,fe,F.fontScale));const qe=this.calculateEffectiveAppearanceIconSize(W,l.zoom,H,e,o,I),tt=0,nt=1+(Math.min(tc,Math.round(qe*Ea))<<1),Ye=r1(ge,be,Ue,He!=="none",I);F.isUsingAppearanceVertexData||(F.isUsingAppearanceVertexData=!0,F.layoutBasedVertexData=this.icon.getIconVertexData(_,R.numIconVertices));for(let je=0;je<Ye.length;++je){const Be=Ye[je],Qe=F.layoutBasedVertexData[0]||R.tileAnchorX,ft=F.layoutBasedVertexData[1]||R.tileAnchorY,at=16*Be.pixelOffsetTL.x,Ot=16*Be.pixelOffsetTL.y,xt=16*Be.pixelOffsetBR.x,St=16*Be.pixelOffsetBR.y,Pt=16*Be.minFontScaleX,pi=16*Be.minFontScaleY;this.icon.updateIconVertexData(_,Qe,ft,Math.round(32*Be.tl.x),Math.round(32*Be.tl.y),Be.texPrimary.x,Be.texPrimary.y,tt,nt,at,Ot,Pt,pi),this.icon.updateIconVertexData(_+1,Qe,ft,Math.round(32*Be.tr.x),Math.round(32*Be.tr.y),Be.texPrimary.x+Be.texPrimary.w,Be.texPrimary.y,tt,nt,xt,Ot,Pt,pi),this.icon.updateIconVertexData(_+2,Qe,ft,Math.round(32*Be.bl.x),Math.round(32*Be.bl.y),Be.texPrimary.x,Be.texPrimary.y+Be.texPrimary.h,tt,nt,at,St,Pt,pi),this.icon.updateIconVertexData(_+3,Qe,ft,Math.round(32*Be.br.x),Math.round(32*Be.br.y),Be.texPrimary.x+Be.texPrimary.w,Be.texPrimary.y+Be.texPrimary.h,tt,nt,xt,St,Pt,pi),_+=4}const Je=R.numIconVertices-4*Ye.length;for(let je=0;je<Je;++je)this.icon.updateIconVertexData(_+je,0,0,0,0,0,0,0,0,0,0,0,0);f=!0}else _+=R.numIconVertices}else if(F.usesAppearanceIconAsPlaceholder)this.layers[0].appearances&&this.layers[0].appearances.length>0&&(this.icon.updateIconVertexData(_,0,0,0,0,0,0,0,0,0,0,0,0),this.icon.updateIconVertexData(_+1,0,0,0,0,0,0,0,0,0,0,0,0),this.icon.updateIconVertexData(_+2,0,0,0,0,0,0,0,0,0,0,0,0),this.icon.updateIconVertexData(_+3,0,0,0,0,0,0,0,0,0,0,0,0),f=!0),_+=R.numIconVertices,F.activeAppearance=null;else if(F.isUsingAppearanceVertexData){const se=F.layoutBasedVertexData.length/12;for(let ie=0;ie<se;++ie){const ce=ie*12;this.icon.updateIconVertexData(_+ie,F.layoutBasedVertexData[ce+0],F.layoutBasedVertexData[ce+1],F.layoutBasedVertexData[ce+2],F.layoutBasedVertexData[ce+3],F.layoutBasedVertexData[ce+4],F.layoutBasedVertexData[ce+5],F.layoutBasedVertexData[ce+6],F.layoutBasedVertexData[ce+7],F.layoutBasedVertexData[ce+8],F.layoutBasedVertexData[ce+9],F.layoutBasedVertexData[ce+10],F.layoutBasedVertexData[ce+11])}_+=se,F.isUsingAppearanceVertexData=!1,F.activeAppearance=null,f=!0}else _+=R.numIconVertices,F.activeAppearance=null}}return f}update(e,i,o,l,d,f,_){this.text.programConfigurations.updatePaintArrays(e,i,d,o,l,f,_,this.worldview),this.icon.programConfigurations.updatePaintArrays(e,i,d,o,l,f,_,this.worldview)}updateRoadElevation(e){if(this.elevationType!=="road"||!this.elevationFeatures||this.elevationStateComplete)return;this.elevationStateComplete=!0,this.hasAnyZOffset=!1;let i=!1;const o=$(e),l=1/o;let d=!1,f=!1;for(let _=0;_<this.symbolInstances.length;_++){const v=this.symbolInstances.get(_),b=In(1,0,0),E=In(0,1,0),{numHorizontalGlyphVertices:I,numVerticalGlyphVertices:C,numIconVertices:R,numVerticalIconVertices:k}=v,F=I>0||C>0,U=R>0,j=this.elevationFeatures[v.elevationFeatureIndex];if(j){const H=new et(v.tileAnchorX,v.tileAnchorY),W=.075+j.pointElevation(H);v.zOffset!==W&&(i=!0,v.zOffset=W),W!==0&&(this.hasAnyZOffset=!0);const Y=j.computeSlopeNormal(H,l),se=_c(na(),In(0,0,1),Y);$a(b,b,se),$a(E,E,se),b[2]*=o,E[2]*=o,b[0]===1&&b[1]===0&&b[2]===0&&E[0]===0&&E[1]===1&&E[2]===0||(d=d||F,f=f||U)}if(F&&(Hy(this.text.orientationVertexArray,I,b,E),Hy(this.text.orientationVertexArray,C,b,E)),U){const{placedIconSymbolIndex:H,verticalPlacedIconSymbolIndex:W}=v;H>=0&&Hy(this.icon.orientationVertexArray,R,b,E),W>=0&&Hy(this.icon.orientationVertexArray,k,b,E)}}d||(this.text.orientationVertexArray=void 0),f||(this.icon.orientationVertexArray=void 0),i&&(this.zOffsetBuffersNeedUpload=!0,this.zOffsetSortDirty=!0)}updateZOffset(){const e=(d,f,_)=>{o+=f,o>d.length&&d.resize(o);for(let v=-f;v<0;v++)d.emplace(v+o,_)},i=(d,f,_)=>{l+=f,l>d.length&&d.resize(l);for(let v=-f;v<0;v++)d.emplace(v+l,_)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let o=0,l=0;for(let d=0;d<this.symbolInstances.length;d++){const f=this.symbolInstances.get(d),{numHorizontalGlyphVertices:_,numVerticalGlyphVertices:v,numIconVertices:b}=f,E=f.zOffset,I=b>0;if((_>0||v>0)&&(e(this.text.zOffsetVertexArray,_,E),e(this.text.zOffsetVertexArray,v,E)),I){const{placedIconSymbolIndex:C,verticalPlacedIconSymbolIndex:R}=f;C>=0&&i(this.icon.zOffsetVertexArray,b,E),R>=0&&i(this.icon.zOffsetVertexArray,f.numVerticalIconVertices,E)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(e,i,o,l,d){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload,!1),this.hasAppearances===null&&(this.hasAppearances=this.layers.some(f=>f.appearances&&f.appearances.length>0)),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload,this.hasAppearances),this.uploaded=!0}updateAppearances(e,i,o,l){return!!(e&&i&&o)&&!(!this.icon.layoutVertexArray||this.icon.layoutVertexArray.length===0)&&!!this.icon.layoutVertexArray.arrayBuffer&&void(this.updateAppearanceBasedIconTextures(e,i,o,l)&&this.icon.layoutVertexBuffer&&this.icon.layoutVertexArray.arrayBuffer!==null&&this.icon.layoutVertexArray.length===this.icon.layoutVertexBuffer.length&&this.icon.layoutVertexBuffer.updateData(this.icon.layoutVertexArray))}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=V2(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(e,i){const o=this.lineVertexArray.length;if(e.segment!==void 0)for(const{x:l,y:d}of i)this.lineVertexArray.emplaceBack(l,d);return{lineStartIndex:o,lineLength:this.lineVertexArray.length-o}}addSymbols(e,i,o,l,d,f,_,v,b,E,I,C,R,k,F,U,j,H){const W=e.indexArray,Y=e.layoutVertexArray,se=e.globeExtVertexArray,ie=e.segments.prepareSegment(4*H,Y,W,this.canOverlap?f.sortKey:void 0),ce=this.glyphOffsetArray.length,fe=ie.vertexLength,ge=this.allowVerticalPlacement&&_===Uo.vertical?Math.PI/2:0,Fe=f.text&&f.text.sections;for(let He=0;He<i.length;He++){const{tl:qe,tr:tt,bl:nt,br:Ye,texPrimary:Je,texSecondary:je,pixelOffsetTL:Be,pixelOffsetBR:Qe,minFontScaleX:ft,minFontScaleY:at,glyphOffset:Ot,isSDF:xt,sectionIndex:St}=i[He],Pt=ie.vertexLength,pi=Ot[1];if(Km(Y,b.x,b.y,qe.x,pi+qe.y,Je.x,Je.y,o,xt,Be.x,Be.y,ft,at),Km(Y,b.x,b.y,tt.x,pi+tt.y,Je.x+Je.w,Je.y,o,xt,Qe.x,Be.y,ft,at),Km(Y,b.x,b.y,nt.x,pi+nt.y,Je.x,Je.y+Je.h,o,xt,Be.x,Qe.y,ft,at),Km(Y,b.x,b.y,Ye.x,pi+Ye.y,Je.x+Je.w,Je.y+Je.h,o,xt,Qe.x,Qe.y,ft,at),v){const{x:lt,y:Mt,z:ei}=v.anchor,[bi,Si,oi]=v.up;Jm(se,lt,Mt,ei,bi,Si,oi),Jm(se,lt,Mt,ei,bi,Si,oi),Jm(se,lt,Mt,ei,bi,Si,oi),Jm(se,lt,Mt,ei,bi,Si,oi),yf(e.dynamicLayoutVertexArray,lt,Mt,ei,ge)}else yf(e.dynamicLayoutVertexArray,b.x,b.y,b.z,ge);if(U){const lt=je||Je;Ym(e.iconTransitioningVertexArray,lt.x,lt.y),Ym(e.iconTransitioningVertexArray,lt.x+lt.w,lt.y),Ym(e.iconTransitioningVertexArray,lt.x,lt.y+lt.h),Ym(e.iconTransitioningVertexArray,lt.x+lt.w,lt.y+lt.h)}W.emplaceBack(Pt,Pt+1,Pt+2),W.emplaceBack(Pt+1,Pt+2,Pt+3),ie.vertexLength+=4,ie.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(Ot[0]),He!==i.length-1&&St===i[He+1].sectionIndex||e.programConfigurations.populatePaintArrays(Y.length,f,f.index,{},R,k,F,Fe&&Fe[St],this.worldview)}const be=H-i.length;be!==0&&this._addNullVertices(be,Y,o,v,se,e,U,ie,W);const Ue=v?v.anchor:b;e.placedSymbolArray.emplaceBack(Ue.x,Ue.y,Ue.z,b.x,b.y,ce,this.glyphOffsetArray.length-ce,fe,E,I,b.segment,o?o[0]:0,o?o[1]:0,l[0],l[1],_,0,0,0,C,0),e.symbolInstanceIndices.push(j)}_addNullVertices(e,i,o,l,d,f,_,v,b){for(let E=0;E<e;E++){for(let C=0;C<4;C++)Km(i,0,0,0,0,0,0,o,!1,0,0,0,0),l&&Jm(d,0,0,0,0,0,0),yf(f.dynamicLayoutVertexArray,0,0,0,0),_&&Ym(f.iconTransitioningVertexArray,0,0);const I=v.vertexLength;b.emplaceBack(I,I+1,I+2),b.emplaceBack(I+1,I+2,I+3),v.vertexLength+=4,v.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(0)}}_commitLayoutVertex(e,i,o,l,d,f,_){e.emplaceBack(i,o,l,d,f,Math.round(_.x),Math.round(_.y))}_addCollisionDebugVertices(e,i,o,l,d,f,_){const v=o.segments.prepareSegment(4,o.layoutVertexArray,o.indexArray),b=v.vertexLength,E=_.tileAnchorX,I=_.tileAnchorY;for(let R=0;R<4;R++)o.collisionVertexArray.emplaceBack(0,0,0,0,0,0);this._commitDebugCollisionVertexUpdate(o.collisionVertexArrayExt,i,e.padding,_.zOffset),this._commitLayoutVertex(o.layoutVertexArray,l,d,f,E,I,new et(e.x1,e.y1)),this._commitLayoutVertex(o.layoutVertexArray,l,d,f,E,I,new et(e.x2,e.y1)),this._commitLayoutVertex(o.layoutVertexArray,l,d,f,E,I,new et(e.x2,e.y2)),this._commitLayoutVertex(o.layoutVertexArray,l,d,f,E,I,new et(e.x1,e.y2)),v.vertexLength+=4;const C=o.indexArray;C.emplaceBack(b,b+1),C.emplaceBack(b+1,b+2),C.emplaceBack(b+2,b+3),C.emplaceBack(b+3,b),v.primitiveLength+=4}_addTextDebugCollisionBoxes(e,i,o,l,d,f){for(let _=l;_<d;_++){const v=o.get(_),b=this.getSymbolInstanceTextSize(e,f,i,_);this._addCollisionDebugVertices(v,b,this.textCollisionBox,v.projectedAnchorX,v.projectedAnchorY,v.projectedAnchorZ,f)}}_addIconDebugCollisionBoxes(e,i,o,l,d,f){for(let _=l;_<d;_++){const v=o.get(_),b=this.getSymbolInstanceIconSize(e,i,f.placedIconSymbolIndex);this._addCollisionDebugVertices(v,b,this.iconCollisionBox,v.projectedAnchorX,v.projectedAnchorY,v.projectedAnchorZ,f)}}generateCollisionDebugBuffers(e,i,o){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new c1(Vd,s2.members,Bo),this.iconCollisionBox=new c1(Vd,s2.members,Bo);const l=pf(this.iconSizeData,e),d=pf(this.textSizeData,e,o);for(let f=0;f<this.symbolInstances.length;f++){const _=this.symbolInstances.get(f);this._addTextDebugCollisionBoxes(d,e,i,_.textBoxStartIndex,_.textBoxEndIndex,_),this._addTextDebugCollisionBoxes(d,e,i,_.verticalTextBoxStartIndex,_.verticalTextBoxEndIndex,_),this._addIconDebugCollisionBoxes(l,e,i,_.iconBoxStartIndex,_.iconBoxEndIndex,_),this._addIconDebugCollisionBoxes(l,e,i,_.verticalIconBoxStartIndex,_.verticalIconBoxEndIndex,_)}}getSymbolInstanceTextSize(e,i,o,l){const d=this.text.placedSymbolArray.get(i.rightJustifiedTextSymbolIndex>=0?i.rightJustifiedTextSymbolIndex:i.centerJustifiedTextSymbolIndex>=0?i.centerJustifiedTextSymbolIndex:i.leftJustifiedTextSymbolIndex>=0?i.leftJustifiedTextSymbolIndex:i.verticalPlacedTextSymbolIndex>=0?i.verticalPlacedTextSymbolIndex:l),f=t1(this.textSizeData,e,d)/br;return this.tilePixelRatio*f}getSymbolInstanceIconSize(e,i,o){const l=this.icon.placedSymbolArray.get(o),d=t1(this.iconSizeData,e,l);return this.tilePixelRatio*d}_commitDebugCollisionVertexUpdate(e,i,o,l){e.emplaceBack(i,-o,-o,l),e.emplaceBack(i,o,-o,l),e.emplaceBack(i,o,o,l),e.emplaceBack(i,-o,o,l)}_updateTextDebugCollisionBoxes(e,i,o,l,d,f,_){for(let v=l;v<d;v++){const b=o.get(v),E=this.getSymbolInstanceTextSize(e,f,i,v);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,E,b.padding,f.zOffset)}}_updateIconDebugCollisionBoxes(e,i,o,l,d,f,_){for(let v=l;v<d;v++){const b=o.get(v),E=this.getSymbolInstanceIconSize(e,i,f.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,E,b.padding,f.zOffset)}}updateCollisionDebugBuffers(e,i,o,l){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const d=pf(this.iconSizeData,e,l),f=pf(this.textSizeData,e,o);for(let _=0;_<this.symbolInstances.length;_++){const v=this.symbolInstances.get(_);this._updateTextDebugCollisionBoxes(f,e,i,v.textBoxStartIndex,v.textBoxEndIndex,v,o),this._updateTextDebugCollisionBoxes(f,e,i,v.verticalTextBoxStartIndex,v.verticalTextBoxEndIndex,v,o),this._updateIconDebugCollisionBoxes(d,e,i,v.iconBoxStartIndex,v.iconBoxEndIndex,v,l),this._updateIconDebugCollisionBoxes(d,e,i,v.verticalIconBoxStartIndex,v.verticalIconBoxEndIndex,v,l)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(e,i,o,l,d,f,_,v,b){const E={};if(i<o){const{x1:I,y1:C,x2:R,y2:k,padding:F,projectedAnchorX:U,projectedAnchorY:j,projectedAnchorZ:H,tileAnchorX:W,tileAnchorY:Y,featureIndex:se}=e.get(i);E.textBox={x1:I,y1:C,x2:R,y2:k,padding:F,projectedAnchorX:U,projectedAnchorY:j,projectedAnchorZ:H,tileAnchorX:W,tileAnchorY:Y},E.textFeatureIndex=se}if(l<d){const{x1:I,y1:C,x2:R,y2:k,padding:F,projectedAnchorX:U,projectedAnchorY:j,projectedAnchorZ:H,tileAnchorX:W,tileAnchorY:Y,featureIndex:se}=e.get(l);E.verticalTextBox={x1:I,y1:C,x2:R,y2:k,padding:F,projectedAnchorX:U,projectedAnchorY:j,projectedAnchorZ:H,tileAnchorX:W,tileAnchorY:Y},E.verticalTextFeatureIndex=se}if(f<_){const{x1:I,y1:C,x2:R,y2:k,padding:F,projectedAnchorX:U,projectedAnchorY:j,projectedAnchorZ:H,tileAnchorX:W,tileAnchorY:Y,featureIndex:se}=e.get(f);E.iconBox={x1:I,y1:C,x2:R,y2:k,padding:F,projectedAnchorX:U,projectedAnchorY:j,projectedAnchorZ:H,tileAnchorX:W,tileAnchorY:Y},E.iconFeatureIndex=se}if(v<b){const{x1:I,y1:C,x2:R,y2:k,padding:F,projectedAnchorX:U,projectedAnchorY:j,projectedAnchorZ:H,tileAnchorX:W,tileAnchorY:Y,featureIndex:se}=e.get(v);E.verticalIconBox={x1:I,y1:C,x2:R,y2:k,padding:F,projectedAnchorX:U,projectedAnchorY:j,projectedAnchorZ:H,tileAnchorX:W,tileAnchorY:Y},E.verticalIconFeatureIndex=se}return E}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let i=0;i<this.symbolInstances.length;i++){const o=this.symbolInstances.get(i);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,o.textBoxStartIndex,o.textBoxEndIndex,o.verticalTextBoxStartIndex,o.verticalTextBoxEndIndex,o.iconBoxStartIndex,o.iconBoxEndIndex,o.verticalIconBoxStartIndex,o.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(e,i){const o=e.placedSymbolArray.get(i),l=o.vertexStartIndex+4*o.numGlyphs;for(let d=o.vertexStartIndex;d<l;d+=4)e.indexArray.emplaceBack(d,d+1,d+2),e.indexArray.emplaceBack(d+1,d+2,d+3)}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const i=Math.sin(e),o=Math.cos(e),l=[],d=[],f=[];for(let _=0;_<this.symbolInstances.length;++_){f.push(_);const v=this.symbolInstances.get(_);l.push(0|Math.round(i*v.tileAnchorX+o*v.tileAnchorY)),d.push(v.featureIndex)}return f.sort((_,v)=>l[_]-l[v]||d[v]-d[_]),f}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let e=0;e<this.symbolInstances.length;++e)this.symbolInstanceIndexesSortedZOffset.push(e)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort((e,i)=>this.symbolInstances.get(i).zOffset-this.symbolInstances.get(e).zOffset)}addToSortKeyRanges(e,i){const o=this.sortKeyRanges[this.sortKeyRanges.length-1];o&&o.sortKey===i?o.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:i,symbolInstanceStart:e,symbolInstanceEnd:e+1})}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const i of this.symbolInstanceIndexes){const o=this.symbolInstances.get(i);this.featureSortOrder.push(o.featureIndex);const{rightJustifiedTextSymbolIndex:l,centerJustifiedTextSymbolIndex:d,leftJustifiedTextSymbolIndex:f,verticalPlacedTextSymbolIndex:_,placedIconSymbolIndex:v,verticalPlacedIconSymbolIndex:b}=o;l>=0&&this.addIndicesForPlacedSymbol(this.text,l),d>=0&&d!==l&&this.addIndicesForPlacedSymbol(this.text,d),f>=0&&f!==d&&f!==l&&this.addIndicesForPlacedSymbol(this.text,f),_>=0&&this.addIndicesForPlacedSymbol(this.text,_),v>=0&&this.addIndicesForPlacedSymbol(this.icon,v),b>=0&&this.addIndicesForPlacedSymbol(this.icon,b)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}getElevationFeatureForText(e){const i=this.symbolInstances.get(this.text.symbolInstanceIndices[e]).elevationFeatureIndex;let o;return this.elevationFeatures&&i<this.elevationFeatures.length&&(o=this.elevationFeatures[i]),o}}function $2(n,e){return e.replace(/{([^{}]+)}/g,(i,o)=>o in n?String(n[o]):"")}let G2,H2,u1;It(qy,"SymbolBucket",{omit:["layers","collisionBoxArray","compareText","features"]}),qy.addDynamicAttributes=yf;class q2{constructor(e){this.type=e.property.overrides?e.property.overrides.runtimeType:_s,this.defaultValue=e}evaluate(e){if(e.formattedSection){const i=this.defaultValue.property.overrides;if(i&&i.hasOverride(e.formattedSection))return i.getOverride(e.formattedSection)}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}It(q2,"FormatSectionOverride",{omit:["defaultValue"]});const h1=()=>u1||(u1={layout:G2||(G2=new Bn({"symbol-placement":new ut(Se.layout_symbol["symbol-placement"]),"symbol-spacing":new ut(Se.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new ut(Se.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new _t(Se.layout_symbol["symbol-sort-key"]),"symbol-z-order":new ut(Se.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new ut(Se.layout_symbol["symbol-z-elevate"]),"symbol-elevation-reference":new ut(Se.layout_symbol["symbol-elevation-reference"]),"icon-allow-overlap":new ut(Se.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new ut(Se.layout_symbol["icon-ignore-placement"]),"icon-optional":new ut(Se.layout_symbol["icon-optional"]),"icon-rotation-alignment":new ut(Se.layout_symbol["icon-rotation-alignment"]),"icon-size":new _t(Se.layout_symbol["icon-size"]),"icon-size-scale-range":new ut(Se.layout_symbol["icon-size-scale-range"]),"icon-text-fit":new _t(Se.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new _t(Se.layout_symbol["icon-text-fit-padding"]),"icon-image":new _t(Se.layout_symbol["icon-image"]),"icon-image-use-theme":new ut({type:"string",default:"default","property-type":"data-constant"}),"icon-rotate":new _t(Se.layout_symbol["icon-rotate"]),"icon-padding":new ut(Se.layout_symbol["icon-padding"]),"icon-keep-upright":new ut(Se.layout_symbol["icon-keep-upright"]),"icon-offset":new _t(Se.layout_symbol["icon-offset"]),"icon-anchor":new _t(Se.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new ut(Se.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new ut(Se.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new ut(Se.layout_symbol["text-rotation-alignment"]),"text-field":new _t(Se.layout_symbol["text-field"]),"text-font":new _t(Se.layout_symbol["text-font"]),"text-size":new _t(Se.layout_symbol["text-size"]),"text-size-scale-range":new ut(Se.layout_symbol["text-size-scale-range"]),"text-max-width":new _t(Se.layout_symbol["text-max-width"]),"text-line-height":new _t(Se.layout_symbol["text-line-height"]),"text-letter-spacing":new _t(Se.layout_symbol["text-letter-spacing"]),"text-justify":new _t(Se.layout_symbol["text-justify"]),"text-radial-offset":new _t(Se.layout_symbol["text-radial-offset"]),"text-variable-anchor":new ut(Se.layout_symbol["text-variable-anchor"]),"text-anchor":new _t(Se.layout_symbol["text-anchor"]),"text-max-angle":new ut(Se.layout_symbol["text-max-angle"]),"text-writing-mode":new ut(Se.layout_symbol["text-writing-mode"]),"text-rotate":new _t(Se.layout_symbol["text-rotate"]),"text-padding":new ut(Se.layout_symbol["text-padding"]),"text-keep-upright":new ut(Se.layout_symbol["text-keep-upright"]),"text-transform":new _t(Se.layout_symbol["text-transform"]),"text-offset":new _t(Se.layout_symbol["text-offset"]),"text-allow-overlap":new ut(Se.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new ut(Se.layout_symbol["text-ignore-placement"]),"text-optional":new ut(Se.layout_symbol["text-optional"]),visibility:new ut(Se.layout_symbol.visibility)})),paint:H2||(H2=new Bn({"icon-opacity":new _t(Se.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new _t(Se.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new _t(Se.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new _t(Se.paint_symbol["text-emissive-strength"]),"icon-color":new _t(Se.paint_symbol["icon-color"]),"icon-halo-color":new _t(Se.paint_symbol["icon-halo-color"]),"icon-halo-width":new _t(Se.paint_symbol["icon-halo-width"]),"icon-halo-blur":new _t(Se.paint_symbol["icon-halo-blur"]),"icon-translate":new ut(Se.paint_symbol["icon-translate"]),"icon-translate-anchor":new ut(Se.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new ut(Se.paint_symbol["icon-image-cross-fade"]),"text-opacity":new _t(Se.paint_symbol["text-opacity"]),"text-occlusion-opacity":new _t(Se.paint_symbol["text-occlusion-opacity"]),"text-color":new _t(Se.paint_symbol["text-color"],{runtimeType:go,getOverride:n=>n.textColor,hasOverride:n=>!!n.textColor}),"text-halo-color":new _t(Se.paint_symbol["text-halo-color"]),"text-halo-width":new _t(Se.paint_symbol["text-halo-width"]),"text-halo-blur":new _t(Se.paint_symbol["text-halo-blur"]),"text-translate":new ut(Se.paint_symbol["text-translate"]),"text-translate-anchor":new ut(Se.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new ut(Se.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new ut(Se.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new ut(Se.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new ut(Se.paint_symbol["icon-color-brightness-max"]),"symbol-z-offset":new _t(Se.paint_symbol["symbol-z-offset"]),"icon-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"icon-halo-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"text-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"text-halo-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},u1);class Wy extends lo{constructor(e,i,o,l){super(e,h1(),i,o,l,e.layout?e.layout["icon-image-use-theme"]:null),this._colorAdjustmentMatrix=ct([]),this.hasOcclusionOpacityProperties=e.paint!==void 0&&("icon-occlusion-opacity"in e.paint||"text-occlusion-opacity"in e.paint)}_handleSpecialPaintPropertyUpdate(e){e!=="icon-occlusion-opacity"&&e!=="text-occlusion-opacity"||(this.hasOcclusionOpacityProperties=!0)}recalculate(e,i){super.recalculate(e,i),this.appearances&&this.appearances.forEach(l=>{l.recalculate(e,i,this.iconImageUseTheme)}),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const o=this.layout.get("text-writing-mode");if(o){const l=[];for(const d of o)l.indexOf(d)<0&&l.push(d);this.layout._values["text-writing-mode"]=l}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(e,i,o,l){return this._saturation===e&&this._contrast===i&&this._brightnessMin===o&&this._brightnessMax===l||(this._colorAdjustmentMatrix=function(d,f,_,v){d=Ln(d),f=Li(f);const b=mt(),E=d/3,I=1-2*E,C=[I,E,E,0,E,I,E,0,E,E,I,0,0,0,0,1],R=.5-.5*f,k=v-_;return xe(b,[k,0,0,0,0,k,0,0,0,0,k,0,_,_,_,1],[f,0,0,0,0,f,0,0,0,0,f,0,R,R,R,1]),xe(b,b,C),b}(e,i,o,l),this._saturation=e,this._contrast=i,this._brightnessMin=o,this._brightnessMax=l),this._colorAdjustmentMatrix}getValueAndResolveTokens(e,i,o,l){const d=this.layout.get(e).evaluate(i,{},o,l),f=this._unevaluatedLayout._values[e];return f.isDataDriven()||Wu(f.value)||!d?d:$2(i.properties,d)}getAppearanceValueAndResolveTokens(e,i,o,l,d){const f=e.getProperty(i);if(!f)return;const _=f.evaluate(o,{},l,d),v=e.getUnevaluatedProperties()._values[i];return v.isDataDriven()||Wu(v.value)||!_||typeof _!="string"?_:$2(o.properties,_)}createBucket(e){return new qy(e)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const e of h1().paint.overridableProperties){if(!Wy.hasPaintOverride(this.layout,e))continue;const i=this.paint.get(e),o=new q2(i),l=new Sd(o,i.property.specification,this.scope,this.options,this.layout.get("icon-image-use-theme"));let d=null;d=i.value.kind==="constant"||i.value.kind==="source"?new kc("source",l):new Vl("composite",l,i.value.zoomStops,i.value.interpolationType),this.paint._values[e]=new Gl(i.property,d,i.parameters)}}_handleOverridablePaintPropertyUpdate(e,i,o){return!(!this.layout||i.isDataDriven()||o.isDataDriven())&&Wy.hasPaintOverride(this.layout,e)}static hasPaintOverride(e,i){const o=e.get("text-field"),l=h1().paint.properties[i];let d=!1;const f=_=>{for(const v of _)if(l.overrides&&l.overrides.hasOverride(v))return void(d=!0)};if(o.value.kind==="constant"&&o.value.value instanceof ro)f(o.value.value.sections);else if(o.value.kind==="source"){const _=b=>{d||(b instanceof ca&&wr(b.value)===ku?f(b.value.sections):b instanceof Ns?f(b.sections):b.eachChild(_))},v=o.value;v._styleExpression&&_(v._styleExpression.expression)}return d}getProgramIds(){return["symbol"]}getDefaultProgramParams(e,i,o){return{config:new ul(this,{zoom:i,lut:o}),overrideFog:!1}}hasElevation(){return this.layout&&this.layout.get("symbol-elevation-reference")==="hd-road-markup"}}let W2,Z2,X2,K2;var d1=_i([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);function Zy(n,e,i,o,l,d,f,_){const v=[n,e,1,i,o,1,l,d,1],b=[f,_,1],E=De([],v),[I,C,R]=Va(b,b,E);return Xe(v,v,[I,0,0,0,C,0,0,0,R])}function Y2(n,e,i,o,l,d,f,_){const v=function(b,E,I,C,R,k,F,U){const j=Zy(0,0,1,0,1,1,0,1),H=Zy(b,E,I,C,R,k,F,U);return Xe(H,H,De([],j))}(n,e,i,o,l,d,f,_);return[v[2]/v[8]/dt,v[5]/v[8]/dt]}function Xy(n){return[n[0],Math.min(Math.max(n[1],-D),D)]}class J2 extends Ol{constructor(e,i,o,l){super(),this.id=e,this.dispatcher=o,this.coordinates=i.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(l),this.options=i,this._dirty=!1}load(e,i){if(this._loaded=i||!1,this.fire(new Fs("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return e&&(this.coordinates=e),this._loaded=!0,void this._finishLoading();this._imageRequest=Hh(this.map._requestManager.transformRequest(this.url,Eu.Image),(o,l)=>{this._imageRequest=null,this._loaded=!0,o?this.fire(new Pu(o)):l&&(this.image=l instanceof HTMLImageElement?xr.getImageData(l):l,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,e&&(this.coordinates=e),this._finishLoading())})}loaded(){return this._loaded}updateImage(e){return e.url?(this._imageRequest&&e.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=e.url,this.load(e.coordinates,this._loaded),this):this}setTexture(e){if(!(e.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new Om(this.map.painter.context,e.handle),this.width=e.dimensions[0],this.height=e.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new Fs("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(e){this.map=e,this.load()}onRemove(e){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof Om||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(e){if(this.coordinates=e,this._boundsArray=void 0,this._unsupportedCoords=!1,!e.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let i=e[0][1],o=e[0][1];for(const d of e)d[1]>o&&(o=d[1]),d[1]<i&&(i=d[1]);const l=(o+i)/2;if(l>D?this.onNorthPole=!0:l<-D&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const d=e.map(X.fromLngLat);this.tileID=function(f){let _=1/0,v=1/0,b=-1/0,E=-1/0;for(const F of f)_=Math.min(_,F.x),v=Math.min(v,F.y),b=Math.max(b,F.x),E=Math.max(E,F.y);const I=Math.max(b-_,E-v),C=Math.max(0,Math.floor(-Math.log2(I))),R=Math.pow(2,C);let k=Math.floor((_+b)/2*R);return k>1&&(k-=1),new on(C,k,Math.floor((v+E)/2*R))}(d),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new Fs("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){!this.texture||this.texture instanceof Om||(this.texture.destroy(),this._dirty=!0),this.texture=null,this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(e){for(const j in this.tiles){const H=this.tiles[j];H.state!=="loaded"&&(H.state="loaded",H.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;const i=Hm(new on(0,0,0),this.map.transform.projection),o=[i.projection.project(this.coordinates[0][0],this.coordinates[0][1]),i.projection.project(this.coordinates[1][0],this.coordinates[1][1]),i.projection.project(this.coordinates[2][0],this.coordinates[2][1]),i.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function(j){const H=j[1].x-j[0].x,W=j[1].y-j[0].y,Y=j[2].x-j[1].x,se=j[2].y-j[1].y,ie=j[3].x-j[2].x,ce=j[3].y-j[2].y,fe=j[0].x-j[3].x,ge=j[0].y-j[3].y,Fe=H*se-Y*W,be=Y*ce-ie*se,Ue=ie*ge-fe*ce,He=fe*W-H*ge;return Fe>0&&be>0&&Ue>0&&He>0||Fe<0&&be<0&&Ue<0&&He<0}(o))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);const l=Hm(this.tileID,this.map.transform.projection),[d,f,_,v]=this.coordinates.map(j=>{const H=l.projection.project(j[0],j[1]);return F2(l,H)._round()});this.perspectiveTransform=Y2(d.x,d.y,f.x,f.y,_.x,_.y,v.x,v.y);const b=this._boundsArray=new Oc;b.emplaceBack(d.x,d.y,0,0),b.emplaceBack(f.x,f.y,dt,0),b.emplaceBack(v.x,v.y,0,dt),b.emplaceBack(_.x,_.y,dt,dt),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=e.createVertexBuffer(b,d1.members),this.boundsSegments=An.simpleSegment(0,0,4,2);const E=[],I=[Xy((C=this.coordinates)[0]),Xy(C[1]),Xy(C[2]),Xy(C[3])];var C;const[R,k,F,U]=function(j){let H=j[0][0],W=H,Y=j[0][1],se=Y;for(let ie=1;ie<j.length;ie++)j[ie][0]<H?H=j[ie][0]:j[ie][0]>W&&(W=j[ie][0]),j[ie][1]<Y?Y=j[ie][1]:j[ie][1]>se&&(se=j[ie][1]);return[H,Y,W-H,se-Y]}(I);{const j=new Oc,[H,W,Y,se]=function(Ye){let Je=Ye[0].x,je=Je,Be=Ye[0].y,Qe=Be;for(let ft=1;ft<Ye.length;ft++)Ye[ft].x<Je?Je=Ye[ft].x:Ye[ft].x>je&&(je=Ye[ft].x),Ye[ft].y<Be?Be=Ye[ft].y:Ye[ft].y>Qe&&(Qe=Ye[ft].y);return[Je,Be,je-Je,Qe-Be]}(o),ie=Ye=>[(Ye.x-H)/Y,(Ye.y-W)/se],[ce,fe,ge,Fe]=o.map(ie),be=function(Ye,Je,je,Be,Qe,ft,at,Ot){const xt=Zy(0,0,1,0,1,1,0,1);return Xe(xt,xt,De([],Zy(Ye,Je,je,Be,Qe,ft,at,Ot)))}(ce[0],ce[1],fe[0],fe[1],ge[0],ge[1],Fe[0],Fe[1]);this.elevatedGlobePerspectiveTransform=Y2(ce[0],ce[1],fe[0],fe[1],ge[0],ge[1],Fe[0],Fe[1]);const Ue=(Ye,Je)=>{E.push(Ye.lng);const je=Math.round((Ye.lng-R)/F*dt),Be=Math.round((Ye.lat-k)/U*dt),Qe=ie(Je),ft=Va([],[Qe[0],Qe[1],1],be),at=Math.round(ft[0]/ft[2]*dt),Ot=Math.round(ft[1]/ft[2]*dt);j.emplaceBack(je,Be,at,Ot)},He=o[3].x-o[0].x,qe=o[3].y-o[0].y,tt=o[2].x-o[1].x,nt=o[2].y-o[1].y;for(let Ye=0;Ye<65;Ye++){const Je=Ye/64,je=[o[0].x+Je*He,o[0].y+Je*qe],Be=[o[1].x+Je*tt,o[1].y+Je*nt],Qe=Be[0]-je[0],ft=Be[1]-je[1];for(let at=0;at<65;at++){const Ot=at/64,xt={x:je[0]+Qe*Ot,y:je[1]+ft*Ot};Ue(i.projection.unproject(xt.x,xt.y),xt)}}this.elevatedGlobeVertexBuffer=e.createVertexBuffer(j,d1.members)}{this.maxLongitudeTriangleSize=0;let j=[],H=new sr;const W=(Y,se,ie)=>{H.emplaceBack(Y,se,ie);const ce=E[Y],fe=E[se],ge=E[ie],Fe=Math.min(Math.min(ce,fe),ge),be=Math.max(Math.max(ce,fe),ge)-Fe;be>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=be),j.push(Fe+be/2)};for(let Y=0;Y<64;Y++)for(let se=0;se<64;se++){const ie=65*Y+se,ce=ie+1,fe=ie+65,ge=fe+1;W(ie,fe,ce),W(ce,fe,ge)}[j,H]=function(Y,se){const ie=Array.from({length:Y.length},(ge,Fe)=>Fe);ie.sort((ge,Fe)=>Y[ge]-Y[Fe]);const ce=[],fe=new sr;for(let ge=0;ge<ie.length;ge++){const Fe=ie[ge];ce.push(Y[Fe]);const be=3*Fe,Ue=be+1;fe.emplaceBack(se.uint16[be],se.uint16[Ue],se.uint16[Ue+1])}return[ce,fe]}(j,H),this.elevatedGlobeTrianglesCenterLongitudes=j,this.elevatedGlobeIndexBuffer=e.createIndexBuffer(H)}this.elevatedGlobeSegments=An.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,F/dt,0,U/dt,0,0,k,R,0])}prepare(){const e=Object.keys(this.tiles).length!==0;if(this.tileID&&!e)return;const i=this.map.painter.context,o=i.gl;!this._dirty||this.texture instanceof Om||(this.texture?this.texture.update(this.image):(this.texture=new Fx(i,this.image,o.RGBA8),this.texture.bind(o.LINEAR,o.CLAMP_TO_EDGE)),this._dirty=!1),e&&this._prepareData(i)}loadTile(e,i){this.tileID&&this.tileID.equals(e.tileID.canonical)?(this.tiles[String(e.tileID.wrap)]=e,e.buckets={},i(null)):(e.state="errored",i(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(e){const i=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!i)return null;const o=this.elevatedGlobeTrianglesCenterLongitudes;let l=(d=e+180)+360*Math.round((o[0]-d)/360);var d;const f=new An,_=(I,C)=>{f.segments.push({vertexOffset:0,primitiveOffset:I,vertexLength:i.segments[0].vertexLength,primitiveLength:C,sortKey:void 0,vaos:{}})},v=.51*this.maxLongitudeTriangleSize;if(Math.abs(o[0]-l)<=v){const I=kn(o,0,o.length,l+v);return I===o.length||_(I,rr(o,I+1,o.length,l+360-v)-I),f}l<o[0]&&(l+=360);const b=rr(o,0,o.length,l-v);if(b===o.length)return _(0,o.length),f;_(0,b-0);const E=kn(o,b+1,o.length,l+v);return E!==o.length&&_(E,o.length-E),f}}const eL=(Math.pow(256,2)-1)/16907520;class Q2 extends lo{constructor(e,i,o,l){super(e,{layout:X2||(X2=new Bn({visibility:new ut(Se.layout_raster.visibility)})),paint:K2||(K2=new Bn({"raster-opacity":new ut(Se.paint_raster["raster-opacity"]),"raster-color":new ql(Se.paint_raster["raster-color"]),"raster-color-mix":new ut(Se.paint_raster["raster-color-mix"]),"raster-color-range":new ut(Se.paint_raster["raster-color-range"]),"raster-hue-rotate":new ut(Se.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new ut(Se.paint_raster["raster-brightness-min"]),"raster-brightness-max":new ut(Se.paint_raster["raster-brightness-max"]),"raster-saturation":new ut(Se.paint_raster["raster-saturation"]),"raster-contrast":new ut(Se.paint_raster["raster-contrast"]),"raster-resampling":new ut(Se.paint_raster["raster-resampling"]),"raster-fade-duration":new ut(Se.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new ut(Se.paint_raster["raster-emissive-strength"]),"raster-array-band":new ut(Se.paint_raster["raster-array-band"]),"raster-elevation":new ut(Se.paint_raster["raster-elevation"]),"raster-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},i,o,l),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(e){return!(e&&e._source instanceof J2&&(e._source.onNorthPole||e._source.onSouthPole))&&this.paint.get("raster-elevation")===0}_handleSpecialPaintPropertyUpdate(e){e!=="raster-color"&&e!=="raster-color-range"||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}updateColorRamp(e){if(!this.hasColorMap()||!this._curRampRange)return;const i=this._transitionablePaint._values["raster-color"].value.expression,[o,l]=e||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(o)&&isNaN(l)||o===this._curRampRange[0]&&l===this._curRampRange[1]||(this.colorRamp=wm({expression:i,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:o,end:l}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[o,l])}}let eE,tE,iE,nE,rE;class oE extends lo{constructor(e,i,o,l){super(e,{layout:eE||(eE=new Bn({visibility:new ut(Se["layout_raster-particle"].visibility)})),paint:tE||(tE=new Bn({"raster-particle-array-band":new ut(Se["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new ut(Se["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new ql(Se["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new ut(Se["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new ut(Se["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new ut(Se["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new ut(Se["paint_raster-particle"]["raster-particle-reset-rate-factor"]),"raster-particle-elevation":new ut(Se["paint_raster-particle"]["raster-particle-elevation"]),"raster-particle-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},i,o,l),this._updateColorRamp(),this.lastInvalidatedAt=xr.now()}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this.tileFramebuffer&&(this.tileFramebuffer.destroy(),this.tileFramebuffer=null),this.particleFramebuffer&&(this.particleFramebuffer.destroy(),this.particleFramebuffer=null)}onRemove(e){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return this.visibility!=="none"}isDraped(e){return!1}_handleSpecialPaintPropertyUpdate(e){e!=="raster-particle-color"&&e!=="raster-particle-max-speed"||(this._updateColorRamp(),this._invalidateAnimationState()),e==="raster-particle-count"&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;const e=this._transitionablePaint._values["raster-particle-color"].value.expression,i=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=wm({expression:e,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:i}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=xr.now()}tileCoverLift(){return this.paint.get("raster-particle-elevation")}}class tL extends lo{constructor(e,i){super(e,{},i,null),this.implementation=e,e.slot&&(this.slot=e.slot)}is3D(e){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}isDraped(e){return this.implementation.renderToTile!==void 0}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(e){this.implementation.onAdd&&this.implementation.onAdd(e,e.painter.context.gl)}onRemove(e){this.implementation.onRemove&&this.implementation.onRemove(e,e.painter.context.gl)}}function f1(n,e,i){const o=[0,0,1],l=mc([]);return ra(l,l,i?-Oi(n)+Math.PI:Oi(n)),hs(l,l,-Oi(e)),$a(o,o,l),yn(o,o)}const sE={None:0,Model:1,Symbol:2,FillExtrusion:4};class Ky{constructor(e,i,o,l){this.message=(e?`${e}: `:"")+o,l&&(this.identifier=l),i!=null&&i.__line__&&(this.line=i.__line__)}}function p1(n,e){const i=n.indexOf("://")===-1;try{return new URL(n,i&&e?"http://example.com":void 0),!0}catch{return!1}}class aE{constructor(e,i){this.feature=e,this.instancedDataOffset=i,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class lE{constructor(){this.maxScale=1,this.maxXYTranslationDistance=0,this.instancedDataArray=new um,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}colorForInstance(e){const i=16*e,o=this.instancedDataArray.float32;let l=Math.floor(o[i+2]);const d=1.05*(o[i+2]-l);return l/=100,[o[i]%1*1.05,o[i+1]%1*1.05,d,l]}tileCoordinatesForInstance(e){const i=16*e,o=this.instancedDataArray.float32;let l=o[i+0];return l=l>dt?l-dt:l,new et(Math.trunc(l),Math.trunc(o[i+1]))}translationForInstance(e){const i=16*e,o=this.instancedDataArray.float32;return[o[i+4],o[i+5],o[i+6]]}rotationScaleForInstance(e){const i=16*e,o=this.instancedDataArray.float32;return[o[i+7],o[i+8],o[i+9],o[i+10],o[i+11],o[i+12],o[i+13],o[i+14],o[i+15]]}transformForInstance(e){const i=16*e,o=this.instancedDataArray.float32;return[o[i+7],o[i+8],o[i+9],o[i+4],o[i+10],o[i+11],o[i+12],o[i+5],o[i+13],o[i+14],o[i+15],o[i+6],0,0,0,1]}}class m1{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.overscaledZ=this.canonical.z+Math.log2(e.overscaling),this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.projection=e.projection,this.index=e.index,this.worldview=e.worldview,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z+1?0:this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.styleDefinedModelURLs=e.styleDefinedModelURLs,this.hasAppearances=null}updateFootprints(e,i){}updateAppearances(e,i,o,l){}populate(e,i,o,l){this.tileToMeter=$(o);const d=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:f,id:_,index:v,sourceLayerIndex:b}of e){const E=_??(f.properties&&f.properties.hasOwnProperty("id")?f.properties.id:void 0),I=we(f,d);if(!this.layers[0]._featureFilter.filter(new fn(this.zoom,{worldview:this.worldview,activeFloors:i.activeFloors}),I,o))continue;const C={id:E,sourceLayerIndex:b,index:v,geometry:d?I.geometry:he(f,o,l),properties:f.properties,type:f.type,patterns:{}},R=this.addFeature(C,C.geometry,I);R&&i.featureIndex.insert(f,C.geometry,v,b,this.index,this.instancesPerModel[R].instancedDataArray.length,dt/32)}this.lookup=null}evaluateQueryRenderedFeaturePadding(){const e=this.layers[0].modelManager,i=this.layers[0].scope;let o=0;for(const l of this.modelUris){const d=e.getModel(l,i);if(!d)continue;const f=this.instancesPerModel[l];if(f){const _=.5*ja(d.aabb.max,d.aabb.min)*f.maxScale+f.maxXYTranslationDistance,v=Math.min(dt,Math.max(_/this.tileToMeter,dt/32));o=Math.max(v,o)}}return o}update(e,i,o,l){for(const d in this.instancesPerModel){const f=this.instancesPerModel[d];for(const _ in e)f.idToFeaturesIndex.hasOwnProperty(_)&&(this.evaluate(f.features[f.idToFeaturesIndex[_]],e[_],f,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let e=!1;for(const i in this.instancesPerModel){const o=this.instancesPerModel[i];for(const l of o.features){const d=this.layers[0],f=l.feature,_=this.canonical,v=d.paint.get("model-rotation").evaluate(f,{},_),b=d.paint.get("model-scale").evaluate(f,{},_),E=d.paint.get("model-translation").evaluate(f,{},_);Xr(l.rotation,v)&&Xr(l.scale,b)&&Xr(l.translation,E)||(this.evaluate(l,l.featureStates,o,!0),e=!0)}}return e}updateReplacement(e,i,o,l){if(i.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=i.updateTime;const d=i.getReplacementRegionsForTile(e.toUnwrapped(),!0);if(xy(this.activeReplacements,d))return!1;this.activeReplacements=d;let f=!1;for(const _ in this.instancesPerModel){const v=this.instancesPerModel[_],b=v.instancedDataArray;for(const E of v.features){const I=E.instancedDataOffset,C=E.instancedDataCount;for(let R=0;R<C;R++){const k=16*(R+I);let F=b.float32[k+0];const U=F>dt;F=U?F-dt:F;const j=Math.floor(F),H=Math.floor(b.float32[k+1]);let W=!1;for(const Y of this.activeReplacements)if(!ZT(Y,o,sE.Model,l)&&!(Y.min.x>j||j>Y.max.x||Y.min.y>H||H>Y.max.y)&&(W=QT(JT(j,H,e.canonical,Y.footprintTileId.canonical),Y.footprint),W))break;b.float32[k]=W?F+dt:F,f=f||W!==U}}}return f}isEmpty(){for(const e in this.instancesPerModel)if(this.instancesPerModel[e].instancedDataArray.length!==0)return!1;return!0}uploadPending(){return!this.uploaded}upload(e){if(!this.uploaded)for(const i in this.instancesPerModel){const o=this.instancesPerModel[i];o.instancedDataArray.length<0||o.instancedDataArray.length===0||(o.instancedDataBuffer?o.instancedDataBuffer.updateData(o.instancedDataArray):o.instancedDataBuffer=e.createVertexBuffer(o.instancedDataArray,SR.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(e){for(const o in this.instancesPerModel){const l=this.instancesPerModel[o];l.instancedDataArray.length!==0&&l.instancedDataBuffer&&l.instancedDataBuffer.destroy()}const i=this.layers[0].modelManager;if(e&&i&&this.modelUris&&this.modelsRequested)for(const o of this.modelUris)i.removeModel(o,"",!0)}addFeature(e,i,o){const l=this.layers[0],d=l.layout.get("model-id").evaluate(o,{},this.canonical);if(!d)return bt(`modelId is not evaluated for layer ${l.id} and it is not going to get rendered.`),d;(p1(d,!1)||this.styleDefinedModelURLs[d]!==void 0)&&(this.modelUris.includes(d)||this.modelUris.push(d)),this.instancesPerModel[d]||(this.instancesPerModel[d]=new lE);const f=this.instancesPerModel[d],_=f.instancedDataArray,v=new aE(o,_.length);for(const b of i)for(const E of b){if(E.x<0||E.x>=dt||E.y<0||E.y>=dt)continue;if(this.lookupDim!==0){const C=(this.lookupDim-1)/dt,R=this.lookupDim*(E.y*C|0)+E.x*C|0;if(this.lookup){if(this.lookup[R]!==0)continue;this.lookup[R]=1}}this.instanceCount++;const I=_.length;_.resize(I+1),f.instancesEvaluatedElevation.push(0),_.float32[16*I]=E.x,_.float32[16*I+1]=E.y}return v.instancedDataCount=f.instancedDataArray.length-v.instancedDataOffset,v.instancedDataCount>0&&(e.id&&(f.idToFeaturesIndex[e.id]=f.features.length),f.features.push(v),this.evaluate(v,{},f,!1)),d}getModelUris(){return this.modelUris}evaluate(e,i,o,l){const d=this.layers[0],f=e.feature,_=this.canonical,v=e.rotation=d.paint.get("model-rotation").evaluate(f,i,_),b=e.scale=d.paint.get("model-scale").evaluate(f,i,_),E=e.translation=d.paint.get("model-translation").evaluate(f,i,_),I=Object.assign({},d.paint.get("model-color").evaluate(f,i,_));I.a=d.paint.get("model-color-mix-intensity").evaluate(f,i,_);const C=[];this.maxVerticalOffset<E[2]&&(this.maxVerticalOffset=E[2]);const R=E[0]*E[0]+E[1]*E[1],k=R>0?Math.sqrt(R):0;o.maxScale=Math.max(Math.max(o.maxScale,b[0]),Math.max(b[1],b[2])),o.maxXYTranslationDistance=Math.max(o.maxXYTranslationDistance,k),this.maxScale=Math.max(Math.max(this.maxScale,b[0]),Math.max(b[1],b[2])),NS(C,v,b);const F=Math.round(100*I.a)+I.b/1.05;for(let U=0;U<e.instancedDataCount;++U){const j=e.instancedDataOffset+U,H=16*j,W=o.instancedDataArray.float32;let Y=0;l&&(Y=W[H+6]-o.instancesEvaluatedElevation[j]);const se=0|W[H+1];W[H]=(0|W[H])+I.r/1.05,W[H+1]=se+I.g/1.05,W[H+2]=F,W[H+3]=1/(_.z>10?this.tileToMeter:$(_,se)),W[H+4]=E[0],W[H+5]=E[1],W[H+6]=E[2]+Y,W[H+7]=C[0],W[H+8]=C[1],W[H+9]=C[2],W[H+10]=C[4],W[H+11]=C[5],W[H+12]=C[6],W[H+13]=C[8],W[H+14]=C[9],W[H+15]=C[10],o.instancesEvaluatedElevation[j]=E[2]}}}let cE,uE;It(m1,"ModelBucket",{omit:["layers"]}),It(lE,"PerModelAttributes"),It(aE,"ModelFeature");class vf{constructor(e,i,o){this._demTile=e,this._dem=this._demTile.dem,this._scale=i,this._offset=o}static create(e,i,o){const l=o||e.findDEMTileFor(i);if(!l||!l.dem)return;const d=l.dem,f=l.tileID,_=1<<i.canonical.z-f.canonical.z;return new vf(l,d.dim/dt/_,[(i.canonical.x/_-f.canonical.x)*d.dim,(i.canonical.y/_-f.canonical.y)*d.dim])}tileCoordToPixel(e,i){const o=i*this._scale+this._offset[1];return new et(Math.floor(e*this._scale+this._offset[0]),Math.floor(o))}getElevationAt(e,i,o,l){const d=e*this._scale+this._offset[0],f=i*this._scale+this._offset[1],_=Math.floor(d),v=Math.floor(f),b=this._dem;return l=!!l,o?Kt(Kt(b.get(_,v,l),b.get(_,v+1,l),f-v),Kt(b.get(_+1,v,l),b.get(_+1,v+1,l),f-v),d-_):b.get(_,v,l)}getElevationAtPixel(e,i,o){return this._dem.get(e,i,!!o)}getMeterToDEM(e){return(1<<this._demTile.tileID.canonical.z)*A(1,e)*this._dem.stride}}const _1=new Float32Array(262144),mh=new Uint8Array(262144);function hE(n){let e=0;if(n.meshes)for(const i of n.meshes)e=Math.max(e,i.aabb.max[2]);if(n.children)for(const i of n.children)e=Math.max(e,hE(i));return e}function dE(n,e,i){if(n.meshes)for(const o of n.meshes){if(o.aabb.min[0]===1/0)continue;const l=Lt.applyTransform(o.aabb,n.globalMatrix);i.insert(e,l.min[0],l.min[1],l.max[0],l.max[1])}if(n.children)for(const o of n.children)dE(o,e,i)}const fE=["","wall","door","roof","window","lamp","logo"];class pE{constructor(e){this.node=e,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedTranslation=[0,0,0],this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.cameraCollisionOpacity=1,this.feature={type:"Point",id:e.id,geometry:[],properties:{height:hE(e)}},this.aabb=this._getLocalBounds(),this.state=null}_getLocalBounds(){if(!this.node.meshes)return new Lt([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let e=0;const i=new Lt([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const o of this.node.meshes)this.node.lightMeshIndex!==e&&(o.transformedAabb=Lt.applyTransformFast(o.aabb,this.node.globalMatrix),i.encapsulate(o.transformedAabb)),e++;this.aabb=i}return this.aabb}}class Yy{constructor(e,i,o,l,d,f,_,v){this.id=o,this.layers=e,this.layerIds=this.layers.map(b=>b.fqid),this.stateDependentLayerIds=this.layers.filter(b=>b.isStateDependent()).map(b=>b.id),this.modelTraits|=uf.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,l&&(this.modelTraits|=uf.HasMapboxMeshFeatures),d&&(this.modelTraits|=uf.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=f,this.worldview=v,this.dirty=!0,this.needsUpload=!1,this.filter=null,this.nodesInfo=[];for(const b of i)this.nodesInfo.push(new pE(b)),dE(b,_.featureIndexArray.length,_.grid),_.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,_.bucketLayerIDs.length-1,0);this.states={},this.hasAppearances=null}updateFootprints(e,i){for(const o of this.getNodesInfo()){const l=o.node;l.footprint&&i.push({footprint:l.footprint,id:e})}}updateAppearances(e,i,o,l){}update(e){const i=Object.keys(e).length!==0;if(i&&!this.stateDependentLayers.length)return;const o=i?this.stateDependentLayers:this.layers;if(!sa(e,this.states))for(const l of o)this.evaluate(l,e);this.states=structuredClone(e)}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(e){if(!this.needsUpload)return;const i=this.getNodesInfo();for(const o of i){const l=o.node;this.uploaded?this.updatePbrBuffer(l):jx(l,e,!0)}for(const o of i)ky(o.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(e){let i=!1;if(!e.meshes)return i;for(const o of e.meshes)o.pbrBuffer&&(o.pbrBuffer.updateData(o.featureArray),i=!0);return i}needsReEvaluation(e,i,o){const l=e.transform.projectionOptions,d=e.style.getBrightness(),f=this.brightness!==d;if(!this.uploaded||this.dirty||l.name!==this.projection.name||Qm(o.paint.get("model-color").value,f)||Qm(o.paint.get("model-color-mix-intensity").value,f)||Qm(o.paint.get("model-roughness").value,f)||Qm(o.paint.get("model-emissive-strength").value,f)||Qm(o.paint.get("model-height-based-emissive-strength-multiplier").value,f)){this.projection=l,this.brightness=d;const _=this.getNodesInfo();for(const v of _)v.state=null;return!0}return!1}evaluateTransform(e,i){if(e.transform.zoom===this.zoom)return;this.zoom=e.transform.zoom;const o=this.getNodesInfo(),l=this.id.canonical;for(const d of o){const f=d.feature;d.evaluatedTranslation=i.paint.get("model-translation").evaluate(f,{},l),d.evaluatedScale=i.paint.get("model-scale").evaluate(f,{},l)}}evaluate(e,i){const o=this.getNodesInfo();for(const l of o){if(!l.node.meshes)continue;const d=l.feature,f=i&&i[d.id];if(sa(f,l.state))continue;l.state=structuredClone(f);const _=l.node.meshes&&l.node.meshes[0].featureData,v=l.evaluatedColor[2],b=l.evaluatedRMEA[2],E=this.id.canonical;if(l.hasTranslucentParts=!1,_){for(let I=0;I<fE.length;I++){const C=fE[I];C.length&&(d.properties.part=C);const R=e.paint.get("model-color").evaluate(d,f,E).toPremultipliedRenderColor(null),k=e.paint.get("model-color-mix-intensity").evaluate(d,f,E);l.evaluatedColor[I]=[R.r,R.g,R.b,k],l.evaluatedRMEA[I][0]=e.paint.get("model-roughness").evaluate(d,f,E),l.evaluatedRMEA[I][2]=e.paint.get("model-emissive-strength").evaluate(d,f,E),l.evaluatedRMEA[I][3]=R.a,l.emissionHeightBasedParams[I]=e.paint.get("model-height-based-emissive-strength-multiplier").evaluate(d,f,E),!l.hasTranslucentParts&&R.a<1&&(l.hasTranslucentParts=!0)}delete d.properties.part,nL(l,v!==l.evaluatedColor[2]||b!==l.evaluatedRMEA[2],this.modelTraits)}else l.evaluatedRMEA[0][2]=e.paint.get("model-emissive-strength").evaluate(d,f,E);l.evaluatedTranslation=e.paint.get("model-translation").evaluate(d,f,E),l.evaluatedScale=e.paint.get("model-scale").evaluate(d,f,E),this.updatePbrBuffer(l.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(e,i,o,l){const d=e.findDEMTileFor(o);if(d&&(d.tileID.canonical!==this.terrainTile||i!==this.terrainExaggeration)){if(d.dem&&d.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=d.tileID.overscaledZ;const f=vf.create(e,o,d);if(!f)return;this.modelTraits&uf.HasMapboxMeshFeatures&&this.updateDEM(e,f,o,l);for(const _ of this.getNodesInfo()){const v=_.node;if(!v.footprint||!v.footprint.vertices||!v.footprint.vertices.length)continue;const b=v.footprint.vertices;let E=f.getElevationAt(b[0].x,b[0].y,!0,!0);for(let I=1;I<b.length;I++)E=Math.min(E,f.getElevationAt(b[I].x,b[I].y,!0,!0));v.elevation=E}}this.terrainTile=d.tileID.canonical,this.terrainExaggeration=i}}updateDEM(e,i,o,l){let d=i._dem._modifiedForSources[l];if(d===void 0&&(i._dem._modifiedForSources[l]=[],d=i._dem._modifiedForSources[l]),d.includes(o.canonical))return;const f=i._dem.dim;d.push(o.canonical);let _=!1;for(const v of this.getNodesInfo()){const b=v.node;if(!b.footprint||!b.footprint.grid)continue;const E=b.footprint.grid,I=i.tileCoordToPixel(E.min.x,E.min.y),C=i.tileCoordToPixel(E.max.x,E.max.y),R=Math.min(Math.min(f-C.y,I.x),Math.min(I.y,f-C.x));if(R<0)continue;const k=V(R,2,5);let F=Math.max(0,I.x-k),U=Math.max(0,I.y-k),j=Math.min(C.x+k,f-1),H=Math.min(C.y+k,f-1);for(let ie=U;ie<=H;++ie)for(let ce=F;ce<=j;++ce)mh[ie*f+ce]=255;let W=0,Y=0;for(let ie=0;ie<E.cellsY;++ie)for(let ce=0;ce<E.cellsX;++ce){if(!E.cells[ie*E.cellsX+ce])continue;const fe=i.tileCoordToPixel(E.min.x+ce/E.xScale,E.min.y+ie/E.yScale),ge=i.tileCoordToPixel(E.min.x+(ce+1)/E.xScale,E.min.y+(ie+1)/E.yScale);for(let Fe=fe.y;Fe<=Math.min(ge.y+1,f-1);++Fe)for(let be=fe.x;be<=Math.min(ge.x+1,f-1);++be)mh[Fe*f+be]===255&&(mh[Fe*f+be]=0,W+=i.getElevationAtPixel(be,Fe),Y++)}const se=W/Y;F=Math.max(1,I.x-k),U=Math.max(1,I.y-k),j=Math.min(C.x+k,f-2),H=Math.min(C.y+k,f-2),_=!0;for(let ie=U;ie<=H;++ie)for(let ce=F;ce<=j;++ce)mh[ie*f+ce]===0&&(_1[ie*f+ce]=i._dem.set(ce,ie,se));for(let ie=1;ie<k;++ie){F=Math.max(1,I.x-ie),U=Math.max(1,I.y-ie),j=Math.min(C.x+ie,f-2),H=Math.min(C.y+ie,f-2);for(let ce=U;ce<=H;++ce)for(let fe=F;fe<=j;++fe){const ge=ce*f+fe;if(mh[ge]===255){let Fe=0,be=0,Ue=-1,He=-1;for(let qe=-1;qe<=1;++qe)for(let tt=-1;tt<=1;++tt){const nt=(ce+qe)*f+fe+tt;if(mh[nt]>=ie)continue;const Ye=_1[nt],Je=Math.abs(Ye);Je>be&&(Fe=Ye,be=Je,Ue=tt,He=qe)}if(be>.1){const qe=1-(ie+.5*Math.abs(Ue*He))/k;let tt=i._dem.get(fe,ce)+Fe*qe;const nt=i._dem.get(fe+Ue,ce+He),Ye=i._dem.get(fe-Ue,ce-He,!0);(tt-nt)*(tt-Ye)>0&&(tt=(nt+Ye)/2),_1[ge]=i._dem.set(fe,ce,tt),mh[ge]=ie}}}}}_&&(i._demTile.needsDEMTextureUpload=!0,i._dem._timestamp=xr.now())}setFilter(e){this.filter=e?Ld(e):null}getNodesInfo(){return this.filter?this.nodesInfo.filter(e=>this.filter.filter(new fn(this.id.overscaledZ,{worldview:this.worldview}),e.feature,this.id.canonical)):this.nodesInfo}destroy(){const e=this.getNodesInfo();for(const i of e)ky(i.node),Ux(i.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(e,i){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;const o=i.getReplacementRegionsForTile(e.toUnwrapped());for(const l of this.getNodesInfo()){const d=l.node.footprint;l.hiddenByReplacement=!!d&&!o.find(f=>f.footprint===d)}}getHeightAtTileCoord(e,i){const o=[],l=[0,0,0],d=ct([]);for(const f of this.getNodesInfo()){const _=f.node.meshes[0],v=_.transformedAabb;if(e<v.min[0]||i<v.min[1]||e>v.max[0]||i>v.max[1])continue;if(f.node.hidden===!0)return{height:1/0,maxHeight:f.feature.properties.height,hidden:!1,verticalScale:f.evaluatedScale[2]};Me(d,f.node.globalMatrix),l[0]=e,l[1]=i,Kn(l,l,d);const b=(l[0]-_.aabb.min[0])/(_.aabb.max[0]-_.aabb.min[0])*dh|0,E=Math.min(63,(l[1]-_.aabb.min[1])/(_.aabb.max[1]-_.aabb.min[1])*dh|0)*dh+Math.min(63,b),I=_.heightmap[E];if(!(I<0&&f.node.footprint))return f.hiddenByReplacement?void 0:{height:I,maxHeight:f.feature.properties.height,hidden:!1,verticalScale:f.evaluatedScale[2]};if(f.node.footprint.grid.query(new et(e,i),new et(e,i),o),o.length>0)return{height:void 0,maxHeight:f.feature.properties.height,hidden:f.hiddenByReplacement,verticalScale:f.evaluatedScale[2]}}}}function Qm(n,e){return n instanceof kc&&!n.isLightConstant&&e}function iL(n,e,i,o,l,d,f,_){let v=(61440&e|(61440&e)>>4)>>8,b=(3840&e|(3840&e)>>4)>>4,E=240&e|(240&e)>>4;i[3]>0&&(v=Kt(v,255*i[0],i[3]),b=Kt(b,255*i[1],i[3]),E=Kt(E,255*i[2],i[3]));const I=v<<8|b,C=E<<8|Math.floor(255*o[3]),R=function(ie){const ce=V(ie,0,2);return Math.min(Math.round(.5*ce*255),255)}(o[2])<<8|15*o[0]<<4|15*o[1],k=V(l[0],0,1),F=V(l[1],0,1),U=V(l[2],0,1),j=V(l[3],0,1);let H,W,Y,se;if(k!==F&&f!==d&&F!==k){const ie=f-d;W=1/(ie*(F-k)),Y=-(d+ie*k)/(ie*(F-k));const ce=V(l[4],-1,1);se=Math.pow(10,ce),H=255*U<<8|255*j}else H=65535,W=0,Y=1,se=1;if(n.emplaceBack(I,C,R,H,W,Y,se),_){const ie=_.length;_.clear();for(let ce=0;ce<ie;ce++)_.emplaceBack(I,C,R,H,W,Y,se)}}function nL(n,e,i){const o=n.node;let l=0;const d=i&uf.HasMeshoptCompression;for(const f of o.meshes){if(o.lights&&o.lightMeshIndex===l||!f.featureData)continue;f.featureArray=new Gd,f.featureArray.reserve(f.featureData.length);let _=e;for(const v of f.featureData){const b=d?65535&v:v>>16&65535,E=d?v>>16&65535:65535&v,I=(15&E)<8?15&E:0,C=n.evaluatedRMEA[I],R=n.evaluatedColor[I],k=n.emissionHeightBasedParams[I];let F;if(_&&I===2&&o.lights&&(F=new Gd,F.resize(10*o.lights.length)),iL(f.featureArray,b,R,C,k,f.aabb.min[2],f.aabb.max[2],F),F&&_){_=!1;const U=o.meshes[o.lightMeshIndex];U.featureArray=F,U.featureArray._trim()}}f.featureArray._trim(),l++}}It(Yy,"Tiled3dModelBucket",{omit:["layers"]}),It(pE,"Tiled3dModelFeature");const rL=["id","tile","layer","source","sourceLayer","state"];class _h{constructor(e,i,o,l,d){this.type="Feature",this._vectorTileFeature=e,this._z=i,this._x=o,this._y=l,this.properties=e?e.properties:{},this.id=d}clone(){const e=new _h(this._vectorTileFeature,this._z,this._x,this._y,this.id);return this.state&&(e.state=Object.assign({},this.state)),this.layer&&(e.layer=Object.assign({},this.layer)),this.source&&(e.source=this.source),this.sourceLayer&&(e.sourceLayer=this.sourceLayer),e}get geometry(){return this._geometry===void 0&&this._vectorTileFeature&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(e){this._geometry=e}toJSON(){const e={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(const i of rL)this[i]!==void 0&&(e[i]=this[i]);return e}}class gh extends Ol{constructor(e,i,o,l){super(),this.id=e,this.type="model",this.models=[],this._loaded=!1,this._options=i,this._modelsInfo=new Map}load(){const e=[];for(const i in this._options.models){const o=this._options.models[i],l=this._modelsInfo.get(i);if(l){const d=l.model;d.position=o.position!=null?new r(o.position[0],o.position[1]):new r(0,0),d.orientation=o.orientation!=null?o.orientation:[0,0,0],l.modelSpec=o,gh.applyModelSpecification(d,o),d.computeBoundsAndApplyParent(),this.models.push(d)}else{const d=DS(this.map._requestManager.transformRequest(o.uri,Eu.Model).url).then(f=>{if(!f)return;const _=$x(f),v=new jS(i,o.uri,o.position,o.orientation,_);gh.applyModelSpecification(v,o),v.computeBoundsAndApplyParent(),this.models.push(v),this._modelsInfo.set(i,{modelSpec:o,model:v})}).catch(f=>{this.fire(new Pu(new Error(`Could not load model ${i} from ${o.uri}: ${f.message}`)))});e.push(d)}}Promise.allSettled(e).then(()=>{this._loaded=!0,this.fire(new Fs("data",{dataType:"source",sourceDataType:"metadata"}))}).catch(i=>{this._loaded=!0,this.fire(new Pu(new Error(`Could not load models: ${i.message}`)))})}static applyModelSpecification(e,i){i.nodeOverrides&&gh.convertNodeOverrides(e,i.nodeOverrides),i.materialOverrides&&gh.convertMaterialOverrides(e,i.materialOverrides),i.nodeOverrideNames&&(e.nodeOverrideNames=[...i.nodeOverrideNames]),i.materialOverrideNames&&(e.materialOverrideNames=[...i.materialOverrideNames]),i.featureProperties&&(e.featureProperties=i.featureProperties)}static convertNodeOverrides(e,i){if(Array.isArray(i)&&i.every(o=>typeof o=="string")){e.nodeOverrideNames=[];for(const o of i)e.nodeOverrideNames.push(o)}else Object.entries(i).forEach(([o,l])=>{const d={orientation:[0,0,0]};if(l.hasOwnProperty("orientation")){const f=l.orientation;f&&(d.orientation=f)}e.nodeOverrides.set(o,d)})}static convertMaterialOverrides(e,i){if(Array.isArray(i)&&i.every(o=>typeof o=="string")){e.materialOverrideNames=[];for(const o of i)e.materialOverrideNames.push(o)}else Object.entries(i).forEach(([o,l])=>{const d={color:new Zi(1,1,1),colorMix:0,emissionStrength:0,opacity:1},f=l["model-color"];f!==void 0&&(d.color.r=f[0],d.color.g=f[1],d.color.b=f[2]);const _=l["model-color-mix-intensity"];_!==void 0&&(d.colorMix=_);const v=l["model-emissive-strength"];v!==void 0&&(d.emissionStrength=v);const b=l["model-opacity"];b!==void 0&&(d.opacity=b),e.materialOverrides.set(o,d)})}onAdd(e){this.map=e,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(e,i){}serialize(){return this._options}setProperty(e,i){return!1}reload(){const e=xs(this.id,this.scope);this.map.style.clearSource(e),this.models=[],this._modelsInfo.clear(),this._loaded=!1,this.load()}setModels(e){this.models=[];const i=new Map;for(const o in e){const l=e[o];if(this._modelsInfo.has(o)){const d=this._modelsInfo.get(o);d&&d.modelSpec.uri===l.uri&&i.set(o,d)}}this._modelsInfo=i,this._options.models=e,this._loaded=!1,this.load()}}function g1(n,e,i,o){const l=1<<n.z;e.lat=z((o/dt+n.y)/l),e.lng=M((i/dt+n.x)/l)}function oL(n,e,i,o){const l=n.getNodesInfo()[e];if(!l||l.hiddenByReplacement||!l.node.meshes)return;let d=Number.MAX_VALUE;const f=l.node,_=i.tile,v=o.calculatePosMatrix(_.tileID.toUnwrapped(),o.worldSize),b=l.evaluatedScale;let E=0;o.elevation&&f.elevation&&(E=f.elevation*o.elevation.exaggeration()),Pe(v,v,[(f.anchor?f.anchor[0]:0)*(b[0]-1),(f.anchor?f.anchor[1]:0)*(b[1]-1),E]),Ze(v,v,b);const I=i.queryGeometry,C=I.isPointQuery()?I.screenBounds:I.screenGeometry,R=function(F){const U=xe([],v,F.globalMatrix);xe(U,o.expandedFarZProjMatrix,U);for(let j=0;j<F.meshes.length;++j){const H=F.meshes[j];if(j===F.lightMeshIndex)continue;const W=Nx(C,o,U,H.aabb);W!=null&&(d=Math.min(W,d))}if(F.children)for(const j of F.children)R(j)};if(R(f),d===Number.MAX_VALUE)return;const k=new r(0,0);return g1(_.tileID.canonical,k,l.node.anchor[0],l.node.anchor[1]),{intersectionZ:d,position:k,feature:l.feature}}const sL={circle:class extends lo{constructor(n,e,i,o){super(n,{layout:xo||(xo=new Bn({"circle-sort-key":new _t(Se.layout_circle["circle-sort-key"]),"circle-elevation-reference":new ut(Se.layout_circle["circle-elevation-reference"]),visibility:new ut(Se.layout_circle.visibility)})),paint:Nn||(Nn=new Bn({"circle-radius":new _t(Se.paint_circle["circle-radius"]),"circle-color":new _t(Se.paint_circle["circle-color"]),"circle-blur":new _t(Se.paint_circle["circle-blur"]),"circle-opacity":new _t(Se.paint_circle["circle-opacity"]),"circle-translate":new ut(Se.paint_circle["circle-translate"]),"circle-translate-anchor":new ut(Se.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new ut(Se.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new ut(Se.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new _t(Se.paint_circle["circle-stroke-width"]),"circle-stroke-color":new _t(Se.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new _t(Se.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new ut(Se.paint_circle["circle-emissive-strength"]),"circle-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"circle-stroke-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o)}createBucket(n){return new Xi(n)}queryRadius(n){const e=n;return qr("circle-radius",this,e)+qr("circle-stroke-width",this,e)+zr(this.paint.get("circle-translate"))}queryIntersectsFeature(n,e,i,o,l,d,f,_){const v=ns(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),d.angle,n.pixelToTileUnitsFactor),b=this.paint.get("circle-radius").evaluate(e,i)+this.paint.get("circle-stroke-width").evaluate(e,i);return wT(n,o,d,f,_,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",v,b)}getProgramIds(){return["circle"]}getDefaultProgramParams(n,e,i){const o=xT(this);return{config:new ul(this,{zoom:e,lut:i}),defines:o,overrideFog:!1}}is3D(n){return!n&&!!this.layout&&this.layout.get("circle-elevation-reference")!=="none"}hasElevation(){return this.layout&&this.layout.get("circle-elevation-reference")!=="none"}},heatmap:class extends lo{createBucket(n){return new TT(n)}constructor(n,e,i,o){super(n,{layout:ST||(ST=new Bn({visibility:new ut(Se.layout_heatmap.visibility)})),paint:ET||(ET=new Bn({"heatmap-radius":new _t(Se.paint_heatmap["heatmap-radius"]),"heatmap-weight":new _t(Se.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new ut(Se.paint_heatmap["heatmap-intensity"]),"heatmap-color":new ql(Se.paint_heatmap["heatmap-color"]),"heatmap-opacity":new ut(Se.paint_heatmap["heatmap-opacity"]),"heatmap-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(n){n==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=wm({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}_clear(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}queryRadius(n){return qr("heatmap-radius",this,n)}queryIntersectsFeature(n,e,i,o,l,d,f,_){const v=this.paint.get("heatmap-radius").evaluate(e,i);return wT(n,o,d,f,_,!0,!0,new et(0,0),v)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(n,e,i){return n==="heatmap"?{config:new ul(this,{zoom:e,lut:i}),overrideFog:!1}:{}}},hillshade:class extends lo{constructor(n,e,i,o){super(n,{layout:IT||(IT=new Bn({visibility:new ut(Se.layout_hillshade.visibility)})),paint:AT||(AT=new Bn({"hillshade-illumination-direction":new ut(Se.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new ut(Se.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new ut(Se.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new ut(Se.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new ut(Se.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new ut(Se.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new ut(Se.paint_hillshade["hillshade-emissive-strength"]),"hillshade-shadow-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"hillshade-highlight-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"hillshade-accent-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o)}shouldRedrape(){return this.hasOffscreenPass()&&this.paint.get("hillshade-illumination-anchor")==="viewport"}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(n,e,i){return{overrideFog:!1}}},fill:class extends lo{constructor(n,e,i,o){super(n,{layout:VT||(VT=new Bn({"fill-sort-key":new _t(Se.layout_fill["fill-sort-key"]),visibility:new ut(Se.layout_fill.visibility),"fill-elevation-reference":new ut(Se.layout_fill["fill-elevation-reference"]),"fill-construct-bridge-guard-rail":new _t(Se.layout_fill["fill-construct-bridge-guard-rail"])})),paint:$T||($T=new Bn({"fill-antialias":new ut(Se.paint_fill["fill-antialias"]),"fill-opacity":new _t(Se.paint_fill["fill-opacity"]),"fill-color":new _t(Se.paint_fill["fill-color"]),"fill-outline-color":new _t(Se.paint_fill["fill-outline-color"]),"fill-translate":new ut(Se.paint_fill["fill-translate"]),"fill-translate-anchor":new ut(Se.paint_fill["fill-translate-anchor"]),"fill-pattern":new _t(Se.paint_fill["fill-pattern"]),"fill-pattern-cross-fade":new ut(Se.paint_fill["fill-pattern-cross-fade"]),"fill-emissive-strength":new ut(Se.paint_fill["fill-emissive-strength"]),"fill-z-offset":new _t(Se.paint_fill["fill-z-offset"]),"fill-bridge-guard-rail-color":new _t(Se.paint_fill["fill-bridge-guard-rail-color"]),"fill-tunnel-structure-color":new _t(Se.paint_fill["fill-tunnel-structure-color"]),"fill-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"fill-outline-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"fill-bridge-guard-rail-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"fill-tunnel-structure-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o)}getProgramIds(){const n=this.paint.get("fill-pattern"),e=n&&n.constantOr(1),i=[e?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&i.push(e&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),i}getDefaultProgramParams(n,e,i){return{config:new ul(this,{zoom:e,lut:i}),overrideFog:!1}}recalculate(n,e){super.recalculate(n,e);const i=this.paint._values["fill-outline-color"];i.value.kind==="constant"&&i.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(n){return new bx(n)}queryRadius(){return zr(this.paint.get("fill-translate"))}queryIntersectsFeature(n,e,i,o,l,d){return!n.queryGeometry.isAboveHorizon&&$i(No(n.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),d.angle,n.pixelToTileUnitsFactor),o)}isTileClipped(){return this.paint.get("fill-z-offset").constantOr(1)===0}is3D(n){if(this.paint.get("fill-z-offset").constantOr(1)!==0)return!0;const e=this.layout&&this.layout.get("fill-elevation-reference")!=="none";return n!=null?e&&!n:e}hasElevation(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}hasShadowPass(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}},"fill-extrusion":class extends lo{constructor(n,e,i,o){super(n,{layout:mS||(mS=new Bn({visibility:new ut(Se["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new ut(Se["layout_fill-extrusion"]["fill-extrusion-edge-radius"])})),paint:_S||(_S=new Bn({"fill-extrusion-opacity":new ut(Se["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new _t(Se["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new ut(Se["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new ut(Se["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new _t(Se["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-pattern-cross-fade":new ut(Se["paint_fill-extrusion"]["fill-extrusion-pattern-cross-fade"]),"fill-extrusion-height":new _t(Se["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new _t(Se["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-height-alignment":new ut(Se["paint_fill-extrusion"]["fill-extrusion-height-alignment"]),"fill-extrusion-base-alignment":new ut(Se["paint_fill-extrusion"]["fill-extrusion-base-alignment"]),"fill-extrusion-vertical-gradient":new ut(Se["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new ut(Se["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new ut(Se["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new ut(Se["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new ut(Se["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new ut(Se["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new ut(Se["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new ut(Se["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new _t(Se["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new _t(Se["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new ut(Se["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new ut(Se["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new ut(Se["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new ut(Se["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new _t(Se["paint_fill-extrusion"]["fill-extrusion-emissive-strength"]),"fill-extrusion-line-width":new _t(Se["paint_fill-extrusion"]["fill-extrusion-line-width"]),"fill-extrusion-cast-shadows":new ut(Se["paint_fill-extrusion"]["fill-extrusion-cast-shadows"]),"fill-extrusion-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"fill-extrusion-flood-light-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(n){return new by(n)}queryRadius(){return zr(this.paint.get("fill-extrusion-translate"))}is3D(n){return!0}hasShadowPass(){return this.paint.get("fill-extrusion-cast-shadows")}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(n,e,i,o,l,d,f,_,v){const b=ns(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),d.angle,n.pixelToTileUnitsFactor),E=this.paint.get("fill-extrusion-height").evaluate(e,i),I=this.paint.get("fill-extrusion-base").evaluate(e,i),C=[0,0],R=_&&d.elevation,k=d.elevation?d.elevation.exaggeration():1,F=n.tile.getBucket(this);if(R&&F instanceof by){const Y=F.centroidVertexArray,se=v+1;se<Y.length&&(C[0]=Y.geta_centroid_pos0(se),C[1]=Y.geta_centroid_pos1(se))}if(C[0]===0&&C[1]===1)return!1;d.projection.name==="globe"&&(o=pS([o],[new et(0,0),new et(dt,dt)],n.tileID.canonical).map(Y=>Y.polygon).flat());const U=R?_:null,[j,H]=TS(d,o,I,E,b,f,U,C,k,d.center.lat,n.tileID.canonical),W=n.queryGeometry;return bS(j,H,W.isPointQuery()?W.screenBounds:W.screenGeometry)}},building:class extends lo{constructor(n,e,i,o){super(n,{layout:WS||(WS=new Bn({visibility:new ut(Se.layout_building.visibility),"building-facade":new _t(Se.layout_building["building-facade"]),"building-facade-floors":new _t(Se.layout_building["building-facade-floors"]),"building-facade-unit-width":new _t(Se.layout_building["building-facade-unit-width"]),"building-facade-window":new _t(Se.layout_building["building-facade-window"]),"building-roof-shape":new _t(Se.layout_building["building-roof-shape"]),"building-height":new _t(Se.layout_building["building-height"]),"building-base":new _t(Se.layout_building["building-base"]),"building-flood-light-wall-radius":new _t(Se.layout_building["building-flood-light-wall-radius"]),"building-flood-light-ground-radius":new _t(Se.layout_building["building-flood-light-ground-radius"]),"building-flip-roof-orientation":new _t(Se.layout_building["building-flip-roof-orientation"])})),paint:ZS||(ZS=new Bn({"building-opacity":new ut(Se.paint_building["building-opacity"]),"building-ambient-occlusion-intensity":new ut(Se.paint_building["building-ambient-occlusion-intensity"]),"building-ambient-occlusion-ground-intensity":new ut(Se.paint_building["building-ambient-occlusion-ground-intensity"]),"building-ambient-occlusion-ground-radius":new ut(Se.paint_building["building-ambient-occlusion-ground-radius"]),"building-ambient-occlusion-ground-attenuation":new ut(Se.paint_building["building-ambient-occlusion-ground-attenuation"]),"building-vertical-scale":new ut(Se.paint_building["building-vertical-scale"]),"building-cast-shadows":new ut(Se.paint_building["building-cast-shadows"]),"building-color":new _t(Se.paint_building["building-color"]),"building-emissive-strength":new _t(Se.paint_building["building-emissive-strength"]),"building-facade-emissive-chance":new ut(Se.paint_building["building-facade-emissive-chance"]),"building-cutoff-fade-range":new ut(Se.paint_building["building-cutoff-fade-range"]),"building-flood-light-color":new ut(Se.paint_building["building-flood-light-color"]),"building-flood-light-intensity":new ut(Se.paint_building["building-flood-light-intensity"]),"building-flood-light-ground-attenuation":new ut(Se.paint_building["building-flood-light-ground-attenuation"]),"building-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"building-flood-light-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(n){return new qS(n)}cutoffRange(){return this.paint.get("building-cutoff-fade-range")}hasShadowPass(){return this.paint.get("building-cast-shadows")}hasLightBeamPass(){return!0}canCastShadows(){return!0}is3D(n){return!0}queryRadius(n){return 0}queryIntersectsFeature(n,e,i,o,l,d,f,_,v){let b=this.layout.get("building-height").evaluate(e,i);const E=this.layout.get("building-base").evaluate(e,i),I=n.tile.getBucket(this).getFootprint(e);if(I){if(I.hiddenFlags!==0)return!1;b=I.height}const[C,R]=TS(d,o,E,b,new et(0,0),f,null,[0,0],1,d.center.lat,n.tileID.canonical),k=n.queryGeometry;return bS(C,R,k.isPointQuery()?k.screenBounds:k.screenGeometry)}},line:class extends lo{constructor(n,e,i,o){const l=r2();super(n,l,e,i,o),l.layout&&(this.layout=new Hl(l.layout)),this.gradientVersion=0,this.hasElevatedBuckets=!1,this.hasNonElevatedBuckets=!1}_handleSpecialPaintPropertyUpdate(n){if(n==="line-gradient"){const e=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=e._styleExpression&&e._styleExpression.expression instanceof Uu,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}emissiveStrengthExpression(){return this._transitionablePaint._values["line-emissive-strength"].value.expression}recalculate(n,e){super.recalculate(n,e),this.paint._values["line-floorwidth"]=(()=>{if(Bm)return Bm;const i=r2();return Bm=new ek(i.paint.properties["line-width"].specification),Bm.useIntegerZoom=!0,Bm})().possiblyEvaluate(this._transitioningPaint._values["line-width"].value,n)}createBucket(n){return new qx(n)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(n,e,i){const o=i2(this);return{config:new ul(this,{zoom:e,lut:i}),defines:o,overrideFog:!1}}queryRadius(n){const e=n,i=o2(qr("line-width",this,e),qr("line-gap-width",this,e)),o=qr("line-offset",this,e);return i/2+Math.abs(o)+zr(this.paint.get("line-translate"))}queryIntersectsFeature(n,e,i,o,l,d){if(n.queryGeometry.isAboveHorizon)return!1;const f=No(n.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),d.angle,n.pixelToTileUnitsFactor),_=n.pixelToTileUnitsFactor/2*o2(this.paint.get("line-width").evaluate(e,i),this.paint.get("line-gap-width").evaluate(e,i)),v=this.paint.get("line-offset").evaluate(e,i);return v&&(o=function(b,E){const I=[],C=new et(0,0);for(let R=0;R<b.length;R++){const k=b[R],F=[];for(let U=0;U<k.length;U++){const j=k[U],H=k[U+1],W=U===0?C:j.sub(k[U-1])._unit()._perp(),Y=U===k.length-1?C:H.sub(j)._unit()._perp(),se=W._add(Y)._unit();se._mult(1/(se.x*Y.x+se.y*Y.y)),F.push(se._mult(E)._add(j))}I.push(F)}return I}(o,v*n.pixelToTileUnitsFactor)),function(b,E,I){for(let C=0;C<E.length;C++){const R=E[C];if(b.length>=3){for(let k=0;k<R.length;k++)if(rn(b,R[k]))return!0}if(zn(b,R,I))return!0}return!1}(f,o,_)}isTileClipped(){return this.hasNonElevatedBuckets}isDraped(n){return!this.hasElevatedBuckets||this.layout&&this.layout.get("line-elevation-reference")==="hd-road-markup"}hasElevation(){return this.layout&&this.layout.get("line-elevation-reference")!=="none"}},symbol:Wy,background:class extends lo{constructor(n,e,i,o){super(n,{layout:W2||(W2=new Bn({visibility:new ut(Se.layout_background.visibility)})),paint:Z2||(Z2=new Bn({"background-pitch-alignment":new ut(Se.paint_background["background-pitch-alignment"]),"background-color":new ut(Se.paint_background["background-color"]),"background-pattern":new ut(Se.paint_background["background-pattern"]),"background-opacity":new ut(Se.paint_background["background-opacity"]),"background-emissive-strength":new ut(Se.paint_background["background-emissive-strength"]),"background-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(n,e,i){return{overrideFog:!1}}is3D(n){return this.paint.get("background-pitch-alignment")==="viewport"}},raster:Q2,"raster-particle":oE,sky:class extends lo{constructor(n,e,i,o){super(n,{layout:iE||(iE=new Bn({visibility:new ut(Se.layout_sky.visibility)})),paint:nE||(nE=new Bn({"sky-type":new ut(Se.paint_sky["sky-type"]),"sky-atmosphere-sun":new ut(Se.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new ut(Se.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new ut(Se.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new ut(Se.paint_sky["sky-gradient-radius"]),"sky-gradient":new ql(Se.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new ut(Se.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new ut(Se.paint_sky["sky-atmosphere-color"]),"sky-opacity":new ut(Se.paint_sky["sky-opacity"]),"sky-gradient-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-halo-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o),this._updateColorRamp()}_clear(){this.skyboxFbo&&(this.skyboxFbo.destroy(),this.skyboxFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this._skyboxInvalidated=!0}_handleSpecialPaintPropertyUpdate(n){n==="sky-gradient"?this._updateColorRamp():n!=="sky-atmosphere-sun"&&n!=="sky-atmosphere-halo-color"&&n!=="sky-atmosphere-color"&&n!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=wm({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(n){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const e=n.style.light.properties.get("position");return this._lightPosition.azimuthal!==e.azimuthal||this._lightPosition.polar!==e.polar}return!1}getCenter(n,e){if(this.paint.get("sky-type")==="atmosphere"){const o=this.paint.get("sky-atmosphere-sun"),l=!o,d=n.style.light,f=d.properties.get("position");return l&&d.properties.get("anchor")==="viewport"&&bt("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),l?f1(f.azimuthal,90-f.polar,e):f1(o[0],90-o[1],e)}const i=this.paint.get("sky-gradient-center");return f1(i[0],90-i[1],e)}isSky(){return!0}markSkyboxValid(n){this._skyboxInvalidated=!1,this._lightPosition=n.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const n=this.paint.get("sky-type");return n==="atmosphere"?["skyboxCapture","skybox"]:n==="gradient"?["skyboxGradient"]:null}},slot:class extends lo{constructor(n,e,i,o){super(n,{paint:rE||(rE=new Bn({}))},e,null)}},model:class extends lo{constructor(n,e,i,o){super(n,{layout:cE||(cE=new Bn({visibility:new ut(Se.layout_model.visibility),"model-id":new _t(Se.layout_model["model-id"])})),paint:uE||(uE=new Bn({"model-opacity":new _t(Se.paint_model["model-opacity"]),"model-rotation":new _t(Se.paint_model["model-rotation"]),"model-scale":new _t(Se.paint_model["model-scale"]),"model-translation":new _t(Se.paint_model["model-translation"]),"model-color":new _t(Se.paint_model["model-color"]),"model-color-mix-intensity":new _t(Se.paint_model["model-color-mix-intensity"]),"model-type":new ut(Se.paint_model["model-type"]),"model-cast-shadows":new ut(Se.paint_model["model-cast-shadows"]),"model-receive-shadows":new ut(Se.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new ut(Se.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new _t(Se.paint_model["model-emissive-strength"]),"model-roughness":new _t(Se.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new _t(Se.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new ut(Se.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new ut(Se.paint_model["model-front-cutoff"]),"model-elevation-reference":new ut(Se.paint_model["model-elevation-reference"]),"model-color-use-theme":new _t({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o),this.layer=n,this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(n){return new m1(n)}getProgramIds(){return["model"]}is3D(n){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(n){return n instanceof Yy?dt-1:0}queryRenderedFeatures(n,e,i){const o=e.getSource();if(!(o&&o instanceof gh))return{};const l=o,d={};d[this.id]=[];const f=d[this.id];let _=0;for(const v of l.models){const b=e.getFeatureState(this.sourceLayer,v.id),E={type:"Unknown",id:v.id,properties:v.featureProperties},I=this.paint.get("model-rotation").evaluate(E,b),C=this.paint.get("model-scale").evaluate(E,b),R=this.paint.get("model-translation").evaluate(E,b),k=this.paint.get("model-elevation-reference");let F=[];Ry(F,v,i,v.position,I,C,R,k==="ground",k==="ground",!1),i.projection.name==="globe"&&(F=My(F,i));const U=xe([],i.projMatrix,F),j=Nx(n.isPointQuery()?n.screenBounds:n.screenGeometry,i,U,v.aabb);if(j!=null){const H=new _h(void 0,0,0,0,v.id);H.layer=this.layer,H.properties=structuredClone(v.featureProperties),H.properties.layer=this.id,H.properties.uri=v.uri,H.properties.orientation=v.orientation,H.sourceLayer=this.sourceLayer,H.geometry={type:"Point",coordinates:[v.position.lng,v.position.lat]},H.state=b,H.source=this.source,f.push({featureIndex:_,feature:H,intersectionZ:j})}++_}return d}queryIntersectsFeature(n,e,i,o,l,d){if(!this.modelManager)return!1;const f=this.modelManager,_=n.tile.getBucket(this);if(!(_&&_ instanceof m1))return!1;for(const v in _.instancesPerModel){const b=_.instancesPerModel[v],E=e.id!==void 0?e.id:e.properties&&e.properties.hasOwnProperty("id")?e.properties.id:void 0;if(b.idToFeaturesIndex.hasOwnProperty(E)){const I=b.features[b.idToFeaturesIndex[E]],C=f.getModel(v,this.scope);if(!C)return!1;let R=[];const k=new r(0,0),F=_.canonical;let U=Number.MAX_VALUE;for(let j=0;j<I.instancedDataCount;++j){const H=16*(I.instancedDataOffset+j),W=b.instancedDataArray.float32,Y=[W[H+4],W[H+5],W[H+6]];g1(F,k,Math.floor(W[H]),Math.floor(W[H+1])),Ry(R,C,d,k,I.rotation,I.scale,Y,!1,!1,!1),d.projection.name==="globe"&&(R=My(R,d));const se=xe([],d.projMatrix,R),ie=n.queryGeometry,ce=Nx(ie.isPointQuery()?ie.screenBounds:ie.screenGeometry,d,se,C.aabb);ce!=null&&(U=Math.min(ce,U))}return U!==Number.MAX_VALUE&&U}}return!1}_handleOverridablePaintPropertyUpdate(n,e,i){return!(!this.layout||e.isDataDriven()||i.isDataDriven()||n!=="model-color"&&n!=="model-color-mix-intensity"&&n!=="model-rotation"&&n!=="model-scale"&&n!=="model-translation"&&n!=="model-emissive-strength")}_isPropertyZoomDependent(n){const e=this._transitionablePaint._values[n];return e!=null&&e.value!=null&&e.value.expression!=null&&e.value.expression instanceof Vl}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}},clip:class extends lo{constructor(n,e,i,o){super(n,{layout:GT||(GT=new Bn({"clip-layer-types":new ut(Se.layout_clip["clip-layer-types"]),"clip-layer-scope":new ut(Se.layout_clip["clip-layer-scope"])})),paint:HT||(HT=new Bn({}))},e,i,o)}recalculate(n,e){super.recalculate(n,e)}createBucket(n){return new qT(n)}is3D(n){return!0}}},y1=new Zi(0,0,0),v1={PATH_RULE_NON_ZERO:1,PATH_RULE_EVEN_ODD:2},x1={LINE_CAP_BUTT:1,LINE_CAP_ROUND:2,LINE_CAP_SQUARE:3},Jy={LINE_JOIN_MITER:1,LINE_JOIN_MITER_CLIP:2,LINE_JOIN_ROUND:3,LINE_JOIN_BEVEL:4},aL={PAINT_ORDER_FILL_AND_STROKE:1},e_={PATH_COMMAND_MOVE:1,PATH_COMMAND_LINE:2,PATH_COMMAND_QUAD:3,PATH_COMMAND_CUBIC:4,PATH_COMMAND_CLOSE:5},mE={MASK_TYPE_LUMINANCE:1};function lL(n,e,i){n===1&&e.icons.push(function(o,l){return function(d){if(d.usvg_tree.height||(d.usvg_tree.height=d.usvg_tree.width),!d.metadata)return d;const{metadata:f}=d;if(f.content_area){const{content_area:_}=f;_.left==null&&(_.left=0),_.top==null&&(_.top=_.left),_.width==null&&(_.width=d.usvg_tree.width),_.height==null&&(_.height=_.width)}if(f.text_placeholder){const{text_placeholder:_}=f;_.top==null&&(_.top=_.left),_.height==null&&(_.height=_.width)}return f.stretch_x&&f.stretch_x.length&&_E(f,"x"),f.stretch_y&&f.stretch_y.length&&_E(f,"y"),d}(o.readFields(cL,{name:void 0},l))}(i,i.readVarint()+i.pos))}function _E(n,e){const i=[],o=n[`stretch_${e}`];let l=null;for(let d=0;d<o.length;d++)l===null?l=i.length===0?o[0]:i[i.length-1][1]+o[d]:(i.push([l,l+o[d]]),l=null);n[`stretch_${e}_areas`]=i}function cL(n,e,i){n===1?e.name=i.readString():n===2?e.metadata=function(o,l){return o.readFields(uL,{stretch_x:null,stretch_y:null,stretch_x_areas:null,stretch_y_areas:null,variables:[]},l)}(i,i.readVarint()+i.pos):n===3&&(e.usvg_tree=function(o,l){return o.readFields(fL,{width:20,children:[],linear_gradients:[],radial_gradients:[],clip_paths:[],masks:[]},l)}(i,i.readVarint()+i.pos),e.data="usvg_tree")}function uL(n,e,i){n===1?e.stretch_x=i.readPackedVarint():n===2?e.stretch_y=i.readPackedVarint():n===3?e.content_area=gE(i,i.readVarint()+i.pos):n===4?e.variables.push(function(o,l){return o.readFields(dL,{name:void 0},l)}(i,i.readVarint()+i.pos)):n===5&&(e.text_placeholder=gE(i,i.readVarint()+i.pos))}function gE(n,e){return n.readFields(hL,{},e)}function hL(n,e,i){n===1?e.left=i.readVarint():n===2?e.width=i.readVarint():n===3?e.top=i.readVarint():n===4&&(e.height=i.readVarint())}function dL(n,e,i){n===1?e.name=i.readString():n===2&&(e.rgb_color=t0(i.readVarint()),e.value="rgb_color")}function fL(n,e,i){n===1?e.width=e.height=i.readVarint():n===2?e.height=i.readVarint():n===3?e.children.push(Qy(i,i.readVarint()+i.pos)):n===4?e.linear_gradients.push(function(o,l){return o.readFields(xL,{spread_method:1,stops:[],x1:0,y1:0,x2:1,y2:0},l)}(i,i.readVarint()+i.pos)):n===5?e.radial_gradients.push(function(o,l){return o.readFields(bL,{spread_method:1,stops:[],cx:.5,cy:.5,r:.5,fx:.5,fy:.5,fr:0},l)}(i,i.readVarint()+i.pos)):n===7?e.clip_paths.push(function(o,l){return o.readFields(TL,{children:[]},l)}(i,i.readVarint()+i.pos)):n===8&&e.masks.push(function(o,l){const d=o.readFields(SL,{left:0,width:20,mask_type:mE.MASK_TYPE_LUMINANCE,children:[]},l);return d.height==null&&(d.height=d.width),d.top==null&&(d.top=d.left),d}(i,i.readVarint()+i.pos))}function Qy(n,e){return n.readFields(pL,{},e)}function pL(n,e,i){n===1?(e.group=function(o,l){return o.readFields(mL,{opacity:255,children:[]},l)}(i,i.readVarint()+i.pos),e.node="group"):n===2&&(e.path=function(o,l){return o.readFields(gL,{paint_order:1,commands:[],step:1,diffs:[],rule:v1.PATH_RULE_NON_ZERO},l)}(i,i.readVarint()+i.pos),e.node="path")}function mL(n,e,i){n===1?e.transform=e0(i,i.readVarint()+i.pos):n===2?e.opacity=i.readVarint():n===5?e.clip_path_idx=i.readVarint():n===6?e.mask_idx=i.readVarint():n===7&&e.children.push(Qy(i,i.readVarint()+i.pos))}function e0(n,e){return n.readFields(_L,{sx:1,ky:0,kx:0,sy:1,tx:0,ty:0},e)}function _L(n,e,i){n===1?e.sx=i.readFloat():n===2?e.ky=i.readFloat():n===3?e.kx=i.readFloat():n===4?e.sy=i.readFloat():n===5?e.tx=i.readFloat():n===6&&(e.ty=i.readFloat())}function gL(n,e,i){n===1?e.fill=function(o,l){return o.readFields(yL,{rgb_color:y1,paint:"rgb_color",opacity:255},l)}(i,i.readVarint()+i.pos):n===2?e.stroke=function(o,l){return o.readFields(vL,{rgb_color:y1,paint:"rgb_color",dasharray:[],dashoffset:0,miterlimit:4,opacity:255,width:1,linecap:1,linejoin:1},l)}(i,i.readVarint()+i.pos):n===3?e.paint_order=i.readVarint():n===5?i.readPackedVarint(e.commands):n===6?e.step=i.readFloat():n===7?i.readPackedSVarint(e.diffs):n===8&&(e.rule=i.readVarint())}function yL(n,e,i){n===1?(e.rgb_color=t0(i.readVarint()),e.paint="rgb_color"):n===2?(e.linear_gradient_idx=i.readVarint(),e.paint="linear_gradient_idx"):n===3?(e.radial_gradient_idx=i.readVarint(),e.paint="radial_gradient_idx"):n===5&&(e.opacity=i.readVarint())}function t0(n){return new Zi((n>>16&255)/255,(n>>8&255)/255,(255&n)/255,1)}function vL(n,e,i){n===1?(e.rgb_color=t0(i.readVarint()),e.paint="rgb_color"):n===2?(e.linear_gradient_idx=i.readVarint(),e.paint="linear_gradient_idx"):n===3?(e.radial_gradient_idx=i.readVarint(),e.paint="radial_gradient_idx"):n===5?i.readPackedFloat(e.dasharray):n===6?e.dashoffset=i.readFloat():n===7?e.miterlimit=i.readFloat():n===8?e.opacity=i.readVarint():n===9?e.width=i.readFloat():n===10?e.linecap=i.readVarint():n===11&&(e.linejoin=i.readVarint())}function xL(n,e,i){n===1?e.transform=e0(i,i.readVarint()+i.pos):n===2?e.spread_method=i.readVarint():n===3?e.stops.push(yE(i,i.readVarint()+i.pos)):n===4?e.x1=i.readFloat():n===5?e.y1=i.readFloat():n===6?e.x2=i.readFloat():n===7&&(e.y2=i.readFloat())}function yE(n,e){return n.readFields(wL,{offset:0,opacity:255,rgb_color:y1},e)}function wL(n,e,i){n===1?e.offset=i.readFloat():n===2?e.opacity=i.readVarint():n===3&&(e.rgb_color=t0(i.readVarint()))}function bL(n,e,i){n===1?e.transform=e0(i,i.readVarint()+i.pos):n===2?e.spread_method=i.readVarint():n===3?e.stops.push(yE(i,i.readVarint()+i.pos)):n===4?e.cx=i.readFloat():n===5?e.cy=i.readFloat():n===6?e.r=i.readFloat():n===7?e.fx=i.readFloat():n===8?e.fy=i.readFloat():n===9&&(e.fr=i.readFloat())}function TL(n,e,i){n===1?e.transform=e0(i,i.readVarint()+i.pos):n===2?e.clip_path_idx=i.readVarint():n===3&&e.children.push(Qy(i,i.readVarint()+i.pos))}function SL(n,e,i){n===1?e.left=e.top=i.readFloat():n===2?e.width=e.height=i.readFloat():n===3?e.top=i.readFloat():n===4?e.height=i.readFloat():n===5?e.mask_type=i.readVarint():n===6?e.mask_idx=i.readVarint():n===7&&e.children.push(Qy(i,i.readVarint()+i.pos))}class EL{static calculate(e={},i=[]){const o=new Map,l=new Map;if(Object.keys(e).length===0)return o;i.forEach(d=>{l.set(d.name,d.rgb_color||new Zi(0,0,0))});for(const[d,f]of Object.entries(e))l.has(d)?o.set(l.get(d).toString(),f):console.warn(`Ignoring unknown image variable "${d}"`);return o}}function xf(n,e=255,i){const o=e/255,l=n.toString(),d=i.has(l)?i.get(l).clone():n.clone();return d.a*=o,d.toString()}function t_(n,e){if(!zs()){const i=document.createElement("canvas");return i.width=n,i.height=e,i}return new OffscreenCanvas(n,e)}let w1,i_=null;function b1(n,e,i,o,l){for(const d of o.children)vE(n,e,i,d,l)}function vE(n,e,i,o,l){o.group?(n.save(),function(d,f,_,v,b){const E=v.mask_idx!=null?_.masks[v.mask_idx]:null,I=v.clip_path_idx!=null?_.clip_paths[v.clip_path_idx]:null;if(v.transform&&(f=wf(v.transform).preMultiplySelf(f)),!function(k,F,U){return k.opacity!==255||F||U}(v,I!=null,E!=null))return void b1(d,f,_,v,b);const C=t_(d.canvas.width,d.canvas.height),R=C.getContext("2d");b1(R,f,_,v,b),I&&IE(R,f,_,I),E&&AE(R,f,_,E,b),d.globalAlpha=v.opacity/255,d.drawImage(C,0,0)}(n,e,i,o.group,l),n.restore()):o.path&&(n.save(),function(d,f,_,v,b){d.setTransform(f),v.paint_order===aL.PAINT_ORDER_FILL_AND_STROKE?(xE(d,_,v,b),bE(d,_,v,b)):(bE(d,_,v,b),xE(d,_,v,b))}(n,e,i,o.path,l),n.restore())}function xE(n,e,i,o){const l=i.fill;if(!l)return;const d=l.opacity/255;switch(n.save(),n.beginPath(),CE(i,n),l.paint){case"rgb_color":n.fillStyle=xf(l.rgb_color,l.opacity,o);break;case"linear_gradient_idx":{const f=e.linear_gradients[l.linear_gradient_idx];f.transform&&n.setTransform(wf(f.transform).preMultiplySelf(n.getTransform())),n.fillStyle=TE(n,f,d,o);break}case"radial_gradient_idx":{const f=e.radial_gradients[l.radial_gradient_idx];f.transform&&n.setTransform(wf(f.transform).preMultiplySelf(n.getTransform())),n.fillStyle=SE(n,f,d,o)}}n.fill(wE(i)),n.restore()}function wE(n){return n.rule===v1.PATH_RULE_NON_ZERO?"nonzero":n.rule===v1.PATH_RULE_EVEN_ODD?"evenodd":void 0}function bE(n,e,i,o){const l=i.stroke;if(!l)return;const d=PE(i);n.lineWidth=l.width,n.miterLimit=l.miterlimit,n.setLineDash(l.dasharray),n.lineDashOffset=l.dashoffset;const f=l.opacity/255;switch(l.paint){case"rgb_color":n.strokeStyle=xf(l.rgb_color,l.opacity,o);break;case"linear_gradient_idx":n.strokeStyle=TE(n,e.linear_gradients[l.linear_gradient_idx],f,o,!0);break;case"radial_gradient_idx":n.strokeStyle=SE(n,e.radial_gradients[l.radial_gradient_idx],f,o,!0)}switch(l.linejoin){case Jy.LINE_JOIN_MITER_CLIP:case Jy.LINE_JOIN_MITER:n.lineJoin="miter";break;case Jy.LINE_JOIN_ROUND:n.lineJoin="round";break;case Jy.LINE_JOIN_BEVEL:n.lineJoin="bevel"}switch(l.linecap){case x1.LINE_CAP_BUTT:n.lineCap="butt";break;case x1.LINE_CAP_ROUND:n.lineCap="round";break;case x1.LINE_CAP_SQUARE:n.lineCap="square"}n.stroke(d)}function TE(n,e,i,o,l=!1){if(e.stops.length===1){const C=e.stops[0];return xf(C.rgb_color,C.opacity*i,o)}const{x1:d,y1:f,x2:_,y2:v}=e;let b=new DOMPoint(d,f),E=new DOMPoint(_,v);if(l){const C=wf(e.transform);b=C.transformPoint(b),E=C.transformPoint(E)}const I=n.createLinearGradient(b.x,b.y,E.x,E.y);for(const C of e.stops)I.addColorStop(C.offset,xf(C.rgb_color,C.opacity*i,o));return I}function SE(n,e,i,o,l=!1){if(e.stops.length===1){const j=e.stops[0];return xf(j.rgb_color,j.opacity*i,o)}const d=wf(e.transform),{fx:f,fy:_,fr:v,cx:b,cy:E,r:I}=e;let C=new DOMPoint(f,_),R=new DOMPoint(b,E),k=v,F=I;if(l){C=d.transformPoint(C),R=d.transformPoint(R);const j=(d.a+d.d)/2;k=v*j,F=e.r*j}const U=n.createRadialGradient(C.x,C.y,k,R.x,R.y,F);for(const j of e.stops)U.addColorStop(j.offset,xf(j.rgb_color,j.opacity*i,o));return U}function EE(n,e,i,o){const l=o.transform?wf(o.transform).preMultiplySelf(e):e,d=t_(n.canvas.width,n.canvas.height),f=d.getContext("2d");for(const v of o.children)if(v.group)EE(f,l,i,v.group);else if(v.path){const b=v.path,E=new Path2D;E.addPath(PE(b),l),f.fill(E,wE(b))}const _=o.clip_path_idx!=null?i.clip_paths[o.clip_path_idx]:null;_&&IE(f,l,i,_),n.globalCompositeOperation="source-over",n.drawImage(d,0,0)}function IE(n,e,i,o){const l=t_(n.canvas.width,n.canvas.height);EE(l.getContext("2d"),e,i,o),n.globalCompositeOperation="destination-in",n.drawImage(l,0,0)}function AE(n,e,i,o,l){if(o.children.length===0)return;const d=o.mask_idx!=null?i.masks[o.mask_idx]:null;d&&AE(n,e,i,d,l);const f=n.canvas.width,_=n.canvas.height,v=t_(f,_),b=v.getContext("2d"),E=o.width,I=o.height,C=o.left,R=o.top,k=new Path2D,F=new Path2D;F.rect(C,R,E,I),k.addPath(F,e),b.clip(k);for(const H of o.children)vE(b,e,i,H,l);const U=b.getImageData(0,0,f,_),j=U.data;if(o.mask_type===mE.MASK_TYPE_LUMINANCE)for(let H=0;H<j.length;H+=4)j[H+3]=j[H+3]/255*(.2126*j[H]+.7152*j[H+1]+.0722*j[H+2]);b.putImageData(U,0,0),n.globalCompositeOperation="destination-in",n.drawImage(v,0,0)}function wf(n){return n?new DOMMatrix([n.sx,n.ky,n.kx,n.sy,n.tx,n.ty]):new DOMMatrix}function CE(n,e){const i=n.step;let o=n.diffs[0]*i,l=n.diffs[1]*i;e.moveTo(o,l);for(let d=0,f=2;d<n.commands.length;d++)switch(n.commands[d]){case e_.PATH_COMMAND_MOVE:o+=n.diffs[f++]*i,l+=n.diffs[f++]*i,e.moveTo(o,l);break;case e_.PATH_COMMAND_LINE:o+=n.diffs[f++]*i,l+=n.diffs[f++]*i,e.lineTo(o,l);break;case e_.PATH_COMMAND_QUAD:{const _=o+n.diffs[f++]*i,v=l+n.diffs[f++]*i;o=_+n.diffs[f++]*i,l=v+n.diffs[f++]*i,e.quadraticCurveTo(_,v,o,l);break}case e_.PATH_COMMAND_CUBIC:{const _=o+n.diffs[f++]*i,v=l+n.diffs[f++]*i,b=_+n.diffs[f++]*i,E=v+n.diffs[f++]*i;o=b+n.diffs[f++]*i,l=E+n.diffs[f++]*i,e.bezierCurveTo(_,v,b,E,o,l);break}case e_.PATH_COMMAND_CLOSE:e.closePath()}return e}function PE(n){return CE(n,new Path2D)}class i0{constructor(e){this.capacity=e,this.cache=new Map}get(e){if(!this.cache.has(e))return;const i=this.cache.get(e);return this.cache.delete(e),this.cache.set(e,i),i}put(e,i){this.cache.has(e)?this.cache.delete(e):this.cache.size===this.capacity&&this.cache.delete(this.cache.keys().next().value),this.cache.set(e,i)}delete(e){this.cache.delete(e)}}It(i0,"LRUCache");class T1{constructor(){this.cacheMap=new Map,this.cacheDependenciesMap=new Map}static _getImage(e){return new Wr(e,e.data)}getFromCache(e,i,o){return this.cacheMap.has(o)||this.cacheMap.set(o,new i0(150)),this.cacheMap.get(o).get(xs(e.toString(),i))}setInCache(e,i,o,l){this.cacheDependenciesMap.has(l)||this.cacheDependenciesMap.set(l,new Map),this.cacheMap.has(l)||this.cacheMap.set(l,new i0(150));const d=this.cacheDependenciesMap.get(l),f=xs(e.id.toString(),o);d.get(f)||d.set(f,new Set);const _=this.cacheMap.get(l),v=e.toString();d.get(f).add(v),_.put(xs(e.toString(),o),i)}removeImagesFromCacheByIds(e,i,o=0){if(!this.cacheMap.has(o)||!this.cacheDependenciesMap.has(o))return;const l=this.cacheMap.get(o),d=this.cacheDependenciesMap.get(o);for(const f of e){const _=xs(f.toString(),i);if(d.has(_)){for(const v of d.get(_))l.delete(v);d.delete(_)}}}rasterize(e,i,o,l){const d=this.getFromCache(e,o,l);if(d)return d.clone();const f=function(v,b){const E=EL.calculate(b.params,v.metadata?v.metadata.variables:[]),I=v.usvg_tree,C=I.width,R=I.height,k=Math.max(1,Math.round(C*b.sx)),F=Math.max(1,Math.round(R*b.sy)),U=new DOMMatrix([k/C,0,0,F/R,0,0]);return i_===null&&(i_=t_(10,10),w1=i_.getContext("2d",{willReadFrequently:!0})),i_.width=k,i_.height=F,b1(w1,U,I,I,E),w1.getImageData(0,0,k,F)}(i.icon,e),_=T1._getImage(f);return this.setInCache(e,_,o,l),_.clone()}}class ME{constructor(e){this.size=e,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(e,i){const o=this.toIdx(e,i);return{min:this.minimums[o],max:this.maximums[o]}}isLeaf(e,i){return this.leaves[this.toIdx(e,i)]}toIdx(e,i){return i*this.size+e}}function RE(n,e,i,o){let l=0,d=Number.MAX_VALUE;for(let f=0;f<3;f++)if(Math.abs(o[f])<1e-15){if(i[f]<n[f]||i[f]>e[f])return null}else{const _=1/o[f];let v=(n[f]-i[f])*_,b=(e[f]-i[f])*_;if(v>b){const E=v;v=b,b=E}if(v>l&&(l=v),b<d&&(d=b),l>d)return null}return l}function kE(n,e,i,o,l,d,f,_,v,b,E){const I=o-n,C=l-e,R=d-i,k=f-n,F=_-e,U=v-i,j=E[1]*U-E[2]*F,H=E[2]*k-E[0]*U,W=E[0]*F-E[1]*k,Y=I*j+C*H+R*W;if(Math.abs(Y)<1e-15)return null;const se=1/Y,ie=b[0]-n,ce=b[1]-e,fe=b[2]-i,ge=(ie*j+ce*H+fe*W)*se;if(ge<0||ge>1)return null;const Fe=ce*R-fe*C,be=fe*I-ie*R,Ue=ie*C-ce*I,He=(E[0]*Fe+E[1]*be+E[2]*Ue)*se;return He<0||ge+He>1?null:(k*Fe+F*be+U*Ue)*se}function LE(n,e,i){return(n-e)/(i-e)}function zE(n,e,i,o,l,d,f,_,v){const b=1<<i,E=d-o,I=f-l,C=(n+1)/b*E+o,R=(e+0)/b*I+l,k=(e+1)/b*I+l;_[0]=(n+0)/b*E+o,_[1]=R,v[0]=C,v[1]=k}class DE{constructor(e){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=e,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const i=function(d){const f=Math.ceil(Math.log2(d.dim/8)),_=[];let v=Math.ceil(Math.pow(2,f));const b=1/v,E=(R,k,F,U,j)=>{const H=U?1:0,W=(R+1)*F-H,Y=k*F,se=(k+1)*F-H;j[0]=R*F,j[1]=Y,j[2]=W,j[3]=se};let I=new ME(v);const C=[];for(let R=0;R<v*v;R++){E(R%v,Math.floor(R/v),b,!1,C);const k=Xc(C[0],C[1],d),F=Xc(C[2],C[1],d),U=Xc(C[2],C[3],d),j=Xc(C[0],C[3],d);I.minimums.push(Math.min(k,F,U,j)),I.maximums.push(Math.max(k,F,U,j)),I.leaves.push(1)}for(_.push(I),v/=2;v>=1;v/=2){const R=_[_.length-1];I=new ME(v);for(let k=0;k<v*v;k++){E(k%v,Math.floor(k/v),2,!0,C);const F=R.getElevation(C[0],C[1]),U=R.getElevation(C[2],C[1]),j=R.getElevation(C[2],C[3]),H=R.getElevation(C[0],C[3]),W=R.isLeaf(C[0],C[1]),Y=R.isLeaf(C[2],C[1]),se=R.isLeaf(C[2],C[3]),ie=R.isLeaf(C[0],C[3]),ce=Math.min(F.min,U.min,j.min,H.min),fe=Math.max(F.max,U.max,j.max,H.max),ge=W&&Y&&se&&ie;I.maximums.push(fe),I.minimums.push(ce),I.leaves.push(fe-ce<=5&&ge?1:0)}_.push(I)}return _}(this.dem),o=i.length-1,l=i[o];this._addNode(l.minimums[0],l.maximums[0],l.leaves[0]),this._construct(i,0,0,o,0)}raycastRoot(e,i,o,l,d,f,_=1){return RE([e,i,-100],[o,l,this.maximums[0]*_],d,f)}raycast(e,i,o,l,d,f,_=1){if(!this.nodeCount)return null;const v=this.raycastRoot(e,i,o,l,d,f,_);if(v==null)return null;const b=[],E=[],I=[],C=[],R=[{idx:0,t:v,nodex:0,nodey:0,depth:0}];for(;R.length>0;){const{idx:k,t:F,nodex:U,nodey:j,depth:H}=R.pop();if(this.leaves[k]){zE(U,j,H,e,i,o,l,I,C);const Y=1<<H,se=(U+0)/Y,ie=(U+1)/Y,ce=(j+0)/Y,fe=(j+1)/Y,ge=Xc(se,ce,this.dem)*_,Fe=Xc(ie,ce,this.dem)*_,be=Xc(ie,fe,this.dem)*_,Ue=Xc(se,fe,this.dem)*_,He=kE(I[0],I[1],ge,C[0],I[1],Fe,C[0],C[1],be,d,f),qe=kE(C[0],C[1],be,I[0],C[1],Ue,I[0],I[1],ge,d,f),tt=Math.min(He!==null?He:Number.MAX_VALUE,qe!==null?qe:Number.MAX_VALUE);if(tt!==Number.MAX_VALUE)return tt;{const nt=Er([],d,f,F);if(OE(ge,Fe,Ue,be,LE(nt[0],I[0],C[0]),LE(nt[1],I[1],C[1]))>=nt[2])return F}continue}let W=0;for(let Y=0;Y<this._siblingOffset.length;Y++){zE((U<<1)+this._siblingOffset[Y][0],(j<<1)+this._siblingOffset[Y][1],H+1,e,i,o,l,I,C),I[2]=-100,C[2]=this.maximums[this.childOffsets[k]+Y]*_;const se=RE(I,C,d,f);if(se!=null){const ie=se;b[Y]=ie;let ce=!1;for(let fe=0;fe<W&&!ce;fe++)ie>=b[E[fe]]&&(E.splice(fe,0,Y),ce=!0);ce||(E[W]=Y),W++}}for(let Y=0;Y<W;Y++){const se=E[Y];R.push({idx:this.childOffsets[k]+se,t:b[se],nodex:(U<<1)+this._siblingOffset[se][0],nodey:(j<<1)+this._siblingOffset[se][1],depth:H+1})}}return null}_addNode(e,i,o){return this.minimums.push(e),this.maximums.push(i),this.leaves.push(o),this.childOffsets.push(0),this.nodeCount++}_construct(e,i,o,l,d){if(e[l].isLeaf(i,o)===1)return;this.childOffsets[d]||(this.childOffsets[d]=this.nodeCount);const f=l-1,_=e[f];let v=0,b=0;for(let E=0;E<this._siblingOffset.length;E++){const I=2*i+this._siblingOffset[E][0],C=2*o+this._siblingOffset[E][1],R=_.getElevation(I,C),k=_.isLeaf(I,C),F=this._addNode(R.min,R.max,k);k&&(v|=1<<E),b||(b=F)}for(let E=0;E<this._siblingOffset.length;E++)v&1<<E||this._construct(e,2*i+this._siblingOffset[E][0],2*o+this._siblingOffset[E][1],f,b+E)}}function OE(n,e,i,o,l,d){return Kt(Kt(n,i,d),Kt(e,o,d),l)}function Xc(n,e,i){const o=i.dim,l=V(n*o-.5,0,o-1),d=V(e*o-.5,0,o-1),f=Math.floor(l),_=Math.floor(d),v=Math.min(f+1,o-1),b=Math.min(_+1,o-1);return OE(i.get(f,_),i.get(v,_),i.get(f,b),i.get(v,b),l-f,d-_)}const IL={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function AL(n,e,i){return(256*n*256+256*e+i)/10-1e4}function CL(n,e,i){return 256*n+e+i/256-32768}class n0{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(e,i,o,l=!1){if(this.uid=e,i.height!==i.width)throw new RangeError("DEM tiles must be square");if(o&&o!=="mapbox"&&o!=="terrarium")return void bt(`"${o}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=i.height;const d=this.dim=i.height-2,f=new Uint32Array(i.data.buffer);if(this.pixels=new Uint8Array(i.data.buffer),this.floatView=new Float32Array(i.data.buffer),this.borderReady=l,this._modifiedForSources={},!l){for(let v=0;v<d;v++)f[this._idx(-1,v)]=f[this._idx(0,v)],f[this._idx(d,v)]=f[this._idx(d-1,v)],f[this._idx(v,-1)]=f[this._idx(v,0)],f[this._idx(v,d)]=f[this._idx(v,d-1)];f[this._idx(-1,-1)]=f[this._idx(0,0)],f[this._idx(d,-1)]=f[this._idx(d-1,0)],f[this._idx(-1,d)]=f[this._idx(0,d-1)],f[this._idx(d,d)]=f[this._idx(d-1,d-1)]}const _=o==="terrarium"?CL:AL;for(let v=0;v<f.length;++v){const b=4*v;this.floatView[v]=_(this.pixels[b],this.pixels[b+1],this.pixels[b+2])}this._timestamp=xr.now()}_buildQuadTree(){this._tree=new DE(this)}get(e,i,o=!1){o&&(e=V(e,-1,this.dim),i=V(i,-1,this.dim));const l=this._idx(e,i);return this.floatView[l]}set(e,i,o){const l=this._idx(e,i),d=this.floatView[l];return this.floatView[l]=o,o-d}static getUnpackVector(e){return IL[e]}_idx(e,i){if(e<-1||e>=this.dim+1||i<-1||i>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(i+1)*this.stride+(e+1)}static pack(e,i){const o=[0,0,0,0],l=n0.getUnpackVector(i);let d=Math.floor((e+l[3])/l[2]);return o[2]=d%256,d=Math.floor(d/256),o[1]=d%256,d=Math.floor(d/256),o[0]=d,o}getPixels(){return new MT({width:this.stride,height:this.stride},this.pixels)}backfillBorder(e,i,o){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let l=i*this.dim,d=i*this.dim+this.dim,f=o*this.dim,_=o*this.dim+this.dim;switch(i){case-1:l=d-1;break;case 1:d=l+1}switch(o){case-1:f=_-1;break;case 1:_=f+1}const v=-i*this.dim,b=-o*this.dim;for(let E=f;E<_;E++)for(let I=l;I<d;I++){const C=4*this._idx(I,E),R=4*this._idx(I+v,E+b);this.pixels[C+0]=e.pixels[R+0],this.pixels[C+1]=e.pixels[R+1],this.pixels[C+2]=e.pixels[R+2],this.pixels[C+3]=e.pixels[R+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}function PL(n,e,i){n===1?e.headerLength=i.readFixed32():n===2?e.x=i.readVarint():n===3?e.y=i.readVarint():n===4?e.z=i.readVarint():n===5&&e.layers.push(function(o,l){return o.readFields(zL,{version:0,name:"",units:"",tileSize:0,buffer:0,pixelFormat:0,dataIndex:[]},l)}(i,i.readVarint()+i.pos))}function ML(n,e,i){n===1?(e.delta_filter=function(o,l){return o.readFields(RL,{blockSize:0},l)}(i,i.readVarint()+i.pos),e.filter="delta_filter"):n===2?(i.readVarint(),e.filter="zigzag_filter"):n===3?(i.readVarint(),e.filter="bitshuffle_filter"):n===4&&(i.readVarint(),e.filter="byteshuffle_filter")}function RL(n,e,i){n===1&&(e.blockSize=i.readVarint())}function kL(n,e,i){n===1?(i.readVarint(),e.codec="gzip_data"):n===2?(i.readVarint(),e.codec="jpeg_image"):n===3?(i.readVarint(),e.codec="webp_image"):n===4&&(i.readVarint(),e.codec="png_image")}function LL(n,e,i){let o=0,l=0;n===1?e.firstByte=i.readFixed64():n===2?e.lastByte=i.readFixed64():n===3?e.filters.push(function(d,f){return d.readFields(ML,{},f)}(i,i.readVarint()+i.pos)):n===4?e.codec=function(d,f){return d.readFields(kL,{},f)}(i,i.readVarint()+i.pos):n===5?l=i.readFloat():n===6?o=i.readFloat():n===7?e.bands.push(i.readString()):n===8?e.offset=i.readDouble():n===9&&(e.scale=i.readDouble()),e.offset===0&&(e.offset=l),e.scale===0&&(e.scale=o)}function zL(n,e,i){n===1?e.version=i.readVarint():n===2?e.name=i.readString():n===3?e.units=i.readString():n===4?e.tileSize=i.readVarint():n===5?e.buffer=i.readVarint():n===6?e.pixelFormat=i.readVarint():n===7&&e.dataIndex.push(function(o,l){return o.readFields(LL,{firstByte:0,lastByte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},l)}(i,i.readVarint()+i.pos))}function DL(n,e,i){if(n===2)(function(o,l,d){o.readFields(OL,d,l)})(i,i.readVarint()+i.pos,e);else if(n===3)throw new Error("Not implemented")}function OL(n,e,i){if(n===1){let o=0;const l=i.readVarint()+i.pos;for(;i.pos<l;)e[o++]=i.readVarint()}}function FL(n,e){if(e.length!==4)throw new Error(`Expected data of dimension 4 but got ${e.length}.`);let i=e[3];for(let o=2;o>=1;o--){const l=o===1?1:0,d=o===2?1:0;for(let f=0;f<e[0];f++){const _=e[1]*f;for(let v=l;v<e[1];v++){const b=e[2]*(v+_);for(let E=d;E<e[2];E++){const I=e[3]*(E+b);for(let C=0;C<e[3];C++){const R=I+C;n[R]+=n[R-i]}}}}i*=e[o]}return n}function BL(n){for(let e=0,i=n.length;e<i;e++)n[e]=n[e]>>>1^-(1&n[e]);return n}function NL(n,e){switch(e){case"uint32":return n;case"uint16":for(let i=0;i<n.length;i+=2){const o=n[i],l=n[i+1];n[i]=(240&o)>>4|(61440&o)>>8|(240&l)<<4|61440&l,n[i+1]=15&o|(3840&o)>>4|(15&l)<<8|(3840&l)<<4}return n;case"uint8":for(let i=0;i<n.length;i+=4){const o=n[i],l=n[i+1],d=n[i+2],f=n[i+3];n[i+0]=(192&o)>>6|(192&l)>>4|(192&d)>>2|192&f,n[i+1]=(48&o)>>4|(48&l)>>2|48&d|(48&f)<<2,n[i+2]=(12&o)>>2|12&l|(12&d)<<2|(12&f)<<4,n[i+3]=3&o|(3&l)<<2|(3&d)<<4|(3&f)<<6}return n;default:throw new Error(`Invalid pixel format, "${e}"`)}}It(n0,"DEMData"),It(DE,"DemMinMaxQuadTree",{omit:["dem"]});var Ss=Uint8Array,n_=Uint16Array,jL=Int32Array,FE=new Ss([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),BE=new Ss([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),UL=new Ss([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),NE=function(n,e){for(var i=new n_(31),o=0;o<31;++o)i[o]=e+=1<<n[o-1];var l=new jL(i[30]);for(o=1;o<30;++o)for(var d=i[o];d<i[o+1];++d)l[d]=d-i[o]<<5|o;return{b:i,r:l}},jE=NE(FE,2),UE=jE.b,VL=jE.r;UE[28]=258,VL[258]=28;for(var $L=NE(BE,0).b,VE=new n_(32768),_r=0;_r<32768;++_r){var bf=(43690&_r)>>1|(21845&_r)<<1;VE[_r]=((65280&(bf=(61680&(bf=(52428&bf)>>2|(13107&bf)<<2))>>4|(3855&bf)<<4))>>8|(255&bf)<<8)>>1}var r_=function(n,e,i){for(var o=n.length,l=0,d=new n_(e);l<o;++l)n[l]&&++d[n[l]-1];var f,_=new n_(e);for(l=1;l<e;++l)_[l]=_[l-1]+d[l-1]<<1;f=new n_(1<<e);var v=15-e;for(l=0;l<o;++l)if(n[l])for(var b=l<<4|n[l],E=e-n[l],I=_[n[l]-1]++<<E,C=I|(1<<E)-1;I<=C;++I)f[VE[I]>>v]=b;return f},o_=new Ss(288);for(_r=0;_r<144;++_r)o_[_r]=8;for(_r=144;_r<256;++_r)o_[_r]=9;for(_r=256;_r<280;++_r)o_[_r]=7;for(_r=280;_r<288;++_r)o_[_r]=8;var $E=new Ss(32);for(_r=0;_r<32;++_r)$E[_r]=5;var GL=r_(o_,9),HL=r_($E,5),S1=function(n){for(var e=n[0],i=1;i<n.length;++i)n[i]>e&&(e=n[i]);return e},Aa=function(n,e,i){var o=e/8|0;return(n[o]|n[o+1]<<8)>>(7&e)&i},E1=function(n,e){var i=e/8|0;return(n[i]|n[i+1]<<8|n[i+2]<<16)>>(7&e)},qL=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Ca=function(n,e,i){var o=new Error(e||qL[n]);if(o.code=n,Error.captureStackTrace&&Error.captureStackTrace(o,Ca),!i)throw o;return o},WL=new Ss(0),ZL=typeof TextDecoder<"u"&&new TextDecoder;try{ZL.decode(WL,{stream:!0})}catch{}const XL={gzip_data:"gzip"};class Zs extends Error{constructor(e){super(e),this.name="MRTError"}}const KL={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},GE={uint32:1,uint16:2,uint8:4},YL={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array};let I1;class r0{constructor(e=5){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=e}getLayer(e){const i=this.layers[e];if(!i)throw new Zs(`Layer '${e}' not found`);return i}getHeaderLength(e){const i=new Uint8Array(e),o=new DataView(e);if(i[0]!==13)throw new Zs("File is not a valid MRT.");return o.getUint32(1,!0)}parseHeader(e){const i=new Uint8Array(e),o=this.getHeaderLength(e);if(i.length<o)throw new Zs(`Expected header with length >= ${o} but got buffer of length ${i.length}`);const l=new I1(i.subarray(0,o)).readFields(PL,{headerLength:0,x:0,y:0,z:0,layers:[]},void 0);if(!isNaN(this.x)&&(this.x!==l.x||this.y!==l.y||this.z!==l.z))throw new Zs(`Invalid attempt to parse header ${l.z}/${l.x}/${l.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=l.x,this.y=l.y,this.z=l.z;for(const d of l.layers)this.layers[d.name]=new HE(d,{cacheSize:this._cacheSize});return this}createDecodingTask(e){const i=[],o=this.getLayer(e.layerName);for(let l of e.blockIndices){const d=o.dataIndex[l],f=d.firstByte-e.firstByte,_=d.lastByte-e.firstByte;if(o._blocksInProgress.has(l))continue;const v={layerName:o.name,firstByte:f,lastByte:_,pixelFormat:o.pixelFormat,blockIndex:l,blockShape:[d.bands.length].concat(o.bandShape),buffer:o.buffer,codec:d.codec.codec,filters:d.filters.map(b=>b.filter)};o._blocksInProgress.add(l),i.push(v)}return new qE(i,()=>{i.forEach(l=>o._blocksInProgress.delete(l.blockIndex))},(l,d)=>{if(i.forEach(f=>o._blocksInProgress.delete(f.blockIndex)),l)throw l;d.forEach(f=>{this.getLayer(f.layerName).processDecodedData(f)})})}}class HE{constructor({version:e,name:i,units:o,tileSize:l,pixelFormat:d,buffer:f,dataIndex:_},v){if(this.version=e,this.version!==1)throw new Zs(`Cannot parse raster layer encoded with MRT version ${e}`);this.name=i,this.units=o,this.tileSize=l,this.buffer=f,this.pixelFormat=KL[d],this.dataIndex=_,this.bandShape=[l+2*f,l+2*f,GE[this.pixelFormat]],this._decodedBlocks=new i0(v?v.cacheSize:5),this._blocksInProgress=new Set}get dimension(){return GE[this.pixelFormat]}get cacheSize(){return this._decodedBlocks.capacity}getBandList(){return this.dataIndex.map(({bands:e})=>e).flat()}processDecodedData(e){const i=e.blockIndex.toString();this._decodedBlocks.get(i)||this._decodedBlocks.put(i,e.data)}getBlockForBand(e){let i=0;switch(typeof e){case"string":for(const[o,l]of this.dataIndex.entries()){for(const[d,f]of l.bands.entries())if(f===e)return{bandIndex:i+d,blockIndex:o,blockBandIndex:d};i+=l.bands.length}break;case"number":for(const[o,l]of this.dataIndex.entries()){if(e>=i&&e<i+l.bands.length)return{bandIndex:e,blockIndex:o,blockBandIndex:e-i};i+=l.bands.length}break;default:throw new Zs(`Invalid band \`${JSON.stringify(e)}\`. Expected string or integer.`)}return{blockIndex:-1,blockBandIndex:-1}}getDataRange(e){let i=1/0,o=-1/0;const l=[],d=new Set;for(const f of e){const{blockIndex:_}=this.getBlockForBand(f);if(_<0)throw new Zs(`Invalid band: ${JSON.stringify(f)}`);const v=this.dataIndex[_];l.includes(_)||l.push(_),d.add(_),i=Math.min(i,v.firstByte),o=Math.max(o,v.lastByte)}if(d.size>this.cacheSize)throw new Zs(`Number of blocks to decode (${d.size}) exceeds cache size (${this.cacheSize}).`);return{layerName:this.name,firstByte:i,lastByte:o,blockIndices:l}}hasBand(e){const{blockIndex:i}=this.getBlockForBand(e);return i>=0}hasDataForBand(e){const{blockIndex:i}=this.getBlockForBand(e);return i>=0&&!!this._decodedBlocks.get(i.toString())}getBandView(e){const{blockIndex:i,blockBandIndex:o}=this.getBlockForBand(e);if(i<0)throw new Zs(`Band not found: ${JSON.stringify(e)}`);const l=this._decodedBlocks.get(i.toString());if(!l)throw new Zs(`Data for band ${JSON.stringify(e)} of layer "${this.name}" not decoded.`);const d=this.dataIndex[i],f=this.bandShape.reduce((b,E)=>b*E,1),_=o*f,v=l.subarray(_,_+f);return{data:v,bytes:new Uint8Array(v.buffer).subarray(v.byteOffset,v.byteOffset+v.byteLength),tileSize:this.tileSize,buffer:this.buffer,pixelFormat:this.pixelFormat,dimension:this.dimension,offset:d.offset,scale:d.scale}}}r0.setPbf=function(n){I1=n};class qE{constructor(e,i,o){this.tasks=e,this._onCancel=i,this._onComplete=o,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(e,i){this._finalized||(this._onComplete(e,i),this._finalized=!0)}}r0.performDecoding=function(n,e){const i=new Uint8Array(n);return Promise.all(e.tasks.map(o=>{const{layerName:l,firstByte:d,lastByte:f,pixelFormat:_,blockShape:v,blockIndex:b,filters:E,codec:I}=o,C=i.subarray(d,f+1),R=new Uint32Array(v[0]*v[1]*v[2]);let k;if(I!=="gzip_data")throw new Zs(`Unhandled codec: ${I}`);return k=function(F,U){if(!globalThis.DecompressionStream&&U==="gzip_data")return Promise.resolve(((Y=function(ce){ce[0]==31&&ce[1]==139&&ce[2]==8||Ca(6,"invalid gzip data");var fe=ce[3],ge=10;4&fe&&(ge+=2+(ce[10]|ce[11]<<8));for(var Fe=(fe>>3&1)+(fe>>4&1);Fe>0;Fe-=!ce[ge++]);return ge+(2&fe)}(W=F))+8>W.length&&Ca(6,"invalid gzip data"),function(ce,fe,ge,Fe){var be=ce.length;if(!be||fe.f&&!fe.l)return ge||new Ss(0);var Ue=!ge,He=Ue||fe.i!=2,qe=fe.i;Ue&&(ge=new Ss(3*be));var tt,nt,Ye=function(tn){var Vi=ge.length;if(tn>Vi){var qi=new Ss(Math.max(2*Vi,tn));qi.set(ge),ge=qi}},Je=fe.f||0,je=fe.p||0,Be=fe.b||0,Qe=fe.l,ft=fe.d,at=fe.m,Ot=fe.n,xt=8*be;do{if(!Qe){Je=Aa(ce,je,1);var St=Aa(ce,je+1,3);if(je+=3,!St){var Pt=ce[(Ve=4+((je+7)/8|0))-4]|ce[Ve-3]<<8,pi=Ve+Pt;if(pi>be){qe&&Ca(0);break}He&&Ye(Be+Pt),ge.set(ce.subarray(Ve,pi),Be),fe.b=Be+=Pt,fe.p=je=8*pi,fe.f=Je;continue}if(St==1)Qe=GL,ft=HL,at=9,Ot=5;else if(St==2){var lt=Aa(ce,je,31)+257,Mt=Aa(ce,je+10,15)+4,ei=lt+Aa(ce,je+5,31)+1;je+=14;for(var bi=new Ss(ei),Si=new Ss(19),oi=0;oi<Mt;++oi)Si[UL[oi]]=Aa(ce,je+3*oi,7);je+=3*Mt;var en=S1(Si),ne=(1<<en)-1,ae=r_(Si,en);for(oi=0;oi<ei;){var Ve,it=ae[Aa(ce,je,ne)];if(je+=15&it,(Ve=it>>4)<16)bi[oi++]=Ve;else{var gt=0,yt=0;for(Ve==16?(yt=3+Aa(ce,je,3),je+=2,gt=bi[oi-1]):Ve==17?(yt=3+Aa(ce,je,7),je+=3):Ve==18&&(yt=11+Aa(ce,je,127),je+=7);yt--;)bi[oi++]=gt}}var Ft=bi.subarray(0,lt),Nt=bi.subarray(lt);at=S1(Ft),Ot=S1(Nt),Qe=r_(Ft,at),ft=r_(Nt,Ot)}else Ca(1);if(je>xt){qe&&Ca(0);break}}He&&Ye(Be+131072);for(var ni=(1<<at)-1,hi=(1<<Ot)-1,fi=je;;fi=je){var gi=(gt=Qe[E1(ce,je)&ni])>>4;if((je+=15&gt)>xt){qe&&Ca(0);break}if(gt||Ca(2),gi<256)ge[Be++]=gi;else{if(gi==256){fi=je,Qe=null;break}var Wt=gi-254;gi>264&&(Wt=Aa(ce,je,(1<<(Bi=FE[oi=gi-257]))-1)+UE[oi],je+=Bi);var Qt=ft[E1(ce,je)&hi],Pi=Qt>>4;if(Qt||Ca(3),je+=15&Qt,Nt=$L[Pi],Pi>3){var Bi=BE[Pi];Nt+=E1(ce,je)&(1<<Bi)-1,je+=Bi}if(je>xt){qe&&Ca(0);break}He&&Ye(Be+131072);var Ni=Be+Wt;if(Be<Nt){var Ki=0-Nt,sn=Math.min(Nt,Ni);for(Ki+Be<0&&Ca(3);Be<sn;++Be)ge[Be]=(void 0)[Ki+Be]}for(;Be<Ni;++Be)ge[Be]=ge[Be-Nt]}}fe.l=Qe,fe.p=fi,fe.b=Be,fe.f=Je,Qe&&(Je=1,fe.m=at,fe.d=ft,fe.n=Ot)}while(!Je);return Be!=ge.length&&Ue?(tt=ge,((nt=Be)==null||nt>tt.length)&&(nt=tt.length),new Ss(tt.subarray(0,nt))):ge.subarray(0,Be)}(W.subarray(Y,-8),{i:2},new Ss(((j=W)[(H=j.length)-4]|j[H-3]<<8|j[H-2]<<16|j[H-1]<<24)>>>0))));var j,H,W,Y;const se=XL[U];if(!se)throw new Error(`Unhandled codec: ${U}`);const ie=new globalThis.DecompressionStream(se);return new Response(new Blob([F]).stream().pipeThrough(ie)).arrayBuffer().then(ce=>new Uint8Array(ce))}(C,I).then(F=>(function(U,j){U.readFields(DL,j)}(new I1(F),R),new YL[_](R.buffer))),k.then(F=>{for(let U=E.length-1;U>=0;U--)switch(E[U]){case"delta_filter":FL(F,v);break;case"zigzag_filter":BL(F);break;case"bitshuffle_filter":NL(F,_);break;default:throw new Zs(`Unhandled filter "${E[U]}"`)}return{layerName:l,blockIndex:b,data:F}}).catch(F=>{throw F})}))},It(qE,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]}),It(r0,"MapboxRasterTile"),It(HE,"MapboxRasterLayer",{omit:["_blocksInProgress"]});class WE{constructor(e){this._stringToNumber={},this._numberToString=[];for(let i=0;i<e.length;i++){const o=e[i];this._stringToNumber[o]=i,this._numberToString[i]=o}}encode(e){return this._stringToNumber[e]}decode(e){return this._numberToString[e]}}class ZE{constructor(e,i){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new Lc(dt,16,0),this.featureIndexArray=new pm,this.promoteId=i,this.is3DTile=!1,this.serializedLayersCache=new Map}insert(e,i,o,l,d,f=0,_=0){const v=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(o,l,d,f);const b=this.grid;for(let E=0;E<i.length;E++){const I=i[E],C=[1/0,1/0,-1/0,-1/0];for(let R=0;R<I.length;R++){const k=I[R];C[0]=Math.min(C[0],k.x),C[1]=Math.min(C[1],k.y),C[2]=Math.max(C[2],k.x),C[3]=Math.max(C[3],k.y)}_!==0&&(C[0]-=_,C[1]-=_,C[2]+=_,C[3]+=_),C[0]<dt&&C[1]<dt&&C[2]>=0&&C[3]>=0&&b.insert(v,C[0],C[1],C[2],C[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new Ae(new zy(this.rawTileData)).layers,this.sourceLayerCoder=new WE(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const e in this.vtLayers)this.vtFeatures[e]=[]}return this.vtLayers}query(e,i){const{tilespaceGeometry:o,transform:l,tileTransform:d,pixelPosMatrix:f,availableImages:_,worldview:v}=i;this.loadVTLayers(),this.serializedLayersCache.clear();const b=i.queryRadius?i.queryRadius:0,E=o.bufferedTilespaceBounds,I=this.grid.query(E.min.x,E.min.y,E.max.x,E.max.y,(F,U,j,H)=>co(o.bufferedTilespaceGeometry,F-b,U-b,j+b,H+b));I.sort(JL);let C=null;l.elevation&&I.length>0&&(C=vf.create(l.elevation,this.tileID));const R={};let k;for(let F=0;F<I.length;F++){const U=I[F];if(U===k)continue;k=U;const j=this.featureIndexArray.get(U);let H=null;this.is3DTile?this.loadMatchingModelFeature(R,j,e,o,l,v):this.loadMatchingFeature(R,j,e,_,v,(W,Y,se,ie=0)=>(H||(H=he(W,this.tileID.canonical,d)),Y.queryIntersectsFeature(o,W,se,H,this.z,l,f,C,ie)))}return R}loadMatchingFeature(e,i,o,l,d,f){const{featureIndex:_,bucketIndex:v,sourceLayerIndex:b,layoutVertexArrayOffset:E}=i,I=this.bucketLayerIDs[v],C=o.layers,R=Object.keys(C);if(R.length&&!Et(R,I))return;const k=o.sourceCache,F=this.sourceLayerCoder.decode(b),U=this.vtLayers[F].feature(_),j=this.getId(U,F);for(let H=0;H<I.length;H++){const W=I[H];if(!C[W])continue;const{styleLayer:Y,targets:se}=C[W];let ie={};j!==void 0&&(ie=k.getFeatureState(Y.sourceLayer,j));const ce=!f||f(U,Y,ie,E);if(!ce)continue;const fe=new _h(U,this.z,this.x,this.y,j);fe.tile=this.tileID.canonical,fe.state=ie;let ge=this.serializedLayersCache.get(W);ge||(ge=Y.serialize(),ge.id=W,this.serializedLayersCache.set(W,ge)),fe.source=ge.source,fe.sourceLayer=ge["source-layer"],fe.layer=Object.assign({},ge),fe.layer.paint=XE(ge.paint,Y.paint,U,ie,l),fe.layer.layout=XE(ge.layout,Y.layout,U,ie,l);let Fe=!1;for(const be of se){this.updateFeatureProperties(fe,be);const{filter:Ue}=be;if(Ue){if(U.properties=fe.properties,Ue.needGeometry){const He=we(U,!0);if(!Ue.filter(new fn(this.tileID.overscaledZ,{worldview:d}),He,this.tileID.canonical))continue}else if(!Ue.filter(new fn(this.tileID.overscaledZ,{worldview:d}),U))continue}Fe=!0,be.targetId&&this.addFeatureVariant(fe,be)}Fe&&this.appendToResult(e,W,_,fe,ce)}}loadMatchingModelFeature(e,i,o,l,d,f){const{featureIndex:_,bucketIndex:v}=i,b=this.bucketLayerIDs[v],E=o.layers,I=Object.keys(E);if(!I.length||Et(I,b))for(let C=0;C<b.length;C++){const R=b[C],{styleLayer:k,targets:F}=E[R];if(k.type!=="model")continue;const U=l.tile,j=U.getBucket(k);if(!(j&&j instanceof Yy))continue;const H=oL(j,_,l,d);if(!H)continue;const{z:W,x:Y,y:se}=U.tileID.canonical,{feature:ie,intersectionZ:ce,position:fe}=H;let ge={};ie.id!==void 0&&(ge=o.sourceCache.getFeatureState(k.sourceLayer,ie.id));const Fe=new _h({},W,Y,se,ie.id);Fe.tile=this.tileID.canonical,Fe.state=ge,Fe.properties=ie.properties,Fe.geometry={type:"Point",coordinates:[fe.lng,fe.lat]};let be=this.serializedLayersCache.get(R);be||(be=k.serialize(),be.id=R,this.serializedLayersCache.set(R,be)),Fe.source=be.source,Fe.sourceLayer=be["source-layer"],Fe.layer=Object.assign({},be);let Ue=!1;for(const He of F){this.updateFeatureProperties(Fe,He);const{filter:qe}=He;if(qe){if(ie.properties=Fe.properties,qe.needGeometry){if(!qe.filter(new fn(this.tileID.overscaledZ,{worldview:f}),ie,this.tileID.canonical))continue}else if(!qe.filter(new fn(this.tileID.overscaledZ,{worldview:f}),ie))continue}Ue=!0,He.targetId&&this.addFeatureVariant(Fe,He)}Ue&&this.appendToResult(e,R,_,Fe,ce)}}updateFeatureProperties(e,i,o){if(i.properties){const l={};for(const d in i.properties){const f=i.properties[d].evaluate({zoom:this.z},e._vectorTileFeature,e.state,e.tile,o);f!=null&&(l[d]=f)}e.properties=l}}addFeatureVariant(e,i,o){const l={target:i.target,namespace:i.namespace,uniqueFeatureID:i.uniqueFeatureID};i.properties&&(l.properties=e.properties),e.variants=e.variants||{},e.variants[i.targetId]=e.variants[i.targetId]||[],e.variants[i.targetId].push(l)}appendToResult(e,i,o,l,d){let f=e[i];f===void 0&&(f=e[i]=[]),f.push({featureIndex:o,feature:l,intersectionZ:d})}lookupSymbolFeatures(e,i,o,l,d,f){const _={};this.loadVTLayers();for(const v of e)this.loadMatchingFeature(_,{bucketIndex:i,sourceLayerIndex:o,featureIndex:v,layoutVertexArrayOffset:0},l,d,f);return _}loadFeature(e){const{featureIndex:i,sourceLayerIndex:o}=e;this.loadVTLayers();const l=this.sourceLayerCoder.decode(o),d=this.vtFeatures[l];if(d[i])return d[i];const f=this.vtLayers[l].feature(i);return d[i]=f,f}hasLayer(e){for(const i of this.bucketLayerIDs)for(const o of i)if(e===o)return!0;return!1}getId(e,i){let o=e.id;if(this.promoteId){const l=Array.isArray(this.promoteId)||typeof this.promoteId!="object"?this.promoteId:this.promoteId[i];if(l!=null)if(Array.isArray(l)){if(!this.promoteIdExpression){const d=ol(l);if(d.result!=="success"){const f=d.value.map(_=>`${_.key}: ${_.message}`).join(", ");return void bt(`Failed to create expression for promoteId: ${f}`)}this.promoteIdExpression=d.value}o=this.promoteIdExpression.evaluate({zoom:0},e)}else o=e.properties[l];typeof o=="boolean"&&(o=Number(o))}return o}}function XE(n,e,i,o,l){return ke(n,(d,f)=>{const _=e instanceof Hl?e.get(f):null;return _&&_.evaluate?_.evaluate(i,o,void 0,l):_})}function JL(n,e){return e-n}It(ZE,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});const KE=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class A1{static from(e){if(!(e instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[i,o]=new Uint8Array(e,0,2);if(i!==219)throw new Error("Data does not appear to be in a KDBush format.");const l=o>>4;if(l!==1)throw new Error(`Got v${l} data when expected v1.`);const d=KE[15&o];if(!d)throw new Error("Unrecognized array type.");const[f]=new Uint16Array(e,2,1),[_]=new Uint32Array(e,4,1);return new A1(_,f,d,e)}constructor(e,i=64,o=Float64Array,l){if(isNaN(e)||e<0)throw new Error(`Unpexpected numItems value: ${e}.`);this.numItems=+e,this.nodeSize=Math.min(Math.max(+i,2),65535),this.ArrayType=o,this.IndexArrayType=e<65536?Uint16Array:Uint32Array;const d=KE.indexOf(this.ArrayType),f=2*e*this.ArrayType.BYTES_PER_ELEMENT,_=e*this.IndexArrayType.BYTES_PER_ELEMENT,v=(8-_%8)%8;if(d<0)throw new Error(`Unexpected typed array class: ${o}.`);l&&l instanceof ArrayBuffer?(this.data=l,this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+_+v,2*e),this._pos=2*e,this._finished=!0):(this.data=new ArrayBuffer(8+f+_+v),this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+_+v,2*e),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+d]),new Uint16Array(this.data,2,1)[0]=i,new Uint32Array(this.data,4,1)[0]=e)}add(e,i){const o=this._pos>>1;return this.ids[o]=o,this.coords[this._pos++]=e,this.coords[this._pos++]=i,o}finish(){const e=this._pos>>1;if(e!==this.numItems)throw new Error(`Added ${e} items when expected ${this.numItems}.`);return C1(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,i,o,l){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:d,coords:f,nodeSize:_}=this,v=[0,d.length-1,0],b=[];for(;v.length;){const E=v.pop()||0,I=v.pop()||0,C=v.pop()||0;if(I-C<=_){for(let U=C;U<=I;U++){const j=f[2*U],H=f[2*U+1];j>=e&&j<=o&&H>=i&&H<=l&&b.push(d[U])}continue}const R=C+I>>1,k=f[2*R],F=f[2*R+1];k>=e&&k<=o&&F>=i&&F<=l&&b.push(d[R]),(E===0?e<=k:i<=F)&&(v.push(C),v.push(R-1),v.push(1-E)),(E===0?o>=k:l>=F)&&(v.push(R+1),v.push(I),v.push(1-E))}return b}within(e,i,o){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:l,coords:d,nodeSize:f}=this,_=[0,l.length-1,0],v=[],b=o*o;for(;_.length;){const E=_.pop()||0,I=_.pop()||0,C=_.pop()||0;if(I-C<=f){for(let U=C;U<=I;U++)JE(d[2*U],d[2*U+1],e,i)<=b&&v.push(l[U]);continue}const R=C+I>>1,k=d[2*R],F=d[2*R+1];JE(k,F,e,i)<=b&&v.push(l[R]),(E===0?e-o<=k:i-o<=F)&&(_.push(C),_.push(R-1),_.push(1-E)),(E===0?e+o>=k:i+o>=F)&&(_.push(R+1),_.push(I),_.push(1-E))}return v}}function C1(n,e,i,o,l,d){if(l-o<=i)return;const f=o+l>>1;YE(n,e,f,o,l,d),C1(n,e,i,o,f-1,1-d),C1(n,e,i,f+1,l,1-d)}function YE(n,e,i,o,l,d){for(;l>o;){if(l-o>600){const b=l-o+1,E=i-o+1,I=Math.log(b),C=.5*Math.exp(2*I/3),R=.5*Math.sqrt(I*C*(b-C)/b)*(E-b/2<0?-1:1);YE(n,e,i,Math.max(o,Math.floor(i-E*C/b+R)),Math.min(l,Math.floor(i+(b-E)*C/b+R)),d)}const f=e[2*i+d];let _=o,v=l;for(s_(n,e,o,i),e[2*l+d]>f&&s_(n,e,o,l);_<v;){for(s_(n,e,_,v),_++,v--;e[2*_+d]<f;)_++;for(;e[2*v+d]>f;)v--}e[2*o+d]===f?s_(n,e,o,v):(v++,s_(n,e,v,l)),v<=i&&(o=v+1),i<=v&&(l=v-1)}}function s_(n,e,i,o){P1(n,i,o),P1(e,2*i,2*o),P1(e,2*i+1,2*o+1)}function P1(n,e,i){const o=n[e];n[e]=n[i],n[i]=o}function JE(n,e,i,o){const l=n-i,d=e-o;return l*l+d*d}s.$=Jh,s.A=la,s.B=xs,s.C=2,s.D=sf,s.E=Ol,s.F=Um,s.G=S2,s.H=Yh,s.I=Jr,s.J=Kg,s.K=Dt,s.L=xc,s.M=bd,s.N=qu,s.O=Fg,s.P=et,s.Q=Wu,s.R=Eu,s.S=kd,s.T=Fx,s.U=ol,s.V=Ky,s.W=Zp,s.X=Ec,s.Y=Sc,s.Z=ju,s._=so,s.a=function(n){return xi.API_CDN_URL_REGEX.test(n)},s.a$=z,s.a0=Jt,s.a1=Xo,s.a2=$s,s.a3=class extends Ky{},s.a4=Td,s.a5=Og,s.a6=Se,s.a7=function(n){const e=n.value;return e?Jt(e)?p1(e,!0)?[]:[new Ky(n.key,e,`invalid url "${e}"`)]:[new Ky(n.key,e,`string expected, "${Dt(e)}" found`)]:[]},s.a8=qg,s.a9=Bn,s.aA=V,s.aB=xe,s.aC=Ur,s.aD=Gr,s.aE=rn,s.aF=w,s.aG=K,s.aH=function(n,e){const i={};for(let o=0;o<e.length;o++){const l=e[o];l in n&&(i[l]=n[l])}return i},s.aI=h,s.aJ=T,s.aK=class{constructor(n){this.entries={},this.scheduler=n}request(n,e,i,o){const l=this.entries[n]=this.entries[n]||{callbacks:[]};if(l.result){const[d,f]=l.result;return this.scheduler?this.scheduler.add(()=>{o(d,f)},e):o(d,f),()=>{}}return l.callbacks.push(o),l.cancel||(l.cancel=i((d,f)=>{l.result=[d,f];for(const _ of l.callbacks)this.scheduler?this.scheduler.add(()=>{_(d,f)},e):_(d,f);setTimeout(()=>delete this.entries[n],3e3)})),()=>{l.result||(l.callbacks=l.callbacks.filter(d=>d!==o),l.callbacks.length||(l.cancel(),delete this.entries[n]))}}},s.aL=function(n,e,i){const o=JSON.stringify(n.request);return n.data&&(this.deduped.entries[o]={result:[null,n.data]}),this.deduped.request(o,{type:"parseTile",isSymbolTile:n.isSymbolTile,zoom:n.tileZoom},l=>{const d=aa(n.request,(f,_,v)=>{f?l(f):_&&l(null,{rawData:_,vectorTile:i?void 0:new Ae(new zy(_)),responseHeaders:new Map(v.entries())})});return()=>{d.cancel(),l()}},e)},s.aM=function(n){return n?{cacheControl:n.get("Cache-Control"),expires:n.get("Expires")}:{cacheControl:void 0,expires:void 0}},s.aN=Io,s.aO=function(n){Zo++,Zo>Uh&&(n.getActor().send("enforceCacheSizeLimit",jh),Zo=0)},s.aP=function(n){return n<=1?1:Math.pow(2,Math.floor(Math.log2(n)))},s.aQ=Dn,s.aR=Q2,s.aS=oE,s.aT=r,s.aU=J2,s.aV=function(n,e){const i=document.createElement("video");i.muted=!0,i.onloadstart=function(){e(null,i)};for(let o=0;o<n.length;o++){const l=document.createElement("source");Rv(n[o])||(i.crossOrigin="Anonymous"),l.src=n[o],i.appendChild(l)}return{cancel:()=>{}}},s.aW=Om,s.aX=gh,s.aY=Te,s.aZ=Hm,s.a_=M,s.aa=ut,s.ab=class{constructor(n){this.specification=n}possiblyEvaluate(n,e){return ri(n.expression.evaluate(e))}interpolate(n,e,i){return{x:Kt(n.x,e.x,i),y:Kt(n.y,e.y,i),z:Kt(n.z,e.z,i),azimuthal:Kt(n.azimuthal,e.azimuthal,i),polar:Kt(n.polar,e.polar,i)}}},s.ac=fn,s.ad=Vl,s.ae=X,s.af=Kn,s.ag=pr,s.ah=q,s.ai=Hl,s.aj=Gc,s.ak=Kt,s.al=dt,s.am=gp,s.an=Oi,s.ao=Zi,s.ap=class{constructor(n){this.specification=n}possiblyEvaluate(n,e){return function([i,o]){const l=ri([1,i,o]);return{x:l.x,y:l.y,z:l.z}}(n.expression.evaluate(e))}interpolate(n,e,i){return{x:Kt(n.x,e.x,i),y:Kt(n.y,e.y,i),z:Kt(n.z,e.z,i)}}},s.aq=function(n,e,i=0,o=!0){const l=new et(i,i),d=n.sub(l),f=e.add(l),_=[d,new et(f.x,d.y),f,new et(d.x,f.y)];return o&&_.push(d.clone()),_},s.ar=function(n,e){const i=[];for(let o=0;o<n.length;o++){const l=ee(o-1,-1,n.length-1),d=ee(o+1,-1,n.length-1),f=n[o],_=n[d],v=n[l].sub(f).unit(),b=_.sub(f).unit(),E=b.angleWithSep(v.x,v.y),I=v.add(b).unit().mult(-1*e/Math.sin(E/2));i.push(f.add(I))}return i},s.as=F2,s.at=co,s.au=function(n,e,i=0){return In(((e.x-i)*n.scale-n.x)*dt,(e.y*n.scale-n.y)*dt,L(e.z,e.y))},s.av=Qn,s.aw=yn,s.ax=At,s.ay=JS,s.az=function(n){let e=1/0,i=1/0,o=-1/0,l=-1/0;for(const d of n)e=Math.min(e,d.x),i=Math.min(i,d.y),o=Math.max(o,d.x),l=Math.max(l,d.y);return{min:new et(e,i),max:new et(o,l)}},s.b=function(n){return xi.API_FONTS_REGEX.test(n)},s.b$=JT,s.b0=sr,s.b1=Oc,s.b2=ve,s.b3=oy,s.b4=qy,s.b5=function(){ma.isLoading()||ma.isLoaded()||Yu()!=="deferred"||Hg()},s.b6=Ld,s.b7=we,s.b8=_h,s.b9=Fn,s.bA=ct,s.bB=zt,s.bC=mt,s.bD=function(n,e){const{x:i,y:o}=n.point,l=gT(i,o,n.worldSize/n._pixelsPerMercatorPixel,0,0);return xe(l,l,dx(Ts(e)))},s.bE=me,s.bF=Eo,s.bG=ja,s.bH=Er,s.bI=jr,s.bJ=qn,s.bK=pf,s.bL=Uo,s.bM=t1,s.bN=function(n,e,i,o,l){const d=5*e+2;n.float32[d+0]=i,n.float32[d+1]=o,n.float32[d+2]=l},s.bO=yf,s.bP=po,s.bQ=oa,s.bR=qa,s.bS=Fh,s.bT=ee,s.bU=function(n,e,i,o){var l=new Q(4);return l[0]=n,l[1]=e,l[2]=i,l[3]=o,l},s.bV=class{isDataAvailableAtPoint(n){const e=this._source();if(this.isUsingMockSource()||!e||n.y<0||n.y>1)return!1;const i=e.getSource().maxzoom,o=1<<i,l=Math.floor(n.x),d=Math.floor((n.x-l)*o),f=Math.floor(n.y*o),_=this.findDEMTileFor(new Dn(i,l,i,d,f));return!(!_||!_.dem)}getAtPointOrZero(n,e=0){return this.getAtPoint(n,e)||0}getAtPoint(n,e,i=!0){if(this.isUsingMockSource())return null;e==null&&(e=null);const o=this._source();if(!o||n.y<0||n.y>1)return e;const l=o.getSource().maxzoom,d=1<<l,f=Math.floor(n.x),_=n.x-f,v=new Dn(l,f,l,Math.floor(_*d),Math.floor(n.y*d)),b=this.findDEMTileFor(v);if(!b||!b.dem)return e;const E=b.dem,I=1<<b.tileID.canonical.z,C=(_*I-b.tileID.canonical.x)*E.dim,R=(n.y*I-b.tileID.canonical.y)*E.dim,k=Math.floor(C),F=Math.floor(R);return(i?this.exaggeration():1)*Kt(Kt(E.get(k,F),E.get(k,F+1),R-F),Kt(E.get(k+1,F),E.get(k+1,F+1),R-F),C-k)}static getAtTileOffset(n,e,i,o){const l=1<<n.canonical.z;return o?o.pointElevation(e):i?i.getAtPointOrZero(new X(n.wrap+(n.canonical.x+e.x/dt)/l,(n.canonical.y+e.y/dt)/l)):0}static getAtTileOffsetFunc(n,e,i,o){return(l,d,f)=>{const _=this.getAtTileOffset(n,l,d,f),v=o.upVector(n.canonical,l.x,l.y);return gn(v,v,_*o.upVectorScale(n.canonical,e,i).metersToTile),v}}getForTilePoints(n,e,i,o){if(this.isUsingMockSource())return!1;const l=vf.create(this,n,o);return!!l&&(e.forEach(d=>{d[2]=this.exaggeration()*l.getElevationAt(d[0],d[1],i)}),!0)}getMinMaxForTile(n){if(this.isUsingMockSource())return null;const e=this.findDEMTileFor(n);if(!e||!e.dem)return null;const i=e.dem.tree,o=e.tileID,l=1<<n.canonical.z-o.canonical.z;let d=n.canonical.x/l-o.canonical.x,f=n.canonical.y/l-o.canonical.y,_=0;for(let v=0;v<n.canonical.z-o.canonical.z&&!i.leaves[_];v++){d*=2,f*=2;const b=2*Math.floor(f)+Math.floor(d);_=i.childOffsets[_]+b,d%=1,f%=1}return{min:this.exaggeration()*i.minimums[_],max:this.exaggeration()*i.maximums[_]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(n,e,i){throw new Error("Pure virtual method called.")}pointCoordinate(n){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(n){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){const n=this.visibleDemTiles;if(n.length===0)return null;let e=!1,i=Number.MAX_VALUE,o=Number.MIN_VALUE;for(const l of n){const d=this.getMinMaxForTile(l.tileID);d&&(i=Math.min(i,d.min),o=Math.max(o,d.max),e=!0)}return e?{min:i,max:o}:null}},s.bW=Ty,s.bX=Di,s.bY=br,s.bZ=ZT,s.b_=sE,s.ba=qx,s.bb=bx,s.bc=he,s.bd=al,s.be=cl,s.bf=Vc,s.bg=An,s.bh=rf,s.bi=d1,s.bj=function(n,e){const i=Gc(e.zoom);if(i===0)return Ts(n);const o=dy(n),l=hx(o),d=w(o.getWest())*e.worldSize,f=w(o.getEast())*e.worldSize,_=T(o.getNorth())*e.worldSize,v=T(o.getSouth())*e.worldSize,b=[d,_,0],E=[f,_,0],I=[d,v,0],C=[f,v,0],R=Me([],e.globeMatrix);return Kn(b,b,R),Kn(E,E,R),Kn(I,I,R),Kn(C,C,R),l[0]=Ta(l[0],I,i),l[1]=Ta(l[1],C,i),l[2]=Ta(l[2],E,i),l[3]=Ta(l[3],b,i),Lt.fromPoints(l)},s.bk=py,s.bl=Me,s.bm=xm,s.bn=Ta,s.bo=Dc,s.bp=lh,s.bq=Zt,s.br=Pe,s.bs=r0,s.bt=zy,s.bu=aa,s.bv=function(n,e){const i=[];for(const o in n)o in e||i.push(o);return i},s.bw=pe,s.bx=["type","source","source-layer","minzoom","maxzoom","filter","layout"],s.by=sa,s.bz=We,s.c=Or,s.c$=function(n,e,i){let o=0;for(let l=0;l<2;++l)n[l]>0&&(o+=(n[l]-0)*(n[l]-0)),e[l]<0&&(o+=(0-e[l])*(0-e[l]));return o},s.c0=QT,s.c1=Jx,s.c2=R2,s.c3=s1,s.c4=A1,s.c5=gn,s.c6=pc,s.c7=mc,s.c8=function(n,e,i){i*=.5;var o=e[0],l=e[1],d=e[2],f=e[3],_=Math.sin(i),v=Math.cos(i);return n[0]=o*v+l*_,n[1]=l*v-o*_,n[2]=d*v+f*_,n[3]=f*v-d*_,n},s.c9=hs,s.cA=Ri,s.cB=Ui,s.cC=FS,s.cD=on,s.cE=pT,s.cF=function(n,e,i,o,l,d,f,_,v){if(v.name==="globe")return pT(n,e,new on(i,o,l),!1);const b=Hm({z:i,x:o,y:l},v);return new Lt([(d+b.x/b.scale)*e,e*(b.y/b.scale),f],[(d+b.x2/b.scale)*e,e*(b.y2/b.scale),_])},s.cG=function(n,e,i){return n[0]=Math.min(e[0],i[0]),n[1]=Math.min(e[1],i[1]),n[2]=Math.min(e[2],i[2]),n[3]=Math.min(e[3],i[3]),n},s.cH=function(n,e,i){return n[0]=Math.max(e[0],i[0]),n[1]=Math.max(e[1],i[1]),n[2]=Math.max(e[2],i[2]),n[3]=Math.max(e[3],i[3]),n},s.cI=function(n){const e=Math.round((n+45+360)%360/90)%4;return fp[e]},s.cJ=D,s.cK=Ga,s.cL=nf,s.cM=function(n){const e=ct(new Float64Array(16));xe(e,n.pixelMatrix,n.globeMatrix);const i=[0,ts,0],o=[0,is,0];return Kn(i,i,e),Kn(o,o,e),[i[0]>0&&i[0]<=n.width&&i[1]>0&&i[1]<=n.height&&!px(n,new r(n.center.lat,90)),o[0]>0&&o[0]<=n.width&&o[1]>0&&o[1]<=n.height&&!px(n,new r(n.center.lat,-90))]},s.cN=function(n,e){const{scale:i}=n.tileTransform,o=i*dt/(n.tileSize*Math.pow(2,e.zoom-n.tileID.overscaledZ+n.tileID.canonical.z));return function(l,d,f){var _=d[1],v=d[2],b=d[3],E=f[0],I=f[1];return l[0]=d[0]*E,l[1]=_*E,l[2]=v*I,l[3]=b*I,l}(new Float32Array(4),e.inverseAdjustmentMatrix,[o,o])},s.cO=Cy,s.cP=or,s.cQ=OS,s.cR=function(n){const e=OS(n,!0);return me([],[e[0],e[1],e[4],e[5]])},s.cS=Ze,s.cT=vt,s.cU=Ct,s.cV=function(n){const{x:e,y:i}=n.point,{lng:o,lat:l}=n._center;return gT(e,i,n.worldSize,o,l)},s.cW=ji,s.cX=Kr,s.cY=Pn,s.cZ=Fr,s.c_=es,s.ca=Vn,s.cb=function(n,e){return n[0]=-e[0],n[1]=-e[1],n[2]=-e[2],n[3]=e[3],n},s.cc=Mi,s.cd=function(n,e,i,o,l){var d=1/Math.tan(e/2);if(n[0]=d/i,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=d,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=-1,n[12]=0,n[13]=0,n[15]=0,l!=null&&l!==1/0){var f=1/(o-l);n[10]=(l+o)*f,n[14]=2*l*o*f}else n[10]=-1,n[14]=-2*o;return n},s.ce=function(n,e,i,o,l,d,f){var _=1/(e-i),v=1/(o-l),b=1/(d-f);return n[0]=-2*_,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=-2*v,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=2*b,n[11]=0,n[12]=(e+i)*_,n[13]=(l+o)*v,n[14]=(f+d)*b,n[15]=1,n},s.cf=A,s.cg=function(n,e,i){n[4*e+0]=i[0],n[4*e+1]=i[1],n[4*e+2]=i[2],n[4*e+3]=i[3]},s.ch=Jd,s.ci=ih,s.cj=ar,s.ck=qs,s.cl=rh,s.cm=V2,s.cn=function(){var n=new Q(4);return Q!=Float32Array&&(n[1]=0,n[2]=0),n[0]=1,n[3]=1,n},s.co=function(n,e,i){var o=e[0],l=e[1],d=e[2],f=e[3],_=Math.sin(i),v=Math.cos(i);return n[0]=o*v+d*_,n[1]=l*v+f*_,n[2]=o*-_+d*v,n[3]=l*-_+f*v,n},s.cp=function(n,e){return n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]&&n[3]===e[3]},s.cq=Xr,s.cr=function(n){var e=n[0],i=n[1],o=n[2],l=n[3];return Math.sqrt(e*e+i*i+o*o+l*l)},s.cs=Il,s.ct=$a,s.cu=Yn,s.cv=3,s.cw=2,s.cx=7,s.cy=6,s.cz=bl,s.d=function(n){return xi.API_TILEJSON_REGEX.test(n)},s.d$=class{constructor(n,e,i,o){this.context=n,this.format=o,this.size=i,this.texture=n.gl.createTexture();const[l,d,f]=this.size,{gl:_}=n;_.bindTexture(_.TEXTURE_3D,this.texture),n.pixelStoreUnpackFlipY.set(!1),n.pixelStoreUnpack.set(1),n.pixelStoreUnpackPremultiplyAlpha.set(!1),"data"in e&&e.data&&_.texImage3D(_.TEXTURE_3D,0,this.format,l,d,f,0,Dx(this.format),Ox(this.format),e.data)}bind(n,e){const{context:i}=this,{gl:o}=i;o.bindTexture(o.TEXTURE_3D,this.texture),n!==this.minFilter&&(o.texParameteri(o.TEXTURE_3D,o.TEXTURE_MAG_FILTER,n),o.texParameteri(o.TEXTURE_3D,o.TEXTURE_MIN_FILTER,n),this.minFilter=n),e!==this.wrapS&&(o.texParameteri(o.TEXTURE_3D,o.TEXTURE_WRAP_S,e),o.texParameteri(o.TEXTURE_3D,o.TEXTURE_WRAP_T,e),this.wrapS=e)}destroy(){const{gl:n}=this.context;n.deleteTexture(this.texture),this.texture=null}},s.d0=function(n){return n*n*n*n*n},s.d1=y,s.d2=45,s.d3=Qd,s.d4=function(n,e,i){const o=Math.sqrt(n*n+e*e+i*i),l=o>0?Math.acos(i/o)*Pl:0;let d=n!==0||e!==0?Math.atan2(-e,-n)*Pl+90:0;return d<0&&(d+=360),[o,d,l]},s.d5=In,s.d6=ri,s.d7=$,s.d8=$t,s.d9=Lt,s.dA=function(n){return n({pluginStatus:ao,pluginURL:pa}),Md.on("pluginStateChange",n),n},s.dB=nh,s.dC=class extends ga{constructor(n){super(n),this.current=ef}set(n,e,i){if(this.fetchUniformLocation(n,e)){for(let o=0;o<9;o++)if(i[o]!==this.current[o]){this.current=i,this.gl.uniformMatrix3fv(this.location,!1,i);break}}}},s.dD=Ml,s.dE=function(n,e,i){const o=Gc(i.zoom),l=n.style.map._antialias,d=n.terrain&&n.terrain.exaggeration()>0;return o===0&&!l&&!d},s.dF=function(n){const e=n.pixelsPerMeter,i=e/A(1,n.center.lat),o=ct(new Float64Array(16));return Pe(o,o,[n.point.x,n.point.y,0]),Ze(o,o,[i,i,e]),Float32Array.from(o)},s.dG=dy,s.dH=function(n){const e=D-5;n=V(n,-e,e)/e*90;const i=Math.pow(Math.abs(Math.sin(Oi(n))),3);return Math.round(i*(vm.length-1))},s.dI=function(n,e,i,o){const l=e.getNorth(),d=e.getSouth(),f=e.getWest(),_=e.getEast(),v=1<<n.z,b=_-f,E=l-d,I=b/jc,C=-E/vm[i],R=[0,I,0,C,0,0,l,f,0];if(n.z>0){const k=180/o;Xe(R,R,[k/b+1,0,0,0,k/E+1,0,-.5*k/I,.5*k/C,1])}return R[2]=v,R[5]=n.x,R[8]=n.y,R},s.dJ=Ts,s.dK=function(n,e,i){const o=ct(new Float64Array(16)),l=(e/(1<<n)-.5)*Math.PI*2;return kt(o,i.globeMatrix,l),Float32Array.from(o)},s.dL=MT,s.dM=Ws,s.dN=function(n,e){return[Math.pow(n[0],2.2)*e,Math.pow(n[1],2.2)*e,Math.pow(n[2],2.2)*e]},s.dO=Ee,s.dP=function(n,e){var i=Math.sin(e),o=Math.cos(e);return n[0]=o,n[1]=i,n[2]=0,n[3]=-i,n[4]=o,n[5]=0,n[6]=0,n[7]=0,n[8]=1,n},s.dQ=Va,s.dR=_T,s.dS=Li,s.dT=Ln,s.dU=256,s.dV=function(n,e){const i=[0,0,0];return Kn(i,i,py(Ts(e.canonical))),Kn(i,i,n),i},s.dW=n=>({u_matrix:new rh(n),u_texsize:new qs(n),u_pixels_to_tile_units:new tf(n),u_device_pixel_ratio:new ar(n),u_width_scale:new ar(n),u_floor_width_scale:new ar(n),u_image:new Jd(n),u_units_to_pixels:new qs(n),u_tile_units_to_pixels:new ar(n),u_alpha_discard_threshold:new ar(n),u_trim_offset:new qs(n),u_trim_fade_range:new qs(n),u_trim_color:new Qd(n),u_zbias_factor:new ar(n),u_tile_to_meter:new ar(n),u_ground_shadow_factor:new ih(n),u_pattern_transition:new ar(n)}),s.dX=n=>({u_matrix:new rh(n),u_pixels_to_tile_units:new tf(n),u_device_pixel_ratio:new ar(n),u_width_scale:new ar(n),u_floor_width_scale:new ar(n),u_units_to_pixels:new qs(n),u_dash_image:new Jd(n),u_gradient_image:new Jd(n),u_image_height:new ar(n),u_texsize:new qs(n),u_tile_units_to_pixels:new ar(n),u_alpha_discard_threshold:new ar(n),u_trim_offset:new qs(n),u_trim_fade_range:new qs(n),u_trim_color:new Qd(n),u_zbias_factor:new ar(n),u_tile_to_meter:new ar(n),u_ground_shadow_factor:new ih(n)}),s.dY=n=>({u_camera_to_center_distance:new ar(n),u_extrude_scale:new tf(n),u_device_pixel_ratio:new ar(n),u_matrix:new rh(n),u_inv_rot_matrix:new rh(n),u_merc_center:new qs(n),u_tile_id:new ih(n),u_zoom_transition:new ar(n),u_up_dir:new ih(n),u_emissive_strength:new ar(n)}),s.dZ=$d,s.d_=ck,s.da=ki,s.db=function(n){return[Math.pow(n[0],1/2.2),Math.pow(n[1],1/2.2),Math.pow(n[2],1/2.2)]},s.dc=DS,s.dd=$x,s.de=jS,s.df=p1,s.dg=function(n,e){return n.readFields(lL,{icons:[]},e)},s.dh=Sy,s.di=mf,s.dj=n1,s.dk=Gh,s.dl=Ku,s.dm=gc,s.dn=qh,s.dp=Ge,s.dq=function(n){const e=n.indexOf(Zl);return e>=0?n.slice(0,e):n},s.dr=function(n){return n.indexOf(Zl)>=0},s.ds=function(n){const e=n.lastIndexOf(Zl);return e>=0?n.slice(e+1):""},s.dt=function(n){const e=[],i=n.id;return i===void 0&&e.push({message:`layers.${i}: missing required property "id"`}),n.render===void 0&&e.push({message:`layers.${i}: missing required method "render"`}),n.renderingMode&&n.renderingMode!=="2d"&&n.renderingMode!=="3d"&&e.push({message:`layers.${i}: property "renderingMode" must be either "2d" or "3d"`}),e},s.du=function(n,e,i,o){return n.type==="custom"?new tL(n,e):new sL[n.type](n,e,i,o)},s.dv=rt,s.dw=function(n){const e=n.indexOf(Zl);return e>=0?n.slice(e+1):""},s.dx=class extends _h{constructor(n,e){super(n._vectorTileFeature,n._z,n._x,n._y,n.id),n.state&&(this.state=Object.assign({},n.state)),this.target=e.target,this.namespace=e.namespace,e.properties&&(this.properties=e.properties),this.target&&("featuresetId"in this.target&&!this.target.importId||"layerId"in this.target)&&(this.source=n.source,this.sourceLayer=n.sourceLayer,this.layer=n.layer)}toJSON(){const n=super.toJSON();return n.target=this.target,n.namespace=this.namespace,n}},s.dy=Md,s.dz=Dl,s.e=xi,s.e$=dn,s.e0=xT,s.e1=(n,e,i,o,l,d)=>{const f=n.transform,_=f.projection.name==="globe";let v;if(d.paint.get("circle-pitch-alignment")==="map")if(_){const E=_T(f.zoom,e.canonical)*f._pixelsPerMercatorPixel;v=Float32Array.from([E,0,0,E])}else v=f.calculatePixelsToTileUnitsMatrix(i);else v=new Float32Array([f.pixelsToGLUnits[0],0,0,f.pixelsToGLUnits[1]]);const b={u_camera_to_center_distance:n.transform.getCameraToCenterDistance(f.projection),u_matrix:n.translatePosMatrix(e.projMatrix,i,d.paint.get("circle-translate"),d.paint.get("circle-translate-anchor")),u_device_pixel_ratio:xr.devicePixelRatio,u_extrude_scale:v,u_inv_rot_matrix:EM,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:d.paint.get("circle-emissive-strength")};if(_){b.u_inv_rot_matrix=o,b.u_merc_center=l,b.u_tile_id=[e.canonical.x,e.canonical.y,1<<e.canonical.z],b.u_zoom_transition=Gc(f.zoom);const E=l[0]*dt,I=l[1]*dt;b.u_up_dir=f.projection.upVector(new on(0,0,0),E,I)}return b},s.e2=i2,s.e3=oo,s.e4=(n,e,i,o,l,d,f,_,v,b)=>{const E=n.transform,I=E.pitch<15?QS(.07,.7,V((14-E.zoom)/5,0,1)):.07,C=i.paint.get("line-trim-color-use-theme").constantOr("default")==="none";return{u_matrix:t2(n,e,i,o),u_texsize:e.imageAtlasTexture?e.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:E.calculatePixelsToTileUnitsMatrix(e),u_device_pixel_ratio:l,u_width_scale:d,u_floor_width_scale:f,u_image:0,u_tile_units_to_pixels:e2(e,E),u_units_to_pixels:[1/E.pixelsToGLUnits[0],1/E.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:_,u_trim_fade_range:i.paint.get("line-trim-fade-range"),u_trim_color:i.paint.get("line-trim-color").toPremultipliedRenderColor(C?null:i.lut).toArray01(),u_zbias_factor:I,u_tile_to_meter:$(e.tileID.canonical,0),u_ground_shadow_factor:v,u_pattern_transition:b}},s.e5=(n,e,i,o,l,d,f,_,v,b)=>{const E=n.transform,I=E.calculatePixelsToTileUnitsMatrix(e),C=i.paint.get("line-trim-color-use-theme").constantOr("default")==="none",R=E.pitch<15?QS(.07,.7,V((14-E.zoom)/5,0,1)):.07;return{u_matrix:t2(n,e,i,o),u_pixels_to_tile_units:I,u_device_pixel_ratio:d,u_width_scale:f,u_floor_width_scale:_,u_units_to_pixels:[1/E.pixelsToGLUnits[0],1/E.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:l,u_texsize:n2(i)&&e.lineAtlasTexture?e.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:e2(e,n.transform),u_alpha_discard_threshold:0,u_trim_offset:v,u_trim_fade_range:i.paint.get("line-trim-fade-range"),u_trim_color:i.paint.get("line-trim-color").toPremultipliedRenderColor(C?null:i.lut).toArray01(),u_zbias_factor:R,u_tile_to_meter:$(e.tileID.canonical,0),u_ground_shadow_factor:b}},s.e6=Le,s.e7=wm,s.e8=L,s.e9=rs,s.eA=function(n,e){var i=2*Math.acos(e[3]),o=Math.sin(i/2);return o>Z?(n[0]=e[0]/o,n[1]=e[1]/o,n[2]=e[2]/o):(n[0]=1,n[1]=0,n[2]=0),i},s.eB=g1,s.eC=Ry,s.eD=My,s.eE=[1,1,1],s.eF=vf,s.eG=Tl,s.eH=function(n,e,i,o){var l=e[0],d=e[1],f=e[2],_=e[3];return n[0]=l+o*(i[0]-l),n[1]=d+o*(i[1]-d),n[2]=f+o*(i[2]-f),n[3]=_+o*(i[3]-_),n},s.eI=uf,s.eJ=Bo,s.eK=Hs,s.eL=function(n,e,i,o,l,d,f,_,v,b,E,I,C,R,k,F){var U=new Q(16);return U[0]=n,U[1]=e,U[2]=i,U[3]=o,U[4]=l,U[5]=d,U[6]=f,U[7]=_,U[8]=v,U[9]=b,U[10]=E,U[11]=I,U[12]=C,U[13]=R,U[14]=k,U[15]=F,U},s.eM=u,s.eN=Bc,s.eO=cm,s.eP=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new et(1/0,1/0),max:new et(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(n,e=!1){const i=KT(new et(0,0),new et(dt,dt),n),o=[];if(e&&!Tx(i,this._globalClipBounds))return o;for(const l of this._activeRegions){if(l.hiddenByOverlap||!Tx(i,l))continue;const d=eR(l.min,l.max,n);o.push({min:d.min,max:d.max,sourceId:this._sourceIds[l.priority],footprint:l.footprint,footprintTileId:l.tileId,order:l.order,clipMask:l.clipMask,clipScope:l.clipScope})}return o}setSources(n){this._setSources(n.map(e=>({getSourceId:()=>e.cache.id,getFootprints:()=>{const i=[];for(const o of e.cache.getVisibleCoordinates()){const l=e.cache.getTile(o).buckets[e.layer];l&&l.updateFootprints(o.toUnwrapped(),i)}return i},getOrder:()=>e.order,getClipMask:()=>e.clipMask,getClipScope:()=>e.clipScope})))}_addSource(n){const e=n.getFootprints();if(e.length===0)return;const i=n.getOrder(),o=n.getClipMask(),l=n.getClipScope();for(const d of e){if(!d.footprint)continue;const f=KT(d.footprint.min,d.footprint.max,d.id);this._activeRegions.push({min:f.min,max:f.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:d.id,footprint:d.footprint,order:i,clipMask:o,clipScope:l})}this._sourceIds.push(n.getSourceId())}_computeReplacement(){this._activeRegions.sort((e,i)=>e.priority-i.priority||vy(e.min,i.min)||vy(e.max,i.max)||e.order-i.order||e.clipMask-i.clipMask||function(o,l){const d=(f,_)=>f+_;return o.length-l.length||o.reduce(d,"").localeCompare(l.reduce(d,""))}(e.clipScope,i.clipScope));let n=this._activeRegions.length!==this._prevRegions.length;if(!n){let e=0;for(;!n&&e!==this._activeRegions.length;){const i=this._activeRegions[e],o=this._prevRegions[e];n=i.priority!==o.priority||!XT(i,o)||i.order!==o.order||i.clipMask!==o.clipMask||!sa(i.clipScope,o.clipScope),this._activeRegions[e].hiddenByOverlap=o.hiddenByOverlap,++e}}if(n){++this._updateTime;for(const i of this._activeRegions)i.order!==Am&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,i.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,i.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,i.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,i.max.y));const e=i=>{const o=this._activeRegions;if(i>=o.length)return i;const l=o[i].priority;for(;i<o.length&&o[i].priority===l;)++i;return i};if(this._sourceIds.length>1){let i=0,o=e(i);for(;i!==o;){let l=i;const d=i;for(;l!==o;){const f=this._activeRegions[l];f.hiddenByOverlap=!1;for(let _=0;_<d;_++){const v=this._activeRegions[_];if(!v.hiddenByOverlap&&f.order===Am&&Tx(f,v)&&(f.hiddenByOverlap=YT(f.footprint,f.tileId,v.footprint,v.tileId),f.hiddenByOverlap))break}++l}i=o,o=e(i)}}}}_setSources(n){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let e=n.length-1;e>=0;e--)this._addSource(n[e]);this._computeReplacement()}},s.eQ=Am,s.eR=class{constructor(n){this._createGrid(n),this._createPoles(n)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const n of this._poleSegments)n.destroy();for(const n of this._gridSegments)n.withSkirts.destroy(),n.withoutSkirts.destroy()}_fillGridMeshWithLods(n,e){const i=new al,o=new sr,l=[],d=n+1+2,f=e[0]+1,_=e[0]+1+(1+e.length),v=(b,E,I)=>{let C=b===d-1?b-2:b===0?b:b-1;return C+=I?24575:0,[C,E]};for(let b=0;b<d;++b)i.emplaceBack(...v(b,0,!0));for(let b=0;b<f;++b)for(let E=0;E<d;++E)i.emplaceBack(...v(E,b,(E===0||E===d-1)&&!0));for(let b=0;b<e.length;++b){const E=e[b];for(let I=0;I<d;++I)i.emplaceBack(...v(I,E,!0))}for(let b=0;b<e.length;++b){const E=o.length,I=e[b]+1+2,C=new sr;for(let F=0;F<I-1;F++){const U=F===I-2,j=U?d*(_-e.length+b-F):d;for(let H=0;H<d-1;H++){const W=F*d+H;F===0||U||H===0||H===d-2?(C.emplaceBack(W+1,W,W+j),C.emplaceBack(W+j,W+j+1,W+1)):(o.emplaceBack(W+1,W,W+j),o.emplaceBack(W+j,W+j+1,W+1))}}const R=An.simpleSegment(0,E,i.length,o.length-E);for(let F=0;F<C.uint16.length;F+=3)o.emplaceBack(C.uint16[F],C.uint16[F+1],C.uint16[F+2]);const k=An.simpleSegment(0,E,i.length,o.length-E);l.push({withoutSkirts:R,withSkirts:k})}return{vertices:i,indices:o,segments:l}}_createGrid(n){const e=this._fillGridMeshWithLods(jc,vm);this._gridSegments=e.segments,this._gridBuffer=n.createVertexBuffer(e.vertices,Vc.members),this._gridIndexBuffer=n.createIndexBuffer(e.indices,!0)}_createPoles(n){const e=new sr;for(let f=0;f<=jc;f++)e.emplaceBack(0,f+1,f+2);this._poleIndexBuffer=n.createIndexBuffer(e,!0);const i=new Kl,o=new Kl,l=new Kl,d=new Kl;this._poleSegments=[];for(let f=0,_=0;f<es;f++){const v=360/(1<<f);i.emplaceBack(0,-Gr,0,.5,0),o.emplaceBack(0,-Gr,0,.5,1),l.emplaceBack(0,-Gr,0,.5,.5),d.emplaceBack(0,-Gr,0,.5,.5);for(let b=0;b<=jc;b++){let E=b/jc,I=0;const C=Kt(0,v,E),[R,k,F]=Yl(TM,SM,C,Gr);i.emplaceBack(R,k,F,E,I),o.emplaceBack(R,k,F,E,1-I);const U=Oi(C);E=.5+.5*Math.sin(U),I=.5+.5*Math.cos(U),l.emplaceBack(R,k,F,E,I),d.emplaceBack(R,k,F,E,1-I)}this._poleSegments.push(An.simpleSegment(_,0,66,64)),_+=66}this._poleNorthVertexBuffer=n.createVertexBuffer(i,bs,!1),this._poleSouthVertexBuffer=n.createVertexBuffer(o,bs,!1),this._texturedPoleNorthVertexBuffer=n.createVertexBuffer(l,bs,!1),this._texturedPoleSouthVertexBuffer=n.createVertexBuffer(d,bs,!1)}getGridBuffers(n,e){return[this._gridBuffer,this._gridIndexBuffer,e?this._gridSegments[n].withSkirts:this._gridSegments[n].withoutSkirts]}getPoleBuffers(n,e){return[e?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,e?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[n]]}},s.eS=WT,s.eT=Tu,s.eU=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},s.eV=Ie,s.eW=G,s.eX=function(n,e,i){return n[0]=e[0]/i[0],n[1]=e[1]/i[1],n[2]=e[2]/i[2],n},s.eY=hp,s.eZ=Uc,s.e_=ia,s.ea=by,s.eb=fS,s.ec=Ql,s.ed=nS,s.ee=iS,s.ef=B,s.eg=function(n,e){if(n===e){var i=e[1],o=e[2],l=e[3],d=e[6],f=e[7],_=e[11];n[1]=e[4],n[2]=e[8],n[3]=e[12],n[4]=i,n[6]=e[9],n[7]=e[13],n[8]=o,n[9]=d,n[11]=e[14],n[12]=l,n[13]=f,n[14]=_}else n[0]=e[0],n[1]=e[4],n[2]=e[8],n[3]=e[12],n[4]=e[1],n[5]=e[5],n[6]=e[9],n[7]=e[13],n[8]=e[2],n[9]=e[6],n[10]=e[10],n[11]=e[14],n[12]=e[3],n[13]=e[7],n[14]=e[11],n[15]=e[15];return n},s.eh=eL,s.ei=_i,s.ej=hm,s.ek=256,s.el=dx,s.em=Fo,s.en=kt,s.eo=function(n,e){return n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[4],n[4]=e[5],n[5]=e[6],n[6]=e[8],n[7]=e[9],n[8]=e[10],n},s.ep=Kl,s.eq=Lg,s.er=lm,s.es=function(n,e,i,o,l){return V((n-e)/(i-e)*(l-o)+o,o,l)},s.et=ra,s.eu=function(n,e){var i=e[0],o=e[1],l=e[2],d=e[3],f=e[4],_=e[5],v=e[6],b=e[7],E=e[8],I=E*f-_*b,C=-E*d+_*v,R=b*d-f*v,k=i*I+o*C+l*R;return k?(n[0]=I*(k=1/k),n[1]=(-E*o+l*b)*k,n[2]=(_*o-l*f)*k,n[3]=C*k,n[4]=(E*i-l*v)*k,n[5]=(-_*i+l*d)*k,n[6]=R*k,n[7]=(-b*i+o*v)*k,n[8]=(f*i-o*d)*k,n):null},s.ev=2,s.ew=Ua,s.ex=na,s.ey=Xt,s.ez=function(n,e){var i=new Q(3);Xt(i,e);var o=1/i[0],l=1/i[1],d=1/i[2],f=e[0]*o,_=e[1]*l,v=e[2]*d,b=e[4]*o,E=e[5]*l,I=e[6]*d,C=e[8]*o,R=e[9]*l,k=e[10]*d,F=f+E+k,U=0;return F>0?(U=2*Math.sqrt(F+1),n[3]=.25*U,n[0]=(I-R)/U,n[1]=(C-v)/U,n[2]=(_-b)/U):f>E&&f>k?(U=2*Math.sqrt(1+f-E-k),n[3]=(I-R)/U,n[0]=.25*U,n[1]=(_+b)/U,n[2]=(C+v)/U):E>k?(U=2*Math.sqrt(1+E-f-k),n[3]=(C-v)/U,n[0]=(_+b)/U,n[1]=.25*U,n[2]=(I+R)/U):(U=2*Math.sqrt(1+k-f-E),n[3]=(_-b)/U,n[0]=(C+v)/U,n[1]=(I+R)/U,n[2]=.25*U),n},s.f=function(n){return btoa(encodeURIComponent(n).replace(/%([0-9A-F]{2})/g,(e,i)=>String.fromCharCode(+("0x"+i))))},s.f0=function([n,e,i]){const o=Math.hypot(n,e,i),l=Math.atan2(n,i),d=.5*Math.PI-Math.acos(-e/o);return new r(Kr(l),Kr(d))},s.f1=Ha,s.f2=Bx,s.f3=function(n){const e=n.navigator?n.navigator.userAgent:null;return!!function(i){if(er==null){const o=i.navigator?i.navigator.userAgent:null;er=!!i.safari||!(!o||!(/\b(iPad|iPhone|iPod)\b/.test(o)||o.match("Safari")&&!o.match("Chrome")))}return er}(n)&&!(!e||!(e.match("Version/15.4")||e.match("Version/15.5")||e.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/)))},s.f4=function(n,e){jh=n,Uh=e},s.f5=px,s.f6=yT,s.f7=function(n){const e=[0,0,0],i=ct(new Float64Array(16));return xe(i,n.pixelMatrix,n.globeMatrix),Kn(e,e,i),new et(e[0],e[1])},s.f8=function(){const n=Lm;n&&(n.isPreloaded()&&n.numActive()===1?(n.release(Px),Lm=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},s.f9=function(){Sy().acquire(Px)},s.fA=n0,s.fB=ye,s.fC=function(n){let e=0;if(new Uint32Array(n,0,1)[0]!==MS){const i=new Uint32Array(n,0,7),[,,o,l,d,f]=i;e=i.byteLength+l+d+f+d,(o!==n.byteLength||e>=n.byteLength)&&bt("Invalid b3dm header information.")}return zS(n,e)},s.fD=function(n,e){const i=$x(n);for(const o of i){for(const l of o.meshes)RR(l);o.lights&&(o.lightMeshIndex=o.meshes.length,o.meshes.push(kR(o.lights,e)))}return i},s.fE=Yy,s.fF=Ii,s.fG=ES,s.fH=ma,s.fI=Ao,s.fJ=function(n){ms(),Ds!=null&&Ds.then(e=>{e.keys().then(i=>{for(let o=0;o<i.length-n;o++)e.delete(i[o]).catch(l=>bt(l.message))}).catch(i=>bt(i.message))}).catch(e=>bt(e.message))},s.fa=Yu,s.fb=function(n,e,i=!1){if(ao===Ao.deferred||ao===Ao.loading||ao===Ao.loaded)throw new Error("setRTLTextPlugin cannot be called multiple times.");pa=xr.resolveURL(n),ao=Ao.deferred,Jp=e,Pd(),i||Hg()},s.fc=function(n){af=xr.resolveURL(n),lf||(lf=new sf(Sy(),new Ol)),lf.broadcast("setMeshoptUrl",af)},s.fd=CS,s.fe=function(n){kx=xr.resolveURL(n),lf||(lf=new sf(Sy(),new Ol)),lf.broadcast("setDracoUrl",kx)},s.ff=AS,s.fg=km,s.fh=function(n){const e=ps();if(!e)return;const i=e.delete(Nh);n&&i.then(()=>n()).catch(n)},s.fi=hh,s.fj=It,s.fk=Hc,s.fl=Ia,s.fm=WE,s.fn=ZE,s.fo=XS,s.fp=Ne,s.fq="hd_road_elevation",s.fr=Gi,s.fs=ke,s.ft=Jl,s.fu=i1,s.fv=ph,s.fw=function(n,e,i,o,l,d,f,_=1,v,b,E){n.createArrays(),n.tilePixelRatio=dt/(512*n.overscaling),n.compareText={},n.iconsNeedLinear=!1;const I=n.layers[0].layout,C=n.layers[0]._unevaluatedLayout._values,R={};R.scaleFactor=_,R.textSizeScaleRange=I.get("text-size-scale-range"),R.iconSizeScaleRange=I.get("icon-size-scale-range");const[k,F]=R.textSizeScaleRange,[U,j]=R.iconSizeScaleRange;R.textScaleFactor=V(R.scaleFactor,k,F),R.iconScaleFactor=V(R.scaleFactor,U,j);const H=C["text-size"],W=C["icon-size"];if(n.textSizeData.kind==="composite"){const{minZoom:ge,maxZoom:Fe}=n.textSizeData;R.compositeTextSizes=[H.possiblyEvaluate(new fn(ge,{worldview:E}),d),H.possiblyEvaluate(new fn(Fe,{worldview:E}),d)]}if(n.iconSizeData.kind==="composite"){const{minZoom:ge,maxZoom:Fe}=n.iconSizeData;R.compositeIconSizes=[W.possiblyEvaluate(new fn(ge,{worldview:E}),d),W.possiblyEvaluate(new fn(Fe,{worldview:E}),d)]}R.layoutTextSize=H.possiblyEvaluate(new fn(f+1,{worldview:E}),d),R.layoutIconSize=W.possiblyEvaluate(new fn(f+1,{worldview:E}),d),R.textMaxSize=H.possiblyEvaluate(new fn(18,{worldview:E}),d);const Y=I.get("symbol-placement"),se=I.get("text-rotation-alignment")==="map"&&Y!=="point",ie=I.get("text-size");let ce=!1;const fe=[];for(const ge of n.features){const Fe=I.get("text-font").evaluate(ge,{},d).join(","),be=ie.evaluate(ge,{},d)*R.textScaleFactor,Ue=R.layoutTextSize.evaluate(ge,{},d)*R.textScaleFactor,He=R.layoutIconSize.evaluate(ge,{},d)*R.iconScaleFactor,qe={horizontal:{},vertical:void 0},tt=ge.text;let nt,Ye=[0,0];if(tt){const oi=tt.toString(),en=I.get("text-letter-spacing").evaluate(ge,{},d)*br,ne=I.get("text-line-height").evaluate(ge,{},d)*br,ae=Kp(oi)?en:0,Ve=I.get("text-anchor").evaluate(ge,{},d),it=I.get("text-variable-anchor");if(!it){const ni=I.get("text-radial-offset").evaluate(ge,{},d);if(ni)Ye=R2(Ve,[ni*br,o1]);else{const hi=I.get("text-offset").evaluate(ge,{},d);Ye=[hi[0]*br,hi[1]*br]}}let gt=se?"center":I.get("text-justify").evaluate(ge,{},d);const yt=Y==="point",Ft=yt?I.get("text-max-width").evaluate(ge,{},d)*br:1/0,Nt=ni=>{n.allowVerticalPlacement&&Xu(oi)&&(qe.vertical=Yx(tt,e,i,l,Fe,Ft,ne,Ve,ni,ae,Ye,Uo.vertical,!0,Ue,be,v))};if(!se&&it){const ni=gt==="auto"?it.map(fi=>s1(fi)):[gt];let hi=!1;for(let fi=0;fi<ni.length;fi++){const gi=ni[fi];if(!qe.horizontal[gi])if(hi)qe.horizontal[gi]=qe.horizontal[0];else{const Wt=Yx(tt,e,i,l,Fe,Ft,ne,"center",gi,ae,Ye,Uo.horizontal,!1,Ue,be,v);Wt&&(qe.horizontal[gi]=Wt,hi=Wt.positionedLines.length===1)}}Nt("left")}else{if(gt==="auto"&&(gt=s1(Ve)),yt||I.get("text-writing-mode").indexOf("horizontal")>=0||!Xu(oi)){const ni=Yx(tt,e,i,l,Fe,Ft,ne,Ve,gt,ae,Ye,Uo.horizontal,!1,Ue,be,v);ni&&(qe.horizontal[gt]=ni)}Nt(yt?"left":gt)}}let Je,je,Be,Qe,ft,at,Ot=!1;const xt=I.get("icon-text-fit").evaluate(ge,{},d);if(ge.icon&&ge.icon.hasPrimary()){const oi=$m(ge.icon,n.iconSizeData,C["icon-size"],d,n.zoom,ge,v,R.iconScaleFactor,E);Je=oi.iconPrimary,Be=oi.iconSecondary;const en=Je.toString();if(je=o.get(en),je&&(ft=I.get("icon-offset").evaluate(ge,{},d),at=I.get("icon-anchor").evaluate(ge,{},d),nt=Oy(l.get(en),Be?l.get(Be.toString()):void 0,ft,at),Ot=je.sdf,n.sdfIcons===void 0?n.sdfIcons=je.sdf:n.sdfIcons!==je.sdf&&bt("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(je.pixelRatio!==n.pixelRatio||I.get("icon-rotate").constantOr(1)!==0)&&(n.iconsNeedLinear=!0)),Be){const ne=Be.toString();Qe=o.get(ne)}}ce=ce||!(!ge.icon||!ge.icon.hasSecondary());const St=Uy(qe.horizontal)||qe.vertical;n.iconsInText||(n.iconsInText=!!St&&St.iconsInText);const Pt=Ue*R.textScaleFactor/br,{defaultShapedIcon:pi,verticallyShapedIcon:lt}=jk(n,nt,I,ge,d,qe,Pt,ft,xt);xt!=="none"&&nt&&(_2(nt)||g2(nt))&&(jy(0,je,Je,nt,pi,xt,b,o,l),jy(0,Qe,Be,nt,pi,xt,b,o,l),lt&&(jy(0,je,Je,nt,lt,xt,b,o,l),jy(0,Qe,Be,nt,lt,xt,b,o,l))),nt=pi;const{iconBBox:Mt,iconVerticalBBox:ei,textBBox:bi,textVerticalBBox:Si}=Dk(n,nt,lt,I,ge,d,He,ft,R,l,at,qe,Ue,Ye);fe.push({feature:ge,shapedTextOrientations:qe,shapedText:St,shapedIcon:nt,iconPrimary:Je,iconSecondary:Be,iconOffset:ft,iconAnchor:at,verticallyShapedIcon:lt,layoutTextSize:Ue,layoutIconSize:He,textOffset:Ye,isSDFIcon:Ot,iconTextFit:xt,iconCollisionBounds:Mt,iconVerticalCollisionBounds:ei,textCollisionBounds:bi,textVerticalCollisionBounds:Si})}return{featureData:fe,sizes:R,hasAnySecondaryIcon:ce,textAlongLine:se,symbolPlacement:Y}},s.fx=E2,s.fy=function(n,e,i,o,l,d,f,_,v,b){n.iconAtlasPositions=b.iconPositions;const{featureData:E,hasAnySecondaryIcon:I,sizes:C,textAlongLine:R,symbolPlacement:k}=e;for(const F of E){const{shapedIcon:U,verticallyShapedIcon:j,feature:H,shapedTextOrientations:W,shapedText:Y,layoutTextSize:se,textOffset:ie,isSDFIcon:ce,iconPrimary:fe,iconSecondary:ge,iconTextFit:Fe,iconOffset:be,iconCollisionBounds:Ue,iconVerticalCollisionBounds:He,textCollisionBounds:qe}=F;L2(U,b.iconPositions,fe,ge),L2(j,b.iconPositions,fe,ge),Nk(W,b.iconPositions),Bk(fe,ge,b.iconPositions),(Y||U)&&Uk(n,H,W,U,j,v,C,se,0,ie,ce,o,l,f,_,I,Fe,be,R,k,Ue,He,qe)}i&&n.generateCollisionDebugBuffers(d,n.collisionBoxArray,C.textScaleFactor)},s.fz=Ae,s.g=function(n,e){return Dl(Object.assign(n,{method:"GET"}),e)},s.h=function(n){return n.indexOf("mapbox:")===0},s.i=function(n){return xi.API_STYLE_REGEX.test(n)&&!Or(n)},s.j=$n,s.k=Os,s.l=function(n){return decodeURIComponent(atob(n).split("").map(e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join(""))},s.m=function(n,e){return Dl(Object.assign(n,{type:"json"}),e)},s.n=Hh,s.o=xr,s.p=function(n,e){return Dl(Object.assign(n,{method:"POST"}),e)},s.q=Wr,s.r=zs,s.s=function(n){try{const e=self[n];return e.setItem("_mapbox_test_",1),e.removeItem("_mapbox_test_"),!0}catch{return!1}},s.t=function(){return Mx||(Mx=new hh("ImageRasterizer")),Mx},s.u=function(){return function n(e){return e?(e^Math.random()*(16>>e/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,n)}()},s.v=function(n){return!!n&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(n)},s.w=bt,s.x=T1,s.y=Pu,s.z=Fs}),P(["./shared"],function(s){function Z(Ie){const V=Ie?Ie.url.toString():void 0;return V?performance.getEntriesByName(V):[]}function Q(Ie){if(typeof Ie=="number"||typeof Ie=="boolean"||typeof Ie=="string"||Ie==null)return JSON.stringify(Ie);if(Array.isArray(Ie)){let q="[";for(const ee of Ie)q+=`${Q(ee)},`;return`${q}]`}let V="{";for(const q of Object.keys(Ie).sort())V+=`${q}:${Q(Ie[q])},`;return`${V}}`}function me(Ie){let V="";for(const q of s.bx)V+=`/${Q(Ie[q])}`;return V}class Ee{constructor(V){this.keyCache={},this._layers={},this._layerConfigs={},V&&this.replace(V)}replace(V,q){this._layerConfigs={},this._layers={},this.update(V,[],q)}update(V,q,ee){this._options=ee;for(const de of V)this._layerConfigs[de.id]=de,(this._layers[de.id]=s.du(de,this.scope,null,this._options)).compileFilter(ee),this.keyCache[de.id]&&delete this.keyCache[de.id];for(const de of q)delete this.keyCache[de],delete this._layerConfigs[de],delete this._layers[de];this.familiesBySource={};const pe=function(de,ve){const Le={};for(let ke=0;ke<de.length;ke++){const rt=de[ke];let Ge=ve&&ve[rt.id];Ge||(rt.type==="symbol"?Ge=rt.id:(Ge=me(rt),rt.type==="line"&&rt.paint&&function jt(bt){return typeof bt=="string"&&bt==="line-progress"||(Array.isArray(bt)?bt.some(jt):!(!bt||typeof bt!="object")&&Object.values(bt).some(jt))}(rt.paint["line-width"])&&(Ge+=`/${Q(rt.paint["line-width"])}`))),ve&&(ve[rt.id]=Ge);let Et=Le[Ge];Et||(Et=Le[Ge]=[]),Et.push(rt)}const Te=[];for(const ke in Le)Te.push(Le[ke]);return Te}(Object.values(this._layerConfigs),this.keyCache);for(const de of pe){const ve=de.map(Et=>this._layers[Et.id]),Le=ve[0];if(Le.visibility==="none")continue;const Te=Le.source||"";let ke=this.familiesBySource[Te];ke||(ke=this.familiesBySource[Te]={});const rt=Le.sourceLayer||"_geojsonTileLayer";let Ge=ke[rt];Ge||(Ge=ke[rt]=[]),Ge.push(ve)}}}const De=1*s.fl;class Xe{constructor(V){const q={},ee=[];for(const Le in V){const Te=V[Le],ke=q[Le]={};for(const rt in Te.glyphs){const Ge=Te.glyphs[+rt];if(!Ge||Ge.bitmap.width===0||Ge.bitmap.height===0)continue;const Et=Ge.metrics.localGlyph?De:1,jt={x:0,y:0,w:Ge.bitmap.width+2*Et,h:Ge.bitmap.height+2*Et};ee.push(jt),ke[rt]=jt}}const{w:pe,h:de}=s.G(ee),ve=new s.fk({width:pe||1,height:de||1});for(const Le in V){const Te=V[Le];for(const ke in Te.glyphs){const rt=Te.glyphs[+ke];if(!rt||rt.bitmap.width===0||rt.bitmap.height===0)continue;const Ge=q[Le][ke],Et=rt.metrics.localGlyph?De:1;s.fk.copy(rt.bitmap,ve,{x:0,y:0},{x:Ge.x+Et,y:Ge.y+Et},rt.bitmap)}}this.image=ve,this.positions=q}}function mt(Ie,V,q){Ie[V]?q&&(Ie[V].center=q):Ie[V]={floorIds:new Set,center:q||[0,0],floors:{}}}function We(Ie,V,q,ee){for(const pe of V)mt(Ie,pe),Ie[pe].floors[q]=ee,Ie[pe].floorIds.add(q)}function ct(Ie){return{id:Ie.properties.id.toString(),center:Ie.properties.center.toString().split(";").map(Number)}}function Me(Ie){return{id:Ie.properties.id.toString(),isDefault:!!Ie.properties.is_default&&Ie.properties.is_default,connections:Ie.properties.connected_floor_ids?new Set(Ie.properties.connected_floor_ids.toString().split(";")):new Set,conflicts:Ie.properties.conflicted_floor_ids?new Set(Ie.properties.conflicted_floor_ids.toString().split(";")):new Set,buildings:Ie.properties.building_ids?new Set(Ie.properties.building_ids.toString().split(";")):new Set,name:Ie.properties.name.toString(),zIndex:Ie.properties.z_index}}function xe(Ie,V){return V.every(q=>Ie.properties&&Ie.properties[q]!=null)}function Pe(Ie){return xe(Ie,["type","id","name"])&&Ie.properties.type==="building"}function Ze(Ie){return xe(Ie,["type","id","name","z_index"])&&Ie.properties.type==="floor"}s.fj(Xe,"GlyphAtlas");class Ct{constructor(V){this.tileID=new s.aQ(V.tileID.overscaledZ,V.tileID.wrap,V.tileID.canonical.z,V.tileID.canonical.x,V.tileID.canonical.y),this.tileZoom=V.tileZoom,this.uid=V.uid,this.zoom=V.zoom,this.lut=V.lut,this.canonical=V.tileID.canonical,this.pixelRatio=V.pixelRatio,this.tileSize=V.tileSize,this.source=V.source,this.scope=V.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=V.showCollisionBoxes,this.collectResourceTiming=!!V.request&&V.request.collectResourceTiming,this.promoteId=V.promoteId,this.isSymbolTile=V.isSymbolTile,this.tileTransform=s.aZ(V.tileID.canonical,V.projection),this.projection=V.projection,this.worldview=V.worldview,this.localizableLayerIds=V.localizableLayerIds,this.brightness=V.brightness,this.extraShadowCaster=!!V.extraShadowCaster,this.tessellationStep=V.tessellationStep,this.scaleFactor=V.scaleFactor,this.worldview=V.worldview,this.indoor=V.indoor}parse(V,q,ee,pe,de,ve){this.status="parsing",this.data=V,this.collisionBoxArray=new s.b3;const Le=new s.fm(Object.keys(V.layers).sort()),Te=new s.fn(this.tileID,this.promoteId);Te.bucketLayerIDs=[];const ke={},rt=new s.fo(256,256),Ge={featureIndex:Te,iconDependencies:new Map,patternDependencies:new Map,glyphDependencies:{},lineAtlas:rt,availableImages:ee,brightness:this.brightness,scaleFactor:this.scaleFactor,elevationFeatures:void 0,activeFloors:void 0};if(this.indoor){const li=this.indoor.indoorState.activeFloorsVisible,si=function(ri,Ii,Fn){const er=function(kn,Li){if(!kn)return s.w("No source layers defined in indoor specification"),Li;if(kn.size===0)return Li;const Ln=kn.difference(Li);for(const an of Ln)s.w(`Missing source layer required in indoor specification: ${an}`);return Li.intersection(Li)}(Ii.sourceLayers,new Set(Object.keys(ri.layers))),Vn=Ii.indoorState,rr=function(kn,Li,Ln,an){const xi=new Set,$n=new Set,Or=new Set,Vr=new Map,mo={},Rl=Ar=>{const zo=Vr.get(Ar)||new Set;for(const Yr of xi)if((Vr.get(Yr)||new Set).has(Ar)||zo.has(Yr))return!0;return!1};for(const Ar of Li){const zo=kn.layers[Ar];if(zo)for(let Yr=0;Yr<zo.length;Yr++){const zs=zo.feature(Yr);if(Pe(zs)){const{id:xr,center:kl}=ct(zs);mt(mo,xr,kl),xi.add(xr)}else if(Ze(zs)){const{id:xr,isDefault:kl,connections:gc,conflicts:Nh,buildings:jh,name:Uh,zIndex:Su}=Me(zs);We(mo,jh,xr,{name:Uh,zIndex:Su}),Vr.set(xr,Nh),(xr===an||gc.has(an))&&xi.add(xr),$n.add(xr),kl&&Or.add(xr)}}else s.w(`indoor source layer not found: ${Ar}`)}if(Ln)for(const Ar of Ln)$n.has(Ar)&&(Rl(Ar)||xi.add(Ar));for(const Ar of Or)xi.has(Ar)||Rl(Ar)||xi.add(Ar);return{buildings:mo,activeFloors:xi}}(ri,er,Vn.lastActiveFloors,Vn.selectedFloorId);return Fn.send("setIndoorData",rr),rr}(V,this.indoor,de);Ge.activeFloors=li?si.activeFloors:void 0}const Et=[],jt=q.familiesBySource[this.source];for(const li in jt){const si=V.layers[li];if(!si)continue;let ri=!1,Ii=!1,Fn=!1;for(const Li of jt[li])Li[0].type==="symbol"?ri=!0:Ii=!0,Li[0].is3D()&&Li[0].type!=="model"&&(Fn=!0);if(this.extraShadowCaster&&!Fn||this.isSymbolTile===!0&&!ri||this.isSymbolTile===!1&&!Ii)continue;si.version===1&&s.w(`Vector tile source "${this.source}" layer "${li}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const er=Le.encode(li),Vn=[],rr=this.localizableLayerIds&&this.localizableLayerIds.has(li);let kn=!1;for(let Li=0,Ln=0;Li<si.length;Li++){const an=si.feature(Li),xi=Te.getId(an,li),$n=an.properties?an.properties.worldview:null;if(rr&&this.worldview&&typeof $n=="string")if($n==="all")an.properties.$localized=!0;else{if(!$n.split(",").includes(this.worldview))continue;an.properties.$localized=!0,an.properties.worldview=this.worldview}!kn&&an.properties&&an.properties.hasOwnProperty(s.fp)&&(kn=!0),Vn.push({feature:an,id:xi,index:Ln,sourceLayerIndex:er}),Ln++}kn&&!Ge.elevationFeatures&&V.layers.hasOwnProperty(s.fq)&&(Ge.elevationFeatures=s.fr.parseFrom(V.layers[s.fq],this.canonical));for(const Li of jt[li]){const Ln=Li[0];if(this.extraShadowCaster&&(!Ln.is3D()||Ln.type==="model")||this.isSymbolTile!==void 0&&Ln.type==="symbol"!==this.isSymbolTile||Ln.minzoom&&this.zoom<Math.floor(Ln.minzoom)||Ln.maxzoom&&this.zoom>=Ln.maxzoom||Ln.visibility==="none")continue;kt(Li,this.zoom,Ge.brightness,ee,this.worldview);const an=ke[Ln.id]=Ln.createBucket({index:Te.bucketLayerIDs.length,layers:Li,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:er,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep,styleDefinedModelURLs:pe,worldview:this.worldview,localizable:rr});Te.bucketLayerIDs.push(Li.map($n=>s.B($n.id,$n.scope)));let xi=an.prepare?an.prepare():null;xi!=null?(xi=xi.then(()=>an.populate(Vn,Ge,this.tileID.canonical,this.tileTransform)),Et.push(xi)):an.populate(Vn,Ge,this.tileID.canonical,this.tileTransform)}}const bt=()=>{let li,si,ri,Ii,Fn,er;rt.trim();const Vn={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},rr=()=>{if(li)return this.status="done",ve(li);if(this.extraShadowCaster)this.status="done",ve(null,{buckets:Object.values(ke).filter(Li=>!Li.isEmpty()),featureIndex:Te,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:Ge.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(si&&ri&&Ii){const Li=new Xe(si),Ln=new Map;for(const[$n,Or]of ri.entries()){const{imagePosition:Vr}=s.fu($n,Or,s.fv);Ln.set($n,Vr)}const an={};for(const $n in ke){const Or=ke[$n];Or instanceof s.b4&&(kt(Or.layers,this.zoom,Ge.brightness,ee,this.worldview),an[$n]=s.fw(Or,si,Li.positions,ri,Ln,this.tileID.canonical,this.tileZoom,this.scaleFactor,this.pixelRatio,Fn,this.worldview))}const xi={iconsPending:!0,patternsPending:!0};this.rasterizeIfNeeded(de,ri,Fn,()=>{xi.iconsPending=!1,kn(an,Li,xi)}),this.rasterizeIfNeeded(de,Ii,er,()=>{xi.patternsPending=!1,kn(an,Li,xi)})}},kn=(Li,Ln,an,xi)=>{if(an.iconsPending||an.patternsPending)return;const $n=new s.fx(ri,Ii,this.lut);for(const Or in ke){const Vr=ke[Or];if(Or in Li)s.fy(Vr,Li[Or],this.showCollisionBoxes,ee,this.tileID.canonical,this.tileZoom,this.projection,this.brightness,ri,$n);else if(Vr.hasPattern&&(Vr instanceof s.ba||Vr instanceof s.bb||Vr instanceof s.ea)){kt(Vr.layers,this.zoom,Ge.brightness,ee,this.worldview);const mo=Object.fromEntries($n.patternPositions);Vr.addFeatures(Ge,this.tileID.canonical,mo,ee,this.tileTransform,this.brightness)}}this.status="done",ve(null,{buckets:Object.values(ke).filter(Or=>!Or.isEmpty()),featureIndex:Te,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:Ln.image,lineAtlas:rt,imageAtlas:$n,brightness:Ge.brightness})};if(!this.extraShadowCaster){const Li=s.fs(Ge.glyphDependencies,xi=>Object.keys(xi).map(Number));Object.keys(Li).length?de.send("getGlyphs",{uid:this.uid,stacks:Li},(xi,$n)=>{li||(li=xi,si=$n,rr())},void 0,!1,Vn):si={};const Ln=Array.from(Ge.iconDependencies.keys()).map(xi=>s.I.parse(xi));Ln.length?de.send("getImages",{images:Ln,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},(xi,$n)=>{li||(li=xi,ri=new Map,Fn=this.updateImageMapAndGetImageTaskQueue(ri,$n,Ge.iconDependencies),rr())},void 0,!1,Vn):(ri=new Map,Fn=new Map);const an=Array.from(Ge.patternDependencies.keys()).map(xi=>s.I.parse(xi));an.length?de.send("getImages",{images:an,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},(xi,$n)=>{li||(li=xi,Ii=new Map,er=this.updateImageMapAndGetImageTaskQueue(Ii,$n,Ge.patternDependencies),rr())},void 0,!1,Vn):(Ii=new Map,er=new Map)}if(Ge.elevationFeatures&&Ge.elevationFeatures.length>0){const Li=[];for(const an of Object.values(ke))if(an instanceof s.bb){const xi=an.getUnevaluatedPortalGraph();xi&&Li.push(xi)}const Ln=s.ft.evaluate(Li);for(const an of Object.values(ke))if(an instanceof s.bb){const xi=V.layers[Le.decode(an.sourceLayerIndex)];an.setEvaluatedPortalGraph(Ln,xi,this.tileID.canonical,Ge.availableImages,Ge.brightness)}}rr()};Et.length>0?Promise.allSettled(Et).then(bt).catch(ve):bt()}updateParameters(V){this.scaleFactor=V.scaleFactor,this.showCollisionBoxes=V.showCollisionBoxes,this.projection=V.projection,this.brightness=V.brightness,this.tileTransform=s.aZ(V.tileID.canonical,V.projection),this.extraShadowCaster=V.extraShadowCaster,this.lut=V.lut,this.worldview=V.worldview,this.indoor=V.indoor}rasterizeIfNeeded(V,q,ee,pe){Array.from(q.values()).some(de=>de.usvg)?this.rasterize(V,q,ee,pe):pe()}updateImageMapAndGetImageTaskQueue(V,q,ee){const pe=new Map;for(const de of q.keys()){const ve=ee.get(de)||[];for(const Le of ve){const Te=Le.toString(),ke=q.get(Le.id.toString());ke.usvg?pe.has(Te)||(pe.set(Te,Le),V.set(Te,Object.assign({},ke))):V.set(Te,ke)}}return pe}rasterize(V,q,ee,pe){this.rasterizeTask=V.send("rasterizeImages",{scope:this.scope,tasks:ee},(de,ve)=>{if(!de)for(const[Le,Te]of ve.entries()){const ke=Object.assign(q.get(Le),{data:Te});q.set(Le,ke)}pe()})}cancelRasterize(){this.rasterizeTask&&this.rasterizeTask.cancel()}}function kt(Ie,V,q,ee,pe){const de=new s.ac(V,{brightness:q,worldview:pe});for(const ve of Ie)ve.recalculate(de,ee)}class zt extends s.E{constructor(V,q,ee,pe,de,ve,Le){super(),this.actor=V,this.layerIndex=q,this.availableImages=ee,this.availableModels=pe,this.loadVectorData=ve||s.aL,this.loading={},this.loaded={},this.deduped=new s.aK(V.scheduler),this.isSpriteLoaded=de,this.scheduler=V.scheduler,this.brightness=Le}loadTile(V,q){const ee=V.uid,pe=V&&V.request,de=pe&&pe.collectResourceTiming,ve=this.loading[ee]=new Ct(V);ve.abort=this.loadVectorData(V,(Le,Te)=>{const ke=!this.loading[ee];if(delete this.loading[ee],ve.cancelRasterize(),ke||Le||!Te)return ve.status="done",ke||(this.loaded[ee]=ve),q(Le);const rt=Te.rawData,Ge={},Et=s.aM(Te.responseHeaders);Et&&Et.expires&&(Ge.expires=Et.expires),Et&&Et.cacheControl&&(Ge.cacheControl=Et.cacheControl),ve.vectorTile=Te.vectorTile||new s.fz(new s.bt(rt));const jt=()=>{ve.parse(ve.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,(bt,li)=>{if(bt||!li)return q(bt);const si={};if(de){const ri=Z(pe);ri.length>0&&(si.resourceTiming=JSON.parse(JSON.stringify(ri)))}q(null,Object.assign({rawTileData:rt.slice(0),responseHeaders:Te.responseHeaders},li,Ge,si))})};this.isSpriteLoaded?jt():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(jt,{type:"parseTile",isSymbolTile:V.isSymbolTile,zoom:V.tileZoom}):jt()}),this.loaded=this.loaded||{},this.loaded[ee]=ve})}reloadTile(V,q){const ee=this.loaded,pe=V.uid;if(ee&&ee[pe]){const de=ee[pe];de.updateParameters(V);const ve=(Le,Te)=>{const ke=de.reloadCallback;ke&&(delete de.reloadCallback,de.parse(de.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,ke)),q(Le,Te)};de.status==="parsing"?de.reloadCallback=ve:de.status==="done"&&(de.vectorTile?de.parse(de.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,ve):ve())}else q(null,void 0)}abortTile(V,q){const ee=V.uid,pe=this.loading[ee];pe&&(pe.abort&&pe.abort(),delete this.loading[ee]),q()}removeTile(V,q){const ee=this.loaded,pe=V.uid;ee&&ee[pe]&&delete ee[pe],q()}}class Zt{loadTile(V,q){const{uid:ee,encoding:pe,rawImageData:de,padding:ve}=V,Le=ImageBitmap&&de instanceof ImageBitmap?this.getImageData(de,ve):de;q(null,new s.fA(ee,Le,pe,ve<1))}reloadTile(V,q){q(null,null)}abortTile(V,q){q()}removeTile(V,q){q()}getImageData(V,q){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(V.width,V.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=V.width,this.offscreenCanvas.height=V.height,this.offscreenCanvasContext.drawImage(V,0,0,V.width,V.height);const ee=this.offscreenCanvasContext.getImageData(-q,-q,V.width+2*q,V.height+2*q);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),ee}}s.bs.setPbf(s.bt);class mn{constructor(V){this._mrt=new s.bs(V.partial?30:1/0),this._isHeaderLoaded=!1,this.uid=V.uid,this.tileID=V.tileID,this.source=V.source}parse(V,q){const ee=this._mrt;this.status="parsing",this._entireBuffer=V;try{ee.parseHeader(V),this._isHeaderLoaded=!0;const pe=[];for(const de in ee.layers){const ve=ee.getLayer(de),Le=ve.getDataRange(ve.getBandList()),Te=ee.createDecodingTask(Le),ke=V.slice(Le.firstByte,Le.lastByte+1),rt=s.bs.performDecoding(ke,Te).then(Ge=>Te.complete(null,Ge)).catch(Ge=>Te.complete(Ge,null));pe.push(rt)}Promise.allSettled(pe).then(()=>q(null,ee)).catch(de=>q(de))}catch(pe){q(pe)}}}class Xt{constructor(V){this.actor=V,this.loading={},this.loaded={}}loadTile(V,q){const ee=V.uid,pe=V.request,de=this.loading[ee]=new mn(V),{cancel:ve}=s.bu(pe,(Le,Te,ke)=>{const rt=!this.loading[ee];if(delete this.loading[ee],rt||Le||!Te)return de.status="done",rt||(this.loaded[ee]=de),q(Le);de.parse(Te,(Ge,Et)=>{if(Ge||!Et)return q(Ge);q(null,Et,ke)}),this.loaded[ee]=de});de.abort=ve}reloadTile(V,q){q(null,void 0)}abortTile(V,q){const ee=V.uid,pe=this.loading[ee];pe&&(pe.abort&&pe.abort(),delete this.loading[ee]),q()}removeTile(V,q){const ee=V.uid;this.loaded[ee]&&delete this.loaded[ee],q()}decodeRasterArray(V,q){s.bs.performDecoding(V.buffer,V.task).then(ee=>q(null,ee)).catch(ee=>q(ee))}}const Mi=s.fB.prototype.toGeoJSON;class or{constructor(V){this._feature=V,this.extent=s.al,this.type=V.type,this.properties=V.tags,"id"in V&&!isNaN(V.id)&&(this.id=parseInt(V.id,10))}loadGeometry(){if(this._feature.type===1){const V=[];for(const q of this._feature.geometry)V.push([new s.P(q[0],q[1])]);return V}{const V=[];for(const q of this._feature.geometry){const ee=[];for(const pe of q)ee.push(new s.P(pe[0],pe[1]));V.push(ee)}return V}}toGeoJSON(V,q,ee){return Mi.call(this,V,q,ee)}}class Ri{constructor(V,q){this.name=V,this.extent=s.al,this.length=q.length,this._jsonFeatures=q}feature(V){return new or(this._jsonFeatures[V])}}class wl{constructor(V){this.layers={},this.extent=s.al;for(const q of Object.keys(V))this.layers[q]=new Ri(q,V[q])}}const pr=64/4096,In=128;class dn{constructor(){this.features=new Map}clear(){this.features.clear()}load(V=[],q){for(const ee of V){const pe=ee.id;if(pe==null)continue;let de=this.features.get(pe);de&&this.updateCache(de,q),ee.geometry?(de=ki(ee),this.updateCache(de,q),this.features.set(pe,de)):this.features.delete(pe),this.updateCache(de,q)}}updateCache(V,q){for(const{canonical:ee,uid:pe}of Object.values(q)){const{z:de,x:ve,y:Le}=ee;$t(V,Math.pow(2,de),ve,Le)&&delete q[pe]}}getTile(V,q,ee){const pe=Math.pow(2,V),de=[];for(const ve of this.features.values())$t(ve,pe,q,ee)&&de.push(gn(ve,pe,q,ee));return{features:de}}getFeatures(){return[...this.features.values()]}}function $t({minX:Ie,minY:V,maxX:q,maxY:ee},pe,de,ve){return Ie<(de+1+pr)/pe&&V<(ve+1+pr)/pe&&q>(de-pr)/pe&&ee>(ve-pr)/pe}function ki(Ie){const{id:V,geometry:q,properties:ee}=Ie;if(!q)return;if(q.type==="GeometryCollection")throw new Error("GeometryCollection not supported in dynamic mode.");const{type:pe,coordinates:de}=q,ve={id:V,type:1,geometry:[],tags:ee,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},Le=ve.geometry;if(pe==="Point")ji(de,Le,ve);else if(pe==="MultiPoint")for(const Te of de)ji(Te,Le,ve);else if(pe==="LineString")ve.type=2,On(de,Le,ve);else if(pe==="MultiLineString")ve.type=2,Un(de,Le,ve);else if(pe==="Polygon")ve.type=3,Un(de,Le,ve,!0);else{if(pe!=="MultiPolygon")throw new Error("Input data is not a valid GeoJSON object.");ve.type=3;for(const Te of de)Un(Te,Le,ve,!0)}return ve}function ji([Ie,V],q,ee){const pe=s.aF(Ie);let de=s.aJ(V);de=de<0?0:de>1?1:de,q.push(pe,de),ee.minX=Math.min(ee.minX,pe),ee.minY=Math.min(ee.minY,de),ee.maxX=Math.max(ee.maxX,pe),ee.maxY=Math.max(ee.maxY,de)}function On(Ie,V,q,ee=!1,pe=!1){const de=[];for(const ve of Ie)ji(ve,de,q);V.push(de),ee&&function(ve,Le){let Te=0;for(let ke=0,rt=ve.length,Ge=rt-2;ke<rt;Ge=ke,ke+=2)Te+=(ve[ke]-ve[Ge])*(ve[ke+1]+ve[Ge+1]);if(Te>0===Le)for(let ke=0,rt=ve.length;ke<rt/2;ke+=2){const Ge=ve[ke],Et=ve[ke+1];ve[ke]=ve[rt-2-ke],ve[ke+1]=ve[rt-1-ke],ve[rt-2-ke]=Ge,ve[rt-1-ke]=Et}}(de,pe)}function Un(Ie,V,q,ee=!1){for(let pe=0;pe<Ie.length;pe++)On(Ie[pe],V,q,ee,pe===0)}function gn(Ie,V,q,ee){const{id:pe,type:de,geometry:ve,tags:Le}=Ie,Te=[];if(de===1)(function(ke,rt,Ge,Et,jt){for(let bt=0;bt<ke.length;bt+=2){const li=Math.round(s.al*(ke[bt+0]*rt-Ge)),si=Math.round(s.al*(ke[bt+1]*rt-Et));jt.push([li,si])}})(ve,V,q,ee,Te);else if(de===2)for(const ke of ve)Er(ke,V,q,ee,Te);else if(de===3)for(const ke of ve)ja(ke,V,q,ee,Te);return{id:pe,type:de,geometry:Te,tags:Le}}function Er(Ie,V,q,ee,pe){const de=-In,ve=s.al+In;let Le;for(let Te=0;Te<Ie.length-2;Te+=2){let ke=Math.round(s.al*(Ie[Te+0]*V-q)),rt=Math.round(s.al*(Ie[Te+1]*V-ee)),Ge=Math.round(s.al*(Ie[Te+2]*V-q)),Et=Math.round(s.al*(Ie[Te+3]*V-ee));const jt=Ge-ke,bt=Et-rt;ke<de&&Ge<de||(ke<de?(rt+=Math.round(bt*((de-ke)/jt)),ke=de):Ge<de&&(Et=rt+Math.round(bt*((de-ke)/jt)),Ge=de),rt<de&&Et<de||(rt<de?(ke+=Math.round(jt*((de-rt)/bt)),rt=de):Et<de&&(Ge=ke+Math.round(jt*((de-rt)/bt)),Et=de),ke>=ve&&Ge>=ve||(ke>=ve?(rt+=Math.round(bt*((ve-ke)/jt)),ke=ve):Ge>=ve&&(Et=rt+Math.round(bt*((ve-ke)/jt)),Ge=ve),rt>=ve&&Et>=ve||(rt>=ve?(ke+=Math.round(jt*((ve-rt)/bt)),rt=ve):Et>=ve&&(Ge=ke+Math.round(jt*((ve-rt)/bt)),Et=ve),Le&&ke===Le[Le.length-1][0]&&rt===Le[Le.length-1][1]||(Le=[[ke,rt]],pe.push(Le)),Le.push([Ge,Et])))))}}function ja(Ie,V,q,ee,pe){const de=(q-pr)/V,ve=(ee-pr)/V,Le=(q+1+pr)/V,Te=(ee+1+pr)/V;function ke(Et,jt){let bt=0;return Et<de?bt|=1:Et>Le&&(bt|=2),jt<ve?bt|=4:jt>Te&&(bt|=8),bt}let rt=[];for(let Et=1;Et<=8;Et*=2){let jt=Ie[Ie.length-2],bt=Ie[Ie.length-1],li=!(ke(jt,bt)&Et);for(let si=0;si<Ie.length;si+=2){const ri=Ie[si],Ii=Ie[si+1],Fn=!(ke(ri,Ii)&Et);Fn!==li&&(8&Et?rt.push(jt+(ri-jt)*(Te-bt)/(Ii-bt),Te):4&Et?rt.push(jt+(ri-jt)*(ve-bt)/(Ii-bt),ve):2&Et?rt.push(Le,bt+(Ii-bt)*(Le-jt)/(ri-jt)):1&Et&&rt.push(de,bt+(Ii-bt)*(de-jt)/(ri-jt))),Fn&&rt.push(ri,Ii),jt=ri,bt=Ii,li=Fn}if(!(Ie=rt).length||Et===8)break;rt=[]}const Ge=[];for(let Et=0;Et<rt.length;Et+=2)Ge.push([Math.round(s.al*(rt[Et]*V-q)),Math.round(s.al*(rt[Et+1]*V-ee))]);pe.push(Ge)}function Lo({name:Ie,features:V},q){q.writeStringField(1,Ie),q.writeVarintField(5,s.al);const ee=new Map,pe=new Map,de={keys:ee,values:pe,feature:null};for(const ve of V)de.feature=ve,q.writeMessage(2,ia,de);for(const ve of ee.keys())q.writeStringField(3,ve);for(const ve of pe.keys())q.writeMessage(4,bl,ve)}function ia(Ie,V){const q=Ie.feature;q.id!==void 0&&Number.isSafeInteger(+q.id)&&V.writeVarintField(1,+q.id),q.tags&&V.writeMessage(2,Ua,Ie),V.writeVarintField(3,q.type),V.writeMessage(4,jr,q)}function Ua({keys:Ie,values:V,feature:q},ee){for(const pe of Object.keys(q.tags)){let de=q.tags[pe];if(de===null)continue;let ve=Ie.get(pe);ve===void 0&&(ve=Ie.size,Ie.set(pe,ve)),ee.writeVarint(ve);const Le=typeof de;Le!=="string"&&Le!=="boolean"&&Le!=="number"&&(de=JSON.stringify(de));let Te=V.get(de);Te===void 0&&(Te=V.size,V.set(de,Te)),ee.writeVarint(Te)}}function yn(Ie,V){return(V<<3)+(7&Ie)}function qn(Ie){return Ie<<1^Ie>>31}function jr(Ie,V){const{geometry:q,type:ee}=Ie;let pe=0,de=0;if(ee===1){V.writeVarint(yn(1,q.length));for(const ve of q){const Le=ve[0]-pe,Te=ve[1]-de;V.writeVarint(qn(Le)),V.writeVarint(qn(Te)),pe+=Le,de+=Te}}else for(const ve of q){V.writeVarint(yn(1,1));const Le=ve.length-(ee===3?1:0);for(let Te=0;Te<Le;Te++){Te===1&&V.writeVarint(yn(2,Le-1));const ke=ve[Te][0]-pe,rt=ve[Te][1]-de;V.writeVarint(qn(ke)),V.writeVarint(qn(rt)),pe+=ke,de+=rt}ee===3&&V.writeVarint(yn(7,1))}}function bl(Ie,V){const q=typeof Ie;q==="string"?V.writeStringField(1,Ie):q==="boolean"?V.writeBooleanField(7,Ie):q==="number"&&(Ie%1!=0?V.writeDoubleField(3,Ie):Ie<0?V.writeSVarintField(6,Ie):V.writeVarintField(5,Ie))}const Kn={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:Ie=>Ie},Va=Math.fround||($a=new Float32Array(1),Ie=>($a[0]=+Ie,$a[0]));var $a;const Eo=3,Xr=5,Qn=6;class hp{constructor(V){this.options=Object.assign(Object.create(Kn),V),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(V){const{log:q,minZoom:ee,maxZoom:pe}=this.options;q&&console.time("total time");const de=`prepare ${V.length} points`;q&&console.time(de),this.points=V;const ve=[];for(let Te=0;Te<V.length;Te++){const ke=V[Te];if(!ke.geometry)continue;const[rt,Ge]=ke.geometry.coordinates,Et=Va(Ga(rt)),jt=Va(Ha(Ge));ve.push(Et,jt,1/0,Te,-1,1),this.options.reduce&&ve.push(0)}let Le=this.trees[pe+1]=this._createTree(ve);q&&console.timeEnd(de);for(let Te=pe;Te>=ee;Te--){const ke=+Date.now();Le=this.trees[Te]=this._createTree(this._cluster(Le,Te)),q&&console.log("z%d: %d clusters in %dms",Te,Le.numItems,+Date.now()-ke)}return q&&console.timeEnd("total time"),this}getClusters(V,q){let ee=((V[0]+180)%360+360)%360-180;const pe=Math.max(-90,Math.min(90,V[1]));let de=V[2]===180?180:((V[2]+180)%360+360)%360-180;const ve=Math.max(-90,Math.min(90,V[3]));if(V[2]-V[0]>=360)ee=-180,de=180;else if(ee>de){const Ge=this.getClusters([ee,pe,180,ve],q),Et=this.getClusters([-180,pe,de,ve],q);return Ge.concat(Et)}const Le=this.trees[this._limitZoom(q)],Te=Le.range(Ga(ee),Ha(ve),Ga(de),Ha(pe)),ke=Le.data,rt=[];for(const Ge of Te){const Et=this.stride*Ge;rt.push(ke[Et+Xr]>1?pc(ke,Et,this.clusterProps):this.points[ke[Et+Eo]])}return rt}getChildren(V){const q=this._getOriginId(V),ee=this._getOriginZoom(V),pe="No cluster with the specified id.",de=this.trees[ee];if(!de)throw new Error(pe);const ve=de.data;if(q*this.stride>=ve.length)throw new Error(pe);const Le=this.options.radius/(this.options.extent*Math.pow(2,ee-1)),Te=de.within(ve[q*this.stride],ve[q*this.stride+1],Le),ke=[];for(const rt of Te){const Ge=rt*this.stride;ve[Ge+4]===V&&ke.push(ve[Ge+Xr]>1?pc(ve,Ge,this.clusterProps):this.points[ve[Ge+Eo]])}if(ke.length===0)throw new Error(pe);return ke}getLeaves(V,q,ee){const pe=[];return this._appendLeaves(pe,V,q=q||10,ee=ee||0,0),pe}getTile(V,q,ee){const pe=this.trees[this._limitZoom(V)],de=Math.pow(2,V),{extent:ve,radius:Le}=this.options,Te=Le/ve,ke=(ee-Te)/de,rt=(ee+1+Te)/de,Ge={features:[]};return this._addTileFeatures(pe.range((q-Te)/de,ke,(q+1+Te)/de,rt),pe.data,q,ee,de,Ge),q===0&&this._addTileFeatures(pe.range(1-Te/de,ke,1,rt),pe.data,de,ee,de,Ge),q===de-1&&this._addTileFeatures(pe.range(0,ke,Te/de,rt),pe.data,-1,ee,de,Ge),Ge.features.length?Ge:null}getClusterExpansionZoom(V){let q=this._getOriginZoom(V)-1;for(;q<=this.options.maxZoom;){const ee=this.getChildren(V);if(q++,ee.length!==1)break;V=ee[0].properties.cluster_id}return q}_appendLeaves(V,q,ee,pe,de){const ve=this.getChildren(q);for(const Le of ve){const Te=Le.properties;if(Te&&Te.cluster?de+Te.point_count<=pe?de+=Te.point_count:de=this._appendLeaves(V,Te.cluster_id,ee,pe,de):de<pe?de++:V.push(Le),V.length===ee)break}return de}_createTree(V){const q=new s.c4(V.length/this.stride|0,this.options.nodeSize,Float32Array);for(let ee=0;ee<V.length;ee+=this.stride)q.add(V[ee],V[ee+1]);return q.finish(),q.data=V,q}_addTileFeatures(V,q,ee,pe,de,ve){for(const Le of V){const Te=Le*this.stride,ke=q[Te+Xr]>1;let rt,Ge,Et;if(ke)rt=Tl(q,Te,this.clusterProps),Ge=q[Te],Et=q[Te+1];else{const li=this.points[q[Te+Eo]];rt=li.properties;const[si,ri]=li.geometry.coordinates;Ge=Ga(si),Et=Ha(ri)}const jt={type:1,geometry:[[Math.round(this.options.extent*(Ge*de-ee)),Math.round(this.options.extent*(Et*de-pe))]],tags:rt};let bt;bt=ke||this.options.generateId?q[Te+Eo]:this.points[q[Te+Eo]].id,bt!==void 0&&(jt.id=bt),ve.features.push(jt)}}_limitZoom(V){return Math.max(this.options.minZoom,Math.min(Math.floor(+V),this.options.maxZoom+1))}_cluster(V,q){const{radius:ee,extent:pe,reduce:de,minPoints:ve}=this.options,Le=ee/(pe*Math.pow(2,q)),Te=V.data,ke=[],rt=this.stride;for(let Ge=0;Ge<Te.length;Ge+=rt){if(Te[Ge+2]<=q)continue;Te[Ge+2]=q;const Et=Te[Ge],jt=Te[Ge+1],bt=V.within(Te[Ge],Te[Ge+1],Le),li=Te[Ge+Xr];let si=li;for(const ri of bt){const Ii=ri*rt;Te[Ii+2]>q&&(si+=Te[Ii+Xr])}if(si>li&&si>=ve){let ri,Ii=Et*li,Fn=jt*li,er=-1;const Vn=(Ge/rt<<5)+(q+1)+this.points.length;for(const rr of bt){const kn=rr*rt;if(Te[kn+2]<=q)continue;Te[kn+2]=q;const Li=Te[kn+Xr];Ii+=Te[kn]*Li,Fn+=Te[kn+1]*Li,Te[kn+4]=Vn,de&&(ri||(ri=this._map(Te,Ge,!0),er=this.clusterProps.length,this.clusterProps.push(ri)),de(ri,this._map(Te,kn)))}Te[Ge+4]=Vn,ke.push(Ii/si,Fn/si,1/0,Vn,-1,si),de&&ke.push(er)}else{for(let ri=0;ri<rt;ri++)ke.push(Te[Ge+ri]);if(si>1)for(const ri of bt){const Ii=ri*rt;if(!(Te[Ii+2]<=q)){Te[Ii+2]=q;for(let Fn=0;Fn<rt;Fn++)ke.push(Te[Ii+Fn])}}}}return ke}_getOriginId(V){return V-this.points.length>>5}_getOriginZoom(V){return(V-this.points.length)%32}_map(V,q,ee){if(V[q+Xr]>1){const ve=this.clusterProps[V[q+Qn]];return ee?Object.assign({},ve):ve}const pe=this.points[V[q+Eo]].properties,de=this.options.map(pe);return ee&&de===pe?Object.assign({},de):de}}function pc(Ie,V,q){return{type:"Feature",id:Ie[V+Eo],properties:Tl(Ie,V,q),geometry:{type:"Point",coordinates:[(ee=Ie[V],360*(ee-.5)),Ur(Ie[V+1])]}};var ee}function Tl(Ie,V,q){const ee=Ie[V+Xr],pe=ee>=1e4?`${Math.round(ee/1e3)}k`:ee>=1e3?Math.round(ee/100)/10+"k":ee,de=Ie[V+Qn],ve=de===-1?{}:Object.assign({},q[de]);return Object.assign(ve,{cluster:!0,cluster_id:Ie[V+Eo],point_count:ee,point_count_abbreviated:pe})}function Ga(Ie){return Ie/360+.5}function Ha(Ie){const V=Math.sin(Ie*Math.PI/180),q=.5-.25*Math.log((1+V)/(1-V))/Math.PI;return q<0?0:q>1?1:q}function Ur(Ie){const V=(180-360*Ie)*Math.PI/180;return 360*Math.atan(Math.exp(V))/Math.PI-90}function na(Ie,V,q,ee){let pe=ee;const de=V+(q-V>>1);let ve,Le=q-V;const Te=Ie[V],ke=Ie[V+1],rt=Ie[q],Ge=Ie[q+1];for(let Et=V+3;Et<q;Et+=3){const jt=mc(Ie[Et],Ie[Et+1],Te,ke,rt,Ge);if(jt>pe)ve=Et,pe=jt;else if(jt===pe){const bt=Math.abs(Et-de);bt<Le&&(ve=Et,Le=bt)}}pe>ee&&(ve-V>3&&na(Ie,V,ve,ee),Ie[ve+2]=pe,q-ve>3&&na(Ie,ve,q,ee))}function mc(Ie,V,q,ee,pe,de){let ve=pe-q,Le=de-ee;if(ve!==0||Le!==0){const Te=((Ie-q)*ve+(V-ee)*Le)/(ve*ve+Le*Le);Te>1?(q=pe,ee=de):Te>0&&(q+=ve*Te,ee+=Le*Te)}return ve=Ie-q,Le=V-ee,ve*ve+Le*Le}function hs(Ie,V,q,ee){const pe={id:Ie??null,type:V,geometry:q,tags:ee,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(V==="Point"||V==="MultiPoint"||V==="LineString")ra(pe,q);else if(V==="Polygon")ra(pe,q[0]);else if(V==="MultiLineString")for(const de of q)ra(pe,de);else if(V==="MultiPolygon")for(const de of q)ra(pe,de[0]);return pe}function ra(Ie,V){for(let q=0;q<V.length;q+=3)Ie.minX=Math.min(Ie.minX,V[q]),Ie.minY=Math.min(Ie.minY,V[q+1]),Ie.maxX=Math.max(Ie.maxX,V[q]),Ie.maxY=Math.max(Ie.maxY,V[q+1])}function no(Ie,V,q,ee){if(!V.geometry)return;const pe=V.geometry.coordinates;if(pe&&pe.length===0)return;const de=V.geometry.type,ve=Math.pow(q.tolerance/((1<<q.maxZoom)*q.extent),2);let Le=[],Te=V.id;if(q.promoteId?Te=V.properties[q.promoteId]:q.generateId&&(Te=ee||0),de==="Point")Sl(pe,Le);else if(de==="MultiPoint")for(const ke of pe)Sl(ke,Le);else if(de==="LineString")El(pe,Le,ve,!1);else if(de==="MultiLineString"){if(q.lineMetrics){for(const ke of pe)Le=[],El(ke,Le,ve,!1),Ie.push(hs(Te,"LineString",Le,V.properties));return}Il(pe,Le,ve,!1)}else if(de==="Polygon")Il(pe,Le,ve,!0);else{if(de!=="MultiPolygon"){if(de==="GeometryCollection"){for(const ke of V.geometry.geometries)no(Ie,{id:Te,geometry:ke,properties:V.properties},q,ee);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const ke of pe){const rt=[];Il(ke,rt,ve,!0),Le.push(rt)}}Ie.push(hs(Te,de,Le,V.properties))}function Sl(Ie,V){V.push(_c(Ie[0]),Ir(Ie[1]),0)}function El(Ie,V,q,ee){let pe,de,ve=0;for(let Te=0;Te<Ie.length;Te++){const ke=_c(Ie[Te][0]),rt=Ir(Ie[Te][1]);V.push(ke,rt,0),Te>0&&(ve+=ee?(pe*rt-ke*de)/2:Math.sqrt(Math.pow(ke-pe,2)+Math.pow(rt-de,2))),pe=ke,de=rt}const Le=V.length-3;V[2]=1,na(V,0,Le,q),V[Le+2]=1,V.size=Math.abs(ve),V.start=0,V.end=V.size}function Il(Ie,V,q,ee){for(let pe=0;pe<Ie.length;pe++){const de=[];El(Ie[pe],de,q,ee),V.push(de)}}function _c(Ie){return Ie/360+.5}function Ir(Ie){const V=Math.sin(Ie*Math.PI/180),q=.5-.25*Math.log((1+V)/(1-V))/Math.PI;return q<0?0:q>1?1:q}function po(Ie,V,q,ee,pe,de,ve,Le){if(ee/=V,de>=(q/=V)&&ve<ee)return Ie;if(ve<q||de>=ee)return null;const Te=[];for(const ke of Ie){const rt=ke.geometry;let Ge=ke.type;const Et=pe===0?ke.minX:ke.minY,jt=pe===0?ke.maxX:ke.maxY;if(Et>=q&&jt<ee){Te.push(ke);continue}if(jt<q||Et>=ee)continue;let bt=[];if(Ge==="Point"||Ge==="MultiPoint")wu(rt,bt,q,ee,pe);else if(Ge==="LineString")qa(rt,bt,q,ee,pe,!1,Le.lineMetrics);else if(Ge==="MultiLineString")oa(rt,bt,q,ee,pe,!1);else if(Ge==="Polygon")oa(rt,bt,q,ee,pe,!0);else if(Ge==="MultiPolygon")for(const li of rt){const si=[];oa(li,si,q,ee,pe,!0),si.length&&bt.push(si)}if(bt.length){if(Le.lineMetrics&&Ge==="LineString"){for(const li of bt)Te.push(hs(ke.id,Ge,li,ke.tags));continue}Ge!=="LineString"&&Ge!=="MultiLineString"||(bt.length===1?(Ge="LineString",bt=bt[0]):Ge="MultiLineString"),Ge!=="Point"&&Ge!=="MultiPoint"||(Ge=bt.length===3?"Point":"MultiPoint"),Te.push(hs(ke.id,Ge,bt,ke.tags))}}return Te.length?Te:null}function wu(Ie,V,q,ee,pe){for(let de=0;de<Ie.length;de+=3){const ve=Ie[de+pe];ve>=q&&ve<=ee&&ds(V,Ie[de],Ie[de+1],Ie[de+2])}}function qa(Ie,V,q,ee,pe,de,ve){let Le=Ls(Ie);const Te=pe===0?bu:Al;let ke,rt,Ge=Ie.start;for(let si=0;si<Ie.length-3;si+=3){const ri=Ie[si],Ii=Ie[si+1],Fn=Ie[si+2],er=Ie[si+3],Vn=Ie[si+4],rr=pe===0?ri:Ii,kn=pe===0?er:Vn;let Li=!1;ve&&(ke=Math.sqrt(Math.pow(ri-er,2)+Math.pow(Ii-Vn,2))),rr<q?kn>q&&(rt=Te(Le,ri,Ii,er,Vn,q),ve&&(Le.start=Ge+ke*rt)):rr>ee?kn<ee&&(rt=Te(Le,ri,Ii,er,Vn,ee),ve&&(Le.start=Ge+ke*rt)):ds(Le,ri,Ii,Fn),kn<q&&rr>=q&&(rt=Te(Le,ri,Ii,er,Vn,q),Li=!0),kn>ee&&rr<=ee&&(rt=Te(Le,ri,Ii,er,Vn,ee),Li=!0),!de&&Li&&(ve&&(Le.end=Ge+ke*rt),V.push(Le),Le=Ls(Ie)),ve&&(Ge+=ke)}let Et=Ie.length-3;const jt=Ie[Et],bt=Ie[Et+1],li=pe===0?jt:bt;li>=q&&li<=ee&&ds(Le,jt,bt,Ie[Et+2]),Et=Le.length-3,de&&Et>=3&&(Le[Et]!==Le[0]||Le[Et+1]!==Le[1])&&ds(Le,Le[0],Le[1],Le[2]),Le.length&&V.push(Le)}function Ls(Ie){const V=[];return V.size=Ie.size,V.start=Ie.start,V.end=Ie.end,V}function oa(Ie,V,q,ee,pe,de){for(const ve of Ie)qa(ve,V,q,ee,pe,de,!1)}function ds(Ie,V,q,ee){Ie.push(V,q,ee)}function bu(Ie,V,q,ee,pe,de){const ve=(de-V)/(ee-V);return ds(Ie,de,q+(pe-q)*ve,1),ve}function Al(Ie,V,q,ee,pe,de){const ve=(de-q)/(pe-q);return ds(Ie,V+(ee-V)*ve,de,1),ve}function Rn(Ie,V){const q=[];for(let ee=0;ee<Ie.length;ee++){const pe=Ie[ee],de=pe.type;let ve;if(de==="Point"||de==="MultiPoint"||de==="LineString")ve=Lr(pe.geometry,V);else if(de==="MultiLineString"||de==="Polygon"){ve=[];for(const Le of pe.geometry)ve.push(Lr(Le,V))}else if(de==="MultiPolygon"){ve=[];for(const Le of pe.geometry){const Te=[];for(const ke of Le)Te.push(Lr(ke,V));ve.push(Te)}}q.push(hs(pe.id,de,ve,pe.tags))}return q}function Lr(Ie,V){const q=[];q.size=Ie.size,Ie.start!==void 0&&(q.start=Ie.start,q.end=Ie.end);for(let ee=0;ee<Ie.length;ee+=3)q.push(Ie[ee]+V,Ie[ee+1],Ie[ee+2]);return q}function Fh(Ie,V){if(Ie.transformed)return Ie;const q=1<<Ie.z,ee=Ie.x,pe=Ie.y;for(const de of Ie.features){const ve=de.geometry,Le=de.type;if(de.geometry=[],Le===1)for(let Te=0;Te<ve.length;Te+=2)de.geometry.push(Cl(ve[Te],ve[Te+1],V,q,ee,pe));else for(let Te=0;Te<ve.length;Te++){const ke=[];for(let rt=0;rt<ve[Te].length;rt+=2)ke.push(Cl(ve[Te][rt],ve[Te][rt+1],V,q,ee,pe));de.geometry.push(ke)}}return Ie.transformed=!0,Ie}function Cl(Ie,V,q,ee,pe,de){return[Math.round(q*(Ie*ee-pe)),Math.round(q*(V*ee-de))]}function fs(Ie,V,q,ee,pe){const de=V===pe.maxZoom?0:pe.tolerance/((1<<V)*pe.extent),ve={features:[],numPoints:0,numSimplified:0,numFeatures:Ie.length,source:null,x:q,y:ee,z:V,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const Le of Ie)Bh(ve,Le,de,pe);return ve}function Bh(Ie,V,q,ee){const pe=V.geometry,de=V.type,ve=[];if(Ie.minX=Math.min(Ie.minX,V.minX),Ie.minY=Math.min(Ie.minY,V.minY),Ie.maxX=Math.max(Ie.maxX,V.maxX),Ie.maxY=Math.max(Ie.maxY,V.maxY),de==="Point"||de==="MultiPoint")for(let Le=0;Le<pe.length;Le+=3)ve.push(pe[Le],pe[Le+1]),Ie.numPoints++,Ie.numSimplified++;else if(de==="LineString")et(ve,pe,Ie,q,!1,!1);else if(de==="MultiLineString"||de==="Polygon")for(let Le=0;Le<pe.length;Le++)et(ve,pe[Le],Ie,q,de==="Polygon",Le===0);else if(de==="MultiPolygon")for(let Le=0;Le<pe.length;Le++){const Te=pe[Le];for(let ke=0;ke<Te.length;ke++)et(ve,Te[ke],Ie,q,!0,ke===0)}if(ve.length){let Le=V.tags||null;if(de==="LineString"&&ee.lineMetrics){Le={};for(const ke in V.tags)Le[ke]=V.tags[ke];Le.mapbox_clip_start=pe.start/pe.size,Le.mapbox_clip_end=pe.end/pe.size}const Te={geometry:ve,type:de==="Polygon"||de==="MultiPolygon"?3:de==="LineString"||de==="MultiLineString"?2:1,tags:Le};V.id!==null&&(Te.id=V.id),Ie.features.push(Te)}}function et(Ie,V,q,ee,pe,de){const ve=ee*ee;if(ee>0&&V.size<(pe?ve:ee))return void(q.numPoints+=V.length/3);const Le=[];for(let Te=0;Te<V.length;Te+=3)(ee===0||V[Te+2]>ve)&&(q.numSimplified++,Le.push(V[Te],V[Te+1])),q.numPoints++;pe&&function(Te,ke){let rt=0;for(let Ge=0,Et=Te.length,jt=Et-2;Ge<Et;jt=Ge,Ge+=2)rt+=(Te[Ge]-Te[jt])*(Te[Ge+1]+Te[jt+1]);if(rt>0===ke)for(let Ge=0,Et=Te.length;Ge<Et/2;Ge+=2){const jt=Te[Ge],bt=Te[Ge+1];Te[Ge]=Te[Et-2-Ge],Te[Ge+1]=Te[Et-1-Ge],Te[Et-2-Ge]=jt,Te[Et-1-Ge]=bt}}(Le,de),Ie.push(Le)}const sa={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class dp{constructor(V,q){const ee=(q=this.options=function(de,ve){for(const Le in ve)de[Le]=ve[Le];return de}(Object.create(sa),q)).debug;if(ee&&console.time("preprocess data"),q.maxZoom<0||q.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(q.promoteId&&q.generateId)throw new Error("promoteId and generateId cannot be used together.");let pe=function(de,ve){const Le=[];if(de.type==="FeatureCollection")for(let Te=0;Te<de.features.length;Te++)no(Le,de.features[Te],ve,Te);else no(Le,de.type==="Feature"?de:{geometry:de},ve);return Le}(V,q);this.tiles={},this.tileCoords=[],ee&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",q.indexMaxZoom,q.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),pe=function(de,ve){const Le=ve.buffer/ve.extent;let Te=de;const ke=po(de,1,-1-Le,Le,0,-1,2,ve),rt=po(de,1,1-Le,2+Le,0,-1,2,ve);return(ke||rt)&&(Te=po(de,1,-Le,1+Le,0,-1,2,ve)||[],ke&&(Te=Rn(ke,1).concat(Te)),rt&&(Te=Te.concat(Rn(rt,-1)))),Te}(pe,q),pe.length&&this.splitTile(pe,0,0,0),ee&&(pe.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(V,q,ee,pe,de,ve,Le){const Te=[V,q,ee,pe],ke=this.options,rt=ke.debug;for(;Te.length;){pe=Te.pop(),ee=Te.pop(),q=Te.pop(),V=Te.pop();const Ge=1<<q,Et=Pl(q,ee,pe);let jt=this.tiles[Et];if(!jt&&(rt>1&&console.time("creation"),jt=this.tiles[Et]=fs(V,q,ee,pe,ke),this.tileCoords.push({z:q,x:ee,y:pe}),rt)){rt>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",q,ee,pe,jt.numFeatures,jt.numPoints,jt.numSimplified),console.timeEnd("creation"));const Li=`z${q}`;this.stats[Li]=(this.stats[Li]||0)+1,this.total++}if(jt.source=V,de==null){if(q===ke.indexMaxZoom||jt.numPoints<=ke.indexMaxPoints)continue}else{if(q===ke.maxZoom||q===de)continue;if(de!=null){const Li=de-q;if(ee!==ve>>Li||pe!==Le>>Li)continue}}if(jt.source=null,V.length===0)continue;rt>1&&console.time("clipping");const bt=.5*ke.buffer/ke.extent,li=.5-bt,si=.5+bt,ri=1+bt;let Ii=null,Fn=null,er=null,Vn=null,rr=po(V,Ge,ee-bt,ee+si,0,jt.minX,jt.maxX,ke),kn=po(V,Ge,ee+li,ee+ri,0,jt.minX,jt.maxX,ke);V=null,rr&&(Ii=po(rr,Ge,pe-bt,pe+si,1,jt.minY,jt.maxY,ke),Fn=po(rr,Ge,pe+li,pe+ri,1,jt.minY,jt.maxY,ke),rr=null),kn&&(er=po(kn,Ge,pe-bt,pe+si,1,jt.minY,jt.maxY,ke),Vn=po(kn,Ge,pe+li,pe+ri,1,jt.minY,jt.maxY,ke),kn=null),rt>1&&console.timeEnd("clipping"),Te.push(Ii||[],q+1,2*ee,2*pe),Te.push(Fn||[],q+1,2*ee,2*pe+1),Te.push(er||[],q+1,2*ee+1,2*pe),Te.push(Vn||[],q+1,2*ee+1,2*pe+1)}}getTile(V,q,ee){V=+V,q=+q,ee=+ee;const pe=this.options,{extent:de,debug:ve}=pe;if(V<0||V>24)return null;const Le=1<<V,Te=Pl(V,q=q+Le&Le-1,ee);if(this.tiles[Te])return Fh(this.tiles[Te],de);ve>1&&console.log("drilling down to z%d-%d-%d",V,q,ee);let ke,rt=V,Ge=q,Et=ee;for(;!ke&&rt>0;)rt--,Ge>>=1,Et>>=1,ke=this.tiles[Pl(rt,Ge,Et)];return ke&&ke.source?(ve>1&&(console.log("found parent tile z%d-%d-%d",rt,Ge,Et),console.time("drilling down")),this.splitTile(ke.source,rt,Ge,Et,V,q,ee),ve>1&&console.timeEnd("drilling down"),this.tiles[Te]?Fh(this.tiles[Te],de):null):null}}function Pl(Ie,V,q){return 32*((1<<Ie)*q+V)+Ie}function Oi(Ie,V){const q=Ie.tileID.canonical;if(!this._geoJSONIndex)return void V(null,null);const ee=this._geoJSONIndex.getTile(q.z,q.x,q.y);if(!ee)return void V(null,null);const pe=ke=>ke.tags&&"3d_elevation_id"in ke.tags&&"source"in ke.tags&&ke.tags.source==="elevation",de=ee.features.filter(ke=>pe(ke));let ve={_geojsonTileLayer:ee.features};de.length>0&&(ve={_geojsonTileLayer:ee.features.filter(ke=>!pe(ke)),hd_road_elevation:de});const Le=new wl(ve),Te=function(ke){const rt=new s.bt;for(const Ge of Object.keys(ke))rt.writeMessage(3,Lo,{name:Ge,features:ke[Ge]});return rt.finish()}(ve).buffer;V(null,{vectorTile:Le,rawData:Te})}class Kr extends zt{constructor(V,q,ee,pe,de,ve,Le){super(V,q,ee,pe,de,Oi,Le),ve&&(this.loadGeoJSON=ve),this._dynamicIndex=new dn}loadData(V,q){const ee=V&&V.request,pe=ee&&ee.collectResourceTiming;this._geoJSONIndex=null,this.loadGeoJSON(V,(de,ve)=>{if(de||!ve)return q(de);if(typeof ve!="object")return q(new Error(`Input data given to '${V.source}' is not a valid GeoJSON object.`));{try{if(V.filter){const Te=s.U(V.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(Te.result==="error")throw new Error(Te.value.map(ke=>`${ke.key}: ${ke.message}`).join(", "));ve.features=ve.features.filter(ke=>Te.value.evaluate({zoom:0},ke))}V.dynamic?(ve.type==="Feature"&&(ve={type:"FeatureCollection",features:[ve]}),V.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(ve.features,this.loaded),V.cluster&&(ve.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=V.cluster?new hp(function({superclusterOptions:Te,clusterProperties:ke}){if(!ke||!Te)return Te;const rt={},Ge={},Et={accumulated:null,zoom:0},jt={properties:null},bt=Object.keys(ke);for(const li of bt){const[si,ri]=ke[li],Ii=s.U(ri),Fn=s.U(typeof si=="string"?[si,["accumulated"],["get",li]]:si);rt[li]=Ii.value,Ge[li]=Fn.value}return Te.map=li=>{jt.properties=li;const si={};for(const ri of bt)si[ri]=rt[ri].evaluate(Et,jt);return si},Te.reduce=(li,si)=>{jt.properties=si;for(const ri of bt)Et.accumulated=li[ri],li[ri]=Ge[ri].evaluate(Et,jt)},Te}(V)).load(ve.features):V.dynamic?this._dynamicIndex:function(Te,ke){return new dp(Te,ke)}(ve,V.geojsonVtOptions)}catch(Te){return q(Te)}const Le={};if(pe){const Te=Z(ee);Te&&(Le.resourceTiming={},Le.resourceTiming[V.source]=JSON.parse(JSON.stringify(Te)))}q(null,Le)}})}reloadTile(V,q){const ee=this.loaded;return ee&&ee[V.uid]?V.partial?q(null,void 0):super.reloadTile(V,q):this.loadTile(V,q)}loadGeoJSON(V,q){if(V.request)s.m(V.request,q);else{if(typeof V.data!="string")return q(new Error(`Input data given to '${V.source}' is not a valid GeoJSON object.`));setTimeout(()=>{try{return q(null,JSON.parse(V.data))}catch{return q(new Error(`Input data given to '${V.source}' is not a valid GeoJSON object.`))}},0)}}getClusterExpansionZoom(V,q){try{q(null,this._geoJSONIndex.getClusterExpansionZoom(V.clusterId))}catch(ee){q(ee)}}getClusterChildren(V,q){try{q(null,this._geoJSONIndex.getChildren(V.clusterId))}catch(ee){q(ee)}}getClusterLeaves(V,q){try{q(null,this._geoJSONIndex.getLeaves(V.clusterId,V.limit,V.offset))}catch(ee){q(ee)}}}class fp{constructor(V,q,ee){this.tileID=new s.aQ(V.tileID.overscaledZ,V.tileID.wrap,V.tileID.canonical.z,V.tileID.canonical.x,V.tileID.canonical.y),this.tileZoom=V.tileZoom,this.uid=V.uid,this.zoom=V.zoom,this.canonical=V.tileID.canonical,this.pixelRatio=V.pixelRatio,this.tileSize=V.tileSize,this.source=V.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=V.projection,this.brightness=q,this.worldview=ee}parse(V,q,ee,pe){this.status="parsing";const de=new s.aQ(ee.tileID.overscaledZ,ee.tileID.wrap,ee.tileID.canonical.z,ee.tileID.canonical.x,ee.tileID.canonical.y),ve=[],Le=q.familiesBySource[ee.source],Te=new s.fn(de,ee.promoteId);Te.bucketLayerIDs=[],Te.is3DTile=!0,s.fC(V).then(ke=>{if(!ke)return pe(new Error("Could not parse tile"));const rt=ke.json.extensionsUsed&&ke.json.extensionsUsed.includes("MAPBOX_mesh_features")||ke.json.asset.extras&&ke.json.asset.extras.MAPBOX_mesh_features,Ge=ke.json.extensionsUsed&&ke.json.extensionsUsed.includes("EXT_meshopt_compression"),Et=new s.ac(this.zoom,{brightness:this.brightness,worldview:this.worldview});for(const jt in Le)for(const bt of Le[jt]){const li=bt[0];Te.bucketLayerIDs.push(bt.map(Ii=>s.B(Ii.id,Ii.scope))),li.recalculate(Et,[]);const si=s.fD(ke,1/s.d7(ee.tileID.canonical)),ri=new s.fE(bt,si,de,rt,Ge,this.brightness,Te,this.worldview);rt||(ri.needsUpload=!0),ve.push(ri),ri.evaluate(li)}this.status="done",pe(null,{buckets:ve,featureIndex:Te,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:null})}).catch(ke=>pe(new Error(ke.message)))}}class Ml{constructor(V,q,ee,pe,de,ve,Le,Te){this.actor=V,this.layerIndex=q,this.availableImages=ee,this.availableModels=pe,this.brightness=Le,this.loading={},this.loaded={},this.worldview=Te}loadTile(V,q){const ee=V.uid,pe=this.loading[ee]=new fp(V,this.brightness,this.worldview);s.bu(V.request,(de,ve)=>{const Le=!this.loading[ee];return delete this.loading[ee],Le||de?(pe.status="done",Le||(this.loaded[ee]=pe),q(de)):ve&&ve.byteLength!==0?void pe.parse(ve,this.layerIndex,V,(Te,ke)=>{pe.status="done",this.loaded=this.loaded||{},this.loaded[ee]=pe,Te||!ke?q(Te):q(null,ke)}):(pe.status="done",this.loaded[ee]=pe,q())})}reloadTile(V,q){const ee=this.loaded,pe=V.uid;if(ee&&ee[pe]){const de=ee[pe];de.projection=V.projection,de.brightness=V.brightness;const ve=(Le,Te)=>{de.reloadCallback&&(delete de.reloadCallback,this.loadTile(V,q)),q(Le,Te)};de.status==="parsing"?de.reloadCallback=ve:de.status==="done"&&this.loadTile(V,q)}}abortTile(V,q){const ee=V.uid;this.loading[ee]&&delete this.loading[ee],q()}removeTile(V,q){const ee=this.loaded,pe=V.uid;ee&&ee[pe]&&delete ee[pe],q()}}class Tu{constructor(V){this.self=V,this.actor=new s.fG(V,this),this.layerIndexes={},this.availableImages={},this.availableModels={},this.isSpriteLoaded={},this.imageRasterizer=new s.x,this.rtlPluginParsingListeners=[],this.projections={},this.defaultProjection=s.cm({name:"mercator"}),this.workerSourceTypes={vector:zt,geojson:Kr,"raster-dem":Zt,"raster-array":Xt,"batched-model":Ml},this.workerSources={},this.self.registerWorkerSource=(q,ee)=>{if(this.workerSourceTypes[q])throw new Error(`Worker source with name "${q}" already registered.`);this.workerSourceTypes[q]=ee},this.self.registerRTLTextPlugin=q=>{if(s.fH.isParsed())throw new Error("RTL text plugin already registered.");s.fH.setState({pluginStatus:s.fI.parsed,pluginURL:s.fH.getPluginURL()}),s.fH.applyArabicShaping=q.applyArabicShaping,s.fH.processBidirectionalText=q.processBidirectionalText,s.fH.processStyledBidirectionalText=q.processStyledBidirectionalText;for(const ee of this.rtlPluginParsingListeners)ee(null,!0);this.rtlPluginParsingListeners=[]}}clearCaches(V,q,ee){delete this.layerIndexes[V],delete this.availableImages[V],delete this.availableModels[V],delete this.workerSources[V],ee()}checkIfReady(V,q,ee){ee()}setReferrer(V,q){this.referrer=q}spriteLoaded(V,q){this.isSpriteLoaded[V]||(this.isSpriteLoaded[V]={});const{scope:ee,isLoaded:pe}=q;if(this.isSpriteLoaded[V][ee]=pe,this.workerSources[V]&&this.workerSources[V][ee])for(const de in this.workerSources[V][ee]){const ve=this.workerSources[V][ee][de];for(const Le in ve){const Te=ve[Le];Te instanceof zt&&(Te.isSpriteLoaded=pe,Te.fire(new s.z("isSpriteLoaded")))}}}setImages(V,q,ee){this.availableImages[V]||(this.availableImages[V]={});const{scope:pe,images:de}=q;if(this.availableImages[V][pe]=de,this.workerSources[V]&&this.workerSources[V][pe]){for(const ve in this.workerSources[V][pe]){const Le=this.workerSources[V][pe][ve];for(const Te in Le)Le[Te].availableImages=de}ee()}else ee()}setModels(V,{scope:q,models:ee},pe){if(this.availableModels[V]||(this.availableModels[V]={}),this.availableModels[V][q]=ee,this.workerSources[V]&&this.workerSources[V][q]){for(const de in this.workerSources[V][q]){const ve=this.workerSources[V][q][de];for(const Le in ve)ve[Le].availableModels=ee}pe()}else pe()}setProjection(V,q){this.projections[V]=s.cm(q)}setBrightness(V,q,ee){this.brightness=q,ee()}setWorldview(V,q,ee){this.worldview=q,ee()}setLayers(V,q,ee){this.getLayerIndex(V,q.scope).replace(q.layers,q.options),ee()}updateLayers(V,q,ee){this.getLayerIndex(V,q.scope).update(q.layers,q.removedIds,q.options),ee()}loadTile(V,q,ee){q.projection=this.projections[V]||this.defaultProjection,this.getWorkerSource(V,q.type,q.source,q.scope).loadTile(q,ee)}decodeRasterArray(V,q,ee){this.getWorkerSource(V,q.type,q.source,q.scope).decodeRasterArray(q,ee)}reloadTile(V,q,ee){q.projection=this.projections[V]||this.defaultProjection,this.getWorkerSource(V,q.type,q.source,q.scope).reloadTile(q,ee)}abortTile(V,q,ee){this.getWorkerSource(V,q.type,q.source,q.scope).abortTile(q,ee)}removeTile(V,q,ee){this.getWorkerSource(V,q.type,q.source,q.scope).removeTile(q,ee)}removeSource(V,q,ee){if(!(this.workerSources[V]&&this.workerSources[V][q.scope]&&this.workerSources[V][q.scope][q.type]&&this.workerSources[V][q.scope][q.type][q.source]))return;const pe=this.workerSources[V][q.scope][q.type][q.source];delete this.workerSources[V][q.scope][q.type][q.source],pe.removeSource!==void 0?pe.removeSource(q,ee):ee()}loadWorkerSource(V,q,ee){try{this.self.importScripts(q.url),ee()}catch(pe){ee(pe)}}syncRTLPluginState(V,q,ee){if(s.fH.isParsed())ee(null,!0);else if(s.fH.isParsing())this.rtlPluginParsingListeners.push(ee);else try{s.fH.setState(q);const pe=s.fH.getPluginURL();!s.fH.isLoaded()||s.fH.isParsed()||s.fH.isParsing()||pe==null||(s.fH.setState({pluginStatus:s.fI.parsing,pluginURL:s.fH.getPluginURL()}),this.self.importScripts(pe),s.fH.isParsed()?ee(null,!0):this.rtlPluginParsingListeners.push(ee))}catch(pe){ee(pe)}}setDracoUrl(V,q){this.dracoUrl=q}getAvailableImages(V,q){this.availableImages[V]||(this.availableImages[V]={});let ee=this.availableImages[V][q];return ee||(ee=[]),ee}getAvailableModels(V,q){this.availableModels[V]||(this.availableModels[V]={});let ee=this.availableModels[V][q];return ee||(ee={}),ee}getLayerIndex(V,q){this.layerIndexes[V]||(this.layerIndexes[V]={});let ee=this.layerIndexes[V][q];return ee||(ee=this.layerIndexes[V][q]=new Ee,ee.scope=q),ee}getWorkerSource(V,q,ee,pe){const de=this.workerSources;return de[V]||(de[V]={}),de[V][pe]||(de[V][pe]={}),de[V][pe][q]||(de[V][pe][q]={}),this.isSpriteLoaded[V]||(this.isSpriteLoaded[V]={}),de[V][pe][q][ee]||(de[V][pe][q][ee]=new this.workerSourceTypes[q]({send:(ve,Le,Te,ke,rt,Ge)=>this.actor.send(ve,Le,Te,V,rt,Ge),scheduler:this.actor.scheduler},this.getLayerIndex(V,pe),this.getAvailableImages(V,pe),this.getAvailableModels(V,pe),this.isSpriteLoaded[V][pe],void 0,this.brightness,this.worldview)),de[V][pe][q][ee]}rasterizeImagesWorker(V,q,ee){const pe=new Map;for(const[de,{image:ve,imageVariant:Le}]of q.tasks.entries()){const Te=this.imageRasterizer.rasterize(Le,ve,q.scope,V);pe.set(de,Te)}ee(void 0,pe)}removeRasterizedImages(V,q,ee){this.imageRasterizer.removeImagesFromCacheByIds(q.imageIds,q.scope,V),ee()}enforceCacheSizeLimit(V,q){s.fJ(q)}getWorkerPerformanceMetrics(V,q,ee){ee(void 0,void 0)}}return s.fF(self)&&(self.worker=new Tu(self)),Tu}),P(["./shared"],function(s){var Z="3.17.0";const Q={create:"create",load:"load",fullLoad:"fullLoad"},me={mark(u){performance.mark(u)},measure(u,t,r){performance.measure(u,t,r)}};function Ee(u){const t=u.name.split("?")[0];return s.a(t)&&t.includes("mapbox-gl.js")?"javascript":s.a(t)&&t.includes("mapbox-gl.css")?"css":s.b(t)?"fontRange":s.c(t)?"sprite":s.i(t)?"style":s.d(t)?"tilejson":"other"}var De,Xe={},mt=function(){if(De)return Xe;function u(h){return!t(h)}function t(h){return typeof window>"u"||typeof document>"u"?"not a browser":function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var g,y,w=new Blob([""],{type:"text/javascript"}),T=URL.createObjectURL(w);try{y=new Worker(T),g=!0}catch{g=!1}return y&&y.terminate(),URL.revokeObjectURL(T),g}()?function(){var g=document.createElement("canvas");g.width=g.height=1;var y=g.getContext("2d");if(!y)return!1;var w=y.getImageData(0,0,1,1);return w&&w.width===g.width}()?(r[p=h&&h.failIfMajorPerformanceCaveat]===void 0&&(r[p]=function(g){var y,w=function(T){var A=document.createElement("canvas"),M=Object.create(u.webGLContextAttributes);return M.failIfMajorPerformanceCaveat=T,A.getContext("webgl2",M)}(g);if(!w)return!1;try{y=w.createShader(w.VERTEX_SHADER)}catch{return!1}return!(!y||w.isContextLost())&&(w.shaderSource(y,"void main() {}"),w.compileShader(y),w.getShaderParameter(y,w.COMPILE_STATUS)===!0)}(p)),r[p]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var p}De=1,Xe.supported=u,Xe.notSupportedReason=t;var r={};return u.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0},Xe}();function We(u,t,r){const h=document.createElement(u);return t!=null&&(h.className=t),r&&r.appendChild(h),h}function ct(u,t,r){const h=document.createElementNS("http://www.w3.org/2000/svg",u);for(const p of Object.keys(t))h.setAttributeNS(null,p,String(t[p]));return r&&r.appendChild(h),h}const Me=typeof document<"u"?document.documentElement&&document.documentElement.style:null,xe=Me&&Me.userSelect!==void 0?"userSelect":"WebkitUserSelect";let Pe;function Ze(){Me&&xe&&(Pe=Me[xe],Me[xe]="none")}function Ct(){Me&&xe&&(Me[xe]=Pe)}function kt(u){u.preventDefault(),u.stopPropagation(),window.removeEventListener("click",kt,!0)}function zt(){window.addEventListener("click",kt,!0),window.setTimeout(()=>{window.removeEventListener("click",kt,!0)},0)}function Zt(u,t){const r=u.getBoundingClientRect();return Mi(u,r,t)}function mn(u,t){const r=u.getBoundingClientRect(),h=[];for(let p=0;p<t.length;p++)h.push(Mi(u,r,t[p]));return h}function Xt(u){return/firefox/i.test(navigator.userAgent)&&/macintosh/i.test(navigator.userAgent)&&u.button===2&&u.ctrlKey?0:u.button}function Mi(u,t,r){const h=u.offsetWidth===t.width?1:u.offsetWidth/t.width;return new s.P((r.clientX-t.left)*h,(r.clientY-t.top)*h)}const or="01",Ri="NO_ACCESS_TOKEN";class wl{constructor(t,r,h){this._transformRequestFn=t,this._customAccessToken=r,this._silenceAuthErrors=!!h,this._createSkuToken()}_createSkuToken(){const t=function(){let r="";for(let h=0;h<10;h++)r+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",or,r].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=t.token,this._skuTokenExpiresAt=t.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(t,r){return this._transformRequestFn&&this._transformRequestFn(t,r)||{url:t}}normalizeStyleURL(t,r){if(!s.h(t))return t;const h=In(t);return h.params.push(`sdk=js-${Z}`),h.path=`/styles/v1${h.path}`,this._makeAPIURL(h,this._customAccessToken||r)}normalizeGlyphsURL(t,r){if(!s.h(t))return t;const h=In(t);return h.path=`/fonts/v1${h.path}`,this._makeAPIURL(h,this._customAccessToken||r)}normalizeModelURL(t,r){if(!s.h(t))return t;const h=In(t);return h.path=`/models/v1${h.path}`,this._makeAPIURL(h,this._customAccessToken||r)}normalizeSourceURL(t,r,h,p){if(!s.h(t))return t;const g=In(t);return g.path=`/v4/${g.authority}.json`,g.params.push("secure"),h&&g.params.push(`language=${h}`),p&&g.params.push(`worldview=${p}`),this._makeAPIURL(g,this._customAccessToken||r)}normalizeIconsetURL(t,r){const h=In(t);return s.h(t)?(h.path=`/styles/v1${h.path}/iconset.pbf`,this._makeAPIURL(h,this._customAccessToken||r)):dn(h)}normalizeSpriteURL(t,r,h,p){const g=In(t);return s.h(t)?(g.path=`/styles/v1${g.path}/sprite${r}${h}`,this._makeAPIURL(g,this._customAccessToken||p)):(g.path+=`${r}${h}`,dn(g))}normalizeTileURL(t,r,h){if(this._isSkuTokenExpired()&&this._createSkuToken(),t&&!s.h(t))return t;const p=In(t);p.path=p.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${r||h&&p.authority!=="raster"&&h===512?"@2x":""}${s.k.supported?".webp":"$1"}`),p.authority==="raster"?p.path=`/${s.e.RASTER_URL_PREFIX}${p.path}`:p.authority==="rasterarrays"?p.path=`/${s.e.RASTERARRAYS_URL_PREFIX}${p.path}`:p.authority==="3dtiles"?p.path=`/${s.e.TILES3D_URL_PREFIX}${p.path}`:(p.path=p.path.replace(/^.+\/v4\//,"/"),p.path=`/${s.e.TILE_URL_VERSION}${p.path}`);const g=this._customAccessToken||function(y){for(const w of y){const T=w.match(/^access_token=(.*)$/);if(T)return T[1]}return null}(p.params)||s.e.ACCESS_TOKEN;return s.e.REQUIRE_ACCESS_TOKEN&&g&&this._skuToken&&p.params.push(`sku=${this._skuToken}`),this._makeAPIURL(p,g)}canonicalizeTileURL(t,r){const h=In(t);if(!h.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!h.path.match(/\.[\w]+$/))return t;let p="mapbox://";h.path.match(/^\/raster\/v1\//)?p+=`raster/${h.path.replace(`/${s.e.RASTER_URL_PREFIX}/`,"")}`:h.path.match(/^\/rasterarrays\/v1\//)?p+=`rasterarrays/${h.path.replace(`/${s.e.RASTERARRAYS_URL_PREFIX}/`,"")}`:p+=`tiles/${h.path.replace(`/${s.e.TILE_URL_VERSION}/`,"")}`;let g=h.params;return r&&(g=g.filter(y=>!y.match(/^access_token=/))),g.length&&(p+=`?${g.join("&")}`),p}canonicalizeTileset(t,r){const h=!!r&&s.h(r),p=[];for(const g of t.tiles||[])s.j(g)?p.push(this.canonicalizeTileURL(g,h)):p.push(g);return p}_makeAPIURL(t,r){const h="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",p=In(s.e.API_URL);if(t.protocol=p.protocol,t.authority=p.authority,t.protocol==="http"){const g=t.params.indexOf("secure");g>=0&&t.params.splice(g,1)}if(p.path!=="/"&&(t.path=`${p.path}${t.path}`),!s.e.REQUIRE_ACCESS_TOKEN)return dn(t);if(r=r||s.e.ACCESS_TOKEN,!this._silenceAuthErrors){if(!r)throw new Error(`An API access token is required to use Mapbox GL. ${h}`);if(r[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${h}`)}return t.params=t.params.filter(g=>g.indexOf("access_token")===-1),t.params.push(`access_token=${r||""}`),dn(t)}}const pr=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function In(u){const t=u.match(pr);if(!t)throw new Error("Unable to parse URL object");return{protocol:t[1],authority:t[2],path:t[3]||"/",params:t[4]?t[4].split("&"):[]}}function dn(u){const t=u.params.length?`?${u.params.join("&")}`:"";return`${u.protocol}://${u.authority}${u.path}${t}`}const $t="mapbox.eventData";function ki(u){if(!u)return null;const t=u.split(".");if(!t||t.length!==3)return null;try{return JSON.parse(s.l(t[1]))}catch{return null}}class ji{constructor(t){this.type=t,this.anonId=null,this.anonIdTimestamp=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(t){const r=ki(s.e.ACCESS_TOKEN);let h="";return h=r&&r.u?s.f(r.u):s.e.ACCESS_TOKEN||"",t?`${$t}.${t}:${h}`:`${$t}:${h}`}fetchEventData(){const t=s.s("localStorage"),r=this.getStorageKey(),h=this.getStorageKey("uuid"),p=this.getStorageKey("uuidTimestamp");if(t)try{const g=localStorage.getItem(r);g&&(this.eventData=JSON.parse(g));const y=localStorage.getItem(h);y&&(this.anonId=y);const w=localStorage.getItem(p);w&&(this.anonIdTimestamp=Number(w));const T=Date.now()-864e5;(!this.anonIdTimestamp||this.anonIdTimestamp<T)&&this.refreshUUID()}catch{s.w("Unable to read from LocalStorage")}}refreshUUID(){this.anonId=s.u(),this.anonIdTimestamp=Date.now()}saveEventData(){const t=s.s("localStorage"),r=this.getStorageKey(),h=this.getStorageKey("uuid"),p=this.getStorageKey("uuidTimestamp"),g=this.anonId,y=this.anonIdTimestamp;if(t&&g)try{localStorage.setItem(h,g),Object.keys(this.eventData).length>=1&&localStorage.setItem(r,JSON.stringify(this.eventData)),y&&localStorage.setItem(p,y.toString())}catch{s.w("Unable to write to LocalStorage")}}processRequests(t){}postEvent(t,r,h,p){if(!s.e.EVENTS_URL)return;const g=In(s.e.EVENTS_URL);g.params.push(`access_token=${p||s.e.ACCESS_TOKEN||""}`);const y={event:this.type,created:new Date(t).toISOString()},w=r?Object.assign(y,r):y,T={url:dn(g),headers:{"Content-Type":"text/plain"},body:JSON.stringify([w])};this.pendingRequest=s.p(T,A=>{this.pendingRequest=null,h(A),this.saveEventData(),this.processRequests(p)})}queueRequest(t,r){this.queue.push(t),this.processRequests(r)}}class On extends ji{constructor(t){super("metrics"),t&&(this.data=t)}postMetricsEvent(t){if(!s.e.EVENTS_URL||!t&&!s.e.ACCESS_TOKEN)return;this.anonId||this.fetchEventData(),s.v(this.anonId)||this.refreshUUID();const r=Object.assign({},this.data,{sessionId:this.anonId});this.queueRequest({timestamp:Date.now(),payload:r},t)}processRequests(t){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:r,payload:h}=this.queue.shift();this.postEvent(r,h,()=>{},t)}}const Un=new class extends ji{constructor(u){super("appUserTurnstile"),this._customAccessToken=u}postTurnstileEvent(u,t){s.e.EVENTS_URL&&s.e.ACCESS_TOKEN&&Array.isArray(u)&&u.some(r=>s.h(r)||s.j(r))&&this.queueRequest(Date.now(),t)}processRequests(u){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.anonIdTimestamp&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const t=ki(s.e.ACCESS_TOKEN),r=t?t.u:s.e.ACCESS_TOKEN;let h=r!==this.eventData.tokenU;s.v(this.anonId)||(this.refreshUUID(),h=!0);const p=this.queue.shift();if(this.eventData.lastSuccess){const g=new Date(this.eventData.lastSuccess),y=new Date(p),w=(p-this.eventData.lastSuccess)/864e5;h=h||w>=1||w<-1||g.getDate()!==y.getDate()}else h=!0;h?this.postEvent(p,{sdkIdentifier:"mapbox-gl-js",sdkVersion:Z,skuId:or,"enabled.telemetry":!1,userId:this.anonId},g=>{g||(this.eventData.lastSuccess=p,this.eventData.tokenU=r)},u):this.processRequests()}},gn=Un.postTurnstileEvent.bind(Un),Er=new class extends ji{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(u,t,r,h){this.skuToken=t,this.errorCb=h,s.e.EVENTS_URL&&(r||s.e.ACCESS_TOKEN?this.queueRequest({id:u,timestamp:Date.now()},r):this.errorCb(new Error(Ri)))}processRequests(u){if(this.pendingRequest||this.queue.length===0)return;const{id:t,timestamp:r}=this.queue.shift();t&&this.success[t]||(this.anonId&&this.anonIdTimestamp||this.fetchEventData(),s.v(this.anonId)||this.refreshUUID(),this.postEvent(r,{sdkIdentifier:"mapbox-gl-js",sdkVersion:Z,skuId:or,skuToken:this.skuToken,userId:this.anonId},h=>{h?this.errorCb(h):t&&(this.success[t]=!0)},u))}remove(){this.errorCb=null}},ja=Er.postMapLoadEvent.bind(Er),Lo=new class extends ji{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(u){let t=this.mapInstanceIdMap.get(u);return t||(t=s.u(),this.mapInstanceIdMap.set(u,t)),t}getEventId(u){const t=this.eventIdPerMapInstanceMap.get(u)||0;return this.eventIdPerMapInstanceMap.set(u,t+1),t}postStyleLoadEvent(u,t){const{map:r,style:h,importedStyles:p}=t;if(!s.e.EVENTS_URL||!u&&!s.e.ACCESS_TOKEN)return;const g=this.getMapInstanceId(r),y={mapInstanceId:g,eventId:this.getEventId(g),style:h};p.length&&(y.importedStyles=p),this.queueRequest({timestamp:Date.now(),payload:y},u)}processRequests(u){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:t,payload:r}=this.queue.shift();this.postEvent(t,r,()=>{},u)}},ia=Lo.postStyleLoadEvent.bind(Lo),Ua=new On({attributes:[{name:"maps/js/layer-animations/style-with-appearances"}]}),yn=Ua.postMetricsEvent.bind(Ua),qn=new On({attributes:[{name:"maps/js/layer-animations/runtime-appearances"}]}),jr=qn.postMetricsEvent.bind(qn),bl=new class extends ji{constructor(){super("gljs.performance")}postPerformanceEvent(u,t){s.e.EVENTS_URL&&(u||s.e.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:t},u)}processRequests(u){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:t,performanceData:r}=this.queue.shift(),h=function(p){const g=performance.getEntriesByType("resource"),y=performance.getEntriesByType("mark"),w=function(D){const N={};if(D){for(const B in D)if(B!=="other")for(const G of D[B]){const $=`${B}ResolveRangeMin`,X=`${B}ResolveRangeMax`,J=`${B}RequestCount`,K=`${B}RequestCachedCount`;N[$]=Math.min(N[$]||1/0,G.startTime),N[X]=Math.max(N[X]||-1/0,G.responseEnd);const ue=oe=>{N[oe]===void 0&&(N[oe]=0),++N[oe]};G.transferSize!==void 0&&G.transferSize===0&&ue(K),ue(J)}}return N}(function(D,N){const B={};if(D)for(const G of D){const $=N(G);B[$]===void 0&&(B[$]=[]),B[$].push(G)}return B}(g,Ee)),T=window.devicePixelRatio,A=navigator.connection||navigator.mozConnection||navigator.webkitConnection,M=A?A.effectiveType:void 0,z={counters:[],metadata:[],attributes:[]},L=(D,N,B)=>{B!=null&&D.push({name:N,value:B.toString()})};for(const D in w)L(z.counters,D,w[D]);if(p.interactionRange[0]!==1/0&&p.interactionRange[1]!==-1/0&&(L(z.counters,"interactionRangeMin",p.interactionRange[0]),L(z.counters,"interactionRangeMax",p.interactionRange[1])),y)for(const D of Object.values(Q)){const N=y.find(B=>B.name===D);N&&L(z.counters,D,N.startTime)}return L(z.counters,"visibilityHidden",p.visibilityHidden),L(z.attributes,"style",function(D){if(D)for(const N of D){const B=N.name.split("?")[0];if(s.i(B)){const G=B.split("/").slice(-2);if(G.length===2)return`mapbox://styles/${G[0]}/${G[1]}`}}}(g)),L(z.attributes,"terrainEnabled",p.terrainEnabled?"true":"false"),L(z.attributes,"fogEnabled",p.fogEnabled?"true":"false"),L(z.attributes,"projection",p.projection),L(z.attributes,"zoom",p.zoom),L(z.metadata,"devicePixelRatio",T),L(z.metadata,"connectionEffectiveType",M),L(z.metadata,"navigatorUserAgent",navigator.userAgent),L(z.metadata,"screenWidth",window.screen.width),L(z.metadata,"screenHeight",window.screen.height),L(z.metadata,"windowWidth",window.innerWidth),L(z.metadata,"windowHeight",window.innerHeight),L(z.metadata,"mapWidth",p.width/T),L(z.metadata,"mapHeight",p.height/T),L(z.metadata,"webglRenderer",p.renderer),L(z.metadata,"webglVendor",p.vendor),L(z.metadata,"sdkVersion",Z),L(z.metadata,"sdkIdentifier","mapbox-gl-js"),z}(r);for(const p of h.metadata);for(const p of h.counters);for(const p of h.attributes);this.postEvent(t,h,()=>{},u)}},Kn=bl.postPerformanceEvent.bind(bl),Va=new class extends ji{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(u,t,r,h){if(!s.e.API_URL||!s.e.SESSION_PATH)return;const p=In(s.e.API_URL+s.e.SESSION_PATH);p.params.push(`sku=${t||""}`),p.params.push(`access_token=${h||s.e.ACCESS_TOKEN||""}`);const g={url:dn(p),headers:{"Content-Type":"text/plain"}};this.pendingRequest=s.g(g,y=>{this.pendingRequest=null,r(y),this.saveEventData(),this.processRequests(h)})}getSessionAPI(u,t,r,h){this.skuToken=t,this.errorCb=h,s.e.SESSION_PATH&&s.e.API_URL&&(r||s.e.ACCESS_TOKEN?this.queueRequest({id:u,timestamp:Date.now()},r):this.errorCb(new Error(Ri)))}processRequests(u){if(this.pendingRequest||this.queue.length===0)return;const{id:t,timestamp:r}=this.queue.shift();t&&this.success[t]||this.getSession(r,this.skuToken,h=>{h?this.errorCb(h):t&&(this.success[t]=!0)},u)}remove(){this.errorCb=null}},$a=Va.getSessionAPI.bind(Va),Eo=new Set;function Xr(u,t){t?Eo.add(u):Eo.delete(u)}class Qn{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages={}}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(t,r){this._updatedSourceCaches[t]=r,this.setDirty()}discardSourceCacheUpdate(t){delete this._updatedSourceCaches[t]}updateLayer(t){const r=t.scope;this._updatedLayers[r]=this._updatedLayers[r]||new Set,this._updatedLayers[r].add(t.id),this.setDirty()}removeLayer(t){const r=t.scope;this._removedLayers[r]=this._removedLayers[r]||{},this._updatedLayers[r]=this._updatedLayers[r]||new Set,this._removedLayers[r][t.id]=t,this._updatedLayers[r].delete(t.id),this._updatedPaintProps.delete(t.fqid),this.setDirty()}getRemovedLayer(t){return this._removedLayers[t.scope]?this._removedLayers[t.scope][t.id]:null}discardLayerRemoval(t){this._removedLayers[t.scope]&&delete this._removedLayers[t.scope][t.id]}getLayerUpdatesByScope(){const t={};for(const r in this._updatedLayers)t[r]=t[r]||{},t[r].updatedIds=Array.from(this._updatedLayers[r].values());for(const r in this._removedLayers)t[r]=t[r]||{},t[r].removedIds=Object.keys(this._removedLayers[r]);return t}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(t){this._updatedPaintProps.add(t.fqid),this.setDirty()}getUpdatedImages(t){return this._updatedImages[t]?Array.from(this._updatedImages[t].values()):[]}updateImage(t,r){this._updatedImages[r]=this._updatedImages[r]||new Set,this._updatedImages[r].add(s.I.toString(t)),this.setDirty()}resetUpdatedImages(t){this._updatedImages[t]&&this._updatedImages[t].clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages={}}}function hp(u){const{userImage:t}=u;return!!(t&&t.render&&t.render())&&(u.data.replace(new Uint8Array(t.data.buffer)),!0)}class pc extends s.E{constructor(t){super(),this.imageProviders=new Map,this.images=new Map,this.updatedImages=new Map,this.callbackDispatchedThisFrame=new Map,this.loaded=new Map,this.requestors=[],this.patterns=new Map,this.patternsInFlight=new Set,this.atlasImage=new Map,this.atlasTexture=new Map,this.dirty=!0,this.spriteFormat=t,t!=="raster"&&s.r()&&(this.imageRasterizerDispatcher=new s.D(s.t(),this,"Image Rasterizer Worker",1))}addScope(t){this.loaded.set(t,!1),this.imageProviders.set(t,new Map),this.images.set(t,new Map),this.updatedImages.set(t,new Set),this.callbackDispatchedThisFrame.set(t,new Set),this.patterns.set(t,new Map),this.atlasImage.set(t,new s.q({width:1,height:1}))}removeScope(t){this.loaded.delete(t),this.imageProviders.delete(t),this.images.delete(t),this.updatedImages.delete(t),this.callbackDispatchedThisFrame.delete(t),this.patterns.delete(t),this.atlasImage.delete(t);const r=this.atlasTexture.get(t);r&&(r.destroy(),this.atlasTexture.delete(t))}addImageProvider(t,r){this.imageProviders.has(r)||this.imageProviders.set(r,new Map),this.imageProviders.get(r).set(t.id,t)}removeImageProvider(t,r){this.imageProviders.has(r)&&this.imageProviders.get(r).delete(t)}getPendingImageProviders(){const t=[];for(const r of this.imageProviders.values())for(const h of r.values())h.hasPendingRequests()&&t.push(h);return t}get imageRasterizer(){return this._imageRasterizer||(this._imageRasterizer=new s.x),this._imageRasterizer}isLoaded(){for(const t of this.loaded.keys())if(!this.loaded.get(t))return!1;return!0}setLoaded(t,r){if(this.loaded.get(r)!==t&&(this.loaded.set(r,t),t)){for(const{ids:h,callback:p}of this.requestors)this._notify(h,r,p);this.requestors=[]}}hasImage(t,r){return!!this.getImage(t,r)}getImage(t,r){return this.images.get(r).get(t.toString())}addImage(t,r,h){this._validate(t,h)&&this.images.get(r).set(t.toString(),h)}_validate(t,r){let h=!0;return this._validateStretch(r.stretchX,r.data&&r.data.width)||(this.fire(new s.y(new Error(`Image "${t.name}" has invalid "stretchX" value`))),h=!1),this._validateStretch(r.stretchY,r.data&&r.data.height)||(this.fire(new s.y(new Error(`Image "${t.name}" has invalid "stretchY" value`))),h=!1),this._validateContent(r.content,r)||(this.fire(new s.y(new Error(`Image "${t.name}" has invalid "content" value`))),h=!1),h}_validateStretch(t,r){if(!t)return!0;let h=0;for(const p of t){if(p[0]<h||p[1]<p[0]||r<p[1])return!1;h=p[1]}return!0}_validateContent(t,r){return t?t.length!==4||!r.usvg&&(t[0]<0||r.data.width<t[0]||t[1]<0||r.data.height<t[1]||t[2]<0||r.data.width<t[2]||t[3]<0||r.data.height<t[3])?!1:!(t[2]<t[0]||t[3]<t[1]):!0}updateImage(t,r,h){const p=this.images.get(r).get(t.toString());h.version=p.version+1,this.images.get(r).set(t.toString(),h),this.updatedImages.get(r).add(t),this.removeFromImageRasterizerCache(t,r)}clearUpdatedImages(t){this.updatedImages.get(t).clear()}removeFromImageRasterizerCache(t,r){this.spriteFormat!=="raster"&&(s.r()?this.imageRasterizerDispatcher.getActor().send("removeRasterizedImages",{imageIds:[t],scope:r}):this.imageRasterizer.removeImagesFromCacheByIds([t],r))}removeImage(t,r){const h=this.images.get(r),p=h.get(t.toString());h.delete(t.toString()),this.patterns.get(r).delete(t.toString()),this.removeFromImageRasterizerCache(t,r),p.userImage&&p.userImage.onRemove&&p.userImage.onRemove()}listImages(t){return Array.from(this.images.get(t).keys()).map(r=>s.I.from(r))}getImages(t,r,h){const p=[],g=[],y=this.imageProviders.get(r);for(const M of t){if(!M.iconsetId){p.push(M);continue}const z=y.get(M.iconsetId);z&&(this.getImage(M,r)?g.push(M):z.addPendingRequest(M))}if(p.length===0)return void this._notify(g,r,h);let w=!0;const T=!!this.loaded.get(r),A=this.images.get(r);if(!T)for(const M of p)A.has(M.toString())||(w=!1);T||w?this._notify(p,r,h):this.requestors.push({ids:p,scope:r,callback:h})}rasterizeImages(t,r){const h=new Map,{tasks:p,scope:g}=t;for(const[y,w]of p.entries()){const T=this.getImage(w.id,g);T&&h.set(y,{image:T,imageVariant:w})}this._rasterizeImages(g,h,r)}_rasterizeImages(t,r,h){if(s.r())this.imageRasterizerDispatcher.getActor().send("rasterizeImagesWorker",{tasks:r,scope:t},h);else{const p=new Map;for(const[g,{image:y,imageVariant:w}]of r.entries())p.set(g,this.imageRasterizer.rasterize(w,y,t,0));h(void 0,p)}}getUpdatedImages(t){return this.updatedImages.get(t)||new Set}_notify(t,r,h){const p=this.images.get(r),g=new Map;for(const y of t){if(!p.get(y.toString())){if(y.iconsetId)continue;this.fire(new s.z("styleimagemissing",{id:y.name}))}const w=p.get(y.toString());if(!w){s.w(`Image "${y.name}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`);continue}const T={data:w.usvg?null:w.data.clone(),pixelRatio:w.pixelRatio,sdf:w.sdf,usvg:w.usvg,version:w.version,stretchX:w.stretchX,stretchY:w.stretchY,content:w.content,hasRenderCallback:!!(w.userImage&&w.userImage.render)};w.usvg&&Object.assign(T,{width:w.icon.usvg_tree.width,height:w.icon.usvg_tree.height}),g.set(s.I.toString(y),T)}h(null,g)}getPixelSize(t){const{width:r,height:h}=this.atlasImage.get(t);return{width:r,height:h}}getPattern(t,r,h){const p=t.toString(),g=this.patterns.get(r),y=g.get(p),w=this.getImage(t,r);if(!w)return null;if(y){if(y.position.version===w.version)return y.position;y.position.version=w.version}else{if(w.usvg&&!w.data){const T=this.getPatternInFlightId(p,r);if(this.patternsInFlight.has(T))return null;this.patternsInFlight.add(T);const A=new s.A(t).scaleSelf(s.o.devicePixelRatio),M=new Map([[A.toString(),{image:w,imageVariant:A}]]);return this._rasterizeImages(r,M,(z,L)=>this.storePatternImage(A,r,w,h,L)),null}this.storePattern(t,r,w)}return this._updatePatternAtlas(r,h),g.get(p).position}getPatternInFlightId(t,r){return s.B(t,r)}hasPatternsInFlight(){return this.patternsInFlight.size!==0}storePatternImage(t,r,h,p,g){const y=t.toString(),w=g?g.get(y):void 0;w&&(h.data=w,this.storePattern(t.id,r,h),this._updatePatternAtlas(r,p),this.patternsInFlight.delete(this.getPatternInFlightId(t.id.toString(),r)))}storePattern(t,r,h){const p={w:h.data.width+2*s.C,h:h.data.height+2*s.C,x:0,y:0},g=new s.F(p,h,s.C);this.patterns.get(r).set(t.toString(),{bin:p,position:g})}destroyAtlasTextures(){for(const t of this.atlasTexture.values())t&&t.destroy();this.atlasTexture.clear()}bind(t,r){const h=t.gl;let p=this.atlasTexture.get(r);p?this.dirty&&(p.update(this.atlasImage.get(r)),this.dirty=!1):(p=new s.T(t,this.atlasImage.get(r),h.RGBA8),this.atlasTexture.set(r,p)),p.bind(h.LINEAR,h.CLAMP_TO_EDGE)}_updatePatternAtlas(t,r){const h=this.patterns.get(t),p=Array.from(h.values()).map(({bin:A})=>A),{w:g,h:y}=s.G(p),w=this.atlasImage.get(t);w.resize({width:g||1,height:y||1});const T=this.images.get(t);for(const[A,{bin:M,position:z}]of h.entries()){let L=z.padding;const D=M.x+L,N=M.y+L,B=T.get(A).data,G=B.width,$=B.height;L=L>1?L-1:L,s.q.copy(B,w,{x:0,y:0},{x:D,y:N},{width:G,height:$},r),s.q.copy(B,w,{x:0,y:$-L},{x:D,y:N-L},{width:G,height:L},r),s.q.copy(B,w,{x:0,y:0},{x:D,y:N+$},{width:G,height:L},r),s.q.copy(B,w,{x:G-L,y:0},{x:D-L,y:N},{width:L,height:$},r),s.q.copy(B,w,{x:0,y:0},{x:D+G,y:N},{width:L,height:$},r),s.q.copy(B,w,{x:G-L,y:$-L},{x:D-L,y:N-L},{width:L,height:L},r),s.q.copy(B,w,{x:0,y:$-L},{x:D+G,y:N-L},{width:L,height:L},r),s.q.copy(B,w,{x:0,y:0},{x:D+G,y:N+$},{width:L,height:L},r),s.q.copy(B,w,{x:G-L,y:0},{x:D-L,y:N+$},{width:L,height:L},r)}this.dirty=!0}beginFrame(){for(const t of this.images.keys())this.callbackDispatchedThisFrame.set(t,new Set)}dispatchRenderCallbacks(t,r){const h=this.images.get(r);for(const p of t){if(this.callbackDispatchedThisFrame.get(r).has(p.toString()))continue;this.callbackDispatchedThisFrame.get(r).add(p.toString());const g=h.get(p.toString());hp(g)&&this.updateImage(p,r,g)}}destroy(){this.imageRasterizerDispatcher&&this.imageRasterizerDispatcher.remove()}}function Tl(u){const t=u.value,r=u.valueSpec,h=u.style,p=u.styleSpec,g=u.key,y=u.arrayElementValidator||Rn;if(!Array.isArray(t))return[new s.V(g,t,`array expected, ${s.K(t)} found`)];if(r.length&&t.length!==r.length)return[new s.V(g,t,`array length ${r.length} expected, length ${t.length} found`)];if(r["min-length"]&&t.length<r["min-length"])return[new s.V(g,t,`array length at least ${r["min-length"]} expected, length ${t.length} found`)];let w={type:r.value,values:r.values,minimum:r.minimum,maximum:r.maximum,function:void 0};p.$version<7&&(w.function=r.function),s.H(r.value)&&(w=r.value);let T=[];for(let A=0;A<t.length;A++)T=T.concat(y({array:t,arrayIndex:A,value:t[A],valueSpec:w,style:h,styleSpec:p,key:`${g}[${A}]`},!0));return T}function Ga(u){const t=u.key,r=u.value,h=u.valueSpec;if(!s.L(r))return[new s.V(t,r,`number expected, ${s.K(r)} found`)];if(r!=r)return[new s.V(t,r,"number expected, NaN found")];if("minimum"in h){let p=h.minimum;if(Array.isArray(h.minimum)&&(p=h.minimum[u.arrayIndex]),r<p)return[new s.V(t,r,`${r} is less than the minimum value ${p}`)]}if("maximum"in h){let p=h.maximum;if(Array.isArray(h.maximum)&&(p=h.maximum[u.arrayIndex]),r>p)return[new s.V(t,r,`${r} is greater than the maximum value ${p}`)]}return[]}function Ha(u){const t=u.key,r=u.value;if(!s.H(r))return[new s.V(t,r,`object expected, ${s.K(r)} found`)];const h=u.valueSpec,p=s.J(r.type);let g,y,w,T={};const A=p!=="categorical"&&r.property===void 0,M=!A,z=function(B){const G=B.stops;return Array.isArray(G)&&Array.isArray(G[0])&&s.H(G[0][0])}(r),L=Lr({key:u.key,value:u.value,valueSpec:u.styleSpec.function,style:u.style,styleSpec:u.styleSpec,objectElementValidators:{stops:function(B){if(p==="identity")return[new s.V(B.key,B.value,'identity function may not have a "stops" property')];let G=[];const $=B.value;return G=G.concat(Tl({key:B.key,value:$,valueSpec:B.valueSpec,style:B.style,styleSpec:B.styleSpec,arrayElementValidator:D})),Array.isArray($)&&$.length===0&&G.push(new s.V(B.key,$,"array must have at least one stop")),G},default:function(B){return Rn({key:B.key,value:B.value,valueSpec:h,style:B.style,styleSpec:B.styleSpec})}}});return p==="identity"&&A&&L.push(new s.V(u.key,u.value,'missing required property "property"')),p==="identity"||r.stops||L.push(new s.V(u.key,u.value,'missing required property "stops"')),p==="exponential"&&h.expression&&!s.M(h)&&L.push(new s.V(u.key,u.value,"exponential functions not supported")),u.styleSpec.$version>=8&&(M&&!s.N(h)?L.push(new s.V(u.key,u.value,"property functions not supported")):A&&!s.O(h)&&L.push(new s.V(u.key,u.value,"zoom functions not supported"))),p!=="categorical"&&!z||r.property!==void 0||L.push(new s.V(u.key,u.value,'"property" property is required')),L;function D(B){let G=[];const $=B.value,X=B.key;if(!Array.isArray($))return[new s.V(X,$,`array expected, ${s.K($)} found`)];if($.length!==2)return[new s.V(X,$,`array length 2 expected, length ${$.length} found`)];if(z){if(!s.H($[0]))return[new s.V(X,$,`object expected, ${s.K($[0])} found`)];const J=$[0];if(J.zoom===void 0)return[new s.V(X,$,"object stop key must have zoom")];if(J.value===void 0)return[new s.V(X,$,"object stop key must have value")];const K=s.J(J.zoom);if(typeof K!="number")return[new s.V(X,J.zoom,"stop zoom values must be numbers")];if(w&&w>K)return[new s.V(X,J.zoom,"stop zoom values must appear in ascending order")];K!==w&&(w=K,y=void 0,T={}),G=G.concat(Lr({key:`${X}[0]`,value:$[0],valueSpec:{zoom:{}},style:B.style,styleSpec:B.styleSpec,objectElementValidators:{zoom:Ga,value:N}}))}else G=G.concat(N({key:`${X}[0]`,value:$[0],style:B.style,styleSpec:B.styleSpec},$));return s.Q(s.S($[1]))?G.concat([new s.V(`${X}[1]`,$[1],"expressions are not allowed in function stops.")]):G.concat(Rn({key:`${X}[1]`,value:$[1],valueSpec:h,style:B.style,styleSpec:B.styleSpec}))}function N(B,G){const $=s.K(B.value),X=s.J(B.value),J=B.value!==null?B.value:G;if(g){if($!==g)return[new s.V(B.key,J,`${$} stop domain type must match previous stop domain type ${g}`)]}else g=$;if($!=="number"&&$!=="string"&&$!=="boolean"&&typeof X!="number"&&typeof X!="string"&&typeof X!="boolean")return[new s.V(B.key,J,"stop domain value must be a number, string, or boolean")];if($!=="number"&&p!=="categorical"){let K=`number expected, ${$} found`;return s.N(h)&&p===void 0&&(K+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new s.V(B.key,J,K)]}return p!=="categorical"||$!=="number"||typeof X=="number"&&isFinite(X)&&Math.floor(X)===X?p!=="categorical"&&$==="number"&&typeof X=="number"&&typeof y=="number"&&y!==void 0&&X<y?[new s.V(B.key,J,"stop domain values must appear in ascending order")]:(y=X,p==="categorical"&&X in T?[new s.V(B.key,J,"stop domain values must be unique")]:(T[X]=!0,[])):[new s.V(B.key,J,`integer expected, found ${String(X)}`)]}}function Ur(u){const t=(u.expressionContext==="property"?s.W:s.U)(s.S(u.value),u.valueSpec);if(t.result==="error")return t.value.map(h=>new s.V(`${u.key}${h.key}`,u.value,h.message));const r=t.value.expression||t.value._styleExpression.expression;if(u.expressionContext==="property"&&u.propertyKey==="text-font"&&!r.outputDefined())return[new s.V(u.key,u.value,`Invalid data expression for "${u.propertyKey}". Output values must be contained as literals within the expression.`)];if(u.expressionContext==="property"&&u.propertyType==="layout"&&!s.Z(r))return[new s.V(u.key,u.value,'"feature-state" data expressions are not supported with layout properties.')];if(u.expressionContext==="filter")return na(r,u);if(u.expressionContext==="appearance")return mc(r,u);if(u.expressionContext&&u.expressionContext.indexOf("cluster")===0){if(!s.X(r,["zoom","feature-state"]))return[new s.V(u.key,u.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(u.expressionContext==="cluster-initial"&&!s.Y(r))return[new s.V(u.key,u.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function na(u,t){const r=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(t.valueSpec&&t.valueSpec.expression)for(const p of t.valueSpec.expression.parameters)r.delete(p);if(r.size===0)return[];const h=[];return u instanceof s._&&r.has(u.name)?[new s.V(t.key,t.value,`["${u.name}"] expression is not supported in a filter for a ${t.object.type} layer with id: ${t.object.id}`)]:(u.eachChild(p=>{h.push(...na(p,t))}),h)}function mc(u,t){const r=new Set;if(t.valueSpec&&t.valueSpec.expression)for(const p of t.valueSpec.expression.parameters)r.add(p);if(r.size===0)return[];const h=[];return u instanceof s._&&!r.has(u.name)?[new s.V(t.key,t.value,`["${u.name}"] is not an allowed parameter`)]:(u.eachChild(p=>{h.push(...mc(p,t))}),h)}function hs(u){const t=u.key,r=u.value,h=u.valueSpec,p=[];return Array.isArray(h.values)?h.values.indexOf(s.J(r))===-1&&p.push(new s.V(t,r,`expected one of [${h.values.join(", ")}], ${JSON.stringify(r)} found`)):Object.keys(h.values).indexOf(s.J(r))===-1&&p.push(new s.V(t,r,`expected one of [${Object.keys(h.values).join(", ")}], ${JSON.stringify(r)} found`)),p}function ra(u){return s.a2(s.S(u.value))?Ur(Object.assign({},u,{expressionContext:"filter",valueSpec:u.styleSpec[`filter_${u.layerType||"fill"}`]})):no(u)}function no(u){const t=u.value,r=u.key;if(!Array.isArray(t))return[new s.V(r,t,`array expected, ${s.K(t)} found`)];if(t.length<1)return[new s.V(r,t,"filter array must have at least 1 element")];const h=u.styleSpec;let p=hs({key:`${r}[0]`,value:t[0],valueSpec:h.filter_operator});const g=()=>{t.length>=2&&(s.a0(t[1])||p.push(new s.V(`${r}[1]`,t[1],`string expected, ${s.K(t[1])} found`)));for(let y=2;y<t.length;y++)s.J(t[1])==="$type"?p=p.concat(hs({key:`${r}[${y}]`,value:t[y],valueSpec:h.geometry_type})):s.a0(t[y])||s.L(t[y])||s.$(t[y])||p.push(new s.V(`${r}[${y}]`,t[y],`string, number, or boolean expected, ${s.K(t[y])} found.`))};switch(s.J(t[0])){case"<":case"<=":case">":case">=":t.length>=2&&s.J(t[1])==="$type"&&p.push(new s.V(r,t,`"$type" cannot be use with operator "${t[0]}"`)),t.length!==3&&p.push(new s.V(r,t,`filter array for operator "${t[0]}" must have 3 elements`)),g();break;case"==":case"!=":t.length!==3&&p.push(new s.V(r,t,`filter array for operator "${t[0]}" must have 3 elements`)),g();break;case"in":case"!in":g();break;case"any":case"all":case"none":for(let y=1;y<t.length;y++)p=p.concat(no({key:`${r}[${y}]`,value:t[y],style:u.style,styleSpec:u.styleSpec}));break;case"has":case"!has":t.length!==2?p.push(new s.V(r,t,`filter array for "${t[0]}" operator must have 2 elements`)):s.a0(t[1])||p.push(new s.V(`${r}[1]`,t[1],`string expected, ${s.K(t[1])} found`))}return p}function Sl(u,t){const r=u.key,h=u.style,p=u.layer,g=u.styleSpec,y=u.value,w=u.objectKey,T=g[`${t}_${u.layerType}`];if(!T)return[];const A=w.match(/^(.*)-use-theme$/);if(A&&T[A[1]])return s.Q(s.S(y))?[].concat(Rn({key:r,value:y,valueSpec:{type:"string",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},style:h,styleSpec:g,expressionContext:"property",propertyType:t,propertyKey:w})):Rn({key:r,value:y,valueSpec:{type:"string"},style:h,styleSpec:g});const M=w.match(/^(.*)-transition$/);if(t==="paint"&&M&&T[M[1]]&&T[M[1]].transition)return Rn({key:r,value:y,valueSpec:g.transition,style:h,styleSpec:g});const z=u.valueSpec||T[w];if(!z)return[new s.a3(r,y,`unknown property "${w}"`)];let L;if(s.a0(y)&&s.N(z)&&!z.tokens&&(L=/^{([^}]+)}$/.exec(y))){const N=`\`{ "type": "identity", "property": ${L?JSON.stringify(L[1]):'"_"'} }\``;return[new s.V(r,y,`"${w}" does not support interpolation syntax
Use an identity property function instead: ${N}.`)]}const D=[];if(u.layerType==="symbol")w!=="text-field"||!h||h.glyphs||h.imports||D.push(new s.V(r,y,'use of "text-field" requires a style "glyphs" property')),w==="text-font"&&s.a4(s.S(y))&&s.J(y.type)==="identity"&&D.push(new s.V(r,y,'"text-font" does not support identity functions'));else if(u.layerType==="model"&&t==="paint"&&p&&p.layout&&p.layout.hasOwnProperty("model-id")&&s.N(z)&&(s.a5(z)||s.O(z))){const N=s.W(s.S(y),z).value,B="expression"in N&&N.expression||"_styleExpression"in N&&N._styleExpression&&N._styleExpression.expression;B&&!s.X(B,["measure-light"])&&(w==="model-emissive-strength"&&s.Y(B)&&s.Z(B)||D.push(new s.V(r,y,`${w} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return D.concat(Rn({key:u.key,value:y,valueSpec:z,style:h,styleSpec:g,expressionContext:"property",propertyType:t,propertyKey:w}))}function El(u){return Sl(u,"paint")}function Il(u){return Sl(u,"layout")}function _c(u){let t=[];const r=u.value,h=u.key,p=u.style,g=u.styleSpec;if(!s.H(r))return[new s.V(h,r,"object expected")];r.type||r.ref||t.push(new s.V(h,r,'either "type" or "ref" is required'));let y=s.J(r.type);const w=s.J(r.ref);if(r.id){const T=s.J(r.id);for(let A=0;A<u.arrayIndex;A++){const M=p.layers[A];s.J(M.id)===T&&t.push(new s.V(h,r.id,`duplicate layer id "${T}", previously used at line ${M.id.__line__}`))}}if("ref"in r){let T;["type","source","source-layer","filter","layout"].forEach(A=>{A in r&&t.push(new s.V(h,r[A],`"${A}" is prohibited for ref layers`))}),p.layers.forEach(A=>{s.J(A.id)===w&&(T=A)}),T?T.ref?t.push(new s.V(h,r.ref,"ref cannot reference another ref layer")):y=s.J(T.type):typeof w=="string"&&t.push(new s.V(h,r.ref,`ref layer "${w}" not found`))}else if(y!=="background"&&y!=="sky"&&y!=="slot")if(r.source)if(s.a0(r.source)){const T=p.sources&&p.sources[r.source],A=T&&s.J(T.type);T?A==="vector"&&y==="raster"?t.push(new s.V(h,r.source,`layer "${r.id}" requires a raster source`)):A==="raster"&&y!=="raster"?t.push(new s.V(h,r.source,`layer "${r.id}" requires a vector source`)):A!=="vector"||r["source-layer"]?A==="raster-dem"&&y!=="hillshade"?t.push(new s.V(h,r.source,"raster-dem source can only be used with layer type 'hillshade'.")):A!=="raster-array"||["raster","raster-particle"].includes(y)?y==="line"&&r.paint&&(r.paint["line-gradient"]||r.paint["line-trim-offset"])&&A==="geojson"&&!T.lineMetrics?t.push(new s.V(h,r,`layer "${r.id}" specifies a line-gradient, which requires the GeoJSON source to have \`lineMetrics\` enabled.`)):y==="raster-particle"&&A!=="raster-array"&&t.push(new s.V(h,r.source,`layer "${r.id}" requires a 'raster-array' source.`)):t.push(new s.V(h,r.source,"raster-array source can only be used with layer type 'raster'.")):t.push(new s.V(h,r,`layer "${r.id}" must specify a "source-layer"`)):t.push(new s.V(h,r.source,`source "${r.source}" not found`))}else t.push(new s.V(`${h}.source`,r.source,'"source" must be a string'));else t.push(new s.V(h,r,'missing required property "source"'));return t=t.concat(Lr({key:h,value:r,valueSpec:g.layer,style:u.style,styleSpec:u.styleSpec,objectElementValidators:{"*":()=>[],type:()=>Rn({key:`${h}.type`,value:r.type,valueSpec:g.layer.type,style:u.style,styleSpec:u.styleSpec,object:r,objectKey:"type"}),filter:T=>ra(Object.assign({layerType:y},T)),layout:T=>Lr({layer:r,key:T.key,value:T.value,valueSpec:{},style:T.style,styleSpec:T.styleSpec,objectElementValidators:{"*":A=>Il(Object.assign({layerType:y},A))}}),paint:T=>Lr({layer:r,key:T.key,value:T.value,valueSpec:{},style:T.style,styleSpec:T.styleSpec,objectElementValidators:{"*":A=>El(Object.assign({layerType:y,layer:r},A))}}),appearances(T){const A=Tl({key:T.key,value:T.value,valueSpec:T.valueSpec,style:T.style,styleSpec:T.styleSpec,arrayElementValidator:L=>function(D){const{key:N,layer:B,layerType:G}=D,$=s.J(D.value),X=s.J($.name),J=s.J($.condition),K=Lr({key:N,value:$,valueSpec:D.styleSpec.appearance,style:D.style,styleSpec:D.styleSpec,objectElementValidators:{condition:ue=>function(oe){const le=[];return le.push(...Ur({key:oe.key,value:oe.object.condition,valueSpec:s.a6.appearance.condition,expressionContext:"appearance"})),le}(Object.assign({layer:B,layerType:G},ue)),properties:ue=>function(oe){const le=[],{styleSpec:re,layer:te,layerType:he}=oe,we=re[`paint_${he}`],ye=re[`layout_${he}`],ze=oe.object[oe.objectKey];for(const Oe in ze){const $e=Oe in we?"paint":Oe in ye?"layout":void 0;if(!$e){le.push(new s.V(oe.key,Oe,`unknown property "${Oe}" for layer type "${he}"`));continue}const ot=Object.assign({},oe,{key:`${oe.key}.${Oe}`,object:ze,objectKey:Oe,layer:te,layerType:he,value:ze[Oe],valueSpec:$e==="paint"?we[Oe]:ye[Oe]});le.push(...Sl(ot,$e))}return le}(Object.assign({layer:B,layerType:G},ue))}});return X!=="hidden"&&J===void 0&&K.push(new s.V(D.key,"name",'Appearance with name different than "hidden" must have a condition')),K}(Object.assign({layerType:y,layer:r},L))}),M=Array.isArray(T.value)?T.value:[],z=new Set;return M.forEach((L,D)=>{const N=s.J(L.name);if(N)if(z.has(N)){const B=s.J(r.id);A.push(new s.V(T.key,N,`Duplicated appearance name "${N}" for layer "${B}"`))}else z.add(N)}),A}}})),t}function Ir({key:u,value:t}){return s.a0(t)?[]:[new s.V(u,t,`string expected, ${s.K(t)} found`)]}const po={promoteId:function u({key:t,value:r}){if(s.a0(r))return Ir({key:t,value:r});if(Array.isArray(r)){const p=[],g=s.S(r),y=s.U(g);return y.result==="error"&&y.value.forEach(w=>{p.push(new s.V(`${t}${w.key}`,null,`${w.message}`))}),s.X(y.value.expression,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])||p.push(new s.V(`${t}`,null,"promoteId expression should be only feature dependent")),p}if(!s.H(r))return[new s.V(t,r,`string, expression or object expected, "${s.K(r)}" found`)];const h=[];for(const p in r)h.push(...u({key:`${t}.${p}`,value:r[p]}));return h}};function wu(u){const t=u.value,r=u.key,h=u.styleSpec,p=u.style;if(!s.H(t))return[new s.V(r,t,`object expected, ${s.K(t)} found`)];if(!("type"in t))return[new s.V(r,t,'"type" is required')];const g=s.J(t.type);let y=[];switch(["vector","raster","raster-dem","raster-array"].includes(g)&&("url"in t||"tiles"in t||y.push(new s.a3(r,t,'Either "url" or "tiles" is required.'))),g){case"vector":case"raster":case"raster-dem":case"raster-array":return y=y.concat(Lr({key:r,value:t,valueSpec:h[`source_${g.replace("-","_")}`],style:u.style,styleSpec:h,objectElementValidators:po})),y;case"geojson":if(y=Lr({key:r,value:t,valueSpec:h.source_geojson,style:p,styleSpec:h,objectElementValidators:po}),"cluster"in t&&"clusterProperties"in t){if(!s.H(t.clusterProperties))return[new s.V(`${r}.clusterProperties`,t,`object expected, ${s.K(t)} found`)];for(const w in t.clusterProperties){const T=t.clusterProperties[w];if(!Array.isArray(T))return[new s.V(`${r}.clusterProperties.${w}`,T,"array expected")];const[A,M]=T,z=typeof A=="string"?[A,["accumulated"],["get",w]]:A;y.push(...Ur({key:`${r}.${w}.map`,value:M,expressionContext:"cluster-map"})),y.push(...Ur({key:`${r}.${w}.reduce`,value:z,expressionContext:"cluster-reduce"}))}}return y;case"video":return Lr({key:r,value:t,valueSpec:h.source_video,style:p,styleSpec:h});case"image":return Lr({key:r,value:t,valueSpec:h.source_image,style:p,styleSpec:h});case"canvas":return[new s.V(r,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return hs({key:`${r}.type`,value:t.type,valueSpec:{values:qa(h)}})}}function qa(u){return u.source.reduce((t,r)=>{const h=u[r];return h.type.type==="enum"&&(t=t.concat(Object.keys(h.type.values||{}))),t},[])}function Ls(u){const t=u.value,r=u.styleSpec,h=r.light,p=u.style;if(t===void 0)return[];if(!s.H(t))return[new s.V("light",t,`object expected, ${s.K(t)} found`)];let g=[];for(const y in t){const w=y.match(/^(.*)-transition$/),T=y.match(/^(.*)-use-theme$/);g=g.concat(T&&h[T[1]]?Rn({key:y,value:t[y],valueSpec:{type:"string"},style:p,styleSpec:r}):w&&h[w[1]]&&h[w[1]].transition?Rn({key:y,value:t[y],valueSpec:r.transition,style:p,styleSpec:r}):h[y]?Rn({key:y,value:t[y],valueSpec:h[y],style:p,styleSpec:r}):[new s.V(y,t[y],`unknown property "${y}"`)])}return g}function oa(u){const t=u.value;if(!t)return[];const r=u.key;if(!s.H(t))return[new s.V(r,t,`object expected, ${s.K(t)} found`)];let h=[];const p=u.styleSpec,g=p["light-3d"],y=u.style,w=u.style.lights;for(const M of["type","id"])if(!(M in t))return h=h.concat([new s.V(r,t,`missing property "${M}"`)]),h;if(!s.a0(t.type))return h=h.concat([new s.V(`${r}.type`,t.type,"string expected")]),h;if(w)for(let M=0;M<u.arrayIndex;M++){const z=s.J(t.type),L=w[M];s.J(L.type)===z&&h.push(new s.V(r,t.id,`duplicate light type "${t.type}", previously defined at line ${L.id.__line__}`))}const T=`properties_light_${t.type}`;if(!(T in p))return h=h.concat([new s.V(`${r}.type`,t,`Invalid light type ${t.type}`)]),h;const A=p[T];for(const M in t)if(M==="properties"){const z=t[M];if(!s.H(z))return h=h.concat([new s.V("properties",z,`object expected, ${s.K(z)} found`)]),h;for(const L in z){const D=L.match(/^(.*)-transition$/),N=L.match(/^(.*)-use-theme$/);h=h.concat(N&&A[N[1]]?Rn({key:M,value:z[L],valueSpec:{type:"string"},style:y,styleSpec:p}):D&&A[D[1]]&&A[D[1]].transition?Rn({key:M,value:t[M],valueSpec:p.transition,style:y,styleSpec:p}):A[L]?Rn({key:L,value:z[L],valueSpec:A[L],style:y,styleSpec:p}):[new s.a3(u.key,z[L],`unknown property "${L}"`)])}}else h=h.concat(g[M]?Rn({key:M,value:t[M],valueSpec:g[M],style:y,styleSpec:p}):[new s.a3(M,t[M],`unknown property "${M}"`)]);return h}function ds(u){const t=u.value,r=u.key,h=u.style,p=u.styleSpec,g=p.terrain;if(t==null)return[];if(!s.H(t))return[new s.V("terrain",t,`object expected, ${s.K(t)} found`)];let y=[];for(const w in t){const T=w.match(/^(.*)-transition$/),A=w.match(/^(.*)-use-theme$/);y=y.concat(A&&g[A[1]]?Rn({key:w,value:t[w],valueSpec:{type:"string"},style:h,styleSpec:p}):T&&g[T[1]]&&g[T[1]].transition?Rn({key:w,value:t[w],valueSpec:p.transition,style:h,styleSpec:p}):g[w]?Rn({key:w,value:t[w],valueSpec:g[w],style:h,styleSpec:p}):[new s.a3(w,t[w],`unknown property "${w}"`)])}if(t.source)if(s.a0(t.source)){const w=h.sources&&h.sources[t.source],T=w&&s.J(w.type);w?T!=="raster-dem"&&y.push(new s.V(`${r}.source`,t.source,`terrain cannot be used with a source of type ${T}, it only be used with a "raster-dem" source type`)):y.push(new s.V(`${r}.source`,t.source,`source "${t.source}" not found`))}else y.push(new s.V(`${r}.source`,t.source,"source must be a string"));else y.push(new s.V(r,t,'terrain is missing required property "source"'));return y}function bu(u){const t=u.value,r=u.style,h=u.styleSpec,p=h.fog;if(t===void 0)return[];if(!s.H(t))return[new s.V("fog",t,`object expected, ${s.K(t)} found`)];let g=[];for(const y in t){const w=y.match(/^(.*)-transition$/),T=y.match(/^(.*)-use-theme$/);g=g.concat(T&&p[T[1]]?Rn({key:y,value:t[y],valueSpec:{type:"string"},style:r,styleSpec:h}):w&&p[w[1]]&&p[w[1]].transition?Rn({key:y,value:t[y],valueSpec:h.transition,style:r,styleSpec:h}):p[y]?Rn({key:y,value:t[y],valueSpec:p[y],style:r,styleSpec:h}):[new s.a3(y,t[y],`unknown property "${y}"`)])}return g}const Al={"*":()=>[],array:Tl,boolean:function(u){const t=u.value,r=u.key;return s.$(t)?[]:[new s.V(r,t,`boolean expected, ${s.K(t)} found`)]},number:Ga,color:function({key:u,value:t}){return s.a0(t)?s.a1.parseCSSColor(t)===null?[new s.V(u,t,`color expected, "${t}" found`)]:[]:[new s.V(u,t,`color expected, ${s.K(t)} found`)]},enum:hs,filter:ra,function:Ha,layer:_c,object:Lr,source:wu,model:s.a7,light:Ls,"light-3d":oa,terrain:ds,fog:bu,string:Ir,formatted:function(u){return Ir(u).length===0?[]:Ur(u)},resolvedImage:function(u){return Ir(u).length===0?[]:Ur(u)},projection:function(u){const t=u.value,r=u.styleSpec,h=r.projection,p=u.style;if(s.H(t)){let g=[];for(const y in t)g=g.concat(Rn({key:y,value:t[y],valueSpec:h[y],style:p,styleSpec:r}));return g}return s.a0(t)?[]:[new s.V("projection",t,`object or string expected, ${s.K(t)} found`)]},import:function(u){const t=u.key,{value:r,styleSpec:h}=u;if(!s.H(r))return[new s.V(t,r,"import must be an object")];const{data:p,...g}=r;Object.defineProperty(g,"__line__",{value:r.__line__,enumerable:!1});let y=Lr(Object.assign({},u,{value:g,valueSpec:h.import}));return s.J(g.id)===""&&y.push(new s.V(`${u.key}.id`,g,"import id can't be an empty string")),p&&(y=y.concat(Cl(p,h,{key:`${u.key}.data`}))),y},iconset:function(u){const t=u.value,r=u.key,h=u.styleSpec,p=u.style;if(!s.H(t))return[new s.V(r,t,"object expected")];if(!t.type)return[new s.V(r,t,'"type" is required')];const g=s.J(t.type);let y=[];if(y=y.concat(Lr({key:r,value:t,valueSpec:h[`iconset_${g}`],style:p,styleSpec:h})),function(w,T){return!(w!=="source"||!T.source)}(g,t)){const w=p.sources&&p.sources[t.source],T=w&&s.J(w.type);w?T!=="raster-array"&&y.push(new s.V(r,t.source,`iconset cannot be used with a source of type ${String(T)}, it only be used with a "raster-array" source type`)):y.push(new s.V(r,t.source,`source "${t.source}" not found`))}return y}};function Rn(u,t=!1){const r=u.value,h=u.valueSpec,p=u.styleSpec;if(h.expression){if(s.a4(s.J(r)))return Ha(u);if(s.Q(s.S(r)))return Ur(u)}if(h.type&&Al[h.type]){const g=Al[h.type](u);return t===!0&&g.length>0&&Array.isArray(u.value)?Ur(u):g}return Lr(Object.assign({},u,{valueSpec:h.type?p[h.type]:h}))}function Lr(u){const t=u.key,r=u.value,h=u.valueSpec||{},p=u.objectElementValidators||{},g=u.style,y=u.styleSpec;if(!s.H(r))return[new s.V(t,r,`object expected, ${s.K(r)} found`)];let w=[];for(const T in r){const A=T.split(".")[0];let M;p[A]?M=p[A]:h[A]?M=Rn:p["*"]?M=p["*"]:h["*"]&&(M=Rn),M?w=w.concat(M({key:(t&&`${t}.`)+T,value:r[T],valueSpec:h[A]||h["*"],style:g,styleSpec:y,object:r,objectKey:T},r)):w.push(new s.a3(t,r[T],`unknown property "${T}"`))}for(const T in h){if(p[T])continue;const A=h[T];A.required&&A.default===void 0&&r[T]===void 0&&w.push(new s.V(t,r,`missing required property "${T}"`))}return w}function Fh({key:u,value:t}){const r=Ir({key:u,value:t});if(r.length)return r;const h=t;return h.indexOf("{fontstack}")===-1&&r.push(new s.V(u,t,'"glyphs" url must include a "{fontstack}" token')),h.indexOf("{range}")===-1&&r.push(new s.V(u,t,'"glyphs" url must include a "{range}" token')),r}function Cl(u,t=s.a6,r={}){return Lr({key:r.key||"",value:u,valueSpec:Object.assign(t.$root,{"*":{type:"*"}}),styleSpec:t,style:u,objectElementValidators:{glyphs:Fh}})}function fs(u,t=s.a6){return q(Cl(u,t))}const Bh=u=>q(wu(u)),et=u=>q(Ls(u)),sa=u=>q(oa(u)),dp=u=>q(ds(u)),Pl=u=>q(bu(u)),Oi=u=>q(function(t){const r=t.value,h=t.style,p=t.styleSpec,g=p.snow;if(r===void 0)return[];if(!s.H(r))return[new s.V("snow",r,`object expected, ${s.K(r)} found`)];let y=[];for(const w in r){const T=w.match(/^(.*)-transition$/);y=y.concat(T&&g[T[1]]&&g[T[1]].transition?Rn({key:w,value:r[w],valueSpec:p.transition,style:h,styleSpec:p}):g[w]?Rn({key:w,value:r[w],valueSpec:g[w],style:h,styleSpec:p}):[new s.a3(w,r[w],`unknown property "${w}"`)])}return y}(u)),Kr=u=>q(function(t){const r=t.value,h=t.style,p=t.styleSpec,g=p.rain;if(r===void 0)return[];if(!s.H(r))return[new s.V("rain",r,`object expected, ${s.K(r)} found`)];let y=[];for(const w in r){const T=w.match(/^(.*)-transition$/);y=y.concat(T&&g[T[1]]&&g[T[1]].transition?Rn({key:w,value:r[w],valueSpec:p.transition,style:h,styleSpec:p}):g[w]?Rn({key:w,value:r[w],valueSpec:g[w],style:h,styleSpec:p}):[new s.a3(w,r[w],`unknown property "${w}"`)])}return y}(u)),fp=u=>q(_c(u)),Ml=u=>q(ra(u)),Tu=u=>q(El(u)),Ie=u=>q(Il(u)),V=u=>q(s.a7(u));function q(u){return u.slice().sort((t,r)=>t.line&&r.line?t.line-r.line:0)}function ee(u,t){let r=!1;if(t&&t.length)for(const h of t)h instanceof s.a3?s.w(h.message):(u.fire(new s.y(new Error(h.message))),r=!0);return r}const pe=s.a6.light;let de;class ve extends s.E{constructor(t,r="flat"){super(),this._transitionable=new s.a8(de||(de=new s.a9({anchor:new s.aa(pe.anchor),position:new s.ab(pe.position),color:new s.aa(pe.color),intensity:new s.aa(pe.intensity)}))),this.setLight(t,r),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(t,r,h={}){this._validate(et,t,h)||(this._transitionable.setTransitionOrValue(t),this.id=r)}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,r,h){return(!h||h.validate!==!1)&&ee(this,t.call(fs,Object.assign({value:r,style:{glyphs:!0,sprite:!0},styleSpec:s.a6})))}}const Le=s.a6.terrain;let Te=class extends s.E{constructor(u,t,r,h,p){super(),this.scope=r,this._transitionable=new s.a8(new s.a9({source:new s.aa(Le.source),exaggeration:new s.aa(Le.exaggeration)}),r,h),this._transitionable.setTransitionOrValue(u,h),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=t,this.worldview=p}get(){return this._transitionable.serialize()}set(u,t){this._transitionable.setTransitionOrValue(u,t)}updateTransitions(u){this._transitioning=this._transitionable.transitioned(u,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(u){this.properties=this._transitioning.possiblyEvaluate(u)}getExaggeration(u){return this._transitioning.possiblyEvaluate(new s.ac(u,{worldview:this.worldview})).get("exaggeration")}getAttenuationRange(){if(!this.isZoomDependent())return null;const u=this._transitionable._values.exaggeration;if(!u)return null;const t=u.value.expression;if(!t)return null;let r=-1,h=-1,p=1;for(const g of t.zoomStops)p=t.evaluate(new s.ac(g,{worldview:this.worldview})),p>.01?(r=g,h=-1):h=g;return p<.01&&r>0&&h>r?[r,h]:null}isZoomDependent(){const u=this._transitionable._values.exaggeration;return u!=null&&u.value!=null&&u.value.expression!=null&&u.value.expression instanceof s.ad}};const ke=45,rt=65,Ge=.05;function Et(u,t,r,h){const p=s.ah(ke,rt,r),[g,y]=jt(u,h);let w=1-Math.min(1,Math.exp((t-g)/(y-g)*-6));return w*=w*w,w=Math.min(1,1.00747*w),w*p*u.alpha}function jt(u,t){const r=.5/Math.tan(.5*t);return[u.range[0]+r,u.range[1]+r]}function bt(u,t,r,h,p){const g=s.af([],[t,r,h],p.mercatorFogMatrix);return Et(u,s.ag(g),p.pitch,p._fov)}function li(u,t,r,h,p,g,y){const w=[[r,h,0],[p,h,0],[p,g,0],[r,g,0]];let T=Number.MAX_VALUE,A=-Number.MAX_VALUE;for(const M of w){const z=s.af([],M,t),L=s.ag(z);T=Math.min(T,L),A=Math.max(A,L)}return[Et(u,T,y.pitch,y._fov),Et(u,A,y.pitch,y._fov)]}const si=s.a6.fog;class ri extends s.E{constructor(t,r,h,p){super();const g=new s.a9({range:new s.aa(si.range),color:new s.aa(si.color),"color-use-theme":new s.aa({type:"string","property-type":"data-constant",default:"default"}),"high-color":new s.aa(si["high-color"]),"high-color-use-theme":new s.aa({type:"string","property-type":"data-constant",default:"default"}),"space-color":new s.aa(si["space-color"]),"space-color-use-theme":new s.aa({type:"string","property-type":"data-constant",default:"default"}),"horizon-blend":new s.aa(si["horizon-blend"]),"star-intensity":new s.aa(si["star-intensity"]),"vertical-range":new s.aa(si["vertical-range"])});this._transitionable=new s.a8(g,h,new Map(p)),this.set(t,p),this._transitioning=this._transitionable.untransitioned(),this._transform=r,this.properties=new s.ai(g),this.scope=h}get state(){const t=this._transform,r=t.projection.name==="globe",h=s.aj(t.zoom),p=this.properties.get("range"),g=[.5,3];return{range:r?[s.ak(g[0],p[0],h),s.ak(g[1],p[1],h)]:p,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(t,r,h={}){if(this._validate(Pl,t,h))return;const p=Object.assign({},t);for(const g of Object.keys(si))p[g]===void 0&&(p[g]=si[g].default);this._options=p,this._transitionable.setTransitionOrValue(this._options,r)}getOpacity(t){if(!this._transform.projection.supportsFog)return 0;const r=this.properties&&this.properties.get("color")||1;return(this._transform.projection.name==="globe"?1:s.ah(ke,rt,t))*r.a}getOpacityAtLatLng(t,r){return this._transform.projection.supportsFog?function(h,p,g){const y=s.ae.fromLngLat(p),w=g.elevation?g.elevation.getAtPointOrZero(y):0;return bt(h,y.x,y.y,w,g)}(this.state,t,r):0}getOpacityForTile(t){if(!this._transform.projection.supportsFog)return[1,1];const r=this._transform.calculateFogTileMatrix(t.toUnwrapped());return li(this.state,r,0,0,s.al,s.al,this._transform)}getOpacityForBounds(t,r,h,p,g){return this._transform.projection.supportsFog?li(this.state,t,r,h,p,g,this._transform):[1,1]}getFovAdjustedRange(t){return this._transform.projection.supportsFog?jt(this.state,t):[0,1]}isVisibleOnFrustum(t){if(!this._transform.projection.supportsFog)return!1;const r=[4,5,6,7];for(const h of r){const p=t.points[h];let g;if(p[2]>=0)g=p;else{const y=t.points[h-4];g=s.am(y,p,y[2]/(y[2]-p[2]))}if(bt(this.state,g[0],g[1],0,this._transform)>=Ge)return!0}return!1}updateConfig(t){this._transitionable.setTransitionOrValue(this._options,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,r,h){return(!h||h.validate!==!1)&&ee(this,t.call(fs,Object.assign({value:r,style:{glyphs:!0,sprite:!0},styleSpec:s.a6})))}}let Ii,Fn,er,Vn,rr=class extends s.E{constructor(u,t,r,h){super();const p=Ii||(Ii=new s.a9({density:new s.aa(s.a6.snow.density),intensity:new s.aa(s.a6.snow.intensity),color:new s.aa(s.a6.snow.color),opacity:new s.aa(s.a6.snow.opacity),vignette:new s.aa(s.a6.snow.vignette),"vignette-color":new s.aa(s.a6.snow["vignette-color"]),"center-thinning":new s.aa(s.a6.snow["center-thinning"]),direction:new s.aa(s.a6.snow.direction),"flake-size":new s.aa(s.a6.snow["flake-size"])}));this._transitionable=new s.a8(p,r,new Map(h)),this.set(u,h),this._transitioning=this._transitionable.untransitioned(),this.properties=new s.ai(p),this.scope=r}get state(){const u=this.properties.get("opacity"),t=this.properties.get("color"),r=this.properties.get("direction"),h=s.an(r[0]),p=-Math.max(s.an(r[1]),.01),g=[Math.cos(h)*Math.cos(p),Math.sin(h)*Math.cos(p),Math.sin(p)],y=this.properties.get("vignette"),w=this.properties.get("vignette-color");return w.a=y,{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new s.ao(t.r,t.g,t.b,t.a*u),direction:g,centerThinning:this.properties.get("center-thinning"),flakeSize:this.properties.get("flake-size"),vignetteColor:w}}get(){return this._transitionable.serialize()}set(u,t,r={}){if(this._validate(Oi,u,r))return;const h=Object.assign({},u),p=s.a6.snow;for(const g of Object.keys(p))h[g]===void 0&&(h[g]=p[g].default);this._options=h,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(u){this._transitionable.setTransitionOrValue(this._options,new Map(u))}updateTransitions(u){this._transitioning=this._transitionable.transitioned(u,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(u){this.properties=this._transitioning.possiblyEvaluate(u)}_validate(u,t,r){return(!r||r.validate!==!1)&&ee(this,u.call(fs,Object.assign({value:t,style:{glyphs:!0,sprite:!0},styleSpec:s.a6})))}},kn=class extends s.E{constructor(u,t,r,h){super();const p=Fn||(Fn=new s.a9({density:new s.aa(s.a6.rain.density),intensity:new s.aa(s.a6.rain.intensity),color:new s.aa(s.a6.rain.color),opacity:new s.aa(s.a6.rain.opacity),vignette:new s.aa(s.a6.rain.vignette),"vignette-color":new s.aa(s.a6.rain["vignette-color"]),"center-thinning":new s.aa(s.a6.rain["center-thinning"]),direction:new s.aa(s.a6.rain.direction),"droplet-size":new s.aa(s.a6.rain["droplet-size"]),"distortion-strength":new s.aa(s.a6.rain["distortion-strength"])}));this._transitionable=new s.a8(p,r,new Map(h)),this.set(u,h),this._transitioning=this._transitionable.untransitioned(),this.properties=new s.ai(p),this.scope=r}get state(){const u=this.properties.get("opacity"),t=this.properties.get("color"),r=this.properties.get("direction"),h=s.an(r[0]),p=-Math.max(s.an(r[1]),.01),g=[Math.cos(h)*Math.cos(p),Math.sin(h)*Math.cos(p),Math.sin(p)],y=this.properties.get("vignette-color");return y.a=this.properties.get("vignette"),{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new s.ao(t.r,t.g,t.b,t.a*u),direction:g,centerThinning:this.properties.get("center-thinning"),dropletSize:this.properties.get("droplet-size"),distortionStrength:this.properties.get("distortion-strength"),vignetteColor:y}}get(){return this._transitionable.serialize()}set(u,t,r={}){if(this._validate(Kr,u,r))return;const h=Object.assign({},u),p=s.a6.rain;for(const g of Object.keys(p))h[g]===void 0&&(h[g]=p[g].default);this._options=h,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(u){this._transitionable.setTransitionOrValue(this._options,new Map(u))}updateTransitions(u){this._transitioning=this._transitionable.transitioned(u,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(u){this.properties=this._transitioning.possiblyEvaluate(u)}_validate(u,t,r){return(!r||r.validate!==!1)&&ee(this,u.call(fs,Object.assign({value:t,style:{glyphs:!0,sprite:!0},styleSpec:s.a6})))}};class Li extends s.E{constructor(t,r,h,p){super(),this.scope=h,this._options=t,this.properties=new s.ai(r),this._transitionable=new s.a8(r,h,new Map(p)),this._transitionable.setTransitionOrValue(t.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(t){this._transitionable.setTransitionOrValue(this._options.properties,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(t,r){this._options=t,this._transitionable.setTransitionOrValue(t.properties,r)}shadowsEnabled(){return!!this.properties&&this.properties.get("cast-shadows")===!0}}class Ln{constructor(t,r,h){this.screenBounds=t,this.cameraPoint=h.getCameraPoint(),this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=r,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,h)}static createFromScreenPoints(t,r){let h,p;if(t instanceof s.P||typeof t[0]=="number"){const g=s.P.convert(t);h=[g],p=r.isPointAboveHorizon(g)}else{const g=s.P.convert(t[0]),y=s.P.convert(t[1]),w=g.add(y)._div(2);h=[g,y],p=s.aq(g,y).every(T=>r.isPointAboveHorizon(T))&&r.isPointAboveHorizon(w)}return new Ln(h,p,r)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(t){return s.aq(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],t)}bufferedCameraGeometry(t){const r=this.screenBounds[0],h=this.screenBounds.length===1?this.screenBounds[0].add(new s.P(1,1)):this.screenBounds[1],p=s.aq(r,h,0,!1);return this.cameraPoint.y>h.y&&(this.cameraPoint.x>r.x&&this.cameraPoint.x<h.x?p.splice(3,0,this.cameraPoint):this.cameraPoint.x>=h.x?p[2]=this.cameraPoint:this.cameraPoint.x<=r.x&&(p[3]=this.cameraPoint)),s.ar(p,t)}bufferedCameraGeometryGlobe(t){const r=this.screenBounds[0],h=this.screenBounds.length===1?this.screenBounds[0].add(new s.P(1,1)):this.screenBounds[1],p=s.aq(r,h,t),g=this.cameraPoint.clone();switch(3*((g.y>r.y)+(g.y>h.y))+((g.x>r.x)+(g.x>h.x))){case 0:p[0]=g,p[4]=g.clone();break;case 1:p.splice(1,0,g);break;case 2:p[1]=g;break;case 3:p.splice(4,0,g);break;case 5:p.splice(2,0,g);break;case 6:p[3]=g;break;case 7:p.splice(3,0,g);break;case 8:p[2]=g}return p}containsTile(t,r,h,p=0){const g=Math.max(t.queryPadding,t.evaluateQueryRenderedFeaturePadding())/r._pixelsPerMercatorPixel+1,y=h?this._bufferedCameraMercator(g,r):this._bufferedScreenMercator(g,r);let w=t.tileID.wrap+(y.unwrapped?p:0);const T=y.polygon.map(G=>s.as(t.tileTransform,G,w));if(!s.at(T,0,0,s.al,s.al))return;w=t.tileID.wrap+(this.screenGeometryMercator.unwrapped?p:0);const A=this.screenGeometryMercator.polygon.map(G=>s.au(t.tileTransform,G,w)),M=A.map(G=>new s.P(G[0],G[1])),z=r.getFreeCameraOptions().position||new s.ae(0,0,0),L=s.au(t.tileTransform,z,w),D=A.map(G=>{const $=s.av(G,G,L);return s.aw($,$),new s.ax(L,$)}),N=s.ay(t,1,r.zoom)*r._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:M,tilespaceRays:D,bufferedTilespaceGeometry:T,bufferedTilespaceBounds:(B=s.az(T),B.min.x=s.aA(B.min.x,0,s.al),B.min.y=s.aA(B.min.y,0,s.al),B.max.x=s.aA(B.max.x,0,s.al),B.max.y=s.aA(B.max.y,0,s.al),B),tile:t,tileID:t.tileID,pixelToTileUnitsFactor:N};var B}_bufferedScreenMercator(t,r){const h=$n(t);if(this._screenRaycastCache[h])return this._screenRaycastCache[h];{let p;return p=r.projection.name==="globe"?this._projectAndResample(this.bufferedScreenGeometry(t),r):{polygon:this.bufferedScreenGeometry(t).map(g=>r.pointCoordinate3D(g)),unwrapped:!0},this._screenRaycastCache[h]=p,p}}_bufferedCameraMercator(t,r){const h=$n(t);if(this._cameraRaycastCache[h])return this._cameraRaycastCache[h];{let p;return p=r.projection.name==="globe"?this._projectAndResample(this.bufferedCameraGeometryGlobe(t),r):{polygon:this.bufferedCameraGeometry(t).map(g=>r.pointCoordinate3D(g)),unwrapped:!0},this._cameraRaycastCache[h]=p,p}}_projectAndResample(t,r){const h=function(g,y){const w=s.aB([],y.pixelMatrix,y.globeMatrix),T=[0,-s.aD,0,1],A=[0,s.aD,0,1],M=[0,0,0,1];s.aC(T,T,w),s.aC(A,A,w),s.aC(M,M,w);const z=new s.P(T[0]/T[3],T[1]/T[3]),L=new s.P(A[0]/A[3],A[1]/A[3]),D=s.aE(g,z)&&T[3]<M[3],N=s.aE(g,L)&&A[3]<M[3];if(!D&&!N)return null;const B=function(le,re,te){for(let he=1;he<le.length;he++){const we=xi(re.pointCoordinate3D(le[he-1]).x),ye=xi(re.pointCoordinate3D(le[he]).x);if(te<0){if(we<ye)return{idx:he,t:-we/(ye-1-we)}}else if(ye<we)return{idx:he,t:(1-we)/(ye+1-we)}}return null}(g,y,D?-1:1);if(!B)return null;const{idx:G,t:$}=B;let X=G>1?an(g.slice(0,G),y):[],J=G<g.length?an(g.slice(G),y):[];X=X.map(le=>new s.P(xi(le.x),le.y)),J=J.map(le=>new s.P(xi(le.x),le.y));const K=[...X];K.length===0&&K.push(J[J.length-1]);const ue=s.ak(K[K.length-1].y,(J.length===0?X[0]:J[0]).y,$);let oe;return oe=D?[new s.P(0,ue),new s.P(0,0),new s.P(1,0),new s.P(1,ue)]:[new s.P(1,ue),new s.P(1,1),new s.P(0,1),new s.P(0,ue)],K.push(...oe),J.length===0?K.push(X[0]):K.push(...J),{polygon:K.map(le=>new s.ae(le.x,le.y)),unwrapped:!1}}(t,r);if(h)return h;const p=function(g,y){let w=!1,T=-1/0,A=0;for(let z=0;z<g.length-1;z++)g[z].x>T&&(T=g[z].x,A=z);for(let z=0;z<g.length-1;z++){const L=(A+z)%(g.length-1),D=g[L],N=g[L+1];Math.abs(D.x-N.x)>.5&&(D.x<N.x?(D.x+=1,L===0&&(g[g.length-1].x+=1)):(N.x+=1,L+1===g.length-1&&(g[0].x+=1)),w=!0)}const M=s.aF(y.center.lng);return w&&M<Math.abs(M-1)&&g.forEach(z=>{z.x-=1}),{polygon:g,unwrapped:w}}(an(t,r).map(g=>new s.P(xi(g.x),g.y)),r);return{polygon:p.polygon.map(g=>new s.ae(g.x,g.y)),unwrapped:p.unwrapped}}}function an(u,t){return s.aG(u,r=>{const h=t.pointCoordinate3D(r);r.x=h.x,r.y=h.y},1/256)}function xi(u){return u<0?1+u%1:u%1}function $n(u){return 100*u|0}function Or(u,t,r,h,p){const g=function(w,T){if(w)return p(w);if(T){if(u.url&&T.tiles&&u.tiles&&delete u.tiles,T.variants){if(!Array.isArray(T.variants))return p(new Error("variants must be an array"));for(const M of T.variants){if(M==null||typeof M!="object"||M.constructor!==Object)return p(new Error("variant must be an object"));if(!Array.isArray(M.capabilities))return p(new Error("capabilities must be an array"));if(M.capabilities.length===1&&M.capabilities[0]==="meshopt"){T=Object.assign(T,M);break}}}const A=s.aH(Object.assign({},T,u),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","extra_bounds","scheme","tileSize","encoding","vector_layers","raster_layers","worldview_options","worldview_default","worldview"]);A.tiles=t.canonicalizeTileset(A,u.url),p(null,A)}},y=function(w,T,A){if(!w)return null;if(!T&&!A)return w;A=A||w.worldview_default;const M=Object.values(w.language||{});if(M.length===0)return null;const z=Object.values(w.worldview||{});if(z.length===0)return null;const L=M.every(N=>N===T),D=z.every(N=>N===A);return L&&D?w:T in(w.language_options||{})||A in(w.worldview_options||{})?null:w.language_options&&w.worldview_options?w:null}(u.data,r,h);return y?s.o.frame(()=>g(null,y)):u.url?s.m(t.transformRequest(t.normalizeSourceURL(u.url,null,r,h),s.R.Source),g):s.o.frame(()=>{const{data:w,...T}=u;g(null,T)})}function Vr(u,t){const r=Math.pow(2,t.z),h=Math.floor(s.aF(u.getWest())*r),p=Math.floor(s.aJ(u.getNorth())*r),g=Math.ceil(s.aF(u.getEast())*r),y=Math.ceil(s.aJ(u.getSouth())*r);return t.x>=h&&t.x<g&&t.y>=p&&t.y<y}class mo{constructor(t,r,h){this.bounds=t?s.aI.convert(this.validateBounds(t)):null,this.minzoom=r||0,this.maxzoom=h||24}validateBounds(t){return Array.isArray(t)&&t.length===4?[Math.max(-180,t[0]),Math.max(-90,t[1]),Math.min(180,t[2]),Math.min(90,t[3])]:[-180,-90,180,90]}addExtraBounds(t){if(t){this.extraBounds||(this.extraBounds=[]);for(const r of t)this.extraBounds.push(s.aI.convert(this.validateBounds(r)))}}contains(t){if(t.z>this.maxzoom||t.z<this.minzoom||this.bounds&&!Vr(this.bounds,t))return!1;if(!this.extraBounds)return!0;for(const r of this.extraBounds)if(Vr(r,t))return!0;return!1}static fromTileJSON(t){if(!t.bounds&&!t.extra_bounds)return null;const r=new mo(t.bounds,t.minzoom,t.maxzoom);return r.addExtraBounds(t.extra_bounds),r}}class Rl extends s.E{constructor(t,r,h,p){if(super(),this.id=t,this.dispatcher=h,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,Object.assign(this,s.aH(r,["url","scheme","tileSize","promoteId"])),this._options=Object.assign({type:"vector"},r),this._collectResourceTiming=!!r.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(p),this._tileWorkers={},this._deduped=new s.aK}load(t){this._loaded=!1,this.fire(new s.z("dataloading",{dataType:"source"}));const r=Array.isArray(this.map._language)?this.map._language.join():this.map._language,h=this.map.getWorldview();this._tileJSONRequest=Or(this._options,this.map._requestManager,r,h,(p,g)=>{if(this._tileJSONRequest=null,this._loaded=!0,p)r&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${r}`),h&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${h}`),this.fire(new s.y(p));else if(g){if(Object.assign(this,g),this.hasWorldviews=!!g.worldview_options,g.worldview_default&&(this.worldviewDefault=g.worldview_default),g.vector_layers){this.vectorLayers=g.vector_layers,this.vectorLayerIds=[],this.localizableLayerIds=new Set;for(const y of g.vector_layers)this.vectorLayerIds.push(y.id),g.worldview&&g.worldview[y.source]&&this.localizableLayerIds.add(y.id)}this.tileBounds=mo.fromTileJSON(g),gn(g.tiles,this.map._requestManager._customAccessToken),this.fire(new s.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.z("data",{dataType:"source",sourceDataType:"content"}))}t&&t(p)})}loaded(){return this._loaded}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();const t=s.B(this.id,this.scope);this.load(()=>this.map.style.clearSource(t))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return Object.assign({},this._options)}loadTile(t,r){const h=t.tileID.canonical.url(this.tiles,this.scheme),p=this.map._requestManager.normalizeTileURL(h),g=this.map._requestManager.transformRequest(p,s.R.Tile),y=this.map.style?this.map.style.getLut(this.scope):null,w=y?{image:y.image.clone()}:null,T={request:g,data:void 0,uid:t.uid,tileID:t.tileID,tileZoom:t.tileZoom,zoom:t.tileID.overscaledZ,maxZoom:this.maxzoom,lut:w,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:s.o.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:t.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:t.isExtraShadowCaster,tessellationStep:this.map._tessellationStep,scaleFactor:this.map.getScaleFactor(),worldview:this.map.getWorldview()||this.worldviewDefault,indoor:this.map.indoor?this.map.indoor.getIndoorTileOptions(this.id,this.scope):null};if(this.hasWorldviews&&s.h(h)&&(T.localizableLayerIds=this.localizableLayerIds),T.request.collectResourceTiming=this._collectResourceTiming,t.actor&&t.state!=="expired")t.state==="loading"?t.reloadCallback=r:t.request=t.actor.send("reloadTile",T,A.bind(this));else if(t.actor=this._tileWorkers[p]=this._tileWorkers[p]||this.dispatcher.getActor(),this.dispatcher.ready)t.request=t.actor.send("loadTile",T,A.bind(this),void 0,!0);else{const M=s.aL.call({deduped:this._deduped},T,(z,L)=>{if(z||!L)A.call(this,z);else{const D=s.aM(L.responseHeaders);T.data={rawData:L.rawData.slice(0),expires:D.expires,cacheControl:D.cacheControl},t.actor&&t.actor.send("loadTile",T,A.bind(this),void 0,!0)}},!0);t.request={cancel:M}}function A(M,z){return delete t.request,t.aborted?r(null):M&&M instanceof s.aN&&M.status!==404?r(M):(z&&z.resourceTiming&&(t.resourceTiming=z.resourceTiming),this.map._refreshExpiredTiles&&z&&t.setExpiryData(z),t.loadVectorData(z,this.map.painter),s.aO(this.dispatcher),r(null,z),void(t.reloadCallback&&(this.loadTile(t,t.reloadCallback),t.reloadCallback=null)))}}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t,r){t.actor&&t.actor.send("removeTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope}),t.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class Ar extends s.E{constructor(t,r,h,p){super(),this.id=t,this.dispatcher=h,this.setEventedParent(p),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=Object.assign({type:"raster"},r),Object.assign(this,s.aH(r,["url","scheme","tileSize"]))}load(t){this._loaded=!1,this.fire(new s.z("dataloading",{dataType:"source"}));const r=this.map.getWorldview();this._tileJSONRequest=Or(this._options,this.map._requestManager,null,r,(h,p)=>{this._tileJSONRequest=null,this._loaded=!0,h?this.fire(new s.y(h)):p&&(Object.assign(this,p),p.raster_layers&&(this.rasterLayers=p.raster_layers,this.rasterLayerIds=this.rasterLayers.map(g=>g.id)),this.tileBounds=mo.fromTileJSON(p),gn(p.tiles),this.fire(new s.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.z("data",{dataType:"source",sourceDataType:"content"}))),t&&t(h)})}loaded(){return this._loaded}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();const t=s.B(this.id,this.scope);this.load(()=>this.map.style.clearSource(t))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return Object.assign({},this._options)}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}loadTile(t,r){const h=s.o.devicePixelRatio>=2,p=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),h,this.tileSize);t.request=s.n(this.map._requestManager.transformRequest(p,s.R.Tile),(g,y,w)=>{if(delete t.request,t.aborted)return t.state="unloaded",r(null);if(g)return t.state="errored",r(g);if(!y)return r(null);const T=s.aM(w);this.map._refreshExpiredTiles&&t.setExpiryData(T),t.setTexture(y,this.map.painter),t.state="loaded",s.aO(this.dispatcher),r(null)})}abortTile(t,r){t.request&&(t.request.cancel(),delete t.request),r&&r()}unloadTile(t,r){t.texture&&t.texture instanceof s.T?(t.destroy(!1),t.texture&&t.texture instanceof s.T&&this.map.painter.saveTileTexture(t.texture)):t.destroy(),r&&r()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}function zo([u,t],r,h,{scaled:p=!0}={}){const{tileSize:g,buffer:y}=h,{x:w,y:T,z:A}=r;if(!isFinite(w)||!isFinite(T)||!isFinite(A))throw new Error("Invalid MRT header");const M=2**A,z=M*s.aF(u),L=M*s.aJ(t);return function([D,N],B,{scaled:G=!0}={}){if(!B)throw new Error("bandView is undefined");const{data:$,tileSize:X,buffer:J,offset:K,scale:ue,dimension:oe}=B;if(D<-J||D>X+J||N<-J||N>X+J)throw new Error(`Point (${D}, ${N}) out of bounds for tileSize=${X}, buffer=${J}`);const le=(N+J)*(X+2*J)+(D+J);if(new Uint32Array($.buffer)[le]===4294967295)return null;let re=[];re=G?[]:new B.data.constructor(oe);for(let te=0;te<oe;te++)re[te]=Math.round(1e12*($[oe*le+te]*ue+K))/1e12;return re}([Math.min(Math.max(-y,Math.floor((z-w)*g)),g-1+y),Math.min(Math.max(-y,Math.floor((L-T)*g)),g-1+y)],h,{scaled:p})}class Yr extends Ar{constructor(t,r,h,p){super(t,r,h,p),this.type="raster-array",this.maxzoom=22,this.partial=!0,this._loadTilePending={},this._loadTileLoaded={},this._options=Object.assign({type:"raster-array"},r)}triggerRepaint(t){const r=this.map.painter._terrain,h=this.map.style.getSourceCache(this.id);r&&r.enabled&&h&&r._clearRenderCacheForTile(h.id,t.tileID),this.map.triggerRepaint()}loadTile(t,r){const h=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),p=this.map._requestManager.transformRequest(h,s.R.Tile),g={request:p,uid:t.uid,tileID:t.tileID,type:this.type,source:this.id,scope:this.scope,partial:this.partial};t.source=this.id,t.scope=this.scope,t.requestParams=p,t.actor||(t.actor=this.dispatcher.getActor());const y=(w,T,A)=>{if(delete t.request,t.aborted)return t.state="unloaded",r(null);if(w)return w.name==="AbortError"?void 0:(t.state="errored",r(w));if(this.map._refreshExpiredTiles&&T){const M=s.aM(A);t.setExpiryData(M)}if(this.partial&&t.state!=="expired")t.state="empty";else if(!this.partial){if(!T)return r(null);t.state="loaded",t._isHeaderLoaded=!0,t._mrt=T}r(null)};t.request=this.partial?t.fetchHeader(void 0,y.bind(this)):t.actor.send("loadTile",g,y.bind(this),void 0,!0)}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t,r){const h=t.texturePerLayer;if(t.flushAllQueues(),h.size){t.destroy(!1);for(const p of h.values())this.map.painter.saveTileTexture(p)}else t.destroy()}prepareTile(t,r,h,p){t._isHeaderLoaded&&(t.state!=="empty"&&(t.state="reloading"),t.fetchBandForRender(r,h,p,(g,y)=>{if(g)return t.state="errored",this.fire(new s.y(g)),void this.triggerRepaint(t);y&&(t._isHeaderLoaded=!0,t.setTexturePerLayer(h,y,this.map.painter),t.state="loaded",this.triggerRepaint(t))}))}getInitialBand(t){if(!this.rasterLayers)return 0;const r=this.rasterLayers.find(({id:g})=>g===t),h=r&&r.fields,p=h&&h.bands&&h.bands;return p?p[0]:0}getTextureDescriptor(t,r,h){if(!t)return;const p=r.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!p)return;let g=null;r instanceof s.aR?g=r.paint.get("raster-array-band"):r instanceof s.aS&&(g=r.paint.get("raster-particle-array-band"));const y=g||this.getInitialBand(p);if(y==null)return;if(!t.textureDescriptorPerLayer.get(r.id))return void this.prepareTile(t,p,r.id,y);if(t.updateNeeded(r.id,y)&&!h)return;const w=t.textureDescriptorPerLayer.get(r.id);return Object.assign({},w,{texture:t.texturePerLayer.get(r.id)})}getImages(t,r){const h=new Map;for(const p of t)for(const g of r){const[y,w]=g.split("/"),T=p.getLayer(y);if(!T||!T.hasBand(w)||!T.hasDataForBand(w))continue;const{bytes:A,tileSize:M,buffer:z}=T.getBandView(w),L=M+2*z,D={data:new s.q({width:L,height:L},A),pixelRatio:2,sdf:!1,usvg:!1,version:0};h.set(g,D)}return h}queryRasterArrayValueByBandId(t,r,h){const p=r._mrt;return new Promise(g=>{const y={},w=new Set;for(const[T,A]of Object.entries(p.layers)){if(h.layerName&&T!==h.layerName)continue;const M={};y[T]=M;for(const{bands:z}of A.dataIndex)for(const L of z)h.bands&&!h.bands.includes(L)||(w.add(s.B(T,L)),r.fetchBand(T,null,L,D=>{s.o.frame(()=>{M[L]=D?null:zo([t.lng,t.lat],p,A.getBandView(L)),w.delete(s.B(T,L)),w.size===0&&g(y)})},!1))}w.size===0&&g(y)})}_loadTileForQuery(t,r){if(this._loadTileLoaded[t.uid])return void r(null,t._mrt);if(this._loadTilePending[t.uid])return void this._loadTilePending[t.uid].push(r);this._loadTilePending[t.uid]=[r];const h=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),p=this.map._requestManager.transformRequest(h,s.R.Tile);t.actor.send("loadTile",{request:p,uid:t.uid,tileID:t.tileID,type:this.type,source:this.id,scope:this.scope,partial:!1},(g,y,w)=>{if(g)return this._loadTilePending[t.uid].forEach(T=>T(g,null)),void delete this._loadTilePending[t.uid];if(!y)return this._loadTilePending[t.uid].forEach(T=>T(null,null)),void delete this._loadTilePending[t.uid];if(this.map._refreshExpiredTiles&&y){const T=s.aM(w);t.setExpiryData(T)}t._mrt=y,t._isHeaderLoaded=!0,t.state="loaded",this._loadTilePending[t.uid].forEach(T=>T(null,y)),this._loadTileLoaded[t.uid]=!0,delete this._loadTilePending[t.uid]},void 0,!0)}queryRasterArrayValueByAllBands(t,r,h){return new Promise((p,g)=>{this._loadTileForQuery(r,(y,w)=>{y?g(y):p(w?this.queryRasterArrayValueByBandId(t,r,h):null)})})}queryRasterArrayValue(t,r){const h=s.aT.convert(t),p=this.findLoadedParent(h);return p&&p._mrt?r.bands||!this.partial?this.queryRasterArrayValueByBandId(h,p,r):this.queryRasterArrayValueByAllBands(h,p,r):Promise.resolve(null)}findLoadedParent(t){const r=s.ae.fromLngLat(t,this.map.transform.tileSize),h=this.maxzoom+1,p=1<<h,g=Math.floor(r.x),y=Math.floor((r.x-g)*p),w=Math.floor(r.y*p),T=this.map.style.getSourceCache(this.id),A=new s.aQ(h,g,h,y,w);return T.findLoadedParent(A,this.minzoom)}}const zs={vector:Rl,raster:Ar,"raster-dem":class extends Ar{constructor(u,t,r,h){super(u,t,r,h),this.type="raster-dem",this.maxzoom=22,this._options=Object.assign({type:"raster-dem"},t),this.encoding=t.encoding||"mapbox"}loadTile(u,t){const r=this.map._requestManager.normalizeTileURL(u.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function h(p,g){p&&(u.state="errored",t(p)),g&&(u.dem=g,u.dem.onDeserialize(),u.needsHillshadePrepare=!0,u.needsDEMTextureUpload=!0,u.state="loaded",t(null))}u.request=s.n(this.map._requestManager.transformRequest(r,s.R.Tile),(function(p,g,y){if(delete u.request,u.aborted)u.state="unloaded",t(null);else if(p)u.state="errored",t(p);else if(g){const w=s.aM(y);this.map._refreshExpiredTiles&&u.setExpiryData(w);const T=ImageBitmap&&g instanceof ImageBitmap&&s.r(),A=1-(g.width-s.aP(g.width))/2;A<1||u.neighboringTiles||(u.neighboringTiles=this._getNeighboringTiles(u.tileID));const M=T?g:s.o.getImageData(g,A),z={uid:u.uid,tileID:u.tileID,source:this.id,type:this.type,scope:this.scope,rawImageData:M,encoding:this.encoding,padding:A};u.actor&&u.state!=="expired"||(u.actor=this.dispatcher.getActor(),u.actor.send("loadTile",z,h.bind(this),void 0,!0))}}).bind(this))}_getNeighboringTiles(u){const t=u.canonical,r=Math.pow(2,t.z),h=(t.x-1+r)%r,p=t.x===0?u.wrap-1:u.wrap,g=(t.x+1+r)%r,y=t.x+1===r?u.wrap+1:u.wrap,w={};return w[new s.aQ(u.overscaledZ,p,t.z,h,t.y).key]={backfilled:!1},w[new s.aQ(u.overscaledZ,y,t.z,g,t.y).key]={backfilled:!1},t.y>0&&(w[new s.aQ(u.overscaledZ,p,t.z,h,t.y-1).key]={backfilled:!1},w[new s.aQ(u.overscaledZ,u.wrap,t.z,t.x,t.y-1).key]={backfilled:!1},w[new s.aQ(u.overscaledZ,y,t.z,g,t.y-1).key]={backfilled:!1}),t.y+1<r&&(w[new s.aQ(u.overscaledZ,p,t.z,h,t.y+1).key]={backfilled:!1},w[new s.aQ(u.overscaledZ,u.wrap,t.z,t.x,t.y+1).key]={backfilled:!1},w[new s.aQ(u.overscaledZ,y,t.z,g,t.y+1).key]={backfilled:!1}),w}},"raster-array":Yr,geojson:class extends s.E{constructor(u,t,r,h){super(),this.id=u,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=r.getActor(),this.setEventedParent(h),this._data=t.data,this._options=Object.assign({},t),this._collectResourceTiming=t.collectResourceTiming,t.maxzoom!==void 0&&(this.maxzoom=t.maxzoom),t.minzoom!==void 0&&(this.minzoom=t.minzoom),t.type&&(this.type=t.type),t.attribution&&(this.attribution=t.attribution),this.promoteId=t.promoteId;const p=s.al/this.tileSize;this.workerOptions=Object.assign({source:this.id,scope:this.scope,cluster:t.cluster||!1,geojsonVtOptions:{buffer:(t.buffer!==void 0?t.buffer:128)*p,tolerance:(t.tolerance!==void 0?t.tolerance:.375)*p,extent:s.al,maxZoom:this.maxzoom,lineMetrics:t.lineMetrics||!1,generateId:t.generateId||!1},superclusterOptions:{maxZoom:t.clusterMaxZoom!==void 0?t.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,t.clusterMinPoints||2),extent:s.al,radius:(t.clusterRadius!==void 0?t.clusterRadius:50)*p,log:!1,generateId:t.generateId||!1},clusterProperties:t.clusterProperties,filter:t.filter,dynamic:t.dynamic},t.workerOptions)}onAdd(u){this.map=u,this.setData(this._data)}setData(u){return this._data=u,this._updateWorkerData(),this}updateData(u){if(!this._options.dynamic)return this.fire(new s.y(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")));if(typeof u!="string"&&(u.type==="Feature"&&(u={type:"FeatureCollection",features:[u]}),u.type!=="FeatureCollection"))return this.fire(new s.y(new Error("Data to update should be a feature or a feature collection.")));if(this._coalesce&&typeof u!="string"&&typeof this._data!="string"&&this._data.type==="FeatureCollection"){const t=new Map;for(const r of this._data.features)t.set(r.id,r);for(const r of u.features)t.set(r.id,r);this._data.features=[...t.values()]}else this._data=u;return this._updateWorkerData(!0),this}getClusterExpansionZoom(u,t){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:u,source:this.id,scope:this.scope},t),this}getClusterChildren(u,t){return this.actor.send("geojson.getClusterChildren",{clusterId:u,source:this.id,scope:this.scope},t),this}getClusterLeaves(u,t,r,h){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:u,limit:t,offset:r},h),this}_updateWorkerData(u=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new s.z("dataloading",{dataType:"source"})),this._loaded=!1;const t=Object.assign({append:u},this.workerOptions);t.scope=this.scope;const r=this._data;typeof r=="string"?(t.request=this.map._requestManager.transformRequest(s.o.resolveURL(r),s.R.Source),t.request.collectResourceTiming=this._collectResourceTiming):t.data=JSON.stringify(r),this._pendingLoad=this.actor.send(`${this.type}.loadData`,t,(h,p)=>{if(this._loaded=!0,this._pendingLoad=null,h)this.fire(new s.y(h));else{const g={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&p&&p.resourceTiming&&p.resourceTiming[this.id]&&(g.resourceTiming=p.resourceTiming[this.id]),u&&(this._partialReload=!0),this.fire(new s.z("data",g)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(u),this._coalesce=!1)})}loaded(){return this._loaded}reload(){const u=s.B(this.id,this.scope);this.map.style.clearSource(u),this._updateWorkerData()}loadTile(u,t){const r=u.actor?"reloadTile":"loadTile";u.actor=this.actor;const h=this.map.style?this.map.style.getLut(this.scope):null,p=h?{image:h.image.clone()}:null,g=this._partialReload,y={type:this.type,uid:u.uid,tileID:u.tileID,tileZoom:u.tileZoom,zoom:u.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:p,scope:this.scope,pixelRatio:s.o.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:u.isExtraShadowCaster,scaleFactor:this.map.getScaleFactor(),partial:g,worldview:this.map.getWorldview(),indoor:this.map.indoor?this.map.indoor.getIndoorTileOptions(this.id,this.scope):null};u.request=this.actor.send(r,y,(w,T)=>g&&!T?(u.state="loaded",t(null)):(delete u.request,u.destroy(!1),u.aborted?t(null):w?t(w):(u.loadVectorData(T,this.map.painter,r==="reloadTile"),t(null))),void 0,r==="loadTile")}abortTile(u){u.request&&(u.request.cancel(),delete u.request),u.aborted=!0}unloadTile(u,t){this.actor.send("removeTile",{uid:u.uid,type:this.type,source:this.id,scope:this.scope}),u.destroy()}onRemove(u){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return Object.assign({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends s.aU{constructor(u,t,r,h){super(u,t,r,h),this.roundZoom=!0,this.type="video",this.options=t}load(){this._loaded=!1;const u=this.options;this.urls=[];for(const t of u.urls)this.urls.push(this.map._requestManager.transformRequest(t,s.R.Source).url);s.aV(this.urls,(t,r)=>{this._loaded=!0,t?this.fire(new s.y(t)):r&&(this.video=r,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(u){if(this.video){const t=this.video.seekable;u<t.start(0)||u>t.end(0)?this.fire(new s.y(new s.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${t.start(0)} and ${t.end(0)}-second mark.`))):this.video.currentTime=u}}getVideo(){return this.video}onAdd(u){this.map||(this.map=u,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const u=this.map.painter.context,t=u.gl;this.texture?this.video.paused||(this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),t.texSubImage2D(t.TEXTURE_2D,0,0,0,t.RGBA,t.UNSIGNED_BYTE,this.video)):(this.texture=new s.T(u,this.video,t.RGBA8),this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(u)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:s.aU,model:s.aX,"batched-model":class extends s.E{constructor(u,t,r,h){super(),this.type="batched-model",this.id=u,this.tileSize=512,this._options=t,this.tiles=this._options.tiles,this.maxzoom=t.maxzoom||19,this.minzoom=t.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=r,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(h)}onAdd(u){this.map=u,this.load()}reload(){this.cancelTileJSONRequest();const u=s.B(this.id,this.scope);this.load(()=>this.map.style.clearSource(u))}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}load(u){this._loaded=!1,this.fire(new s.z("dataloading",{dataType:"source"}));const t=Array.isArray(this.map._language)?this.map._language.join():this.map._language,r=this.map.getWorldview();this._tileJSONRequest=Or(this._options,this.map._requestManager,t,r,(h,p)=>{this._tileJSONRequest=null,this._loaded=!0,h?(t&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${t}`),r&&r.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${r}`),this.fire(new s.y(h))):p&&(Object.assign(this,p),p.bounds&&(this.tileBounds=new mo(p.bounds,this.minzoom,this.maxzoom)),gn(p.tiles,this.map._requestManager._customAccessToken),this.fire(new s.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.z("data",{dataType:"source",sourceDataType:"content"}))),u&&u(h)})}hasTransition(){return!1}hasTile(u){return!this.tileBounds||this.tileBounds.contains(u.canonical)}loaded(){return this._loaded}loadTile(u,t){const r=this.map._requestManager.normalizeTileURL(u.tileID.canonical.url(this.tiles,this.scheme)),h={request:this.map._requestManager.transformRequest(r,s.R.Tile),data:void 0,uid:u.uid,tileID:u.tileID,tileZoom:u.tileZoom,zoom:u.tileID.overscaledZ,tileSize:this.tileSize*u.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:u.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,pixelRatio:s.o.devicePixelRatio,promoteId:this.promoteId};if(u.actor&&u.state!=="expired")if(u.state==="loading")u.reloadCallback=t;else{if(u.buckets){const g=Object.values(u.buckets);for(const y of g)y.dirty=!0;return void(u.state="loaded")}u.request=u.actor.send("reloadTile",h,p.bind(this))}else u.actor=this.dispatcher.getActor(),u.request=u.actor.send("loadTile",h,p.bind(this),void 0,!0);function p(g,y){return u.aborted?t(null):g&&g.status!==404?t(g):(this.map._refreshExpiredTiles&&y&&u.setExpiryData(y),u.loadModelData(y,this.map.painter),u.state="loaded",void t(null))}}serialize(){return Object.assign({},this._options)}},canvas:class extends s.aU{constructor(u,t,r,h){super(u,t,r,h),t.coordinates?Array.isArray(t.coordinates)&&t.coordinates.length===4&&!t.coordinates.some(p=>!Array.isArray(p)||p.length!==2||p.some(g=>typeof g!="number"))||this.fire(new s.y(new s.V(`sources.${u}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new s.y(new s.V(`sources.${u}`,null,'missing required property "coordinates"'))),t.animate&&typeof t.animate!="boolean"&&this.fire(new s.y(new s.V(`sources.${u}`,null,'optional "animate" property must be a boolean value'))),t.canvas?typeof t.canvas=="string"||t.canvas instanceof HTMLCanvasElement||this.fire(new s.y(new s.V(`sources.${u}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new s.y(new s.V(`sources.${u}`,null,'missing required property "canvas"'))),this.options=t,this.animate=t.animate===void 0||t.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new s.y(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(u){this.map=u,this.load(),this.canvas&&this.animate&&this.play()}onRemove(u){this.pause()}prepare(){let u=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,u=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,u=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const t=this.map.painter.context;this.texture?!u&&!this._playing||this.texture instanceof s.aW||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new s.T(t,this.canvas,t.gl.RGBA8,{premultiply:!0}),this._prepareData(t)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const u of[this.canvas.width,this.canvas.height])if(isNaN(u)||u<=0)return!0;return!1}},custom:class extends s.E{constructor(u,t,r,h){super(),this.id=u,this.type="custom",this._dataType="raster",this._dispatcher=r,this._implementation=t,this.setEventedParent(h),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new s.y(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new s.y(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new mo(this._implementation.bounds,this.minzoom,this.maxzoom)),t.update=this._update.bind(this),t.clearTiles=this._clearTiles.bind(this),t.coveringTiles=this._coveringTiles.bind(this),Object.assign(this,s.aH(t,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return s.aH(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new s.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.z("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(u){this.map=u,this._loaded=!1,this.fire(new s.z("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(u),this.load()}onRemove(u){this._implementation.onRemove&&this._implementation.onRemove(u)}hasTile(u){if(this._implementation.hasTile){const{x:t,y:r,z:h}=u.canonical;return this._implementation.hasTile({x:t,y:r,z:h})}return!this.tileBounds||this.tileBounds.contains(u.canonical)}loadTile(u,t){const{x:r,y:h,z:p}=u.tileID.canonical,g=new AbortController;u.request=Promise.resolve(this._implementation.loadTile({x:r,y:h,z:p},{signal:g.signal})).then((function(y){return delete u.request,u.aborted?(u.state="unloaded",t(null)):y===void 0?(u.state="errored",t(null)):y===null?(this.loadTileData(u,{width:this.tileSize,height:this.tileSize,data:null}),u.state="loaded",t(null)):function(w){return w instanceof ImageData||w instanceof HTMLCanvasElement||w instanceof ImageBitmap||w instanceof HTMLImageElement}(y)?(this.loadTileData(u,y),u.state="loaded",void t(null)):(u.state="errored",t(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}).bind(this)).catch(y=>{y.name!=="AbortError"&&(u.state="errored",t(y))}),u.request.cancel=()=>g.abort()}loadTileData(u,t){u.setTexture(t,this.map.painter)}unloadTile(u,t){if(u.texture&&u.texture instanceof s.T?(u.destroy(!1),u.texture&&u.texture instanceof s.T&&this.map.painter.saveTileTexture(u.texture)):u.destroy(),this._implementation.unloadTile){const{x:r,y:h,z:p}=u.tileID.canonical;this._implementation.unloadTile({x:r,y:h,z:p})}t&&t()}abortTile(u,t){u.request&&u.request.cancel&&(u.request.cancel(),delete u.request),t&&t()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(u=>({x:u.canonical.x,y:u.canonical.y,z:u.canonical.z}))}_clearTiles(){const u=s.B(this.id,this.scope);this.map.style.clearSource(u)}_update(){this.fire(new s.z("data",{dataType:"source",sourceDataType:"content"}))}}},xr=function(u,t,r,h){const p=new zs[t.type](u,t,r,h);if(p.id!==u)throw new Error(`Expected Source id to be ${u} instead of ${p.id}`);return s.aY(["load","abort","unload","serialize","prepare"],p),p};function kl(u,t,r=""){return`${r}:${t.id||""}:${t.layer.id}:${function(h){if("layerId"in h)return`layer:${h.layerId}`;{const{featuresetId:p,importId:g}=h;return`featureset:${p}${g?`:import:${g}`:""}`}}(u.target)}`}function gc(u,t,r,h=""){if(u.uniqueFeatureID){const p=kl(u,t,h);if(r.has(p))return!0;r.add(p)}return!1}function Nh(u,t,r,h,p=!1){const g=t.sourceCache.transform,y=t.sourceCache.tilesIn(u,t.has3DLayers,p);y.sort(Su);const w=[];for(const T of y){const A=T.tile.queryRenderedFeatures(t,T,r,h,g,p);Object.keys(A).length&&w.push({wrappedTileID:T.tile.tileID.wrapped().key,queryResults:A})}for(const T in t.layers){const A=t.layers[T];if(A.styleLayer){const M=A.styleLayer.queryRenderedFeatures(u,t.sourceCache,h);Object.keys(M).length&&w.push({wrappedTileID:0,queryResults:M})}}return w.length===0?{}:function(T){const A={},M={};for(const z of T){const L=z.queryResults,D=z.wrappedTileID,N=M[D]=M[D]||{};for(const B in L){const G=L[B],$=N[B]=N[B]||{},X=A[B]=A[B]||[];for(const J of G)$[J.featureIndex]||($[J.featureIndex]=!0,X.push(J))}}return A}(w)}function jh(u,t,r,h,p,g){const y={},w=h.queryRenderedSymbols(u),T=[];for(const A of Object.keys(w).map(Number))T.push(p[A]);T.sort(Su);for(const A of T){const M=A.featureIndex.lookupSymbolFeatures(w[A.bucketInstanceId],A.bucketIndex,A.sourceLayerIndex,t,r,g);for(const z in M){const L=y[z]=y[z]||[],D=M[z];D.sort((N,B)=>{const G=A.featureSortOrder;if(G){const $=G.indexOf(N.featureIndex);return G.indexOf(B.featureIndex)-$}return B.featureIndex-N.featureIndex});for(const N of D)L.push(N)}}return y}function Uh(u,t){const r=u.getRenderableIds().map(g=>u.getTileByID(g)),h=[],p={};for(let g=0;g<r.length;g++){const y=r[g],w=y.tileID.canonical.key;p[w]||(p[w]=!0,y.querySourceFeatures(h,t))}return h}function Su(u,t){const r=u.tileID,h=t.tileID;return r.overscaledZ-h.overscaledZ||r.canonical.y-h.canonical.y||r.wrap-h.wrap||r.canonical.x-h.canonical.x}function Ds(u,t){const r={};if(!t)return r;for(const h of u){const p=h.layerIds.map(g=>t.getLayer(g)).filter(Boolean);if(p.length!==0){h.layers=p,h.stateDependentLayerIds&&(h.stateDependentLayers=h.stateDependentLayerIds.map(g=>p.filter(y=>y.id===g)[0]));for(const g of p)r[g.fqid]=h}}return r}const _o=32,ps=33,ms=new Uint16Array(8184);for(let u=0;u<2046;u++){let t=u+2,r=0,h=0,p=0,g=0,y=0,w=0;for(1&t?p=g=y=_o:r=h=w=_o;(t>>=1)>1;){const A=r+p>>1,M=h+g>>1;1&t?(p=r,g=h,r=y,h=w):(r=p,h=g,p=y,g=w),y=A,w=M}const T=4*u;ms[T+0]=r,ms[T+1]=h,ms[T+2]=p,ms[T+3]=g}const Zo=new Uint16Array(2178),Os=new Uint8Array(1089),Wa=new Uint16Array(1089);function Ll(u){return u===0?-.03125:u===32?.03125:0}const Vh={type:2,extent:s.al,loadGeometry:()=>[[new s.P(0,0),new s.P(s.al+1,0),new s.P(s.al+1,s.al+1),new s.P(0,s.al+1),new s.P(0,0)]]};class zl{constructor(t,r,h,p,g,y){this.tileID=t,this.uid=s.b2(),this.uses=0,this.tileSize=r,this.tileZoom=h,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=g,p&&p.style&&(this._lastUpdatedBrightness=p.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",p&&p.transform&&(this.projection=p.transform.projection),this.worldview=y,this._hasAppearances=null}registerFadeDuration(t){const r=t+this.timeAdded;r<s.o.now()||this.fadeEndTime&&r<this.fadeEndTime||(this.fadeEndTime=r)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=s.aZ(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(t,r,h){if(this.unloadVectorData(),this.state="loaded",t){t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=Ds(t.buckets,r.style),this.hasSymbolBuckets=!1;for(const p in this.buckets){const g=this.buckets[p];if(g instanceof s.b4){if(this.hasSymbolBuckets=!0,!h)break;g.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const p in this.buckets){const g=this.buckets[p];if(g instanceof s.b4&&g.hasRTLText){this.hasRTLText=!0,s.b5();break}}this.queryPadding=0;for(const p in this.buckets){const g=this.buckets[p],y=r.style.getOwnLayer(p);if(!y)continue;const w=y.queryRadius(g);this.queryPadding=Math.max(this.queryPadding,w)}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage),t.lineAtlas&&(this.lineAtlas=t.lineAtlas),this._lastUpdatedBrightness=t.brightness}else this.collisionBoxArray=new s.b3}unloadVectorData(){if(this.hasData()){for(const t in this.buckets)this.buckets[t].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}loadModelData(t,r,h){t&&(t.resourceTiming&&(this.resourceTiming=t.resourceTiming),this.buckets=Object.assign({},this.buckets,Ds(t.buckets,r.style)),t.featureIndex&&(this.latestFeatureIndex=t.featureIndex))}getBucket(t){return this.buckets[t.fqid]}upload(t,r){for(const g in this.buckets){const y=this.buckets[g];if(y.uploadPending()){let w={},T=[],A={zoom:0,pitch:0,brightness:0,worldview:""};if(r){if(r.style){T=r.style.listImages();const M=y.layers[0],z=M.sourceLayer||"_geojsonTileLayer",L=r.style.getLayerSourceCache(M);L&&(w=L._state.getState(z,void 0))}A={zoom:r.transform.zoom||0,pitch:r.transform.pitch||0,brightness:r.style.getBrightness()||0,worldview:r.worldview||""}}y.upload(t,this.tileID.canonical,w,T,A)}}const h=t.gl,p=this.imageAtlas;p&&!p.uploaded&&(this.imageAtlasTexture=new s.T(t,p.image,h.RGBA8,{useMipmap:!!p.patternPositions.size}),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new s.T(t,this.glyphAtlasImage,h.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new s.T(t,this.lineAtlas.image,h.R8),this.lineAtlas.uploaded=!0)}prepare(t,r,h){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(t,this.imageAtlasTexture,h),!r||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const p=r.style.getBrightness();this._hasAppearances===null&&(this._hasAppearances=this.hasAppearances(r)),(this._lastUpdatedBrightness||p||this._hasAppearances)&&(!this._hasAppearances&&this._lastUpdatedBrightness&&p&&Math.abs(this._lastUpdatedBrightness-p)<.001||(this.updateBuckets(r,this._lastUpdatedBrightness!==p),this._lastUpdatedBrightness=p))}evaluateQueryRenderedFeaturePadding(){let t=0;for(const r in this.buckets){const h=this.buckets[r];h.evaluateQueryRenderedFeaturePadding&&(t=Math.max(t,h.evaluateQueryRenderedFeaturePadding()))}return t}queryRenderedFeatures(t,r,h,p,g,y){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData&&!this.latestFeatureIndex.is3DTile)return{};const w=this.evaluateQueryRenderedFeaturePadding(),T=function(A,M){const z=s.bq([],[.5*A.width,.5*-A.height,1]);return s.br(z,z,[1,-1,0]),s.aB(z,z,A.calculateProjMatrix(M.toUnwrapped())),Float32Array.from(z)}(g,this.tileID);return this.latestFeatureIndex.query(t,{tilespaceGeometry:r,pixelPosMatrix:T,transform:p,availableImages:h,tileTransform:this.tileTransform,worldview:this.worldview,queryRadius:w})}querySourceFeatures(t,r){const h=this.latestFeatureIndex;if(!h||!h.rawTileData)return;const p=h.loadVTLayers(),g=r?r.sourceLayer:"",y=p._geojsonTileLayer||p[g];if(!y)return;const w=s.b6(r&&r.filter),{z:T,x:A,y:M}=this.tileID.canonical,z={z:T,x:A,y:M};for(let L=0;L<y.length;L++){const D=y.feature(L);if(w.needGeometry){const G=s.b7(D,!0);if(!w.filter(new s.ac(this.tileID.overscaledZ,{worldview:this.worldview}),G,this.tileID.canonical))continue}else if(!w.filter(new s.ac(this.tileID.overscaledZ,{worldview:this.worldview}),D))continue;const N=h.getId(D,g),B=new s.b8(D,T,A,M,N);B.tile=z,t.push(B)}}loaded(){return this.state==="loaded"||this.state==="errored"}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return!!this.imageAtlas&&!!this.imageAtlas.patternPositions.size}setExpiryData(t){const r=this.expirationTime;if(t.cacheControl){const h=s.b9(t.cacheControl);h["max-age"]&&(this.expirationTime=Date.now()+1e3*h["max-age"])}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){const h=Date.now();let p=!1;if(this.expirationTime>h)p=!1;else if(r)if(this.expirationTime<r)p=!0;else{const g=this.expirationTime-r;g?this.expirationTime=h+Math.max(g,3e4):p=!0}else p=!0;p?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}refreshFeatureState(t){this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)&&t&&this.updateBuckets(t)}hasAppearances(t){for(const r in this.buckets)if(t.style.hasLayer(r)&&this.buckets[r].layers.some(h=>h.appearances&&h.appearances.length>0))return!0;return!1}updateBuckets(t,r){if(!this.latestFeatureIndex||!t.style)return;const h=t.style.listImages(),p=t.style.getBrightness();for(const g in this.buckets){if(!t.style.hasLayer(g))continue;const y=this.buckets[g],w=y.layers[0],T=w.sourceLayer||"_geojsonTileLayer",A=t.style.getLayerSourceCache(w);let M={};A&&(M=A._state.getState(T,void 0));const z=this.imageAtlas?Object.fromEntries(this.imageAtlas.patternPositions):{},L=Object.keys(M).length>0&&!r;y.hasAppearances=y.layers.some(B=>B.appearances&&B.appearances.length>0);const D=L?y.stateDependentLayers:y.layers;if(L&&y.stateDependentLayers.length!==0||r){const B=this.latestFeatureIndex.loadVTLayers();y.update(M,B[T],h,z,D,r,p)}if(L&&y.stateDependentLayers.length!==0||r||y.hasAppearances){const B={zoom:t.transform.zoom,pitch:t.transform.pitch,brightness:t.style.getBrightness()||0,worldview:t.worldview};y.updateAppearances(this.tileID.canonical,M,h,B)}(y instanceof s.ba||y instanceof s.bb)&&t._terrain&&t._terrain.enabled&&A&&y.uploadPending()&&t._terrain._clearRenderCacheForTile(A.id,this.tileID);const N=t&&t.style&&t.style.getOwnLayer(g);N&&(this.queryPadding=Math.max(this.queryPadding,N.queryRadius(y)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<s.o.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(t){this.symbolFadeHoldUntil=s.o.now()+t}setTexture(t,r){const h=r.context,p=h.gl;this.texture=this.texture||r.getTileTexture(t.width),this.texture&&this.texture instanceof s.T?this.texture.update(t):(this.texture=new s.T(h,t,p.RGBA8,{useMipmap:!0}),this.texture.bind(p.LINEAR,p.CLAMP_TO_EDGE))}setDependencies(t,r){const h={};for(const p of r)h[p]=!0;this.dependencies[t]=h}hasDependency(t,r){for(const h of t){const p=this.dependencies[h];if(p){for(const g of r)if(p[g])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(t,r){if(!r||r.name==="mercator"||this._tileDebugBuffer)return;const h=s.bc(Vh,this.tileID.canonical,this.tileTransform)[0],p=new s.bd,g=new s.be;for(let y=0;y<h.length;y++){const{x:w,y:T}=h[y];p.emplaceBack(w,T),g.emplaceBack(y)}g.emplaceBack(0),this._tileDebugIndexBuffer=t.createIndexBuffer(g),this._tileDebugBuffer=t.createVertexBuffer(p,s.bf.members),this._tileDebugSegments=s.bg.simpleSegment(0,0,p.length,g.length)}_makeTileBoundsBuffers(t,r){if(this._tileBoundsBuffer||!r||r.name==="mercator")return;const h=s.bc(Vh,this.tileID.canonical,this.tileTransform)[0];let p,g;if(this.isRaster){const y=function(w,T){const A=s.aZ(w,T),M=Math.pow(2,w.z);for(let G=0;G<ps;G++)for(let $=0;$<ps;$++){const X=s.a_((w.x+($+Ll($))/_o)/M),J=s.a$((w.y+(G+Ll(G))/_o)/M),K=T.project(X,J),ue=G*ps+$;Zo[2*ue+0]=Math.round((K.x*A.scale-A.x)*s.al),Zo[2*ue+1]=Math.round((K.y*A.scale-A.y)*s.al)}Os.fill(0),Wa.fill(0);for(let G=2045;G>=0;G--){const $=4*G,X=ms[$+0],J=ms[$+1],K=ms[$+2],ue=ms[$+3],oe=X+K>>1,le=J+ue>>1,re=oe+le-J,te=le+X-oe,he=J*ps+X,we=ue*ps+K,ye=le*ps+oe,ze=Math.hypot((Zo[2*he+0]+Zo[2*we+0])/2-Zo[2*ye+0],(Zo[2*he+1]+Zo[2*we+1])/2-Zo[2*ye+1])>=16;Os[ye]=Os[ye]||(ze?1:0),G<1022&&(Os[ye]=Os[ye]||Os[(J+te>>1)*ps+(X+re>>1)]||Os[(ue+te>>1)*ps+(K+re>>1)])}const z=new s.b1,L=new s.b0;let D=0;function N(G,$){const X=$*ps+G;return Wa[X]===0&&(z.emplaceBack(Zo[2*X+0],Zo[2*X+1],G*s.al/_o,$*s.al/_o),Wa[X]=++D),Wa[X]-1}function B(G,$,X,J,K,ue){const oe=G+X>>1,le=$+J>>1;if(Math.abs(G-K)+Math.abs($-ue)>1&&Os[le*ps+oe])B(K,ue,G,$,oe,le),B(X,J,K,ue,oe,le);else{const re=N(G,$),te=N(X,J),he=N(K,ue);L.emplaceBack(re,te,he)}}return B(0,0,_o,_o,_o,0),B(_o,_o,0,0,0,_o),{vertices:z,indices:L}}(this.tileID.canonical,r);p=y.vertices,g=y.indices}else{p=new s.b1,g=new s.b0;for(const{x:w,y:T}of h)p.emplaceBack(w,T,0,0);const y=s.bh(p.int16.subarray(0,4*p.length),void 0,4);for(let w=0;w<y.length;w+=3)g.emplaceBack(y[w],y[w+1],y[w+2])}this._tileBoundsBuffer=t.createVertexBuffer(p,s.bi.members),this._tileBoundsIndexBuffer=t.createIndexBuffer(g),this._tileBoundsSegments=s.bg.simpleSegment(0,0,p.length,g.length)}_makeGlobeTileDebugBuffers(t,r){const h=r.projection;if(!h||h.name!=="globe"||r.freezeTileCoverage)return;const p=this.tileID.canonical,g=s.bj(p,r),y=s.bk(g),w=s.aj(r.zoom);let T;w>0&&(T=s.bl(new Float64Array(16),r.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(t,p,r,y,T,w),this._makeGlobeTileDebugTextBuffer(t,p,r,y,T,w)}_globePoint(t,r,h,p,g,y,w){let T=s.bm(t,r,h);if(y){const A=1<<h.z,M=s.aF(p.center.lng),z=s.aJ(p.center.lat),L=(h.x+.5)/A-M;let D=0;L>.5?D=-1:L<-.5&&(D=1);let N=(t/s.al+h.x)/A+D,B=(r/s.al+h.y)/A;N=(N-M)*p._pixelsPerMercatorPixel+M,B=(B-z)*p._pixelsPerMercatorPixel+z;const G=[N*p.worldSize,B*p.worldSize,0];s.af(G,G,y),T=s.bn(T,G,w)}return s.af(T,T,g)}_makeGlobeTileDebugBorderBuffer(t,r,h,p,g,y){const w=new s.bd,T=new s.be,A=new s.bo,M=(L,D,N,B,G)=>{const $=(N-L)/(G-1),X=(B-D)/(G-1),J=w.length;for(let K=0;K<G;K++){const ue=L+K*$,oe=D+K*X;w.emplaceBack(ue,oe);const le=this._globePoint(ue,oe,r,h,p,g,y);A.emplaceBack(le[0],le[1],le[2]),T.emplaceBack(J+K)}},z=s.al;M(0,0,z,0,16),M(z,0,z,z,16),M(z,z,0,z,16),M(0,z,0,0,16),this._tileDebugIndexBuffer=t.createIndexBuffer(T),this._tileDebugBuffer=t.createVertexBuffer(w,s.bf.members),this._globeTileDebugBorderBuffer=t.createVertexBuffer(A,s.bp.members),this._tileDebugSegments=s.bg.simpleSegment(0,0,w.length,T.length)}_makeGlobeTileDebugTextBuffer(t,r,h,p,g,y){const w=s.al/4,T=new s.bd,A=new s.b0,M=new s.bo,z=25;A.reserve(32),T.reserve(z),M.reserve(z);const L=(D,N)=>z*D+N;for(let D=0;D<z;D++){const N=D*w;for(let B=0;B<z;B++){const G=B*w;T.emplaceBack(G,N);const $=this._globePoint(G,N,r,h,p,g,y);M.emplaceBack($[0],$[1],$[2])}}for(let D=0;D<4;D++)for(let N=0;N<4;N++){const B=L(D,N),G=L(D,N+1),$=L(D+1,N),X=L(D+1,N+1);A.emplaceBack(B,G,$),A.emplaceBack($,G,X)}this._tileDebugTextIndexBuffer=t.createIndexBuffer(A),this._tileDebugTextBuffer=t.createVertexBuffer(T,s.bf.members),this._globeTileDebugTextBuffer=t.createVertexBuffer(M,s.bp.members),this._tileDebugTextSegments=s.bg.simpleSegment(0,0,z,32)}destroy(t=!0){for(const r in this.buckets)this.buckets[r].destroy(t);this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),t&&this.texture&&this.texture instanceof s.T&&(this.texture.destroy(),delete this.texture),this.emissiveTexture&&this.emissiveTexture instanceof s.T&&(this.emissiveTexture.destroy(),delete this.emissiveTexture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}s.bs.setPbf(s.bt);class $h extends zl{constructor(t,r,h,p,g){super(t,r,h,p,g),this._workQueuePerLayer=new Map,this._fetchQueuePerLayer=new Map,this._taskQueue=new Map,this._isHeaderLoaded=!1,this.textureDescriptorPerLayer=new Map,this.texturePerLayer=new Map}getLayers(){return this._mrt?Object.values(this._mrt.layers):[]}getLayer(t){return this._mrt&&this._mrt.getLayer(t)}setTexturePerLayer(t,r,h){const p=h.context,g=p.gl;let y=this.texturePerLayer.get(t)||h.getTileTexture(r.width);y&&y instanceof s.T?y.update(r,{premultiply:!1}):y=new s.T(p,r,g.RGBA8,{premultiply:!1}),this.texturePerLayer.has(t)||this.texturePerLayer.set(t,y)}flushQueues(t){const r=this._workQueuePerLayer.get(t)||[],h=this._fetchQueuePerLayer.get(t)||[];for(;r.length;)r.pop()();for(;h.length;)h.pop()()}flushAllQueues(){for(const t of this._workQueuePerLayer.keys()){const r=this._workQueuePerLayer.get(t)||[];for(;r.length;)r.pop()()}for(const t of this._fetchQueuePerLayer.keys()){const r=this._fetchQueuePerLayer.get(t)||[];for(;r.length;)r.pop()()}}fetchHeader(t=16384,r){const h=this._mrt=new s.bs(30),p=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(t-1)}});return this.entireBuffer=null,this.request=s.bu(p,(g,y,w)=>{if(g)r(g);else try{const T=h.getHeaderLength(y);if(T>t)return void(this.request=this.fetchHeader(T,r));h.parseHeader(y),this._isHeaderLoaded=!0;let A=0;for(const M of Object.values(h.layers))A=Math.max(A,M.dataIndex[M.dataIndex.length-1].lastByte);y.byteLength>=A&&(this.entireBuffer=y),r(null,this.entireBuffer||y,w)}catch(T){r(T)}}),this.request}fetchBandForRender(t,r,h,p){this.fetchBand(t,r,h,g=>{if(g)return void p(g);this.updateTextureDescriptor(t,r,h);const y=this.textureDescriptorPerLayer.get(r);p(null,y?y.img:null)})}fetchBand(t,r,h,p,g=!0){const y=this._mrt;if(!this._isHeaderLoaded||!y)return void p(new Error("Tile header is not ready"));const w=this.actor;if(!w)return void p(new Error("Can't fetch tile band without an actor"));let T;const A=s.B(String(h),s.B(this.tileID.key,t));let M=this._taskQueue.get(A);M?M.add(p):(M=new Set,M.add(p),this._taskQueue.set(A,M));const z=(B,G)=>{T.complete(B,G),B?p(B):(M.forEach($=>$(null,G)),this._taskQueue.delete(A))},L=(B,G)=>{if(B)return p(B);const $=w.send("decodeRasterArray",{type:"raster-array",source:this.source,scope:this.scope,tileID:this.tileID,uid:this.uid,buffer:G,task:T},z,void 0,!0);if(r!==null){const X=this._workQueuePerLayer.get(r)||[];X.push(()=>{$&&$.cancel(),T.cancel()}),this._workQueuePerLayer.has(r)||this._workQueuePerLayer.set(r,X)}};let D;try{D=y.getLayer(t)}catch(B){if(this.state==="reloading")return;throw B}if(!D)return void p(new Error(`Unknown sourceLayer "${t}"`));if(D.hasDataForBand(h))return M.forEach(B=>B(null,null)),void this._taskQueue.delete(A);const N=D.getDataRange([h]);if(T=y.createDecodingTask(N),!T||T.tasks.length)if(r!==null&&this.flushQueues(r),this.entireBuffer)L(null,this.entireBuffer.slice(N.firstByte,N.lastByte+1));else{const B=Object.assign({},this.requestParams,{headers:{Range:`bytes=${N.firstByte}-${N.lastByte}`}}),G=s.bu(B,L);if(r!==null){const $=this._fetchQueuePerLayer.get(r)||[];$.push(()=>{G.cancel(),T.cancel()}),this._fetchQueuePerLayer.has(r)||this._fetchQueuePerLayer.set(r,$)}}}updateNeeded(t,r){return(!this.textureDescriptorPerLayer.get(t)||this.textureDescriptorPerLayer.get(t).band!==r||this.refreshedUponExpiration)&&this.state!=="errored"}updateTextureDescriptor(t,r,h){if(!this._mrt)return;const p=this._mrt.getLayer(t);if(!p||!p.hasBand(h)||!p.hasDataForBand(h))return;const{bytes:g,tileSize:y,buffer:w,offset:T,scale:A}=p.getBandView(h),M=y+2*w,z=new s.q({width:M,height:M},g),L=this.texturePerLayer.get(r);L&&L instanceof s.T&&L.update(z,{premultiply:!1}),this.textureDescriptorPerLayer.set(r,{layer:t,band:h,img:z,buffer:w,offset:T,tileSize:y,format:p.pixelFormat,mix:[A,256*A,65536*A,16777216*A]})}destroy(t=!1){if(super.destroy(t),delete this._mrt,!t)for(const r of this.texturePerLayer.values())r&&r instanceof s.T&&r.destroy();this.texturePerLayer.clear(),this.textureDescriptorPerLayer.clear(),this.fbo&&(this.fbo.destroy(),delete this.fbo),delete this.request,delete this.requestParams,this._isHeaderLoaded=!1}}class lg{constructor(t,r){this.max=t,this.onRemove=r,this.reset()}reset(){for(const t in this.data)for(const r of this.data[t])r.timeout&&clearTimeout(r.timeout),this.onRemove(r.value);return this.data={},this.order=[],this}add(t,r,h){const p=t.wrapped().key;this.data[p]===void 0&&(this.data[p]=[]);const g={value:r,timeout:void 0};if(h!==void 0&&(g.timeout=setTimeout(()=>{this.remove(t,g)},h)),this.data[p].push(g),this.order.push(p),this.order.length>this.max){const y=this._getAndRemoveByKey(this.order[0]);y&&this.onRemove(y)}return this}has(t){return t.wrapped().key in this.data}getAndRemove(t){return this.has(t)?this._getAndRemoveByKey(t.wrapped().key):null}_getAndRemoveByKey(t){const r=this.data[t].shift();return r.timeout&&clearTimeout(r.timeout),this.data[t].length===0&&delete this.data[t],this.order.splice(this.order.indexOf(t),1),r.value}getByKey(t){const r=this.data[t];return r?r[0].value:null}get(t){return this.has(t)?this.data[t.wrapped().key][0].value:null}remove(t,r){if(!this.has(t))return this;const h=t.wrapped().key,p=r===void 0?0:this.data[h].indexOf(r),g=this.data[h][p];return this.data[h].splice(p,1),g.timeout&&clearTimeout(g.timeout),this.data[h].length===0&&delete this.data[h],this.onRemove(g.value),this.order.splice(this.order.indexOf(h),1),this}setMaxSize(t){for(this.max=t;this.order.length>this.max;){const r=this._getAndRemoveByKey(this.order[0]);r&&this.onRemove(r)}return this}filter(t){const r=[];for(const h in this.data)for(const p of this.data[h])t(p.value)||r.push(p);for(const h of r)this.remove(h.value.tileID,h)}}class Eu{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(t,r,h){const p=String(r);if(this.stateChanges[t]=this.stateChanges[t]||{},this.stateChanges[t][p]=this.stateChanges[t][p]||{},Object.assign(this.stateChanges[t][p],h),this.deletedStates[t]===null){this.deletedStates[t]={};for(const g in this.state[t])g!==p&&(this.deletedStates[t][g]=null)}else if(this.deletedStates[t]&&this.deletedStates[t][p]===null){this.deletedStates[t][p]={};for(const g in this.state[t][p])h[g]||(this.deletedStates[t][p][g]=null)}else for(const g in h)this.deletedStates[t]&&this.deletedStates[t][p]&&this.deletedStates[t][p][g]===null&&delete this.deletedStates[t][p][g]}removeFeatureState(t,r,h){if(this.deletedStates[t]===null)return;const p=String(r);if(this.deletedStates[t]=this.deletedStates[t]||{},h&&r!==void 0)this.deletedStates[t][p]!==null&&(this.deletedStates[t][p]=this.deletedStates[t][p]||{},this.deletedStates[t][p][h]=null);else if(r!==void 0)if(this.stateChanges[t]&&this.stateChanges[t][p])for(h in this.deletedStates[t][p]={},this.stateChanges[t][p])this.deletedStates[t][p][h]=null;else this.deletedStates[t][p]=null;else this.deletedStates[t]=null}getState(t,r){const h=this.state[t]||{},p=this.stateChanges[t]||{},g=this.deletedStates[t];if(g===null)return{};if(r!==void 0){const w=String(r),T=Object.assign({},h[w],p[w]);if(g){const A=g[r];if(A===null)return{};for(const M in A)delete T[M]}return T}const y=Object.assign({},h,p);if(g)for(const w in g)delete y[w];return y}initializeTileState(t,r){t.refreshFeatureState(r)}coalesceChanges(t,r){const h={};for(const p in this.stateChanges){this.state[p]=this.state[p]||{};const g={};for(const y in this.stateChanges[p])this.state[p][y]||(this.state[p][y]={}),Object.assign(this.state[p][y],this.stateChanges[p][y]),g[y]=this.state[p][y];h[p]=g}for(const p in this.deletedStates){this.state[p]=this.state[p]||{};const g={};if(this.deletedStates[p]===null)for(const y in this.state[p])g[y]={},this.state[p][y]={};else for(const y in this.deletedStates[p]){if(this.deletedStates[p][y]===null)this.state[p][y]={};else if(this.state[p][y])for(const w of Object.keys(this.deletedStates[p][y]))delete this.state[p][y][w];g[y]=this.state[p][y]}h[p]=h[p]||{},Object.assign(h[p],g)}if(this.stateChanges={},this.deletedStates={},Object.keys(h).length!==0)for(const p in t)t[p].refreshFeatureState(r)}}class Io extends s.E{constructor(t,r,h){super(),this.id=t,this._onlySymbols=h,r.on("data",p=>{p.dataType==="source"&&p.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&p.dataType==="source"&&p.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))}),r.on("error",()=>{this._sourceErrored=!0}),this._source=r,this._tiles={},this._cache=new lg(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=r.minTileCacheSize,this._maxTileCacheSize=r.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new Eu,this._isRaster=this._source.type==="raster"||this._source.type==="raster-dem"||this._source.type==="raster-array"||this._source.type==="custom"&&this._source._dataType==="raster"}onAdd(t){this.map=t,this._minTileCacheSize=this._minTileCacheSize===void 0&&t?t._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=this._maxTileCacheSize===void 0&&t?t._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const t in this._tiles)if(!this._tiles[t].loaded())return!1;return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const t=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,t&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(t,r){return t.isSymbolTile=this._onlySymbols,t.isExtraShadowCaster=this._shadowCasterTiles[t.tileID.key],this._source.loadTile(t,r)}_unloadTile(t){if(this._source.unloadTile)return this._source.unloadTile(t)}_abortTile(t){if(this._source.abortTile)return this._source.abortTile(t)}serialize(){return this._source.serialize()}prepare(t){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const r in this._tiles){const h=this._tiles[r];h.upload(t,this.map?this.map.painter:void 0),h.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return Object.values(this._tiles).map(t=>t.tileID).sort(Gh).map(t=>t.key)}getRenderableIds(t,r){const h=[];for(const p in this._tiles)this._isIdRenderable(+p,t,r)&&h.push(this._tiles[p]);return t?h.sort((p,g)=>{const y=p.tileID,w=g.tileID,T=new s.P(y.canonical.x,y.canonical.y)._rotate(this.transform.angle),A=new s.P(w.canonical.x,w.canonical.y)._rotate(this.transform.angle);return y.overscaledZ-w.overscaledZ||A.y-T.y||A.x-T.x}).map(p=>p.tileID.key):h.map(p=>p.tileID).sort(Gh).map(p=>p.key)}hasRenderableParent(t){const r=this.findLoadedParent(t,0);return!!r&&this._isIdRenderable(r.tileID.key)}_isIdRenderable(t,r,h){return this._tiles[t]&&this._tiles[t].hasData()&&!this._coveredTiles[t]&&(r||!this._tiles[t].holdingForFade())&&(h||!this._shadowCasterTiles[t])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const t in this._tiles)this._tiles[t].state!=="errored"&&this._reloadTile(+t,"reloading")}}_reloadTile(t,r){const h=this._tiles[t];h&&(h.state!=="loading"&&(h.state=r),this._loadTile(h,this._tileLoaded.bind(this,h,t,r)))}_tileLoaded(t,r,h,p,g){if(p){if(t.state="errored",p.status!==404)this._source.fire(new s.y(p,{tile:t}));else{if(this._source.fire(new s.z("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id,tile:t})),!(t.tileID.key in this._loadedParentTiles))return;if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){const w=this.map.painter.terrain;this.update(this.transform,w.getScaledDemTileSize(),!0),w.resetTileLookupCache(this.id)}else this.update(this.transform)}return}t.timeAdded=s.o.now(),h==="expired"&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(r,t),this._source.type==="raster-dem"&&t.dem&&this._backfillDEM(t),this._state.initializeTileState(t,this.map?this.map.painter:null);let y=new Map;g&&g.responseHeaders&&(y=g.responseHeaders),this._source.fire(new s.z("data",{dataType:"source",tile:t,coord:t.tileID,sourceCacheId:this.id,responseHeaders:y}))}_backfillDEM(t){const r=this.getRenderableIds();for(let p=0;p<r.length;p++){const g=r[p];if(t.neighboringTiles&&t.neighboringTiles[g]){const y=this.getTileByID(g);h(t,y),h(y,t)}}function h(p,g){if(!p.dem||p.dem.borderReady)return;p.needsHillshadePrepare=!0,p.needsDEMTextureUpload=!0;let y=g.tileID.canonical.x-p.tileID.canonical.x;const w=g.tileID.canonical.y-p.tileID.canonical.y,T=Math.pow(2,p.tileID.canonical.z),A=g.tileID.key;y===0&&w===0||Math.abs(w)>1||(Math.abs(y)>1&&(Math.abs(y+T)===1?y+=T:Math.abs(y-T)===1&&(y-=T)),g.dem&&p.dem&&(p.dem.backfillBorder(g.dem,y,w),p.neighboringTiles&&p.neighboringTiles[A]&&(p.neighboringTiles[A].backfilled=!0)))}}getTile(t){return this.getTileByID(t.key)}getTileByID(t){return this._tiles[t]}_retainLoadedChildren(t,r,h,p){for(const g in this._tiles){let y=this._tiles[g];if(p[g]||!y.hasData()||y.tileID.overscaledZ<=r||y.tileID.overscaledZ>h)continue;let w=y.tileID;for(;y&&y.tileID.overscaledZ>r+1;){const A=y.tileID.scaledTo(y.tileID.overscaledZ-1);y=this._tiles[A.key],y&&y.hasData()&&(w=A)}let T=w;for(;T.overscaledZ>r;)if(T=T.scaledTo(T.overscaledZ-1),t[T.key]){p[w.key]=w;break}}}findLoadedParent(t,r){if(t.key in this._loadedParentTiles){const h=this._loadedParentTiles[t.key];return h&&h.tileID.overscaledZ>=r?h:null}for(let h=t.overscaledZ-1;h>=r;h--){const p=t.scaledTo(h),g=this._getLoadedTile(p);if(g)return g}}_getLoadedTile(t){const r=this._tiles[t.key];return r&&r.hasData()?r:this._cache.getByKey(this._source.reparseOverscaled?t.wrapped().key:t.canonical.key)}updateCacheSize(t,r){r=r||this._source.tileSize;const h=Math.ceil(t.width/r)+1,p=Math.ceil(t.height/r)+1,g=Math.floor(h*p*5),y=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,g):g,w=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,y):y;this._cache.setMaxSize(w)}handleWrapJump(t){const r=Math.round((t-(this._prevLng===void 0?t:this._prevLng))/360);if(this._prevLng=t,r){const h={};for(const p in this._tiles){const g=this._tiles[p];g.tileID=g.tileID.unwrapTo(g.tileID.wrap+r),h[g.tileID.key]=g}this._tiles=h;for(const p in this._timers)clearTimeout(this._timers[p]),delete this._timers[p];for(const p in this._tiles)this._setTileReloadTimer(+p,this._tiles[p])}}update(t,r,h,p,g){if(this.transform=t,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!h)return;this.updateCacheSize(t,r),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={};const y=this._source.type==="batched-model";let w,T=this._source.maxzoom;const A=this.map&&this.map.painter?this.map.painter._terrain:null;if(A&&A.sourceCache===this&&A.attenuationRange()){const L=A.attenuationRange()[0],D=Math.floor(L)-Math.log2(A.getDemUpscale());T>D&&(T=D)}if(this.used||this.usedForTerrain){if(this._source.tileID)w=t.getVisibleUnwrappedCoordinates(this._source.tileID).map(L=>new s.aQ(L.canonical.z,L.wrap,L.canonical.z,L.canonical.x,L.canonical.y));else if(this.tileCoverLift!==0){const L=t.clone();L.tileCoverLift=this.tileCoverLift,w=L.coveringTiles({tileSize:r||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:T,roundZoom:this._source.roundZoom&&!h,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:y}),this._source.minzoom<=1&&t.projection.name==="globe"&&(w.push(new s.aQ(1,0,1,0,0)),w.push(new s.aQ(1,0,1,1,0)),w.push(new s.aQ(1,0,1,0,1)),w.push(new s.aQ(1,0,1,1,1)))}else if(w=t.coveringTiles({tileSize:r||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:T,roundZoom:this._source.roundZoom&&!h,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:y}),this._source.hasTile){const L=this._source.hasTile.bind(this._source);w=w.filter(D=>L(D))}}else w=[];if(w.length>0&&this.transform.projection.name!=="globe"&&!this.usedForTerrain&&!Dl(this._source.type)){const L=t.coveringZoomLevel({tileSize:r||this._source.tileSize,roundZoom:this._source.roundZoom&&!h}),D=Math.min(L,this._source.maxzoom);if(y){const N=t.extendTileCover(w,D);for(const B of N)w.push(B)}else if(g){const N=t.extendTileCoverToNearPlane(w,this.transform.getFrustum(D),D);for(const B of N)w.push(B)}else if(this.castsShadows&&p){const N=t.extendTileCover(w,D,p,16);for(const B of N)this._shadowCasterTiles[B.key]=!0,w.push(B)}}const M=this._updateRetainedTiles(w);if(Dl(this._source.type)&&w.length!==0){const L={},D={},N=Object.keys(M);for(const G of N){const $=M[G],X=this._tiles[G];if(!X||X.fadeEndTime&&X.fadeEndTime<=s.o.now())continue;const J=this.findLoadedParent($,Math.max($.overscaledZ-Io.maxOverzooming,this._source.minzoom));J&&(this._addTile(J.tileID),L[J.tileID.key]=J.tileID),D[G]=$}const B=w[w.length-1].overscaledZ;for(const G in this._tiles){const $=this._tiles[G];if(M[G]||!$.hasData())continue;let X=$.tileID;for(;X.overscaledZ>B;){X=X.scaledTo(X.overscaledZ-1);const J=this._tiles[X.key];if(J&&J.hasData()&&D[X.key]){M[G]=$.tileID;break}}}for(const G in L)M[G]||(this._coveredTiles[G]=!0,M[G]=L[G])}for(const L in M)this._tiles[L].clearFadeHold();const z=s.bv(this._tiles,M);for(const L of z){const D=this._tiles[L];D.hasSymbolBuckets&&!D.holdingForFade()?D.setHoldDuration(this.map._fadeDuration):D.hasSymbolBuckets&&!D.symbolFadeFinished()||this._removeTile(+L)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const t in this._tiles)this._tiles[t].holdingForFade()&&this._removeTile(+t)}_updateRetainedTiles(t){const r={};if(t.length===0)return r;const h={},p=t.reduce((A,M)=>Math.min(A,M.overscaledZ),1/0),g=t[0].overscaledZ,y=Math.max(g-Io.maxOverzooming,this._source.minzoom),w=Math.max(g+Io.maxUnderzooming,this._source.minzoom),T={};for(const A of t){const M=this._addTile(A);r[A.key]=A,M.hasData()||p<this._source.maxzoom&&(T[A.key]=A)}this._retainLoadedChildren(T,p,w,r);for(const A of t){let M=this._tiles[A.key];if(M.hasData())continue;if(A.canonical.z>=this._source.maxzoom){const L=A.children(this._source.maxzoom)[0],D=this.getTile(L);if(D&&D.hasData()){r[L.key]=L;continue}}else{const L=A.children(this._source.maxzoom);if(r[L[0].key]&&r[L[1].key]&&r[L[2].key]&&r[L[3].key])continue}let z=M.wasRequested();for(let L=A.overscaledZ-1;L>=y;--L){const D=A.scaledTo(L);if(h[D.key]||(h[D.key]=!0,M=this.getTile(D),!M&&z&&(M=this._addTile(D)),M&&(r[D.key]=D,z=M.wasRequested(),M.hasData())))break}}return r}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const t in this._tiles){const r=[];let h,p=this._tiles[t].tileID;for(;p.overscaledZ>0;){if(p.key in this._loadedParentTiles){h=this._loadedParentTiles[p.key];break}r.push(p.key);const g=p.scaledTo(p.overscaledZ-1);if(h=this._getLoadedTile(g),h)break;p=g}for(const g of r)this._loadedParentTiles[g]=h}}_addTile(t){let r=this._tiles[t.key];if(r)return r.isExtraShadowCaster!==!0||this._shadowCasterTiles[t.key]||this._reloadTile(t.key,"reloading"),r;r=this._cache.getAndRemove(t),r&&(this._setTileReloadTimer(t.key,r),r.tileID=t,this._state.initializeTileState(r,this.map?this.map.painter:null),this._cacheTimers[t.key]&&(clearTimeout(this._cacheTimers[t.key]),delete this._cacheTimers[t.key],this._setTileReloadTimer(t.key,r)));const h=!!r;if(!h){const p=this.map?this.map.painter:null,g=this._source.tileSize*t.overscaleFactor();r=this._source.type==="raster-array"?new $h(t,g,this.transform.tileZoom,p,this._isRaster):new zl(t,g,this.transform.tileZoom,p,this._isRaster,this._source.worldview),this._loadTile(r,this._tileLoaded.bind(this,r,t.key,r.state))}return r.uses++,this._tiles[t.key]=r,h||this._source.fire(new s.z("dataloading",{tile:r,coord:r.tileID,dataType:"source"})),r}_setTileReloadTimer(t,r){t in this._timers&&(clearTimeout(this._timers[t]),delete this._timers[t]);const h=r.getExpiryTimeout();h&&(this._timers[t]=setTimeout(()=>{this._reloadTile(t,"expired"),delete this._timers[t]},h))}_removeTile(t){const r=this._tiles[t];r&&(r.uses--,delete this._tiles[t],this._timers[t]&&(clearTimeout(this._timers[t]),delete this._timers[t]),r.uses>0||(r.hasData()&&r.state!=="reloading"||r.state==="empty"?this._cache.add(r.tileID,r,r.getExpiryTimeout()):(r.aborted=!0,this._abortTile(r),this._unloadTile(r))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const t in this._tiles)this._removeTile(+t);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(t,r,h){const p=[],g=this.transform;if(!g)return p;const y=g.projection.name==="globe",w=s.aF(g.center.lng);for(const T in this._tiles){const A=this._tiles[T];if(h&&A.clearQueryDebugViz(),A.holdingForFade())continue;let M;if(y){const z=A.tileID.canonical;if(z.z===0){const L=[Math.abs(s.aA(w,...aa(z,-1))-w),Math.abs(s.aA(w,...aa(z,1))-w)];M=[0,2*L.indexOf(Math.min(...L))-1]}else{const L=[Math.abs(s.aA(w,...aa(z,-1))-w),Math.abs(s.aA(w,...aa(z,0))-w),Math.abs(s.aA(w,...aa(z,1))-w)];M=[L.indexOf(Math.min(...L))-1]}}else M=[0];for(const z of M){const L=t.containsTile(A,g,r,z);L&&p.push(L)}}return p}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(t){return this._getRenderableCoordinates(t)}_getRenderableCoordinates(t,r){const h=this.getRenderableIds(t,r).map(g=>this._tiles[g].tileID),p=this.transform.projection.name==="globe";for(const g of h)g.projMatrix=this.transform.calculateProjMatrix(g.toUnwrapped()),g.expandedProjMatrix=p?this.transform.calculateProjMatrix(g.toUnwrapped(),!1,!0):g.projMatrix;return h}sortCoordinatesByDistance(t){const r=t.slice(),h=this.transform._camera.position,p=this.transform._camera.forward(),g={};for(const y of r){const w=1/(1<<y.canonical.z);g[y.key]=((y.canonical.x+.5)*w+y.wrap-h[0])*p[0]+((y.canonical.y+.5)*w-h[1])*p[1]-h[2]*p[2]}return r.sort((y,w)=>g[y.key]-g[w.key]),r}hasTransition(){if(this._source.hasTransition())return!0;if(Dl(this._source.type))for(const t in this._tiles){const r=this._tiles[t];if(r.fadeEndTime!==void 0&&r.fadeEndTime>=s.o.now())return!0}return!1}setFeatureState(t,r,h){this._state.updateState(t=t||"_geojsonTileLayer",r,h)}removeFeatureState(t,r,h){this._state.removeFeatureState(t=t||"_geojsonTileLayer",r,h)}getFeatureState(t,r){return this._state.getState(t=t||"_geojsonTileLayer",r)}setDependencies(t,r,h){const p=this._tiles[t];p&&p.setDependencies(r,h)}reloadTilesForDependencies(t,r){for(const h in this._tiles)this._tiles[h].hasDependency(t,r)&&this._reloadTile(+h,"reloading");this._cache.filter(h=>!h.hasDependency(t,r))}_preloadTiles(t,r){if(!this._sourceLoaded){const T=()=>{this._sourceLoaded&&(this._source.off("data",T),this._preloadTiles(t,r))};return void this._source.on("data",T)}const h=new Map,p=Array.isArray(t)?t:[t],g=this.map.painter.terrain,y=this.usedForTerrain&&g?g.getScaledDemTileSize():this._source.tileSize;for(const T of p){const A=T.coveringTiles({tileSize:y,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const M of A)h.set(M.key,M);this.usedForTerrain&&T.updateElevation(!1)}const w=Array.from(h.values());s.bw(w,(T,A)=>{const M=new zl(T,this._source.tileSize*T.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster,this._source.worldview);this._loadTile(M,z=>{this._source.type==="raster-dem"&&M.dem&&this._backfillDEM(M),A(z,M)})},r)}}function Gh(u,t){const r=Math.abs(2*u.wrap)-+(u.wrap<0),h=Math.abs(2*t.wrap)-+(t.wrap<0);return u.overscaledZ-t.overscaledZ||h-r||t.canonical.y-u.canonical.y||t.canonical.x-u.canonical.x}function Dl(u){return u==="raster"||u==="image"||u==="video"||u==="custom"}function aa(u,t){const r=1<<u.z;return[u.x/r+t,(u.x+1)/r+t]}Io.maxOverzooming=10,Io.maxUnderzooming=3;class Rv{constructor(t){this.style=t,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];const t=!1,r=!1;for(const h in this.style._mergedLayers){const p=this.style._mergedLayers[h];if(p.type==="fill-extrusion"||p.type==="building")this.layers.push({layer:p,visible:t,visibilityChanged:r});else if(p.type==="model"){const g=this.style.getLayerSource(p);g&&g.type==="batched-model"&&this.layers.push({layer:p,visible:t,visibilityChanged:r})}}}onNewFrame(t){this.layersGotHidden=!1;for(const r of this.layers){const h=r.layer;let p=!1;h.type==="fill-extrusion"?p=!h.isHidden(t)&&h.paint.get("fill-extrusion-opacity")>0:h.type==="building"?p=!h.isHidden(t)&&h.paint.get("building-opacity")>0:h.type==="model"&&(p=!h.isHidden(t)&&h.paint.get("model-opacity").constantOr(1)>0),this.layersGotHidden=this.layersGotHidden||!p&&r.visible,r.visible=p}}updateZOffset(t,r){this.currentBuildingBuckets=[];for(const p of this.layers){const g=p.layer,y=this.style.getLayerSourceCache(g);let w=1;g.type==="fill-extrusion"?w=p.visible?g.paint.get("fill-extrusion-vertical-scale"):0:g.type==="building"&&(w=p.visible?g.paint.get("building-vertical-scale"):0);let T=y?y.getTile(r):null;if(!T&&y)for(const A in y._tiles){const M=y._tiles[A];if(r.canonical.isChildOf(M.tileID.canonical)){T=M;break}}this.currentBuildingBuckets.push({bucket:T?T.getBucket(g):null,tileID:T?T.tileID:r,verticalScale:w})}t.hasAnyZOffset=!1;let h=!1;for(let p=0;p<t.symbolInstances.length;p++){const g=t.symbolInstances.get(p),y=g.zOffset,w=this._getHeightAtTileOffset(r,g.tileAnchorX,g.tileAnchorY);g.zOffset=w!==Number.NEGATIVE_INFINITY?w:y,h||y===g.zOffset||(h=!0),t.hasAnyZOffset||g.zOffset===0||(t.hasAnyZOffset=!0)}h&&(t.zOffsetBuffersNeedUpload=!0,t.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(t,r,h,p){let g=r,y=h;if(t.canonical.z!==p.canonical.z){const w=p.canonical,T=1/(1<<t.canonical.z-w.z);g=(r+t.canonical.x*s.al)*T-w.x*s.al|0,y=(h+t.canonical.y*s.al)*T-w.y*s.al|0}return{tileX:g,tileY:y}}_getHeightAtTileOffset(t,r,h){let p,g;for(let y=0;y<this.layers.length;++y){const w=this.layers[y].layer;if(w.type!=="fill-extrusion"&&w.type!=="building")continue;const{bucket:T,tileID:A,verticalScale:M}=this.currentBuildingBuckets[y];if(!T)continue;const{tileX:z,tileY:L}=this._mapCoordToOverlappingTile(t,r,h,A),D=T.getHeightAtTileCoord(z,L);D&&D.height!==void 0&&(D.hidden?p=D.height:g=Math.max(D.height*M,g||0))}if(g!==void 0)return g;for(let y=0;y<this.layers.length;++y){const w=this.layers[y];if(w.layer.type!=="model"||!w.visible)continue;const{bucket:T,tileID:A}=this.currentBuildingBuckets[y];if(!T)continue;const{tileX:M,tileY:z}=this._mapCoordToOverlappingTile(t,r,h,A),L=T.getHeightAtTileCoord(M,z);if(L&&!L.hidden)return L.height===void 0&&p!==void 0?Math.min(L.maxHeight,p)*L.verticalScale:L.height?L.height*L.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function cg(u,t){const r={};for(const h in u)h!=="ref"&&(r[h]=u[h]);return s.bx.forEach(h=>{h in t&&(r[h]=t[h])}),r}function Iu(u){u=u.slice();const t=Object.create(null);for(let r=0;r<u.length;r++)t[u[r].id]=u[r];for(let r=0;r<u.length;r++)"ref"in u[r]&&(u[r]=cg(u[r],t[u[r].ref]));return u}const zi={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setSnow:"setSnow",setRain:"setRain",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport",addIconset:"addIconset",removeIconset:"removeIconset"};function Hh(u,t,r){r.push({command:zi.addSource,args:[u,t[u]]})}function pp(u,t,r){t.push({command:zi.removeSource,args:[u]}),r[u]=!0}function ug(u,t,r,h){pp(u,r,h),Hh(u,t,r)}function hg(u,t,r){let h;for(h in u[r])if(u[r].hasOwnProperty(h)&&h!=="data"&&!s.by(u[r][h],t[r][h]))return!1;for(h in t[r])if(t[r].hasOwnProperty(h)&&h!=="data"&&!s.by(u[r][h],t[r][h]))return!1;return!0}function Za(u,t,r,h,p,g){let y;for(y in t=t||{},u=u||{})u.hasOwnProperty(y)&&(s.by(u[y],t[y])||r.push({command:g,args:[h,y,t[y],p]}));for(y in t)t.hasOwnProperty(y)&&!u.hasOwnProperty(y)&&(s.by(u[y],t[y])||r.push({command:g,args:[h,y,t[y],p]}))}function Au(u){return u.id}function Cu(u,t){return u[t.id]=t,u}function mp(u,t,r){const h=t.createTileMatrix(u,u.worldSize,r.toUnwrapped());return s.aB(new Float32Array(16),u.projMatrix,h)}function qh(u,t,r){if(t.projection.name===r.projection.name)return u.projMatrix;const h=r.clone();return h.setProjection(t.projection),mp(h,t.getProjection(),u)}function Fs(u,t,r){return t.name===r.projection.name?u.projMatrix:mp(r,t,u)}class Pu{constructor(t,r){this.reset(t,r)}reset(t,r){this.points=t||[],this._distances=[0];for(let h=1;h<this.points.length;h++)this._distances[h]=this._distances[h-1]+this.points[h].dist(this.points[h-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(r||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(t){if(this.points.length===1)return this.points[0];t=s.aA(t,0,1);let r=1,h=this._distances[r];const p=t*this.paddedLength+this.padding;for(;h<p&&r<this._distances.length;)h=this._distances[++r];const g=r-1,y=this._distances[g],w=h-y,T=w>0?(p-y)/w:0;return this.points[g].mult(1-T).add(this.points[r].mult(T))}}class _p{constructor(t,r,h){const p=this.boxCells=[],g=this.circleCells=[];this.xCellCount=Math.ceil(t/h),this.yCellCount=Math.ceil(r/h);for(let y=0;y<this.xCellCount*this.yCellCount;y++)p.push([]),g.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=t,this.height=r,this.xScale=this.xCellCount/t,this.yScale=this.yCellCount/r,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(t,r,h,p,g){this._forEachCell(r,h,p,g,this._insertBoxCell,this.boxUid++),this.boxKeys.push(t),this.bboxes.push(r),this.bboxes.push(h),this.bboxes.push(p),this.bboxes.push(g)}insertCircle(t,r,h,p){this._forEachCell(r-p,h-p,r+p,h+p,this._insertCircleCell,this.circleUid++),this.circleKeys.push(t),this.circles.push(r),this.circles.push(h),this.circles.push(p)}_insertBoxCell(t,r,h,p,g,y){this.boxCells[g].push(y)}_insertCircleCell(t,r,h,p,g,y){this.circleCells[g].push(y)}_query(t,r,h,p,g,y){if(h<0||t>this.width||p<0||r>this.height)return!g&&[];const w=[];if(t<=0&&r<=0&&this.width<=h&&this.height<=p){if(g)return!0;for(let T=0;T<this.boxKeys.length;T++)w.push({key:this.boxKeys[T],x1:this.bboxes[4*T],y1:this.bboxes[4*T+1],x2:this.bboxes[4*T+2],y2:this.bboxes[4*T+3]});for(let T=0;T<this.circleKeys.length;T++){const A=this.circles[3*T],M=this.circles[3*T+1],z=this.circles[3*T+2];w.push({key:this.circleKeys[T],x1:A-z,y1:M-z,x2:A+z,y2:M+z})}return y?w.filter(y):w}return this._forEachCell(t,r,h,p,this._queryCell,w,{hitTest:g,seenUids:{box:{},circle:{}}},y),g?w.length>0:w}_queryCircle(t,r,h,p,g){const y=t-h,w=t+h,T=r-h,A=r+h;if(w<0||y>this.width||A<0||T>this.height)return!p&&[];const M=[];return this._forEachCell(y,T,w,A,this._queryCellCircle,M,{hitTest:p,circle:{x:t,y:r,radius:h},seenUids:{box:{},circle:{}}},g),p?M.length>0:M}query(t,r,h,p,g){return this._query(t,r,h,p,!1,g)}hitTest(t,r,h,p,g){return this._query(t,r,h,p,!0,g)}hitTestCircle(t,r,h,p){return this._queryCircle(t,r,h,!0,p)}_queryCell(t,r,h,p,g,y,w,T){const A=w.seenUids,M=this.boxCells[g];if(M!==null){const L=this.bboxes;for(const D of M)if(!A.box[D]){A.box[D]=!0;const N=4*D;if(t<=L[N+2]&&r<=L[N+3]&&h>=L[N+0]&&p>=L[N+1]&&(!T||T(this.boxKeys[D]))){if(w.hitTest)return y.push(!0),!0;y.push({key:this.boxKeys[D],x1:L[N],y1:L[N+1],x2:L[N+2],y2:L[N+3]})}}}const z=this.circleCells[g];if(z!==null){const L=this.circles;for(const D of z)if(!A.circle[D]){A.circle[D]=!0;const N=3*D;if(this._circleAndRectCollide(L[N],L[N+1],L[N+2],t,r,h,p)&&(!T||T(this.circleKeys[D]))){if(w.hitTest)return y.push(!0),!0;{const B=L[N],G=L[N+1],$=L[N+2];y.push({key:this.circleKeys[D],x1:B-$,y1:G-$,x2:B+$,y2:G+$})}}}}}_queryCellCircle(t,r,h,p,g,y,w,T){const A=w.circle,M=w.seenUids,z=this.boxCells[g];if(z!==null){const D=this.bboxes;for(const N of z)if(!M.box[N]){M.box[N]=!0;const B=4*N;if(this._circleAndRectCollide(A.x,A.y,A.radius,D[B+0],D[B+1],D[B+2],D[B+3])&&(!T||T(this.boxKeys[N])))return y.push(!0),!0}}const L=this.circleCells[g];if(L!==null){const D=this.circles;for(const N of L)if(!M.circle[N]){M.circle[N]=!0;const B=3*N;if(this._circlesCollide(D[B],D[B+1],D[B+2],A.x,A.y,A.radius)&&(!T||T(this.circleKeys[N])))return y.push(!0),!0}}}_forEachCell(t,r,h,p,g,y,w,T){const A=this._convertToXCellCoord(t),M=this._convertToYCellCoord(r),z=this._convertToXCellCoord(h),L=this._convertToYCellCoord(p);for(let D=A;D<=z;D++)for(let N=M;N<=L;N++)if(g.call(this,t,r,h,p,this.xCellCount*N+D,y,w,T))return}_convertToXCellCoord(t){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(t*this.xScale)))}_convertToYCellCoord(t){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(t*this.yScale)))}_circlesCollide(t,r,h,p,g,y){const w=p-t,T=g-r,A=h+y;return A*A>w*w+T*T}_circleAndRectCollide(t,r,h,p,g,y,w){const T=(y-p)/2,A=Math.abs(t-(p+T));if(A>T+h)return!1;const M=(w-g)/2,z=Math.abs(r-(g+M));if(z>M+h)return!1;if(A<=T||z<=M)return!0;const L=A-T,D=z-M;return L*L+D*D<=h*h}}const Xa={unknown:0,flipRequired:1,flipNotRequired:2},Ol=Math.tan(85*Math.PI/180);function Jr(u,t,r,h,p,g,y){const w=s.bC();if(r)if(g.name==="globe"){const T=s.bD(p,t);s.aB(w,w,T)}else{const T=s.bE([],y);w[0]=T[0],w[1]=T[1],w[4]=T[2],w[5]=T[3],h||s.bB(w,w,p.angle)}else s.aB(w,p.labelPlaneMatrix,u);return w}function Wh(u,t,r,h,p,g,y){const w=Jr(u,t,r,h,p,g,y);return g.name==="globe"&&r||(w[2]=w[6]=w[10]=w[14]=0),w}function Mu(u,t,r,h,p,g,y){if(r){if(g.name==="globe"){const w=Jr(u,t,r,h,p,g,y);return s.bl(w,w),s.aB(w,u,w),w}{const w=s.bz(u),T=s.bA([]);return T[0]=y[0],T[1]=y[1],T[4]=y[2],T[5]=y[3],s.aB(w,w,T),h||s.bB(w,w,-p.angle),w}}return p.glCoordMatrix}function Xo(u,t,r,h){const p=[u,t,r,1];r?s.aC(p,p,h):Bt(p,p,h);const g=p[3];return p[0]/=g,p[1]/=g,p[2]/=g,p}function Zi(u,t){return Math.min(.5+u/t*.5,1.5)}function dg(u,t){const r=u[0]/u[3],h=u[1]/u[3];return r>=-t[0]&&r<=t[0]&&h>=-t[1]&&h<=t[1]}function fg(u,t,r,h,p,g,y,w,T,A,M=1){const z=r.transform,L=h?u.textSizeData:u.iconSizeData,D=s.bK(L,r.transform.zoom,M),N=z.projection.name==="globe",B=[256/r.width*2+1,256/r.height*2+1],G=h?u.text.dynamicLayoutVertexArray:u.icon.dynamicLayoutVertexArray;G.clear();let $=null;N&&($=h?u.text.globeExtVertexArray:u.icon.globeExtVertexArray);const X=u.lineVertexArray,J=h?u.text.placedSymbolArray:u.icon.placedSymbolArray,K=r.transform.width/r.transform.height;let ue,oe=!1;for(let le=0;le<J.length;le++){const re=J.get(le),{numGlyphs:te,writingMode:he}=re;if(he!==s.bL.vertical||oe||ue===s.bL.horizontal||(oe=!0),ue=he,(re.hidden||he===s.bL.vertical)&&!oe){_s(te,G);continue}oe=!1;const we=new s.P(re.tileAnchorX,re.tileAnchorY),ye=u.elevationType==="road",ze=!!z.elevation||ye;let{x:Oe,y:$e,z:ot}=z.projection.projectTilePoint(we.x,we.y,A.canonical),Ae=null;if(ze){const Tt=ye?u.getElevationFeatureForText(le):null;Ae={getElevation:T,elevation:z.elevation,elevationFeature:Tt};const[Ut,ii,wi]=T(we,z.elevation,Tt);Oe+=Ut,$e+=ii,ot+=wi}const _e=[Oe,$e,ot,1];if(s.aC(_e,_e,t),!dg(_e,B)){_s(te,G);continue}const Ne=_e[3],Re=Zi(r.transform.getCameraToCenterDistance(z.projection),Ne),Ke=s.bM(L,D,re),pt=y?Ke/Re:Ke*Re,wt=Xo(Oe,$e,ot,p);if(wt[3]<=0){_s(te,G);continue}let ht={};const st=s.an(u.layers[0].layout.get("text-max-angle")),Rt=Math.cos(st),At=y?null:Ae,vt=gp(re,pt,!1,w,t,p,g,u.glyphOffsetArray,X,G,$,wt,we,ht,K,At,z.projection,A,y,Rt);oe=vt.useVertical,At&&vt.needsFlipping&&(ht={}),(vt.notEnoughRoom||oe||vt.needsFlipping&&gp(re,pt,!0,w,t,p,g,u.glyphOffsetArray,X,G,$,wt,we,ht,K,At,z.projection,A,y,Rt).notEnoughRoom)&&_s(te,G)}h?(u.text.dynamicLayoutVertexBuffer.updateData(G),$&&u.text.globeExtVertexBuffer&&u.text.globeExtVertexBuffer.updateData($)):(u.icon.dynamicLayoutVertexBuffer.updateData(G),$&&u.icon.globeExtVertexBuffer&&u.icon.globeExtVertexBuffer.updateData($))}function pg(u,t,r,h,p,g,y,w,T,A,M,z,L,D,N,B,G){const{lineStartIndex:$,glyphStartIndex:X,segment:J}=w,K=X+w.numGlyphs,ue=$+w.lineLength,oe=t.getoffsetX(X),le=t.getoffsetX(K-1),re=yc(u*oe,r,h,p,g,y,J,$,ue,T,A,M,z,L,!0,D,N,B,G);if(!re)return null;const te=yc(u*le,r,h,p,g,y,J,$,ue,T,A,M,z,L,!0,D,N,B,G);return te?{first:re,last:te}:null}function Kt(u,t,r,h){return u===s.bL.horizontal&&Math.abs(h)>Math.abs(r)?{useVertical:!0}:u===s.bL.vertical?h>0?{needsFlipping:!0}:null:t!==Xa.unknown&&function(p,g){return p===0||Math.abs(g/p)>Ol}(r,h)?t===Xa.flipRequired?{needsFlipping:!0}:null:r<0?{needsFlipping:!0}:null}function gp(u,t,r,h,p,g,y,w,T,A,M,z,L,D,N,B,G,$,X,J){const K=t/24,ue=u.lineOffsetX*K,oe=u.lineOffsetY*K,{lineStartIndex:le,glyphStartIndex:re,numGlyphs:te,segment:he,writingMode:we,flipState:ye}=u,ze=le+u.lineLength,Oe=$e=>{if(M){const[Ne,Re,Ke]=$e.up,pt=A.length;s.bN(M,pt+0,Ne,Re,Ke),s.bN(M,pt+1,Ne,Re,Ke),s.bN(M,pt+2,Ne,Re,Ke),s.bN(M,pt+3,Ne,Re,Ke)}const[ot,Ae,_e]=$e.point;s.bO(A,ot,Ae,_e,$e.angle)};if(te>1){const $e=pg(K,w,ue,oe,r,z,L,u,T,g,D,B,!1,G,$,X,J);if(!$e)return{notEnoughRoom:!0};if(h&&!r){let[ot,Ae,_e]=$e.first.point,[Ne,Re,Ke]=$e.last.point;[ot,Ae]=Xo(ot,Ae,_e,y),[Ne,Re]=Xo(Ne,Re,Ke,y);const pt=Kt(we,ye,(Ne-ot)*N,Re-Ae);if(u.flipState=pt&&pt.needsFlipping?Xa.flipRequired:Xa.flipNotRequired,pt)return pt}Oe($e.first);for(let ot=re+1;ot<re+te-1;ot++){const Ae=yc(K*w.getoffsetX(ot),ue,oe,r,z,L,he,le,ze,T,g,D,B,!1,!1,G,$,X,J);if(!Ae)return A.length-=4*(ot-re),{notEnoughRoom:!0};Oe(Ae)}Oe($e.last)}else{if(h&&!r){const ot=Xo(L.x,L.y,0,p),Ae=le+he+1,_e=new s.P(T.getx(Ae),T.gety(Ae)),Ne=Xo(_e.x,_e.y,0,p),Re=Ne[3]>0?Ne:Ko(L,_e,ot,1,p,void 0,G,$.canonical),Ke=Kt(we,ye,(Re[0]-ot[0])*N,Re[1]-ot[1]);if(u.flipState=Ke&&Ke.needsFlipping?Xa.flipRequired:Xa.flipNotRequired,Ke)return Ke}const $e=yc(K*w.getoffsetX(re),ue,oe,r,z,L,he,le,ze,T,g,D,B,!1,!1,G,$,X,J);if(!$e)return{notEnoughRoom:!0};Oe($e)}return{}}function Ru(u,t,r,h,p){const{x:g,y,z:w}=h.projectTilePoint(u.x,u.y,t);if(!p)return Xo(g,y,w,r);const[T,A,M]=p.getElevation(u,p.elevation,p.elevationFeature);return Xo(g+T,y+A,w+M,r)}function Ko(u,t,r,h,p,g,y,w){const T=Ru(u.sub(t)._unit()._add(u),w,p,y,g);return s.av(T,r,T),s.aw(T,T),s.bH(T,r,T,h)}function yc(u,t,r,h,p,g,y,w,T,A,M,z,L,D,N,B,G,$,X){const J=h?u-t:u+t;let K=J>0?1:-1,ue=0;h&&(K*=-1,ue=Math.PI),K<0&&(ue+=Math.PI);let oe=w+y+(K>0?0:1)|0,le=p,re=p,te=0,he=0;const we=Math.abs(J),ye=[],ze=[];let Oe=g,$e=Oe,ot=s.bF([]);const Ae=()=>Ko($e,Oe,re,we-te+1,M,L,B,G.canonical);for(;te+he<=we;){if(oe+=K,oe<w||oe>=T)return null;if(re=le,$e=Oe,ye.push(re),D&&ze.push($e),Oe=new s.P(A.getx(oe),A.gety(oe)),le=z[oe],!le){const At=Ru(Oe,G.canonical,M,B,L);le=At[3]>0?z[oe]=At:Ae()}te+=he;const st=s.av([],le,re),Rt=s.bG(re,le);if(r&&Rt>0&&he>0&&s.bJ(ot,st)/(he*Rt)<X)return null;he=Rt,ot=st}N&&L&&(z[oe]&&(le=Ae(),he=s.bG(re,le),ot=s.av([],le,re)),z[oe]=le);const _e=(we-te)/he,Ne=Oe.sub($e)._mult(_e)._add($e),Re=s.bH([],re,ot,_e);let Ke=[0,0,1],pt=ot[0],wt=ot[1];if($&&(Ke=B.upVector(G.canonical,Ne.x,Ne.y),Ke[0]!==0||Ke[1]!==0||Ke[2]!==1)){const st=[Ke[2],0,-Ke[0]],Rt=s.bI([],Ke,st);s.aw(st,st),s.aw(Rt,Rt),pt=s.bJ(ot,st),wt=s.bJ(ot,Rt)}if(r){const st=s.bI([],Ke,ot);s.aw(st,st),s.bH(Re,Re,st,r*K)}const ht=ue+Math.atan2(wt,pt);return ye.push(Re),D&&ze.push(Ne),{point:Re,angle:ht,path:ye,tilePath:ze,up:Ke}}function _s(u,t){const r=t.length,h=r+4*u;t.resize(h),t.float32.fill(-1/0,4*r,4*h)}function Bt(u,t,r){const h=t[0],p=t[1];return u[0]=r[0]*h+r[4]*p+r[12],u[1]=r[1]*h+r[5]*p+r[13],u[3]=r[3]*h+r[7]*p+r[15],u}const Ei=100;class Ji{constructor(t,r,h=new _p(t.width+200,t.height+200,25),p=new _p(t.width+200,t.height+200,25)){this.transform=t,this.grid=h,this.ignoredGrid=p,this.pitchfactor=Math.cos(t._pitch)*t.cameraToCenterDistance,this.screenRightBoundary=t.width+Ei,this.screenBottomBoundary=t.height+Ei,this.gridRightBoundary=t.width+200,this.gridBottomBoundary=t.height+200,this.fogState=r}placeCollisionBox(t,r,h,p,g,y,w,T,A,M,z){let L=h.projectedAnchorX,D=h.projectedAnchorY,N=h.projectedAnchorZ;const B=h.tileAnchorX,G=h.tileAnchorY,$=h.elevation,X=h.tileID,J=t.getProjection();if($&&X){const[ze,Oe,$e]=J.upVector(X.canonical,h.tileAnchorX,h.tileAnchorY),ot=J.upVectorScale(X.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;L+=ze*$*ot,D+=Oe*$*ot,N+=$e*$*ot}const K=t.projection.name==="globe",ue=t.projection.name==="globe"?s.aj(this.transform.zoom):0;if(X&&K&&ue<1&&!y){const ze=1<<X.canonical.z,Oe=s.bP(B,G);s.bQ(Oe,Oe,1/s.al),s.bR(Oe,Oe,s.bP(X.canonical.x,X.canonical.y)),s.bQ(Oe,Oe,1/ze),s.bS(Oe,Oe,s.bP(p[0],p[1])),Oe[0]=s.bT(Oe[0],-.5,.5),s.bQ(Oe,Oe,s.al);const $e=s.bU(Oe[0],Oe[1],s.al/(2*Math.PI),1);s.aC($e,$e,g),L=s.ak(L,$e[0],ue),D=s.ak(D,$e[1],ue),N=s.ak(N,$e[2],ue)}const oe=this.projectAndGetPerspectiveRatio(M,L,D,N,h.tileID,J.name==="globe"||!!$||this.transform.pitch>0,J),le=A*oe.perspectiveRatio,re=(h.x1*r+w.x-h.padding)*le+oe.point.x,te=(h.y1*r+w.y-h.padding)*le+oe.point.y,he=(h.x2*r+w.x+h.padding)*le+oe.point.x,we=(h.y2*r+w.y+h.padding)*le+oe.point.y,ye=oe.perspectiveRatio<=.55||oe.occluded;return!this.isInsideGrid(re,te,he,we)||!T&&this.grid.hitTest(re,te,he,we,z)||ye?{box:[],offscreen:!1,occluded:oe.occluded}:{box:[re,te,he,we],offscreen:this.isOffscreen(re,te,he,we),occluded:!1}}placeCollisionCircles(t,r,h,p,g,y,w,T,A,M,z,L,D,N,B,G){const $=[],X=this.transform.elevation,J=t.getProjection(),K=t.elevationType==="road",ue=!!X||K,oe=s.bV.getAtTileOffsetFunc(G,this.transform.center.lat,this.transform.worldSize,J),le=new s.P(h.tileAnchorX,h.tileAnchorY),re=new s.P(h.tileAnchorX,h.tileAnchorY);let{x:te,y:he,z:we}=J.projectTilePoint(re.x,re.y,G.canonical),ye=null;if(ue){const Rt=K?t.getElevationFeatureForText(p):null;ye={getElevation:oe,elevation:X,elevationFeature:Rt};const[At,vt,Tt]=oe(le,X,Rt);te+=At,he+=vt,we+=Tt}const ze=J.name==="globe",Oe=this.projectAndGetPerspectiveRatio(T,te,he,we,G,ze||!!X||this.transform.pitch>0,J),{perspectiveRatio:$e}=Oe,ot=(L?w/$e:w*$e)/s.bY,Ae=Xo(te,he,we,A),_e=h.lineOffsetX*ot,Ne=h.lineOffsetY*ot,Re=s.an(t.layers[0].layout.get("text-max-angle")),Ke=Math.cos(Re),pt=Oe.signedDistanceFromCamera>0?pg(ot,y,_e,Ne,K&&h.flipState===1,Ae,re,h,g,A,{},ue&&!L?ye:null,L&&ue,J,G,L,Ke):null;let wt=!1,ht=!1,st=!0;if(pt&&!Oe.occluded){const Rt=.5*N*$e+B,At=new s.P(-100,-100),vt=new s.P(this.screenRightBoundary,this.screenBottomBoundary),Tt=new Pu,{first:Ut,last:ii}=pt,wi=Ut.path.length;let Ui=[];for(let ti=wi-1;ti>=1;ti--)Ui.push(Ut.path[ti]);for(let ti=1;ti<ii.path.length;ti++)Ui.push(ii.path[ti]);const Lt=2.5*Rt;M&&(Ui=Ui.map(([ti,Gi,Qi],Xi)=>(ue&&!ze&&(Qi=oe(Xi<wi-1?Ut.tilePath[wi-1-Xi]:ii.tilePath[Xi-wi+2],X,ye.elevationFeature)[2]),Xo(ti,Gi,Qi,M))),Ui.some(ti=>ti[3]<=0)&&(Ui=[]));let Fi=[];if(Ui.length>0){let ti=1/0,Gi=-1/0,Qi=1/0,Xi=-1/0;for(const Di of Ui)ti=Math.min(ti,Di[0]),Qi=Math.min(Qi,Di[1]),Gi=Math.max(Gi,Di[0]),Xi=Math.max(Xi,Di[1]);Gi>=At.x&&ti<=vt.x&&Xi>=At.y&&Qi<=vt.y&&(Fi=[Ui.map(Di=>new s.P(Di[0],Di[1]))],(ti<At.x||Gi>vt.x||Qi<At.y||Xi>vt.y)&&(Fi=s.bW(Fi,At.x,At.y,vt.x,vt.y)))}for(const ti of Fi){Tt.reset(ti,.25*Rt);let Gi=0;Gi=Tt.length<=.5*Rt?1:Math.ceil(Tt.paddedLength/Lt)+1;for(let Qi=0;Qi<Gi;Qi++){const Xi=Qi/Math.max(Gi-1,1),Di=Tt.lerp(Xi),ci=Di.x+Ei,$i=Di.y+Ei;$.push(ci,$i,Rt,0);const zn=ci-Rt,xn=$i-Rt,Hi=ci+Rt,Ci=$i+Rt;if(st=st&&this.isOffscreen(zn,xn,Hi,Ci),ht=ht||this.isInsideGrid(zn,xn,Hi,Ci),!r&&this.grid.hitTestCircle(ci,$i,Rt,D)&&(wt=!0,!z))return{circles:[],offscreen:!1,collisionDetected:wt,occluded:!1}}}}return{circles:!z&&wt||!ht?[]:$,offscreen:st,collisionDetected:wt,occluded:Oe.occluded}}queryRenderedSymbols(t){if(t.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const r=[];let h=1/0,p=1/0,g=-1/0,y=-1/0;for(const M of t){const z=new s.P(M.x+Ei,M.y+Ei);h=Math.min(h,z.x),p=Math.min(p,z.y),g=Math.max(g,z.x),y=Math.max(y,z.y),r.push(z)}const w=this.grid.query(h,p,g,y).concat(this.ignoredGrid.query(h,p,g,y)),T={},A={};for(const M of w){const z=M.key;if(T[z.bucketInstanceId]===void 0&&(T[z.bucketInstanceId]={}),T[z.bucketInstanceId][z.featureIndex])continue;const L=[new s.P(M.x1,M.y1),new s.P(M.x2,M.y1),new s.P(M.x2,M.y2),new s.P(M.x1,M.y2)];s.bX(r,L)&&(T[z.bucketInstanceId][z.featureIndex]=!0,A[z.bucketInstanceId]===void 0&&(A[z.bucketInstanceId]=[]),A[z.bucketInstanceId].push(z.featureIndex))}return A}insertCollisionBox(t,r,h,p,g){(r?this.ignoredGrid:this.grid).insert({bucketInstanceId:h,featureIndex:p,collisionGroupID:g},t[0],t[1],t[2],t[3])}insertCollisionCircles(t,r,h,p,g){const y=r?this.ignoredGrid:this.grid,w={bucketInstanceId:h,featureIndex:p,collisionGroupID:g};for(let T=0;T<t.length;T+=4)y.insertCircle(w,t[T],t[T+1],t[T+2])}projectAndGetPerspectiveRatio(t,r,h,p,g,y,w){const T=[r,h,p,1];let A=!1;p||this.transform.pitch>0?(s.aC(T,T,t),this.fogState&&g&&w.name!=="globe"&&(A=function(L,D,N,B,G,$){const X=$.calculateFogTileMatrix(G),J=[D,N,B];return s.af(J,J,X),Et(L,s.ag(J),$.pitch,$._fov)}(this.fogState,r,h,p,g.toUnwrapped(),this.transform)>.9)):Bt(T,T,t);const M=T[3];return{point:new s.P((T[0]/M+1)/2*this.transform.width+Ei,(-T[1]/M+1)/2*this.transform.height+Ei),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(w)/M*.5,1.5),signedDistanceFromCamera:M,occluded:y&&T[2]>M||A}}isOffscreen(t,r,h,p){return h<Ei||t>=this.screenRightBoundary||p<Ei||r>this.screenBottomBoundary}isInsideGrid(t,r,h,p){return h>=0&&t<this.gridRightBoundary&&p>=0&&r<this.gridBottomBoundary}getViewportMatrix(){const t=s.bA([]);return s.br(t,t,[-100,-100,0]),t}}class go{constructor(t,r,h,p){this.opacity=t?Math.max(0,Math.min(1,t.opacity+(t.placed?r:-r))):p&&h?1:0,this.placed=h}isHidden(){return this.opacity===0&&!this.placed}}class Bs{constructor(t,r,h,p,g,y=!1){this.text=new go(t?t.text:null,r,h,g),this.icon=new go(t?t.icon:null,r,p,g),this.clipped=y}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class Wi{constructor(t,r,h,p=!1){this.text=t,this.icon=r,this.skipFade=h,this.clipped=p}}class Zh{constructor(){this.invProjMatrix=s.bC(),this.viewportMatrix=s.bC(),this.circles=[]}}class ku{constructor(t,r,h,p,g){this.bucketInstanceId=t,this.featureIndex=r,this.sourceLayerIndex=h,this.bucketIndex=p,this.tileID=g}}class Lu{constructor(t){this.crossSourceCollisions=t,this.maxGroupID=0,this.collisionGroups={}}get(t){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[t]){const r=++this.maxGroupID;this.collisionGroups[t]={ID:r,predicate:h=>h.collisionGroupID===r}}return this.collisionGroups[t]}}function $r(u,t,r,h,p){const{horizontalAlign:g,verticalAlign:y}=s.c1(u),w=-(g-.5)*t,T=-(y-.5)*r,A=s.c2(u,h);return new s.P(w+A[0]*p,T+A[1]*p)}function tr(u,t,r,h,p){const g=new s.P(u,t);return r&&g._rotate(h?p:-p),g}class kv{constructor(t,r,h,p,g,y){this.transform=t.clone(),this.projection=t.projection.name,this.collisionIndex=new Ji(this.transform,g),this.buildingIndex=y,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=r,this.retainedQueryData={},this.collisionGroups=new Lu(h),this.collisionCircleArrays={},this.prevPlacement=p,p&&(p.prevPlacement=void 0),this.placedOrientations={},this.lastReplacementSourceUpdateTime=0}getBucketParts(t,r,h,p,g=1){const y=h.getBucket(r),w=h.latestFeatureIndex;if(!y||!w||r.fqid!==y.layerIds[0])return;const T=y.layers[0].layout,A=y.layers[0].paint,M=h.collisionBoxArray,z=Math.pow(2,this.transform.zoom-h.tileID.overscaledZ),L=h.tileSize/s.al,D=h.tileID.toUnwrapped();this.transform.setProjection(y.projection);const N=(B=h.tileID,G=y.getProjection(),$=this.transform,G.name===this.projection?$.calculateProjMatrix(B.toUnwrapped()):mp($,G,B));var B,G,$;const X=T.get("text-pitch-alignment")==="map",J=T.get("text-rotation-alignment")==="map";r.compileFilter(r.options);const K=r.dynamicFilter(),ue=r.dynamicFilterNeedsFeature(),oe=this.transform.calculatePixelsToTileUnitsMatrix(h),le=Wh(N,h.tileID.canonical,X,J,this.transform,y.getProjection(),oe);let re=null;const te=y.getProjection().createInversionMatrix(this.transform,h.tileID.canonical);if(X){const _e=Mu(N,h.tileID.canonical,X,J,this.transform,y.getProjection(),oe);re=s.aB([],this.transform.labelPlaneMatrix,_e)}let he=null;K&&h.latestFeatureIndex&&(he={unwrappedTileID:D,dynamicFilter:K,dynamicFilterNeedsFeature:ue}),this.retainedQueryData[y.bucketInstanceId]=new ku(y.bucketInstanceId,w,y.sourceLayerIndex,y.index,h.tileID);const[we,ye]=y.layers[0].layout.get("text-size-scale-range"),ze=s.aA(g,we,ye),[Oe,$e]=T.get("icon-size-scale-range"),ot=s.aA(g,Oe,$e),Ae={bucket:y,layout:T,paint:A,posMatrix:N,invMatrix:te,mercatorCenter:[s.aF(this.transform.center.lng),s.aJ(this.transform.center.lat)],textLabelPlaneMatrix:le,labelToScreenMatrix:re,clippingData:he,scale:z,textPixelRatio:L,holdingForFade:h.holdingForFade(),collisionBoxArray:M,partiallyEvaluatedTextSize:s.bK(y.textSizeData,this.transform.zoom,ze),partiallyEvaluatedIconSize:s.bK(y.iconSizeData,this.transform.zoom,ot),collisionGroup:this.collisionGroups.get(y.sourceID),latestFeatureIndex:h.latestFeatureIndex};if(p)for(const _e of y.sortKeyRanges){const{sortKey:Ne,symbolInstanceStart:Re,symbolInstanceEnd:Ke}=_e;t.push({sortKey:Ne,symbolInstanceStart:Re,symbolInstanceEnd:Ke,parameters:Ae})}else t.push({symbolInstanceStart:0,symbolInstanceEnd:y.symbolInstances.length,parameters:Ae})}attemptAnchorPlacement(t,r,h,p,g,y,w,T,A,M,z,L,D,N,B,G,$,X,J,K,ue){const{textOffset0:oe,textOffset1:le,crossTileID:re}=B,te=[oe,le],he=$r(t,y,w,te,T),we=this.collisionIndex.placeCollisionBox($,T,r,h,p,g,tr(he.x,he.y,A,M,this.transform.angle),N,z,L,D.predicate);if(J){const ye=$.getSymbolInstanceIconSize(ue,this.transform.zoom,B.placedIconSymbolIndex);if(this.collisionIndex.placeCollisionBox($,ye,J,h,p,g,tr(he.x,he.y,A,M,this.transform.angle),N,z,L,D.predicate).box.length===0)return}if(we.box.length>0){let ye;return this.prevPlacement&&this.prevPlacement.variableOffsets[re]&&this.prevPlacement.placements[re]&&this.prevPlacement.placements[re].text&&(ye=this.prevPlacement.variableOffsets[re].anchor),this.variableOffsets[re]={textOffset:te,width:y,height:w,anchor:t,textScale:T,prevAnchor:ye},this.markUsedJustification($,t,B,X),$.allowVerticalPlacement&&(this.markUsedOrientation($,X,B),this.placedOrientations[re]=X),{shift:he,placedGlyphBoxes:we}}}placeLayerBucketPart(t,r,h,p,g=1){const{bucket:y,layout:w,paint:T,posMatrix:A,textLabelPlaneMatrix:M,labelToScreenMatrix:z,clippingData:L,textPixelRatio:D,mercatorCenter:N,invMatrix:B,holdingForFade:G,collisionBoxArray:$,partiallyEvaluatedTextSize:X,partiallyEvaluatedIconSize:J,collisionGroup:K,latestFeatureIndex:ue}=t.parameters,oe=w.get("text-optional"),le=w.get("icon-optional"),re=w.get("text-allow-overlap"),te=w.get("icon-allow-overlap"),he=w.get("text-rotation-alignment")==="map",we=w.get("icon-rotation-alignment")==="map",ye=w.get("text-pitch-alignment")==="map",ze=T.get("symbol-z-offset"),Oe=w.get("symbol-elevation-reference")==="sea",$e=w.get("symbol-placement"),[ot,Ae]=w.get("text-size-scale-range"),[_e,Ne]=w.get("icon-size-scale-range"),Re=s.aA(g,ot,Ae),Ke=s.aA(g,_e,Ne),pt=w.get("text-variable-anchor"),wt=he&&$e!=="point",ht=we&&$e!=="point",st=pt&&y.hasTextData(),Rt=y.hasIconTextFit()&&st&&y.hasIconData();this.transform.setProjection(y.projection);const At=st||wt,vt=ht||Rt;let Tt=re&&(te||!y.hasIconData()||le),Ut=te&&(re||!y.hasTextData()||oe);const ii=!ze.isConstant();!y.collisionArrays&&$&&y.deserializeCollisionBoxes($),h&&p&&y.updateCollisionDebugBuffers(this.transform.zoom,$,Re,Ke);const wi=(Lt,Fi,ti)=>{const{crossTileID:Gi,numVerticalGlyphVertices:Qi}=Lt;let Xi=null;if(L&&L.dynamicFilterNeedsFeature||ii){const Nn=this.retainedQueryData[y.bucketInstanceId];Xi=ue.loadFeature({featureIndex:Lt.featureIndex,bucketIndex:Nn.bucketIndex,sourceLayerIndex:Nn.sourceLayerIndex,layoutVertexArrayOffset:0});const Wn=Xi.properties?Xi.properties.worldview:null;if(y.localizable&&y.worldview&&typeof Wn=="string")if(Wn==="all")Xi.properties.$localized=!0;else{if(!Wn.split(",").includes(y.worldview))return;Xi.properties.$localized=!0,Xi.properties.worldview=y.worldview}}if(L&&!(0,L.dynamicFilter)({zoom:this.transform.zoom,pitch:this.transform.pitch,worldview:y.worldview},Xi,this.retainedQueryData[y.bucketInstanceId].tileID.canonical,new s.P(Lt.tileAnchorX,Lt.tileAnchorY),this.transform.calculateDistanceTileData(L.unwrappedTileID)))return this.placements[Gi]=new Wi(!1,!1,!1,!0),void r.add(Gi);const Di=ze.evaluate(Xi,{});if(r.has(Gi))return;if(G)return void(this.placements[Gi]=new Wi(!1,!1,!1));let ci=!1,$i=!1,zn=!0,xn=!1,Hi=!1,Ci=null,ui={box:null,offscreen:null,occluded:null},_n={box:null},Gn=null,Cn=null,rn=null,co=0,Fr=0,lr=0;ti.textFeatureIndex?co=ti.textFeatureIndex:Lt.useRuntimeCollisionCircles&&(co=Lt.featureIndex),ti.verticalTextFeatureIndex&&(Fr=ti.verticalTextFeatureIndex);const Hr=y.elevationFeatures?y.elevationFeatures[Lt.elevationFeatureIndex]:void 0,qr=Nn=>{Nn.tileID=this.retainedQueryData[y.bucketInstanceId].tileID;const Wn=this.transform.elevation;Nn.elevation=Oe?Di:Di+s.bV.getAtTileOffset(Nn.tileID,new s.P(Nn.tileAnchorX,Nn.tileAnchorY),Wn,Hr),Nn.elevation+=Lt.zOffset},zr=ti.textBox;if(zr){qr(zr);const Nn=on=>{let Yn=s.bL.horizontal;if(y.allowVerticalPlacement&&!on&&this.prevPlacement){const Dn=this.prevPlacement.placedOrientations[Gi];Dn&&(this.placedOrientations[Gi]=Dn,Yn=Dn,this.markUsedOrientation(y,Yn,Lt))}return Yn},Wn=(on,Yn)=>{if(y.allowVerticalPlacement&&Qi>0&&ti.verticalTextBox){for(const Dn of y.writingModes)if(Dn===s.bL.vertical?(ui=Yn(),_n=ui):ui=on(),ui&&ui.box&&ui.box.length)break}else ui=on()};if(pt){let on=pt;if(this.prevPlacement&&this.prevPlacement.variableOffsets[Gi]){const Pn=this.prevPlacement.variableOffsets[Gi];on.indexOf(Pn.anchor)>0&&(on=on.filter(rs=>rs!==Pn.anchor),on.unshift(Pn.anchor))}const Yn=(Pn,rs,ah)=>{const bs=y.getSymbolInstanceTextSize(X,Lt,this.transform.zoom,Fi),lh=(Pn.x2-Pn.x1)*bs+2*Pn.padding,Vc=(Pn.y2-Pn.y1)*bs+2*Pn.padding,Ws=Lt.hasIconTextFit&&!te?rs:null;Ws&&qr(Ws);let wa={box:[],offscreen:!1,occluded:!1};const $c=re?2*on.length:on.length;for(let hl=0;hl<$c;++hl){const ba=this.attemptAnchorPlacement(on[hl%on.length],Pn,N,B,At,lh,Vc,bs,he,ye,D,A,K,hl>=on.length,Lt,Fi,y,ah,Ws,X,J);if(ba&&(wa=ba.placedGlyphBoxes,wa&&wa.box&&wa.box.length)){ci=!0,Ci=ba.shift;break}}return wa};Wn(()=>Yn(zr,ti.iconBox,s.bL.horizontal),()=>{const Pn=ti.verticalTextBox;return Pn&&qr(Pn),y.allowVerticalPlacement&&!(ui&&ui.box&&ui.box.length)&&Qi>0&&Pn?Yn(Pn,ti.verticalIconBox,s.bL.vertical):{box:null,offscreen:null,occluded:null}}),ui&&(ci=ui.box,zn=ui.offscreen,xn=ui.occluded);const Dn=Nn(!(!ui||!ui.box));if(!ci&&this.prevPlacement){const Pn=this.prevPlacement.variableOffsets[Gi];Pn&&(this.variableOffsets[Gi]=Pn,this.markUsedJustification(y,Pn.anchor,Lt,Dn))}}else{const on=(Yn,Dn)=>{const Pn=y.getSymbolInstanceTextSize(X,Lt,this.transform.zoom,Fi),rs=this.collisionIndex.placeCollisionBox(y,Pn,Yn,N,B,At,new s.P(0,0),re,D,A,K.predicate);return rs&&rs.box&&rs.box.length&&(this.markUsedOrientation(y,Dn,Lt),this.placedOrientations[Gi]=Dn),rs};Wn(()=>on(zr,s.bL.horizontal),()=>{const Yn=ti.verticalTextBox;return y.allowVerticalPlacement&&Qi>0&&Yn?(qr(Yn),on(Yn,s.bL.vertical)):{box:null,offscreen:null,occluded:null}}),Nn(!!(ui&&ui.box&&ui.box.length))}}if(Gn=ui,ci=Gn&&Gn.box&&Gn.box.length>0,zn=Gn&&Gn.offscreen,xn=Gn&&Gn.occluded,Lt.useRuntimeCollisionCircles){const Nn=Lt.centerJustifiedTextSymbolIndex>=0?Lt.centerJustifiedTextSymbolIndex:Lt.verticalPlacedTextSymbolIndex,Wn=y.text.placedSymbolArray.get(Nn),on=s.bM(y.textSizeData,X,Wn),Yn=w.get("text-padding");Cn=this.collisionIndex.placeCollisionCircles(y,re,Wn,Nn,y.lineVertexArray,y.glyphOffsetArray,on,A,M,z,h,ye,K.predicate,Lt.collisionCircleDiameter*on/s.bY,Yn,this.retainedQueryData[y.bucketInstanceId].tileID),ci=re||Cn.circles.length>0&&!Cn.collisionDetected,zn=zn&&Cn.offscreen,xn=Cn.occluded}if(ti.iconFeatureIndex&&(lr=ti.iconFeatureIndex),ti.iconBox){const Nn=Wn=>{qr(Wn);const on=Lt.hasIconTextFit&&Ci?tr(Ci.x,Ci.y,he,ye,this.transform.angle):new s.P(0,0),Yn=y.getSymbolInstanceIconSize(J,this.transform.zoom,Lt.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(y,Yn,Wn,N,B,vt,on,te,D,A,K.predicate)};_n&&_n.box&&_n.box.length&&ti.verticalIconBox?(rn=Nn(ti.verticalIconBox),$i=rn.box.length>0):(rn=Nn(ti.iconBox),$i=rn.box.length>0),zn=zn&&rn.offscreen,Hi=rn.occluded}const No=oe||Lt.numHorizontalGlyphVertices===0&&Qi===0,ns=le||Lt.numIconVertices===0;if(No||ns?ns?No||($i=$i&&ci):ci=$i&&ci:$i=ci=$i&&ci,ci&&Gn&&Gn.box&&this.collisionIndex.insertCollisionBox(Gn.box,w.get("text-ignore-placement"),y.bucketInstanceId,_n&&_n.box&&Fr?Fr:co,K.ID),$i&&rn&&this.collisionIndex.insertCollisionBox(rn.box,w.get("icon-ignore-placement"),y.bucketInstanceId,lr,K.ID),Cn&&(ci&&this.collisionIndex.insertCollisionCircles(Cn.circles,w.get("text-ignore-placement"),y.bucketInstanceId,co,K.ID),h)){const Nn=y.bucketInstanceId;let Wn=this.collisionCircleArrays[Nn];Wn===void 0&&(Wn=this.collisionCircleArrays[Nn]=new Zh);for(let on=0;on<Cn.circles.length;on+=4)Wn.circles.push(Cn.circles[on+0]),Wn.circles.push(Cn.circles[on+1]),Wn.circles.push(Cn.circles[on+2]),Wn.circles.push(Cn.collisionDetected?1:0)}const xo=y.projection.name!=="globe";Tt=Tt&&(xo||!xn),Ut=Ut&&(xo||!Hi),this.placements[Gi]=new Wi(ci||Tt,$i||Ut,zn||y.justReloaded),r.add(Gi)},Ui=this.retainedQueryData[y.bucketInstanceId].tileID;if(y.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(y,Ui),y.elevationType==="road"&&y.updateRoadElevation(Ui.canonical),y.updateZOffset(),y.sortFeaturesByY){const Lt=y.getSortedSymbolIndexes(this.transform.angle);for(let Fi=Lt.length-1;Fi>=0;--Fi){const ti=Lt[Fi];wi(y.symbolInstances.get(ti),ti,y.collisionArrays[ti])}y.hasAnyZOffset&&s.w(`${y.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(y.hasAnyZOffset){const Lt=y.getSortedIndexesByZOffset();for(let Fi=0;Fi<Lt.length;++Fi){const ti=Lt[Fi];wi(y.symbolInstances.get(ti),ti,y.collisionArrays[ti])}}else for(let Lt=t.symbolInstanceStart;Lt<t.symbolInstanceEnd;Lt++)wi(y.symbolInstances.get(Lt),Lt,y.collisionArrays[Lt]);if(h&&y.bucketInstanceId in this.collisionCircleArrays){const Lt=this.collisionCircleArrays[y.bucketInstanceId];s.bl(Lt.invProjMatrix,A),Lt.viewportMatrix=this.collisionIndex.getViewportMatrix()}y.justReloaded=!1}markUsedJustification(t,r,h,p){const{leftJustifiedTextSymbolIndex:g,centerJustifiedTextSymbolIndex:y,rightJustifiedTextSymbolIndex:w,verticalPlacedTextSymbolIndex:T,crossTileID:A}=h,M=s.c3(r),z=p===s.bL.vertical?T:M==="left"?g:M==="center"?y:M==="right"?w:-1;g>=0&&(t.text.placedSymbolArray.get(g).crossTileID=z>=0&&g!==z?0:A),y>=0&&(t.text.placedSymbolArray.get(y).crossTileID=z>=0&&y!==z?0:A),w>=0&&(t.text.placedSymbolArray.get(w).crossTileID=z>=0&&w!==z?0:A),T>=0&&(t.text.placedSymbolArray.get(T).crossTileID=z>=0&&T!==z?0:A)}markUsedOrientation(t,r,h){const p=r===s.bL.horizontal||r===s.bL.horizontalOnly?r:0,g=r===s.bL.vertical?r:0,{leftJustifiedTextSymbolIndex:y,centerJustifiedTextSymbolIndex:w,rightJustifiedTextSymbolIndex:T,verticalPlacedTextSymbolIndex:A}=h,M=t.text.placedSymbolArray;y>=0&&(M.get(y).placedOrientation=p),w>=0&&(M.get(w).placedOrientation=p),T>=0&&(M.get(T).placedOrientation=p),A>=0&&(M.get(A).placedOrientation=g)}commit(t){this.commitTime=t,this.zoomAtLastRecencyCheck=this.transform.zoom;const r=this.prevPlacement;let h=!1;this.prevZoomAdjustment=r?r.zoomAdjustment(this.transform.zoom):0;const p=r?r.symbolFadeChange(t):1,g=r?r.opacities:{},y=r?r.variableOffsets:{},w=r?r.placedOrientations:{};for(const T in this.placements){const A=this.placements[T],M=g[T];M?(this.opacities[T]=new Bs(M,p,A.text,A.icon,null,A.clipped),h=h||A.text!==M.text.placed||A.icon!==M.icon.placed):(this.opacities[T]=new Bs(null,p,A.text,A.icon,A.skipFade,A.clipped),h=h||A.text||A.icon)}for(const T in g){const A=g[T];if(!this.opacities[T]){const M=new Bs(A,p,!1,!1);M.isHidden()||(this.opacities[T]=M,h=h||A.text.placed||A.icon.placed)}}for(const T in y)this.variableOffsets[T]||!this.opacities[T]||this.opacities[T].isHidden()||(this.variableOffsets[T]=y[T]);for(const T in w)this.placedOrientations[T]||!this.opacities[T]||this.opacities[T].isHidden()||(this.placedOrientations[T]=w[T]);h?this.lastPlacementChangeTime=t:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=r?r.lastPlacementChangeTime:t)}updateLayerOpacities(t,r,h,p){p&&(this.lastReplacementSourceUpdateTime=p.updateTime);const g=new Set;for(const y of r){const w=y.getBucket(t);w&&y.latestFeatureIndex&&t.fqid===w.layerIds[0]&&(this.updateBucketOpacities(w,g,y,y.collisionBoxArray,h,p,y.tileID,t.scope),w.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(w,y.tileID),w.elevationType==="road"&&w.updateRoadElevation(y.tileID.canonical),w.updateZOffset())}}updateBucketOpacities(t,r,h,p,g,y,w,T){t.hasTextData()&&t.text.opacityVertexArray.clear(),t.hasIconData()&&t.icon.opacityVertexArray.clear(),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexArray.clear(),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexArray.clear();const A=t.layers[0].layout,M=t.layers[0].paint,z=!!t.layers[0].dynamicFilter(),L=new Bs(null,0,!1,!1,!0),D=A.get("text-allow-overlap"),N=A.get("icon-allow-overlap"),B=A.get("text-variable-anchor"),G=A.get("text-rotation-alignment")==="map",$=A.get("text-pitch-alignment")==="map",X=M.get("symbol-z-offset"),J=A.get("symbol-elevation-reference")==="sea",K=!X.isConstant(),ue=new Bs(null,0,D&&(N||!t.hasIconData()||A.get("icon-optional")),N&&(D||!t.hasTextData()||A.get("text-optional")),!0);!t.collisionArrays&&p&&(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData())&&t.deserializeCollisionBoxes(p);const oe=(re,te,he)=>{for(let we=0;we<te/4;we++)re.opacityVertexArray.emplaceBack(he)};let le=0;y&&t.updateReplacement(w,y);for(let re=0;re<t.symbolInstances.length;re++){const te=t.symbolInstances.get(re),{numHorizontalGlyphVertices:he,numVerticalGlyphVertices:we,crossTileID:ye,numIconVertices:ze,tileAnchorX:Oe,tileAnchorY:$e}=te;let ot=null;const Ae=this.retainedQueryData[t.bucketInstanceId];K&&te&&Ae&&(ot=h.latestFeatureIndex.loadFeature({featureIndex:te.featureIndex,bucketIndex:Ae.bucketIndex,sourceLayerIndex:Ae.sourceLayerIndex,layoutVertexArrayOffset:0}));const _e=X.evaluate(ot,{}),Ne=r.has(ye);let Re=this.opacities[ye];Ne?Re=L:Re||(Re=ue,this.opacities[ye]=Re),r.add(ye);const Ke=he>0||we>0,pt=ze>0,wt=this.placedOrientations[ye],ht=wt===s.bL.vertical,st=wt===s.bL.horizontal||wt===s.bL.horizontalOnly;!Ke&&!pt||Re.isHidden()||le++;let Rt=!1;if((Ke||pt)&&y)for(const At of t.activeReplacements){if(s.bZ(At,g,s.b_.Symbol,T)||At.min.x>Oe||Oe>At.max.x||At.min.y>$e||$e>At.max.y)continue;const vt=s.b$(Oe,$e,w.canonical,At.footprintTileId.canonical);if(Rt=s.c0(vt,At.footprint),Rt)break}if(Ke){const At=Rt?Fl:oo(Re.text);oe(t.text,he,ht?Fl:At),oe(t.text,we,st?Fl:At);const vt=Re.text.isHidden(),{leftJustifiedTextSymbolIndex:Tt,centerJustifiedTextSymbolIndex:Ut,rightJustifiedTextSymbolIndex:ii,verticalPlacedTextSymbolIndex:wi}=te,Ui=t.text.placedSymbolArray,Lt=vt||ht?1:0;Tt>=0&&(Ui.get(Tt).hidden=Lt),Ut>=0&&(Ui.get(Ut).hidden=Lt),ii>=0&&(Ui.get(ii).hidden=Lt),wi>=0&&(Ui.get(wi).hidden=vt||st?1:0);const Fi=this.variableOffsets[ye];Fi&&this.markUsedJustification(t,Fi.anchor,te,wt);const ti=this.placedOrientations[ye];ti&&(this.markUsedJustification(t,"left",te,ti),this.markUsedOrientation(t,ti,te))}if(pt){const At=Rt?Fl:oo(Re.icon),{placedIconSymbolIndex:vt,verticalPlacedIconSymbolIndex:Tt}=te,Ut=t.icon.placedSymbolArray,ii=Re.icon.isHidden()?1:0;vt>=0&&(oe(t.icon,ze,ht?Fl:At),Ut.get(vt).hidden=ii),Tt>=0&&(oe(t.icon,te.numVerticalIconVertices,st?Fl:At),Ut.get(Tt).hidden=ii)}if(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData()){const At=t.collisionArrays[re];if(At){let vt=new s.P(0,0),Tt=!0;if(At.textBox||At.verticalTextBox){if(B){const ii=this.variableOffsets[ye];ii?(vt=$r(ii.anchor,ii.width,ii.height,ii.textOffset,ii.textScale),G&&vt._rotate($?this.transform.angle:-this.transform.angle)):Tt=!1}z&&(Tt=!Re.clipped),At.textBox&&Ka(t.textCollisionBox.collisionVertexArray,Re.text.placed,!Tt||ht,_e,J,vt.x,vt.y),At.verticalTextBox&&Ka(t.textCollisionBox.collisionVertexArray,Re.text.placed,!Tt||st,_e,J,vt.x,vt.y)}const Ut=Tt&&!!(!st&&At.verticalIconBox);At.iconBox&&Ka(t.iconCollisionBox.collisionVertexArray,Re.icon.placed,Ut,_e,J,te.hasIconTextFit?vt.x:0,te.hasIconTextFit?vt.y:0),At.verticalIconBox&&Ka(t.iconCollisionBox.collisionVertexArray,Re.icon.placed,!Ut,_e,J,te.hasIconTextFit?vt.x:0,te.hasIconTextFit?vt.y:0)}}}if(t.fullyClipped=le===0,t.sortFeatures(this.transform.angle),this.retainedQueryData[t.bucketInstanceId]&&(this.retainedQueryData[t.bucketInstanceId].featureSortOrder=t.featureSortOrder),t.hasTextData()&&t.text.opacityVertexBuffer&&t.text.opacityVertexBuffer.updateData(t.text.opacityVertexArray),t.hasIconData()&&t.icon.opacityVertexBuffer&&t.icon.opacityVertexBuffer.updateData(t.icon.opacityVertexArray),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexBuffer&&t.iconCollisionBox.collisionVertexBuffer.updateData(t.iconCollisionBox.collisionVertexArray),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexBuffer&&t.textCollisionBox.collisionVertexBuffer.updateData(t.textCollisionBox.collisionVertexArray),t.bucketInstanceId in this.collisionCircleArrays){const re=this.collisionCircleArrays[t.bucketInstanceId];t.placementInvProjMatrix=re.invProjMatrix,t.placementViewportMatrix=re.viewportMatrix,t.collisionCircleArray=re.circles,delete this.collisionCircleArrays[t.bucketInstanceId]}}symbolFadeChange(t){return this.fadeDuration===0?1:(t-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(t){return Math.max(0,(this.transform.zoom-t)/1.5)}hasTransitions(t){return this.stale||t-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(t,r){const h=this.zoomAtLastRecencyCheck===r?1-this.zoomAdjustment(r):1;return this.zoomAtLastRecencyCheck=r,this.commitTime+this.fadeDuration*h>t}isStale(){return this.stale}setStale(){this.stale=!0}}function Ka(u,t,r,h,p,g,y){u.emplaceBack(t?1:0,r?1:0,g||0,y||0,h,p?1:0),u.emplaceBack(t?1:0,r?1:0,g||0,y||0,h,p?1:0),u.emplaceBack(t?1:0,r?1:0,g||0,y||0,h,p?1:0),u.emplaceBack(t?1:0,r?1:0,g||0,y||0,h,p?1:0)}const yp=Math.pow(2,25),zu=Math.pow(2,24),Xh=Math.pow(2,17),vp=Math.pow(2,16),Kh=Math.pow(2,9),ro=Math.pow(2,8),la=Math.pow(2,1);function oo(u){if(u.opacity===0&&!u.placed)return 0;if(u.opacity===1&&u.placed)return 4294967295;const t=u.placed?1:0,r=Math.floor(127*u.opacity);return r*yp+t*zu+r*Xh+t*vp+r*Kh+t*ro+r*la+t}const Fl=0;class vc{constructor(t){this._sortAcrossTiles=t.layout.get("symbol-z-order")!=="viewport-y"&&t.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(t,r,h,p,g,y){const w=this._bucketParts;for(;this._currentTileIndex<t.length;)if(r.getBucketParts(w,p,t[this._currentTileIndex],this._sortAcrossTiles,y),this._currentTileIndex++,g())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,w.sort((T,A)=>T.sortKey-A.sortKey));this._currentPartIndex<w.length;){const T=w[this._currentPartIndex];if(r.placeLayerBucketPart(T,this._seenCrossTileIDs,h,T.symbolInstanceStart===0,y),this._currentPartIndex++,g())return!0}return!1}}class wr{constructor(t,r,h,p,g,y,w,T,A){this.placement=new kv(t,g,y,w,T,A),this._currentPlacementIndex=r.length-1,this._forceFullPlacement=h,this._showCollisionBoxes=p,this._done=!1}isDone(){return this._done}continuePlacement(t,r,h,p,g){const y=s.o.now(),w=()=>{const T=s.o.now()-y;return!this._forceFullPlacement&&T>2};for(;this._currentPlacementIndex>=0;){const T=r[t[this._currentPlacementIndex]],A=this.placement.collisionIndex.transform.zoom;if(T.type==="symbol"&&T.visibility!=="none"&&(!T.minzoom||T.minzoom<=A)&&(!T.maxzoom||T.maxzoom>A)){const M=T,z=M.layout.get("symbol-z-elevate"),L=M.layout.get("symbol-sort-key").constantOr(1)!==void 0,D=M.layout.get("symbol-z-order"),N=D==="viewport-y"||D==="auto"&&!(D!=="viewport-y"&&L),B=M.layout.get("text-allow-overlap")||M.layout.get("icon-allow-overlap")||M.layout.get("text-ignore-placement")||M.layout.get("icon-ignore-placement"),G=N&&B,$=this._inProgressLayer=this._inProgressLayer||new vc(M),X=s.B(T.source,T.scope);if($.continuePlacement(z||G?p[X]:h[X],this.placement,this._showCollisionBoxes,T,w,g))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(t){return this.placement.commit(t),this.placement}}const Yo=512/s.al/2;class ca{constructor(t,r,h){this.tileID=t,this.bucketInstanceId=h,this.index=new s.c4(r.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const p=t.canonical.x*s.al,g=t.canonical.y*s.al;for(let y=0;y<r.length;y++){const{key:w,crossTileID:T,tileAnchorX:A,tileAnchorY:M}=r.get(y),z=Math.floor((p+A)*Yo),L=Math.floor((g+M)*Yo);this.index.add(z,L),this.keys.push(w),this.crossTileIDs.push(T)}this.index.finish()}findMatches(t,r,h){const p=this.tileID.canonical.z<r.canonical.z?1:Math.pow(2,this.tileID.canonical.z-r.canonical.z),g=Yo/Math.pow(2,r.canonical.z-this.tileID.canonical.z),y=r.canonical.x*s.al,w=r.canonical.y*s.al;for(let T=0;T<t.length;T++){const A=t.get(T);if(A.crossTileID)continue;const{key:M,tileAnchorX:z,tileAnchorY:L}=A,D=Math.floor((y+z)*g),N=Math.floor((w+L)*g),B=this.index.range(D-p,N-p,D+p,N+p).sort((G,$)=>G-$);for(const G of B){const $=this.crossTileIDs[G];if(this.keys[G]===M&&!h.has($)){h.add($),A.crossTileID=$;break}}}}}class mr{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class xp{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(t){const r=Math.round((t-this.lng)/360);if(r!==0)for(const h in this.indexes){const p=this.indexes[h],g={};for(const y in p){const w=p[y];w.tileID=w.tileID.unwrapTo(w.tileID.wrap+r),g[w.tileID.key]=w}this.indexes[h]=g}this.lng=t}addBucket(t,r,h){if(this.indexes[t.overscaledZ]&&this.indexes[t.overscaledZ][t.key]){if(this.indexes[t.overscaledZ][t.key].bucketInstanceId===r.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(t.overscaledZ,this.indexes[t.overscaledZ][t.key])}for(let g=0;g<r.symbolInstances.length;g++)r.symbolInstances.get(g).crossTileID=0;this.usedCrossTileIDs[t.overscaledZ]||(this.usedCrossTileIDs[t.overscaledZ]=new Set);const p=this.usedCrossTileIDs[t.overscaledZ];for(const g in this.indexes){const y=this.indexes[g];if(Number(g)>t.overscaledZ)for(const w in y){const T=y[w];T.tileID.isChildOf(t)&&T.findMatches(r.symbolInstances,t,p)}else{const w=y[t.scaledTo(Number(g)).key];w&&w.findMatches(r.symbolInstances,t,p)}}for(let g=0;g<r.symbolInstances.length;g++){const y=r.symbolInstances.get(g);y.crossTileID||(y.crossTileID=h.generate(),p.add(y.crossTileID))}return this.indexes[t.overscaledZ]===void 0&&(this.indexes[t.overscaledZ]={}),this.indexes[t.overscaledZ][t.key]=new ca(t,r.symbolInstances,r.bucketInstanceId),!0}removeBucketCrossTileIDs(t,r){for(const h of r.crossTileIDs)this.usedCrossTileIDs[t].delete(h)}removeStaleBuckets(t){let r=!1;for(const h in this.indexes){const p=this.indexes[h];for(const g in p)t[p[g].bucketInstanceId]||(this.removeBucketCrossTileIDs(h,p[g]),delete p[g],r=!0)}return r}}class gs{constructor(){this.layerIndexes={},this.crossTileIDs=new mr,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(t,r,h,p){let g=this.layerIndexes[t.fqid];g===void 0&&(g=this.layerIndexes[t.fqid]=new xp);let y=!1;const w={};p.name!=="globe"&&g.handleWrapJump(h);for(const T of r){const A=T.getBucket(t);A&&t.fqid===A.layerIds[0]&&(A.bucketInstanceId||(A.bucketInstanceId=++this.maxBucketInstanceId),g.addBucket(T.tileID,A,this.crossTileIDs)&&(y=!0),w[A.bucketInstanceId]=!0)}return g.removeStaleBuckets(w)&&(y=!0),y}pruneUnusedLayers(t){const r={};t.forEach(h=>{r[h]=!0});for(const h in this.layerIndexes)r[h]||delete this.layerIndexes[h]}}const Ns=771;class ai{constructor(t,r,h,p){this.blendFunction=t,this.blendColor=r.toNonPremultipliedRenderColor(null),this.mask=h,this.blendEquation=p}}ai.Replace=[1,0,1,0],ai.disabled=new ai(ai.Replace,s.ao.transparent,[!1,!1,!1,!1]),ai.unblended=new ai(ai.Replace,s.ao.transparent,[!0,!0,!0,!0]),ai.alphaBlended=new ai([1,Ns,1,Ns],s.ao.transparent,[!0,!0,!0,!0]),ai.alphaBlendedNonPremultiplied=new ai([770,Ns,770,Ns],s.ao.transparent,[!0,!0,!0,!0]),ai.multiply=new ai([774,0,774,0],s.ao.transparent,[!0,!0,!0,!0]),ai.additive=new ai([1,1,1,1],s.ao.transparent,[!0,!0,!0,!0]);class Dt{constructor(t,r,h){this.func=t,this.mask=r,this.range=h}}Dt.ReadOnly=!1,Dt.ReadWrite=!0,Dt.disabled=new Dt(519,Dt.ReadOnly,[0,1]);const Yh=7680;class Jt{constructor(t,r,h,p,g,y){this.test=t,this.ref=r,this.mask=h,this.fail=p,this.depthFail=g,this.pass=y}}Jt.disabled=new Jt({func:519,mask:0},0,0,Yh,Yh,Yh);const xc=1029,Jh=2305;class Yt{constructor(t,r,h){this.enable=t,this.mode=r,this.frontFace=h}}function js(u,t){const r=s.ca(u,3);s.cc(u,t),s.cg(u,3,r)}function wp(u,t){const r=s.c7([]);return s.c8(r,r,-t),s.c9(r,r,-u),r}function Qh(u,t){const r=[u[0],u[1],0],h=[t[0],t[1],0];if(s.ag(r)>=1e-15){const y=s.aw([],r);s.c5(h,y,s.bJ(h,y)),t[0]=h[0],t[1]=h[1]}const p=s.bI([],t,u);if(s.c6(p)<1e-15)return null;const g=Math.atan2(-p[1],p[0]);return wp(Math.atan2(Math.sqrt(u[0]*u[0]+u[1]*u[1]),-u[2]),g)}Yt.disabled=new Yt(!1,xc,Jh),Yt.backCCW=new Yt(!0,xc,Jh),Yt.backCW=new Yt(!0,xc,2304),Yt.frontCW=new Yt(!0,1028,2304),Yt.frontCCW=new Yt(!0,1028,Jh);class so{constructor(t,r){this.position=t,this.orientation=r}get position(){return this._position}set position(t){if(t){const r=t instanceof s.ae?t:new s.ae(t[0],t[1],t[2]);this._renderWorldCopies&&(r.x=s.bT(r.x,0,1)),this._position=r}else this._position=null}lookAtPoint(t,r,h){if(this.orientation=null,!this.position)return;const p=this.position,g=h||(this._elevation?this._elevation.getAtPointOrZero(s.ae.fromLngLat(t)):0),y=s.ae.fromLngLat(t,g),w=[y.x-p.x,y.y-p.y,y.z-p.z];r||(r=[0,0,1]),r[2]=Math.abs(r[2]),this.orientation=Qh(w,r)}setPitchBearing(t,r){this.orientation=wp(s.an(t),s.an(-r))}}class ed{constructor(t,r){this._transform=s.bA([]),this.orientation=r,this.position=t}get mercatorPosition(){const t=this.position;return new s.ae(t[0],t[1],t[2])}get position(){const t=s.ca(this._transform,3);return[t[0],t[1],t[2]]}set position(t){var r;t&&s.cg(this._transform,3,[(r=t)[0],r[1],r[2],1])}get orientation(){return this._orientation}set orientation(t){this._orientation=t||s.c7([]),t&&js(this._transform,this._orientation)}getPitchBearing(){const t=this.forward(),r=this.right();return{bearing:Math.atan2(-r[1],r[0]),pitch:Math.atan2(Math.sqrt(t[0]*t[0]+t[1]*t[1]),-t[2])}}setPitchBearing(t,r){this._orientation=wp(t,r),js(this._transform,this._orientation)}forward(){const t=s.ca(this._transform,2);return[-t[0],-t[1],-t[2]]}up(){const t=s.ca(this._transform,1);return[-t[0],-t[1],-t[2]]}right(){const t=s.ca(this._transform,0);return[t[0],t[1],t[2]]}getCameraToWorld(t,r){const h=new Float64Array(16);return s.bl(h,this.getWorldToCamera(t,r)),h}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(t,r,h){const p=this.position;s.c5(p,p,-t);const g=new Float64Array(16);return s.bq(g,[h,h,h]),s.br(g,g,p),g[10]*=r,g}getWorldToCamera(t,r){const h=new Float64Array(16),p=new Float64Array(4),g=this.position;return s.cb(p,this._orientation),s.c5(g,g,-t),s.cc(h,p),s.br(h,h,g),h[1]*=-1,h[5]*=-1,h[9]*=-1,h[13]*=-1,h[8]*=r,h[9]*=r,h[10]*=r,h[11]*=r,h}getCameraToClipPerspective(t,r,h,p){const g=new Float64Array(16);return s.cd(g,t,r,h,p),g}getCameraToClipOrthographic(t,r,h,p,g,y){const w=new Float64Array(16);return s.ce(w,t,r,h,p,g,y),w}getDistanceToElevation(t,r=!1){const h=t===0?0:s.cf(t,r?s.a$(this.position[1]):this.position[1]),p=this.forward();return(h-this.position[2])/p[2]}clone(){return new ed([...this.position],[...this.orientation])}}const Cr={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,LUT:10,ShadowMap0:11};class td{constructor(t=0,r=0,h=0,p=0){if(isNaN(t)||t<0||isNaN(r)||r<0||isNaN(h)||h<0||isNaN(p)||p<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=t,this.bottom=r,this.left=h,this.right=p}interpolate(t,r,h){return r.top!=null&&t.top!=null&&(this.top=s.ak(t.top,r.top,h)),r.bottom!=null&&t.bottom!=null&&(this.bottom=s.ak(t.bottom,r.bottom,h)),r.left!=null&&t.left!=null&&(this.left=s.ak(t.left,r.left,h)),r.right!=null&&t.right!=null&&(this.right=s.ak(t.right,r.right,h)),this}getCenter(t,r){const h=s.aA((this.left+t-this.right)/2,0,t),p=s.aA((this.top+r-this.bottom)/2,0,r);return new s.P(h,p)}equals(t){return this.top===t.top&&this.bottom===t.bottom&&this.left===t.left&&this.right===t.right}clone(){return new td(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}const ys=15;class bp{constructor(t,r,h,p,g,y,w){this.tileSize=512,this._renderWorldCopies=g===void 0||g,this._minZoom=t||0,this._maxZoom=r||22,this._minPitch=h??0,this._maxPitch=p??60,this.setProjection(y),this.setMaxBounds(w),this.width=0,this.height=0,this._center=new s.aT(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new td,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new ed,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1,this._allowWorldUnderZoom=!1}clone(){const t=new bp(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection(),this.maxBounds);return t._elevation=this._elevation,t._centerAltitude=this._centerAltitude,t._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,t.tileSize=this.tileSize,t.mercatorFromTransition=this.mercatorFromTransition,t.width=this.width,t.height=this.height,t.cameraElevationReference=this.cameraElevationReference,t._center=this._center,t._setZoom(this.zoom),t._seaLevelZoom=this._seaLevelZoom,t.angle=this.angle,t._fov=this._fov,t._pitch=this._pitch,t._nearZ=this._nearZ,t._farZ=this._farZ,t._averageElevation=this._averageElevation,t._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,t._unmodified=this._unmodified,t._edgeInsets=this._edgeInsets.clone(),t._camera=this._camera.clone(),t._calcMatrices(),t.freezeTileCoverage=this.freezeTileCoverage,t.frustumCorners=this.frustumCorners,t._allowWorldUnderZoom=this._allowWorldUnderZoom,t}get isOrthographic(){return this.projection.name!=="globe"&&this._orthographicProjectionAtLowPitch&&this.pitch<ys}get elevation(){return this._elevation}set elevation(t){this._elevation!==t&&(this._elevation=t,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return this.projection.name!=="globe"&&!this.isOrthographic}updateElevation(t,r=!1){const h=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(this._seaLevelZoom==null||h)&&this._updateCameraOnTerrain(),(t||h)&&this._constrainCamera(r),this._calcMatrices()}getProjection(){return s.aH(this.projection,["name","center","parallels"])}setProjection(t){this.projectionOptions=t||{name:"mercator"};const r=this.projection?this.getProjection():void 0;this.projection=s.cm(this.projectionOptions);const h=this.getProjection(),p=!s.by(r,h);return p&&this._calcMatrices(),this.mercatorFromTransition=!1,p}setOrthographicProjectionAtLowPitch(t){return this._orthographicProjectionAtLowPitch!==t&&(this._orthographicProjectionAtLowPitch=t,this._calcMatrices(),!0)}setMercatorFromTransition(){const t=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=s.cm({name:"mercator"});const r=t!==this.projection.name;return r&&this._calcMatrices(),r}get minZoom(){return this._minZoom}set minZoom(t){this._minZoom!==t&&(this._minZoom=t,this.zoom=Math.max(this.zoom,t))}get maxZoom(){return this._maxZoom}set maxZoom(t){this._maxZoom!==t&&(this._maxZoom=t,this.zoom=Math.min(this.zoom,t))}get minPitch(){return this._minPitch}set minPitch(t){this._minPitch!==t&&(this._minPitch=t,this.pitch=Math.max(this.pitch,t))}get maxPitch(){return this._maxPitch}set maxPitch(t){this._maxPitch!==t&&(this._maxPitch=t,this.pitch=Math.min(this.pitch,t))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(t){t===void 0?t=!0:t===null&&(t=!1),this._renderWorldCopies=t}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const t=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get cameraWorldSize(){const t=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return s.cf(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new s.P(this.width,this.height)}get bearing(){return s.bT(this.rotation,-180,180)}set bearing(t){this.rotation=t}get rotation(){return-this.angle/Math.PI*180}set rotation(t){const r=-t*Math.PI/180;this.angle!==r&&(this._unmodified=!1,this.angle=r,this._calcMatrices(),this.rotationMatrix=s.cn(),s.co(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(t){const r=s.aA(t,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==r&&(this._unmodified=!1,this._pitch=r,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}set fov(t){t=Math.max(.01,Math.min(60,t)),this._fov!==t&&(this._unmodified=!1,this._fov=s.an(t),this._calcMatrices())}get fovX(){return this._fov}get fovY(){const t=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/t)}get averageElevation(){return this._averageElevation}set averageElevation(t){this._averageElevation=t,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(t){const r=Math.min(Math.max(t,this.minZoom),this.maxZoom);this._zoom!==r&&(this._unmodified=!1,this._setZoom(r),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(t){this._zoom=t,this.scale=this.zoomScale(t),this.tileZoom=Math.floor(t),this.zoomFraction=t-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(t){this._tileCoverLift!==t&&(this._tileCoverLift=t)}_updateCameraOnTerrain(){const t=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,r=this.elevation&&t===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||t===Number.NEGATIVE_INFINITY&&(!r||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const h=this._elevation;r||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&h.exaggeration()&&this._centerAltitudeValidForExaggeration!==h.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*h.exaggeration(),this._centerAltitudeValidForExaggeration=h.exaggeration()):(this._centerAltitude=t||0,this._centerAltitudeValidForExaggeration=h.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){if(this._centerAltitudeValidForExaggeration===void 0)return;const t=Math.max(0,(this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize);this._seaLevelZoom=this._zoomFromMercatorZ(t)}sampleAverageElevation(){if(!this._elevation)return 0;const t=this._elevation,r=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],h=this.horizonLineFromTop();let p=0,g=0;for(let y=0;y<r.length;y++){const w=new s.P(r[y][0]*this.width,h+r[y][1]*(this.height-h)),T=t.pointCoordinate(w);if(!T)continue;const A=1/Math.hypot(T[0]-this._camera.position[0],T[1]-this._camera.position[1]);p+=T[3]*A,g+=A}return g===0?NaN:p/g}get center(){return this._center}set center(t){t.lat===this._center.lat&&t.lng===this._center.lng||(this._unmodified=!1,this._center=t,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._seaLevelZoom==null||!this._elevation)return;const t=this._seaLevelZoom,r=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),h=this.pixelsPerMeter/this.worldSize*r,p=this._mercatorZfromZoom(t),g=this._mercatorZfromZoom(this._maxZoom),y=Math.max(p-h,g);this._setZoom(this._zoomFromMercatorZ(y))}get padding(){return this._edgeInsets.toJSON()}set padding(t){this._edgeInsets.equals(t)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,t,1),this._calcMatrices())}equals(t){const r=this.elevation,h=t.elevation,p=r!=null!=(h!=null)||r&&h&&r.exaggeration()!==h.exaggeration();return this.width===t.width&&this.height===t.height&&this.center.lng===t.center.lng&&this.center.lat===t.center.lat&&this.zoom===t.zoom&&this.bearing===t.bearing&&this.pitch===t.pitch&&this.fov===t.fov&&this.projection.name===t.projection.name&&this._edgeInsets.equals(t.padding)&&!p}computeZoomRelativeTo(t){const r=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,t.toAltitude()));let h;h=t.z<this._camera.position[2]?[r.x,r.y,r.z]:[t.x,t.y,t.z];const p=s.ag(s.av([],this._camera.position,h));return s.aA(this._zoomFromMercatorZ(p),this._minZoom,this._maxZoom)}setFreeCameraOptions(t){if(!this.height||!t.position&&!t.orientation)return;this._updateCameraState();let r=!1;if(t.orientation&&!s.cp(t.orientation,this._camera.orientation)&&(r=this._setCameraOrientation(t.orientation)),t.position){const h=[t.position.x,t.position.y,t.position.z];s.cq(h,this._camera.position)||(this._setCameraPosition(h),r=!0)}r&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const t=this._camera.position,r=new so;return r.position=new s.ae(t[0],t[1],t[2]),r.orientation=this._camera.orientation,r._elevation=this.elevation,r._renderWorldCopies=this.renderWorldCopies,r}_setCameraOrientation(t){if(!s.cr(t))return!1;s.cs(t,t);const r=s.ct([],[0,0,-1],t),h=s.ct([],[0,-1,0],t);if(h[2]<0)return!1;const p=Qh(r,h);return!!p&&(this._camera.orientation=p,!0)}_setCameraPosition(t){const r=this.zoomScale(this.minZoom)*this.tileSize,h=this.zoomScale(this.maxZoom)*this.tileSize,p=this.cameraToCenterDistance;t[2]=s.aA(t[2],p/h,p/r),this._camera.position=t}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(t){return this._edgeInsets.equals(t)}interpolatePadding(t,r,h){this._unmodified=!1,this._edgeInsets.interpolate(t,r,h),this._constrain(),this._calcMatrices()}coveringZoomLevel(t){const r=(t.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/t.tileSize));return Math.max(0,r)}getVisibleUnwrappedCoordinates(t){const r=[new s.cu(0,t)];if(this.renderWorldCopies){const h=this.pointCoordinate(new s.P(0,0)),p=this.pointCoordinate(new s.P(this.width,0)),g=this.pointCoordinate(new s.P(this.width,this.height)),y=this.pointCoordinate(new s.P(0,this.height)),w=Math.floor(Math.min(h.x,p.x,g.x,y.x)),T=Math.floor(Math.max(h.x,p.x,g.x,y.x)),A=1;for(let M=w-A;M<=T+A;M++)M!==0&&r.push(new s.cu(M,t))}return r}isLODDisabled(t){return(!t||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCover(t,r,h,p){let g=[];const y=h!=null,w=!y;if(w&&this.zoom<r||y&&h[0]===0&&h[1]===0)return g;const T=new Set,A=(z,L,D,N,B)=>{const G=s.cY(L,z,D,N,B);T.has(G)||(g.push(new s.aQ(z,L,D,N,B)),T.add(G))};for(let z=0;z<t.length;z++){const L=t[z];if(w&&L.canonical.z!==r||y&&p!==void 0&&p>L.canonical.z)continue;const D=L.canonical,N=L.overscaledZ,B=L.wrap,G=1<<D.z,$=D.x+1<G,X=D.x>0,J=D.y+1<G,K=D.y>0,ue=L.wrap-(X?0:1),oe=L.wrap+($?0:1),le=X?D.x-1:G-1,re=$?D.x+1:0;if(y)h[0]<0?(A(N,oe,D.z,re,D.y),h[1]<0&&J&&(A(N,B,D.z,D.x,D.y+1),A(N,oe,D.z,re,D.y+1)),h[1]>0&&K&&(A(N,B,D.z,D.x,D.y-1),A(N,oe,D.z,re,D.y-1))):h[0]>0?(A(N,ue,D.z,le,D.y),h[1]<0&&J&&(A(N,B,D.z,D.x,D.y+1),A(N,ue,D.z,le,D.y+1)),h[1]>0&&K&&(A(N,B,D.z,D.x,D.y-1),A(N,ue,D.z,le,D.y-1))):h[1]<0&&J?A(N,B,D.z,D.x,D.y+1):K&&A(N,B,D.z,D.x,D.y-1);else{const te=L.visibleQuadrants;1&te&&(A(N,ue,D.z,le,D.y),K&&(A(N,B,D.z,D.x,D.y-1),A(N,ue,D.z,le,D.y-1))),2&te&&(A(N,oe,D.z,re,D.y),K&&(A(N,B,D.z,D.x,D.y-1),A(N,oe,D.z,re,D.y-1))),4&te&&(A(N,ue,D.z,le,D.y),J&&(A(N,B,D.z,D.x,D.y+1),A(N,ue,D.z,le,D.y+1))),8&te&&(A(N,oe,D.z,re,D.y),J&&(A(N,B,D.z,D.x,D.y+1),A(N,oe,D.z,re,D.y+1)))}}const M=[];for(const z of g)g.some(L=>z.isChildOf(L))||M.push(z);if(g=M.filter(z=>!t.some(L=>!!(z.overscaledZ<r&&L.isChildOf(z))||z.equals(L)||z.isChildOf(L))),w){const z=1<<r,L=this.projection.name==="globe"?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),D=[z*L.x,z*L.y],N=4,B=N*N;g=g.filter(G=>{const $=G.canonical.x+.5-D[0],X=G.canonical.y+.5-D[1];return $*$+X*X<B})}return g}extendTileCoverToNearPlane(t,r,h){const p=[],g=new Set;for(const X of t)g.add(X.key);const y=(X,J,K,ue,oe)=>{const le=s.cY(J,X,K,ue,oe);g.has(le)||(p.push(new s.aQ(X,J,K,ue,oe)),g.add(le))},w=t.reduce((X,J)=>Math.max(X,J.overscaledZ),h),T=1<<h,A=[new s.P(0,0),new s.P(s.al,0),new s.P(s.al,s.al),new s.P(0,s.al)],M=new s.P(0,0),z=new s.P(0,0),L=(X,J)=>{const K=Math.floor(X[0]),ue=Math.floor(X[1]),oe=(X[0]-K)*s.al,le=(X[1]-ue)*s.al,re=Math.floor(J[0]),te=Math.floor(J[1]),he=(J[0]-re)*s.al,we=(J[1]-te)*s.al;for(let ye=-1;ye<=1;ye++){const ze=K+ye;if(!(ze<0||ze>=T)){M.x=oe-ye*s.al,z.x=he-(ze-re)*s.al;for(let Oe=-1;Oe<=1;Oe++){const $e=ue+Oe;M.y=le-Oe*s.al,z.y=we-($e-te)*s.al,s.cZ(M,z,A)&&y(w,0,h,ze,$e)}}}},D=r.points,N=D[s.cv],B=D[s.cw],G=this._projectToGround(N,D[s.cx]),$=this._projectToGround(B,D[s.cy]);return L(N,G),L(B,$),p}_projectToGround(t,r){return s.cz(s.cA(),t,r,t[2]/(t[2]-r[2]))}coveringTiles(t){let r=this.coveringZoomLevel(t);const h=r,p=this.elevation&&this.elevation.exaggeration(),g=p&&!t.isTerrainDEM,y=this.projection.name==="mercator";if(t.minzoom!==void 0&&r<t.minzoom)return[];t.maxzoom!==void 0&&r>t.maxzoom&&(r=t.maxzoom);const w=this.locationCoordinate(this.center),T=this.center.lat,A=1<<r,M=[A*w.x,A*w.y,0],z=this.projection.name==="globe",L=!z,D=s.cB.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,r,L),N=z?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),B=A*s.cf(1,this.center.lat),G=this._camera.position[2]/s.cf(1,this.center.lat),$=[A*N.x,A*N.y,G*(L?1:B)],X=z||p,J=this.cameraToCenterDistance/t.tileSize*(t.roundZoom?1:.502),K=this.isLODDisabled(!0)?r:0;let ue;if(this._elevation&&t.isTerrainDEM)ue=1e4*this._elevation.exaggeration();else if(this._elevation){const _e=this._elevation.getMinMaxForVisibleTiles();ue=_e?_e.max:this._centerAltitude}else ue=this._centerAltitude;const oe=t.isTerrainDEM?-ue:this._elevation?this._elevation.getMinElevationBelowMSL():0,le=this.projection.isReprojectedInTileSpace?s.cC(this):1,re=_e=>{const Re=new s.ae(_e.x+25e-6,_e.y,_e.z),Ke=new s.ae(_e.x,_e.y+25e-6,_e.z),pt=_e.toLngLat(),wt=Re.toLngLat(),ht=Ke.toLngLat(),st=this.locationCoordinate(pt),Rt=this.locationCoordinate(wt),At=this.locationCoordinate(ht),vt=Math.hypot(Rt.x-st.x,Rt.y-st.y),Tt=Math.hypot(At.x-st.x,At.y-st.y);return Math.sqrt(vt*Tt)*le/25e-6},te=_e=>{const Ne=ue,Re=oe;return{aabb:s.cF(this,A,0,0,0,_e,Re,Ne,this.projection),zoom:0,x:0,y:0,minZ:Re,maxZ:Ne,wrap:_e,fullyVisible:!1}},he=[];let we=[];const ye=r,ze=t.reparseOverscaled?h:r,Oe=(G-this._centerAltitude)*B,$e=_e=>{if(!this._elevation||!_e.tileID||!y)return;const Ne=this._elevation.getMinMaxForTile(_e.tileID),Re=_e.aabb;Ne?(Re.min[2]=Ne.min,Re.max[2]=Ne.max,Re.center[2]=(Re.min[2]+Re.max[2])/2):(_e.shouldSplit=Ae(_e),_e.shouldSplit||(Re.min[2]=Re.max[2]=Re.center[2]=this._centerAltitude))},ot=(_e,Ne)=>{if(.707*Ne<_e)return 1;const Re=Ne/_e;return Re/(1.4144271570014144+(Math.pow(1.1,Re-1.4144271570014144+1)-1)/(1.1-1)-1)},Ae=_e=>{if(_e.zoom<K)return!0;if(_e.zoom===ye)return!1;if(_e.shouldSplit!=null)return _e.shouldSplit;const Ne=_e.aabb.distanceX($),Re=_e.aabb.distanceY($);let Ke=Oe,pt=1;if(z){Ke=_e.aabb.distanceZ($);const Tt=Math.pow(2,_e.zoom),Ut=s.a$((_e.y+1)/Tt),ii=s.a$(_e.y/Tt),wi=Math.min(Math.max(T,Ut),ii),Ui=s.d1(wi)/s.d1(T);if(pt=wi===T?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,Ui/this._mercatorScaleRatio),this.zoom<=s.c_&&_e.zoom===ye-1&&Ui>=.9)return!0}else if(g&&(Ke=_e.aabb.distanceZ($)*B),this.projection.isReprojectedInTileSpace&&h<=5){const Tt=Math.pow(2,_e.zoom),Ut=re(new s.ae((_e.x+.5)/Tt,(_e.y+.5)/Tt));pt=Ut>.85?1:Ut}if(!y&&!z){const Tt=Math.sqrt(Ne*Ne+Re*Re+Ke*Ke);let Ut=(1<<ye-_e.zoom)*J*pt;return Ut*=ot(Math.max(Ke,Oe),Tt),Tt<Ut}let wt=Number.MAX_VALUE,ht=0;const st=_e.aabb.getCorners(),Rt=[];for(const Tt of st){s.av(Rt,Tt,$),z||(g?Rt[2]*=B:Rt[2]=Oe);const Ut=s.bJ(Rt,this._camera.forward());Ut<wt&&(wt=Ut,ht=Math.abs(Rt[2]))}let At=(1<<ye-_e.zoom)*J*pt;if(At*=ot(Math.max(ht,Oe),wt),wt<At)return!0;const vt=_e.aabb.closestPoint(M);return vt[0]===M[0]&&vt[1]===M[1]};if(this.renderWorldCopies)for(let _e=1;_e<=3;_e++)he.push(te(-_e)),he.push(te(_e));for(he.push(te(0));he.length>0;){const _e=he.pop(),Ne=_e.x,Re=_e.y;let Ke=_e.fullyVisible;const pt=()=>this.projection.name==="globe"&&(_e.y===0||_e.y===(1<<_e.zoom)-1);if(!Ke){let wt=X?_e.aabb.intersects(D):_e.aabb.intersectsFlat(D);if(wt===0&&pt()){const ht=new s.cD(_e.zoom,Ne,Re);wt=s.cE(this,A,ht,!0).intersects(D)}if(wt===0)continue;Ke=wt===2}if(_e.zoom!==ye&&Ae(_e))for(let wt=0;wt<4;wt++){const ht=(Ne<<1)+wt%2,st=(Re<<1)+(wt>>1),Rt={aabb:y?_e.aabb.quadrant(wt):s.cF(this,A,_e.zoom+1,ht,st,_e.wrap,_e.minZ,_e.maxZ,this.projection),zoom:_e.zoom+1,x:ht,y:st,wrap:_e.wrap,fullyVisible:Ke,tileID:void 0,shouldSplit:void 0,minZ:_e.minZ,maxZ:_e.maxZ};g&&!z&&(Rt.tileID=new s.aQ(_e.zoom+1===ye?ze:_e.zoom+1,_e.wrap,_e.zoom+1,ht,st),$e(Rt)),he.push(Rt)}else{const wt=_e.zoom===ye?ze:_e.zoom;if(t.minzoom&&t.minzoom>wt)continue;let ht=0;if(!Ke){let vt=X?_e.aabb.intersectsPrecise(D):_e.aabb.intersectsPreciseFlat(D);if(vt===0&&pt()){const Tt=new s.cD(_e.zoom,Ne,Re);vt=s.cE(this,A,Tt,!0).intersectsPrecise(D)}if(vt===0)continue;if(t.calculateQuadrantVisibility)if(D.containsPoint(_e.aabb.center))ht=15;else for(let Tt=0;Tt<4;Tt++)_e.aabb.quadrant(Tt).intersects(D)!==0&&(ht|=1<<Tt)}const st=M[0]-(.5+Ne+(_e.wrap<<_e.zoom))*(1<<r-_e.zoom),Rt=M[1]-.5-Re,At=_e.tileID?_e.tileID:new s.aQ(wt,_e.wrap,_e.zoom,Ne,Re);t.calculateQuadrantVisibility&&(At.visibleQuadrants=ht),we.push({tileID:At,distanceSq:st*st+Rt*Rt})}}if(this.fogCullDistSq){const _e=this.fogCullDistSq,Ne=this.horizonLineFromTop();we=we.filter(Re=>{const Ke=[0,0,0,1],pt=[s.al,s.al,0,1],wt=this.calculateFogTileMatrix(Re.tileID.toUnwrapped());s.aC(Ke,Ke,wt),s.aC(pt,pt,wt);const ht=s.cG([],Ke,pt),st=s.cH([],Ke,pt),Rt=s.c$(ht,st);if(Rt===0)return!0;let At=!1;const vt=this._elevation;if(vt&&Rt>_e&&Ne!==0){const Tt=this.calculateProjMatrix(Re.tileID.toUnwrapped());let Ut;t.isTerrainDEM||(Ut=vt.getMinMaxForTile(Re.tileID)),Ut||(Ut={min:oe,max:ue});const ii=s.cI(this.rotation),wi=[ii[0]*s.al,ii[1]*s.al,Ut.max];s.af(wi,wi,Tt),At=(1-wi[1])*this.height*.5<Ne}return Rt<_e||At})}return we.sort((_e,Ne)=>_e.distanceSq-Ne.distanceSq).map(_e=>_e.tileID)}resize(t,r){this.width=t,this.height=r,this.pixelsToGLUnits=[2/t,-2/r],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(t){return Math.pow(2,t)}scaleZoom(t){return Math.log2(t)}project(t){const r=s.aA(t.lat,-s.cJ,s.cJ),h=this.projection.project(t.lng,r);return new s.P(h.x*this.worldSize,h.y*this.worldSize)}unproject(t){return this.projection.unproject(t.x/this.worldSize,t.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/s.cf(1,this.center.lat)/this.worldSize}setLocationAtPoint(t,r){let h,p;const g=this.centerPoint;if(this.projection.name==="globe"){const w=this.worldSize;h=(r.x-g.x)/w,p=(r.y-g.y)/w}else{const w=this.pointCoordinate(r),T=this.pointCoordinate(g);h=w.x-T.x,p=w.y-T.y}const y=this.locationCoordinate(t);this.setLocation(new s.ae(y.x-h,y.y-p))}setLocation(t){this.center=this.coordinateLocation(t),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(t,r){return this.projection.locationPoint(this,t,r)}locationPoint3D(t,r){return this.projection.locationPoint(this,t,r,!0)}pointLocation(t){return this.coordinateLocation(this.pointCoordinate(t))}pointLocation3D(t,r){return this.coordinateLocation(this.pointCoordinate3D(t,r))}locationCoordinate(t,r){const h=r?s.cf(r,t.lat):void 0,p=this.projection.project(t.lng,t.lat);return new s.ae(p.x,p.y,h)}coordinateLocation(t){return this.projection.unproject(t.x,t.y)}pointRayIntersection(t,r){const h=r??this._centerAltitude,p=[t.x,t.y,0,1],g=[t.x,t.y,1,1];s.aC(p,p,this.pixelMatrixInverse),s.aC(g,g,this.pixelMatrixInverse);const y=g[3];s.cK(p,p,1/p[3]),s.cK(g,g,1/y);const w=p[2],T=g[2];return{p0:p,p1:g,t:w===T?0:(h-w)/(T-w)}}screenPointToMercatorRay(t){const r=[t.x,t.y,0,1],h=[t.x,t.y,1,1];return s.aC(r,r,this.pixelMatrixInverse),s.aC(h,h,this.pixelMatrixInverse),s.cK(r,r,1/r[3]),s.cK(h,h,1/h[3]),r[2]=s.cf(r[2],this._center.lat)*this.worldSize,h[2]=s.cf(h[2],this._center.lat)*this.worldSize,s.cK(r,r,1/this.worldSize),s.cK(h,h,1/this.worldSize),new s.ax([r[0],r[1],r[2]],s.aw([],s.av([],h,r)))}rayIntersectionCoordinate(t){const{p0:r,p1:h,t:p}=t,g=s.cf(r[2],this._center.lat),y=s.cf(h[2],this._center.lat);return new s.ae(s.ak(r[0],h[0],p)/this.worldSize,s.ak(r[1],h[1],p)/this.worldSize,s.ak(g,y,p))}pointCoordinate(t,r=this._centerAltitude){return this.projection.pointCoordinate(this,t.x,t.y,r)}pointCoordinate3D(t,r){if(!this.elevation)return this.pointCoordinate(t,r);let h=this.projection.pointCoordinate3D(this,t.x,t.y);if(h)return new s.ae(h[0],h[1],h[2]);let p=0,g=this.horizonLineFromTop();if(t.y>g)return this.pointCoordinate(t,r);const y=.02*g,w=t.clone();for(let T=0;T<10&&g-p>y;T++){w.y=s.ak(p,g,.66);const A=this.projection.pointCoordinate3D(this,w.x,w.y);A?(g=w.y,h=A):p=w.y}return h?new s.ae(h[0],h[1],h[2]):this.pointCoordinate(t)}isPointAboveHorizon(t){return this.projection.isPointAboveHorizon(this,t)}isPointOnSurface(t){if(t.y<0||t.y>this.height||t.x<0||t.x>this.width)return!1;if(this.elevation||this.zoom>=s.cL)return!this.isPointAboveHorizon(t);const r=this.pointCoordinate(t);return r.y>=0&&r.y<=1}_coordinatePoint(t,r){const h=r&&this.elevation?this.elevation.getAtPointOrZero(t,this._centerAltitude):this._centerAltitude,p=[t.x*this.worldSize,t.y*this.worldSize,h+t.toAltitude(),1];return s.aC(p,p,this.pixelMatrix),p[3]>0?new s.P(p[0]/p[3],p[1]/p[3]):new s.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:t,left:r}=this._edgeInsets,h=this.height-this._edgeInsets.bottom,p=this.width-this._edgeInsets.right,g=this.pointLocation3D(new s.P(r,t)),y=this.pointLocation3D(new s.P(p,t)),w=this.pointLocation3D(new s.P(p,h)),T=this.pointLocation3D(new s.P(r,h));let A=Math.min(g.lng,y.lng,w.lng,T.lng),M=Math.max(g.lng,y.lng,w.lng,T.lng),z=Math.min(g.lat,y.lat,w.lat,T.lat),L=Math.max(g.lat,y.lat,w.lat,T.lat);const D=Math.pow(2,-this.zoom)/16*270,N=this.projection.name==="globe"?1:4,B=(G,$,X,J,K)=>{const ue=(G+X)/2,oe=($+J)/2,le=new s.P(ue,oe),{lng:re,lat:te}=this.pointLocation3D(le),he=Math.max(0,A-re,z-te,re-M,te-L);A=Math.min(A,re),M=Math.max(M,re),z=Math.min(z,te),L=Math.max(L,te),(K<N||he>D)&&(B(G,$,ue,oe,K+1),B(ue,oe,X,J,K+1))};if(B(r,t,p,t,1),B(p,t,p,h,1),B(p,h,r,h,1),B(r,h,r,t,1),this.projection.name==="globe"){const[G,$]=s.cM(this);G?(L=90,M=180,A=-180):$&&(z=-90,M=180,A=-180)}return new s.aI(new s.aT(A,z),new s.aT(M,L))}_getBoundsRectangular(t,r){const{top:h,left:p}=this._edgeInsets,g=this.height-this._edgeInsets.bottom,y=this.width-this._edgeInsets.right,w=new s.P(p,h),T=new s.P(y,h),A=new s.P(y,g),M=new s.P(p,g);let z=this.pointCoordinate(w,t),L=this.pointCoordinate(T,t);const D=this.pointCoordinate(A,r),N=this.pointCoordinate(M,r),B=(G,$)=>($.y-G.y)/($.x-G.x);return z.y>1&&L.y>=0?z=new s.ae((1-N.y)/B(N,z)+N.x,1):z.y<0&&L.y<=1&&(z=new s.ae(-N.y/B(N,z)+N.x,0)),L.y>1&&z.y>=0?L=new s.ae((1-D.y)/B(D,L)+D.x,1):L.y<0&&z.y<=1&&(L=new s.ae(-D.y/B(D,L)+D.x,0)),new s.aI().extend(this.coordinateLocation(z)).extend(this.coordinateLocation(L)).extend(this.coordinateLocation(N)).extend(this.coordinateLocation(D))}_getBoundsRectangularTerrain(){const t=this.elevation;if(!t.visibleDemTiles.length||t.isUsingMockSource())return this._getBoundsRectangular(0,0);const r=t.visibleDemTiles.reduce((h,p)=>{if(p.dem){const g=p.dem.tree;h.min=Math.min(h.min,g.minimums[0]),h.max=Math.max(h.max,g.maximums[0])}return h},{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(r.min*t.exaggeration(),r.max*t.exaggeration())}getBounds(){return this.projection.name==="mercator"||this.projection.name==="equirectangular"?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(t=!0){const r=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,h=this.height/2-r*(1-this._horizonShift);return t?Math.max(0,h):h}getMaxBounds(){return this.maxBounds}setMaxBounds(t){this.maxBounds=t,this.minLat=-s.cJ,this.maxLat=s.cJ,this.minLng=-180,this.maxLng=180,t&&(this.minLat=t.getSouth(),this.maxLat=t.getNorth(),this.minLng=t.getWest(),this.maxLng=t.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=s.aF(this.minLng)*this.tileSize,this.worldMaxX=s.aF(this.maxLng)*this.tileSize,this.worldMinY=s.aJ(this.maxLat)*this.tileSize,this.worldMaxY=s.aJ(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(t,r){return this.projection.createTileMatrix(this,r,t)}calculateDistanceTileData(t){const r=t.key,h=this._distanceTileDataCache;if(h[r])return h[r];const p=t.canonical,g=1/this.height,y=this.cameraWorldSize,w=y/this.zoomScale(p.z),T=(p.x+Math.pow(2,p.z)*t.wrap)*w,A=p.y*w,M=this.point;M.x*=y/this.worldSize,M.y*=y/this.worldSize;const z=this.angle,L=Math.sin(-z),D=-Math.cos(-z);return h[r]={bearing:[L,D],center:[(M.x-T)*g,(M.y-A)*g],scale:w/s.al*g},h[r]}calculateFogTileMatrix(t){const r=t.key,h=this._fogTileMatrixCache;if(h[r])return h[r];const p=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,t);return s.aB(p,this.worldToFogMatrix,p),h[r]=new Float32Array(p),h[r]}calculateProjMatrix(t,r=!1,h=!1){const p=t.key;let g;if(g=h?this._expandedProjMatrixCache:r?this._alignedProjMatrixCache:this._projMatrixCache,g[p])return g[p];const y=this.calculatePosMatrix(t,this.worldSize);let w;return w=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:h?this.expandedFarZProjMatrix:r?this.alignedProjMatrix:this.projMatrix,s.aB(y,w,y),g[p]=new Float32Array(y),g[p]}calculatePixelsToTileUnitsMatrix(t){const r=t.tileID.key,h=this._pixelsToTileUnitsCache;if(h[r])return h[r];const p=s.cN(t,this);return h[r]=p,h[r]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if(this.projection.name==="globe"){const t=1/this.worldSize,r=s.bq([],[t,t,t]);return s.aB(r,r,this.globeMatrix),r}}recenterOnTerrain(){if(!this._elevation||this.projection.name==="globe")return;const t=this._elevation;this._updateCameraState();const r=s.cf(1,this._center.lat)*this.worldSize,h=this._computeCameraPosition(r),p=this._camera.forward(),g=s.cf(1,this._center.lat);h[2]/=g,p[2]/=g,s.aw(p,p);const y=t.raycast(h,p,t.exaggeration());if(y){const w=s.bH([],h,p,y),T=new s.ae(w[0],w[1],s.cf(w[2],s.a$(w[1]))),A=(T.z+s.ag([T.x-h[0],T.y-h[1],T.z-h[2]*g]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(A),this._centerAltitude=T.toAltitude(),this._center=this.coordinateLocation(T),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(t=!1){if(!this._elevation)return;const r=this._elevation,h=s.cf(1,this._center.lat)*this.worldSize,p=this._computeCameraPosition(h),g=r.getAtPointOrZero(new s.ae(...p)),y=this.pixelsPerMeter/this.worldSize*g,w=this._minimumHeightOverTerrain(),T=p[2]-y;if(T<=w)if(T<0||t){const A=this.locationCoordinate(this._center,this._centerAltitude),M=[p[0],p[1],A.z-p[2]],z=s.ag(M);M[2]-=(w-T)/this._pixelsPerMercatorPixel;const L=s.ag(M);if(L===0)return;s.c5(M,M,z/L*this._pixelsPerMercatorPixel),this._camera.position=[p[0],p[1],A.z*this._pixelsPerMercatorPixel-M[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const t=this.projection.name==="globe"||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||t){const L=this.center;return L.lat=s.aA(L.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!t)&&(L.lng=s.aA(L.lng,this.minLng,this.maxLng)),this.center=L,void(this._constraining=!1)}const r=this._unmodified,{x:h,y:p}=this.point;let g=0,y=h,w=p;const T=this.width/2,A=this.height/2,M=this.worldMinY*this.scale,z=this.worldMaxY*this.scale;if(p-A<M&&(w=M+A),p+A>z&&(w=z-A),z-M<this.height&&(g=Math.max(g,this.height/(z-M)),w=(z+M)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const L=this.worldMinX*this.scale,D=this.worldMaxX*this.scale,N=this.worldSize/2-(L+D)/2;y=(h+N+this.worldSize)%this.worldSize-N,y-T<L&&(y=L+T),y+T>D&&(y=D-T),D-L<this.width&&(g=Math.max(g,this.width/(D-L)),y=(D+L)/2)}y===h&&w===p||this._allowWorldUnderZoom||(this.center=this.unproject(new s.P(y,w))),g&&!this._allowWorldUnderZoom&&(this.zoom+=this.scaleZoom(g)),this._constrainCamera(),this._unmodified=r,this._constraining=!1}_minZoomForBounds(){let t=Math.max(0,this.scaleZoom(Math.max(0,this.height)/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(t=Math.max(t,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),t}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const t=this.centerOffset,r=this.projection.name==="globe",h=this.pixelsPerMeter;this.projection.name==="globe"&&(this._mercatorScaleRatio=s.cf(1,this.center.lat)/s.cf(1,s.d2));const p=s.cO(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,p),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const g=this.projection.zAxisUnit==="meters"?h:1,y=this._camera.getWorldToCamera(this.worldSize,g);let w;const T=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(T[8]=2*-t.x/this.width,T[9]=2*t.y/this.height,this.isOrthographic){let te=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),he=te*this.aspect,we=-he,ye=-te;he-=t.x,we-=t.x,te+=t.y,ye+=t.y,w=this._camera.getCameraToClipOrthographic(we,he,ye,te,this._nearZ,this._farZ),((ze,Oe,$e,ot)=>{for(let Ae=0;Ae<16;Ae++)ze[Ae]=s.ak(Oe[Ae],$e[Ae],ot)})(w,w,T,s.d0(this.pitch>=ys?1:this.pitch/ys))}else w=T;const A=s.cP([],T,y);let M=s.cP([],w,y);if(this.projection.isReprojectedInTileSpace){const te=this.locationCoordinate(this.center),he=s.bA([]);s.br(he,he,[te.x*this.worldSize,te.y*this.worldSize,0]),s.aB(he,he,s.cQ(this)),s.br(he,he,[-te.x*this.worldSize,-te.y*this.worldSize,0]),s.aB(M,M,he),s.aB(A,A,he),this.inverseAdjustmentMatrix=s.cR(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=s.cS([],M,[this.worldSize,this.worldSize,this.worldSize/g,1]),this.projMatrix=M,this.invProjMatrix=s.bl(new Float64Array(16),this.projMatrix),r){const te=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);te[8]=2*-t.x/this.width,te[9]=2*t.y/this.height,this.expandedFarZProjMatrix=s.cP([],te,y)}else this.expandedFarZProjMatrix=this.projMatrix;const z=s.bl([],w);this.frustumCorners=s.cT.fromInvProjectionMatrix(z,this.horizonLineFromTop(),this.height),this.cameraFrustum=s.cB.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!r);const L=new Float32Array(16);s.bA(L),s.cS(L,L,[1,-1,1]),s.cU(L,L,this._pitch),s.bB(L,L,this.angle);const D=s.cd(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=s.bz(D);const N=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;D[8]=2*-t.x/this.width,D[9]=2*(t.y+N)/this.height,this.skyboxMatrix=s.aB(L,D,L);const B=this.point,G=B.x,$=B.y,X=this.width%2/2,J=this.height%2/2,K=Math.cos(this.angle),ue=Math.sin(this.angle),oe=G-Math.round(G)+K*X+ue*J,le=$-Math.round($)+K*J+ue*X,re=new Float64Array(M);if(s.br(re,re,[oe>.5?oe-1:oe,le>.5?le-1:le,0]),this.alignedProjMatrix=re,M=s.bC(),s.cS(M,M,[this.width/2,-this.height/2,1]),s.br(M,M,[1,-1,0]),this.labelPlaneMatrix=M,M=s.bC(),s.cS(M,M,[1,-1,1]),s.br(M,M,[-1,-1,0]),s.cS(M,M,[2/this.width,2/this.height,1]),this.glCoordMatrix=M,this.pixelMatrix=s.aB(new Float64Array(16),this.labelPlaneMatrix,A),this._calcFogMatrices(),this._distanceTileDataCache={},M=s.bl(new Float64Array(16),this.pixelMatrix),!M)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=M,this.projection.name==="globe"||this.mercatorFromTransition){this.globeMatrix=s.cV(this);const te=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=s.af(te,te,y),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=M;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const t=this.cameraWorldSizeForFog,r=this.cameraPixelsPerMeter,h=this._camera.position,p=1/this.height/this._pixelsPerMercatorPixel,g=[t,t,r];s.c5(g,g,p),s.c5(h,h,-1),s.cW(h,h,g);const y=s.bC();s.br(y,y,h),s.cS(y,y,g),this.mercatorFogMatrix=y,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(t,r,p)}_computeCameraPosition(t){const r=(t=t||this.pixelsPerMeter)/this.pixelsPerMeter,h=this._camera.forward(),p=this.point,g=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*r-t/this.worldSize*this._centerAltitude;return[p.x/this.worldSize-h[0]*g,p.y/this.worldSize-h[1]*g,t/this.worldSize*this._centerAltitude-h[2]*g]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(t){const r=this._maxCameraBoundsDistance()*Math.cos(this._pitch),h=this._camera.position[2],p=t[2];let g=1;this.projection.wrap&&(this.center=this.center.wrap()),p>0&&(g=Math.min((r-h)/p,1)),this._camera.position=s.bH([],this._camera.position,t,g),this._updateStateFromCamera()}_updateStateFromCamera(){const t=this._camera.position,r=this._camera.forward(),{pitch:h,bearing:p}=this._camera.getPitchBearing(),g=s.cf(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,y=this._mercatorZfromZoom(this._maxZoom)*Math.cos(s.an(this._maxPitch)),w=Math.max((t[2]-g)/Math.cos(h),y),T=this._zoomFromMercatorZ(w);s.bH(t,t,r,w),this._pitch=s.aA(h,s.an(this.minPitch),s.an(this.maxPitch)),this.angle=s.bT(p,-Math.PI,Math.PI),this._setZoom(s.aA(T,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new s.ae(t[0],t[1],t[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(t){return Math.pow(2,t)*this.tileSize}_mercatorZfromZoom(t){return this.cameraToCenterDistance/this._worldSizeFromZoom(t)}_minimumHeightOverTerrain(){const t=Math.min(this._seaLevelZoom!=null?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(t)}_zoomFromMercatorZ(t){return this.scaleZoom(this.cameraToCenterDistance/(Math.max(0,t)*this.tileSize))}zoomFromMercatorZAdjusted(t){let r=0,h=s.cL,p=0,g=1/0;for(;h-r>1e-6&&h>r;){const y=r+.5*(h-r),w=this.tileSize*Math.pow(2,y),T=this.getCameraToCenterDistance(this.projection,y,w),A=this.scaleZoom(T/(Math.max(0,t)*this.tileSize)),M=Math.abs(y-A);M<g&&(g=M,p=y),y<A?r=y:h=y}return p}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(s.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(t,r){const h=Math.min(t.x,r.x),p=Math.max(t.x,r.x),g=Math.min(t.y,r.y),y=Math.max(t.y,r.y);if(g<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;const w=[new s.P(h,g),new s.P(p,y),new s.P(h,y),new s.P(p,g)],T=this.renderWorldCopies?-3:0,A=this.renderWorldCopies?4:1;for(const M of w){const z=this.pointRayIntersection(M);if(z.t<0)return!0;const L=this.rayIntersectionCoordinate(z);if(L.x<T||L.y<0||L.x>A||L.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+s.cX(this.fovAboveCenter)>88||this.anyCornerOffEdge(new s.P(0,0),new s.P(this.width,this.height))}zoomDeltaToMovement(t,r){const h=s.ag(s.av([],this._camera.position,t)),p=this._zoomFromMercatorZ(h)+r;return h-this._mercatorZfromZoom(p)}getCameraPoint(){if(this.projection.name==="globe"){const t=function([r,h,p],g){const y=[r,h,p,1];s.aC(y,y,g);const w=y[3]=Math.max(y[3],1e-6);return y[0]/=w,y[1]/=w,y[2]/=w,y}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new s.P(t[0],t[1])}{const t=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new s.P(0,t))}}getCameraToCenterDistance(t,r=this.zoom,h=this.worldSize){const p=s.cO(t,r,this.width,this.height,1024),g=t.pixelSpaceConversion(this.center.lat,h,p);let y=.5/Math.tan(.5*this._fov)*this.height*g;return this.isOrthographic&&(y=s.ak(1,y,s.d0(this.pitch>=ys?1:this.pitch/ys))),y}getWorldToCameraMatrix(){const t=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?this.pixelsPerMeter:1);return this.projection.name==="globe"&&s.aB(t,t,this.globeMatrix),t}getFrustum(t){return s.cB.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,t,this.projection.zAxisUnit==="meters")}}const Ya=(u,t)=>{if(t>0&&u.terrain&&s.w("Cutoff is currently disabled on terrain"),t<=0||u.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};const r=u.transform,h=Math.max(Math.abs(r._zoom-(u.minCutoffZoom-1)),1),p=r.isLODDisabled(!1)?s.ah(60,45,r.pitch):s.ah(30,15,r.pitch),g=r._farZ-r._nearZ,y=t*r.height,w=((1-(T=p))*r.cameraToCenterDistance+T*(r._farZ+y))*h;var T;return{shouldRenderCutoff:p<1,uniformValues:{u_cutoff_params:[r._nearZ,r._farZ,(w-r._nearZ)/g,(w-y-r._nearZ)/g]}}},Jo=2048;class Du{constructor(t,r){this.aabb=t,this.lastCascade=r}}class Lv{add(t,r){const h=this.receivers[t.key];h!==void 0?(h.aabb.min[0]=Math.min(h.aabb.min[0],r.min[0]),h.aabb.min[1]=Math.min(h.aabb.min[1],r.min[1]),h.aabb.min[2]=Math.min(h.aabb.min[2],r.min[2]),h.aabb.max[0]=Math.max(h.aabb.max[0],r.max[0]),h.aabb.max[1]=Math.max(h.aabb.max[1],r.max[1]),h.aabb.max[2]=Math.max(h.aabb.max[2],r.max[2])):this.receivers[t.key]=new Du(r,null)}clear(){this.receivers={}}get(t){return this.receivers[t.key]}computeRequiredCascades(t,r,h){const p=s.d9.fromPoints(t.points);let g=0;for(const y in this.receivers){const w=this.receivers[y];if(!w||!p.intersectsAabb(w.aabb))continue;w.aabb.min=p.closestPoint(w.aabb.min),w.aabb.max=p.closestPoint(w.aabb.max);const T=w.aabb.getCorners();for(let A=0;A<h.length;A++){let M=!0;for(const z of T){const L=[z[0]*r,z[1]*r,z[2]];if(s.af(L,L,h[A].matrix),L[0]<-1||L[0]>1||L[1]<-1||L[1]>1){M=!1;break}}if(w.lastCascade=A,g=Math.max(g,A),M)break}}return g+1}}class wc{constructor(t){this.painter=t,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new Lv,this._depthMode=new Dt(t.context.gl.LEQUAL,Dt.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1}destroy(){for(const t of this._cascades)t.texture.destroy(),t.framebuffer.destroy();this._cascades=[]}updateShadowParameters(t,r){const h=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!r||!r.properties)return;const p=r.properties.get("shadow-intensity");if(!r.shadowsEnabled()||p<=0||(this._shadowLayerCount=h.style.order.reduce((N,B)=>{const G=h.style._mergedLayers[B];return N+(G.hasShadowPass()&&!G.isHidden(t.zoom)?1:0)},0),this._enabled=this._shadowLayerCount>0,!this.enabled))return;const g=h.context,y=Jo,w=Jo;if(this._cascades.length===0||Jo!==this._cascades[0].texture.size[0]){this._cascades=[];for(let N=0;N<2;++N){const B=h._shadowMapDebug,G=g.gl,$=g.createFramebuffer(y,w,B?1:0,"texture"),X=new s.T(g,{width:y,height:w,data:null},G.DEPTH_COMPONENT16);if($.depthAttachment.set(X.texture),B){const J=new s.T(g,{width:y,height:w,data:null},G.RGBA8);$.colorAttachment0.set(J.texture)}this._cascades.push({framebuffer:$,texture:X,matrix:[],far:0,boundingSphereRadius:0,frustum:new s.cB,scale:0})}}this.shadowDirection=Fu(r);let T=0;if(t.elevation){const N=t.elevation,B=[1e4,-1e4];N.visibleDemTiles.filter(G=>G.dem).forEach(G=>{const $=G.dem.tree;B[0]=Math.min(B[0],$.minimums[0]),B[1]=Math.max(B[1],$.maximums[0])}),B[0]!==1e4&&(T=(B[1]-B[0])*N.exaggeration())}const A=1.5*t.cameraToCenterDistance,M=3*A,z=new Float64Array(16);for(let N=0;N<this._cascades.length;++N){const B=this._cascades[N];let G=t.height/50,$=1;N===0?$=A:(G=A,$=M);const[X,J]=Ja(t,this.shadowDirection,G,$,Jo,T);B.scale=t.scale,B.matrix=X,B.boundingSphereRadius=J,s.bl(z,B.matrix),B.frustum=s.cB.fromInvProjectionMatrix(z,1,0,!0),B.far=$}const L=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[L].far,this._cascades[L].far],this._uniformValues.u_shadow_intensity=p,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=.00048828125,this._uniformValues.u_shadow_map_resolution=Jo,this._uniformValues.u_shadowmap_0=Cr.ShadowMap0,this._uniformValues.u_shadowmap_1=Cr.ShadowMap0+1,this._groundShadowTiles=h.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const D=h.transform.elevation;for(const N of this._groundShadowTiles){let B={min:0,max:0};if(D){const G=D.getMinMaxForTile(N);G&&(B=G)}this.addShadowReceiver(N.toUnwrapped(),B.min,B.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(t){this._enabled=t}drawShadowPass(t,r){if(!this.enabled)return;const h=this.painter,p=h.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(h.transform.getFrustum(0),h.transform.worldSize,this._cascades),p.viewport.set([0,0,Jo,Jo]);for(let g=0;g<this._numCascadesToRender;++g){h.currentShadowCascade=g,p.bindFramebuffer.set(this._cascades[g].framebuffer.framebuffer),p.clear({color:s.ao.white,depth:1});for(const y of t.order){const w=t._mergedLayers[y];if(!w.hasShadowPass()||w.isHidden(h.transform.zoom))continue;const T=t.getLayerSourceCache(w),A=T?r[T.id]:void 0;(w.type==="model"||A&&A.length)&&h.renderLayer(h,T,w,A)}}h.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;const t=this.painter,r=t.style,h=t.context,p=h.gl,g=r.directionalLight,y=r.ambientLight;if(!g||!y)return;const w=[],T=Ya(t,t.longestCutoffRange);T.shouldRenderCutoff&&w.push("RENDER_CUTOFF"),w.push("RENDER_SHADOWS","DEPTH_TEXTURE"),this.useNormalOffset&&w.push("NORMAL_OFFSET");const A=ua(r,g,y),M=new Dt(p.LEQUAL,Dt.ReadOnly,t.depthRangeFor3D),z=new Jt({func:p.EQUAL,mask:255},0,255,p.KEEP,p.KEEP,p.KEEP);for(const L of this._groundShadowTiles){const D=L.toUnwrapped(),N=t.isTileAffectedByFog(L),B=t.getOrCreateProgram("groundShadow",{defines:w,overrideFog:N});this.setupShadows(D,B),t.uploadCommonUniforms(h,B,D,null,T);const G={u_matrix:t.transform.calculateProjMatrix(D),u_ground_shadow_factor:A};B.draw(t,p.TRIANGLES,M,z,ai.multiply,Yt.disabled,G,"ground_shadow",t.tileExtentBuffer,t.quadTriangleIndexBuffer,t.tileExtentSegments,null,t.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?ai.unblended:ai.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(t){const r=this.painter.transform,h=r.calculatePosMatrix(t,r.worldSize);return s.aB(h,this._cascades[this.painter.currentShadowCascade].matrix,h),Float32Array.from(h)}calculateShadowPassMatrixFromMatrix(t){const r=s.bz(t);return s.aB(r,this._cascades[this.painter.currentShadowCascade].matrix,t),r}setupShadows(t,r,h){if(!this.enabled)return;const p=this.painter.transform,g=this.painter.context,y=g.gl,w=this._uniformValues,T=new Float64Array(16),A=p.calculatePosMatrix(t,p.worldSize);for(let M=0;M<this._cascades.length;M++)s.aB(T,this._cascades[M].matrix,A),w[M===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(T),g.activeTexture.set(y.TEXTURE0+Cr.ShadowMap0+M),this._cascades[M].texture.bindExtraParam(y.LINEAR,y.LINEAR,y.CLAMP_TO_EDGE,y.CLAMP_TO_EDGE,y.GREATER);if(this.useNormalOffset=!!h,this.useNormalOffset){const M=s.d7(t.canonical),z=2/p.tileSize*s.al/Jo,L=z*this._cascades[0].boundingSphereRadius,D=z*this._cascades[this._cascades.length-1].boundingSphereRadius,N=(h==="vector-tile"?1:3)*function(B,G,$,X,J){const K=s.aA((B-22)/-22,0,1);return .125*(1-K)+4*K}(p.zoom);w.u_shadow_normal_offset=[M,L*N,D*N],w.u_shadow_bias=[1e-4,.0012,.012]}else w.u_shadow_bias=[36e-5,.0012,.012];r.setShadowUniformValues(g,w)}setupShadowsFromMatrix(t,r,h=!1){if(!this.enabled)return;const p=this.painter.context,g=p.gl,y=this._uniformValues,w=new Float64Array(16);for(let T=0;T<2;T++)s.aB(w,this._cascades[T].matrix,t),y[T===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(w),p.activeTexture.set(g.TEXTURE0+Cr.ShadowMap0+T),this._cascades[T].texture.bindExtraParam(g.LINEAR,g.LINEAR,g.CLAMP_TO_EDGE,g.CLAMP_TO_EDGE,g.GREATER);this.useNormalOffset=h,h?(y.u_shadow_normal_offset=[1,3,3],y.u_shadow_bias=[6e-5,.0012,.012]):y.u_shadow_bias=[36e-5,.0012,.012],r.setShadowUniformValues(p,y)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(t,r,h,p){if(p[2]>=0)return{};const g=function(T,A,M){const z=M/(1<<T.canonical.z);return new s.d9([T.canonical.x*z+T.wrap*M,T.canonical.y*z+T.wrap*M,0],[(T.canonical.x+1)*z+T.wrap*M,(T.canonical.y+1)*z+T.wrap*M,A])}(t,r,h).getCorners(),y=r/-p[2];p[0]<0?(s.d8(g[0],g[0],[p[0]*y,0,0]),s.d8(g[3],g[3],[p[0]*y,0,0])):p[0]>0&&(s.d8(g[1],g[1],[p[0]*y,0,0]),s.d8(g[2],g[2],[p[0]*y,0,0])),p[1]<0?(s.d8(g[0],g[0],[0,p[1]*y,0]),s.d8(g[1],g[1],[0,p[1]*y,0])):p[1]>0&&(s.d8(g[2],g[2],[0,p[1]*y,0]),s.d8(g[3],g[3],[0,p[1]*y,0]));const w={};return w.vertices=g,w.planes=[Ou(g[1],g[0],g[4]),Ou(g[2],g[1],g[5]),Ou(g[3],g[2],g[6]),Ou(g[0],g[3],g[7])],w}addShadowReceiver(t,r,h){this._receivers.add(t,s.d9.fromTileIdAndHeight(t,r,h))}getMaxCascadeForTile(t){const r=this._receivers.get(t);return r&&r.lastCascade?r.lastCascade:0}}function Ou(u,t,r){const h=s.av([],r,t),p=s.av([],u,t),g=s.bI([],h,p),y=s.ag(g);return y===0?[0,0,1,0]:(s.c5(g,g,1/y),[g[0],g[1],g[2],-s.bJ(g,t)])}function Fu(u){const t=u.properties.get("direction"),r=s.d4(t.x,t.y,t.z);r[2]=s.aA(r[2],0,75);const h=s.d6([r[0],r[1],r[2]]);return s.d5(h.x,h.y,h.z)}function ua(u,t,r){const h=t.properties.get("color-use-theme")==="none",p=t.properties.get("color"),g=t.properties.get("intensity"),y=t.properties.get("direction"),w=[y.x,y.y,y.z],T=r.properties.get("color-use-theme")==="none",A=r.properties.get("color"),M=r.properties.get("intensity"),z=Math.max(s.bJ([0,0,1],w),0),L=[0,0,0];s.c5(L,A.toPremultipliedRenderColor(T?null:u.getLut(t.scope)).toArray01Linear().slice(0,3),M);const D=[0,0,0];return s.c5(D,p.toPremultipliedRenderColor(h?null:u.getLut(r.scope)).toArray01Linear().slice(0,3),z*g),s.db([L[0]>0?L[0]/(L[0]+D[0]):0,L[1]>0?L[1]/(L[1]+D[1]):0,L[2]>0?L[2]/(L[2]+D[2]):0])}function Ja(u,t,r,h,p,g){const y=u.zoom,w=u.scale,T=u.worldSize,A=1/T,M=u.aspect,z=Math.sqrt(1+M*M)*Math.tan(.5*u.fovX),L=z*z,D=h-r,N=h+r;let B,G;L>D/N?(B=h,G=h*z):(B=.5*N*(1+L),G=.5*Math.sqrt(D*D+2*(h*h+r*r)*L+N*N*L*L));const $=u.projection.pixelsPerMeter(u.center.lat,T),X=u._camera.getCameraToWorldMercator(),J=[0,0,-B*A];s.af(J,J,X);let K=G*A;const ue=u._edgeInsets;if(!(ue.left===0&&ue.top===0&&ue.right===0&&ue.bottom===0||ue.left===ue.right&&ue.top===ue.bottom)){const Ke=u._camera.getWorldToCamera(u.worldSize,u.projection.zAxisUnit==="meters"?$:1),pt=u._camera.getCameraToClipPerspective(u._fov,u.width/u.height,r,h);pt[8]=2*-u.centerOffset.x/u.width,pt[9]=2*u.centerOffset.y/u.height;const wt=new Float64Array(16);s.cP(wt,pt,Ke);const ht=new Float64Array(16);s.bl(ht,wt);const st=s.cB.fromInvProjectionMatrix(ht,T,y,!0);for(const Rt of st.points){const At=((oe=Rt)[0]/=w,oe[1]/=w,oe[2]=s.cf(oe[2],u._center.lat),oe);K=Math.max(K,s.c6(s.da([],J,At)))}}var oe;K*=p/(p-1);const le=Math.acos(t[2]),re=Math.atan2(-t[0],-t[1]),te=new ed;te.position=J,te.setPitchBearing(le,re);const he=te.getWorldToCamera(T,$),we=K*T,ye=Math.min(u._mercatorZfromZoom(17)*T*-2,-2*we),ze=te.getCameraToClipOrthographic(-we,we,-we,we,ye,(we+g*$)/t[2]),Oe=new Float64Array(16);s.aB(Oe,ze,he);const $e=s.d5(Math.floor(1e6*J[0])/1e6*T,Math.floor(1e6*J[1])/1e6*T,0),ot=.5*p,Ae=[0,0,0];s.af(Ae,$e,Oe),s.c5(Ae,Ae,ot);const _e=[Math.floor(Ae[0]),Math.floor(Ae[1]),Math.floor(Ae[2])],Ne=[0,0,0];s.av(Ne,Ae,_e),s.c5(Ne,Ne,-1/ot);const Re=new Float64Array(16);return s.bA(Re),s.br(Re,Re,Ne),s.aB(Oe,Re,Oe),[Oe,we]}class zv extends s.E{constructor(t){super(),this.requestManager=t,this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}loadModel(t,r){return s.dc(this.requestManager.transformRequest(r,s.R.Model).url).then(h=>{if(!h)return;const p=s.dd(h),g=new s.de(t,r,void 0,void 0,p);return g.computeBoundsAndApplyParent(),g}).catch(h=>{if(h&&h.status===404)return null;this.fire(new s.y(new Error(`Could not load model ${t} from ${r}: ${h.message}`)))})}load(t,r,h={forceReload:!1}){this.models[r]||(this.models[r]={});const p=Object.keys(t),g=[],y=[];for(const w of p){const T=t[w];this.hasURLBeenRequested(T)&&!h.forceReload||(this.modelByURL[T]={modelId:w,scope:r},g.push(this.loadModel(w,T)),y.push(w)),this.models[r][w]||(this.models[r][w]={model:null,numReferences:1})}this.numModelsLoading[r]=(this.numModelsLoading[r]||0)+y.length,Promise.allSettled(g).then(w=>{for(let T=0;T<w.length;T++){const{status:A}=w[T];if(A==="rejected")continue;const{value:M}=w[T];this.models[r][y[T]]||(this.models[r][y[T]]={model:null,numReferences:1}),this.models[r][y[T]].model=M}this.numModelsLoading[r]-=y.length,this.fire(new s.z("data",{dataType:"style"}))}).catch(w=>{this.fire(new s.y(new Error(`Could not load models: ${w.message}`)))})}isLoaded(){for(const t in this.numModelsLoading)if(this.numModelsLoading[t]>0)return!1;return!0}hasModel(t,r,h={exactIdMatch:!1}){return!!(h.exactIdMatch?this.getModel(t,r):this.getModelByURL(this.modelUris[r][t]))}getModel(t,r){return this.models[r]||(this.models[r]={}),this.models[r][t]?this.models[r][t].model:void 0}getModelByURL(t){if(!t)return null;const r=this.modelByURL[t];return r?this.models[r.scope][r.modelId].model:null}hasModelBeenAdded(t,r){return this.models[r]&&this.models[r][t]!==void 0}getModelURIs(t){return this.modelUris[t]||{}}addModel(t,r,h){this.models[h]||(this.models[h]={}),this.modelUris[h]||(this.modelUris[h]={});const p=this.requestManager.normalizeModelURL(r);if((this.hasModel(t,h,{exactIdMatch:!0})||this.hasModelBeenAdded(t,h))&&this.modelUris[h][t]===p)this.models[h][t].numReferences++;else if(this.hasURLBeenRequested(p)){const{scope:g,modelId:y}=this.modelByURL[p];this.models[g][y].numReferences++}else this.modelUris[h][t]=p,this.load({[t]:this.modelUris[h][t]},h)}addModelURLs(t,r){this.models[r]||(this.models[r]={}),this.modelUris[r]||(this.modelUris[r]={});const h=this.modelUris[r];for(const p in t)h[p]=this.requestManager.normalizeModelURL(t[p])}reloadModels(t){this.load(this.modelUris[t],t,{forceReload:!0})}addModelsFromBucket(t,r){this.models[r]||(this.models[r]={}),this.modelUris[r]||(this.modelUris[r]={});const h={};for(const p of t)this.hasModel(p,r,{exactIdMatch:!0})||this.hasURLBeenRequested(p)?this.models[r][p].numReferences++:this.modelUris[r][p]&&!this.hasURLBeenRequested(p)?h[p]=this.modelUris[r][p]:!this.hasURLBeenRequested(p)&&s.df(p,!1)&&(this.modelUris[r][p]=this.requestManager.normalizeModelURL(p),h[p]=this.modelUris[r][p]);this.load(h,r)}hasURLBeenRequested(t){return this.modelByURL[t]!==void 0}removeModel(t,r,h=!1,p=!1){if(this.models[r]&&this.models[r][t]&&(this.models[r][t].numReferences--,this.models[r][t].numReferences===0||p)){const g=this.modelUris[r][t];h||delete this.modelUris[r][t],delete this.modelByURL[g];const y=this.models[r][t].model;if(!y)return;delete this.models[r][t],y.destroy()}}destroy(){for(const t of Object.keys(this.models))for(const r of Object.keys(this.models[t])){const h=this.models[t][r].model;delete this.models[t][r],h&&h.destroy()}this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}listModels(t){return this.models[t]||(this.models[t]={}),Object.keys(this.models[t])}upload(t,r){this.models[r]||(this.models[r]={});for(const h in this.models[r])this.models[r][h].model&&this.models[r][h].model.upload(t.context)}}const Tp=s.a6.colorTheme,Dv=new s.a9({data:new s.aa(Tp.data)});function mg(u){if(!u.metadata||!u.metadata.content_area)return;const t=s.o.devicePixelRatio,{left:r,top:h,width:p,height:g}=u.metadata.content_area,y=r*t,w=h*t;return[y,w,y+p*t,w+g*t]}function _g(u){if(u)return u.map(([t,r])=>[t*s.o.devicePixelRatio,r*s.o.devicePixelRatio])}class Sp{constructor(t,r,h){this.id=t,this.scope=r,this.sourceCache=h,this.pendingRequests=new Set,this.missingRequests=new Set}addPendingRequest(t){this.missingRequests.has(t.name)||this.pendingRequests.has(t.name)||this.pendingRequests.add(t.name)}hasPendingRequests(){return this.pendingRequests.size>0}resolvePendingRequests(){const t=new Map;if(!this.sourceCache.loaded())return t;const r=this.sourceCache.getVisibleCoordinates();if(r.length===0)return t;const h=this.sourceCache.getSource();if(!(h instanceof Yr))return t;const p=r.map(y=>this.sourceCache.getTile(y)),g=h.getImages(p,Array.from(this.pendingRequests));for(const[y,w]of g)t.set(s.I.from({name:y,iconsetId:this.id}),w),this.pendingRequests.delete(y);for(const y of this.pendingRequests)this.missingRequests.add(y);return this.pendingRequests.clear(),t}}const Qa=(u,t)=>ee(u,t&&t.filter(r=>r.identifier!=="source.canvas")),gg=s.aH(zi,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setLayerProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setSnow","setRain","setProjection","setCamera","addImport","removeImport","updateImport","addIconset","removeIconset"]),yg=s.aH(zi,["setCenter","setZoom","setBearing","setPitch"]),id=new Set(["background","sky","slot","custom"]),el={version:8,layers:[],sources:{}},Bu={duration:300,delay:0};class Qo extends s.E{constructor(t,r={}){super(),this.map=t,this.scope=r.scope||"",this.globalId=null,this.fragments=[],this.importDepth=r.importDepth||0,this.importsCache=r.importsCache||new Map,this.resolvedImports=r.resolvedImports||new Set,this.transition=Object.assign({},Bu),this._buildingIndex=new Rv(this),this.crossTileSymbolIndex=new gs,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedIndoor={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerPresent=!1,this._hasAppearances=!1,this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._importedAsBasemap=!1,this._changes=r.styleChanges||new Qn,this._hasDataDrivenEmissive=!1,this.dispatcher=r.dispatcher?r.dispatcher:new s.D(s.dh(),this),r.imageManager?this.imageManager=r.imageManager:(this.imageManager=new pc(this.map._spriteFormat),this.imageManager.setEventedParent(this)),this.imageManager.addScope(this.scope),this.glyphManager=r.glyphManager?r.glyphManager:new s.di(t._requestManager,r.localFontFamily?s.dj.all:r.localIdeographFontFamily?s.dj.ideographs:s.dj.none,r.localFontFamily||r.localIdeographFontFamily),r.modelManager?this.modelManager=r.modelManager:(this.modelManager=new zv(t._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._availableModels={},this._order=[],this._markersNeedUpdate=!1,this.options=r.configOptions?r.configOptions:new Map,this._configDependentLayers=r.configDependentLayers?r.configDependentLayers:new Set,this._indoorDependentLayers=r.indoorDependentLayers?r.indoorDependentLayers:new Set,this._config=r.config,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null,colorThemeOverride:r.colorThemeOverride},this._styleColorThemeForScope={},this._initialConfig=r.initialConfig,this.dispatcher.broadcast("setReferrer",s.dk());const h=this;this._rtlTextPluginCallback=Qo.registerForPluginStateChange(p=>{h.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:p.pluginStatus,pluginURL:p.pluginURL},(g,y)=>{if(s.dl(g),y&&y.every(w=>w))for(const w in h._sourceCaches){const T=h._sourceCaches[w],A=T.getSource().type;A!=="vector"&&A!=="geojson"||T.reload()}})}),this.on("data",p=>{if(p.dataType!=="source"||p.sourceDataType!=="metadata")return;const g=this.getOwnSource(p.sourceId);if(g&&g.vectorLayerIds)for(const y in this._layers){const w=this._layers[y];w.source===g.id&&this._validateLayer(w)}})}load(t){return t?(typeof t=="string"?this.loadURL(t):this.loadJSON(t),this):this}_getGlobalId(t){if(!t)return null;if(typeof t=="string"){if(s.h(t))return t;const r=s.dm(t);if(!r.startsWith("http"))try{return new URL(r,location.href).toString()}catch{return r}return r}return`json://${s.dn(JSON.stringify(t))}`}_diffStyle(t,r,h){this.globalId=this._getGlobalId(t);const p=(g,y)=>{try{y(null,this.setState(g,h))}catch(w){y(w,!1)}};if(typeof t=="string"){const g=this.map._requestManager.normalizeStyleURL(t),y=this.map._requestManager.transformRequest(g,s.R.Style);s.m(y,(w,T)=>{w?this.fire(new s.y(w)):T&&p(T,r)})}else typeof t=="object"&&p(t,r)}loadURL(t,r={}){this.fire(new s.z("dataloading",{dataType:"style"}));const h=typeof r.validate=="boolean"?r.validate:!s.h(t);this.globalId=this._getGlobalId(t),t=this.map._requestManager.normalizeStyleURL(t,r.accessToken),this.resolvedImports.add(t);const p=this.importsCache.get(t);if(p)return this._load(p,h);const g=this.map._requestManager.transformRequest(t,s.R.Style);this._request=s.m(g,(y,w)=>{if(this._request=null,y)this.fire(new s.y(y));else if(w)return this.importsCache.set(t,w),this._load(w,h)})}loadJSON(t,r={}){this.fire(new s.z("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(t),this._request=s.o.frame(()=>{this._request=null,this._load(t,r.validate!==!1)})}loadEmpty(){this.fire(new s.z("dataloading",{dataType:"style"})),this._load(el,!1)}_loadImports(t,r,h){if(this.importDepth>=4)return s.w("Style doesn't support nesting deeper than 5"),Promise.resolve();const p=[];for(const g of t){const y=this._createFragmentStyle(g),w=new Promise(M=>{y.once("style.import.load",M),y.once("error",M)}).then(()=>this.mergeAll());if(p.push(w),this.resolvedImports.has(g.url)){y.loadEmpty();continue}const T=g.data||this.importsCache.get(g.url);T?(y.loadJSON(T,{validate:r}),this._isInternalStyle(T)&&(y.globalId=null)):g.url?y.loadURL(g.url,{validate:r}):y.loadEmpty();const A={style:y,id:g.id,config:g.config};if(h){const M=this.fragments.findIndex(({id:z})=>z===h);this.fragments=this.fragments.slice(0,M).concat(A).concat(this.fragments.slice(M))}else this.fragments.push(A)}return Promise.allSettled(p)}getImportGlobalIds(t=this,r=new Set){for(const h of t.fragments)h.style.globalId&&r.add(h.style.globalId),this.getImportGlobalIds(h.style,r);return[...r.values()]}_createFragmentStyle(t){const r=this.scope?s.B(t.id,this.scope):t.id;let h;const p=this._initialConfig&&this._initialConfig[r];(t.config||p)&&(h=Object.assign({},t.config,p));const g=new Qo(this.map,{scope:r,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:h,configOptions:this.options,colorThemeOverride:t["color-theme"],configDependentLayers:this._configDependentLayers,indoorDependentLayers:this._indoorDependentLayers});return g.setEventedParent(this.map,{style:g}),g}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this._updateLayers(this._indoorDependentLayers),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.map._precompilePrograms&&this.isRootStyle()}_isInternalStyle(t){return this.isRootStyle()&&(t.fragment||!!t.schema&&t.fragment!==!1)}_load(t,r){if(this._isInternalStyle(t)){const g=Object.assign({},el,{imports:[{id:"basemap",data:t,url:""}]},t.center?{center:t.center}:{},t.bearing?{bearing:t.bearing}:{},t.pitch?{pitch:t.pitch}:{},t.zoom?{zoom:t.zoom}:{},t.light?{light:t.light}:{});return this._importedAsBasemap=!0,void this._load(g,r)}if(this.updateConfig(this._config,t.schema),r&&Qa(this,fs(t)))return;this._loaded=!0,this.stylesheet=s.dp(t);const h=()=>{for(const T in t.sources)this.addSource(T,t.sources[T],{validate:!1,isInitialLoad:!0});if(t.iconsets)for(const T in t.iconsets)this.addIconset(T,t.iconsets[T]);t.sprite?this._loadIconset(t.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),!this.glyphManager.url&&t.glyphs&&this.glyphManager.setURL(t.glyphs);const g=Iu(this.stylesheet.layers);if(this._order=g.map(T=>T.id),this.stylesheet.light&&s.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(this.stylesheet.lights.length===1&&this.stylesheet.lights[0].type==="flat"){const T=this.stylesheet.lights[0];this.light=new ve(T.properties,T.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new ve(this.stylesheet.light)),this._layers={};for(const T of g){const A=s.du(T,this.scope,this._styleColorTheme.lut,this.options);A.expressionDependencies.configDependencies.size!==0&&this._configDependentLayers.add(A.fqid),A.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(A.fqid),this._hasAppearances=this._hasAppearances||A.getAppearances().length!==0,A.setEventedParent(this,{layer:{id:A.id}}),this._layers[A.id]=A;const M=this.getOwnLayerSourceCache(A),z=!!this.directionalLight&&this.directionalLight.shadowsEnabled();M&&A.canCastShadows()&&z&&(M.castsShadows=!0)}this.stylesheet.featuresets&&this.setFeaturesetSelectors(this.stylesheet.featuresets),this.stylesheet.models&&this.addModelURLs(this.stylesheet.models);const y=this.stylesheet.terrain;y&&(this.checkCanvasFingerprintNoise(),this.disableElevatedTerrain||this.terrainSetForDrapingOnly()||this._createTerrain(y,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.snow&&this._createSnow(this.stylesheet.snow),this.stylesheet.rain&&this._createRain(this.stylesheet.rain),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new s.z("data",{dataType:"style"}));const w=this.isRootStyle();t.imports?this._loadImports(t.imports,r).then(()=>{this._reloadImports(),this.fire(new s.z(w?"style.load":"style.import.load"))}).catch(T=>{this.fire(new s.y(new Error("Failed to load imports",T))),this.fire(new s.z(w?"style.load":"style.import.load"))}):(this._reloadImports(),this.fire(new s.z(w?"style.load":"style.import.load")))};this._styleColorTheme.colorTheme=this.stylesheet["color-theme"];const p=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(p){const g=this._evaluateColorThemeData(p);this._loadColorTheme(g).then(()=>{h()}).catch(y=>{s.w(`Couldn't load color theme from the stylesheet: ${y}`),h()})}else this._styleColorTheme.lut=null,h()}isRootStyle(){return this.importDepth===0}hasAppearances(){return this._hasAppearances||this.fragments.some(t=>t.style.hasAppearances())}mergeAll(){let t,r,h,p,g,y,w,T,A,M;const z={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(L=>{if(L.stylesheet){if(L.light!=null&&(t=L.light),L.stylesheet.lights)for(const D of L.stylesheet.lights)D.type==="ambient"&&L.ambientLight!=null&&(r=L.ambientLight),D.type==="directional"&&L.directionalLight!=null&&(h=L.directionalLight);p=this._prioritizeTerrain(p,L.terrain,L.stylesheet.terrain),L.stylesheet.fog&&L.fog!=null&&(g=L.fog),L.stylesheet.snow&&L.snow!=null&&(y=L.snow),L.stylesheet.rain&&L.rain!=null&&(w=L.rain),L.stylesheet.camera!=null&&(M=L.stylesheet.camera),L.stylesheet.projection!=null&&(T=L.stylesheet.projection),L.stylesheet.transition!=null&&(A=L.stylesheet.transition),z[L.scope]=L._styleColorTheme}}),this.light=t,this.ambientLight=r,this.directionalLight=h,this.fog=g,this.snow=y,this.rain=w,this._styleColorThemeForScope=z,p===null?delete this.terrain:this.terrain=p,this.camera=M||{"camera-projection":"perspective"},this.projection=T||{name:"mercator"},this.transition=Object.assign({},Bu,A),this.mergeSources(),this.mergeLayers(),this.mergeIndoor()}forEachFragmentStyle(t){const r=h=>{for(const p of h.fragments)r(p.style);t(h)};r(this)}_prioritizeTerrain(t,r,h){const p=t&&t.drapeRenderMode===0;return h===null?r&&r.drapeRenderMode===0?r:p?t:null:r!=null&&(!t||p||r&&r.drapeRenderMode===1)?r:t}mergeTerrain(){let t;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(r=>{t=this._prioritizeTerrain(t,r.terrain,r.stylesheet.terrain)}),t===null?delete this.terrain:this.terrain=t}mergeProjection(){let t;this.forEachFragmentStyle(r=>{r.stylesheet.projection!=null&&(t=r.stylesheet.projection)}),this.projection=t||{name:"mercator"}}mergeSources(){const t={},r={},h={};this.forEachFragmentStyle(p=>{for(const g in p._sourceCaches){const y=s.B(g,p.scope);t[y]=p._sourceCaches[g]}for(const g in p._otherSourceCaches){const y=s.B(g,p.scope);r[y]=p._otherSourceCaches[g]}for(const g in p._symbolSourceCaches){const y=s.B(g,p.scope);h[y]=p._symbolSourceCaches[g]}}),this._mergedSourceCaches=t,this._mergedOtherSourceCaches=r,this._mergedSymbolSourceCaches=h}mergeIndoor(){this.forEachFragmentStyle(t=>{if(t.stylesheet&&t.stylesheet.indoor)for(const r of Object.values(t.stylesheet.indoor)){const h=r,p=s.B(h.sourceId,t.scope);this._mergedIndoor[p]=new Set(h.sourceLayers||[])}})}mergeLayers(){const t={},r=[],h={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle(y=>{for(const w of y._order){const T=y._layers[w];if(T.type==="slot"){const A=s.dq(w);if(t[A])continue;t[A]=[]}T.slot&&t[T.slot]?t[T.slot].push(T):r.push(T)}}),this._mergedOrder=[];let p=-1;const g=(y=[])=>{for(const w of y)if(w.type==="slot"){const T=s.dq(w.id);t[T]&&g(t[T]),this._mergedSlots.push(T)}else{const T=s.B(w.id,w.scope);this._mergedOrder.push(T),h[T]=w,w.is3D(!!this.terrain)&&(this._has3DLayers=!0,p=this._mergedOrder.length-1),w.type==="circle"&&(this._hasCircleLayers=!0),w.type==="symbol"&&(this._hasSymbolLayers=!0),w.type==="clip"&&(this._clipLayerPresent=!0)}};if(g(r),this._has3DLayers){const y={};for(let w=0;w<this._mergedOrder.length;++w){const T=this._mergedOrder[w];y[T]=w===p?1:w<p?h[T].hasOcclusionOpacityProperties?2:0:4}this._mergedOrder.sort((w,T)=>y[w]-y[T])}this._mergedLayers=h,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged(),this._updateDataDrivenEmissiveStrength()}terrainSetForDrapingOnly(){return!!this.terrain&&this.terrain.drapeRenderMode===0}getCamera(){return this.stylesheet.camera}setCamera(t){return this.stylesheet.camera=Object.assign({},this.stylesheet.camera,t),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(t){return t.data?function(r,h,p,g){const y=Object.assign({},h);for(const T of Object.keys(Tp))y[T]===void 0&&(y[T]=Tp[T].default);const w=new s.a8(Dv,r,new Map(p));return w.setTransitionOrValue(y,p),w.untransitioned().possiblyEvaluate(new s.ac(0,{worldview:void 0}))}(this.scope,t,this.options).get("data"):null}_loadColorTheme(t){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;const r=this._styleColorTheme.lutLoadingCorrelationID;return new Promise((h,p)=>{const g="data:image/png;base64,";if(!t||t.length===0)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void h();let y=t;y.startsWith(g)||(y=g+y);const w=s.I.from("mapbox-reserved-lut"),T=new Image;T.src=y,T.onerror=()=>{this._styleColorTheme.lutLoading=!1,p(new Error("Failed to load image data"))},T.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==r)return void h();this._styleColorTheme.lutLoading=!1;const{width:A,height:M,data:z}=s.o.getImageData(T);if(M>32)return void p(new Error("The height of the image must be less than or equal to 32 pixels."));if(A!==M*M)return void p(new Error("The width of the image must be equal to the height squared."));this.getImage(w)&&this.removeImage(w),this.addImage(w,{data:new s.q({width:A,height:M},z),pixelRatio:1,sdf:!1,usvg:!1,version:0});const L=this.imageManager.getImage(w,this.scope);L?(this._styleColorTheme.lut={image:L.data,data:t},h()):p(new Error("Missing LUT image."))}})}getLut(t){const r=this._styleColorThemeForScope[t];return r?r.lut:null}setProjection(t){t?this.stylesheet.projection=t:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(t){this._spriteRequest=function(r,h,p){let g,y,w;const T=s.o.devicePixelRatio>1?"@2x":"";let A=s.m(h.transformRequest(h.normalizeSpriteURL(r,T,".json"),s.R.SpriteJSON),(L,D)=>{A=null,w||(w=L,g=D,z())}),M=s.n(h.transformRequest(h.normalizeSpriteURL(r,T,".png"),s.R.SpriteImage),(L,D)=>{M=null,w||(w=L,y=D,z())});function z(){if(w)p(w);else if(g&&y){const L=s.o.getImageData(y),D={};for(const N in g){const{width:B,height:G,x:$,y:X,sdf:J,pixelRatio:K,stretchX:ue,stretchY:oe,content:le}=g[N],re=new s.q({width:B,height:G});s.q.copy(L,re,{x:$,y:X},{x:0,y:0},{width:B,height:G},null),D[N]={data:re,pixelRatio:K!==void 0?K:1,sdf:J!==void 0&&J,stretchX:ue,stretchY:oe,content:le,usvg:!1,version:0}}p(null,D)}}return{cancel(){A&&(A.cancel(),A=null),M&&(M.cancel(),M=null)}}}(t,this.map._requestManager,(r,h)=>{if(this._spriteRequest=null,r)this.fire(new s.y(r));else if(h){const p=new Map;for(const g in h)p.set(s.I.from(g),h[g]);this.addImages(p)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new s.z("data",{dataType:"style"}))})}addIconset(t,r){if(r.type==="sprite")return void this._loadSprite(r.url);const h=this.getOwnSourceCache(r.source);if(!h)return void this.fire(new s.y(new Error(`Source "${r.source}" as specified by iconset "${t}" does not exist and cannot be used as an iconset source`)));const p=h.getSource();if(p.type!=="raster-array")return void this.fire(new s.y(new Error(`Source "${r.source}" as specified by iconset "${t}" is not a "raster-array" source and cannot be used as an iconset source`)));p.partial=!1;const g=new Sp(t,this.scope,h);this.imageManager.addImageProvider(g,this.scope)}removeIconset(t){this.imageManager.removeImageProvider(t,this.scope)}_loadIconset(t){if(!s.h(t)&&this.map._spriteFormat!=="icon_set"||this.map._spriteFormat==="raster")return void this._loadSprite(t);const r=this.map._spriteFormat==="auto";var h,p;this._spriteRequest=(p=(g,y)=>{if(this._spriteRequest=null,g)r?this._loadSprite(t):this.fire(new s.y(g));else if(y){const w=new Map;for(const T in y)w.set(s.I.from(T),y[T]);this.addImages(w)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new s.z("data",{dataType:"style"}))},s.bu((h=this.map._requestManager).transformRequest(h.normalizeIconsetURL(t),s.R.Iconset),(g,y)=>{if(g)return void p(g);const w={},T=s.dg(new s.bt(y));for(const A of T.icons){const M={version:1,pixelRatio:s.o.devicePixelRatio,content:mg(A),stretchX:A.metadata?_g(A.metadata.stretch_x_areas):void 0,stretchY:A.metadata?_g(A.metadata.stretch_y_areas):void 0,sdf:!1,usvg:!0,icon:A};w[A.name]=M}p(null,w)}))}_validateLayer(t){const r=this.getOwnSource(t.source);if(!r)return;const h=t.sourceLayer;h&&(r.type==="geojson"||r.vectorLayerIds&&r.vectorLayerIds.indexOf(h)===-1)&&this.fire(new s.y(new Error(`Source layer "${h}" does not exist on source "${r.id}" as specified by style layer "${t.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(const t in this._sourceCaches)if(!this._sourceCaches[t].loaded())return!1;if(!this.imageManager.isLoaded()||this.imageManager.hasPatternsInFlight()||!this.modelManager.isLoaded()||this._styleColorTheme.lutLoading)return!1;for(const{style:t}of this.fragments)if(!t.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map((t,r)=>{const h=this.fragments[r];return h&&h.style&&(t.data=h.style.serialize()),t})}_serializeSources(){const t={};for(const r in this._sourceCaches){const h=this._sourceCaches[r].getSource();t[h.id]||(t[h.id]=h.serialize())}return t}_serializeLayers(t){const r=[];for(const h of t){const p=this._layers[h];p&&p.type!=="custom"&&r.push(p.serialize())}return r}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasSnowTransition(){return!!this.snow&&this.snow.hasTransition()}hasRainTransition(){return!!this.rain&&this.rain.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition()||this.hasSnowTransition()||this.hasRainTransition())return!0;for(const t in this._sourceCaches)if(this._sourceCaches[t].hasTransition())return!0;for(const t in this._layers)if(this._layers[t].hasTransition())return!0;return!1}_updateDataDrivenEmissiveStrength(){for(const t in this._mergedLayers){const r=this._mergedLayers[t];if(r._transitionablePaint&&r._transitionablePaint._values){const h=r._transitionablePaint._values["line-emissive-strength"];if(h&&h.value&&h.value.isDataDriven())return void(this._hasDataDrivenEmissive=!0)}}this._hasDataDrivenEmissive=!1}hasDataDrivenEmissiveStrength(){return this._hasDataDrivenEmissive}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}_getOrder(t){return t?this.order:this._mergedOrder}isLayerDraped(t){return!!this.terrain&&t.isDraped(this.getLayerSourceCache(t))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(t){const r=this.getOwnLayer(t);if(r)return r;this.fire(new s.y(new Error(`The layer '${t}' does not exist in the map's style.`)))}_checkSource(t){const r=this.getOwnSource(t);if(r)return r;this.fire(new s.y(new Error(`The source '${t}' does not exist in the map's style.`)))}precompilePrograms(t,r){const h=this.map.painter;if(h)for(let p=t.minzoom||0;p<(t.maxzoom||25.5);p++){const g=t.getProgramIds();if(g)for(const y of g){const w=t.getDefaultProgramParams(y,r.zoom,this._styleColorTheme.lut);w&&(h.style=this,this.fog&&(h._fogVisible=!0,w.overrideFog=!0,h.getOrCreateProgram(y,w)),h._fogVisible=!1,w.overrideFog=!1,h.getOrCreateProgram(y,w),(this.stylesheet.terrain||this.stylesheet.projection&&this.stylesheet.projection.name==="globe")&&(w.overrideRtt=!0,h.getOrCreateProgram(y,w)))}}}update(t){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(t),this.directionalLight&&this.directionalLight.recalculate(t);const r=this.calculateLightsBrightness();t.brightness=r||0,r!==this._brightness&&(this._brightness=r,this.dispatcher.broadcast("setBrightness",r)),t.worldview!==this._worldview&&(this._worldview=t.worldview,this.dispatcher.broadcast("setWorldview",this._worldview));const h=this._changes.isDirty();let p=!1;if(this._changes.isDirty()){const w=this._changes.getLayerUpdatesByScope();for(const T in w){const{updatedIds:A,removedIds:M}=w[T];(A||M)&&(this._updateWorkerLayers(T,A,M),p=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(t),this.light&&this.light.updateTransitions(t),this.ambientLight&&this.ambientLight.updateTransitions(t),this.directionalLight&&this.directionalLight.updateTransitions(t),this.fog&&this.fog.updateTransitions(t),this.snow&&this.snow.updateTransitions(t),this.rain&&this.rain.updateTransitions(t),this._changes.reset()}const g={};for(const w in this._mergedSourceCaches){const T=this._mergedSourceCaches[w];g[w]=T.used,T.used=!1,T.tileCoverLift=0}for(const w of this._mergedOrder){const T=this._mergedLayers[w];if(T.visibility!=="none"&&T.recalculate(t,this._availableImages),!T.isHidden(t.zoom)){const A=this.getLayerSourceCache(T);A&&(A.used=!0,A.tileCoverLift=Math.max(A.tileCoverLift,T.tileCoverLift()))}!this._precompileDone&&this._shouldPrecompile&&("requestIdleCallback"in window?requestIdleCallback(()=>{this.precompilePrograms(T,t)}):this.precompilePrograms(T,t))}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&p&&this.mergeLayers();const y=this.imageManager.getPendingImageProviders();for(const w of y)w.sourceCache.used=!0;for(const w in g){const T=this._mergedSourceCaches[w];g[w]!==T.used&&T.getSource().fire(new s.z("data",{sourceDataType:"visibility",dataType:"source",sourceId:T.getSource().id}))}this.light&&this.light.recalculate(t),this.terrain&&this.terrain.recalculate(t),this.fog&&this.fog.recalculate(t),this.snow&&this.snow.recalculate(t),this.rain&&this.rain.recalculate(t),this.z=t.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),this.imageManager.clearUpdatedImages(this.scope),h&&this.fire(new s.z("data",{dataType:"style"}))}updateImageProviders(){const t=this.imageManager.getPendingImageProviders();for(const r of t){const h=r.resolvePendingRequests(),p=this.getFragmentStyle(r.scope);p&&p.addImages(h)}}_updateTilesForChangedImages(){const t={};for(const r in this._mergedSourceCaches){const h=this._mergedSourceCaches[r].getSource().scope;t[h]=t[h]||this._changes.getUpdatedImages(h),t[h].length!==0&&this._mergedSourceCaches[r].reloadTilesForDependencies(["icons","patterns"],t[h])}for(const r in t)this._changes.resetUpdatedImages(r)}_updateWorkerLayers(t,r,h){const p=this.getFragmentStyle(t);p&&this.dispatcher.broadcast("updateLayers",{layers:r?p._serializeLayers(r):[],scope:t,removedIds:h||[],options:p.options})}setState(t,r){if(this._checkLoaded(),Qa(this,fs(t)))return!1;(t=s.dp(t)).layers=Iu(t.layers);const h=function(y,w){if(!y)return[{command:zi.setStyle,args:[w]}];let T=[];try{if(!s.by(y.version,w.version))return[{command:zi.setStyle,args:[w]}];if(s.by(y.center,w.center)||T.push({command:zi.setCenter,args:[w.center]}),s.by(y.zoom,w.zoom)||T.push({command:zi.setZoom,args:[w.zoom]}),s.by(y.bearing,w.bearing)||T.push({command:zi.setBearing,args:[w.bearing]}),s.by(y.pitch,w.pitch)||T.push({command:zi.setPitch,args:[w.pitch]}),s.by(y.sprite,w.sprite)||T.push({command:zi.setSprite,args:[w.sprite]}),s.by(y.glyphs,w.glyphs)||T.push({command:zi.setGlyphs,args:[w.glyphs]}),s.by(y.imports,w.imports)||function(D=[],N=[],B){N=N||[];const G=(D=D||[]).map(Au),$=N.map(Au),X=D.reduce(Cu,{}),J=N.reduce(Cu,{}),K=G.slice();let ue,oe,le,re;for(ue=0,oe=0;ue<G.length;ue++)le=G[ue],J.hasOwnProperty(le)?oe++:(B.push({command:zi.removeImport,args:[le]}),K.splice(K.indexOf(le,oe),1));for(ue=0,oe=0;ue<$.length;ue++)le=$[$.length-1-ue],K[K.length-1-ue]!==le&&(X.hasOwnProperty(le)?(B.push({command:zi.removeImport,args:[le]}),K.splice(K.lastIndexOf(le,K.length-oe),1)):oe++,re=K[K.length-ue],B.push({command:zi.addImport,args:[J[le],re]}),K.splice(K.length-ue,0,le));for(const te of N){const he=X[te.id];he&&(delete he.data,s.by(he,te)||B.push({command:zi.updateImport,args:[te.id,te]}))}}(y.imports,w.imports,T),s.by(y.transition,w.transition)||T.push({command:zi.setTransition,args:[w.transition]}),s.by(y.light,w.light)||T.push({command:zi.setLight,args:[w.light]}),s.by(y.fog,w.fog)||T.push({command:zi.setFog,args:[w.fog]}),s.by(y.snow,w.snow)||T.push({command:zi.setSnow,args:[w.snow]}),s.by(y.rain,w.rain)||T.push({command:zi.setRain,args:[w.rain]}),s.by(y.projection,w.projection)||T.push({command:zi.setProjection,args:[w.projection]}),s.by(y.lights,w.lights)||T.push({command:zi.setLights,args:[w.lights]}),s.by(y.camera,w.camera)||T.push({command:zi.setCamera,args:[w.camera]}),s.by(y.iconsets,w.iconsets)||function(D,N,B){let G;for(G in N=N||{},D=D||{})D.hasOwnProperty(G)&&(N.hasOwnProperty(G)||B.push({command:zi.removeIconset,args:[G]}));for(G in N){if(!N.hasOwnProperty(G))continue;const $=N[G];D.hasOwnProperty(G)?s.by(D[G],$)||(B.push({command:zi.removeIconset,args:[G]}),B.push({command:zi.addIconset,args:[G,$]})):B.push({command:zi.addIconset,args:[G,$]})}}(y.iconsets,w.iconsets,T),!s.by(y["color-theme"],w["color-theme"]))return[{command:zi.setStyle,args:[w]}];const A={},M=[];(function(D,N,B,G){let $;for($ in N=N||{},D=D||{})D.hasOwnProperty($)&&(N.hasOwnProperty($)||pp($,B,G));for($ in N){if(!N.hasOwnProperty($))continue;const X=N[$];D.hasOwnProperty($)?s.by(D[$],X)||(D[$].type==="geojson"&&X.type==="geojson"&&hg(D,N,$)?B.push({command:zi.setGeoJSONSourceData,args:[$,X.data]}):ug($,N,B,G)):Hh($,N,B)}})(y.sources,w.sources,M,A);const z=[];y.layers&&y.layers.forEach(D=>{D.source&&A[D.source]?T.push({command:zi.removeLayer,args:[D.id]}):z.push(D)});let L=y.terrain;L&&A[L.source]&&(T.push({command:zi.setTerrain,args:[void 0]}),L=void 0),T=T.concat(M),s.by(L,w.terrain)||T.push({command:zi.setTerrain,args:[w.terrain]}),function(D,N,B){N=N||[];const G=(D=D||[]).map(Au),$=N.map(Au),X=D.reduce(Cu,{}),J=N.reduce(Cu,{}),K=G.slice(),ue=Object.create(null);let oe,le,re,te,he,we,ye;for(oe=0,le=0;oe<G.length;oe++)re=G[oe],J.hasOwnProperty(re)?le++:(B.push({command:zi.removeLayer,args:[re]}),K.splice(K.indexOf(re,le),1));for(oe=0,le=0;oe<$.length;oe++)re=$[$.length-1-oe],K[K.length-1-oe]!==re&&(X.hasOwnProperty(re)?(B.push({command:zi.removeLayer,args:[re]}),K.splice(K.lastIndexOf(re,K.length-le),1)):le++,we=K[K.length-oe],B.push({command:zi.addLayer,args:[J[re],we]}),K.splice(K.length-oe,0,re),ue[re]=!0);for(oe=0;oe<$.length;oe++)if(re=$[oe],te=X[re],he=J[re],!ue[re]&&!s.by(te,he))if(s.by(te.source,he.source)&&s.by(te["source-layer"],he["source-layer"])&&s.by(te.type,he.type)){for(ye in Za(te.layout,he.layout,B,re,null,zi.setLayoutProperty),Za(te.paint,he.paint,B,re,null,zi.setPaintProperty),s.by(te.slot,he.slot)||B.push({command:zi.setSlot,args:[re,he.slot]}),s.by(te.filter,he.filter)||B.push({command:zi.setFilter,args:[re,he.filter]}),s.by(te.minzoom,he.minzoom)&&s.by(te.maxzoom,he.maxzoom)||B.push({command:zi.setLayerZoomRange,args:[re,he.minzoom,he.maxzoom]}),te)te.hasOwnProperty(ye)&&ye!=="layout"&&ye!=="paint"&&ye!=="filter"&&ye!=="metadata"&&ye!=="minzoom"&&ye!=="maxzoom"&&ye!=="slot"&&(ye.indexOf("paint.")===0?Za(te[ye],he[ye],B,re,ye.slice(6),zi.setPaintProperty):s.by(te[ye],he[ye])||B.push({command:zi.setLayerProperty,args:[re,ye,he[ye]]}));for(ye in he)he.hasOwnProperty(ye)&&!te.hasOwnProperty(ye)&&ye!=="layout"&&ye!=="paint"&&ye!=="filter"&&ye!=="metadata"&&ye!=="minzoom"&&ye!=="maxzoom"&&ye!=="slot"&&(ye.indexOf("paint.")===0?Za(te[ye],he[ye],B,re,ye.slice(6),zi.setPaintProperty):s.by(te[ye],he[ye])||B.push({command:zi.setLayerProperty,args:[re,ye,he[ye]]}))}else B.push({command:zi.removeLayer,args:[re]}),we=K[K.lastIndexOf(re)+1],B.push({command:zi.addLayer,args:[he,we]})}(z,w.layers,T)}catch(A){console.warn("Unable to compute style diff:",A),T=[{command:zi.setStyle,args:[w]}]}return T}(this.serialize(),t).filter(y=>!(y.command in yg));if(h.length===0)return!1;const p=h.filter(y=>!(y.command in gg));if(p.length>0)throw new Error(`Unimplemented: ${p.map(y=>y.command).join(", ")}.`);const g=[];return h.forEach(y=>{g.push(this[y.command](...y.args))}),r&&Promise.all(g).then(r).catch(r),this.stylesheet=t,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}_updateWorkerImages(){this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages})}_updateWorkerModels(){this._availableModels=this.modelManager.getModelURIs(this.scope),this.dispatcher.broadcast("setModels",{scope:this.scope,models:this._availableModels})}addImages(t){if(t.size===0)return this;for(const[r,h]of t.entries()){if(this.getImage(r))return this.fire(new s.y(new Error(`An image with the name "${r.name}" already exists.`)));this.imageManager.addImage(r,this.scope,h),this._changes.updateImage(r,this.scope)}return this._updateWorkerImages(),this.fire(new s.z("data",{dataType:"style"})),this}addImage(t,r){return this.getImage(t)?this.fire(new s.y(new Error(`An image with the name "${t.name}" already exists.`))):(this.imageManager.addImage(t,this.scope,r),this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new s.z("data",{dataType:"style"})),this)}updateImage(t,r,h=!1){this.imageManager.updateImage(t,this.scope,r),h&&(this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new s.z("data",{dataType:"style"})))}getImage(t){return this.imageManager.getImage(t,this.scope)}removeImage(t){return this.getImage(t)?(this.imageManager.removeImage(t,this.scope),this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new s.z("data",{dataType:"style"})),this):this.fire(new s.y(new Error("No image with this name exists.")))}listImages(){return this._checkLoaded(),this._availableImages.slice()}getActualScope(){return this._importedAsBasemap?"basemap":this.scope}addModelURLs(t){return this.modelManager.addModelURLs(t,this.getActualScope()),this._updateWorkerModels(),this.fire(new s.z("data",{dataType:"style"})),this}addModel(t,r,h={}){return this._checkLoaded(),this._validate(V,`models.${t}`,r,null,h)||(this.modelManager.addModel(t,r,this.getActualScope()),this.fire(new s.z("data",{dataType:"style"}))),this}hasModel(t){return this.modelManager.hasModel(t,this.getActualScope())}removeModel(t){return this.hasModel(t)?(this.modelManager.removeModel(t,this.getActualScope(),!1,!0),this.fire(new s.z("data",{dataType:"style"})),this):this.fire(new s.y(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.getActualScope())}addSource(t,r,h={}){if(this._checkLoaded(),this.getOwnSource(t)!==void 0)throw new Error(`There is already a source with ID "${t}".`);if(!r.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(r).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(r.type)>=0&&this._validate(Bh,`sources.${t}`,r,null,h))return;this.map&&this.map._collectResourceTiming&&(r.collectResourceTiming=!0);const p=xr(t,r,this.dispatcher,this);p.scope=this.scope,p.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(p.id),source:p.serialize(),sourceId:p.id}));const g=y=>{const w=(y?"symbol:":"other:")+p.id,T=s.B(w,this.scope),A=this._sourceCaches[w]=new Io(T,p,y);(y?this._symbolSourceCaches:this._otherSourceCaches)[p.id]=A,A.onAdd(this.map)};g(!1),r.type!=="vector"&&r.type!=="geojson"||g(!0),p.onAdd&&p.onAdd(this.map),h.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(t){this._checkLoaded();const r=this.getOwnSource(t);if(!r)throw new Error("There is no source with this ID");for(const p in this._layers)if(this._layers[p].source===t)return this.fire(new s.y(new Error(`Source "${t}" cannot be removed while layer "${p}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===t)return this.fire(new s.y(new Error(`Source "${t}" cannot be removed while terrain is using it.`)));if(this.stylesheet.iconsets){const p=Object.entries(this.stylesheet.iconsets).find(([g,y])=>y.type==="source"&&y.source===t);if(p)return this.fire(new s.y(new Error(`Source "${t}" cannot be removed while iconset "${p[0]}" is using it.`)))}const h=this.getOwnSourceCaches(t);for(const p of h){const g=s.dq(p.id);delete this._sourceCaches[g],this._changes.discardSourceCacheUpdate(p.id),p.fire(new s.z("data",{sourceDataType:"metadata",dataType:"source",sourceId:p.getSource().id})),p.setEventedParent(null),p.clearTiles()}return delete this._otherSourceCaches[t],delete this._symbolSourceCaches[t],this.mergeSources(),r.setEventedParent(null),r.onRemove&&r.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(t,r){this._checkLoaded(),this.getOwnSource(t).setData(r),this._changes.setDirty()}getOwnSource(t){const r=this.getOwnSourceCache(t);return r&&r.getSource()}getOwnSources(){const t=[];for(const r in this._otherSourceCaches){const h=this.getOwnSourceCache(r);h&&t.push(h.getSource())}return t}areTilesLoaded(){const t=this._mergedSourceCaches;for(const r in t){const h=t[r]._tiles;for(const p in h){const g=h[p];if(g.state!=="loaded"&&g.state!=="errored")return!1}}return!0}setLights(t){if(this._checkLoaded(),!t)return delete this.ambientLight,void delete this.directionalLight;const r=this._getTransitionParameters();for(const g of t){if(this._validate(sa,"lights",g))return;switch(g.type){case"ambient":if(this.ambientLight){const y=this.ambientLight;y.set(g),y.updateTransitions(r)}else this.ambientLight=new Li(g,er||(er=new s.a9({color:new s.aa(s.a6.properties_light_ambient.color),"color-use-theme":new s.aa({type:"string",default:"default","property-type":"data-constant"}),intensity:new s.aa(s.a6.properties_light_ambient.intensity)})),this.scope,this.options);break;case"directional":if(this.directionalLight){const y=this.directionalLight;y.set(g),y.updateTransitions(r)}else this.directionalLight=new Li(g,Vn||(Vn=new s.a9({direction:new s.ap(s.a6.properties_light_directional.direction),color:new s.aa(s.a6.properties_light_directional.color),"color-use-theme":new s.aa({type:"string",default:"default","property-type":"data-constant"}),intensity:new s.aa(s.a6.properties_light_directional.intensity),"cast-shadows":new s.aa(s.a6.properties_light_directional["cast-shadows"]),"shadow-quality":new s.aa(s.a6.properties_light_directional["shadow-quality"]),"shadow-intensity":new s.aa(s.a6.properties_light_directional["shadow-intensity"])})),this.scope,this.options)}}const h=Object.assign(r,{worldview:this.map.getWorldview()}),p=new s.ac(this.z||0,h);this.ambientLight&&this.ambientLight.recalculate(p),this.directionalLight&&this.directionalLight.recalculate(p),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const t=this.directionalLight,r=this.ambientLight;if(!t||!r)return;const h=L=>.2126*(L[0]<=.03928?L[0]/12.92:Math.pow((L[0]+.055)/1.055,2.4))+.7152*(L[1]<=.03928?L[1]/12.92:Math.pow((L[1]+.055)/1.055,2.4))+.0722*(L[2]<=.03928?L[2]/12.92:Math.pow((L[2]+.055)/1.055,2.4)),p=t.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),g=t.properties.get("intensity"),y=t.properties.get("direction"),w=1-s.d4(y.x,y.y,y.z)[2]/90,T=h(p)*g*w,A=r.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),M=r.properties.get("intensity"),z=h(A)*M;return Number(((T+z)/2).toFixed(6))}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const t=[];return this.directionalLight&&t.push(this.directionalLight.get()),this.ambientLight&&t.push(this.ambientLight.get()),t}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(t){if(t==null||t===""&&this.isRootStyle())return this;if(s.dr(t)){const r=s.ds(t),h=this.fragments.find(({id:g})=>g===r);if(!h)return;const p=s.dq(t);return h.style.getFragmentStyle(p)}{const r=this.fragments.find(({id:h})=>h===t);return r?r.style:void 0}}setFeaturesetSelectors(t){if(!t)return;const r={},h=(p,g="")=>`${p}::${g}`;this._featuresetSelectors={};for(const p in t){const g=this._featuresetSelectors[p]=[];for(const y of t[p].selectors){if(y.featureNamespace){const T=this.getOwnLayer(y.layer);if(!T){s.w(`Layer is undefined for selector: ${y.layer}`);continue}const A=h(T.source,T.sourceLayer);if(A in r&&r[A]!==y.featureNamespace){s.w(`"featureNamespace ${y.featureNamespace} of featureset ${p}'s selector is not associated to the same source, skip this selector`);continue}r[A]=y.featureNamespace}let w;if(y.properties)for(const T in y.properties){const A=s.U(y.properties[T]);A.result==="success"&&(w=w||{},w[T]=A.value)}g.push({layerId:y.layer,namespace:y.featureNamespace,properties:w,uniqueFeatureID:y._uniqueFeatureID})}}}getFeaturesetDescriptors(t){const r=this.getFragmentStyle(t);if(!r||!r.stylesheet.featuresets)return[];const h=[];for(const p in r.stylesheet.featuresets)h.push({featuresetId:p,importId:r.scope?r.scope:void 0});return h}getFeaturesetLayers(t,r){const h=this.getFragmentStyle(r),p=h.stylesheet.featuresets;if(!p||!p[t])return this.fire(new s.y(new Error(`The featureset '${t}' does not exist in the map's style and cannot be queried.`))),[];const g=[];for(const y of p[t].selectors){const w=h.getOwnLayer(y.layer);w&&g.push(w)}return g}getConfigProperty(t,r){const h=this.getFragmentStyle(t);if(!h)return null;const p=s.B(r,h.scope),g=h.options.get(p),y=g?g.value||g.default:null;return y?y.serialize():null}isIndoorEnabled(){return Object.keys(this._mergedIndoor).length>0}getIndoorSourceLayers(t,r){const h=s.B(t,r);return this._mergedIndoor[h]}setIndoorData(t,r){this.map.indoor.setIndoorData(r)}updateIndoorDependentLayers(){this._updateLayers(this._indoorDependentLayers),this.map._styleDirty=!0,this.map.triggerRepaint()}setConfigProperty(t,r,h){const p=this.getFragmentStyle(t);if(!p)return;const g=p.stylesheet.schema;if(!g||!g[r])return;const y=s.U(h);if(y.result!=="success")return void Qa(this,y.value);const w=y.value.expression,T=s.B(r,p.scope),A=p.options.get(T);if(!A)return;let M;const{minValue:z,maxValue:L,stepValue:D,type:N,values:B}=g[r],G=s.U(g[r].default);G.result==="success"&&(M=G.value.expression),M?(this.options.set(T,Object.assign({},A,{value:w,default:M,minValue:z,maxValue:L,stepValue:D,type:N,values:B})),this.updateConfigDependencies(r)):this.fire(new s.y(new Error(`No schema defined for the config option "${r}" in the "${t}" fragment.`)))}getConfig(t){const r=this.getFragmentStyle(t);if(!r)return null;const h=r.stylesheet.schema;if(!h)return null;const p={};for(const g in h){const y=s.B(g,r.scope),w=r.options.get(y),T=w?w.value||w.default:null;p[g]=T?T.serialize():null}return p}setConfig(t,r){const h=this.getFragmentStyle(t);h&&(h.updateConfig(r,h.stylesheet.schema),this.updateConfigDependencies())}getSchema(t){const r=this.getFragmentStyle(t);return r?r.stylesheet.schema:null}setSchema(t,r){const h=this.getFragmentStyle(t);h&&(h.stylesheet.schema=r,h.updateConfig(h._config,r),this.updateConfigDependencies())}updateConfig(t,r){if(this._config=t,t||r)if(r)for(const h in r){let p,g;const y=s.U(r[h].default);if(y.result==="success"&&(p=y.value.expression),t&&t[h]!==void 0){const L=s.U(t[h]);L.result==="success"&&(g=L.value.expression)}const{minValue:w,maxValue:T,stepValue:A,type:M,values:z}=r[h];if(p){const L=s.B(h,this.scope);this.options.set(L,{default:p,value:g,minValue:w,maxValue:T,stepValue:A,type:M,values:z})}else this.fire(new s.y(new Error(`No schema defined for config option "${h}".`)))}else this.fire(new s.y(new Error("Attempting to set config for a style without schema.")))}_updateLayers(t,r=()=>!0){for(const h of t){const p=this.getLayer(h);p&&r(p)&&(p.possiblyEvaluateVisibility(),this._updateLayer(p),this._changes.setDirty())}}updateConfigDependencies(t){this._updateLayers(this._configDependentLayers,r=>!t||r.expressionDependencies.configDependencies.has(t)),this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.snow&&this.snow.updateConfig(this.options),this.rain&&this.rain.updateConfig(this.options),this.forEachFragmentStyle(r=>{const h=r._styleColorTheme.colorThemeOverride?r._styleColorTheme.colorThemeOverride:r._styleColorTheme.colorTheme;if(h){const p=r._evaluateColorThemeData(h);(!r._styleColorTheme.lut&&p!==""||r._styleColorTheme.lut&&p!==r._styleColorTheme.lut.data)&&r.setColorTheme(h)}}),this._changes.setDirty()}addLayer(t,r,h={}){this._checkLoaded();const p=t.id;if(this._layers[p])return void this.fire(new s.y(new Error(`Layer with id "${p}" already exists on this map`)));let g;if(t.type==="custom"){if(Qa(this,s.dt(t)))return;g=s.du(t,this.scope,this._styleColorTheme.lut,this.options)}else{if(typeof t.source=="object"&&(this.addSource(p,t.source),t=s.dp(t),t=Object.assign(t,{source:p})),this._validate(fp,`layers.${p}`,t,{arrayIndex:-1},h))return;g=s.du(t,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(g),g.setEventedParent(this,{layer:{id:p}})}const y=s.B(g.source,g.scope);g.expressionDependencies.configDependencies.size!==0&&this._configDependentLayers.add(y),g.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(y);let w=this._order.length;if(r){const z=this._order.indexOf(r);if(z===-1)return void this.fire(new s.y(new Error(`Layer with id "${r}" does not exist on this map.`)));g.slot===this._layers[r].slot?w=z:s.w(`Layer with id "${r}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(w,0,p),this._layerOrderChanged=!0,this._layers[p]=g;const T=this.getOwnLayerSourceCache(g),A=!!this.directionalLight&&this.directionalLight.shadowsEnabled();T&&g.canCastShadows()&&A&&(T.castsShadows=!0);const M=this._changes.getRemovedLayer(g);if(M&&g.source&&T&&g.type!=="custom"){this._changes.discardLayerRemoval(g);const z=s.B(g.source,g.scope);M.type!==g.type?this._changes.updateSourceCache(z,"clear"):(this._changes.updateSourceCache(z,"reload"),T.pause())}this._updateLayer(g),g.onAdd&&g.onAdd(this.map),g.scope=this.scope,this.mergeLayers()}moveLayer(t,r){this._checkLoaded();const h=this._checkLayer(t);if(!h||t===r)return;const p=this._order.indexOf(t);this._order.splice(p,1);let g=this._order.length;if(r){const y=this._order.indexOf(r);if(y===-1)return void this.fire(new s.y(new Error(`Layer with id "${r}" does not exist on this map.`)));h.slot===this._layers[r].slot?g=y:s.w(`Layer with id "${r}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(g,0,t),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(t){this._checkLoaded();const r=this._checkLayer(t);if(!r)return;r.setEventedParent(null);const h=this._order.indexOf(t);this._order.splice(h,1),delete this._layers[t],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(r.fqid),this._indoorDependentLayers.delete(r.fqid),this._changes.removeLayer(r);const p=this.getOwnLayerSourceCache(r);if(p&&p.castsShadows){let g=!1;for(const y in this._layers)if(this._layers[y].source===r.source&&this._layers[y].canCastShadows()){g=!0;break}p.castsShadows=g}r.onRemove&&r.onRemove(this.map),this.mergeLayers()}getOwnLayer(t){return this._layers[t]}hasLayer(t){return t in this._mergedLayers}hasLayerType(t){for(const r in this._layers)if(this._layers[r].type===t)return!0;return!1}setLayerZoomRange(t,r,h){this._checkLoaded();const p=this._checkLayer(t);p&&(p.minzoom===r&&p.maxzoom===h||(r!=null&&(p.minzoom=r),h!=null&&(p.maxzoom=h),this._updateLayer(p)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(t,r){this._checkLoaded();const h=this._checkLayer(t);h&&h.slot!==r&&(h.slot=r,this._updateLayer(h))}setFilter(t,r,h={}){this._checkLoaded();const p=this._checkLayer(t);if(p&&!s.by(p.filter,r))return r==null?(p.filter=void 0,void this._updateLayer(p)):void(this._validate(Ml,`layers.${p.id}.filter`,r,{layerType:p.type},h)||(p.filter=s.dp(r),this._updateLayer(p)))}getFilter(t){const r=this._checkLayer(t);if(r)return s.dp(r.filter)}setLayoutProperty(t,r,h,p={}){this._checkLoaded();const g=this._checkLayer(t);if(g&&!s.by(g.getLayoutProperty(r),h)){if(h!=null&&(!p||p.validate!==!1)&&Qa(g,Ie.call(fs,{key:`layers.${t}.layout.${r}`,layerType:g.type,objectKey:r,value:h,styleSpec:s.a6,style:{glyphs:!0,sprite:!0}})))return;g.setLayoutProperty(r,h),g.expressionDependencies.configDependencies.size!==0&&this._configDependentLayers.add(g.fqid),g.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(g.fqid),this._updateLayer(g)}}setLayerProperty(t,r,h,p={}){this._checkLoaded();const g=this._checkLayer(t);g&&(r==="appearances"?(g.setAppearances(h),this._changes.setDirty()):g.isPaintProperty(r)?this.setPaintProperty(t,r,h,p):this.setLayoutProperty(t,r,h,p))}getLayoutProperty(t,r){const h=this._checkLayer(t);if(h)return h.getLayoutProperty(r)}setPaintProperty(t,r,h,p={}){this._checkLoaded();const g=this._checkLayer(t);if(!g||s.by(g.getPaintProperty(r),h)||h!=null&&(!p||p.validate!==!1)&&Qa(g,Tu.call(fs,{key:`layers.${t}.paint.${r}`,layerType:g.type,objectKey:r,value:h,styleSpec:s.a6})))return;const y=g.setPaintProperty(r,h);g.expressionDependencies.configDependencies.size!==0&&this._configDependentLayers.add(g.fqid),g.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(g.fqid),y&&this._updateLayer(g),this._changes.updatePaintProperties(g)}getPaintProperty(t,r){const h=this._checkLayer(t);if(h)return h.getPaintProperty(r)}setFeatureState(t,r){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){const{featuresetId:T,importId:A}=t.target,M=this.getFragmentStyle(A),z=M.getFeaturesetLayers(T);for(const{source:L,sourceLayer:D}of z)M.setFeatureState({id:t.id,source:L,sourceLayer:D},r)}else if("layerId"in t.target){const{layerId:T}=t.target,A=this.getLayer(T);this.setFeatureState({id:t.id,source:A.source,sourceLayer:A.sourceLayer},r)}return}const h=t.source,p=t.sourceLayer,g=this._checkSource(h);if(!g)return;const y=g.type;if(y==="geojson"&&p)return void this.fire(new s.y(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(y==="vector"&&!p)return void this.fire(new s.y(new Error("The sourceLayer parameter must be provided for vector source types.")));t.id===void 0&&this.fire(new s.y(new Error("The feature id parameter must be provided.")));const w=this.getOwnSourceCaches(h);for(const T of w)T.setFeatureState(p,t.id,r)}removeFeatureState(t,r){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){const{featuresetId:T,importId:A}=t.target,M=this.getFragmentStyle(A),z=M.getFeaturesetLayers(T);for(const{source:L,sourceLayer:D}of z)M.removeFeatureState({id:t.id,source:L,sourceLayer:D},r)}else if("layerId"in t.target){const{layerId:T}=t.target,A=this.getLayer(T);this.removeFeatureState({id:t.id,source:A.source,sourceLayer:A.sourceLayer},r)}return}const h=t.source,p=this._checkSource(h);if(!p)return;const g=p.type,y=g==="vector"?t.sourceLayer:void 0;if(g==="vector"&&!y)return void this.fire(new s.y(new Error("The sourceLayer parameter must be provided for vector source types.")));if(r&&typeof t.id!="string"&&typeof t.id!="number")return void this.fire(new s.y(new Error("A feature id is required to remove its specific state property.")));const w=this.getOwnSourceCaches(h);for(const T of w)T.removeFeatureState(y,t.id,r)}getFeatureState(t){if(this._checkLoaded(),"target"in t){let g;if("featuresetId"in t.target){const{featuresetId:y,importId:w}=t.target,T=this.getFragmentStyle(w),A=T.getFeaturesetLayers(y);for(const{source:M,sourceLayer:z}of A){const L=T.getFeatureState({id:t.id,source:M,sourceLayer:z});if(L&&!g)g=L;else if(!s.by(g,L))return void this.fire(new s.y(new Error("The same feature id exists in multiple sources in the featureset, but their feature states are not consistent through the sources.")))}}else if("layerId"in t.target){const{layerId:y}=t.target,w=this.getLayer(y);g=this.getFeatureState({id:t.id,source:w.source,sourceLayer:w.sourceLayer})}return g}const r=t.source,h=t.sourceLayer,p=this._checkSource(r);if(p){if(p.type!=="vector"||h)return t.id===void 0&&this.fire(new s.y(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(r)[0].getFeatureState(h,t.id);this.fire(new s.y(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(t){return this.stylesheet.transition=Object.assign({},this.stylesheet.transition,t),this.transition=this.stylesheet.transition,this}getTransition(){return Object.assign({},this.stylesheet.transition)}serialize(){this._checkLoaded();const t=this.getTerrain(),r=t&&this.terrain&&this.terrain.scope===this.scope?t:this.stylesheet.terrain;return s.dv({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,iconsets:this.stylesheet.iconsets,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:r,fog:this.stylesheet.fog,snow:this.stylesheet.snow,rain:this.stylesheet.rain,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},h=>h!==void 0)}_updateFilteredLayers(t){for(const r of Object.values(this._mergedLayers))t(r)&&this._updateLayer(r)}_updateLayer(t){this._changes.updateLayer(t);const r=this.getLayerSourceCache(t),h=s.B(t.source,t.scope),p=this._changes.getUpdatedSourceCaches();t.source&&!p[h]&&r&&r.getSource().type!=="raster"&&(this._changes.updateSourceCache(h,"reload"),r.pause()),t.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(t){const r=w=>this._mergedLayers[w].is3D(!!this.terrain),h=this.order,p={},g=[];for(let w=h.length-1;w>=0;w--){const T=h[w];if(r(T)){p[T]=w;for(const A of t){const M=A[T];if(M)for(const z of M)g.push(z)}}}g.sort((w,T)=>T.intersectionZ-w.intersectionZ);const y=[];for(let w=h.length-1;w>=0;w--){const T=h[w];if(r(T))for(let A=g.length-1;A>=0;A--){const M=g[A].feature;if(M.layer&&p[M.layer.id]<w)break;y.push(M),g.pop()}else for(const A of t){const M=A[T];if(M)for(const z of M)y.push(z.feature)}}return y}queryRasterValue(t,r,h){const p=this.getOwnSource(t);return p?p.type!=="raster-array"?(this.fire(new s.y(new Error('queryRasterValue support only "raster-array" sources.'))),Promise.resolve(null)):p.queryRasterArrayValue(r,h):(this.fire(new s.y(new Error(`Source with id "${t}" does not exist in the style.`))),Promise.resolve(null))}queryRenderedFeatures(t,r,h){let p;r&&!Array.isArray(r)&&r.filter&&(this._validate(Ml,"queryRenderedFeatures.filter",r.filter,null,r),p=s.b6(r.filter));const g={},y=M=>{if(id.has(M.type))return;const z=this.getOwnLayerSourceCache(M),L=g[z.id]=g[z.id]||{sourceCache:z,layers:{},has3DLayers:!1};M.is3D(!!this.terrain)&&(L.has3DLayers=!0),L.layers[M.fqid]=L.layers[M.fqid]||{styleLayer:M,targets:[]},L.layers[M.fqid].targets.push({filter:p})};if(r&&r.layers){if(!Array.isArray(r.layers))return this.fire(new s.y(new Error("parameters.layers must be an Array."))),[];for(const M of r.layers){const z=this._layers[M];if(!z)return this.fire(new s.y(new Error(`The layer '${M}' does not exist in the map's style and cannot be queried for features.`))),[];y(z)}}else for(const M in this._layers)y(this._layers[M]);const w=this._queryRenderedFeatures(t,g,h),T=this._flattenAndSortRenderedFeatures(w),A=[];for(const M of T)s.dw(M.layer.id)===this.scope&&A.push(M);return A}queryRenderedFeatureset(t,r,h){let p;r&&!Array.isArray(r)&&r.filter&&(this._validate(Ml,"queryRenderedFeatures.filter",r.filter,null,r),p=s.b6(r.filter));const g="mock",y=[];if(r&&r.target)y.push(Object.assign({},r,{targetId:g,filter:p}));else{const M=this.getFeaturesetDescriptors();for(const z of M)y.push({targetId:g,filter:p,target:z});for(const{style:z}of this.fragments){const L=z.getFeaturesetDescriptors();for(const D of L)y.push({targetId:g,filter:p,target:D})}}const w=this.queryRenderedTargets(t,y,h),T=[],A=new Set;for(const M of w)for(const z of M.variants[g])gc(z,M,A)||T.push(new s.dx(M,z));return T}queryRenderedTargets(t,r,h){const p={},g=(w,T,A,M)=>{const z=p[T.id]=p[T.id]||{sourceCache:T,layers:{},has3DLayers:!1};if(z.layers[w.fqid]=z.layers[w.fqid]||{styleLayer:w,targets:[]},w.is3D(!!this.terrain)&&(z.has3DLayers=!0),!M)return A.uniqueFeatureID=!1,void z.layers[w.fqid].targets.push(A);z.layers[w.fqid].targets.push(Object.assign({},A,{namespace:M.namespace,properties:M.properties,uniqueFeatureID:M.uniqueFeatureID}))};for(const w of r)if("featuresetId"in w.target){const{featuresetId:T,importId:A}=w.target,M=this.getFragmentStyle(A);if(!M||!M._featuresetSelectors)continue;const z=M._featuresetSelectors[T];if(!z){this.fire(new s.y(new Error(`The featureset '${T}' does not exist in the map's style and cannot be queried for features.`)));continue}for(const L of z){const D=M.getOwnLayer(L.layerId);D&&!id.has(D.type)&&g(D,M.getOwnLayerSourceCache(D),w,L)}}else if("layerId"in w.target){const{layerId:T}=w.target,A=this.getLayer(T);if(!A||id.has(A.type))continue;g(A,this.getLayerSourceCache(A),w)}const y=this._queryRenderedFeatures(t,p,h);return this._flattenAndSortRenderedFeatures(y)}_queryRenderedFeatures(t,r,h){const p=[],g=!!this.map._showQueryGeometry,y=Ln.createFromScreenPoints(t,h);for(const w in r){const T=Nh(y,r[w],this._availableImages,h,g);Object.keys(T).length&&p.push(T)}if(this.placement)for(const w in r){if(!r[w].sourceCache._onlySymbols)continue;const T=jh(y.screenGeometry,r[w],this._availableImages,this.placement.collisionIndex,this.placement.retainedQueryData,this.map.getWorldview());Object.keys(T).length&&p.push(T)}return p}querySourceFeatures(t,r){const h=r&&r.filter;h&&this._validate(Ml,"querySourceFeatures.filter",h,null,r);let p=[];const g=this.getOwnSourceCaches(t);for(const y of g)p=p.concat(Uh(y,r));return p}addSourceType(t,r,h){return Qo.getSourceType(t)?h(new Error(`A source type called "${t}" already exists.`)):(Qo.setSourceType(t,r),r.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:t,url:r.workerSourceURL},h):h(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(t,r,h={}){this._checkLoaded();const p=this.light.getLight();let g=!1;for(const w in t)if(!s.by(t[w],p[w])){g=!0;break}if(!g)return;const y=this._getTransitionParameters();this.light.setLight(t,r,h),this.light.updateTransitions(y)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){this.disableElevatedTerrain===void 0&&(this.disableElevatedTerrain=s.o.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&s.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(t,r=1){if(this._checkLoaded(),!t)return this.terrainSetForDrapingOnly()||(delete this.terrain,this.map.transform.projection.requiresDraping&&this.setTerrainForDraping()),r===0&&delete this.terrain,t===null?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let h=t;const p=!("source"in t)||t.source==null;if(r===1){if(this.disableElevatedTerrain)return;if("source"in h&&typeof h.source=="object"){const w="terrain-dem-src";this.addSource(w,h.source),h=s.dp(h),h=Object.assign(h,{source:w})}const g=Object.assign({},h),y={};if(this.terrain&&p){g.source=this.terrain.get().source;const w=this.terrain?this.getFragmentStyle(this.terrain.scope):null;w&&(y.style=w.serialize())}if(this._validate(dp,"terrain",g,y))return}if(!this.terrain||this.terrain.scope!==this.scope&&!p||this.terrain&&r!==this.terrain.drapeRenderMode){if(!h)return;this._createTerrain(h,r),this.fire(new s.z("data",{dataType:"style"}))}else{const g=this.terrain,y=g.get();for(const w of Object.keys(s.a6.terrain))!h.hasOwnProperty(w)&&s.a6.terrain[w].default&&(h[w]=s.a6.terrain[w].default);for(const w in t)if(!s.by(t[w],y[w])){g.set(t,this.options),this.stylesheet.terrain=t;const T=this._getTransitionParameters({duration:0});g.updateTransitions(T),this.fire(new s.z("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(t){const r=this.fog=new ri(t,this.map.transform,this.scope,this.options);this.stylesheet.fog=r.get();const h=this._getTransitionParameters({duration:0});r.updateTransitions(h)}_createSnow(t){const r=this.snow=new rr(t,this.map.transform,this.scope,this.options);this.stylesheet.snow=r.get();const h=this._getTransitionParameters({duration:0});r.updateTransitions(h)}_createRain(t){const r=this.rain=new kn(t,this.map.transform,this.scope,this.options);this.stylesheet.rain=r.get();const h=this._getTransitionParameters({duration:0});r.updateTransitions(h)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask(()=>{for(const t of this.map._markers)t._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(t){if(this._checkLoaded(),!t)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const r=this.fog;if(!s.by(r.get(),t)){r.set(t,this.options),this.stylesheet.fog=r.get();const h=this._getTransitionParameters({duration:0});r.updateTransitions(h)}}else this._createFog(t);this._markersNeedUpdate=!0}getSnow(){return this.snow?this.snow.get():null}setSnow(t){if(this._checkLoaded(),!t)return delete this.snow,void delete this.stylesheet.snow;if(this.snow){const r=this.snow;if(!s.by(r.get(),t)){r.set(t,this.options),this.stylesheet.snow=r.get();const h=this._getTransitionParameters({duration:0});r.updateTransitions(h)}}else this._createSnow(t);this._markersNeedUpdate=!0}getRain(){return this.rain?this.rain.get():null}setRain(t){if(this._checkLoaded(),!t)return delete this.rain,void delete this.stylesheet.rain;if(this.rain){const r=this.rain;if(!s.by(r.get(),t)){r.set(t,this.options),this.stylesheet.rain=r.get();const h=this._getTransitionParameters({duration:0});r.updateTransitions(h)}}else this._createRain(t);this._markersNeedUpdate=!0}_reloadColorTheme(){const t=()=>{for(const p in this._layers)this._layers[p].lut=this._styleColorTheme.lut;for(const p in this._sourceCaches)this._sourceCaches[p].clearTiles()},r=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(!r)return this._styleColorTheme.lut=null,void t();const h=this._evaluateColorThemeData(r);this._loadColorTheme(h).then(()=>{this.fire(new s.z("colorthemeset")),t()}).catch(p=>{s.w(`Couldn't set color theme: ${p}`)})}setColorTheme(t){this._checkLoaded(),this._styleColorTheme.colorThemeOverride&&s.w("Note: setColorTheme is called on a style with a color-theme override, the passed color-theme won't be visible."),this._styleColorTheme.colorTheme=t,this._reloadColorTheme()}setImportColorTheme(t,r){const h=this.getFragmentStyle(t);h&&(h._styleColorTheme.colorThemeOverride=r,h._reloadColorTheme())}_getTransitionParameters(t){return{now:s.o.now(),transition:Object.assign(this.transition,t)}}updateDrapeFirstLayers(){if(!this.terrain)return;const t=[],r=[];for(const h of this._mergedOrder)this.isLayerDraped(this._mergedLayers[h])?t.push(h):r.push(h);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...t),this._drapedFirstOrder.push(...r)}_createTerrain(t,r){const h=this.terrain=new Te(t,r,this.scope,this.options,this.map.getWorldview());r===1&&(this.stylesheet.terrain=t),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const p=this._getTransitionParameters({duration:0});h.updateTransitions(p)}_force3DLayerUpdate(){for(const t in this._layers){const r=this._layers[t];r.type==="fill-extrusion"&&this._updateLayer(r)}}_forceSymbolLayerUpdate(){for(const t in this._layers){const r=this._layers[t];r.type==="symbol"&&this._updateLayer(r)}}_validate(t,r,h,p,g={}){if(g&&g.validate===!1)return!1;const y=Object.assign({},this.serialize());return Qa(this,t.call(fs,Object.assign({key:r,style:y,value:h,styleSpec:s.a6},p)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),s.dy.off("pluginStateChange",this._rtlTextPluginCallback);for(const t in this._mergedLayers)this._mergedLayers[t].setEventedParent(null);for(const t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles(),this._mergedSourceCaches[t].setEventedParent(null);this.imageManager.removeScope(this.scope),this.setEventedParent(null),delete this.fog,delete this.snow,delete this.rain,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.imageManager.destroy(),this.modelManager.setEventedParent(null),this.modelManager.destroy(),this.dispatcher.remove())}clearSource(t){const r=this.getSourceCaches(t);for(const h of r)h.clearTiles()}clearSources(){for(const t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles()}clearLayers(){for(const t in this._mergedLayers){const r=this._mergedLayers[t];r._clear&&r._clear()}}reloadSource(t){const r=this.getSourceCaches(t);for(const h of r)h.resume(),h.reload()}reloadSources(){for(const t of this.getSources())t.reload&&t.reload()}reloadModels(){this.modelManager.reloadModels(""),this.forEachFragmentStyle(t=>{t.modelManager.reloadModels(t.scope)})}updateSources(t){let r;this.directionalLight&&(r=Fu(this.directionalLight));const h=new Set,p=new Set;for(const g in this._mergedLayers){const y=this._mergedLayers[g];y.type==="building"&&h.add(y.source),y.hasElevation()&&!p.has(y.source)&&p.add(y.source)}for(const g in this._mergedSourceCaches){const y=this._mergedSourceCaches[g],w=p.has(y._source.id);h.has(y._source.id)&&(y._source.reparseOverscaled=!1),y.update(t,void 0,void 0,r,w)}}_generateCollisionBoxes(){for(const t in this._sourceCaches){const r=this._sourceCaches[t];r.resume(),r.reload()}}_updatePlacement(t,r,h,p,g,y,w=!1){let T=!1,A=!1;const M={},z={};for(const B of this._mergedOrder){const G=this._mergedLayers[B];if(G.type!=="symbol")continue;const $=s.B(G.source,G.scope);let X=M[$];if(!X){const K=this.getLayerSourceCache(G);if(!K)continue;const ue=K.getRenderableIds(!0).map(oe=>K.getTileByID(oe));z[$]=ue.slice(),X=M[$]=ue.sort((oe,le)=>le.tileID.overscaledZ-oe.tileID.overscaledZ||(oe.tileID.isLessThan(le.tileID)?-1:1))}const J=this.crossTileSymbolIndex.addLayer(G,X,r.center.lng,r.projection);T=T||J}this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),w=w||this._layerOrderChanged,this._layerOrderChanged&&this.fire(new s.z("neworder"));const L=!!(this.placement&&!r.equals(this.placement.transform)),D=!!(this.placement&&(this.placement.lastReplacementSourceUpdateTime!==0&&!y||this.placement.lastReplacementSourceUpdateTime!==y.updateTime)),N=(L||D||T||this.placement&&this.placement.isStale())&&p===0;if((w||!this.pauseablePlacement||N||p!==0&&this.pauseablePlacement.isDone()&&!this.placement.stillRecent(s.o.now(),r.zoom))&&(this.pauseablePlacement=new wr(r,this._mergedOrder,w||p===0,h,p,g,this.placement,this.fog&&r.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,M,z,this.map.painter.scaleFactor),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(s.o.now()),A=!0),T&&this.pauseablePlacement.placement.setStale()),A||T){this._buildingIndex.onNewFrame(r.zoom);for(let B=0;B<this._mergedOrder.length;B++){const G=this._mergedLayers[this._mergedOrder[B]];if(G.type!=="symbol"||G.visibility==="none")continue;const $=this.isLayerClipped(G);this.placement.updateLayerOpacities(G,M[s.B(G.source,G.scope)],B,$?y:null)}}return{needsRerender:!this.pauseablePlacement.isDone()||this.placement.hasTransitions(s.o.now())}}_releaseSymbolFadeTiles(){for(const t in this._sourceCaches)this._sourceCaches[t].releaseSymbolFadeTiles()}addImport(t,r){this._checkLoaded();const h=this.stylesheet.imports=this.stylesheet.imports||[];if(h.findIndex(({id:g})=>g===t.id)!==-1)return void this.fire(new s.y(new Error(`Import with id '${t.id}' already exists in the map's style.`)));if(!r)return h.push(t),this._loadImports([t],!0);const p=h.findIndex(({id:g})=>g===r);return p===-1&&this.fire(new s.y(new Error(`Import with id "${r}" does not exist on this map.`))),this.stylesheet.imports=h.slice(0,p).concat(t).concat(h.slice(p)),this._loadImports([t],!0,r)}updateImport(t,r){this._checkLoaded();const h=this.stylesheet.imports||[],p=this.getImportIndex(t);return p===-1?this:typeof r=="string"?(this.setImportUrl(t,r),this):(r.url&&r.url!==h[p].url&&this.setImportUrl(t,r.url),s.by(r.config,h[p].config)||this.setImportConfig(t,r.config,r.data.schema),s.by(r.data,h[p].data)||this.setImportData(t,r.data),this)}moveImport(t,r){this._checkLoaded();let h=this.stylesheet.imports||[];const p=this.getImportIndex(t);if(p===-1)return this;const g=this.getImportIndex(r);if(g===-1)return this;const y=h[p],w=this.fragments[p];return h=h.filter(({id:T})=>T!==t),this.fragments=this.fragments.filter(({id:T})=>T!==t),this.stylesheet.imports=h.slice(0,g).concat(y).concat(h.slice(g)),this.fragments=this.fragments.slice(0,g).concat(w).concat(this.fragments.slice(g)),this.mergeLayers(),this}setImportUrl(t,r){this._checkLoaded();const h=this.stylesheet.imports||[],p=this.getImportIndex(t);if(p===-1)return this;h[p].url=r;const g=this.fragments[p];return g.style=this._createFragmentStyle(h[p]),g.style.on("style.import.load",()=>this.mergeAll()),g.style.loadURL(r),this}setImportData(t,r){this._checkLoaded();const h=this.getImportIndex(t),p=this.stylesheet.imports||[];return h===-1?this:r?(this.fragments[h].style.setState(r),this._reloadImports(),this):(delete p[h].data,this.setImportUrl(t,p[h].url))}setImportConfig(t,r,h){this._checkLoaded();const p=this.getImportIndex(t),g=this.stylesheet.imports||[];if(p===-1)return this;r?g[p].config=r:delete g[p].config;const y=this.fragments[p];h&&y.style.stylesheet&&(y.style.stylesheet.schema=h);const w=y.style.stylesheet&&y.style.stylesheet.schema;return y.config=r,y.style.updateConfig(r,w),this.updateConfigDependencies(),this}removeImport(t){this._checkLoaded();const r=this.stylesheet.imports||[],h=this.getImportIndex(t);h!==-1&&(r.splice(h,1),this.fragments[h].style._remove(),this.fragments.splice(h,1),this._reloadImports())}getImportIndex(t){const r=(this.stylesheet.imports||[]).findIndex(h=>h.id===t);return r===-1&&this.fire(new s.y(new Error(`Import '${t}' does not exist in the map's style and cannot be updated.`))),r}getLayer(t){return this._mergedLayers[t]}getSources(){const t=[];for(const r in this._mergedOtherSourceCaches){const h=this._mergedOtherSourceCaches[r];h&&t.push(h.getSource())}return t}getSource(t,r){const h=this.getSourceCache(t,r);return h&&h.getSource()}getLayerSource(t){const r=this.getLayerSourceCache(t);return r&&r.getSource()}getSourceCache(t,r){const h=s.B(t,r);return this._mergedOtherSourceCaches[h]}getLayerSourceCache(t){const r=s.B(t.source,t.scope);return t.type==="symbol"?this._mergedSymbolSourceCaches[r]:this._mergedOtherSourceCaches[r]}getSourceCaches(t){if(t==null)return Object.values(this._mergedSourceCaches);const r=[];return this._mergedOtherSourceCaches[t]&&r.push(this._mergedOtherSourceCaches[t]),this._mergedSymbolSourceCaches[t]&&r.push(this._mergedSymbolSourceCaches[t]),r}updateSourceCaches(){const t=this._changes.getUpdatedSourceCaches();for(const r in t){const h=t[r];h==="reload"?this.reloadSource(r):h==="clear"&&this.clearSource(r)}}updateLayers(t){const r=this._changes.getUpdatedPaintProperties();for(const h of r){const p=this.getLayer(h);p&&p.updateTransitions(t)}}getGlyphsUrl(){return this.stylesheet.glyphs}setGlyphsUrl(t){this.stylesheet.glyphs=t,this.glyphManager.setURL(t)}getImages(t,r,h){this.imageManager.getImages(r.images,r.scope,h),this._updateTilesForChangedImages();const p=y=>{if(y){const w=r.images.map(T=>s.I.toString(T));y.setDependencies(r.tileID.key,r.type,w)}},g=s.B(r.source,r.scope);p(this._mergedOtherSourceCaches[g]),p(this._mergedSymbolSourceCaches[g]),r.images.some(y=>y.iconsetId)&&this.fire(new s.z("data",{dataType:"style"}))}rasterizeImages(t,r,h){this.imageManager.rasterizeImages(r,h)}getGlyphs(t,r,h){this.glyphManager.getGlyphs(r.stacks,h)}getResource(t,r,h){return s.dz(r,h)}getOwnSourceCache(t){return this._otherSourceCaches[t]}getOwnLayerSourceCache(t){return t.type==="symbol"?this._symbolSourceCaches[t.source]:this._otherSourceCaches[t.source]}getOwnSourceCaches(t){const r=[];return this._otherSourceCaches[t]&&r.push(this._otherSourceCaches[t]),this._symbolSourceCaches[t]&&r.push(this._symbolSourceCaches[t]),r}_isSourceCacheLoaded(t){const r=this.getOwnSourceCaches(t);return r.length===0?(this.fire(new s.y(new Error(`There is no source with ID '${t}'`))),!1):r.every(h=>h.loaded())}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(t,r){if(!this._clipLayerPresent&&t.type!=="fill-extrusion"&&t.type!=="building")return!1;const h=t.type==="fill-extrusion"&&(t.sourceLayer==="building"||t.sourceLayer==="procedural_buildings"),p=t.type==="building";if(t.is3D(!!this.terrain)){if(h||p||r&&r.type==="batched-model"||t.type==="model")return!0}else if(t.type==="symbol")return!0;return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach(t=>{t.style._remove()}),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}Qo.getSourceType=function(u){return zs[u]},Qo.setSourceType=function(u,t){zs[u]=t},Qo.registerForPluginStateChange=s.dA;class vg extends s.E{constructor(t){super(),this._style=t,this._buildings={},this._activeFloors=new Set,this._activeFloorsVisible=!0,this._indoorState={selectedFloorId:null,lastActiveFloors:null,activeFloorsVisible:!0},s.aY(["_updateUI"],this)}destroy(){this._buildings={},this._activeFloors=new Set,this._indoorState=null}selectFloor(t){t===this._selectedFloorId&&this._activeFloorsVisible||(this._selectedFloorId=t,this._activeFloorsVisible=!0,this._updateActiveFloors())}setActiveFloorsVisibility(t){this._activeFloorsVisible=t,this._updateActiveFloors(),this._updateIndoorSelector()}setIndoorData(t){for(const[r,h]of Object.entries(t.buildings))if(this._buildings[r])for(const p of h.floorIds)this._buildings[r].floors[p]||(this._buildings[r].floors[p]=h.floors[p]);else this._buildings[r]=h;for(const r of t.activeFloors)this._activeFloors.add(r);this._updateIndoorSelector()}getIndoorTileOptions(t,r){const h=this._style.getIndoorSourceLayers(t,r);return h&&this._indoorState?{sourceLayers:h,indoorState:this._indoorState}:null}_updateUI(t,r,h){const p=function(g,y,w,T){let A=null,M=Number.MAX_SAFE_INTEGER;if(T<16)return null;for(const[z,L]of Object.entries(g)){const D=L.center;if(D){const N=y.distanceTo(s.aT.convert(D));N<M&&w.contains(D)&&(M=N,A=z)}}return A}(this._buildings,r,h,t);p!==this._closestBuildingId&&(this._closestBuildingId=p,this._updateIndoorSelector())}_updateIndoorSelector(){const t=this._buildings,r=this._closestBuildingId,h=r&&t?t[r]:void 0;if(!h)return void this.fire(new s.z("selector-update",{selectedFloorId:null,activeFloorsVisible:this._activeFloorsVisible,floors:[]}));let p=null;for(const y of h.floorIds)if(this._activeFloors&&this._activeFloors.has(y)){p=y;break}const g=Array.from(h.floorIds).map(y=>({id:y,name:h.floors[y].name,zIndex:h.floors[y].zIndex})).sort((y,w)=>w.zIndex-y.zIndex);this.fire(new s.z("selector-update",{selectedFloorId:p,activeFloorsVisible:this._activeFloorsVisible,floors:g}))}_updateActiveFloors(){const t=this._activeFloors;this._activeFloors=new Set,this._indoorState={selectedFloorId:this._selectedFloorId,lastActiveFloors:t,activeFloorsVisible:this._activeFloorsVisible},this._style.updateIndoorDependentLayers()}}var bc=`
#define EPSILON 0.0000001
#define PI 3.141592653589793
#ifdef RENDER_CUTOFF
float cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}
#endif`,Tc=`
#ifdef DUAL_SOURCE_BLENDING
layout(location=0,index=0) out vec4 glFragColor;layout(location=0,index=1) out vec4 glFragColorSrc1;
#else
layout(location=0) out vec4 glFragColor;
#endif
#ifdef USE_MRT1
layout(location=1) out vec4 out_Target1;
#endif
highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
#ifdef INDICATOR_CUTOUT
uniform vec3 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;
#endif
vec4 applyCutout(vec4 color,float height) {
#ifdef INDICATOR_CUTOUT
float verticalFadeRange=u_indicator_cutout_centers.z*0.25;float holeMinOpacity=mix(1.0,u_indicator_cutout_params.x,smoothstep(u_indicator_cutout_centers.z,u_indicator_cutout_centers.z+verticalFadeRange,height));float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);
#else
return color;
#endif
}
#ifdef DEBUG_WIREFRAME
#define HANDLE_WIREFRAME_DEBUG \\
glFragColor=vec4(0.7,0.0,0.0,0.7); \\
gl_FragDepth=gl_FragCoord.z-0.0001;
#else
#define HANDLE_WIREFRAME_DEBUG
#endif
#ifdef RENDER_CUTOFF
uniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;
#endif
vec4 textureLodCustom(sampler2D image,highp vec2 pos,highp vec2 lod_coord) {highp vec2 size=vec2(textureSize(image,0));highp vec2 dx=dFdx(lod_coord.xy*size);highp vec2 dy=dFdy(lod_coord.xy*size);highp float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));highp float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb*col.a,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}`,Ep=`
#define EXTENT 8192.0
#define RAD_TO_DEG 180.0/PI
#define DEG_TO_RAD PI/180.0
#define GLOBE_RADIUS EXTENT/PI/2.0
float wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {
#ifndef PROJECTED_POS_ON_VIEWPORT
float tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;
#else
return vec3(0.0);
#endif
}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(
unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const vec2 units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (units_to_pixels*pos+offset)/pattern_size;}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {return get_pattern_pos(pixel_coord_upper,pixel_coord_lower,pattern_size,vec2(tile_units_to_pixels),pos);}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}
#ifdef RENDER_CUTOFF
uniform vec4 u_cutoff_params;out float v_cutoff_opacity;
#endif
const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)
{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}
#ifndef HAS_SHADER_STORAGE_BLOCK_material_buffer
#define GET_ATTRIBUTE_float(attrib,matInfo,attrib_id) attrib
#define GET_ATTRIBUTE_vec4(attrib,matInfo,attrib_id) attrib
#define GET_ATTRIBUTE_vec2(attrib,matInfo,attrib_id) attrib
#define DECLARE_MATERIAL_TABLE_INFO
#endif`,nd="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",Do=`
#define ELEVATION_SCALE 7.0
#define ELEVATION_OFFSET 450.0
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(
mix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}
#else
vec3 elevationVector(vec2 pos) { return vec3(0,0,1); }
#endif
#ifdef TERRAIN
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}float prevElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}
#ifdef TERRAIN_VERTEX_MORPHING
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}
#else
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
return currentElevation(apos);}
#endif
vec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}
#else
float elevation(vec2 pos) { return 0.0; }
#endif
#ifdef DEPTH_OCCLUSION
uniform highp sampler2D u_depth;uniform highp vec2 u_depth_size_inv;uniform highp vec2 u_depth_range_unpack;uniform highp float u_occluder_half_size;uniform highp float u_occlusion_depth_offset;
#ifdef DEPTH_D24
float unpack_depth(float depth) {return depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}vec4 unpack_depth4(vec4 depth) {return depth*u_depth_range_unpack.x+vec4(u_depth_range_unpack.y);}
#else
highp float unpack_depth_rgba(vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;
#ifdef CLIP_ZERO_TO_ONE
coord.z=-1.0+2.0*coord.z; 
#endif
#ifdef DEPTH_D24
float depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5).r);
#else
float depth=unpack_depth_rgba(texture(u_depth,(coord.xy+1.0)*0.5));
#endif
return coord.z+u_occlusion_depth_offset > depth;}highp vec4 getCornerDepths(vec2 coord) {highp vec3 df=vec3(u_occluder_half_size*u_depth_size_inv,0.0);highp vec2 uv=0.5*coord.xy+0.5;
#ifdef DEPTH_D24
highp vec4 depth=vec4(
texture(u_depth,uv-df.xz).r,texture(u_depth,uv+df.xz).r,texture(u_depth,uv-df.zy).r,texture(u_depth,uv+df.zy).r
);depth=unpack_depth4(depth);
#else
highp vec4 depth=vec4(
unpack_depth_rgba(texture(u_depth,uv-df.xz)),unpack_depth_rgba(texture(u_depth,uv+df.xz)),unpack_depth_rgba(texture(u_depth,uv-df.zy)),unpack_depth_rgba(texture(u_depth,uv+df.zy))
);
#endif
return depth;}highp float occlusionFadeMultiSample(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec2 uv=0.5*coord.xy+0.5;
#ifdef CLIP_ZERO_TO_ONE
coord.z=-1.0+2.0*coord.z; 
#endif
int NX=3;int NY=4;highp vec2 df=u_occluder_half_size*u_depth_size_inv;highp vec2 oneStep=2.0*u_occluder_half_size*u_depth_size_inv/vec2(NX-1,NY-1);highp float res=0.0;for (int y=0; y < NY;++y) {for (int x=0; x < NX;++x) {
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)));
#endif
res+=1.0-clamp(300.0*(coord.z+u_occlusion_depth_offset-depth),0.0,1.0);}}res=clamp(2.0*res/float(NX*NY)-0.5,0.0,1.0);return res;}highp float occlusionFade(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;
#ifdef CLIP_ZERO_TO_ONE
coord.z=-1.0+2.0*coord.z; 
#endif
highp vec4 depth=getCornerDepths(coord.xy);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z+u_occlusion_depth_offset)-depth),0.0,1.0));}
#else
bool isOccluded(vec4 frag) { return false; }highp float occlusionFade(vec4 frag) { return 1.0; }highp float occlusionFadeMultiSample(vec4 frag) { return 1.0; }
#endif`,rd=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}
#endif`,dt=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;
#ifdef FLIP_Y
uv.y=1.0-uv.y;
#endif
highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {return color;}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}
#endif`,Ip=`#ifdef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)
);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)
);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}
#endif`,od=`#ifdef RASTER_ARRAY
uniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec2 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=u_data_offset+vec2(dot(t.rg,u_data_scale),dot(t.ba,u_data_scale));velocity.y=-velocity.y;velocity/=max(u_max_speed,length(velocity));return velocity;}
#endif
uniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}`,sd=`#ifdef RENDER_SHADOWS
uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {vec3 transformed_normal=vec3(-normal.xy,normal.z);float NDotL=dot(normalize(transformed_normal),u_shadow_direction);float dotScale=min(1.0-NDotL,1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}
#endif`,Ap=`#ifdef RENDER_SHADOWS
precision highp sampler2DShadow;uniform sampler2DShadow u_shadowmap_0;uniform sampler2DShadow u_shadowmap_1;uniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;float shadow_sample(sampler2DShadow shadowmap,highp vec3 pos,highp float bias) {
#ifdef CLIP_ZERO_TO_ONE
highp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z-bias);
#else
highp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z*0.5+0.5-bias);
#endif
return texture(shadowmap,coord);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {light_view_pos0.xyz/=light_view_pos0.w;
#ifdef SHADOWS_SINGLE_CASCADE
vec2 abs_bounds=abs(light_view_pos0.xy);if (abs_bounds.x >=1.0 || abs_bounds.y >=1.0) {return 0.0;}return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);
#else
light_view_pos1.xyz/=light_view_pos1.w;vec4 abs_bounds=abs(vec4(light_view_pos0.xy,light_view_pos1.xy));if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}float occlusion1=shadow_sample(u_shadowmap_1,light_view_pos1.xyz,bias);return clamp(mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth)),0.0,1.0);
#endif
}highp float calculate_shadow_bias(float NDotL) {
#ifdef NORMAL_OFFSET
return 0.5*u_shadow_bias.x;
#else
return 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));
#endif
}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_opacity(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,float shadow_opacity) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias)*shadow_opacity;return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}highp vec2 compute_receiver_plane_depth_bias(highp vec3 pos_dx,highp vec3 pos_dy)
{highp vec2 biasUV=vec2(
pos_dy.y*pos_dx.z-pos_dx.y*pos_dy.z,pos_dx.x*pos_dy.z-pos_dy.x*pos_dx.z);biasUV*=1.0/((pos_dx.x*pos_dy.y)-(pos_dx.y*pos_dy.x));return biasUV;}float shadowed_light_factor_plane_bias(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {highp vec3 light_view_pos0_xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;highp vec3 light_view_pos0_ddx=dFdx(light_view_pos0_xyz);highp vec3 light_view_pos0_ddy=dFdy(light_view_pos0_xyz);highp vec2 plane_depth_bias=compute_receiver_plane_depth_bias(light_view_pos0_ddx,light_view_pos0_ddy);highp float bias=dot(vec2(u_shadow_texel_size,u_shadow_texel_size),plane_depth_bias)+0.0001;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}
#endif`;const Nu=/#include\s+"([^"]+)"/g,Us=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g,Cp=/\b[A-Za-z_][A-Za-z0-9_]*\b/g,Bl=new Set(["ifdef","ifndef","elif","if","defined"]),Nl=new Set;il(bc,Nl),il(Ep,Nl),il(Tc,Nl);const tl={"_prelude_fog.vertex.glsl":rd,"_prelude_terrain.vertex.glsl":Do,"_prelude_shadow.vertex.glsl":sd,"_prelude_material_table.vertex.glsl":`#ifdef HAS_SHADER_STORAGE_BLOCK_material_buffer
#define MATERIAL_TABLE_DEBUG 0
uniform int u_material_offset;uniform int u_vertex_offset;layout(std140,binding=0)readonly buffer material_buffer{uvec4 material_data[];};struct MaterialInfo{uint dataOffset;
#if MATERIAL_TABLE_DEBUG
vec4 colorDebug;
#endif
};uint read_buf_no_offset(uint iDword) {return material_data[iDword/4u][iDword % 4u];}uint read_buf(uint iDword) {iDword+=uint(u_material_offset/4);return read_buf_no_offset(iDword);}float read_buf_float(uint iDword){return uintBitsToFloat(read_buf(iDword));}uint read_buf_uint8(uint iDword,uint iUint8){uint dwordOffset=iDword+(iUint8/4u);uint byteOffset=iUint8 & 3u;uint bitOffset=8u*byteOffset;uint mask=0xffu << bitOffset;uint dwordVal=read_buf(dwordOffset);return (dwordVal & mask) >> bitOffset;}uint read_buf_uint16(uint iDword,uint iUint16){uint dwordOffset=iDword+(iUint16 >> 1u);uint bitOffset=(iUint16 & 1u)*16u;uint mask=0xffffu << bitOffset;uint dwordVal=read_buf(dwordOffset);return (dwordVal & mask) >> bitOffset;}uint nrDwordsForVertexIdEntries(uint nrMaterialLookupEntries) {return nrMaterialLookupEntries;}uint nrDwordsForMaterialIdEntries(uint nrMaterialLookupEntries) {return (nrMaterialLookupEntries*2u+3u)/4u;}uint findRangeBinarySearch(uint vertexId,uint numRanges,uint dwordOffset) {uint left=0u;uint right=numRanges-1u;for (uint i=0u; i < 16u; i++) { 
if (left > right) {break;}uint mid=(left+right)/2u;uint start=read_buf(dwordOffset+mid);uint nextStart=(mid+1u < numRanges) ? read_buf(dwordOffset+mid+1u) : 0xffffffffu;if (vertexId >=start && vertexId < nextStart) {return mid;} else if (vertexId < start) {if (mid==0u) {break;}right=mid-1u;} else {left=mid+1u;}}return 0u; 
}uint readVertexId(uint dwordOffset,uint iMaterialLookupEntry) {return read_buf(dwordOffset+iMaterialLookupEntry);}uint findRange(uint vertexId,uint numRanges,uint dwordOffset) {uint iRange;if(numRanges <=64u){uint vertexBegin;for(iRange=0u; iRange < numRanges;++iRange) {vertexBegin=readVertexId(dwordOffset,iRange);if(vertexBegin > vertexId) {break;}}iRange=iRange==0u? 0u : iRange-1u;} else { 
iRange=findRangeBinarySearch(vertexId,numRanges,dwordOffset);}return iRange;}MaterialInfo read_material_info(uint vertex_id) {MaterialInfo info;
#if MATERIAL_TABLE_DEBUG
const vec4 red=vec4(1.0,0.0,0.0,1.0);const vec4 orange=vec4(1.0,0.5,0.0,1.0);const vec4 yellow=vec4(1.0,1.0,0.0,1.0);const vec4 green=vec4(0.0,1.0,0.0,1.0);const vec4 indigo=vec4(0.294,0.0,0.510,1.0);const vec4 blue=vec4(0.0,0.0,1.0,1.0);const vec4 purple=vec4(0.5,0.0,0.5,1.0);const vec4 pink=vec4(1.0,0.0,1.0,1.0);info.colorDebug=green;
#endif
uint offset=0u;
#if MATERIAL_TABLE_DEBUG
bool keepFinding=true;uint magic=read_buf(offset);if(magic !=0xCAFEBABEu) {info.colorDebug=red;keepFinding=false;return info;}
#endif
offset++;
#if MATERIAL_TABLE_DEBUG
uint nrMaterials=read_buf(offset);uint nrVertices=read_buf(offset+1u);if(keepFinding && vertex_id >=nrVertices) {info.colorDebug=red;keepFinding=false;}
#endif
offset+=2u;uint nrMaterialLookupEntries=read_buf(offset++);uint perMaterialEntrySizeDwords=read_buf(offset++);
#if MATERIAL_TABLE_DEBUG
if(keepFinding && perMaterialEntrySizeDwords !=1u) {info.colorDebug=red;keepFinding=false;}
#endif
uint iMaterialLookup=findRange(vertex_id,nrMaterialLookupEntries,offset);
#if MATERIAL_TABLE_DEBUG
if(keepFinding)
{uint vertexBeginCheck=readVertexId(offset,iMaterialLookup);if(vertexBeginCheck > vertex_id) {info.colorDebug=red;keepFinding=false;}if(iMaterialLookup < nrMaterialLookupEntries-1u) {uint vertexEndCheck=readVertexId(offset,iMaterialLookup+1u);if(vertexEndCheck <=vertex_id) {info.colorDebug=red;keepFinding=false;}}}
#endif
offset+=nrDwordsForVertexIdEntries(nrMaterialLookupEntries);uint materialId=iMaterialLookup;
#if MATERIAL_TABLE_DEBUG
if(keepFinding) {if(materialId >=nrMaterialLookupEntries) {info.colorDebug=red;}}
#endif
info.dataOffset=offset+materialId*perMaterialEntrySizeDwords;return info;}uint get_data_location(const MaterialInfo matInfo,uint attribOffsetBytes)
{uint attribFieldOffsetDwords=attribOffsetBytes/4u;return matInfo.dataOffset+attribFieldOffsetDwords;}vec4 read_material_vec4(const MaterialInfo matInfo,uint attribOffsetBytes){uint loc=get_data_location(matInfo,attribOffsetBytes);return vec4(read_buf_float(loc),read_buf_float(loc+1u),read_buf_float(loc+2u),read_buf_float(loc+3u));}vec2 read_material_vec2(const MaterialInfo matInfo,uint attribOffsetBytes){uint loc=get_data_location(matInfo,attribOffsetBytes);return vec2(read_buf_float(loc),read_buf_float(loc+1u));}float read_material_float(const MaterialInfo matInfo,uint attribOffsetBytes){uint loc=get_data_location(matInfo,attribOffsetBytes);return read_buf_float(loc);}
#define GET_ATTRIBUTE_float(attrib,matInfo,attrib_offset) read_material_float(matInfo,attrib_offset)
#define GET_ATTRIBUTE_vec4(attrib,matInfo,attrib_offset) read_material_vec4(matInfo,attrib_offset)
#define GET_ATTRIBUTE_vec2(attrib,matInfo,attrib_offset) read_material_vec2(matInfo,attrib_offset)
#define DECLARE_MATERIAL_TABLE_INFO MaterialInfo materialInfo=read_material_info(uint(gl_VertexID));
#define DECLARE_MATERIAL_TABLE_INFO_DEBUG(dbgColor) MaterialInfo materialInfo=read_material_info(uint(gl_VertexID)); dbgColor=materialInfo.colorDebug;
#endif`,"_prelude_fog.fragment.glsl":dt,"_prelude_shadow.fragment.glsl":Ap,"_prelude_lighting.glsl":`
#ifdef LIGHTING_3D_MODE
uniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}
#endif`,"_prelude_raster_array.glsl":Ip,"_prelude_raster_particle.glsl":od},ad={};Ai("",Do),Ai(dt,rd),Ai(Ap,sd),Ai(Ip,""),Ai(od,"");const xg=Ai(Tc,Ep),ld=bc,Ov=[`
#if defined(GL_EXT_blend_func_extended) && defined(DUAL_SOURCE_BLENDING)
#extension GL_EXT_blend_func_extended : require
#endif`,"precision mediump float;",ld,xg.fragmentSource].join(`
`),wg=["precision highp float;",ld,xg.vertexSource].join(`
`);var Pp={background:Ai(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec4 u_color;uniform float u_opacity;uniform mediump float u_emissive_strength;
#ifdef LIGHTING_3D_MODE
in vec4 v_color;
#endif
void main() {vec4 out_color;
#ifdef LIGHTING_3D_MODE
out_color=v_color;
#else
out_color=u_color;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef USE_MRT1
out_Target1=vec4(u_emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_lighting.glsl"
in vec2 a_pos;uniform mat4 u_matrix;uniform mediump float u_emissive_strength;
#ifdef LIGHTING_3D_MODE
uniform mediump vec4 u_color;out vec4 v_color;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef LIGHTING_3D_MODE
v_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),backgroundPattern:Ai(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in highp vec2 v_pos;void main() {highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef USE_MRT1
out_Target1=vec4(u_emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec2 u_pattern_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_pattern_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),building:Ai(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
const float window_depth=0.5;const float ao_radius=0.2;in vec4 v_color;in highp vec3 v_normal;in highp vec3 v_pos;
#ifdef BUILDING_FAUX_FACADE
in lowp float v_faux_facade;in highp float v_faux_facade_ed;in highp vec2 v_faux_facade_window;in highp vec2 v_faux_facade_floor;in highp vec2 v_faux_facade_range;in highp float v_aspect;in highp vec3 v_tbn_0;in highp vec3 v_tbn_1;in highp vec3 v_tbn_2;in highp vec4 v_faux_color_emissive;uniform float u_faux_facade_ao_intensity;
#endif
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;
#endif
#ifdef FLOOD_LIGHT
in highp float v_flood_radius;in float v_has_flood_light;
#endif
uniform lowp float u_opacity;uniform vec3 u_camera_pos;uniform highp float u_tile_to_meter;uniform float u_facade_emissive_chance;uniform vec3 u_flood_light_color;uniform float u_flood_light_intensity;vec3 linearTosRGB(in vec3 color) {return pow(color,vec3(1./2.2));}
#ifdef BUILDING_FAUX_FACADE
float hash12(in vec2 p) {vec3 p3 =fract(vec3(p.xyx)*0.1031);p3+=dot(p3,p3.yzx+33.33);return fract((p3.x+p3.y)*p3.z);}float min3(in vec3 v) {return min(min(v.x,v.y),v.z);}vec2 get_uv_mask_id(in vec2 q,out float mask,out vec2 id) {vec2 p=q;mask=step(v_faux_facade_range.x,p.y)*step(p.y,v_faux_facade_range.y);p.y=p.y-v_faux_facade_range.x;vec2 uv=modf(p/v_faux_facade_floor,id);vec4 d=(v_faux_facade_floor.xyxy+vec4(-v_faux_facade_window,v_faux_facade_window))*0.5;vec4 edge=d/v_faux_facade_floor.xyxy;vec2 m=step(edge.xy,uv)*step(uv,edge.zw);mask*=m.x*m.y;uv-=vec2(0.5);uv*=vec2(0.5)/(vec2(0.5)-edge.xy);uv+=vec2(0.5);return uv;}float ray_unit_box(in vec3 ray_o,in vec3 ray_d,in vec3 bmin,in vec3 bmax) {vec3 planes=mix(bmin,bmax,step(0.0,ray_d));vec3 t=(planes-ray_o)/ray_d;return min3(t);}float get_emissive(in vec2 id) {if (u_facade_emissive_chance > 0.0) {return (step(hash12(id),u_facade_emissive_chance)+0.05)*v_faux_color_emissive.a;}return 0.0;}vec3 get_shade_info(in vec3 v,in vec3 v_normalized,in vec3 color,in vec2 id,in mat3 tbn,inout vec3 out_normal,inout float out_emissive) {vec3 out_color=color;vec3 abs_v=abs(v_normalized);bool x_major=abs_v.x >=abs_v.y && abs_v.x >=abs_v.z;bool y_major=abs_v.y >=abs_v.x && abs_v.y >=abs_v.z;bool z_major=abs_v.z >=abs_v.x && abs_v.z >=abs_v.y;
#if 0
if (x_major) {out_color=v.x > 0.0 ? vec3(1.0,0.0,0.0) : vec3(0.0,1.0,1.0);} else if (y_major) {out_color=v.y > 0.0 ? vec3(0.0,1.0,0.0) : vec3(1.0,0.0,1.0);} else if (z_major) {out_color=v.z > 0.0 ? vec3(0.0,0.0,1.0) : vec3(1.0,1.0,0.0);}out_emissive=1.0;
#else
if (x_major) {out_normal=sign(v.x)*tbn[0];} else if (y_major) {out_normal=vec3(0.0,0.0,-sign(v.y));} else if (z_major) {out_color=v_faux_color_emissive.rgb;out_emissive=v.z <=0.0 ? get_emissive(id) : out_emissive;}float ao=1.0;if (u_faux_facade_ao_intensity > 0.0) {vec4 ao_range=v_faux_facade_window.xxyy*0.5-vec4(0,ao_radius,0,ao_radius);vec2 ao_range_z=vec2(window_depth*0.5)-vec2(0.0,ao_radius);if (x_major || y_major) {ao*=smoothstep(-ao_range_z.x,-ao_range_z.y,v.z);} else if (z_major) {ao*=smoothstep(-ao_range.x,-ao_range.y,v.x)*(1.0-smoothstep(ao_range.y,ao_range.x,v.x));ao*=smoothstep(-ao_range.z,-ao_range.w,v.y)*(1.0-smoothstep(ao_range.w,ao_range.z,v.y));}ao=mix(1.0,min(1.0,ao+0.25),u_faux_facade_ao_intensity);}out_color*=ao;
#endif
return out_color;}
#endif
vec3 apply_lighting_linear(in vec3 color,in vec3 normal,in float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return color*(ambient_contrib+directional_contrib);}void main() {vec3 normal=normalize(v_normal);vec3 base_color=v_color.rgb;float emissive=v_color.a;
#ifdef BUILDING_FAUX_FACADE
if (v_faux_facade > 0.0) {mat3 tbn=mat3(v_tbn_0,v_tbn_1,v_tbn_2);vec3 v=vec3(v_pos.xy,v_pos.z/u_tile_to_meter)-u_camera_pos;vec3 view_tangent=transpose(tbn)*v;vec2 q=vec2(v_faux_facade_ed,v_pos.z);float mask=0.0;vec2 id=vec2(0.0);vec2 uv=get_uv_mask_id(q,mask,id);uv*=v_faux_facade_window;vec3 bmin=vec3(0.0,0.0,-window_depth);vec3 bmax=bmin+vec3(v_faux_facade_window,window_depth);vec3 ray_o=vec3(uv,0.0);vec3 ray_d=normalize(view_tangent);float t_min=ray_unit_box(ray_o,ray_d,bmin,bmax);vec3 hit=ray_o+t_min*ray_d;vec3 r=vec3(v_faux_facade_window,-window_depth);hit-=r*0.5;vec3 normalized=hit/r;vec3 out_normal=normal;float out_emissive=emissive;vec3 room_color=get_shade_info(hit,normalized,base_color,id,tbn,out_normal,out_emissive);base_color=mix(base_color,room_color,mask);normal=mix(normal,out_normal,mask);emissive=mix(emissive,out_emissive,mask);}
#endif
vec4 color=vec4(base_color,1.0);vec3 xy_flipped_normal=vec3(-normal.xy,normal.z);float shadowed_lighting_factor=0.0;
#ifdef RENDER_SHADOWS
#ifdef RENDER_CUTOFF
shadowed_lighting_factor=shadowed_light_factor_normal_opacity(xy_flipped_normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}
#else
shadowed_lighting_factor=shadowed_light_factor_normal(xy_flipped_normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);
#endif
#else
shadowed_lighting_factor=dot(xy_flipped_normal,u_lighting_directional_dir);
#endif
color.rgb=apply_lighting_linear(color.rgb,xy_flipped_normal,shadowed_lighting_factor);color.rgb=linearTosRGB(color.rgb);
#ifdef FLOOD_LIGHT
float flood_radiance=(1.0-min(v_pos.z/v_flood_radius,1.0))*u_flood_light_intensity*v_has_flood_light;color.rgb=mix(color.rgb,u_flood_light_color,flood_radiance);
#endif
color.rgb=mix(color.rgb,linearTosRGB(base_color.rgb),emissive);
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,v_pos.z));
#endif
color*=u_opacity;
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,v_pos.z);
#endif
#ifdef FEATURE_CUTOUT
color=apply_feature_cutout(color,gl_FragCoord);
#endif
glFragColor=color; 
#ifdef DEBUG_SHOW_NORMALS
color.rgb=xy_flipped_normal*0.5+vec3(0.5,0.5,0.5);color.a=1.0;glFragColor=color;
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;in vec3 a_normal_3;in vec3 a_centroid_3;in float a_flood_light_wall_radius_1i16;in vec4 a_faux_facade_data;in vec2 a_faux_facade_vertical_range;uniform mat4 u_matrix;uniform mat4 u_normal_matrix;uniform highp float u_tile_to_meter;out vec4 v_color;out vec3 v_normal;out highp vec3 v_pos;
#ifdef BUILDING_FAUX_FACADE
out lowp float v_faux_facade;out highp float v_faux_facade_ed;out highp vec2 v_faux_facade_window;out highp vec2 v_faux_facade_floor;out highp vec2 v_faux_facade_range;out highp float v_aspect;out highp vec3 v_tbn_0;out highp vec3 v_tbn_1;out highp vec3 v_tbn_2;out highp vec4 v_faux_color_emissive;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;
#endif
#ifdef FLOOD_LIGHT
out highp float v_flood_radius;out float v_has_flood_light;
#endif
const float MAX_UINT_16=65535.0;const float MAX_INT_16=32767.0;const float MAX_UINT_8=255.0;const float TWO_POW_8=256.0;const float FLOOD_LIGHT_MAX_RADIUS_METER=2048.0;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}
#ifdef BUILDING_FAUX_FACADE
mat3 get_tbn(in vec3 normal) {const vec3 bitangent=vec3(0.0,0.0,1.0);vec3 tangent=normalize(vec3(normal.y,-normal.x,0.0));return mat3(tangent,bitangent,normal);}
#endif
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 faux_facade_color_emissive
void main() {
#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive
#pragma mapbox: initialize-attribute-custom highp vec2 faux_facade_color_emissive
#ifdef FLOOD_LIGHT
v_flood_radius=(a_flood_light_wall_radius_1i16/MAX_INT_16*FLOOD_LIGHT_MAX_RADIUS_METER);v_has_flood_light=step(0.0,v_flood_radius);
#endif
vec4 color_emissive=decode_color(part_color_emissive);v_color=vec4(sRGBToLinear(color_emissive.rgb),color_emissive.a);vec3 a_normal_3f=a_normal_3/MAX_INT_16;v_normal=vec3(u_normal_matrix*vec4(a_normal_3f,0.0));float hidden=0.0;float depth_offset=0.0;
#ifdef BUILDING_FAUX_FACADE
v_faux_facade=a_faux_facade_data.x;if (v_faux_facade > 0.0) {v_faux_facade_ed=a_faux_facade_data.x *u_tile_to_meter;float window_x_perc=floor(a_faux_facade_data.y/TWO_POW_8);float window_y_perc=a_faux_facade_data.y-TWO_POW_8*window_x_perc;vec2 window_perc=vec2(window_x_perc,window_y_perc)/MAX_UINT_8;v_faux_facade_floor=(a_faux_facade_data.zw/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_faux_facade_window=window_perc*v_faux_facade_floor;v_faux_facade_range=(a_faux_facade_vertical_range/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_aspect=v_faux_facade_window.x/v_faux_facade_window.y;mat3 tbn=get_tbn(normalize(v_normal));v_tbn_0=tbn[0];v_tbn_1=tbn[1];v_tbn_2=tbn[2];v_faux_color_emissive=decode_color(faux_facade_color_emissive);v_faux_color_emissive.rgb=sRGBToLinear(v_faux_color_emissive.rgb);float height=a_centroid_3.z;depth_offset=min(1000.0,height)*0.0000002;}
#endif
v_pos=a_pos_3f;
#ifdef RENDER_CUTOFF
vec4 ground=u_matrix*vec4(a_centroid_3,1.0);v_cutoff_opacity=cutoff_opacity(u_cutoff_params,ground.z);hidden=float(v_cutoff_opacity==0.0);v_pos.z*=v_cutoff_opacity;
#endif
#ifdef RENDER_SHADOWS
vec3 shadow_pos=v_pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset_model(v_normal);shadow_pos+=offset*shadow_normal_offset_multiplier0();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shadow_pos,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(shadow_pos,1.0);
#endif
#ifdef FOG
v_fog_pos=fog_position(v_pos);
#endif
gl_Position=mix(u_matrix*vec4(v_pos,1),AWAY,hidden);gl_Position.z-=depth_offset*gl_Position.w;}`),buildingBloom:Ai(`in vec4 v_color_emissive;
#pragma mapbox: define-attribute highp vec4 bloom_attenuation
#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation
float saturate(float val) {return clamp(val,0.0,1.0);}void main() {float emission=v_color_emissive.a;float opacity=1.0;
#ifdef HAS_ATTRIBUTE_a_bloom_attenuation
float distance=length(vec2(1.3*max(0.0,abs(bloom_attenuation.x)-bloom_attenuation.z),bloom_attenuation.y));distance+= mix(0.5,0.0,clamp(emission-1.0,0.0,1.0));opacity*=saturate(1.0-distance*distance);
#endif
#ifdef RENDER_CUTOFF
opacity*=v_cutoff_opacity;
#endif
glFragColor=vec4(v_color_emissive.rgb,1.0)*opacity;}`,`in vec3 a_pos_3f;
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive
#pragma mapbox: define-attribute highp vec4 bloom_attenuation
out vec4 v_color_emissive;uniform mat4 u_matrix;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive
#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation
#ifdef HAS_ATTRIBUTE_a_part_color_emissive
vec4 color_emissive=decode_color(part_color_emissive);float part_emissive=color_emissive.a*5.0;v_color_emissive=vec4(sRGBToLinear(color_emissive.rgb),part_emissive);
#else
v_color_emissive=vec4(1.0);
#endif
gl_Position=u_matrix*vec4(a_pos_3f,1.0);
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
}`),buildingDepth:Ai(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,"in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;void main() {gl_Position=u_matrix*vec4(a_pos_3f,1.0);v_depth=gl_Position.z/gl_Position.w;}"),circle:Ai(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec3 v_data;in float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
uniform float u_emissive_strength;void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float blur_positive=blur < 0.0 ? 0.0 : 1.0;lowp float antialiasblur=v_data.z;float extrude_length=length(extrude)+antialiasblur*(1.0-blur_positive);float antialiased_blur=-max(abs(blur),antialiasblur);float antialiase_blur_opacity=smoothstep(0.0,antialiasblur,extrude_length-1.0);float opacity_t=blur_positive==1.0 ? 
smoothstep(0.0,-antialiased_blur,1.0-extrude_length) : 
smoothstep(antialiased_blur,0.0,extrude_length-1.0)-antialiase_blur_opacity;float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(
antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)
);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_apply_premultiplied(out_color,v_fog_pos);
#endif
glFragColor=out_color*(v_visibility*opacity_t);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define NUM_VISIBILITY_RINGS 2
#define INV_SQRT2 0.70710678
#define ELEVATION_BIAS 0.0001
#define NUM_SAMPLES_PER_RING 16
uniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
#ifdef ELEVATED_ROADS
in float a_circle_z_offset;
#endif
out vec3 v_data;out float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
vec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {
#if defined(TERRAIN)
return elevation(pos)+ELEVATION_BIAS;
#else
return 0.0;
#endif
}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);
#ifdef PITCH_WITH_MAP
#ifdef PROJECTION_GLOBE_VIEW
return u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );
#else
return u_matrix*( world_center+vec4(sample_offset,0,0) );
#endif
#else
return projected_center+vec4(sample_offset,0,0);
#endif
}float get_sample_step() {
#ifdef PITCH_WITH_MAP
return 2.0*PI/float(NUM_SAMPLES_PER_RING);
#else
return PI/float(NUM_SAMPLES_PER_RING);
#endif
}void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);
#else 
surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);
#endif
#ifdef ELEVATED_ROADS
world_center.z+=a_circle_z_offset+ELEVATION_BIAS;
#endif
vec4 projected_center=u_matrix*world_center;float view_scale=0.0;
#ifdef PITCH_WITH_MAP
#ifdef SCALE_WITH_MAP
view_scale=1.0;
#else
view_scale=projected_center.w/u_camera_to_center_distance;
#endif
#else
#ifdef SCALE_WITH_MAP
view_scale=u_camera_to_center_distance;
#else
view_scale=projected_center.w;
#endif
#endif
gl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;
#ifdef TERRAIN
float step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;
#ifdef PITCH_WITH_MAP
float cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;
#else
occlusion_world_center=world_center;occlusion_projected_center=projected_center;
#endif
for(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);
#else
visibility=1.0;
#endif
#ifdef PROJECTION_GLOBE_VIEW
visibility=1.0;
#endif
v_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);
#ifdef FOG
v_fog_pos=fog_position(world_center.xyz);
#endif
}`),clippingMask:Ai("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:Ai(`#include "_prelude_fog.fragment.glsl"
uniform highp float u_intensity;in vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);
#ifdef FOG
if (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
out vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#else
pos=vec3(tilePos+extrude,elevation(tilePos));
#endif
gl_Position=u_matrix*vec4(pos,1);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),heatmapTexture:Ai(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(0.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,"in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:Ai("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",`#include "_prelude_terrain.vertex.glsl"
in vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in vec2 a_elevation_from_sea;in float a_size_scale;in vec2 a_padding;in float a_auto_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform float u_zoom_transition;
#endif
out float v_placed;out float v_notUsed;void main() {float feature_elevation=a_elevation_from_sea.x+a_auto_z_offset;float terrain_elevation=(a_elevation_from_sea.y==1.0 ? 0.0 : elevation(a_anchor_pos));vec3 proj_pos=a_pos+elevationVector(a_anchor_pos)*(feature_elevation+terrain_elevation);
#ifdef PROJECTION_GLOBE_VIEW
#ifndef PROJECTED_POS_ON_VIEWPORT
vec3 globe_pos=proj_pos;vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,a_anchor_pos,u_tile_id,u_merc_center);proj_pos=mix_globe_mercator(globe_pos,mercator_pos,u_zoom_transition);
#endif
#endif
vec4 projectedPoint=u_matrix*vec4(proj_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}`),collisionCircle:Ai("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}",`in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(
mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}`),debug:Ai("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",`#include "_prelude_terrain.vertex.glsl"
in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;
#endif
out vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
gl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);
#else
gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);
#endif
}`),elevatedStructuresDepth:Ai(`void main() {
#ifndef DEPTH_TEXTURE
glFragColor=vec4(0.);
#endif
}`,"in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform float u_depth_bias;void main() {gl_Position=u_matrix*vec4(a_pos,a_height,1);gl_Position.z=gl_Position.z+u_depth_bias;}"),elevatedStructuresDepthReconstruct:Ai(`#ifdef DEPTH_RECONSTRUCTION
in float v_height;
#endif
void main() {
#ifdef DEPTH_RECONSTRUCTION
if (v_height >=0.0)
discard;
#else
#ifdef FEATURE_CUTOUT
apply_feature_cutout(vec4(0.0,0.0,0.0,1.0),gl_FragCoord);
#endif
#endif
glFragColor=vec4(1.0,0.0,0.0,1.0);}`,`in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform vec3 u_camera_pos;uniform highp float u_depth_bias;uniform lowp float u_height_scale;uniform lowp float u_reset_depth;
#ifdef DEPTH_RECONSTRUCTION
out float v_height;
#endif
void main() {vec3 vpos=vec3(a_pos,a_height*u_height_scale);
#ifdef DEPTH_RECONSTRUCTION
if (u_camera_pos.z > vpos.z) {vpos-=(u_camera_pos-vpos)*(vpos.z/(u_camera_pos.z-vpos.z));}v_height=a_height;
#endif
gl_Position=u_matrix*vec4(vpos,1);gl_Position.z=u_reset_depth==1.0 ? gl_Position.w : gl_Position.z+u_depth_bias;}`),elevatedStructures:Ai(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in vec3 v_normal;in float v_height;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth;
#endif
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}vec3 compute_view_dependent_emissive_color(float ndotl,float emissive_strength,vec3 color)
{color=sRGBToLinear(color);color=color*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);color=linearTosRGB(color.rgb);return color;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 structure_color
void main() {
#pragma mapbox: initialize highp vec4 structure_color
vec3 color=structure_color.xyz;
#ifdef LIGHTING_3D_MODE
vec3 normal=normalize(v_normal);vec3 transformed_normal=vec3(-normal.xy,normal.z);float ndotl=calculate_NdotL(transformed_normal);float emissive_strength=u_emissive_strength;emissive_strength=0.0;vec3 emissive_color=compute_view_dependent_emissive_color(ndotl,emissive_strength,color.xyz);
#ifdef RENDER_SHADOWS
float shadowed_lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color.rgb=apply_lighting(color.rgb,transformed_normal,shadowed_lighting_factor);
#else
color=apply_lighting(color,transformed_normal);
#endif
color=mix(color,emissive_color,emissive_strength);if (v_height < 0.0) {float penetration=max(v_height+7.5,0.0);float occlusion=1.0-1.0/PI*acos(1.0-penetration/4.0);color=color*(1.0-pow(occlusion,2.0)*0.3);}
#endif
#ifdef FOG
color=fog_apply(color,v_fog_pos);
#endif
vec4 out_color=vec4(color,1.0);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_height);
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;in float a_height;in vec3 a_pos_normal_3;uniform mat4 u_matrix;out vec3 v_normal;out float v_height;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth;
#endif
#pragma mapbox: define highp vec4 structure_color
void main() {
#pragma mapbox: initialize highp vec4 structure_color
v_normal=a_pos_normal_3/16384.0;v_height=a_height;vec3 pos=vec3(a_pos,a_height);gl_Position=u_matrix*vec4(pos,1);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(-v_normal.xy,v_normal.z));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fill:Ai(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
vec4 out_color=color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=opacity;
#ifdef INDICATOR_CUTOUT
if (v_z_offset >=0.0) {out_color=applyCutout(out_color,v_z_offset);}
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;
#ifdef USE_MRT1
out_Target1=vec4(u_emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;v_road_z_offset=z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=z_offset;
#endif
}`),fillOutline:Ai(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef USE_MRT1
out_Target1=vec4(u_emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
uniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);
#ifdef FLIP_Y
v_pos=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;
#else
v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#endif
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutlinePattern:Ai(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
uniform float u_emissive_strength;
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
in highp vec2 v_pos;in highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef APPLY_LUT_ON_GPU
out_color=applyLUT(u_lutTexture,out_color);
#endif
#ifdef FILL_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef USE_MRT1
out_Target1=vec4(u_emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;out highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef FLIP_Y
v_pos_world=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;
#else
v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#endif
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillPattern:Ai(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef APPLY_LUT_ON_GPU
out_color=applyLUT(u_lutTexture,out_color);
#endif
#ifdef FILL_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
out_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*opacity;
#ifdef USE_MRT1
out_Target1=vec4(u_emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;v_road_z_offset=z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillExtrusion:Ai(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec4 v_color;in vec4 v_flat;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;
#endif
uniform lowp float u_opacity;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec2 v_ao;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
in vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
in highp vec3 v_normal;
#endif
uniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
in float v_flood_radius;in float v_has_floodlight;
#endif
in float v_height;
#pragma mapbox: define highp float emissive_strength
void main() {
#pragma mapbox: initialize highp float emissive_strength
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
vec3 normal=normalize(v_normal);
#endif
float z;vec4 color=v_color;
#ifdef ZERO_ROOF_RADIUS
z=float(normal.z > 0.00001);
#ifdef LIGHTING_3D_MODE
normal=mix(normal,vec3(0.0,0.0,1.0),z);
#else
color=mix(v_color,v_roof_color,z);
#endif
#endif
float h=max(0.0,v_height);float ao_shade=1.0;
#ifdef FAUX_AO
float intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;
#ifdef ZERO_ROOF_RADIUS
concave*=(1.0-z);
#endif
float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
color.rgb*=mix(ao_shade,1.0,v_has_floodlight);
#else
color.rgb*=ao_shade;
#endif
#else
color.rgb*=ao_shade;
#endif
#endif
#ifdef LIGHTING_3D_MODE
float flood_radiance=0.0;
#ifdef FLOOD_LIGHT
flood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;
#endif
#ifdef RENDER_SHADOWS
#ifdef FLOOD_LIGHT
float ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);
#else
float shadowed_lighting_factor;
#ifdef RENDER_CUTOFF
shadowed_lighting_factor=shadowed_light_factor_normal_opacity(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}
#else
shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);
#endif
color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);
#endif
#else
color.rgb=apply_lighting(color.rgb,normal);
#ifdef FLOOD_LIGHT
color.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);
#endif
#endif
color.rgb=mix(color.rgb,v_flat.rgb,emissive_strength);color*=u_opacity;
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));
#endif
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,h);
#endif
#ifdef FEATURE_CUTOUT
color=apply_feature_cutout(color,gl_FragCoord);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_material_table.vertex.glsl"
uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;uniform float u_width_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
uniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
out vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
out highp vec3 v_normal;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec2 v_ao;
#endif
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
out float v_flood_radius;out float v_has_floodlight;
#endif
out float v_height;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define highp float flood_light_wall_radius
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp float emissive_strength
void main() {DECLARE_MATERIAL_TABLE_INFO
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize highp float flood_light_wall_radius
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp float emissive_strength
base*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
v_normal=normal;
#endif
base=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
h=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float cutoff=1.0;vec3 scaled_pos=pos;
#ifdef RENDER_CUTOFF
vec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);
#ifdef CLIP_ZERO_TO_ONE
cutoff=cutoff_opacity(u_cutoff_params,ground.z*2.0-ground.w);
#else
cutoff=cutoff_opacity(u_cutoff_params,ground.z);
#endif
if (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;v_cutoff_opacity=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff==0.0 && centroid_pos.x !=0.0) || (color.a==0.0));
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);scaled_pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;scaled_pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
gl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);
#endif
float NdotL=0.0;float colorvalue=0.0;
#ifndef LIGHTING_3D_MODE
colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#endif
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
float is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;
#endif
v_color=vec4(color.rgb,1.0);float ndotl=calculate_NdotL(normal);v_flat.rgb=sRGBToLinear(color.rgb);v_flat.rgb=v_flat.rgb*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);v_flat=vec4(linearTosRGB(v_flat.rgb),1.0);
#else
v_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
float roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),fillExtrusionDepth:Ai(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_material_table.vertex.glsl"
uniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_width_scale;uniform float u_vertical_scale;
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp vec4 color
out highp float v_depth;void main() {DECLARE_MATERIAL_TABLE_INFO
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp vec4 color
base*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;float ele=elevation(pos_nx.xy);float c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);float h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
pos=vec3(pos_nx.xy,t > 0.0 ? height : base);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}`),fillExtrusionPattern:Ai(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
in vec3 v_normal;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
in highp vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define highp float pixel_ratio
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize highp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef APPLY_LUT_ON_GPU
out_color=applyLUT(u_lutTexture,out_color);
#endif
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;
#else
out_color=out_color*v_lighting;
#endif
#ifdef FAUX_AO
float intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,height);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_material_table.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_width_scale;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
out highp vec2 v_pos;out vec4 v_lighting;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
out vec3 v_normal;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define highp float pixel_ratio
#pragma mapbox: define highp float line_width
void main() {DECLARE_MATERIAL_TABLE_INFO
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize highp float pixel_ratio
#pragma mapbox: initialize highp float line_width
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=z;vec3 p;float c_ele;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;p=vec3(pos_nx.xy,h);
#else
p=vec3(pos_nx.xy,z);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);p.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;p.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0
? pos_nx.xy
: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;
#ifdef LIGHTING_3D_MODE
NdotL=calculate_NdotL(normal);
#else
NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);
#endif
if (normal.y !=0.0) {float r=0.84;
#ifndef LIGHTING_3D_MODE
r=mix(0.7,0.98,1.0-u_lightintensity);
#endif
NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
v_normal=normal;
#else
v_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(p);
#endif
}`),groundShadow:Ai(`#include "_prelude_shadow.fragment.glsl"
precision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#ifdef FOG
in float v_fog_opacity;
#endif
void main() {float light=shadowed_light_factor_plane_bias(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);
#ifdef RENDER_CUTOFF
shadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));
#endif
#ifdef FOG
shadow=mix(shadow,vec3(1.0),v_fog_opacity);
#endif
#ifdef INDICATOR_CUTOUT
shadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0),0.0).r);
#endif
glFragColor=vec4(shadow,1.0);}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#ifdef FOG
out float v_fog_opacity;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);
#ifdef FOG
v_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);
#endif
}`),fillExtrusionGroundEffect:Ai(`uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;
#ifdef SDF_SUBPASS
in highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}
#ifdef FOG
in highp float v_fog;
#endif
#endif
void main() {
#ifdef CLEAR_SUBPASS
vec4 color=vec4(1.0);
#ifdef CLEAR_FROM_TEXTURE
color=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));
#endif
glFragColor=color;
#else
#ifdef SDF_SUBPASS
highp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;
#ifdef FOG
fog=v_fog;
#endif
#ifdef RENDER_CUTOFF
fog*=v_cutoff_opacity;
#endif
glFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));
#else
#ifdef USE_MRT1
out_Target1=vec4(1.0-texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size)).a,0.0,0.0,0.0);
#else
vec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);
#ifdef OVERDRAW_INSPECTOR
color=vec4(1.0);
#endif
glFragColor=color;
#endif
#endif
HANDLE_WIREFRAME_DEBUG;
#endif
}`,`#include "_prelude_fog.vertex.glsl"
in highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;
#ifdef SDF_SUBPASS
out highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;
#ifdef FOG
out highp float v_fog;
#endif
#endif
uniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp float u_dynamic_offset;uniform highp vec2 u_ao;
#pragma mapbox: define highp float flood_light_ground_radius
const float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {
#pragma mapbox: initialize highp float flood_light_ground_radius
vec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(u_dynamic_offset,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;
#ifdef SDF_SUBPASS
v_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);
#ifdef FOG
v_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);
#endif
#endif
float hidden_by_landmark=0.0;
#ifdef HAS_CENTROID
hidden_by_landmark=a_hidden_by_landmark;
#endif
float isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
}`),hillshadePrepare:Ai(`precision highp float;uniform highp sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(
(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)
)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(
deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:Ai(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef LIGHTING_3D_MODE
glFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);
#endif
#ifdef FOG
glFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));
#endif
#ifdef USE_MRT1
out_Target1=vec4(u_emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),line:Ai(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform lowp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_floor_width_scale;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec3 v_uv;
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform sampler2D u_dash_image;in vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform sampler2D u_gradient_image;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
float luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float side_z_offset
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
#pragma mapbox: define lowp float emissive_strength
float linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float side_z_offset
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
#pragma mapbox: initialize lowp float emissive_strength
float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);alpha=side_z_offset > 0.0 ? 1.0-alpha : alpha;
#ifdef RENDER_LINE_DASH
float sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;float scaled_floorwidth=(floorwidth*u_floor_width_scale);alpha*=linearstep(0.5-sdfgamma/scaled_floorwidth,0.5+sdfgamma/scaled_floorwidth,sdfdist);
#endif
highp vec4 out_color;
#ifdef RENDER_LINE_GRADIENT
out_color=texture(u_gradient_image,v_uv.xy);
#ifdef MULTIPLY_LINE_GRADIENT_COLOR
out_color*=color;
#endif
#else
out_color=color;
#endif
float trim_alpha=1.0;
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);out_color=mix(out_color,u_trim_color,transition_factor);trim_alpha=1.0-transition_factor;}
#endif
if (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}
#ifdef RENDER_LINE_BORDER
float edgeBlur=((border_width*u_width_scale)+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color=mix(border_color*trim_alpha,out_color,smoothAlpha);}}
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
out_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=(alpha*opacity);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;
#ifdef DUAL_SOURCE_BLENDING
glFragColorSrc1=vec4(vec3(0.0),emissive_strength);
#else
#ifdef USE_MRT1
out_Target1=vec4(emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);
#endif
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define EXTRUDE_SCALE 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS) || defined(VARIABLE_LINE_WIDTH)
in vec3 a_z_offset_width;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
in highp vec3 a_packed;
#endif
#ifdef RENDER_LINE_DASH
in float a_linesofar;
#endif
uniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;uniform float u_width_scale;uniform highp float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec3 v_uv;
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform float u_image_height;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define mediump float side_z_offset
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize mediump float side_z_offset
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
#pragma mapbox: initialize lowp float emissive_strength
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth;
#ifdef VARIABLE_LINE_WIDTH
bool left=normal.y==1.0;halfwidth=(u_width_scale*(left ? a_z_offset_width.y : a_z_offset_width.z))/2.0;a_z_offset+=left ? side_z_offset : 0.0;v_normal=side_z_offset > 0.0 && left ? vec2(0.0) : v_normal;
#else
halfwidth=(u_width_scale*width)/2.0;
#endif
offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float epsilon=0.0001;float extrude_length_without_perspective=max(length(dist),epsilon);float extrude_length_with_perspective=max(length(projected_extrude_xy/gl_Position.w*u_units_to_pixels),epsilon);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
highp float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float line_progress=a_packed[2];
#ifdef RENDER_LINE_GRADIENT
highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec3(a_uv_x,a_split_index*texel_height-half_texel_height,line_progress);
#else
v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
#endif
#ifdef RENDER_LINE_DASH
float scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/(floorwidth*u_floor_width_scale),(-normal.y*height+dash.x+0.5)/u_texsize.y);
#endif
v_width2=vec2(outset,inset);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),linePattern:Ai(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform highp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;uniform sampler2D u_image;
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef LINE_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
in vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef LINE_JOIN_NONE
in vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#pragma mapbox: define mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define mediump float pixel_ratio
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize mediump float pixel_ratio
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
#pragma mapbox: initialize lowp float emissive_strength
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;highp float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;highp float x=mod(pattern_x,1.0);highp float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;highp vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));highp vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);
#ifdef APPLY_LUT_ON_GPU
color=applyLUT(u_lutTexture,color);
#endif
#ifdef LINE_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl*texel_size-texel_size,pattern_b_br*texel_size+texel_size,vec2(x,y));vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);color=color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);color=mix(color,color.a*u_trim_color,transition_factor);}
#endif
#ifdef LINE_JOIN_NONE
highp float pattern_len=pattern_size/aspect;highp float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);highp float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;highp float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}
#endif
#ifdef LIGHTING_3D_MODE
color=apply_lighting_with_emission_ground(color,emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,v_z_offset);
#endif
glFragColor=color;
#ifdef DUAL_SOURCE_BLENDING
glFragColorSrc1=vec4(vec3(0.0),emissive_strength);
#else
#ifdef USE_MRT1
out_Target1=vec4(emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);
#endif
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
in vec3 a_z_offset_width;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 a_packed;
#endif
in highp float a_linesofar;
#ifdef LINE_JOIN_NONE
in highp vec3 a_pattern_data;out vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;uniform float u_width_scale;uniform float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
out highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
#pragma mapbox: define mediump float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define mediump float floorwidth
#pragma mapbox: define mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define mediump float pixel_ratio
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
#pragma mapbox: initialize mediump float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize mediump float floorwidth
#pragma mapbox: initialize mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize mediump float pixel_ratio
#pragma mapbox: initialize lowp float emissive_strength
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=(u_width_scale*width)/2.0;offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float a_uv_x=a_packed[0];highp float line_progress=a_packed[2];v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=(floorwidth*u_floor_width_scale);
#ifdef LINE_JOIN_NONE
v_width=(floorwidth*u_floor_width_scale)+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),raster:Ai(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_raster_array.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
in float v_split_fade;
#endif
uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;
#ifndef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;
#endif
#ifdef RASTER_COLOR
uniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;
#endif
void main() {vec4 color0,color1,color;vec2 value;
#ifdef RASTER_COLOR
#ifdef RASTER_ARRAY
#ifdef RASTER_ARRAY_LINEAR
value=mix(
raTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#else
value=mix(
raTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#endif
if (value.y > 0.0) value.x/=value.y;
#else
color=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);
#endif
color=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;
#else
color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);
#endif
color.a*=u_opacity;
#ifdef GLOBE_POLES
color.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);
#endif
vec3 rgb=color.rgb;rgb=vec3(
dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef PROJECTION_GLOBE_VIEW
glFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));
#endif
#ifdef RENDER_CUTOFF
glFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
#ifdef USE_MRT1
out_Target1=vec4(u_emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;in vec2 a_texture_pos;
#endif
out vec2 v_pos0;out vec2 v_pos1;out float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
out float v_split_fade;
#endif
void main() {vec2 uv;
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);
#endif
#else
float w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    
v_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;
#ifdef RENDER_CUTOFF
v_depth=gl_Position.z;
#endif
}`),rasterParticle:Ai(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),1.0).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
uv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}`),rasterParticleDraw:Ai("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",`#include "_prelude_raster_particle.glsl"
in float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(
mod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-1.0,0,1);v_particle_speed=length(velocity);}gl_PointSize=1.0;}`),rasterParticleTexture:Ai("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:Ai(`#include "_prelude_raster_particle.glsl"
uniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;vec2 linearstep(vec2 edge0,vec2 edge1,vec2 x) {return  clamp((x-edge0)/(edge1-edge0),vec2(0),vec2(1));}const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp vec2 persist_rate=pow(
linearstep(vec2(-u_particle_pos_offset),vec2(0),pos)*linearstep(vec2(1.0+u_particle_pos_offset),vec2(1),pos),vec2(4)
);highp vec2 per_frame_persist=pow(persist_rate,abs(dp)/u_particle_pos_offset);highp float drop_rate=1.0-per_frame_persist.x*per_frame_persist.y;drop_rate=any(greaterThanEqual(abs(pos-0.5),vec2(0.5+u_particle_pos_offset))) ? 1.0 : drop_rate;highp float drop=step(1.0-drop_rate-u_reset_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}`,"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbol:Ai(`#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;uniform lowp float u_scale_factor;
#ifdef ICON_TRANSITION
uniform float u_icon_transition;
#endif
#ifdef COLOR_ADJUSTMENT
uniform mat4 u_color_adj_mat;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#else
#ifdef RENDER_SHADOWS
in highp float v_z_offset;
#endif
#endif
in vec2 v_tex_a;
#ifdef ICON_TRANSITION
in vec2 v_tex_b;
#endif
in float v_draw_halo;in vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
in float is_sdf;in vec2 v_tex_a_icon;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
vec4 out_color;float fade_opacity=v_gamma_scale_size_fade_opacity[2];
#ifdef RENDER_TEXT_AND_SYMBOL
if (is_sdf==ICON) {vec2 tex_icon=v_tex_a_icon;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
return;}
#endif
#ifdef RENDER_SDF
float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_gamma_scale_size_fade_opacity.x;float size=v_gamma_scale_size_fade_opacity.y;float fontScale=u_is_text ? size/24.0 : size;out_color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {out_color=halo_color;gamma=(halo_blur*u_scale_factor*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width*u_scale_factor/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,v_tex_a).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);out_color*=alpha;
#else
#ifdef ICON_TRANSITION
vec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);
#else
out_color=texture(u_texture,v_tex_a);
#endif
#ifdef APPLY_LUT_ON_GPU
out_color=applyLUT(u_lutTexture,out_color);
#endif
#ifdef COLOR_ADJUSTMENT
out_color=u_color_adj_mat*out_color;
#endif
#endif
out_color*=opacity*fade_opacity;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef TERRAIN
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#else
out_color.rgb*=mix(v_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#endif
#endif
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#define APPEARANCE_ICON 1.0
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef Z_OFFSET
in float a_auto_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
#ifdef ICON_TRANSITION
in vec2 a_texb;
#endif
#ifdef OCCLUSION_QUERIES
in float a_occlusion_query_opacity;
#endif
#ifdef ELEVATED_ROADS
in vec3 a_x_axis;in vec3 a_y_axis;uniform float u_normal_scale;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#else
#ifdef RENDER_SHADOWS
out highp float v_z_offset;
#endif
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_elevation_from_sea;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out vec2 v_tex_a;
#ifdef ICON_TRANSITION
out vec2 v_tex_b;
#endif
out float v_draw_halo;out vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
out float is_sdf;out vec2 v_tex_a_icon;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
#pragma mapbox: define lowp float occlusion_opacity
#pragma mapbox: define lowp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
#pragma mapbox: initialize lowp float occlusion_opacity
#pragma mapbox: initialize lowp float z_offset
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float a_size_max= floor(a_size[1]*0.5);float a_apperance_icon=a_size[1]-2.0*a_size_max;vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (a_apperance_icon==APPEARANCE_ICON) {size=a_size_max/128.0;} else if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size_max,u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=u_elevation_from_sea ? z_offset : z_offset+elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_auto_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;
#else
offsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;
#endif
vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
#ifdef PROJECTED_POS_ON_VIEWPORT
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xyz+h,1.0);
#else
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz,mercator_pos,u_zoom_transition)+h;projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);    
#endif
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
#ifdef Z_OFFSET
z+=u_pitch_with_map ? a_auto_z_offset+z_offset : 0.0;
#else
z+=u_pitch_with_map ? z_offset : 0.0;
#endif
float occlusion_fade=globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));
#ifdef DEPTH_OCCLUSION
float depth_occlusion=occlusionFadeMultiSample(projected_point);float depth_occlusion_multplier=mix(occlusion_opacity,1.0,depth_occlusion);out_fade_opacity*=depth_occlusion_multplier;
#endif
#ifdef OCCLUSION_QUERIES
float occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;
#endif
#ifdef Z_TEST_OCCLUSION
out_fade_opacity*=occlusion_opacity;
#endif
float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;
#else
#ifdef ELEVATED_ROADS
vec3 xAxis=vec3(a_x_axis.xy,a_x_axis.z*u_normal_scale);vec3 yAxis=vec3(a_y_axis.xy,a_y_axis.z*u_normal_scale);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;
#else
pos=vec3(projected_pos.xy/projected_pos.w+offset,z);
#endif
#endif
gl_Position=mix(u_coord_matrix*vec4(pos,1.0),AWAY,hidden);float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_gamma_scale_size_fade_opacity=vec3(gamma_scale,size,out_fade_opacity);v_tex_a=a_tex/u_texsize;
#ifdef RENDER_TEXT_AND_SYMBOL
is_sdf=a_size[0]-2.0*a_size_min;v_tex_a_icon=a_tex/u_texsize_icon;
#endif
#ifdef ICON_TRANSITION
v_tex_b=a_texb/u_texsize;
#endif
#ifdef RENDER_SHADOWS
vec4 shd_pos=u_inv_matrix*vec4(pos,1.0);vec3 shd_pos0=shd_pos.xyz;vec3 shd_pos1=shd_pos.xyz;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=e;
#else
#ifdef RENDER_SHADOWS
v_z_offset=e;
#endif
#endif
}`),terrainRaster:Ai(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
uniform sampler2D u_image1;uniform float u_emissive_texture_available;
#endif
in vec2 v_pos0;
#ifdef FOG
in float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#endif
uniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;
#ifdef LIGHTING_3D_MODE
const vec3 normal=vec3(0.0,0.0,1.0);
#ifdef RENDER_SHADOWS
float cutoffOpacity=1.0;
#ifdef RENDER_CUTOFF
cutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);
#endif
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
float emissive_strength=u_emissive_texture_available > 0.5 ? texture(u_image1,v_pos0).r : image_color.a;vec3 unlit_base=image_color.rgb*(1.0-emissive_strength);vec3 emissive_base=image_color.rgb*emissive_strength;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;
#else
float lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));
#endif
#else
float lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
float emissive_strength=u_emissive_texture_available > 0.5 ? texture(u_image1,v_pos0).r : image_color.a;color.rgb=mix(color.rgb,image_color.rgb,emissive_strength);color.a=1.0;
#endif
#endif
#else
color=image_color;
#endif
#ifdef FOG
#ifdef ZERO_EXAGGERATION
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#else
color=fog_dither(fog_apply_from_vert(color,v_fog_opacity));
#endif
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;
#ifdef FOG
out float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#endif
void main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);
#ifdef FOG
#ifdef ZERO_EXAGGERATION
v_fog_pos=fog_position(decodedPos);
#else
v_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));
#endif
#endif
#ifdef RENDER_SHADOWS
vec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);
#endif
}`),terrainDepth:Ai("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}`),skybox:Ai(`#include "_prelude_fog.fragment.glsl"
in lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(
cos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;
#ifdef FOG
sky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);
#endif
sky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,nd),skyboxGradient:Ai(`#include "_prelude_fog.fragment.glsl"
in highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));
#ifdef FOG
color.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;
#endif
color*=u_opacity;glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,nd),skyboxCapture:Ai(`
in highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;
#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)
#define BETA_M                  vec3(21e-6,21e-6,21e-6)
#define MIE_G                   0.76
#define DENSITY_HEIGHT_SCALE_R  8000.0
#define DENSITY_HEIGHT_SCALE_M  1200.0
#define PLANET_RADIUS           6360e3
#define ATMOSPHERE_RADIUS       6420e3
#define SAMPLE_STEPS            10
#define DENSITY_STEPS           4
float ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}`,"in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:Ai(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
uniform sampler2D u_image1;uniform float u_emissive_texture_available;
#endif
uniform float u_far_z_cutoff;in vec2 v_pos0;
#ifndef FOG
uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;
#endif
void main() {vec4 color;
#ifdef CUSTOM_ANTIALIASING
highp vec2 uv=gl_FragCoord.xy/u_viewport;
#ifdef FLIP_Y
uv.y=1.0-uv.y;
#endif
highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;highp float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);highp float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
float emissive_strength=u_emissive_texture_available > 0.5 ? texture(u_image1,v_pos0).r : raster.a;raster=apply_lighting_with_emission_ground(raster,emissive_strength);color=vec4(clamp(raster.rgb,vec3(0),vec3(1))*antialias,antialias);
#else
raster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
float emissive_strength=u_emissive_texture_available > 0.5 ? texture(u_image1,v_pos0).r : color.a;color=apply_lighting_with_emission_ground(color,emissive_strength);color.a=1.0;
#else
color=apply_lighting_ground(color);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;
#endif
out vec2 v_pos0;void main() {
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;vec2 uv=a_uv;
#else
float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);
#endif
v_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;
#ifdef GLOBE_POLES
vec3 up_vector=globe_derived_up_vector;
#else
vec3 up_vector=elevationVector(tile_pos);
#endif
float height=elevation(tile_pos);globe_pos+=up_vector*height;
#ifndef GLOBE_POLES
globe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;
#endif
#ifdef GLOBE_POLES
vec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);
#else
vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);
#endif
gl_Position=u_proj_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
}`),globeAtmosphere:Ai(`#include "_prelude_fog.fragment.glsl"
uniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_atmosphere_fog_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;
#ifdef PROJECTION_GLOBE_VIEW
globe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {
#ifdef ALPHA_PASS
glFragColor=vec4(0,0,0,0);return;
#else
#ifdef NATIVE
glFragColor=vec4(1,1,1,1);
#else
glFragColor=vec4(0,0,0,1);
#endif
return;
#endif
}
#endif
highp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?
0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;
#ifdef PROJECTION_GLOBE_VIEW
highp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?
PI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);
#else
horizon_angle=horizon_angle_mercator;
#endif
horizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_atmosphere_fog_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_atmosphere_fog_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;
#ifdef ALPHA_PASS
float a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);
#else
vec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;glFragColor=vec4(c*t,t);
#endif
}`,`in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(
mix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}`),model:Ai(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
#ifdef OCCLUSION_TEXTURE_TRANSFORM
uniform vec4 u_occlusionTextureTransform;
#endif
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#ifdef HAS_ATTRIBUTE_a_pbr
in lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;
#endif
#ifdef HAS_TEXTURE_u_baseColorTexture
uniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;
#endif
#ifdef HAS_TEXTURE_u_metallicRoughnessTexture
uniform sampler2D u_metallicRoughnessTexture;
#endif
#ifdef HAS_TEXTURE_u_occlusionTexture
uniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;
#endif
#ifdef HAS_TEXTURE_u_normalTexture
uniform sampler2D u_normalTexture;
#endif
#ifdef HAS_TEXTURE_u_emissionTexture
uniform sampler2D u_emissionTexture;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
in highp float v_depth;uniform highp sampler2D u_depthTexture;uniform highp vec2 u_inv_depth_size;uniform highp vec2 u_depth_range_unpack;
#ifdef DEPTH_D24
highp float unpack_depth(highp float depth) {return  depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}
#else
highp float unpack_depth_rgba(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded() {highp vec2 coord=gl_FragCoord.xy*u_inv_depth_size;
#ifdef FLIP_Y
coord.y=1.0-coord.y;
#endif
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depthTexture,coord).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depthTexture,coord));
#endif
return v_depth > depth+0.0005;}
#endif
#define saturate(_x) clamp(_x,0.,1.)
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)
{
#ifdef LIGHTING_3D_MODE
vec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));
#endif
return apply_lighting(albedo,transformed_normal,lighting_factor);
#else
vec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;
#endif
}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;
#ifdef HAS_ATTRIBUTE_a_color_3f
albedo*=vec4(color_3f,1.0);
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#else
#ifdef HAS_ATTRIBUTE_a_color_4f
albedo*=color_4f;
#endif
#endif
#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)
vec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}
#ifdef UNPREMULT_TEXTURE_IN_SHADER
if(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;
#endif
if(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}
#endif
vec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);
#ifdef APPLY_LUT_ON_GPU
color=applyLUT(u_lutTexture,color);
#endif
return color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {
#ifdef HAS_TEXTURE_u_normalTexture
highp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;
#ifdef FLIP_Y
T=-T;B=-B;
#endif
highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;
#else
return mat3(1.0);
#endif
}highp vec3 getNormal(){highp vec3 n;
#ifdef HAS_ATTRIBUTE_a_normal_3f
n=normalize(normal_3f);
#else
highp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));
#ifdef FLIP_Y
n=normalize(cross(fdx,fdy));
#else
n=normalize(cross(fdx,fdy))*-1.0;
#endif
#endif
#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
vec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);
#endif
return n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;
#ifdef HAS_ATTRIBUTE_a_pbr
mat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;
#endif
#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) 
vec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;
#endif
const float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)
{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)
{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)
{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)
{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)
{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)
{
#ifdef LIGHTING_3D_MODE
return mat.diffuseColor;
#else
return mat.diffuseColor/PI;
#endif
}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)
{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)
{vec3 env_light=vec3(0.65,0.65,0.65);
#ifdef LIGHTING_3D_MODE
float ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;
#endif
vec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)
{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=NdotL;
#endif
vec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;
#if !defined(LIGHTING_3D_MODE)
const vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);
#endif
color*=intensityFactor;return color;}void main() {
#ifdef TERRAIN_FRAGMENT_OCCLUSION
if (isOccluded()) {discard;}
#endif
vec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;
#ifdef LIGHTING_3D_MODE
lightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;
#endif
vec4 finalColor;
#ifdef DIFFUSE_SHADED
vec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);
#ifdef HAS_TEXTURE_u_occlusionTexture
float ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;
#endif
finalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;
#else
Material mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;
#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
#ifdef OCCLUSION_TEXTURE_TRANSFORM
vec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;
#else
vec2 uv=uv_2f;
#endif
ao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;
#endif
vec4 emissive=u_emissiveFactor;
#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
emissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);
#endif
#ifdef APPLY_LUT_ON_GPU
float emissiveFactorLength=max(length(u_emissiveFactor.rgb),0.001);emissive.rgb=sRGBToLinear(applyLUT(u_lutTexture,linearTosRGB(emissive.rgb/emissiveFactorLength).rbg))*emissiveFactorLength;
#endif
color+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;
#ifdef HAS_ATTRIBUTE_a_pbr
float resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;
#ifdef APPLY_LUT_ON_GPU
color_mix=applyLUT(u_lutTexture,color_mix);
#endif
color=mix(color,color_mix,min(1.0,resEmission));
#ifdef HAS_ATTRIBUTE_a_color_4f
float distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);
#endif
#endif
vec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);
#endif
#ifdef FOG
finalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));
#endif
#ifdef RENDER_CUTOFF
finalColor*=v_cutoff_opacity;
#endif
#ifdef INDICATOR_CUTOUT
finalColor=applyCutout(finalColor,v_position_height.w);
#endif
#ifdef FEATURE_CUTOUT
finalColor=apply_feature_cutout(finalColor,gl_FragCoord);
#endif
glFragColor=finalColor;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr
#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength
uniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_normal_matrix;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
out vec4 v_position_height;out lowp vec4 v_color_mix;
#ifdef TERRAIN_FRAGMENT_OCCLUSION
out highp float v_depth;
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
out lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;
#endif
vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute-custom highp vec4 pbr
#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength
highp mat4 normal_matrix;
#ifdef INSTANCED_ARRAYS
normal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
normal_matrix=u_normal_matrix;
#endif
vec3 local_pos;mat3 rs;
#ifdef MODEL_POSITION_ON_GPU
vec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;
#else
local_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);
#endif
v_position_height.w=a_pos_3f.z;
#ifdef HAS_ATTRIBUTE_a_pbr
vec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;
#endif
#ifdef FOG
v_fog_pos=fog_position(local_pos);
#endif
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
v_depth=gl_Position.z/gl_Position.w;
#ifdef CLIP_ZERO_TO_ONE
v_depth=-1.0+2.0*v_depth; 
#endif
#endif
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
float x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);
#else
normal_3f=vec3(normal_matrix*vec4(normal_3f,0));
#endif
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#ifdef HAS_ATTRIBUTE_a_color_4f
v_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);
#endif
#endif
#ifdef RENDER_SHADOWS
vec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);
#ifdef NORMAL_OFFSET
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
vec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#else
vec3 offset=shadow_normal_offset_model(normal_3f);shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#endif
#endif
#endif
v_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;
#endif
}`),modelDepth:Ai(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;
#ifdef MODEL_POSITION_ON_GPU
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_instance;
#endif
uniform highp mat4 u_node_matrix;
#endif
void main() {
#ifdef MODEL_POSITION_ON_GPU
highp mat4 instance;
#ifdef INSTANCED_ARRAYS
instance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
instance=u_instance;
#endif
vec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);
#else
gl_Position=u_matrix*vec4(a_pos_3f,1);
#endif
v_depth=gl_Position.z/gl_Position.w;}`),stars:Ai(`in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)
{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}`,`
in vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}`),snowParticle:Ai("in highp vec2 uv;in highp float alphaMultiplier;uniform vec4 u_particleColor;uniform vec2 u_simpleShapeParameters;void main() {float t=clamp((length(uv)-u_simpleShapeParameters.x)/(1.0-u_simpleShapeParameters.x),0.0,1.0);float alpha=1.0-pow(t,pow(10.0,u_simpleShapeParameters.y));alpha*=alphaMultiplier;alpha*=u_particleColor.a;vec3 color=u_particleColor.rgb*alpha;glFragColor=vec4(color,alpha) ;HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_snowParticleData;in highp vec4 a_snowParticleDataHorizontalOscillation;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform vec2 u_screenSize;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity;uniform vec3 u_direction;uniform float u_horizontalOscillationRadius; 
uniform float u_horizontalOscillationRate; 
uniform float u_billboardSize;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;out highp vec2 uv;out highp float alphaMultiplier;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos.xyz*=halfBoxSize;pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_snowParticleData.z;float coneAngleHeadingRad=a_snowParticleData.w*radians(360.0);vec3 localZ=normalize(u_direction);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 direction;direction.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.z=cos(coneAnglePichRad);direction=normalize(direction);vec3 simPosLocal=vec3(0,0,0);float velocityScale=(1.0+3.0*a_snowParticleData.y)*u_velocity;simPosLocal+=direction*velocityScale*u_time;float horizontalOscillationRadius=u_horizontalOscillationRadius*a_snowParticleDataHorizontalOscillation.x;float horizontalOscillationAngle=u_horizontalOscillationRate*u_time*(-1.0+2.0*a_snowParticleDataHorizontalOscillation.y);simPosLocal.xy+=horizontalOscillationRadius*vec2(cos(horizontalOscillationAngle),sin(horizontalOscillationAngle));vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);float clipZ=-u_cam_pos.z+pos.z;vec4 posView=u_modelview*vec4(pos,1.0);float size=u_billboardSize;alphaMultiplier=1.0;vec4 posScreen=u_projection*posView;posScreen/=posScreen.w;posScreen.xy=vec2(0.5)+posScreen.xy*0.5;posScreen.xy*=u_screenSize;vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=u_screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-posScreen.xy)/(0.5*u_screenSize));screenDist+=a_snowParticleData.x*u_thinningParticleOffset;float scaleFactorMode=0.0;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);if (a_snowParticleData.x < u_thinningAffectedRatio) {scaleFactorMode=1.0-thinningFadeRatio;alphaMultiplier=thinningFadeRatio;}}vec4 posScreen1=u_projection*vec4(posView.x-size,posView.yzw);posScreen1/=posScreen1.w;vec4 posScreen2=u_projection*vec4(posView.x+size,posView.yzw);posScreen2/=posScreen2.w;posScreen1.xy=vec2(0.5)+posScreen1.xy*0.5;posScreen1.xy*=u_screenSize;posScreen2.xy=vec2(0.5)+posScreen2.xy*0.5;posScreen2.xy*=u_screenSize;float screenLength=length(posScreen1.xy-posScreen2.xy);float screenEpsilon=3.0;float scaleFactor=1.0;if (screenLength < screenEpsilon) {scaleFactor=screenEpsilon/max(screenLength,0.01);scaleFactor=mix(scaleFactor,1.0,scaleFactorMode);}float screenEpsilon2=15.0;if (screenLength > screenEpsilon2) {scaleFactor=screenEpsilon2/max(screenLength,0.01);}size*=scaleFactor;vec2 right=size*vec2(1,0);vec2 up=size*vec2(0,1);posView.xy+=right*a_uv.x;posView.xy+=up*a_uv.y;uv=a_uv;gl_Position=u_projection*posView;}`),rainParticle:Ai("in highp vec2 uv;in highp float particleRandomValue;uniform sampler2D u_texScreen;uniform float u_distortionStrength;uniform vec4 u_color;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;uniform float u_shapeDirectionalPower;uniform float u_mode;void main() {vec2 st=uv*0.5+vec2(0.5);vec2 uvm=uv;uvm.y=-1.0+2.0*pow(st.y,u_shapeDirectionalPower);float shape=clamp(1.0-length(uvm),0.0,1.0);float alpha=abs(shape)*u_color.a;vec2 screenSize=vec2(textureSize(u_texScreen,0));vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-gl_FragCoord.xy)/(0.5*screenSize));screenDist+=(0.5+0.5*particleRandomValue)*u_thinningParticleOffset;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;float thinningAlpha=1.0;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);thinningAlpha*=thinningFadeRatio;}vec2 offsetXY=normalize(uvm)*abs(shape);vec2 stScreen=(gl_FragCoord.xy+offsetXY*u_distortionStrength*thinningAlpha)/screenSize;vec3 colorScreen=texture(u_texScreen,stScreen).rgb;alpha*=thinningAlpha;glFragColor=mix(vec4(colorScreen,1.0),vec4(u_color.rgb*alpha,alpha),u_mode);HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_rainParticleData;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity; 
uniform vec2 u_rainDropletSize;uniform vec3 u_rainDirection;out highp vec2 uv;out highp float particleRandomValue;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos*=halfBoxSize; 
pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_rainParticleData.z;float coneAngleHeadingRad=a_rainParticleData.w*radians(360.0);vec3 localZ=normalize(u_rainDirection);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 directionLocal;directionLocal.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.z=cos(coneAnglePichRad);directionLocal=normalize(directionLocal);vec3 directionWorld=localX*directionLocal.x+localY*directionLocal.y+localZ*directionLocal.z;float velocityScale=(1.0+3.0*a_rainParticleData.y)*u_velocity;vec3 simPosLocal=vec3(0,0,0);simPosLocal+=directionLocal*velocityScale*u_time;vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);vec4 posView=u_modelview*vec4(pos,1.0);vec3 directionView=normalize((u_modelview*vec4(directionWorld,0.0)).xyz);vec3 side=cross(directionView,normalize(posView.xyz));posView.xyz+=side*a_uv.x*u_rainDropletSize.x;posView.xyz+=directionView*a_uv.y*u_rainDropletSize.y;uv=a_uv;particleRandomValue=a_rainParticleData.x;gl_Position=u_projection*posView;}`),vignette:Ai("uniform vec3 u_vignetteShape;uniform vec4 u_vignetteColor;in vec2 st;void main() {float screenDist=length(st);float alpha=clamp((screenDist-u_vignetteShape.x)/u_vignetteShape.y,0.0,1.0);alpha=pow(alpha,u_vignetteShape.z)*u_vignetteColor.a;vec3 color=u_vignetteColor.rgb;glFragColor=vec4(color*alpha,alpha) ;}","in vec2 a_pos_2f;out vec2 st;void main() {st=a_pos_2f;gl_Position=vec4(a_pos_2f,0,1);}"),occlusion:Ai("uniform vec4 u_color;void main() {glFragColor=u_color;}",`#include "_prelude_terrain.vertex.glsl"
in highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;
#ifdef TERRAIN
float e=elevation(world_pos.xy);world_pos.z+=e;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}`)};function il(u,t){const r=u.split(`
`);for(let h of r){if(h=h.trimStart(),h[0]!=="#"||!h.includes("if")||h.startsWith("#endif"))continue;const p=h.match(Cp);if(p)for(const g of p)Bl.has(g)||t.add(g)}}function Ai(u,t){const r=new Set,h=[],p=[];u=u.replace(Nu,(y,w)=>(p.push(w),"")),t=t.replace(Nu,(y,w)=>(h.push(w),""));let g=new Set(Nl);il(u,g),il(t,g);for(const y of[...h,...p])ad[y]||(ad[y]=new Set,il(tl[y],ad[y])),g=new Set([...g,...ad[y]]);return{fragmentSource:u=u.replace(Us,(y,w,T,A,M)=>(r.add(M),w==="define"?`
#ifndef HAS_UNIFORM_u_${M}
in ${T} ${A} ${M};
#else
uniform ${T} ${A} u_${M};
#endif
`:w==="initialize"?`
#ifdef HAS_UNIFORM_u_${M}
    ${T} ${A} ${M} = u_${M};
#endif
`:w==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${M}
    in ${T} ${A} ${M};
#endif
`:w==="initialize-attribute"?"":void 0)),vertexSource:t=t.replace(Us,(y,w,T,A,M)=>{const z=`MATERIAL_ATTRIBUTE_OFFSET_${M}`,L=A==="float"?"vec2":A,D=`GET_ATTRIBUTE_${L}(a_${M}, materialInfo, ${z})`,N=M.match(/color/)?"color":L;return w==="define-attribute-vertex-shader-only"?`
#ifdef HAS_ATTRIBUTE_a_${M}
in ${T} ${A} a_${M};
#endif
`:r.has(M)?w==="define"?`
#ifndef HAS_UNIFORM_u_${M}
uniform lowp float u_${M}_t;
    #if !defined(${z})
        in ${T} ${L} a_${M};
    #endif
out ${T} ${A} ${M};
#else
uniform ${T} ${A} u_${M};
#endif
`:w==="initialize"?N==="vec4"?`
#ifndef HAS_UNIFORM_u_${M}
    ${M} = a_${M};
#else
    ${T} ${A} ${M} = u_${M};
#endif
`:`
#if !defined(HAS_UNIFORM_u_${M})
    #ifdef ${z}
        ${M} = unpack_mix_${N}(${D}, u_${M}_t);
    #else
        ${M} = unpack_mix_${N}(a_${M}, u_${M}_t);
    #endif
#else
    ${T} ${A} ${M} = u_${M};
#endif
`:w==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${M}
    in ${T} ${A} a_${M};
    out ${T} ${A} ${M};
#endif
`:w==="initialize-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${M}
    ${M} = a_${M};
#endif
`:void 0:w==="define"?`
#ifndef HAS_UNIFORM_u_${M}
uniform lowp float u_${M}_t;
    #if !defined(${z})
        in ${T} ${L} a_${M};
    #endif
#else
uniform ${T} ${A} u_${M};
#endif
`:w==="define-instanced"?N==="mat4"?`
#ifdef INSTANCED_ARRAYS
in vec4 a_${M}0;
in vec4 a_${M}1;
in vec4 a_${M}2;
in vec4 a_${M}3;
#else
uniform ${T} ${A} u_${M};
#endif
`:`
#ifdef INSTANCED_ARRAYS
in ${T} ${L} a_${M};
#else
uniform ${T} ${A} u_${M};
#endif
`:w==="initialize-attribute-custom"?`
#ifdef HAS_ATTRIBUTE_a_${M}
    ${T} ${A} ${M} = a_${M};
#endif
`:N==="vec4"?`
#ifndef HAS_UNIFORM_u_${M}
    #ifdef ${z}
        ${T} ${A} ${M} = ${D};
    #else
        ${T} ${A} ${M} = a_${M};
    #endif
#else
    ${T} ${A} ${M} = u_${M};
#endif
`:`
#ifndef HAS_UNIFORM_u_${M}
    #ifdef ${z}
        ${T} ${A} ${M} = unpack_mix_${N}(${D}, u_${M}_t);
    #else
        ${T} ${A} ${M} = unpack_mix_${N}(a_${M}, u_${M}_t);
    #endif
#else
    ${T} ${A} ${M} = u_${M};
#endif
`}),usedDefines:g,vertexIncludes:h,fragmentIncludes:p}}class Fv{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(t,r,h,p,g,y,w,T){this.context=t;let A=this.boundPaintVertexBuffers.length!==p.length;for(let z=0;!A&&z<p.length;z++)this.boundPaintVertexBuffers[z]!==p[z]&&(A=!0);let M=this.boundDynamicVertexBuffers.length!==w.length;for(let z=0;!M&&z<w.length;z++)this.boundDynamicVertexBuffers[z]!==w[z]&&(M=!0);if(!this.vao||this.boundProgram!==r||this.boundLayoutVertexBuffer!==h||A||M||this.boundIndexBuffer!==g||this.boundVertexOffset!==y)this.freshBind(r,h,p,g,y,w,T);else{t.bindVertexArrayOES.set(this.vao);for(const z of w)z&&(z.bind(),T&&z.instanceCount&&z.setVertexAttribDivisor(t.gl,r,T));g&&g.dynamicDraw&&g.bind()}}freshBind(t,r,h,p,g,y,w){const T=this.context,A=T.gl;this.vao&&this.destroy(),this.vao=T.gl.createVertexArray(),T.bindVertexArrayOES.set(this.vao),this.boundProgram=t,this.boundLayoutVertexBuffer=r,this.boundPaintVertexBuffers=h,this.boundIndexBuffer=p,this.boundVertexOffset=g,this.boundDynamicVertexBuffers=y,r.enableAttributes(A,t),r.bind(),r.setVertexAttribPointers(A,t,g);for(const M of h)M.enableAttributes(A,t),M.bind(),M.setVertexAttribPointers(A,t,g);for(const M of y)M&&(M.enableAttributes(A,t),M.bind(),M.setVertexAttribPointers(A,t,g),w&&M.instanceCount&&M.setVertexAttribDivisor(A,t,w));p&&p.bind()}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function Bv(u,t){const r=Math.pow(2,t.canonical.z),h=t.canonical.y;return[new s.ae(0,h/r).toLngLat().lat,new s.ae(0,(h+1)/r).toLngLat().lat]}function Nv(u,t,r,h,p,g,y){const w=u.context,T=w.gl,A=r.hillshadeFBO;if(!A)return;u.prepareDrawTile();const M=u.isTileAffectedByFog(t),z=[];u.terrain&&u.terrain.renderingToTexture&&u.emissiveMode==="mrt-fallback"&&z.push("USE_MRT1");const L=u.getOrCreateProgram("hillshade",{overrideFog:M,defines:z});w.activeTexture.set(T.TEXTURE0),T.bindTexture(T.TEXTURE_2D,A.colorAttachment0.get());const D=(($,X,J,K)=>{const ue=J.paint.get("hillshade-shadow-color"),oe=J.paint.get("hillshade-shadow-color-use-theme").constantOr("default")==="none",le=J.paint.get("hillshade-highlight-color"),re=J.paint.get("hillshade-highlight-color-use-theme").constantOr("default")==="none",te=J.paint.get("hillshade-accent-color"),he=J.paint.get("hillshade-accent-color-use-theme").constantOr("default")==="none",we=J.paint.get("hillshade-emissive-strength");let ye=s.an(J.paint.get("hillshade-illumination-direction"));if(J.paint.get("hillshade-illumination-anchor")==="viewport")ye-=$.transform.angle;else if($.style&&$.style.enable3dLights()&&$.style.directionalLight){const Oe=$.style.directionalLight.properties.get("direction"),$e=s.d4(Oe.x,Oe.y,Oe.z);ye=s.an($e[1])}const ze=!$.options.moving;return{u_matrix:K||$.transform.calculateProjMatrix(X.tileID.toUnwrapped(),ze),u_image:0,u_latrange:Bv(0,X.tileID),u_light:[J.paint.get("hillshade-exaggeration"),ye],u_shadow:ue.toPremultipliedRenderColor(oe?null:J.lut),u_highlight:le.toPremultipliedRenderColor(re?null:J.lut),u_emissive_strength:we,u_accent:te.toPremultipliedRenderColor(he?null:J.lut)}})(u,r,h,u.terrain?t.projMatrix:null);u.uploadCommonUniforms(w,L,t.toUnwrapped());const{tileBoundsBuffer:N,tileBoundsIndexBuffer:B,tileBoundsSegments:G}=u.getTileBoundsBuffers(r);L.draw(u,T.TRIANGLES,p,g,y,Yt.disabled,D,h.id,N,B,G)}function Mp(u,t,r){if(!t.needsDEMTextureUpload)return;const h=u.context,p=h.gl;h.pixelStoreUnpackPremultiplyAlpha.set(!1),t.demTexture=t.demTexture||u.getTileTexture(r.stride);const g=r.getPixels();t.demTexture?t.demTexture.update(g,{premultiply:!1}):t.demTexture=new s.T(h,g,p.R32F,{premultiply:!1}),t.needsDEMTextureUpload=!1}function jv(u,t,r){const h=u.context,p=h.gl;if(!t.dem)return;const g=t.dem;if(h.activeTexture.set(p.TEXTURE1),Mp(u,t,g),!t.demTexture)return;t.demTexture.bind(p.NEAREST,p.CLAMP_TO_EDGE);const y=g.dim;h.activeTexture.set(p.TEXTURE0);let w=t.hillshadeFBO;if(!w){const L=new s.T(h,{width:y,height:y,data:null},p.RGBA8);L.bind(p.LINEAR,p.CLAMP_TO_EDGE),w=t.hillshadeFBO=h.createFramebuffer(y,y,1,"renderbuffer"),w.colorAttachment0.set(L.texture)}h.bindFramebuffer.set(w.framebuffer),h.viewport.set([0,0,y,y]);const{tileBoundsBuffer:T,tileBoundsIndexBuffer:A,tileBoundsSegments:M}=u.getMercatorTileBoundsBuffers(),z=[];u.linearFloatFilteringSupported()&&z.push("TERRAIN_DEM_FLOAT_FORMAT"),u.terrain&&u.terrain.renderingToTexture&&u.emissiveMode==="mrt-fallback"&&z.push("USE_MRT1"),u.getOrCreateProgram("hillshadePrepare",{defines:z}).draw(u,p.TRIANGLES,Dt.disabled,Jt.disabled,ai.unblended,Yt.disabled,((L,D)=>{const N=D.stride,B=s.bC();return s.ce(B,0,s.al,-s.al,0,0,1),s.br(B,B,[0,-s.al,0]),{u_matrix:B,u_image:1,u_dimension:[N,N],u_zoom:L.overscaledZ}})(t.tileID,g),r.id,T,A,M),t.needsHillshadePrepare=!1}class bn{constructor(t){this.gl=t.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(t){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class Uv extends bn{getDefault(){return s.ao.transparent.toNonPremultipliedRenderColor(null)}set(t){const r=this.current;(t.r!==r.r||t.g!==r.g||t.b!==r.b||t.a!==r.a||this.dirty)&&(this.gl.clearColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class bg extends bn{getDefault(){return 1}set(t){(t!==this.current||this.dirty)&&(this.gl.clearDepth(t),this.current=t,this.dirty=!1)}}class Rp extends bn{getDefault(){return 0}set(t){(t!==this.current||this.dirty)&&(this.gl.clearStencil(t),this.current=t,this.dirty=!1)}}class cd extends bn{getDefault(){return[!0,!0,!0,!0]}set(t){const r=this.current;(t[0]!==r[0]||t[1]!==r[1]||t[2]!==r[2]||t[3]!==r[3]||this.dirty)&&(this.gl.colorMask(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class kp extends bn{getDefault(){return!0}set(t){(t!==this.current||this.dirty)&&(this.gl.depthMask(t),this.current=t,this.dirty=!1)}}class jl extends bn{getDefault(){return 255}set(t){(t!==this.current||this.dirty)&&(this.gl.stencilMask(t),this.current=t,this.dirty=!1)}}class Sc extends bn{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(t){const r=this.current;(t.func!==r.func||t.ref!==r.ref||t.mask!==r.mask||this.dirty)&&(this.gl.stencilFunc(t.func,t.ref,t.mask),this.current=t,this.dirty=!1)}}class ju extends bn{getDefault(){const t=this.gl;return[t.KEEP,t.KEEP,t.KEEP]}set(t){const r=this.current;(t[0]!==r[0]||t[1]!==r[1]||t[2]!==r[2]||this.dirty)&&(this.gl.stencilOp(t[0],t[1],t[2]),this.current=t,this.dirty=!1)}}class Ec extends bn{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;t?r.enable(r.STENCIL_TEST):r.disable(r.STENCIL_TEST),this.current=t,this.dirty=!1}}class Tg extends bn{getDefault(){return[0,1]}set(t){const r=this.current;(t[0]!==r[0]||t[1]!==r[1]||this.dirty)&&(this.gl.depthRange(t[0],t[1]),this.current=t,this.dirty=!1)}}class Lp extends bn{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;t?r.enable(r.DEPTH_TEST):r.disable(r.DEPTH_TEST),this.current=t,this.dirty=!1}}class Sg extends bn{getDefault(){return this.gl.LESS}set(t){(t!==this.current||this.dirty)&&(this.gl.depthFunc(t),this.current=t,this.dirty=!1)}}class Ic extends bn{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;t?r.enable(r.BLEND):r.disable(r.BLEND),this.current=t,this.dirty=!1}}class ud extends bn{getDefault(){const t=this.gl;return[t.ONE,t.ZERO,t.ONE,t.ZERO]}set(t){const r=this.current;(t[0]!==r[0]||t[1]!==r[1]||t[2]!==r[2]||t[3]!==r[3]||this.dirty)&&(this.gl.blendFuncSeparate(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class hd extends bn{getDefault(){return s.ao.transparent.toNonPremultipliedRenderColor(null)}set(t){const r=this.current;(t.r!==r.r||t.g!==r.g||t.b!==r.b||t.a!==r.a||this.dirty)&&(this.gl.blendColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class zp extends bn{getDefault(){return this.gl.FUNC_ADD}set(t){(t!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(t,t),this.current=t,this.dirty=!1)}}class dd extends bn{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;t?r.enable(r.CULL_FACE):r.disable(r.CULL_FACE),this.current=t,this.dirty=!1}}class Uu extends bn{getDefault(){return this.gl.BACK}set(t){(t!==this.current||this.dirty)&&(this.gl.cullFace(t),this.current=t,this.dirty=!1)}}class Eg extends bn{getDefault(){return this.gl.CCW}set(t){(t!==this.current||this.dirty)&&(this.gl.frontFace(t),this.current=t,this.dirty=!1)}}let Ig=class extends bn{getDefault(){return null}set(u){(u!==this.current||this.dirty)&&(this.gl.useProgram(u),this.current=u,this.dirty=!1)}};class Ag extends bn{getDefault(){return this.gl.TEXTURE0}set(t){(t!==this.current||this.dirty)&&(this.gl.activeTexture(t),this.current=t,this.dirty=!1)}}class Ac extends bn{getDefault(){const t=this.gl;return[0,0,t.drawingBufferWidth,t.drawingBufferHeight]}set(t){const r=this.current;(t[0]!==r[0]||t[1]!==r[1]||t[2]!==r[2]||t[3]!==r[3]||this.dirty)&&(this.gl.viewport(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Cg extends bn{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;r.bindFramebuffer(r.FRAMEBUFFER,t),this.current=t,this.dirty=!1}}class Vv extends bn{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;r.bindRenderbuffer(r.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class $v extends bn{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;r.bindTexture(r.TEXTURE_2D,t),this.current=t,this.dirty=!1}}class Gv extends bn{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;r.bindBuffer(r.ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class Dp extends bn{getDefault(){return null}set(t){const r=this.gl;r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class Op extends bn{getDefault(){return null}set(t){this.gl&&(t!==this.current||this.dirty)&&(this.gl.bindVertexArray(t),this.current=t,this.dirty=!1)}}class Fp extends bn{getDefault(){return 4}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;r.pixelStorei(r.UNPACK_ALIGNMENT,t),this.current=t,this.dirty=!1}}class Bp extends bn{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t),this.current=t,this.dirty=!1}}class Pg extends bn{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,t),this.current=t,this.dirty=!1}}class fd extends bn{constructor(t,r){super(t),this.context=t,this.parent=r}getDefault(){return null}}class pd extends fd{constructor(t,r,h=0){super(t,r),this.attachmentPoint=t.gl.COLOR_ATTACHMENT0+h}setDirty(){this.dirty=!0}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const r=this.gl;r.framebufferTexture2D(r.FRAMEBUFFER,this.attachmentPoint,r.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class Cc extends fd{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const r=this.gl;r.framebufferRenderbuffer(r.FRAMEBUFFER,this.attachment(),r.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class Vu extends fd{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const r=this.gl;r.framebufferTexture2D(r.FRAMEBUFFER,this.attachment(),r.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class Mg extends Cc{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}const Oo=(u,t,r,h)=>({u_matrix:u,u_image0:0,u_image1:1,u_skirt_height:t,u_ground_shadow_factor:r,u_emissive_texture_available:h}),md=(u,t,r,h,p,g,y,w,T,A,M,z,L,D,N,B,G)=>({u_proj_matrix:Float32Array.from(u),u_globe_matrix:t,u_normalize_matrix:Float32Array.from(h),u_merc_matrix:r,u_zoom_transition:p,u_merc_center:g,u_image0:0,u_image1:1,u_frustum_tl:y,u_frustum_tr:w,u_frustum_br:T,u_frustum_bl:A,u_globe_pos:M,u_globe_radius:z,u_viewport:L,u_grid_matrix:G?Float32Array.from(G):new Float32Array(9),u_skirt_height:D,u_far_z_cutoff:N,u_emissive_texture_available:B});function $u(u,t){return u!=null&&t!=null&&!(!u.hasData()||!t.hasData())&&u.demTexture!=null&&t.demTexture!=null&&u.tileID.key!==t.tileID.key}const ha=new class{constructor(){this.operations={}}newMorphing(u,t,r,h,p){if(u in this.operations){const g=this.operations[u];g.to.tileID.key!==r.tileID.key&&(g.queued=r)}else this.operations[u]={startTime:h,phase:0,duration:p,from:t,to:r,queued:null}}getMorphValuesForProxy(u){if(!(u in this.operations))return null;const t=this.operations[u];return{from:t.from,to:t.to,phase:t.phase}}update(u){for(const t in this.operations){const r=this.operations[t];for(r.phase=(u-r.startTime)/r.duration;r.phase>=1||!this._validOp(r);)if(!this._nextOp(r,u)){delete this.operations[t];break}}}_nextOp(u,t){return!!u.queued&&(u.from=u.to,u.to=u.queued,u.queued=null,u.phase=0,u.startTime=t,!0)}_validOp(u){return u.from.hasData()&&u.to.hasData()}},_d={0:null,1:"TERRAIN_VERTEX_MORPHING"};function gd(u,t,r){if(t===0)return 0;const h=t<1&&r===514?.25/t:1;return 6*Math.pow(1.5,22-u)*Math.max(t,1)*h}function Np(u,t){const r=1<<u.z;return!t&&(u.x===0||u.x===r-1)||u.y===0||u.y===r-1}function Pc(u,t){if(!u.style||!u.style.enable3dLights())return;const r=u.context,h=r.gl;r.activeTexture.set(h.TEXTURE1),t?t.bind(h.LINEAR,h.CLAMP_TO_EDGE):u.emptyTexture.bind(h.LINEAR,h.CLAMP_TO_EDGE)}const Gu=u=>({u_matrix:u});function Hu(u,t,r,h,p){if(p>0){const g=s.o.now(),y=(g-u.timeAdded)/p,w=t?(g-t.timeAdded)/p:-1,T=r.getSource(),A=h.coveringZoomLevel({tileSize:T.tileSize,roundZoom:T.roundZoom}),M=!t||Math.abs(t.tileID.overscaledZ-A)>Math.abs(u.tileID.overscaledZ-A),z=M&&u.refreshedUponExpiration?1:s.aA(M?y:1-w,0,1);return t?{opacity:1,mix:1-z,isFading:y<1}:{opacity:z,mix:0,isFading:y<1}}return{opacity:1,mix:0,isFading:!1}}class yd extends Io{constructor(t){const r=xr("mock-dem",{type:"raster-dem",maxzoom:t.transform.maxZoom},t.style.dispatcher,t.style);super("mock-dem",r,!1),r.setEventedParent(this),this._sourceLoaded=!0}_loadTile(t,r){t.state="loaded",r(null)}}class jp extends Io{constructor(t){const r=xr("proxy",{type:"geojson",maxzoom:t.transform.maxZoom},t.style.dispatcher,t.style);super("proxy",r,!1),r.setEventedParent(this),this.map=this.getSource().map=t,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(t,r,h){if(t.freezeTileCoverage)return;this.transform=t;const p=t.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((g,y)=>{if(g[y.key]="",!this._tiles[y.key]){const w=new zl(y,this._source.tileSize*y.overscaleFactor(),t.tileZoom,void 0,void 0,this._source.worldview);w.state="loaded",this._tiles[y.key]=w}return g},{});for(const g in this._tiles)g in p||(this.freeFBO(g),this._tiles[g].unloadVectorData(),delete this._tiles[g])}freeFBO(t){const r=this.proxyCachedFBO[t];if(r!==void 0){const h=Object.values(r);this.renderCachePool.push(...h),delete this.proxyCachedFBO[t]}}deallocRenderCache(){this.renderCache.forEach(t=>t.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class Up extends s.aQ{constructor(t,r,h){super(t.overscaledZ,t.wrap,t.canonical.z,t.canonical.x,t.canonical.y),this.proxyTileKey=r,this.projMatrix=h}}class Vp extends s.bV{constructor(t,r){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},this.painter=t,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[h,p,g]=function(T){const A=new s.bd,M=new s.b0,z=131;A.reserve(17161),M.reserve(33800);const L=s.al/128,D=s.al+L/2,N=D+L;for(let G=-L;G<N;G+=L)for(let $=-L;$<N;$+=L){const X=$<0||$>D||G<0||G>D?24575:0,J=s.aA(Math.round($),0,s.al),K=s.aA(Math.round(G),0,s.al);A.emplaceBack(J+X,K)}const B=(G,$)=>{const X=$*z+G;M.emplaceBack(X+1,X,X+z),M.emplaceBack(X+z,X+z+1,X+1)};for(let G=1;G<129;G++)for(let $=1;$<129;$++)B($,G);return[0,129].forEach(G=>{for(let $=0;$<130;$++)B($,G),B(G,$)}),[A,M,32768]}(),y=t.context;this.gridBuffer=y.createVertexBuffer(h,s.bf.members),this.gridIndexBuffer=y.createIndexBuffer(p),this.gridSegments=s.bg.simpleSegment(0,0,h.length,p.length),this.gridNoSkirtSegments=s.bg.simpleSegment(0,0,h.length,g),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new jp(r.map),this.orthoMatrix=s.bC(),s.ce(this.orthoMatrix,this.painter.transform.projection.name==="globe"?.015:0,s.al,0,s.al,0,1);const w=y.gl;this._overlapStencilMode=new Jt({func:w.GEQUAL,mask:255},0,255,w.KEEP,w.KEEP,w.REPLACE),this._previousZoom=t.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=r,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new yd(r.map),this._pendingGroundEffectLayers=[],this._emissiveTexture=!1}set style(t){t.on("data",this._onStyleDataEvent.bind(this)),this._style=t,this._style.map.on("moveend",()=>{this._clearLineLayersFromRenderCache()})}update(t,r,h){if(t&&t.terrain){this._style!==t&&(this.style=t,this._evaluationZoom=void 0);const p=t.terrain.properties,g=t.terrain.drapeRenderMode===0,y=t.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=s.o.now();const w=t.terrain&&t.terrain.scope,T=p.get("source"),A=g?this._mockSourceCache:t.getSourceCache(T,w);if(!A)return void s.w(`Couldn't find terrain source "${T}".`);if(this.sourceCache=A,this._attenuationRange=t.terrain.getAttenuationRange(),this._exaggeration=y?this.calculateExaggeration(r):p.get("exaggeration"),!r.projection.requiresDraping&&y&&this._exaggeration===0)return void this._disable();this.enabled=!0;const M=()=>{this.sourceCache.used&&s.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const z=this.getScaledDemTileSize();this.sourceCache.update(r,z,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,M(),this._initializing=!0),M(),r.updateElevation(!0,h),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(r),this._emptyDEMTextureDirty=!0,this._previousZoom=r.zoom}else this._disable()}calculateExaggeration(t){if(this._attenuationRange&&t.zoom>=Math.ceil(this._attenuationRange[1]))return this._style.terrain.getExaggeration(t.zoom);const r=this._previousCameraAltitude,h=t.getFreeCameraOptions().position.z/t.pixelsPerMeter*t.worldSize;this._previousCameraAltitude=h;const p=r!=null?h-r:Number.MAX_VALUE;if(Math.abs(p)<2)return this._exaggeration;const g=t.zoom,y=this._style.terrain;if(!this._previousUpdateTimestamp)return y.getExaggeration(g);let w=g-this._previousZoom;const T=this._previousUpdateTimestamp;let A=g;this._evaluationZoom!=null&&(A=this._evaluationZoom,Math.abs(g-A)>.5&&(w=.5*(g-A+w)),w*p<0&&(A+=w)),this._evaluationZoom=A;const M=y.getExaggeration(A),z=M===y.getExaggeration(Math.max(0,A-.1));if(z&&Math.abs(M-this._exaggeration)<.01)return M;let L=Math.min(.1,.00375*(this._updateTimestamp-T));return(z||M<.1||Math.abs(w)<1e-4)&&(L=Math.min(.2,4*L)),s.ak(this._exaggeration,M,L)}resetTileLookupCache(t){this._findCoveringTileCache[t]={}}attenuationRange(){return this._attenuationRange}getDemUpscale(){return this.proxySourceCache.getSource().tileSize/128}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(t){t.dataType==="source"&&t.coord?this._clearRenderCacheForTile(t.sourceCacheId,t.coord):t.dataType==="style"&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const t in this._style._mergedSourceCaches)this._style._mergedSourceCaches[t].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this.pool.forEach(t=>t.fb.destroy()),this.pool=[],this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const t=2*this.proxySourceCache.getSource().tileSize;return[t,t]}set useVertexMorphing(t){this._useVertexMorphing=t}updateTileBinding(t){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const r=this.proxySourceCache,h=this.painter.transform;this._initializing&&(this._initializing=h._centerAltitude===0&&this.getAtPointOrZero(s.ae.fromLngLat(h.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);const p=this.proxyCoords=r.getIds().map(T=>{const A=r.getTileByID(T).tileID;return A.projMatrix=h.calculateProjMatrix(A.toUnwrapped()),A});(function(T,A){const M=A.transform.pointCoordinate(A.transform.getCameraPoint()),z=new s.P(M.x,M.y);T.sort((L,D)=>{if(D.overscaledZ-L.overscaledZ)return D.overscaledZ-L.overscaledZ;const N=new s.P(L.canonical.x+(1<<L.canonical.z)*L.wrap,L.canonical.y),B=new s.P(D.canonical.x+(1<<D.canonical.z)*D.wrap,D.canonical.y),G=z.mult(1<<L.canonical.z);return G.x-=.5,G.y-=.5,G.distSqr(N)-G.distSqr(B)})})(p,this.painter);const g=this.proxyToSource||{};this.proxyToSource={},p.forEach(T=>{this.proxyToSource[T.key]={}}),this.terrainTileForTile={};const y=this._style._mergedSourceCaches;for(const T in y){const A=y[T];if(!A.used||(A!==this.sourceCache&&this.resetTileLookupCache(A.id),this._setupProxiedCoordsForOrtho(A,t[T],g),A.usedForTerrain))continue;const M=t[T];A.getSource().reparseOverscaled&&this._assignTerrainTiles(M)}this.proxiedCoords[r.id]=p.map(T=>new Up(T,T.key,this.orthoMatrix)),this._assignTerrainTiles(p),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(g),this.renderingToTexture=!1;const w={};this._visibleDemTiles=[];for(const T of this.proxyCoords){const A=this.terrainTileForTile[T.key];if(!A)continue;const M=A.tileID.key;M in w||(this._visibleDemTiles.push(A),w[M]=M)}}_assignTerrainTiles(t){this._initializing||t.forEach(r=>{if(this.terrainTileForTile[r.key])return;const h=this._findTileCoveringTileID(r,this.sourceCache);h&&(this.terrainTileForTile[r.key]=h)})}_prepareDEMTextures(){const t=this.painter.context,r=t.gl;for(const h in this.terrainTileForTile){const p=this.terrainTileForTile[h],g=p.dem;!g||p.demTexture&&!p.needsDEMTextureUpload||(t.activeTexture.set(r.TEXTURE1),Mp(this.painter,p,g))}}_prepareDemTileUniforms(t,r,h,p){if(!r||r.demTexture==null)return!1;const g=t.tileID.canonical,y=Math.pow(2,r.tileID.canonical.z-g.z),w=p||"";return h[`u_dem_tl${w}`]=[g.x*y%1,g.y*y%1],h[`u_dem_scale${w}`]=y,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let t=0;const r=this._visibleDemTiles.reduce((h,p)=>{if(!p.dem)return h;const g=p.dem.tree.minimums[0];return g>0&&t++,h+g},0);return t?r/t:0}_updateEmptyDEMTexture(){const t=this.painter.context,r=t.gl;t.activeTexture.set(r.TEXTURE2);const h=this._getLoadedAreaMinimum(),p=new s.dL({width:1,height:1},new Float32Array([h]));this._emptyDEMTextureDirty=!1;let g=this._emptyDEMTexture;return g?g.update(p,{premultiply:!1}):g=this._emptyDEMTexture=new s.T(t,p,r.R32F,{premultiply:!1}),g}setupElevationDraw(t,r,h){const p=this.painter.context,g=p.gl,y={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0};y.u_exaggeration=this.exaggeration();let w=null,T=null,A=1;if(h&&h.morphing&&this._useVertexMorphing){const D=h.morphing.srcDemTile,N=h.morphing.dstDemTile;A=h.morphing.phase,D&&N&&(this._prepareDemTileUniforms(t,D,y,"_prev")&&(T=D),this._prepareDemTileUniforms(t,N,y)&&(w=N))}const M=D=>D&&D.demTexture&&this.painter.linearFloatFilteringSupported()?g.LINEAR:g.NEAREST;let z=null;var L;if(this.enabled?T&&w?(z=w.demTexture,p.activeTexture.set(g.TEXTURE4),T.demTexture.bind(M(T),g.CLAMP_TO_EDGE),y.u_dem_lerp=A):(w=this.terrainTileForTile[t.tileID.key],z=this._prepareDemTileUniforms(t,w,y)?w.demTexture:this.emptyDEMTexture):z=this.emptyDEMTexture,p.activeTexture.set(g.TEXTURE2),z&&(y.u_dem_size=(L=z).size[0]===1?1:L.size[0]-2,z.bind(M(w),g.CLAMP_TO_EDGE)),this.painter.setupDepthForOcclusion(h&&h.useDepthForOcclusion,r,y),h&&h.useMeterToDem&&w){const D=(1<<w.tileID.canonical.z)*s.cf(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;y.u_meter_to_dem=D}if(h&&h.labelPlaneMatrixInv&&(y.u_label_plane_matrix_inv=h.labelPlaneMatrixInv),r.setTerrainUniformValues(p,y),this.painter.transform.projection.name==="globe"){const D=this.globeUniformValues(this.painter.transform,t.tileID.canonical,h&&h.useDenormalizedUpVectorScale);r.setGlobeUniformValues(p,D)}}globeUniformValues(t,r,h){const p=t.projection;return{u_tile_tl_up:p.upVector(r,0,0),u_tile_tr_up:p.upVector(r,s.al,0),u_tile_br_up:p.upVector(r,s.al,s.al),u_tile_bl_up:p.upVector(r,0,s.al),u_tile_up_scale:h?s.dM(1):p.upVectorScale(r,t.center.lat,t.worldSize).metersToTile}}renderToBackBuffer(t){const r=this.painter,h=this.painter.context;t.length!==0&&(h.bindFramebuffer.set(null),h.viewport.set([0,0,r.width,r.height]),r.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(p,g,y,w,T){if(p.transform.projection.name==="globe")(function(A,M,z,L,D){const N=A.context,B=N.gl;let G,$;const X=A.transform,J=s.dE(A,N,X),K=(ze,Oe)=>{if($===Oe)return;const $e=[_d[Oe],"PROJECTION_GLOBE_VIEW"];J&&$e.push("CUSTOM_ANTIALIASING");const ot=A.isTileAffectedByFog(ze);G=A.getOrCreateProgram("globeRaster",{defines:$e,overrideFog:ot}),$=Oe},ue=A.colorModeForRenderPass(),oe=new Dt(B.LEQUAL,Dt.ReadWrite,A.depthRangeFor3D);ha.update(D);const le=s.dF(X),re=[s.aF(X.center.lng),s.aJ(X.center.lat)],te=A.globeSharedBuffers,he=[X.width*s.o.devicePixelRatio,X.height*s.o.devicePixelRatio],we=Float32Array.from(X.globeMatrix),ye={useDenormalizedUpVectorScale:!0};{const ze=A.transform,Oe=gd(ze.zoom,M.exaggeration(),M.sourceCache._source.tileSize);$=-1;const $e=B.TRIANGLES;for(const ot of L){const Ae=z.getTile(ot),_e=Jt.disabled,Ne=M.prevTerrainTileForTile[ot.key],Re=M.terrainTileForTile[ot.key];$u(Ne,Re)&&ha.newMorphing(ot.key,Ne,Re,D,250),Pc(A,Ae.emissiveTexture),N.activeTexture.set(B.TEXTURE0),Ae.texture&&Ae.texture.bind(B.LINEAR,B.CLAMP_TO_EDGE);const Ke=ha.getMorphValuesForProxy(ot.key),pt=Ke?1:0;Ke&&Object.assign(ye,{morphing:{srcDemTile:Ke.from,dstDemTile:Ke.to,phase:s.dD(Ke.phase)}});const wt=s.dG(ot.canonical),ht=s.dH(wt.getCenter().lat),st=s.dI(ot.canonical,wt,ht,ze.worldSize/ze._pixelsPerMercatorPixel),Rt=s.bk(s.dJ(ot.canonical)),At=A.emissiveMode==="mrt-fallback"?1:0,vt=md(ze.expandedFarZProjMatrix,we,le,Rt,s.aj(ze.zoom),re,ze.frustumCorners.TL,ze.frustumCorners.TR,ze.frustumCorners.BR,ze.frustumCorners.BL,ze.globeCenterInViewSpace,ze.globeRadius,he,Oe,ze._farZ,At,st);if(K(ot,pt),G&&(M.setupElevationDraw(Ae,G,ye),A.uploadCommonUniforms(N,G,ot.toUnwrapped()),te)){const[Tt,Ut,ii]=te.getGridBuffers(ht,Oe!==0);G.draw(A,$e,oe,_e,ue,Yt.backCCW,vt,"globe_raster",Tt,Ut,ii)}}}if(te&&(A.renderDefaultNorthPole||A.renderDefaultSouthPole)){const ze=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];J&&ze.push("CUSTOM_ANTIALIASING"),G=A.getOrCreateProgram("globeRaster",{defines:ze});for(const Oe of L){const{x:$e,y:ot,z:Ae}=Oe.canonical,_e=ot===0,Ne=ot===(1<<Ae)-1,[Re,Ke,pt,wt]=te.getPoleBuffers(Ae,!1);if(wt&&(_e||Ne)){const ht=z.getTile(Oe);Pc(A,ht.emissiveTexture),N.activeTexture.set(B.TEXTURE0),ht.texture&&ht.texture.bind(B.LINEAR,B.CLAMP_TO_EDGE);let st=s.dK(Ae,$e,X);const Rt=s.bk(s.dJ(Oe.canonical)),At=A.emissiveMode==="mrt-fallback"?1:0,vt=(Tt,Ut)=>Tt.draw(A,B.TRIANGLES,oe,Jt.disabled,ue,Yt.disabled,md(X.expandedFarZProjMatrix,st,st,Rt,0,re,X.frustumCorners.TL,X.frustumCorners.TR,X.frustumCorners.BR,X.frustumCorners.BL,X.globeCenterInViewSpace,X.globeRadius,he,0,X._farZ,At),"globe_pole_raster",Ut,pt,wt);M.setupElevationDraw(ht,G,ye),A.uploadCommonUniforms(N,G,Oe.toUnwrapped()),_e&&A.renderDefaultNorthPole&&vt(G,Re),Ne&&A.renderDefaultSouthPole&&(st=s.cS(s.bC(),st,[1,-1,1]),vt(G,Ke))}}}})(p,g,y,w,T);else{const A=p.context,M=A.gl;let z,L;const D=p.shadowRenderer,N=Ya(p,p.longestCutoffRange),B=ue=>{if(L===ue)return;const oe=[];oe.push(_d[ue]),N.shouldRenderCutoff&&oe.push("RENDER_CUTOFF"),D&&(oe.push("RENDER_SHADOWS","DEPTH_TEXTURE"),D.useNormalOffset&&oe.push("NORMAL_OFFSET")),z=p.getOrCreateProgram("terrainRaster",{defines:oe}),L=ue},G=p.colorModeForRenderPass(),$=new Dt(M.LEQUAL,Dt.ReadWrite,p.depthRangeFor3D);ha.update(T);const X=p.transform,J=gd(X.zoom,g.exaggeration(),g.sourceCache._source.tileSize);let K=[0,0,0];if(D){const ue=p.style.directionalLight,oe=p.style.ambientLight;ue&&oe&&(K=ua(p.style,ue,oe))}{L=-1;const ue=M.TRIANGLES,[oe,le]=[g.gridIndexBuffer,g.gridSegments];for(const re of w){const te=y.getTile(re),he=Jt.disabled,we=g.prevTerrainTileForTile[re.key],ye=g.terrainTileForTile[re.key];$u(we,ye)&&ha.newMorphing(re.key,we,ye,T,250),Pc(p,te.emissiveTexture),A.activeTexture.set(M.TEXTURE0),te.texture&&te.texture.bind(M.LINEAR,M.CLAMP_TO_EDGE);const ze=ha.getMorphValuesForProxy(re.key),Oe=ze?1:0;let $e;ze&&($e={morphing:{srcDemTile:ze.from,dstDemTile:ze.to,phase:s.dD(ze.phase)}});const ot=p.emissiveMode==="mrt-fallback"?1:0,Ae=Oo(re.projMatrix,Np(re.canonical,X.renderWorldCopies)?J/10:J,K,ot);if(B(Oe),!z)continue;g.setupElevationDraw(te,z,$e);const _e=re.toUnwrapped();D&&D.setupShadows(_e,z),p.uploadCommonUniforms(A,z,_e,null,N),z.draw(p,ue,$,he,G,Yt.backCCW,Ae,"terrain_raster",g.gridBuffer,oe,le)}}}}(r,this,this.proxySourceCache,t,this._updateTimestamp),this.renderingToTexture=!0,r.gpuTimingDeferredRenderEnd(),t.splice(0,t.length))}renderBatch(t){if(this._drapedRenderBatches.length===0)return t+1;this.renderingToTexture=!0;const r=this.painter,h=this.painter.context,p=this.proxySourceCache,g=this.proxiedCoords[p.id],y=this._drapedRenderBatches.shift(),w=r.style.order,T=[];this._updateFBOs(r.emissiveMode==="mrt-fallback");let A=0;for(const M of g){const z=p.getTileByID(M.proxyTileKey),L=p.proxyCachedFBO[M.key]?p.proxyCachedFBO[M.key][t]:void 0,D=L!==void 0?p.renderCache[L]:this.pool[A++],N=L!==void 0;if(z.texture=D.tex,z.emissiveTexture=D.emissiveTex,N&&!D.dirty){T.push(z.tileID);continue}h.bindFramebuffer.set(D.fb.framebuffer);const B=h.gl;let G;B.drawBuffers(r.emissiveMode==="mrt-fallback"?[B.COLOR_ATTACHMENT0,B.COLOR_ATTACHMENT1]:[B.COLOR_ATTACHMENT0]),this.renderedToTile=!1,D.dirty&&(h.clear({color:s.ao.transparent,stencil:0}),D.dirty=!1);for(let $=y.start;$<=y.end;++$){const X=r.style._mergedLayers[w[$]];if(X.isHidden(r.transform.zoom))continue;const J=r.style.getLayerSourceCache(X),K=J?this.proxyToSource[M.key][J.id]:[M];if(!K)continue;const ue=K;h.viewport.set([0,0,D.fb.width,D.fb.height]),G!==(J?J.id:null)&&(this._setupStencil(D,K,X,J),G=J?J.id:null),r.renderLayer(r,J,X,ue)}if(B.drawBuffers([B.COLOR_ATTACHMENT0]),this._drapedRenderBatches.length===0)for(const $ of this._pendingGroundEffectLayers){const X=r.style._mergedLayers[w[$]];if(X.isHidden(r.transform.zoom))continue;const J=r.style.getLayerSourceCache(X),K=J?this.proxyToSource[M.key][J.id]:[M];if(!K)continue;const ue=K;h.viewport.set([0,0,D.fb.width,D.fb.height]),G!==(J?J.id:null)&&(this._setupStencil(D,K,X,J),G=J?J.id:null),r.renderLayer(r,J,X,ue)}this.renderedToTile?(D.dirty=!0,T.push(z.tileID)):N||--A,A===5&&(A=0,this.renderToBackBuffer(T))}return this.renderToBackBuffer(T),this.renderingToTexture=!1,h.bindFramebuffer.set(null),h.viewport.set([0,0,r.width,r.height]),y.end+1}postRender(){}isLayerOrderingCorrect(t){const r=t.order.length;let h=-1,p=r;for(let g=0;g<r;++g)this._style.isLayerDraped(t._mergedLayers[t.order[g]])?h=Math.max(h,g):p=Math.min(p,g);return p>h}getMinElevationBelowMSL(){let t=0;return this._visibleDemTiles.filter(r=>r.dem).forEach(r=>{t=Math.min(t,r.dem.tree.minimums[0])}),t===0?t:(t-30)*this._exaggeration}raycast(t,r,h){if(!this._visibleDemTiles)return null;const p=this._visibleDemTiles.filter(g=>g.dem).map(g=>{const y=g.tileID,w=1<<y.overscaledZ,{x:T,y:A}=y.canonical,M=T/w,z=(T+1)/w,L=A/w,D=(A+1)/w;return{minx:M,miny:L,maxx:z,maxy:D,t:g.dem.tree.raycastRoot(M,L,z,D,t,r,h),tile:g}});p.sort((g,y)=>(g.t!==null?g.t:Number.MAX_VALUE)-(y.t!==null?y.t:Number.MAX_VALUE));for(const g of p){if(g.t==null)return null;const y=g.tile.dem.tree.raycast(g.minx,g.miny,g.maxx,g.maxy,t,r,h);if(y!=null)return y}return null}_createFBO(){const t=this.painter.context,r=t.gl,h=this.drapeBufferSize;t.activeTexture.set(r.TEXTURE0);const p=new s.T(t,{width:h[0],height:h[1],data:null},r.RGBA8);p.bind(r.LINEAR,r.CLAMP_TO_EDGE);const g=t.createFramebuffer(h[0],h[1],1,null);let y;return g.colorAttachment0.set(p.texture),this._emissiveTexture&&(y=new s.T(t,{width:h[0],height:h[1],data:null},r.R8),y.bind(r.LINEAR,r.CLAMP_TO_EDGE),g.createColorAttachment(t,1),g.colorAttachment1.set(y.texture)),g.depthAttachment=new Mg(t,g.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=t.createRenderbuffer(t.gl.DEPTH_STENCIL,h[0],h[1]),this._stencilRef=0,g.depthAttachment.set(this._sharedDepthStencil),t.clear({stencil:0})):g.depthAttachment.set(this._sharedDepthStencil),t.extTextureFilterAnisotropic&&r.texParameterf(r.TEXTURE_2D,t.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,t.extTextureFilterAnisotropicMax),{fb:g,tex:p,emissiveTex:y,dirty:!1}}_updateFBOs(t){if(this._emissiveTexture!==t){for(const r of this.pool)this._updateFBO(r,t);for(const r of this.proxySourceCache.renderCache)this._updateFBO(r,t);this._emissiveTexture=t}}_updateFBO(t,r){const h=t.fb,p=this.painter.context,g=p.gl,y=this.drapeBufferSize;if(r){const w=new s.T(p,{width:y[0],height:y[1],data:null},g.R8);w.bind(g.LINEAR,g.CLAMP_TO_EDGE),t.emissiveTex=w,h.createColorAttachment(p,1),h.colorAttachment1.set(w.texture)}else t.emissiveTex=void 0,h.removeColorAttachment(p,1);t.dirty=!0}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache||this._style.hasLightTransitions())return!0;for(const t in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[t].hasTransition())return!0;return this._style.order.some(t=>{const r=this._style._mergedLayers[t],h=r.isHidden(this.painter.transform.zoom);return r.type==="hillshade"||r.type==="custom"?!h&&r.shouldRedrape():!h&&r.hasTransition()})}_clearLineLayersFromRenderCache(){let t=!1;for(const h of this._style.getSources())if(h instanceof Rl){t=!0;break}if(!t)return;const r={};for(let h=0;h<this._style.order.length;++h){const p=this._style._mergedLayers[this._style.order[h]],g=this._style.getLayerSourceCache(p);if(!g||r[g.id]||p.isHidden(this.painter.transform.zoom)||p.type!=="line")continue;const y=p.widthExpression(),w=p.emissiveStrengthExpression();if(y instanceof s.ad||w instanceof s.ad){r[g.id]=!0;for(const T of this.proxyCoords){const A=this.proxyToSource[T.key][g.id];if(A)for(const M of A)this._clearRenderCacheForTile(g.id,M)}}}}_clearRasterLayersFromRenderCache(){let t=!1;for(const h in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[h]._source instanceof Ar){t=!0;break}if(!t)return;const r={};for(let h=0;h<this._style.order.length;++h){const p=this._style._mergedLayers[this._style.order[h]],g=this._style.getLayerSourceCache(p);if(!g||r[g.id]||p.isHidden(this.painter.transform.zoom)||p.type!=="raster")continue;const y=p.paint.get("raster-fade-duration");for(const w of this.proxyCoords){const T=this.proxyToSource[w.key][g.id];if(T)for(const A of T){const M=Hu(g.getTile(A),g.findLoadedParent(A,0),g,this.painter.transform,y);(M.opacity!==1||M.mix!==0)&&this._clearRenderCacheForTile(g.id,A)}}}}_setupDrapedRenderBatches(){this._style.updateDrapeFirstLayers();const t=this._style.order,r=t.length;if(r===0)return;const h=[];this._pendingGroundEffectLayers=[];let p,g=0,y=this._style._mergedLayers[t[g]];for(;!this._style.isLayerDraped(y)&&y.isHidden(this.painter.transform.zoom)&&++g<r;)y=this._style._mergedLayers[t[g]];for(;g<r;++g){const w=this._style._mergedLayers[t[g]];w.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(w)?p===void 0&&(p=g):(w.type==="fill-extrusion"&&this._pendingGroundEffectLayers.push(g),p!==void 0&&(h.push({start:p,end:g-1}),p=void 0)))}if(p!==void 0&&h.push({start:p,end:g-1}),h.length!==0){const w=h[h.length-1];this._pendingGroundEffectLayers.every(T=>T>w.end)||s.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=h}_setupRenderCache(t){const r=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,r.renderCache.length>r.renderCachePool.length){const y=Object.values(r.proxyCachedFBO);r.proxyCachedFBO={};for(let w=0;w<y.length;++w){const T=Object.values(y[w]);r.renderCachePool.push(...T)}}return}this._clearRasterLayersFromRenderCache();const h=this.proxyCoords,p=this._tilesDirty;for(let y=h.length-1;y>=0;y--){const w=h[y];if(r.getTileByID(w.key),r.proxyCachedFBO[w.key]!==void 0){const T=t[w.key],A=this.proxyToSource[w.key];let M=0;for(const z in A){const L=A[z],D=T[z];if(!D||D.length!==L.length||L.some((N,B)=>N!==D[B]||p[z]&&p[z].hasOwnProperty(N.key))){M=-1;break}++M}for(const z in r.proxyCachedFBO[w.key])r.renderCache[r.proxyCachedFBO[w.key][z]].dirty=M<0||M!==Object.values(T).length}}const g=[...this._drapedRenderBatches];g.sort((y,w)=>w.end-w.start-(y.end-y.start));for(const y of g)for(const w of h){if(r.proxyCachedFBO[w.key])continue;let T=r.renderCachePool.pop();T===void 0&&r.renderCache.length<50&&(T=r.renderCache.length,r.renderCache.push(this._createFBO())),T!==void 0&&(r.proxyCachedFBO[w.key]={},r.proxyCachedFBO[w.key][y.start]=T,r.renderCache[T].dirty=!0)}this._tilesDirty={}}_setupStencil(t,r,h,p){if(!p||!this._sourceTilesOverlap[p.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const g=this.painter.context,y=g.gl;if(r.length<=1)return void(this._overlapStencilType=!1);let w;if(h.isTileClipped())w=r.length,this._overlapStencilMode.test={func:y.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(r[0].overscaledZ>r[r.length-1].overscaledZ))return void(this._overlapStencilType=!1);w=1,this._overlapStencilMode.test={func:y.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+w>255&&(g.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=w,this._overlapStencilMode.ref=this._stencilRef,h.isTileClipped()&&this._renderTileClippingMasks(r,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(t){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[t.key]),this._overlapStencilMode):Jt.disabled}_renderTileClippingMasks(t,r){const h=this.painter,p=this.painter.context,g=p.gl;h._tileClippingMaskIDs={},p.setColorMode(ai.disabled),p.setDepthMode(Dt.disabled);const y=h.getOrCreateProgram("clippingMask");for(const w of t){const T=h._tileClippingMaskIDs[w.key]=--r;y.draw(h,g.TRIANGLES,Dt.disabled,new Jt({func:g.ALWAYS,mask:0},T,255,g.KEEP,g.KEEP,g.REPLACE),ai.disabled,Yt.disabled,Gu(w.projMatrix),"$clipping",h.tileExtentBuffer,h.quadTriangleIndexBuffer,h.tileExtentSegments)}}pointCoordinate(t){const r=this.painter.transform;if(t.x<0||t.x>r.width||t.y<0||t.y>r.height)return null;const h=[t.x,t.y,1,1];s.aC(h,h,r.pixelMatrixInverse),s.cK(h,h,1/h[3]),h[0]/=r.worldSize,h[1]/=r.worldSize;const p=r._camera.position,g=s.cf(1,r.center.lat),y=[p[0],p[1],p[2]/g,0],w=s.da([],h.slice(0,3),y);s.aw(w,w);const T=this.raycast(y,w,this._exaggeration);return T!==null&&T?(s.bH(y,y,w,T),y[3]=y[2],y[2]*=g,y):null}_setupProxiedCoordsForOrtho(t,r,h){if(t.getSource()instanceof s.aU)return this._setupProxiedCoordsForImageSource(t,r,h);this._findCoveringTileCache[t.id]=this._findCoveringTileCache[t.id]||{};const p=this.proxiedCoords[t.id]=[],g=this.proxyCoords;for(let T=0;T<g.length;T++){const A=g[T],M=this._findTileCoveringTileID(A,t);if(M){const z=this._createProxiedId(A,M,h[A.key]&&h[A.key][t.id]);p.push(z),this.proxyToSource[A.key][t.id]=[z]}}let y=!1;const w=new Set;for(let T=0;T<r.length;T++){const A=t.getTile(r[T]);if(!A||!A.hasData())continue;const M=this._findTileCoveringTileID(A.tileID,this.proxySourceCache);if(M&&M.tileID.canonical.z!==A.tileID.canonical.z){const z=this.proxyToSource[M.tileID.key][t.id],L=this._createProxiedId(M.tileID,A,h[M.tileID.key]&&h[M.tileID.key][t.id]);z?z.splice(z.length-1,0,L):this.proxyToSource[M.tileID.key][t.id]=[L];const D=this.proxyToSource[M.tileID.key][t.id];w.has(D)||w.add(D),p.push(L),y=!0}}if(this._sourceTilesOverlap[t.id]=y,y&&this._debugParams.sortTilesHiZFirst)for(const T of w)T.sort((A,M)=>M.overscaledZ-A.overscaledZ)}_setupProxiedCoordsForImageSource(t,r,h){if(!t.getSource().loaded())return;const p=this.proxiedCoords[t.id]=[],g=this.proxyCoords,y=t.getSource(),w=y.tileID;if(!w)return;const T=new s.P(w.x,w.y)._div(1<<w.z),A=y.coordinates.map(s.ae.fromLngLat).reduce((z,L)=>(z.min.x=Math.min(z.min.x,L.x-T.x),z.min.y=Math.min(z.min.y,L.y-T.y),z.max.x=Math.max(z.max.x,L.x-T.x),z.max.y=Math.max(z.max.y,L.y-T.y),z),{min:new s.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new s.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),M=(z,L)=>{const D=z.wrap+z.canonical.x/(1<<z.canonical.z),N=z.canonical.y/(1<<z.canonical.z),B=s.al/(1<<z.canonical.z),G=L.wrap+L.canonical.x/(1<<L.canonical.z),$=L.canonical.y/(1<<L.canonical.z);return D+B<G+A.min.x||D>G+A.max.x||N+B<$+A.min.y||N>$+A.max.y};for(let z=0;z<g.length;z++){const L=g[z];for(let D=0;D<r.length;D++){const N=t.getTile(r[D]);if(!N||!N.hasData()||M(L,N.tileID))continue;const B=this._createProxiedId(L,N,h[L.key]&&h[L.key][t.id]),G=this.proxyToSource[L.key][t.id];G?G.push(B):this.proxyToSource[L.key][t.id]=[B],p.push(B)}}}_createProxiedId(t,r,h){let p=this.orthoMatrix;if(h){const g=h.find(y=>y.key===r.tileID.key);if(g)return g}if(r.tileID.key!==t.key){const g=t.canonical.z-r.tileID.canonical.z;let y,w,T;p=s.bC();const A=r.tileID.wrap-t.wrap<<t.overscaledZ;g>0?(y=s.al>>g,w=y*((r.tileID.canonical.x<<g)-t.canonical.x+A),T=y*((r.tileID.canonical.y<<g)-t.canonical.y)):(y=s.al<<-g,w=s.al*(r.tileID.canonical.x-(t.canonical.x+A<<-g)),T=s.al*(r.tileID.canonical.y-(t.canonical.y<<-g))),s.ce(p,0,y,0,y,0,1),s.br(p,p,[w,T,0])}return new Up(r.tileID,t.key,p)}_findTileCoveringTileID(t,r){let h=r.getTile(t);if(h&&h.hasData())return h;const p=this._findCoveringTileCache[r.id],g=p[t.key];if(h=g?r.getTileByID(g):null,h&&h.hasData()||g===null)return h;let y=h?h.tileID:t,w=y.overscaledZ;const T=r.getSource().minzoom,A=[];if(!g){const z=r.getSource().maxzoom;if(t.canonical.z>=z){const L=t.canonical.z-z;r.getSource().reparseOverscaled?(w=Math.max(t.canonical.z+2,r.transform.tileZoom),y=new s.aQ(w,t.wrap,z,t.canonical.x>>L,t.canonical.y>>L)):L!==0&&(w=z,y=new s.aQ(w,t.wrap,z,t.canonical.x>>L,t.canonical.y>>L))}y.key!==t.key&&(A.push(y.key),h=r.getTile(y))}const M=z=>{A.forEach(L=>{p[L]=z}),A.length=0};for(w-=1;w>=T&&(!h||!h.hasData());w--){h&&M(h.tileID.key);const z=y.calculateScaledKey(w);if(h=r.getTileByID(z),h&&h.hasData())break;const L=p[z];if(L===null)break;L===void 0?A.push(z):h=r.getTileByID(L)}return M(h?h.tileID.key:null),h&&h.hasData()?h:null}findDEMTileFor(t){return this.enabled?this._findTileCoveringTileID(t,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(t,r){let h=this._tilesDirty[t];h||(h=this._tilesDirty[t]={}),h[r.key]=!0}}function Mc(u,t,r){const h=function(w,T,A){const M=s.bJ(T,w),z=s.bJ(A,[.2126,.7152,.0722]),L=(N,B,G)=>(1-G)*N+G*B,D=L(1-.3*Math.min(z,1),1,Math.min(M+1,1));return L(.92,1,Math.asin(s.aA(T[2],-1,1))/Math.PI+.5)*D}(u,[0,0,1],t),p=[0,0,0];s.c5(p,r.slice(0,3),h);const g=[0,0,0];s.c5(g,t.slice(0,3),u[2]);const y=[0,0,0];return s.d8(y,p,g),s.db(y)}const Hv=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],qv=["stars","rainParticle","snowParticle","fillExtrusion","fillExtrusionGroundEffect","building","buildingBloom","elevatedStructures","model","symbol"];class Rg{static cacheKey(t,r,h,p){const g=[r];p&&g.push(p.cacheKey);for(const y of h)t.usedDefines.has(y)&&g.push(y);return g.join("/")}constructor(t,r,h,p,g,y){const w=t.gl;this.program=w.createProgram(),this.configuration=p,this.name=r,this.fixedDefines=[...y];const T=`#version 300 es
${(p?p.defines():[]).concat(y.map(B=>`#define ${B}`)).join(`
`)}`,A=[T,Ov];for(const B of h.fragmentIncludes)A.push(tl[B]);A.push(h.fragmentSource);const M=A.join(`
`),z=[T,wg];for(const B of h.vertexIncludes)z.push(tl[B]);this.forceManualRenderingForInstanceIDShaders=t.forceManualRenderingForInstanceIDShaders&&h.vertexSource.includes("gl_InstanceID"),this.forceManualRenderingForInstanceIDShaders&&z.push("uniform int u_instanceID;"),z.push(h.vertexSource);let L=z.join(`
`);this.forceManualRenderingForInstanceIDShaders&&(L=L.replaceAll("gl_InstanceID","u_instanceID"));const D=w.createShader(w.FRAGMENT_SHADER);if(w.isContextLost())return void(this.failedToCreate=!0);w.shaderSource(D,M),w.compileShader(D),w.attachShader(this.program,D);const N=w.createShader(w.VERTEX_SHADER);w.isContextLost()?this.failedToCreate=!0:(w.shaderSource(N,L),w.compileShader(N),w.attachShader(this.program,N),this.attributes={},w.linkProgram(this.program),w.deleteShader(N),w.deleteShader(D),this.fixedUniforms=g(t),this.fixedUniformsEntries=Object.entries(this.fixedUniforms),this.binderUniforms=p?p.getUniforms(t):[],this.forceManualRenderingForInstanceIDShaders&&(this.instancingUniforms=(B=>({u_instanceID:new s.ch(B)}))(t)),(y.includes("TERRAIN")||r.includes("symbol")||r.includes("circle"))&&(this.terrainUniforms=(B=>({u_dem:new s.ch(B),u_dem_prev:new s.ch(B),u_dem_tl:new s.ck(B),u_dem_scale:new s.cj(B),u_dem_tl_prev:new s.ck(B),u_dem_scale_prev:new s.cj(B),u_dem_size:new s.cj(B),u_dem_lerp:new s.cj(B),u_exaggeration:new s.cj(B),u_depth:new s.ch(B),u_depth_size_inv:new s.ck(B),u_depth_range_unpack:new s.ck(B),u_occluder_half_size:new s.cj(B),u_occlusion_depth_offset:new s.cj(B),u_meter_to_dem:new s.cj(B),u_label_plane_matrix_inv:new s.cl(B)}))(t)),y.includes("GLOBE")&&(this.globeUniforms=(B=>({u_tile_tl_up:new s.ci(B),u_tile_tr_up:new s.ci(B),u_tile_br_up:new s.ci(B),u_tile_bl_up:new s.ci(B),u_tile_up_scale:new s.cj(B)}))(t)),y.includes("FOG")&&(this.fogUniforms=(B=>({u_fog_matrix:new s.cl(B),u_fog_range:new s.ck(B),u_fog_color:new s.d3(B),u_fog_horizon_blend:new s.cj(B),u_fog_vertical_limit:new s.ck(B),u_fog_temporal_offset:new s.cj(B),u_frustum_tl:new s.ci(B),u_frustum_tr:new s.ci(B),u_frustum_br:new s.ci(B),u_frustum_bl:new s.ci(B),u_globe_pos:new s.ci(B),u_globe_radius:new s.cj(B),u_globe_transition:new s.cj(B),u_is_globe:new s.ch(B),u_viewport:new s.ck(B)}))(t)),y.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(B=>({u_cutoff_params:new s.d3(B)}))(t)),y.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(B=>({u_lighting_ambient_color:new s.ci(B),u_lighting_directional_dir:new s.ci(B),u_lighting_directional_color:new s.ci(B),u_ground_radiance:new s.ci(B)}))(t)),y.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(B=>({u_light_matrix_0:new s.cl(B),u_light_matrix_1:new s.cl(B),u_fade_range:new s.ck(B),u_shadow_normal_offset:new s.ci(B),u_shadow_intensity:new s.cj(B),u_shadow_texel_size:new s.cj(B),u_shadow_map_resolution:new s.cj(B),u_shadow_direction:new s.ci(B),u_shadow_bias:new s.ci(B),u_shadowmap_0:new s.ch(B),u_shadowmap_1:new s.ch(B)}))(t)))}getAttributeLocation(t,r){let h=this.attributes[r];return h===void 0&&(h=this.attributes[r]=t.getAttribLocation(this.program,r)),h}setTerrainUniformValues(t,r){if(!this.terrainUniforms)return;const h=this.terrainUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const p in r)h[p]&&h[p].set(this.program,p,r[p])}}setGlobeUniformValues(t,r){if(!this.globeUniforms)return;const h=this.globeUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const p in r)h[p]&&h[p].set(this.program,p,r[p])}}setFogUniformValues(t,r){if(!this.fogUniforms)return;const h=this.fogUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const p in r)h[p].set(this.program,p,r[p])}}setCutoffUniformValues(t,r){if(!this.cutoffUniforms)return;const h=this.cutoffUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const p in r)h[p].set(this.program,p,r[p])}}setLightsUniformValues(t,r){if(!this.lightsUniforms)return;const h=this.lightsUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const p in r)h[p].set(this.program,p,r[p])}}setShadowUniformValues(t,r){if(this.failedToCreate||!this.shadowUniforms)return;const h=this.shadowUniforms;t.program.set(this.program);for(const p in r)h[p].set(this.program,p,r[p])}_drawDebugWireframe(t,r,h,p,g,y,w,T,A,M){const z=t.options.wireframe;if(z.terrain===!1&&z.layers2D===!1&&z.layers3D===!1)return;const L=t.context;if(!(!(!z.terrain||this.name!=="terrainRaster"&&this.name!=="globeRaster")||!(!z.layers2D||t._terrain&&t._terrain.renderingToTexture||!Hv.includes(this.name))||!(!z.layers3D||!qv.includes(this.name))))return;const D=L.gl,N=t.wireframeDebugCache.getLinesFromTrianglesBuffer(t.frameCounter,g,L);if(!N)return;const B=[...this.fixedDefines,"DEBUG_WIREFRAME"],G=t.getOrCreateProgram(this.name,{config:this.configuration,defines:B});L.program.set(G.program);const $=(K,ue,oe)=>{if(ue[K]&&oe[K])for(const le in ue[K])oe[K][le]&&oe[K][le].set(oe.program,le,ue[K][le].current)};A&&A.setUniforms(G.program,L,G.binderUniforms,w,{zoom:T}),$("fixedUniforms",this,G),$("terrainUniforms",this,G),$("globeUniforms",this,G),$("fogUniforms",this,G),$("lightsUniforms",this,G),$("shadowUniforms",this,G),N.bind(),L.setColorMode(new ai([D.ONE,D.ONE_MINUS_SRC_ALPHA,D.ZERO,D.ONE],s.ao.transparent,[!0,!0,!0,!1])),L.setDepthMode(new Dt(r.func===D.LESS?D.LEQUAL:r.func,Dt.ReadOnly,r.range)),L.setStencilMode(Jt.disabled);const X=3*y.primitiveLength*2,J=3*y.primitiveOffset*2*2;if(this.forceManualRenderingForInstanceIDShaders){const K=M||1;for(let ue=0;ue<K;++ue)G.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",ue),D.drawElements(D.LINES,X,D.UNSIGNED_SHORT,J)}else M&&M>1?D.drawElementsInstanced(D.LINES,X,D.UNSIGNED_SHORT,J,M):D.drawElements(D.LINES,X,D.UNSIGNED_SHORT,J);g.bind(),L.program.set(this.program),L.setDepthMode(r),L.setStencilMode(h),L.setColorMode(p)}checkUniforms(t,r,h){if(this.fixedDefines.includes(r)){for(const p of Object.keys(h))if(!h[p].initialized)throw new Error(`Program '${this.name}', from draw '${t}': uniform ${p} not set but required by ${r} being defined`)}}draw(t,r,h,p,g,y,w,T,A,M,z,L,D,N,B,G){const $=t.context,X=$.gl;if(this.failedToCreate)return;$.program.set(this.program),$.setDepthMode(h),$.setStencilMode(p),$.setColorMode(g),$.setCullFace(y);for(const[re,te]of this.fixedUniformsEntries)te.set(this.program,re,w[re]);N&&N.setUniforms(this.program,$,this.binderUniforms,L,{zoom:D});const J={[X.POINTS]:1,[X.LINES]:2,[X.TRIANGLES]:3,[X.LINE_STRIP]:1}[r];this.checkUniforms(T,"RENDER_SHADOWS",this.shadowUniforms);const K=B||[],ue=N?N.getPaintVertexBuffers():[],oe=r===X.TRIANGLES&&M,le=G&&G>0?1:void 0;for(const re of z.get()){const te=re.vaos||(re.vaos={});if((te[T]||(te[T]=new Fv)).bind($,this,A,ue,M,re.vertexOffset,K,le),this.forceManualRenderingForInstanceIDShaders){const he=G||1;for(let we=0;we<he;++we)this.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",we),M?X.drawElements(r,re.primitiveLength*J,X.UNSIGNED_SHORT,re.primitiveOffset*J*2):X.drawArrays(r,re.vertexOffset,re.vertexLength)}else G&&G>1?X.drawElementsInstanced(r,re.primitiveLength*J,X.UNSIGNED_SHORT,re.primitiveOffset*J*2,G):M?X.drawElements(r,re.primitiveLength*J,X.UNSIGNED_SHORT,re.primitiveOffset*J*2):X.drawArrays(r,re.vertexOffset,re.vertexLength);oe&&this._drawDebugWireframe(t,h,p,g,M,re,L,D,N,G)}}}function kg(u,t,r=0){const h=Math.pow(2,t.tileID.overscaledZ),p=t.tileSize*Math.pow(2,u.transform.tileZoom)/h,g=p*(t.tileID.canonical.x+t.tileID.wrap*h),y=p*t.tileID.canonical.y;return{u_image:0,u_texsize:t.imageAtlasTexture?t.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/s.ay(t,1,u.transform.tileZoom),u_pixel_coord_upper:[g>>16,y>>16],u_pixel_coord_lower:[65535&g,65535&y],u_pattern_transition:r}}const vd={terrain:0,flat:1},Wv=s.bC(),xd=(u,t,r,h,p,g,y,w,T,A,M,z,L,D,N,B,G,$)=>{const X=t.style.light,J=X.properties.get("position"),K=[J.x,J.y,J.z],ue=s.dO();X.properties.get("anchor")==="viewport"&&(s.dP(ue,-t.transform.angle),s.dQ(K,K,ue));const oe=X.properties.get("color").toPremultipliedRenderColor(null),le=t.transform,re={u_matrix:u,u_lightpos:K,u_lightintensity:X.properties.get("intensity"),u_lightcolor:[oe.r,oe.g,oe.b],u_vertical_gradient:+r,u_opacity:h,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Wv,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_height_type:vd[A],u_base_type:vd[M],u_ao:p,u_edge_radius:g,u_width_scale:y,u_flood_light_color:N,u_vertical_scale:B,u_flood_light_intensity:G,u_ground_shadow_factor:$};return le.projection.name==="globe"&&(re.u_tile_id=[w.canonical.x,w.canonical.y,1<<w.canonical.z],re.u_zoom_transition=z,re.u_inv_rot_matrix=D,re.u_merc_center=L,re.u_up_dir=le.projection.upVector(new s.cD(0,0,0),L[0]*s.al,L[1]*s.al),re.u_height_lift=T),re},$p=(u,t,r,h,p,g)=>({u_matrix:u,u_edge_radius:t,u_width_scale:r,u_vertical_scale:h,u_height_type:vd[p],u_base_type:vd[g]}),Lg=(u,t,r,h,p,g,y,w,T,A,M,z,L,D,N,B,G,$)=>{const X=xd(u,t,r,h,p,g,y,w,A,M,z,L,D,N,B,G,1,[0,0,0]),J={u_height_factor:-Math.pow(2,w.overscaledZ)/T.tileSize/8};return Object.assign(X,kg(t,T,$),J)},Rc=(u,t,r,h,p,g,y,w,T,A,M)=>({u_matrix:t,u_opacity:r,u_ao_pass:h?1:0,u_meter_to_tile:p,u_ao:g,u_flood_light_intensity:y,u_flood_light_color:w,u_attenuation:T,u_edge_radius:A,u_fb:0,u_fb_size:M,u_dynamic_offset:1}),Gp=(u,t,r)=>({u_matrix:u,u_emissive_strength:t,u_ground_shadow_factor:r}),Hp=(u,t,r,h,p,g=0)=>Object.assign(Gp(u,t,p),kg(r,h,g)),zg=(u,t,r,h)=>({u_matrix:u,u_world:r,u_emissive_strength:t,u_ground_shadow_factor:h}),qp=(u,t,r,h,p,g,y=0)=>Object.assign(Hp(u,t,r,h,g,y),{u_world:p}),nl=(u,t)=>({u_matrix:u,u_ground_shadow_factor:t}),Ul=(u,t,r,h,p)=>({u_matrix:u,u_camera_pos:[t[0],t[1],t[2]],u_depth_bias:r,u_height_scale:h,u_reset_depth:p}),wd=(u,t,r,h,p,g,y,w,T)=>({u_matrix:u,u_normal_matrix:t,u_opacity:r,u_faux_facade_ao_intensity:h,u_camera_pos:p,u_tile_to_meter:g,u_facade_emissive_chance:y,u_flood_light_color:w,u_flood_light_intensity:T}),Dg=u=>({u_matrix:u}),rl=u=>({u_matrix:u}),Wp=(u,t,r,h,p,g,y,w)=>{const T=s.al/g.tileSize;return{u_matrix:u,u_inv_rot_matrix:t,u_camera_to_center_distance:r.getCameraToCenterDistance(w),u_extrude_scale:[r.pixelsToGLUnits[0]/T,r.pixelsToGLUnits[1]/T],u_zoom_transition:h,u_tile_id:y,u_merc_center:p}},qu=(u,t,r=1)=>({u_matrix:u,u_color:t,u_overlay:0,u_overlay_scale:r}),Og=s.bC(),Fg=(u,t,r,h,p,g,y)=>{const w=u.transform,T=w.projection.name==="globe",A=T?s.dR(w.zoom,t.canonical)*w._pixelsPerMercatorPixel:s.ay(r,1,g),M={u_matrix:t.projMatrix,u_extrude_scale:A,u_intensity:y,u_inv_rot_matrix:Og,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(T){M.u_inv_rot_matrix=h,M.u_merc_center=p,M.u_tile_id=[t.canonical.x,t.canonical.y,1<<t.canonical.z],M.u_zoom_transition=s.aj(w.zoom);const z=p[0]*s.al,L=p[1]*s.al;M.u_up_dir=w.projection.upVector(new s.cD(0,0,0),z,L)}return M};function bd(u,[t,r,h,p],[g,y]){if(g===y)return[0,0,0,0];const w=255*(u-1)/(u*(y-g));return[t*w,r*w,h*w,p*w]}function Td(u,t,[r,h]){return r===h?0:.5/u+(t-r)*(u-1)/(u*(h-r))}const Bg=(u,t,r,h,p,g,y,w,T,A,M,z,L,D,N,B,G,$,X,J,K)=>({u_matrix:u,u_normalize_matrix:t,u_globe_matrix:r,u_merc_matrix:h,u_grid_matrix:p,u_tl_parent:g,u_scale_parent:A,u_fade_t:M.mix,u_opacity:M.opacity*z.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:z.paint.get("raster-brightness-min"),u_brightness_high:z.paint.get("raster-brightness-max"),u_saturation_factor:s.dT(z.paint.get("raster-saturation")),u_contrast_factor:s.dS(z.paint.get("raster-contrast")),u_spin_weights:Ng(z.paint.get("raster-hue-rotate")),u_perspective_transform:L,u_raster_elevation:D,u_zoom_transition:y,u_merc_center:w,u_cutoff_params:T,u_colorization_mix:bd(s.dU,B,$),u_colorization_offset:Td(s.dU,G,$),u_color_ramp:N,u_texture_offset:[J/(X+2*J),X/(X+2*J)],u_texture_res:[X+2*J,X+2*J],u_emissive_strength:K});function Ng(u){u*=Math.PI/180;const t=Math.sin(u),r=Math.cos(u);return[(2*r+1)/3,(-Math.sqrt(3)*t-r+1)/3,(Math.sqrt(3)*t-r+1)/3]}const Vs=.05,Zv=(u,t,r,h,p,g,y,w,T,A,M,z)=>({u_matrix:u,u_normalize_matrix:t,u_globe_matrix:r,u_merc_matrix:h,u_grid_matrix:p,u_tl_parent:g,u_scale_parent:A,u_fade_t:M.mix,u_opacity:M.opacity,u_image0:0,u_image1:1,u_raster_elevation:z,u_zoom_transition:y,u_merc_center:w,u_cutoff_params:T}),Xv=(u,t,r,h,p,g,y,w,T,A)=>({u_particle_texture:u,u_particle_texture_side_len:t,u_tile_offset:r,u_velocity:h,u_color_ramp:g,u_velocity_res:p,u_max_speed:y,u_uv_offset:w,u_data_scale:[255*T[0],255*T[1]],u_data_offset:A,u_particle_pos_scale:1.1,u_particle_pos_offset:[Vs,Vs]}),jg=(u,t,r,h,p,g,y,w,T,A)=>({u_particle_texture:u,u_particle_texture_side_len:t,u_velocity:r,u_velocity_res:h,u_max_speed:p,u_speed_factor:g,u_reset_rate:y,u_rand_seed:Math.random(),u_uv_offset:w,u_data_scale:[255*T[0],255*T[1]],u_data_offset:A,u_particle_pos_scale:1.1,u_particle_pos_offset:[Vs,Vs]}),Ug=s.bC(),Sd=(u,t,r,h,p,g,y,w,T,A,M,z,L,D,N,B,G,$,X,J,K,ue,oe,le)=>{const re=p.transform,te={u_is_size_zoom_constant:+(u==="constant"||u==="source"),u_is_size_feature_constant:+(u==="constant"||u==="camera"),u_size_t:t?t.uSizeT:0,u_size:t?t.uSize:0,u_camera_to_center_distance:re.getCameraToCenterDistance(X),u_rotate_symbol:+r,u_aspect_ratio:re.width/re.height,u_fade_change:p.options.fadeDuration?p.symbolFadeChange:1,u_matrix:g,u_label_plane_matrix:y,u_coord_matrix:w,u_is_text:+A,u_elevation_from_sea:T?1:0,u_pitch_with_map:+h,u_texsize:M,u_texsize_icon:z,u_texture:0,u_texture_icon:1,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Ug,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:Ug,u_up_vector:[0,-1,0],u_color_adj_mat:ue,u_icon_transition:oe||0,u_gamma_scale:h?p.transform.getCameraToCenterDistance(X)*Math.cos(p.terrain?0:p.transform._pitch):1,u_device_pixel_ratio:s.o.devicePixelRatio,u_is_halo:1,u_scale_factor:le||1,u_ground_shadow_factor:J,u_inv_matrix:s.bl(s.bC(),y),u_normal_scale:K,u_lutTexture:Cr.LUT};return X.name==="globe"&&(te.u_tile_id=[D.canonical.x,D.canonical.y,1<<D.canonical.z],te.u_zoom_transition=N,te.u_inv_rot_matrix=G,te.u_merc_center=B,te.u_camera_forward=re._camera.forward(),te.u_ecef_origin=s.dV(re.globeMatrix,D.toUnwrapped()),te.u_tile_matrix=Float32Array.from(re.globeMatrix),te.u_up_vector=$),te},Wu=(u,t,r,h)=>({u_matrix:u,u_emissive_strength:t,u_opacity:r,u_color:h}),ol=(u,t,r,h,p,g,y,w,T)=>Object.assign(function(A,M,z,L,D,N){const{width:B,height:G}=L.imageManager.getPixelSize(M),$=Math.pow(2,N.tileID.overscaledZ),X=N.tileSize*Math.pow(2,L.transform.tileZoom)/$,J=X*(N.tileID.canonical.x+N.tileID.wrap*$),K=X*N.tileID.canonical.y;return{u_image:0,u_pattern_tl:z.tl,u_pattern_br:z.br,u_texsize:[B,G],u_pattern_size:z.displaySize,u_pattern_units_to_pixels:D?[L.transform.width,-1*L.transform.height]:[1/s.ay(N,1,L.transform.tileZoom),1/s.ay(N,1,L.transform.tileZoom)],u_pixel_coord_upper:[J>>16,K>>16],u_pixel_coord_lower:[65535&J,65535&K]}}(0,g,y,h,w,T),{u_matrix:u,u_emissive_strength:t,u_opacity:r}),kc=new Float32Array(s.bA([])),Vl=(u,t,r,h,p,g,y,w,T,A,M,z,L,D=[0,0,0],N,B,G)=>{const $=p.style.light,X=$.properties.get("position"),J=[-X.x,-X.y,X.z],K=s.dO();$.properties.get("anchor")==="viewport"&&(s.dP(K,-p.transform.angle),s.dQ(J,J,K));const ue=M.alphaMode==="MASK",oe=$.properties.get("color").toNonPremultipliedRenderColor(null),le=L.paint.get("model-ambient-occlusion-intensity"),re=L.paint.get("model-color").constantOr(s.ao.white).toNonPremultipliedRenderColor(null);return re.a=L.paint.get("model-color-mix-intensity").constantOr(0),G&&(re.r=G[0],re.g=G[1],re.b=G[2],re.a=G[3]),B&&(re.r=B.color.r,re.g=B.color.g,re.b=B.color.b,re.a=B.colorMix,z=B.emissionStrength,g*=B.opacity),{u_matrix:u,u_lighting_matrix:t,u_normal_matrix:r,u_node_matrix:h||kc,u_lightpos:J,u_lightintensity:$.properties.get("intensity"),u_lightcolor:[oe.r,oe.g,oe.b],u_camera_pos:D,u_opacity:g,u_baseTextureIsAlpha:0,u_alphaMask:+ue,u_alphaCutoff:M.alphaCutoff,u_baseColorFactor:y.toNonPremultipliedRenderColor(null).toArray01(),u_emissiveFactor:w.toNonPremultipliedRenderColor(null).toArray01(),u_metallicFactor:T,u_roughnessFactor:A,u_baseColorTexture:Cr.BaseColor,u_metallicRoughnessTexture:Cr.MetallicRoughness,u_normalTexture:Cr.Normal,u_occlusionTexture:Cr.Occlusion,u_emissionTexture:Cr.Emission,u_lutTexture:Cr.LUT,u_color_mix:re.toArray01(),u_aoIntensity:le,u_emissive_strength:z,u_occlusionTextureTransform:N||[0,0,0,0]}},Zp=(u,t=kc,r=kc)=>({u_matrix:u,u_instance:t,u_node_matrix:r}),Ed={fillExtrusion:u=>({u_matrix:new s.cl(u),u_lightpos:new s.ci(u),u_lightintensity:new s.cj(u),u_lightcolor:new s.ci(u),u_vertical_gradient:new s.cj(u),u_opacity:new s.cj(u),u_edge_radius:new s.cj(u),u_width_scale:new s.cj(u),u_ao:new s.ck(u),u_height_type:new s.ch(u),u_base_type:new s.ch(u),u_tile_id:new s.ci(u),u_zoom_transition:new s.cj(u),u_inv_rot_matrix:new s.cl(u),u_merc_center:new s.ck(u),u_up_dir:new s.ci(u),u_height_lift:new s.cj(u),u_flood_light_color:new s.ci(u),u_vertical_scale:new s.cj(u),u_flood_light_intensity:new s.cj(u),u_ground_shadow_factor:new s.ci(u)}),fillExtrusionDepth:u=>({u_matrix:new s.cl(u),u_edge_radius:new s.cj(u),u_width_scale:new s.cj(u),u_vertical_scale:new s.cj(u),u_height_type:new s.ch(u),u_base_type:new s.ch(u)}),fillExtrusionPattern:u=>({u_matrix:new s.cl(u),u_lightpos:new s.ci(u),u_lightintensity:new s.cj(u),u_lightcolor:new s.ci(u),u_vertical_gradient:new s.cj(u),u_height_factor:new s.cj(u),u_edge_radius:new s.cj(u),u_width_scale:new s.cj(u),u_ao:new s.ck(u),u_height_type:new s.ch(u),u_base_type:new s.ch(u),u_tile_id:new s.ci(u),u_zoom_transition:new s.cj(u),u_inv_rot_matrix:new s.cl(u),u_merc_center:new s.ck(u),u_up_dir:new s.ci(u),u_height_lift:new s.cj(u),u_image:new s.ch(u),u_texsize:new s.ck(u),u_pixel_coord_upper:new s.ck(u),u_pixel_coord_lower:new s.ck(u),u_tile_units_to_pixels:new s.cj(u),u_opacity:new s.cj(u),u_pattern_transition:new s.cj(u)}),fillExtrusionGroundEffect:u=>({u_matrix:new s.cl(u),u_opacity:new s.cj(u),u_ao_pass:new s.cj(u),u_meter_to_tile:new s.cj(u),u_ao:new s.ck(u),u_flood_light_intensity:new s.cj(u),u_flood_light_color:new s.ci(u),u_attenuation:new s.cj(u),u_edge_radius:new s.cj(u),u_fb:new s.ch(u),u_fb_size:new s.cj(u),u_dynamic_offset:new s.cj(u)}),fill:u=>({u_matrix:new s.cl(u),u_emissive_strength:new s.cj(u),u_ground_shadow_factor:new s.ci(u)}),fillPattern:u=>({u_matrix:new s.cl(u),u_emissive_strength:new s.cj(u),u_image:new s.ch(u),u_texsize:new s.ck(u),u_pixel_coord_upper:new s.ck(u),u_pixel_coord_lower:new s.ck(u),u_tile_units_to_pixels:new s.cj(u),u_ground_shadow_factor:new s.ci(u),u_pattern_transition:new s.cj(u)}),fillOutline:u=>({u_matrix:new s.cl(u),u_emissive_strength:new s.cj(u),u_world:new s.ck(u),u_ground_shadow_factor:new s.ci(u)}),fillOutlinePattern:u=>({u_matrix:new s.cl(u),u_emissive_strength:new s.cj(u),u_world:new s.ck(u),u_image:new s.ch(u),u_texsize:new s.ck(u),u_pixel_coord_upper:new s.ck(u),u_pixel_coord_lower:new s.ck(u),u_tile_units_to_pixels:new s.cj(u),u_ground_shadow_factor:new s.ci(u),u_pattern_transition:new s.cj(u)}),building:u=>({u_matrix:new s.cl(u),u_normal_matrix:new s.cl(u),u_opacity:new s.cj(u),u_faux_facade_ao_intensity:new s.cj(u),u_camera_pos:new s.ci(u),u_tile_to_meter:new s.cj(u),u_facade_emissive_chance:new s.cj(u),u_flood_light_color:new s.ci(u),u_flood_light_intensity:new s.cj(u)}),buildingBloom:u=>({u_matrix:new s.cl(u)}),buildingDepth:u=>({u_matrix:new s.cl(u)}),elevatedStructuresDepth:u=>({u_matrix:new s.cl(u),u_depth_bias:new s.cj(u)}),elevatedStructures:u=>({u_matrix:new s.cl(u),u_ground_shadow_factor:new s.ci(u)}),elevatedStructuresDepthReconstruct:u=>({u_matrix:new s.cl(u),u_camera_pos:new s.ci(u),u_depth_bias:new s.cj(u),u_height_scale:new s.cj(u),u_reset_depth:new s.cj(u)}),circle:s.dY,collisionBox:u=>({u_matrix:new s.cl(u),u_inv_rot_matrix:new s.cl(u),u_camera_to_center_distance:new s.cj(u),u_extrude_scale:new s.ck(u),u_zoom_transition:new s.cj(u),u_merc_center:new s.ck(u),u_tile_id:new s.ci(u)}),collisionCircle:u=>({u_matrix:new s.cl(u),u_inv_matrix:new s.cl(u),u_camera_to_center_distance:new s.cj(u),u_viewport_size:new s.ck(u)}),debug:u=>({u_color:new s.dB(u),u_matrix:new s.cl(u),u_overlay:new s.ch(u),u_overlay_scale:new s.cj(u)}),clippingMask:u=>({u_matrix:new s.cl(u)}),heatmap:u=>({u_extrude_scale:new s.cj(u),u_intensity:new s.cj(u),u_matrix:new s.cl(u),u_inv_rot_matrix:new s.cl(u),u_merc_center:new s.ck(u),u_tile_id:new s.ci(u),u_zoom_transition:new s.cj(u),u_up_dir:new s.ci(u)}),heatmapTexture:u=>({u_image:new s.ch(u),u_color_ramp:new s.ch(u),u_opacity:new s.cj(u)}),hillshade:u=>({u_matrix:new s.cl(u),u_image:new s.ch(u),u_latrange:new s.ck(u),u_light:new s.ck(u),u_shadow:new s.dB(u),u_highlight:new s.dB(u),u_emissive_strength:new s.cj(u),u_accent:new s.dB(u)}),hillshadePrepare:u=>({u_matrix:new s.cl(u),u_image:new s.ch(u),u_dimension:new s.ck(u),u_zoom:new s.cj(u)}),line:s.dX,linePattern:s.dW,raster:u=>({u_matrix:new s.cl(u),u_normalize_matrix:new s.cl(u),u_globe_matrix:new s.cl(u),u_merc_matrix:new s.cl(u),u_grid_matrix:new s.dC(u),u_tl_parent:new s.ck(u),u_scale_parent:new s.cj(u),u_fade_t:new s.cj(u),u_opacity:new s.cj(u),u_image0:new s.ch(u),u_image1:new s.ch(u),u_brightness_low:new s.cj(u),u_brightness_high:new s.cj(u),u_saturation_factor:new s.cj(u),u_contrast_factor:new s.cj(u),u_spin_weights:new s.ci(u),u_perspective_transform:new s.ck(u),u_raster_elevation:new s.cj(u),u_zoom_transition:new s.cj(u),u_merc_center:new s.ck(u),u_cutoff_params:new s.d3(u),u_colorization_mix:new s.d3(u),u_colorization_offset:new s.cj(u),u_color_ramp:new s.ch(u),u_texture_offset:new s.ck(u),u_texture_res:new s.ck(u),u_emissive_strength:new s.cj(u)}),rasterParticle:u=>({u_matrix:new s.cl(u),u_normalize_matrix:new s.cl(u),u_globe_matrix:new s.cl(u),u_merc_matrix:new s.cl(u),u_grid_matrix:new s.dC(u),u_tl_parent:new s.ck(u),u_scale_parent:new s.cj(u),u_fade_t:new s.cj(u),u_opacity:new s.cj(u),u_image0:new s.ch(u),u_image1:new s.ch(u),u_raster_elevation:new s.cj(u),u_zoom_transition:new s.cj(u),u_merc_center:new s.ck(u),u_cutoff_params:new s.d3(u)}),rasterParticleTexture:u=>({u_texture:new s.ch(u),u_opacity:new s.cj(u)}),rasterParticleDraw:u=>({u_particle_texture:new s.ch(u),u_particle_texture_side_len:new s.cj(u),u_tile_offset:new s.ck(u),u_velocity:new s.ch(u),u_color_ramp:new s.ch(u),u_velocity_res:new s.ck(u),u_max_speed:new s.cj(u),u_uv_offset:new s.ck(u),u_data_scale:new s.ck(u),u_data_offset:new s.cj(u),u_particle_pos_scale:new s.cj(u),u_particle_pos_offset:new s.ck(u)}),rasterParticleUpdate:u=>({u_particle_texture:new s.ch(u),u_particle_texture_side_len:new s.cj(u),u_velocity:new s.ch(u),u_velocity_res:new s.ck(u),u_max_speed:new s.cj(u),u_speed_factor:new s.cj(u),u_reset_rate:new s.cj(u),u_rand_seed:new s.cj(u),u_uv_offset:new s.ck(u),u_data_scale:new s.ck(u),u_data_offset:new s.cj(u),u_particle_pos_scale:new s.cj(u),u_particle_pos_offset:new s.ck(u)}),symbol:u=>({u_is_size_zoom_constant:new s.ch(u),u_is_size_feature_constant:new s.ch(u),u_size_t:new s.cj(u),u_size:new s.cj(u),u_camera_to_center_distance:new s.cj(u),u_rotate_symbol:new s.ch(u),u_aspect_ratio:new s.cj(u),u_fade_change:new s.cj(u),u_matrix:new s.cl(u),u_label_plane_matrix:new s.cl(u),u_coord_matrix:new s.cl(u),u_is_text:new s.ch(u),u_elevation_from_sea:new s.ch(u),u_pitch_with_map:new s.ch(u),u_texsize:new s.ck(u),u_texsize_icon:new s.ck(u),u_texture:new s.ch(u),u_texture_icon:new s.ch(u),u_gamma_scale:new s.cj(u),u_device_pixel_ratio:new s.cj(u),u_tile_id:new s.ci(u),u_zoom_transition:new s.cj(u),u_inv_rot_matrix:new s.cl(u),u_merc_center:new s.ck(u),u_camera_forward:new s.ci(u),u_tile_matrix:new s.cl(u),u_up_vector:new s.ci(u),u_ecef_origin:new s.ci(u),u_is_halo:new s.ch(u),u_icon_transition:new s.cj(u),u_color_adj_mat:new s.cl(u),u_scale_factor:new s.cj(u),u_ground_shadow_factor:new s.ci(u),u_inv_matrix:new s.cl(u),u_normal_scale:new s.cj(u),u_lutTexture:new s.ch(u)}),background:u=>({u_matrix:new s.cl(u),u_emissive_strength:new s.cj(u),u_opacity:new s.cj(u),u_color:new s.dB(u)}),backgroundPattern:u=>({u_matrix:new s.cl(u),u_emissive_strength:new s.cj(u),u_opacity:new s.cj(u),u_image:new s.ch(u),u_pattern_tl:new s.ck(u),u_pattern_br:new s.ck(u),u_texsize:new s.ck(u),u_pattern_size:new s.ck(u),u_pixel_coord_upper:new s.ck(u),u_pixel_coord_lower:new s.ck(u),u_pattern_units_to_pixels:new s.ck(u)}),terrainRaster:u=>({u_matrix:new s.cl(u),u_image0:new s.ch(u),u_image1:new s.ch(u),u_skirt_height:new s.cj(u),u_ground_shadow_factor:new s.ci(u),u_emissive_texture_available:new s.cj(u)}),skybox:u=>({u_matrix:new s.cl(u),u_sun_direction:new s.ci(u),u_cubemap:new s.ch(u),u_opacity:new s.cj(u),u_temporal_offset:new s.cj(u)}),skyboxGradient:u=>({u_matrix:new s.cl(u),u_color_ramp:new s.ch(u),u_center_direction:new s.ci(u),u_radius:new s.cj(u),u_opacity:new s.cj(u),u_temporal_offset:new s.cj(u)}),skyboxCapture:u=>({u_matrix_3f:new s.dC(u),u_sun_direction:new s.ci(u),u_sun_intensity:new s.cj(u),u_color_tint_r:new s.d3(u),u_color_tint_m:new s.d3(u),u_luminance:new s.cj(u)}),globeRaster:u=>({u_proj_matrix:new s.cl(u),u_globe_matrix:new s.cl(u),u_normalize_matrix:new s.cl(u),u_merc_matrix:new s.cl(u),u_zoom_transition:new s.cj(u),u_merc_center:new s.ck(u),u_image0:new s.ch(u),u_image1:new s.ch(u),u_grid_matrix:new s.dC(u),u_skirt_height:new s.cj(u),u_far_z_cutoff:new s.cj(u),u_frustum_tl:new s.ci(u),u_frustum_tr:new s.ci(u),u_frustum_br:new s.ci(u),u_frustum_bl:new s.ci(u),u_globe_pos:new s.ci(u),u_globe_radius:new s.cj(u),u_viewport:new s.ck(u),u_emissive_texture_available:new s.cj(u)}),globeAtmosphere:u=>({u_frustum_tl:new s.ci(u),u_frustum_tr:new s.ci(u),u_frustum_br:new s.ci(u),u_frustum_bl:new s.ci(u),u_horizon:new s.cj(u),u_transition:new s.cj(u),u_fadeout_range:new s.cj(u),u_atmosphere_fog_color:new s.d3(u),u_high_color:new s.d3(u),u_space_color:new s.d3(u),u_temporal_offset:new s.cj(u),u_horizon_angle:new s.cj(u)}),model:u=>({u_matrix:new s.cl(u),u_lighting_matrix:new s.cl(u),u_normal_matrix:new s.cl(u),u_node_matrix:new s.cl(u),u_lightpos:new s.ci(u),u_lightintensity:new s.cj(u),u_lightcolor:new s.ci(u),u_camera_pos:new s.ci(u),u_opacity:new s.cj(u),u_baseColorFactor:new s.d3(u),u_emissiveFactor:new s.d3(u),u_metallicFactor:new s.cj(u),u_roughnessFactor:new s.cj(u),u_baseTextureIsAlpha:new s.ch(u),u_alphaMask:new s.ch(u),u_alphaCutoff:new s.cj(u),u_baseColorTexture:new s.ch(u),u_metallicRoughnessTexture:new s.ch(u),u_normalTexture:new s.ch(u),u_occlusionTexture:new s.ch(u),u_emissionTexture:new s.ch(u),u_lutTexture:new s.ch(u),u_color_mix:new s.d3(u),u_aoIntensity:new s.cj(u),u_emissive_strength:new s.cj(u),u_occlusionTextureTransform:new s.d3(u)}),modelDepth:u=>({u_matrix:new s.cl(u),u_instance:new s.cl(u),u_node_matrix:new s.cl(u)}),groundShadow:u=>({u_matrix:new s.cl(u),u_ground_shadow_factor:new s.ci(u)}),stars:u=>({u_matrix:new s.cl(u),u_up:new s.ci(u),u_right:new s.ci(u),u_intensity_multiplier:new s.cj(u)}),snowParticle:u=>({u_modelview:new s.cl(u),u_projection:new s.cl(u),u_time:new s.cj(u),u_cam_pos:new s.ci(u),u_velocityConeAperture:new s.cj(u),u_velocity:new s.cj(u),u_horizontalOscillationRadius:new s.cj(u),u_horizontalOscillationRate:new s.cj(u),u_boxSize:new s.cj(u),u_billboardSize:new s.cj(u),u_simpleShapeParameters:new s.ck(u),u_screenSize:new s.ck(u),u_thinningCenterPos:new s.ck(u),u_thinningShape:new s.ci(u),u_thinningAffectedRatio:new s.cj(u),u_thinningParticleOffset:new s.cj(u),u_particleColor:new s.d3(u),u_direction:new s.ci(u)}),rainParticle:u=>({u_modelview:new s.cl(u),u_projection:new s.cl(u),u_time:new s.cj(u),u_cam_pos:new s.ci(u),u_texScreen:new s.ch(u),u_velocityConeAperture:new s.cj(u),u_velocity:new s.cj(u),u_boxSize:new s.cj(u),u_rainDropletSize:new s.ck(u),u_distortionStrength:new s.cj(u),u_rainDirection:new s.ci(u),u_color:new s.d3(u),u_screenSize:new s.ck(u),u_thinningCenterPos:new s.ck(u),u_thinningShape:new s.ci(u),u_thinningAffectedRatio:new s.cj(u),u_thinningParticleOffset:new s.cj(u),u_shapeDirectionalPower:new s.cj(u),u_shapeNormalPower:new s.cj(u),u_mode:new s.cj(u)}),vignette:u=>({u_vignetteShape:new s.ci(u),u_vignetteColor:new s.d3(u)}),occlusion:u=>({u_matrix:new s.cl(u),u_anchorPos:new s.ci(u),u_screenSizePx:new s.ck(u),u_occluderSizePx:new s.ck(u),u_color:new s.d3(u)})};class vs{constructor(t,r,h,p){this.id=vs.uniqueIdxCounter,vs.uniqueIdxCounter++,this.context=t;const g=t.gl;this.buffer=g.createBuffer(),this.dynamicDraw=!!h,this.context.unbindVAO(),t.bindElementBuffer.set(this.buffer),g.bufferData(g.ELEMENT_ARRAY_BUFFER,r.arrayBuffer,this.dynamicDraw?g.DYNAMIC_DRAW:g.STATIC_DRAW),this.dynamicDraw||p||r.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(t){this.id=vs.uniqueIdxCounter,vs.uniqueIdxCounter++;const r=this.context.gl;this.context.unbindVAO(),this.bind(),r.bufferSubData(r.ELEMENT_ARRAY_BUFFER,0,t.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}vs.uniqueIdxCounter=0;const Xp={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class Vg{constructor(t,r,h,p,g,y){this.length=r.length,this.attributes=h,this.itemSize=r.bytesPerElement,this.dynamicDraw=p,this.instanceCount=y,this.context=t;const w=t.gl;this.buffer=w.createBuffer(),t.bindVertexBuffer.set(this.buffer),w.bufferData(w.ARRAY_BUFFER,r.arrayBuffer,this.dynamicDraw?w.DYNAMIC_DRAW:w.STATIC_DRAW),this.dynamicDraw||g||r.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(t){const r=this.context.gl;this.bind(),r.bufferSubData(r.ARRAY_BUFFER,0,t.arrayBuffer)}enableAttributes(t,r){for(let h=0;h<this.attributes.length;h++){const p=r.getAttributeLocation(t,this.attributes[h].name);p!==-1&&t.enableVertexAttribArray(p)}}setVertexAttribPointers(t,r,h){for(let p=0;p<this.attributes.length;p++){const g=this.attributes[p],y=r.getAttributeLocation(t,g.name);y!==-1&&t.vertexAttribPointer(y,g.components,t[Xp[g.type]],!1,this.itemSize,g.offset+this.itemSize*(h||0))}}setVertexAttribDivisor(t,r,h){for(let p=0;p<this.attributes.length;p++){const g=r.getAttributeLocation(t,this.attributes[p].name);g!==-1&&this.instanceCount&&this.instanceCount>0&&t.vertexAttribDivisor(g,h)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class $g{constructor(t,r,h,p,g){this.context=t,this.width=r,this.height=h;const y=this.framebuffer=t.gl.createFramebuffer();p>0&&(this.colorAttachment0=new pd(t,y,0)),p>1&&(this.colorAttachment1=new pd(t,y,1)),g&&(this.depthAttachmentType=g,this.depthAttachment=g==="renderbuffer"?new Cc(t,y):new Vu(t,y))}createColorAttachment(t,r){r===0?this.colorAttachment0=new pd(t,this.framebuffer,0):r===1&&(this.colorAttachment1=new pd(t,this.framebuffer,1))}removeColorAttachment(t,r){const h=this.context.gl;let p;r===0?(p=this.colorAttachment0.get(),this.colorAttachment0=void 0):r===1&&(p=this.colorAttachment1.get(),this.colorAttachment1=void 0),p&&h.deleteTexture(p)}destroy(){const t=this.context.gl;if(this.colorAttachment0){const r=this.colorAttachment0.get();r&&t.deleteTexture(r)}if(this.colorAttachment1){const r=this.colorAttachment1.get();r&&t.deleteTexture(r)}if(this.depthAttachment&&this.depthAttachmentType)if(this.depthAttachmentType==="renderbuffer"){const r=this.depthAttachment.get();r&&t.deleteRenderbuffer(r)}else{const r=this.depthAttachment.get();r&&t.deleteTexture(r)}t.deleteFramebuffer(this.framebuffer)}}class Lc{constructor(t,r){this.gl=t,this.clearColor=new Uv(this),this.clearDepth=new bg(this),this.clearStencil=new Rp(this),this.colorMask=new cd(this),this.depthMask=new kp(this),this.stencilMask=new jl(this),this.stencilFunc=new Sc(this),this.stencilOp=new ju(this),this.stencilTest=new Ec(this),this.depthRange=new Tg(this),this.depthTest=new Lp(this),this.depthFunc=new Sg(this),this.blend=new Ic(this),this.blendFunc=new ud(this),this.blendColor=new hd(this),this.blendEquation=new zp(this),this.cullFace=new dd(this),this.cullFaceSide=new Uu(this),this.frontFace=new Eg(this),this.program=new Ig(this),this.activeTexture=new Ag(this),this.viewport=new Ac(this),this.bindFramebuffer=new Cg(this),this.bindRenderbuffer=new Vv(this),this.bindTexture=new $v(this),this.bindVertexBuffer=new Gv(this),this.bindElementBuffer=new Dp(this),this.bindVertexArrayOES=new Op(this),this.pixelStoreUnpack=new Fp(this),this.pixelStoreUnpackPremultiplyAlpha=new Bp(this),this.pixelStoreUnpackFlipY=new Pg(this),this.options=r?Object.assign({},r):{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=t.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=t.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=t.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=t.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.forceManualRenderingForInstanceIDShaders=r&&!!r.forceManualRenderingForInstanceIDShaders||this.renderer&&this.renderer.indexOf("PowerVR")!==-1,this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=t.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=t.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=t.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.extBlendFuncExtended=t.getExtension("WEBGL_blend_func_extended")}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(t,r,h){return new vs(this,t,r,h)}createVertexBuffer(t,r,h,p,g){return new Vg(this,t,r,h,p,g)}createRenderbuffer(t,r,h){const p=this.gl,g=p.createRenderbuffer();return this.bindRenderbuffer.set(g),p.renderbufferStorage(p.RENDERBUFFER,t,r,h),this.bindRenderbuffer.set(null),g}createFramebuffer(t,r,h,p){return new $g(this,t,r,h,p)}clear({color:t,depth:r,stencil:h,colorMask:p}){const g=this.gl;let y=0;t&&(y|=g.COLOR_BUFFER_BIT,this.clearColor.set(t.toNonPremultipliedRenderColor(null)),this.colorMask.set(p||[!0,!0,!0,!0])),r!==void 0&&(y|=g.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(r),this.depthMask.set(!0)),h!==void 0&&(y|=g.STENCIL_BUFFER_BIT,this.clearStencil.set(h),this.stencilMask.set(255)),g.clear(y)}setCullFace(t){t.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(t.mode),this.frontFace.set(t.frontFace))}setDepthMode(t){t.func!==this.gl.ALWAYS||t.mask?(this.depthTest.set(!0),this.depthFunc.set(t.func),this.depthMask.set(t.mask),this.depthRange.set(t.range)):this.depthTest.set(!1)}setStencilMode(t){t.test.func!==this.gl.ALWAYS||t.mask?(this.stencilTest.set(!0),this.stencilMask.set(t.mask),this.stencilOp.set([t.fail,t.depthFail,t.pass]),this.stencilFunc.set({func:t.test.func,ref:t.ref,mask:t.test.mask})):this.stencilTest.set(!1)}setColorMode(t){s.by(t.blendFunction,ai.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(t.blendFunction),this.blendColor.set(t.blendColor),t.blendEquation?this.blendEquation.set(t.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(t.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}let $l;function It(u,t,r,h,p,g,y){const w=u.context,T=w.gl,A=u.transform,M=[s.aF(A.center.lng),s.aJ(A.center.lat)],z=r.layout.get("symbol-placement"),L=r.layout.get("text-variable-anchor"),D=r.layout.get("icon-rotation-alignment")==="map",N=r.layout.get("text-rotation-alignment")==="map",B=z!=="point",G=[];let $=0,X=0;for(let te=0;te<h.length;te++){const he=h[te],we=t.getTile(he),ye=we.getBucket(r);if(!ye)continue;const ze=ye.getProjection().createInversionMatrix(A,he.canonical),Oe=[],$e=qh(he,ye,A),ot=!y&&D&&B,Ae=y&&N&&B,_e=L&&ye.hasTextData(),Ne=ye.hasIconTextFit()&&_e&&ye.hasIconData(),Re=ot||Ae||y&&_e||Ne,Ke=ye.projection.name==="globe",pt=Ke?s.aj(A.zoom):0;Ke&&(Oe.push("PROJECTION_GLOBE_VIEW"),Re&&Oe.push("PROJECTED_POS_ON_VIEWPORT"));const wt=u.getOrCreateProgram("collisionBox",{defines:Oe});let ht=$e;p[0]===0&&p[1]===0||(ht=u.translatePosMatrix($e,we,p,g));const st=y?ye.textCollisionBox:ye.iconCollisionBox,Rt=ye.collisionCircleArray;if(Rt.length>0){const vt=s.bC(),Tt=ht;s.cP(vt,ye.placementInvProjMatrix,A.glCoordMatrix),s.cP(vt,vt,ye.placementViewportMatrix),G.push({circleArray:Rt,circleOffset:X,transform:Tt,invTransform:vt,projection:ye.getProjection()}),$+=Rt.length/4,X=$}if(!st)continue;u.terrain&&u.terrain.setupElevationDraw(we,wt);const At=Ke?[he.canonical.x,he.canonical.y,1<<he.canonical.z]:[0,0,0];wt.draw(u,T.LINES,Dt.disabled,Jt.disabled,u.colorModeForRenderPass(),Yt.disabled,Wp(ht,ze,A,pt,M,we,At,ye.getProjection()),r.id,st.layoutVertexBuffer,st.indexBuffer,st.segments,null,A.zoom,null,[st.collisionVertexBuffer,st.collisionVertexBufferExt])}if(!y||!G.length)return;const J=u.getOrCreateProgram("collisionCircle"),K=new s.dZ;K.resize(4*$),K._trim();let ue=0;for(const te of G)for(let he=0;he<te.circleArray.length/4;he++){const we=4*he,ye=te.circleArray[we+0],ze=te.circleArray[we+1],Oe=te.circleArray[we+2],$e=te.circleArray[we+3];K.emplace(ue++,ye,ze,Oe,$e,0),K.emplace(ue++,ye,ze,Oe,$e,1),K.emplace(ue++,ye,ze,Oe,$e,2),K.emplace(ue++,ye,ze,Oe,$e,3)}(!$l||$l.length<2*$)&&($l=function(te){const he=2*te,we=new s.b0;we.resize(he),we._trim();for(let ye=0;ye<he;ye++){const ze=6*ye;we.uint16[ze+0]=4*ye+0,we.uint16[ze+1]=4*ye+1,we.uint16[ze+2]=4*ye+2,we.uint16[ze+3]=4*ye+2,we.uint16[ze+4]=4*ye+3,we.uint16[ze+5]=4*ye+0}return we}($));const oe=w.createIndexBuffer($l,!0),le=w.createVertexBuffer(K,s.d_.members,!0);for(const te of G){const he={u_matrix:te.transform,u_inv_matrix:te.invTransform,u_camera_to_center_distance:(re=A).getCameraToCenterDistance(te.projection),u_viewport_size:[re.width,re.height]};J.draw(u,T.TRIANGLES,Dt.disabled,Jt.disabled,u.colorModeForRenderPass(),Yt.disabled,he,r.id,le,oe,s.bg.simpleSegment(0,2*te.circleOffset,te.circleArray.length,te.circleArray.length/2),null,A.zoom)}var re;le.destroy(),oe.destroy()}const Zu=s.bC();function da(u){const t=u._camera.getWorldToCamera(u.worldSize,1),r=s.aB([],t,u.globeMatrix);s.bl(r,r);const h=[0,0,0],p=[0,1,0,0];return s.aC(p,p,r),h[0]=p[0],h[1]=p[1],h[2]=p[2],s.aw(h,h),h}function sl({width:u,height:t,anchor:r,textOffset:h,textScale:p},g){const{horizontalAlign:y,verticalAlign:w}=s.c1(r),T=-(y-.5)*u,A=-(w-.5)*t,M=s.c2(r,h);return new s.P((T/p+M[0])*g,(A/p+M[1])*g)}function Gt(u,t,r,h,p,g,y,w,T,A){const M=u.text.placedSymbolArray,z=u.text.dynamicLayoutVertexArray,L=u.icon.dynamicLayoutVertexArray,D={},N=u.getProjection(),B=Fs(y,N,p),G=p.elevation,$=N.upVectorScale(y.canonical,p.center.lat,p.worldSize).metersToTile;z.clear();for(let X=0;X<M.length;X++){const J=M.get(X),{tileAnchorX:K,tileAnchorY:ue,numGlyphs:oe}=J,le=J.hidden||!J.crossTileID||u.allowVerticalPlacement&&!J.placedOrientation?null:h[J.crossTileID];if(le){let re=0,te=0,he=0;const we=u.elevationType==="road";if(G||we){const Re=we?u.getElevationFeatureForText(X):null,Ke=s.bV.getAtTileOffset(y,new s.P(K,ue),G,Re),[pt,wt,ht]=N.upVector(y.canonical,K,ue);re=Ke*pt*$,te=Ke*wt*$,he=Ke*ht*$}let[ye,ze,Oe,$e]=Xo(J.projectedAnchorX+re,J.projectedAnchorY+te,J.projectedAnchorZ+he,r?B:g);const ot=Zi(p.getCameraToCenterDistance(N),$e);let Ae=s.bM(u.textSizeData,T,J)*ot/s.bY;r&&(Ae*=u.tilePixelRatio/w);const _e=sl(le,Ae);r?({x:ye,y:ze,z:Oe}=N.projectTilePoint(K+_e.x,ue+_e.y,y.canonical),[ye,ze,Oe]=Xo(ye+re,ze+te,Oe+he,g)):(t&&_e._rotate(-p.angle),ye+=_e.x,ze+=_e.y,Oe=0);const Ne=u.allowVerticalPlacement&&J.placedOrientation===s.bL.vertical?Math.PI/2:0;for(let Re=0;Re<oe;Re++)s.bO(z,ye,ze,Oe,Ne);A&&J.associatedIconIndex>=0&&(D[J.associatedIconIndex]={x:ye,y:ze,z:Oe,angle:Ne})}else _s(oe,z)}if(A){L.clear();const X=u.icon.placedSymbolArray;for(let J=0;J<X.length;J++){const K=X.get(J),{numGlyphs:ue}=K,oe=D[J];if(K.hidden||!oe)_s(ue,L);else{const{x:le,y:re,z:te,angle:he}=oe;for(let we=0;we<ue;we++)s.bO(L,le,re,te,he)}}u.icon.dynamicLayoutVertexBuffer.updateData(L)}u.text.dynamicLayoutVertexBuffer.updateData(z)}function Xu(u,t,r,h,p,g,y={}){const w=r.paint.get("icon-translate"),T=r.paint.get("text-translate"),A=r.paint.get("icon-translate-anchor"),M=r.paint.get("text-translate-anchor"),z=r.layout.get("icon-rotation-alignment"),L=r.layout.get("text-rotation-alignment"),D=r.layout.get("icon-pitch-alignment"),N=r.layout.get("text-pitch-alignment"),B=r.layout.get("icon-keep-upright"),G=r.layout.get("text-keep-upright"),$=r.paint.get("icon-color-saturation"),X=r.paint.get("icon-color-contrast"),J=r.paint.get("icon-color-brightness-min"),K=r.paint.get("icon-color-brightness-max"),ue=r.layout.get("symbol-elevation-reference")==="sea",oe=r.layout.get("icon-image-use-theme")==="none",le=u.context,re=le.gl,te=u.transform,he=z==="map",we=L==="map",ye=D==="map",ze=N==="map",Oe=r.layout.get("symbol-sort-key").constantOr(1)!==void 0;let $e=!1;const ot=u.depthModeForSublayer(0,Dt.ReadOnly),Ae=new Dt(u.context.gl.LEQUAL,Dt.ReadOnly,u.depthRangeFor3D),_e=[s.aF(te.center.lng),s.aJ(te.center.lat)],Ne=r.layout.get("text-variable-anchor"),Re=te.projection.name==="globe",Ke=[],pt=[0,-1,0];for(const wt of h){const ht=t.getTile(wt),st=ht.getBucket(r);if(!st||st.projection.name==="mercator"&&Re||st.fullyClipped)continue;const Rt=st.projection.name==="globe",At=Rt?s.aj(te.zoom):0,vt=Fs(wt,st.getProjection(),te),Tt=te.calculatePixelsToTileUnitsMatrix(ht),Ut=Ne&&st.hasTextData(),ii=st.hasIconTextFit()&&Ut&&st.hasIconData(),wi=st.getProjection().createInversionMatrix(te,wt.canonical),Ui=(1<<ht.tileID.canonical.z)*s.al/u.transform.worldSize,Lt=Hi=>{let Ci=[0,0,0];if(Hi){const ui=u.style.directionalLight,_n=u.style.ambientLight;ui&&_n&&(Ci=ua(u.style,ui,_n))}return Ci},Fi=Hi=>{te.depthOcclusionForSymbolsAndCircles&&(r.hasOcclusionOpacityProperties||u.terrain)&&(Hi.push("DEPTH_D24"),Hi.push("DEPTH_OCCLUSION"))},ti=Hi=>{r.lut&&!oe&&(r.lut.texture||(r.lut.texture=new s.d$(u.context,r.lut.image,[r.lut.image.height,r.lut.image.height,r.lut.image.height],le.gl.RGBA8)),le.activeTexture.set(le.gl.TEXTURE0+Cr.LUT),r.lut.texture&&r.lut.texture.bind(le.gl.LINEAR,le.gl.CLAMP_TO_EDGE),Hi.push("APPLY_LUT_ON_GPU"))},Gi=()=>{const Hi=he&&r.layout.get("symbol-placement")!=="point",Ci=[];Fi(Ci),ti(Ci);const ui=Hi||ii,_n=st.elevationType==="road",Gn=u.shadowRenderer,Cn=_n&&ye&&!!Gn&&Gn.enabled,rn=Lt(Cn),co=_n&&ye&&!u.terrain?Ae:ot,Fr=r.paint.get("icon-image-cross-fade");u.terrainRenderModeElevated()&&ye&&Ci.push("PITCH_WITH_MAP_TERRAIN"),Rt&&(Ci.push("PROJECTION_GLOBE_VIEW"),ui&&Ci.push("PROJECTED_POS_ON_VIEWPORT")),Fr>0&&st.hasAnySecondaryIcon&&Ci.push("ICON_TRANSITION"),!st.icon.zOffsetVertexBuffer||_n&&u.terrain||Ci.push("Z_OFFSET"),$===0&&X===0&&J===0&&K===1||Ci.push("COLOR_ADJUSTMENT"),st.sdfIcons&&Ci.push("RENDER_SDF"),Cn&&Ci.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),_n&&ye&&!u.terrain&&st.icon.orientationVertexBuffer&&Ci.push("ELEVATED_ROADS");const lr=st.icon.programConfigurations.get(r.id),Hr=u.getOrCreateProgram("symbol",{config:lr,defines:Ci}),qr=ht.imageAtlasTexture?ht.imageAtlasTexture.size:[0,0],zr=st.iconSizeData,No=s.bK(zr,te.zoom),ns=ye||!te.isOrthographic,xo=Jr(vt,ht.tileID.canonical,ye,he,te,st.getProjection(),Tt),Nn=Mu(vt,ht.tileID.canonical,ye,he,te,st.getProjection(),Tt),Wn=u.translatePosMatrix(Nn,ht,w,A,!0),on=u.translatePosMatrix(vt,ht,w,A),Yn=ui?Zu:xo,Dn=he&&!ye&&!Hi;let Pn=pt;!Re&&!te.mercatorFromTransition||he||(Pn=da(te));const rs=Rt?Pn:pt,ah=r.getColorAdjustmentMatrix($,X,J,K),bs=Sd(zr.kind,No,Dn,ye,u,on,Yn,Wn,ue,!1,qr,[0,0],0,wt,At,_e,wi,rs,st.getProjection(),rn,Ui,ah,Fr,null),lh=ht.imageAtlasTexture?ht.imageAtlasTexture:null,Vc=r.layout.get("icon-size").constantOr(0)!==1||st.iconsNeedLinear,Ws=st.sdfIcons||u.options.rotating||u.options.zooming||Vc||ns?re.LINEAR:re.NEAREST,wa=st.sdfIcons&&r.paint.get("icon-halo-width").constantOr(1)!==0,$c=u.terrain&&ye&&Hi?s.bl(s.bC(),xo):Zu;if(Hi&&st.icon){const hl=s.bV.getAtTileOffsetFunc(wt,te.center.lat,te.worldSize,st.getProjection()),ba=Wh(vt,ht.tileID.canonical,ye,he,te,st.getProjection(),Tt),Ts=r.layout.get("icon-size-scale-range"),Ta=s.aA(u.scaleFactor,Ts[0],Ts[1]);fg(st,vt,u,!1,ba,Nn,ye,B,hl,wt,Ta)}return{program:Hr,buffers:st.icon,uniformValues:bs,atlasTexture:lh,atlasTextureIcon:null,atlasInterpolation:Ws,atlasInterpolationIcon:null,isSDF:st.sdfIcons,hasHalo:wa,depthMode:co,tile:ht,renderWithShadows:Cn,labelPlaneMatrixInv:$c}},Qi=()=>{const Hi=we&&r.layout.get("symbol-placement")!=="point",Ci=[],ui=Hi||Ne||ii,_n=st.elevationType==="road",Gn=u.shadowRenderer,Cn=_n&&ze&&!!Gn&&Gn.enabled,rn=Lt(Cn),co=_n&&ze&&!u.terrain?Ae:ot;u.terrainRenderModeElevated()&&ze&&Ci.push("PITCH_WITH_MAP_TERRAIN"),Rt&&(Ci.push("PROJECTION_GLOBE_VIEW"),ui&&Ci.push("PROJECTED_POS_ON_VIEWPORT")),!st.text.zOffsetVertexBuffer||_n&&u.terrain||Ci.push("Z_OFFSET"),st.iconsInText&&Ci.push("RENDER_TEXT_AND_SYMBOL"),Ci.push("RENDER_SDF"),Cn&&Ci.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),_n&&ze&&!u.terrain&&st.text.orientationVertexBuffer&&Ci.push("ELEVATED_ROADS"),Fi(Ci);const Fr=st.text.programConfigurations.get(r.id),lr=u.getOrCreateProgram("symbol",{config:Fr,defines:Ci});let Hr,qr=[0,0],zr=null;const No=st.textSizeData;st.iconsInText&&(qr=ht.imageAtlasTexture?ht.imageAtlasTexture.size:[0,0],zr=ht.imageAtlasTexture?ht.imageAtlasTexture:null,Hr=ze||!te.isOrthographic||u.options.rotating||u.options.zooming||No.kind==="composite"||No.kind==="camera"?re.LINEAR:re.NEAREST);const ns=ht.glyphAtlasTexture?ht.glyphAtlasTexture.size:[0,0],xo=r.layout.get("text-size-scale-range"),Nn=s.aA(u.scaleFactor,xo[0],xo[1]),Wn=s.bK(No,te.zoom,Nn),on=Jr(vt,ht.tileID.canonical,ze,we,te,st.getProjection(),Tt),Yn=Mu(vt,ht.tileID.canonical,ze,we,te,st.getProjection(),Tt),Dn=u.translatePosMatrix(Yn,ht,T,M,!0),Pn=u.translatePosMatrix(vt,ht,T,M),rs=ui?Zu:on,ah=we&&!ze&&!Hi;let bs=pt;!Re&&!te.mercatorFromTransition||we||(bs=da(te));const lh=Sd(No.kind,Wn,ah,ze,u,Pn,rs,Dn,ue,!0,ns,qr,0,wt,At,_e,wi,Rt?bs:pt,st.getProjection(),rn,Ui,null,null,Nn),Vc=ht.glyphAtlasTexture?ht.glyphAtlasTexture:null,Ws=re.LINEAR,wa=r.paint.get("text-halo-width").constantOr(1)!==0,$c=u.terrain&&ze&&Hi?s.bl(s.bC(),on):Zu;if(Hi&&st.text){const hl=s.bV.getAtTileOffsetFunc(wt,te.center.lat,te.worldSize,st.getProjection()),ba=Wh(vt,ht.tileID.canonical,ze,we,te,st.getProjection(),Tt);fg(st,vt,u,!0,ba,Yn,ze,G,hl,wt,Nn)}return{program:lr,buffers:st.text,uniformValues:lh,atlasTexture:Vc,atlasTextureIcon:zr,atlasInterpolation:Ws,atlasInterpolationIcon:Hr,isSDF:!0,hasHalo:wa,depthMode:co,tile:ht,renderWithShadows:Cn,labelPlaneMatrixInv:$c}},Xi=st.icon.segments.get().length,Di=st.text.segments.get().length,ci=Xi&&!y.onlyText?Gi():null,$i=Di&&!y.onlyIcons?Qi():null,zn=r.paint.get("icon-opacity").constantOr(1),xn=r.paint.get("text-opacity").constantOr(1);if(Oe&&st.canOverlap){$e=!0;const Hi=zn&&!y.onlyText?st.icon.segments.get():[],Ci=xn&&!y.onlyIcons?st.text.segments.get():[];for(const ui of Hi)Ke.push({segments:new s.bg([ui]),sortKey:ui.sortKey,state:ci});for(const ui of Ci)Ke.push({segments:new s.bg([ui]),sortKey:ui.sortKey,state:$i})}else y.onlyText||Ke.push({segments:zn?st.icon.segments:new s.bg([]),sortKey:0,state:ci}),y.onlyIcons||Ke.push({segments:xn?st.text.segments:new s.bg([]),sortKey:0,state:$i})}$e&&Ke.sort((wt,ht)=>wt.sortKey-ht.sortKey);for(const wt of Ke){const ht=wt.state;if(ht)if(u.terrain?u.terrain.setupElevationDraw(ht.tile,ht.program,{useDepthForOcclusion:te.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:ht.labelPlaneMatrixInv}):u.setupDepthForOcclusion(te.depthOcclusionForSymbolsAndCircles,ht.program),le.activeTexture.set(re.TEXTURE0),ht.atlasTexture&&ht.atlasTexture.bind(ht.atlasInterpolation,re.CLAMP_TO_EDGE,!0),ht.atlasTextureIcon&&(le.activeTexture.set(re.TEXTURE1),ht.atlasTextureIcon&&ht.atlasTextureIcon.bind(ht.atlasInterpolationIcon,re.CLAMP_TO_EDGE,!0)),ht.renderWithShadows&&u.shadowRenderer.setupShadows(ht.tile.tileID.toUnwrapped(),ht.program,"vector-tile"),u.uploadCommonLightUniforms(u.context,ht.program),ht.hasHalo){const st=ht.uniformValues;st.u_is_halo=1,Kp(ht.buffers,wt.segments,r,u,ht.program,ht.depthMode,p,g,st,2),st.u_is_halo=0}else{if(ht.isSDF){const st=ht.uniformValues;ht.hasHalo&&(st.u_is_halo=1,Kp(ht.buffers,wt.segments,r,u,ht.program,ht.depthMode,p,g,st,1)),st.u_is_halo=0}Kp(ht.buffers,wt.segments,r,u,ht.program,ht.depthMode,p,g,ht.uniformValues,1)}}}function Kp(u,t,r,h,p,g,y,w,T,A){const M=[u.dynamicLayoutVertexBuffer,u.opacityVertexBuffer,u.iconTransitioningVertexBuffer,u.globeExtVertexBuffer,u.zOffsetVertexBuffer,u.orientationVertexBuffer];p.draw(h,h.context.gl.TRIANGLES,g,y,w,Yt.disabled,T,r.id,u.layoutVertexBuffer,u.indexBuffer,t,r.paint,h.transform.zoom,u.programConfigurations.get(r.id),M,A)}function Gg(u,t){const r=1<<u.canonical.z,h=(t.x*r-u.canonical.x-u.wrap*r)*s.al,p=(t.y*r-u.canonical.y)*s.al,g=s.e8(t.z,t.y);return s.d5(h,p,g)}function Id(u,t,r,h,p){if(!r.layout||r.layout.get("fill-elevation-reference")==="none"||r.paint.get("fill-opacity").constantOr(1)===0)return;const g=u.context.gl,y=new Dt(u.context.gl.LEQUAL,Dt.ReadWrite,u.depthRangeFor3D),w=new Dt(u.context.gl.GREATER,Dt.ReadWrite,u.depthRangeFor3D),T=function(D){let N=.01;return D.isOrthographic&&(N=s.ak(1e-4,N,s.d0(D.pitch>=ys?1:D.pitch/ys))),2*N}(u.transform),A=u.transform.getFreeCameraOptions().position,M="elevatedStructuresDepthReconstruct",z=u.getOrCreateProgram(M,{defines:["DEPTH_RECONSTRUCTION"]}),L=u.getOrCreateProgram(M);for(const D of h){const N=t.getTile(D),B=N.getBucket(r);if(!B)continue;const G=B.elevatedStructures;if(!G)continue;const $=B.elevationBufferData.heightRange,X=Gg(D.toUnwrapped(),A),J=u.translatePosMatrix(D.projMatrix,N,r.paint.get("fill-translate"),r.paint.get("fill-translate-anchor"));let K,ue,oe,le;if(p==="initialize"){if(!$||$.min>=1||G.depthSegments.segments[0].primitiveLength===0)continue;K=Ul(J,X,T,1,0),ue=y,oe=G.depthSegments,le=z}else if(p==="reset"){if(!$||$.min>=0||G.maskSegments.segments[0].primitiveLength===0)continue;K=Ul(J,X,0,0,1),ue=w,oe=G.maskSegments,le=z}else if(p==="geometry"){if(G.depthSegments.segments[0].primitiveLength===0)continue;K=Ul(J,X,T,1,0),ue=y,oe=G.depthSegments,le=L}le.draw(u,g.TRIANGLES,ue,Jt.disabled,ai.disabled,Yt.disabled,K,r.id,G.vertexBuffer,G.indexBuffer,oe,r.paint,u.transform.zoom)}}function Ad(u,t,r,h){const{painter:p,sourceCache:g,layer:y,coords:w,colorMode:T,elevationType:A,terrainEnabled:M,pass:z}=u,L=p.context.gl,D=y.paint.get("fill-pattern"),N=y.paint.get("fill-pattern-cross-fade"),B=D.constantOr(null);let G=A;A!=="road"||t&&!M||(G="none");const $=G==="road",X=u.painter.shadowRenderer,J=$&&!!X&&X.enabled,K=new Dt(p.context.gl.LEQUAL,Dt.ReadOnly,p.depthRangeFor3D);let ue=[0,0,0];if(J){const te=p.style.directionalLight,he=p.style.ambientLight;te&&he&&(ue=ua(p.style,te,he))}const oe=D&&D.constantOr(1),le=p.terrain&&p.terrain.renderingToTexture,re=(te,he)=>{let we,ye,ze,Oe,$e;he?(we=oe&&!y.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",ze=L.LINES):(we=oe?"fillPattern":"fill",ze=L.TRIANGLES);for(const ot of w){const Ae=g.getTile(ot);if(oe&&!Ae.patternsLoaded())continue;const _e=Ae.getBucket(y);if(!_e)continue;const Ne=t?_e.elevationBufferData:_e.bufferData;if(Ne.isEmpty())continue;p.prepareDrawTile();const Re=Ne.programConfigurations.get(y.id),Ke=p.isTileAffectedByFog(ot),pt=[],wt=[];$&&(pt.push("ELEVATED_ROADS"),wt.push(Ne.elevatedLayoutVertexBuffer)),J&&pt.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),le&&r&&pt.push("USE_MRT1"),oe&&(p.context.activeTexture.set(L.TEXTURE0),Ae.imageAtlasTexture&&Ae.imageAtlasTexture.bind(L.LINEAR,L.CLAMP_TO_EDGE),Re.updatePaintBuffers());let ht=!1;if(B&&Ae.imageAtlas){const Tt=Ae.imageAtlas,Ut=s.e3.from(B),ii=Ut.getPrimary().scaleSelf(s.o.devicePixelRatio).toString(),wi=Ut.getSecondary(),Ui=Tt.patternPositions.get(ii),Lt=wi?Tt.patternPositions.get(wi.scaleSelf(s.o.devicePixelRatio).toString()):null;ht=!!Ui&&!!Lt,Ui&&Re.setConstantPatternPositions(Ui,Lt)}N>0&&(ht||Re.getPatternTransitionVertexBuffer("fill-pattern"))&&pt.push("FILL_PATTERN_TRANSITION");const st=p.getOrCreateProgram(we,{config:Re,overrideFog:Ke,defines:pt}),Rt=p.translatePosMatrix(ot.projMatrix,Ae,y.paint.get("fill-translate"),y.paint.get("fill-translate-anchor"));J&&X.setupShadows(Ae.tileID.toUnwrapped(),st,"vector-tile");const At=y.paint.get("fill-emissive-strength");if(he){Oe=Ne.lineIndexBuffer,$e=Ne.lineSegments;const Tt=p.terrain&&p.terrain.renderingToTexture?p.terrain.drapeBufferSize:[L.drawingBufferWidth,L.drawingBufferHeight];ye=we==="fillOutlinePattern"&&oe?qp(Rt,At,p,Ae,Tt,ue,N):zg(Rt,At,Tt,ue)}else Oe=Ne.indexBuffer,$e=Ne.triangleSegments,ye=oe?Hp(Rt,At,p,Ae,ue,N):Gp(Rt,At,ue);p.uploadCommonUniforms(p.context,st,ot.toUnwrapped());let vt=te;(A==="road"&&!M||A==="offset")&&(vt=K),st.draw(p,ze,vt,h||p.stencilModeForClipping(ot),T,Yt.disabled,ye,y.id,Ne.layoutVertexBuffer,Oe,$e,y.paint,p.transform.zoom,Re,wt)}};p.renderPass===z&&re(p.depthModeForSublayer(1,p.renderPass==="opaque"?Dt.ReadWrite:Dt.ReadOnly),!1),G==="none"&&p.renderPass==="translucent"&&y.paint.get("fill-antialias")&&re(p.depthModeForSublayer(y.getPaintProperty("fill-outline-color")?2:0,Dt.ReadOnly),!0)}function Cd(u,t,r,h,p,g,y,w){r.resetLayerRenderingStats(u);const T=u.context,A=T.gl,M=u.transform,z=r.paint.get("fill-extrusion-pattern"),L=r.paint.get("fill-extrusion-pattern-cross-fade"),D=z.constantOr(null),N=z.constantOr(1),B=r.paint.get("fill-extrusion-opacity"),G=u.style.enable3dLights(),$=r.paint.get(G&&!N?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),X=[r.paint.get("fill-extrusion-ambient-occlusion-intensity"),$],J=r.layout.get("fill-extrusion-edge-radius"),K=J>0&&!r.paint.get("fill-extrusion-rounded-roof"),ue=K?0:J,oe=M.projection.name==="globe"?s.eb():0,le=M.projection.name==="globe",re=le?s.aj(M.zoom):0,te=[s.aF(M.center.lng),s.aJ(M.center.lat)],he=r.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",we=r.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(he?null:r.lut).toArray01().slice(0,3),ye=r.paint.get("fill-extrusion-flood-light-intensity"),ze=r.paint.get("fill-extrusion-vertical-scale"),Oe=r.paint.get("fill-extrusion-line-width").constantOr(1)!==0,$e=r.paint.get("fill-extrusion-height-alignment"),ot=r.paint.get("fill-extrusion-base-alignment"),Ae=Ya(u,r.paint.get("fill-extrusion-cutoff-fade-range")),_e=[];let Ne;le&&_e.push("PROJECTION_GLOBE_VIEW"),X[0]>0&&_e.push("FAUX_AO"),K&&_e.push("ZERO_ROOF_RADIUS"),w&&_e.push("HAS_CENTROID"),ye>0&&_e.push("FLOOD_LIGHT"),Ae.shouldRenderCutoff&&_e.push("RENDER_CUTOFF"),Oe&&_e.push("RENDER_WALL_MODE");const Re=u.renderPass==="shadow",Ke=u.shadowRenderer,pt=Re&&!!Ke,wt=Re?Yt.disabled:Yt.backCCW;u.shadowRenderer&&(u.shadowRenderer.useNormalOffset=!0);let ht=[0,0,0];if(Ke){const At=u.style.directionalLight,vt=u.style.ambientLight;At&&vt&&(ht=ua(u.style,At,vt)),Re||(_e.push("RENDER_SHADOWS","DEPTH_TEXTURE"),Ke.useNormalOffset&&_e.push("NORMAL_OFFSET")),Ne=_e.concat(["SHADOWS_SINGLE_CASCADE"])}const st=pt?"fillExtrusionDepth":N?"fillExtrusionPattern":"fillExtrusion",Rt=r.getLayerRenderingStats();for(const At of h){const vt=t.getTile(At),Tt=vt.getBucket(r);if(!Tt||Tt.projection.name!==M.projection.name)continue;let Ut=!1;Ke&&(Ut=Ke.getMaxCascadeForTile(At.toUnwrapped())===0);const ii=u.isTileAffectedByFog(At),wi=Tt.programConfigurations.get(r.id);let Ui=!1;if(D&&vt.imageAtlas){const Di=vt.imageAtlas,ci=s.e3.from(D),$i=ci.getPrimary().scaleSelf(s.o.devicePixelRatio).toString(),zn=ci.getSecondary(),xn=Di.patternPositions.get($i),Hi=zn?Di.patternPositions.get(zn.scaleSelf(s.o.devicePixelRatio).toString()):null;Ui=!!xn&&!!Hi,xn&&wi.setConstantPatternPositions(xn,Hi)}L>0&&(Ui||wi.getPatternTransitionVertexBuffer("fill-extrusion-pattern"))&&_e.push("FILL_EXTRUSION_PATTERN_TRANSITION");const Lt=u.getOrCreateProgram(st,{config:wi,defines:Ut?Ne:_e,overrideFog:ii});if(u.terrain&&u.terrain.setupElevationDraw(vt,Lt,{useMeterToDem:!0}),!Tt.centroidVertexBuffer){const Di=Lt.getAttributeLocation(A,"a_centroid_pos");Di!==-1&&A.vertexAttrib2f(Di,0,0)}!Re&&Ke&&Ke.setupShadows(vt.tileID.toUnwrapped(),Lt,"vector-tile"),N&&(u.context.activeTexture.set(A.TEXTURE0),vt.imageAtlasTexture&&vt.imageAtlasTexture.bind(A.LINEAR,A.CLAMP_TO_EDGE),wi.updatePaintBuffers());const Fi=r.paint.get("fill-extrusion-vertical-gradient"),ti=1/Tt.tileToMeter;let Gi;if(Re&&Ke){if(pa(vt.tileID,Tt.maxHeight,u))continue;const Di=Ke.calculateShadowPassMatrixFromTile(vt.tileID.toUnwrapped());Gi=$p(Di,ue,ti,ze,$e,ot)}else{const Di=u.translatePosMatrix(At.expandedProjMatrix,vt,r.paint.get("fill-extrusion-translate"),r.paint.get("fill-extrusion-translate-anchor")),ci=M.projection.createInversionMatrix(M,At.canonical);Gi=N?Lg(Di,u,Fi,B,X,ue,ti,At,vt,oe,$e,ot,re,te,ci,we,ze,L):xd(Di,u,Fi,B,X,ue,ti,At,oe,$e,ot,re,te,ci,we,ze,ye,ht)}u.uploadCommonUniforms(T,Lt,At.toUnwrapped(),null,Ae);let Qi=Tt.segments;if(M.projection.name==="mercator"&&!Re&&(Qi=Tt.getVisibleSegments(vt.tileID,u.terrain,u.transform.getFrustum(0)),!Qi.get().length))continue;if(Rt)if(Re)for(const Di of Qi.get())Rt.numRenderedVerticesInShadowPass+=Di.primitiveLength;else for(const Di of Qi.get())Rt.numRenderedVerticesInTransparentPass+=Di.primitiveLength;const Xi=[];(u.terrain||w)&&Xi.push(Tt.centroidVertexBuffer),le&&Xi.push(Tt.layoutVertexExtBuffer),Oe&&Xi.push(Tt.wallVertexBuffer),Lt.draw(u,T.gl.TRIANGLES,p,g,y,wt,Gi,r.id,Tt.layoutVertexBuffer,Tt.indexBuffer,Qi,r.paint,u.transform.zoom,wi,Xi)}u.shadowRenderer&&(u.shadowRenderer.useNormalOffset=!1)}class Yp{constructor(){this.translate=[0,0],this.translateAnchor="map",this.edgeRadius=0,this.cutoffFadeRange=0}}function fa(u,t,r,h,p,g,y,w,T,A,M,z,L,D,N,B,G,$,X,J){const K=t.context,ue=K.gl,oe=t.transform,le=t.transform.zoom,re=[],te=u.translate,he=u.translateAnchor,we=u.edgeRadius,ye=Ya(t,u.cutoffFadeRange);M==="clear"?(re.push("CLEAR_SUBPASS"),J&&(re.push("CLEAR_FROM_TEXTURE"),K.activeTexture.set(ue.TEXTURE0),J.bind(ue.LINEAR,ue.CLAMP_TO_EDGE))):M==="sdf"?re.push("SDF_SUBPASS"):M==="emissive"&&(re.push("USE_MRT1"),K.activeTexture.set(ue.TEXTURE0),J.bind(ue.LINEAR,ue.CLAMP_TO_EDGE)),$&&re.push("HAS_CENTROID"),ye.shouldRenderCutoff&&re.push("RENDER_CUTOFF");const ze=(Oe,$e,ot,Ae,_e)=>{let Ne=re;$e.groundRadiusBuffer!=null&&(Ne=re.concat("HAS_ATTRIBUTE_a_flood_light_ground_radius"));const Re=$e.programConfigurations.get(h.id),Ke=t.isTileAffectedByFog(Oe),pt=t.getOrCreateProgram("fillExtrusionGroundEffect",{config:Re,defines:Ne,overrideFog:Ke}),wt=Rc(t,Ae,z,A,_e,[L,D*_e],N,B,G,le>=17?0:we*_e,J?J.size[0]:0),ht=[];$&&ht.push($e.hiddenByLandmarkVertexBuffer),$e.groundRadiusBuffer!=null&&ht.push($e.groundRadiusBuffer),t.uploadCommonUniforms(K,pt,Oe.toUnwrapped(),null,ye),pt.draw(t,K.gl.TRIANGLES,g,y,w,T,wt,h.id,$e.vertexBuffer,$e.indexBuffer,ot,h.paint,le,Re,ht)};for(const Oe of p){const $e=r.getTile(Oe),ot=$e.getBucket(h);if(!ot||ot.projection.name!==oe.projection.name||!ot.groundEffect||ot.groundEffect&&!ot.groundEffect.hasData())continue;const Ae=ot.groundEffect,_e=1/ot.tileToMeter;{const Ne=t.translatePosMatrix(Oe.projMatrix,$e,te,he),Re=Ae.getDefaultSegment();ze(Oe,Ae,Re,Ne,_e)}if(X)for(let Ne=0;Ne<4;Ne++){const Re=s.e9[Ne](Oe),Ke=r.getTile(Re);if(!Ke)continue;const pt=Ke.getBucket(h);if(!pt||pt.projection.name!==oe.projection.name||!pt.groundEffect||pt.groundEffect&&!pt.groundEffect.hasData())continue;const wt=pt.groundEffect;let ht,st;Ne===0?(ht=[-s.al,0,0],st=1):Ne===1?(ht=[s.al,0,0],st=0):Ne===2?(ht=[0,-s.al,0],st=3):(ht=[0,s.al,0],st=2);const Rt=wt.regionSegments[st];if(!Rt)continue;const At=new Float32Array(16);s.br(At,Oe.projMatrix,ht),ze(Oe,wt,Rt,t.translatePosMatrix(At,$e,te,he),_e)}}}function Kv(u,t,r,h,p,g,y){h.centroidVertexArray.length===0&&h.createCentroidsBuffer();const w=g?g.findDEMTileFor(r):null;if(!(w&&w.dem||y))return;g&&w&&w.dem&&h.selfDEMTileTimestamp!==w.dem._timestamp&&(h.borderDoneWithNeighborZ=[-1,-1,-1,-1],h.selfDEMTileTimestamp=w.dem._timestamp);const T=$=>new s.P(Math.ceil(($+s.ed)*s.ee),0),A=$=>{const X=t.getSource().minzoom,J=ue=>{const oe=t.getTileByID(ue);if(oe&&oe.hasData())return oe.getBucket(p)},K=[0,-1,1];for(const ue of K){if($.overscaledZ+ue<X)continue;const oe=J($.calculateScaledKey($.overscaledZ+ue));if(oe)return oe}},M=[0,0,0],z=($,X)=>(M[0]=Math.min($.min.y,X.min.y),M[1]=Math.max($.max.y,X.max.y),M[2]=s.al-X.min.x>$.max.x?X.min.x-s.al:$.max.x,M),L=($,X)=>(M[0]=Math.min($.min.x,X.min.x),M[1]=Math.max($.max.x,X.max.x),M[2]=s.al-X.min.y>$.max.y?X.min.y-s.al:$.max.y,M),D=[($,X)=>z($,X),($,X)=>z(X,$),($,X)=>L($,X),($,X)=>L(X,$)],N=($,X,J,K,ue,oe,le)=>{if(!g)return 0;const re=[[oe?J:$,oe?$:J,0],[oe?J:X,oe?X:J,0]],te=le<0?s.al+le:le,he=[oe?te:($+X)/2,oe?($+X)/2:te,0];return J===0&&le<0||J!==0&&le>0?g.getForTilePoints(ue,[he],!0,K):re.push(he),g.getForTilePoints(r,re,!0,w),Math.max(re[0][2],re[1][2],he[2])/g.exaggeration()};for(let $=0;$<4;$++){const X=h.borderFeatureIndices[$];if(X.length===0)continue;const J=s.e9[$](r),K=A(J);if(!(K&&K instanceof s.ea))continue;const ue=g?g.findDEMTileFor(J):null;if(!(ue&&ue.dem||y)||(g&&ue&&ue.dem&&h.borderDEMTileTimestamp[$]!==ue.dem._timestamp&&(h.borderDoneWithNeighborZ[$]=-1,h.borderDEMTileTimestamp[$]=ue.dem._timestamp),h.borderDoneWithNeighborZ[$]===K.canonical.z))continue;K.centroidVertexArray.length===0&&K.createCentroidsBuffer();const oe=($<2?1:5)-$,le=K.borderDoneWithNeighborZ[oe]!==h.canonical.z,re=K.borderFeatureIndices[oe];let te=0;if(h.canonical.z!==K.canonical.z){for(const he of X)h.showCentroid(h.featuresOnBorder[he]);if(le)for(const he of re)K.showCentroid(K.featuresOnBorder[he]);h.borderDoneWithNeighborZ[$]=K.canonical.z,K.borderDoneWithNeighborZ[oe]=h.canonical.z}for(const he of X){const we=h.featuresOnBorder[he],ye=h.centroidData[we.centroidDataIndex],ze=we.borders[$];let Oe;for(;te<re.length;){Oe=K.featuresOnBorder[re[te]];const $e=Oe.borders[oe];if($e[1]>ze[0]+3||$e[0]>ze[0]-3)break;K.showCentroid(Oe),te++}if(Oe&&te<re.length){const $e=te;let ot=0;for(;!(Oe.borders[oe][0]>ze[1]-3)&&(ot++,++te!==re.length);)Oe=K.featuresOnBorder[re[te]];Oe=K.featuresOnBorder[re[$e]];let Ae=!1;if(ot>=1){const Re=Oe.borders[oe];Math.abs(ze[0]-Re[0])<3&&Math.abs(ze[1]-Re[1])<3&&(ot=1,Ae=!0,te=$e+1)}else if(ot===0){h.showCentroid(we);continue}const _e=K.centroidData[Oe.centroidDataIndex];y&&Ae&&(((B=ye).flags|(G=_e).flags)&s.ec?(B.flags|=s.ec,G.flags|=s.ec):(B.flags&=~s.ec,G.flags&=~s.ec));const Ne=we.intersectsCount()>1||Oe.intersectsCount()>1;if(ot>1)te=$e,ye.centroidXY=_e.centroidXY=new s.P(0,0);else if(ue&&ue.dem&&!Ne){const Re=D[$](ye,_e),Ke=$%2?s.al-1:0,pt=N(Re[0],Math.min(s.al-1,Re[1]),Ke,ue,J,$<2,Re[2]);ye.centroidXY=_e.centroidXY=T(pt)}else Ne?ye.centroidXY=_e.centroidXY=new s.P(0,0):(ye.centroidXY=h.encodeBorderCentroid(we),_e.centroidXY=K.encodeBorderCentroid(Oe));h.writeCentroidToBuffer(ye),K.writeCentroidToBuffer(_e)}else h.showCentroid(we)}h.borderDoneWithNeighborZ[$]=K.canonical.z,K.borderDoneWithNeighborZ[oe]=h.canonical.z}var B,G;(h.needsCentroidUpdate||!h.centroidVertexBuffer&&h.centroidVertexArray.length!==0)&&h.uploadCentroid(u)}const Ao=[1,0,0],Jp=[0,1,0],ao=[0,0,1];function pa(u,t,r){const h=r.transform,p=r.shadowRenderer;if(!p)return!0;const g=u.toUnwrapped(),y=h.tileSize*p._cascades[r.currentShadowCascade].scale;let w=t;if(h.elevation){const B=h.elevation.getMinMaxForTile(u);B&&(w+=B.max)}const T=[...p.shadowDirection];T[2]=-T[2];const A=p.computeSimplifiedTileShadowVolume(g,w,y,T);if(!A)return!1;const M=[Ao,Jp,ao,T,[T[0],0,T[2]],[0,T[1],T[2]]],z=h.projection.name==="globe",L=h.scaleZoom(y),D=s.cB.fromInvProjectionMatrix(h.invProjMatrix,h.worldSize,L,!z),N=p.getCurrentCascadeFrustum();return D.intersectsPrecise(A.vertices,A.planes,M)===0||N.intersectsPrecise(A.vertices,A.planes,M)===0}function Ku(u){const{painter:t,source:r,layer:h,coords:p}=u;let g=u.defines;const y=t.context,w=t.renderPass==="shadow",T=t.renderPass==="light-beam",A=t.shadowRenderer,M=s.ef(t.transform.center.lat,t.transform.zoom),z=Ya(t,h.paint.get("building-cutoff-fade-range"));z.shouldRenderCutoff&&(g=g.concat("RENDER_CUTOFF")),u.floodLightIntensity>0&&(g=g.concat("FLOOD_LIGHT"));for(const L of p){const D=r.getTile(L),N=D.getBucket(h);if(!N)continue;A&&A.getMaxCascadeForTile(L.toUnwrapped())===0&&(g=g.concat("SHADOWS_SINGLE_CASCADE"));const B=N.programConfigurations.get(h.id);let G,$,X,J=t.translatePosMatrix(L.expandedProjMatrix,D,[0,0],"map");if(J=s.cS(s.bC(),J,[1,1,u.verticalScale]),w&&A){if(pa(D.tileID,N.maxHeight*M,t))continue;let ue=A.calculateShadowPassMatrixFromTile(D.tileID.toUnwrapped());ue=s.cS(s.bC(),ue,[1,1,u.verticalScale]),X=rl(ue),G=$=t.getOrCreateProgram("buildingDepth",{config:B,defines:g,overrideFog:!1})}else if(T)G=$=t.getOrCreateProgram("buildingBloom",{config:B,defines:g,overrideFog:!1}),X=Dg(J);else{const ue=t.transform.calculatePosMatrix(L.toUnwrapped(),t.transform.worldSize);s.cS(ue,ue,[1,1,u.verticalScale]);const oe=s.bC();s.cS(oe,ue,[1,-1,1/M]),s.bl(oe,oe),s.eg(oe,oe);const le=t.transform.getFreeCameraOptions().position,re=1<<L.canonical.z;if(X=wd(J,oe,u.opacity,u.facadeAOIntensity,[((le.x-L.wrap)*re-L.canonical.x)*s.al,(le.y*re-L.canonical.y)*s.al,le.z*re*s.al],N.tileToMeter,u.facadeEmissiveChance,u.floodLightColor,u.floodLightIntensity),$=t.getOrCreateProgram("building",{config:B,defines:g,overrideFog:!1}),u.depthOnly===!0)G=$;else{const te=g.concat(["BUILDING_FAUX_FACADE","HAS_ATTRIBUTE_a_faux_facade_color_emissive"]);G=t.getOrCreateProgram("building",{config:B,defines:te,overrideFog:!1})}A&&(A.setupShadowsFromMatrix(ue,$,!0),G!==$&&A.setupShadowsFromMatrix(ue,G,!0))}const K=(ue,oe)=>{if(T){const le=ue.entranceBloom;oe.draw(t,y.gl.TRIANGLES,u.depthMode,Jt.disabled,u.blendMode,Yt.disabled,X,h.id,le.layoutVertexBuffer,le.indexBuffer,le.segmentsBucket,h.paint,t.transform.zoom,B,[le.layoutAttenuationBuffer,le.layoutColorBuffer])}else{const le=ue.segmentsBucket;let re=[ue.layoutNormalBuffer,ue.layoutCentroidBuffer,ue.layoutColorBuffer,ue.layoutFloodLightDataBuffer];ue.layoutFacadePaintBuffer&&(re=re.concat([ue.layoutFacadeDataBuffer,ue.layoutFacadeVerticalRangeBuffer,ue.layoutFacadePaintBuffer])),oe.draw(t,y.gl.TRIANGLES,u.depthMode,Jt.disabled,u.blendMode,w?Yt.disabled:Yt.backCW,X,h.id,ue.layoutVertexBuffer,ue.indexBuffer,le,h.paint,t.transform.zoom,B,re)}};t.uploadCommonUniforms(y,$,L.toUnwrapped(),null,z),N.buildingWithoutFacade&&K(N.buildingWithoutFacade,$),N.buildingWithFacade&&(G!==$&&t.uploadCommonUniforms(y,G,L.toUnwrapped(),null,z),K(N.buildingWithFacade,G))}}function Pd(u,t,r,h,p,g,y,w,T,A,M,z,L){const D=u.context.gl,N=u.depthModeForSublayer(1,Dt.ReadOnly,D.LEQUAL,!0),B=.1*(1-(G=M))+3*G;var G;const $=u._showOverdrawInspector,X=z,J=new Yp;$||fa(J,u,t,r,h,N,new Jt({func:D.ALWAYS,mask:255},255,255,D.KEEP,D.KEEP,D.REPLACE),new ai([D.ONE,D.ONE,D.ONE,D.ONE],s.ao.transparent,[!1,!1,!1,!0],D.MIN),Yt.disabled,p,"sdf",g,y,w,T,A,B,X,!1);{const K=$?Jt.disabled:new Jt({func:D.EQUAL,mask:255},255,255,D.KEEP,D.DECR,D.DECR),ue=$?u.colorModeForRenderPass():new ai([D.ONE_MINUS_DST_ALPHA,D.DST_ALPHA,D.ONE,D.ONE],s.ao.transparent,[!0,!0,!0,!0]);fa(J,u,t,r,h,N,K,ue,Yt.disabled,p,"color",g,y,w,T,A,B,X,!1)}}function Md(u){return[u[0]*s.eh,u[1]*s.eh,u[2]*s.eh,0]}function Yu(u,t,r,h,p,g,y,w,T){const A=h.getSource(),M=r.globeSharedBuffers;if(!M)return;let z,L,D;if(t&&(z=h.getTile(t)),A instanceof s.aU?(L=A.texture,D=s.dK(0,0,r.transform)):z&&t&&(L=z.texture,D=s.dK(t.canonical.z,t.canonical.x,r.transform)),!L||!D)return;u||(D=s.cS(s.bC(),D,[1,-1,1]));const N=r.context,B=N.gl,G=p.paint.get("raster-resampling")==="nearest"?B.NEAREST:B.LINEAR,$=r.colorModeForDrapableLayerRenderPass(g),X=y.defines;X.push("GLOBE_POLES");const J=new Dt(B.LEQUAL,Dt.ReadWrite,r.depthRangeFor3D),K=Float32Array.from(r.transform.expandedFarZProjMatrix),ue=Float32Array.from(s.bk(s.dJ(new s.cD(0,0,0))));r.terrain&&r.terrain.prepareDrawTile(),N.activeTexture.set(B.TEXTURE0),L.bind(G,B.CLAMP_TO_EDGE),N.activeTexture.set(B.TEXTURE1),L.bind(G,B.CLAMP_TO_EDGE),"useMipmap"in L&&N.extTextureFilterAnisotropic&&r.transform.pitch>20&&B.texParameterf(B.TEXTURE_2D,N.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,N.extTextureFilterAnisotropicMax);const[oe,le,re,te]=t?M.getPoleBuffers(t.canonical.z,!1):M.getPoleBuffers(0,!0),he=p.paint.get("raster-elevation");let we;u?(we=oe,r.renderDefaultNorthPole=he!==0):(we=le,r.renderDefaultSouthPole=he!==0);const ye=Md(y.mix),ze=(($e,ot,Ae,_e,Ne,Re,Ke,pt,wt,ht,st,Rt,At)=>Bg($e,ot,Ae,new Float32Array(16),new Float32Array(9),[0,0],_e,[0,0],[0,0,0,0],1,{opacity:1,mix:0},Re,[0,0],pt,2,ht,st,Rt,1,0,At))(K,ue,D,s.aj(r.transform.zoom),0,p,0,he,0,ye,y.offset,y.range,g),Oe=r.getOrCreateProgram("raster",{defines:X});r.uploadCommonUniforms(N,Oe,null),Oe.draw(r,B.TRIANGLES,J,T,$,w,ze,p.id,we,re,te)}function Hg(u){const t=u._nearZ,r=u.projection.farthestPixelDistance(u),h=r-t,p=.2*u.height,g=t+p;return[t,r,(g-p-t)/h,(g-t)/h]}function ma(u,t,r,h){if(u)return t instanceof Yr&&u instanceof $h?t.getTextureDescriptor(u,r,!0):{texture:u.texture,mix:Md(h.mix),offset:h.offset,buffer:0,tileSize:1}}var fn=s.ei([{name:"a_index",type:"Int16",components:1}]);class Rd{constructor(t,r,h,p){const g={width:h[0],height:h[1],data:null},y=t.gl;this.targetColorTexture=new s.T(t,g,y.RGBA8,{useMipmap:!1}),this.backgroundColorTexture=new s.T(t,g,y.RGBA8,{useMipmap:!1}),this.context=t,this.updateParticleTexture(r,p),this.lastInvalidatedAt=0}updateParticleTexture(t,r){if(this.particleTextureDimension===r.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());const h=this.context.gl,p=r.width*r.height;this.particleTexture0=new s.T(this.context,r,h.RGBA8,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new s.T(this.context,r,h.RGBA8,{premultiply:!1,useMipmap:!1});const g=new s.ej;g.reserve(p);for(let y=0;y<p;y++)g.emplaceBack(y);this.particleIndexBuffer=this.context.createVertexBuffer(g,fn.members,!0),this.particleSegment=s.bg.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=r.width}update(t){return!(this.lastInvalidatedAt<t&&(this.lastInvalidatedAt=s.o.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}function Qp(u,t,r){if(!u)return null;const h=t.getTextureDescriptor(u,r,!0);if(!h)return null;let{texture:p,mix:g,offset:y,tileSize:w,buffer:T,format:A}=h;if(!p||!A)return null;let M=!1;return A==="uint32"&&(M=!0,g[3]=0,g=bd(s.ek,g,[0,r.paint.get("raster-particle-max-speed")]),y=Td(s.ek,y,[0,r.paint.get("raster-particle-max-speed")])),{texture:p,textureOffset:[T/(w+2*T),w/(w+2*T)],tileSize:w,scalarData:M,scale:g,offset:y,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[A]]}}function qg(u){const t=u._nearZ,r=u.projection.farthestPixelDistance(u),h=r-t,p=.2*u.height,g=t+p;return[t,r,(g-p-t)/h,(g-t)/h]}const Wg=new s.ao(1,0,0,1),Zg=new s.ao(0,1,0,1),Xg=new s.ao(0,0,1,1),Gl=new s.ao(1,0,1,1),Hl=new s.ao(0,1,1,1);function ut(u,t,r,h,p,g){for(let y=0;y<r.length;y++)if(p){const A=new s.ao(h.r*.8,h.g*.8,h.b*.8,1);_t(u,t,r[y],h,-1,-1,g),_t(u,t,r[y],h,-1,1,g),_t(u,t,r[y],h,1,1,g),_t(u,t,r[y],h,1,-1,g),_t(u,t,r[y],A,0,0,g)}else _t(u,t,r[y],h,0,0,g)}function _t(u,t,r,h,p,g,y){const w=u.context,T=u.transform,A=w.gl,M=T.projection.name==="globe",z=M?["PROJECTION_GLOBE_VIEW"]:[];let L=s.bz(r.projMatrix);if(M&&s.aj(T.zoom)>0){const ye=s.bj(r.canonical,T),ze=s.el(ye);L=s.aB(new Float32Array(16),T.globeMatrix,ze),s.aB(L,T.projMatrix,L)}const D=s.bC();D[12]+=2*p/(s.o.devicePixelRatio*T.width),D[13]+=2*g/(s.o.devicePixelRatio*T.height),s.aB(L,D,L);const N=u.getOrCreateProgram("debug",{defines:z}),B=t.getTileByID(r.key);u.terrain&&u.terrain.setupElevationDraw(B,N);const G=Dt.disabled,$=Jt.disabled,X=u.colorModeForRenderPass(),J="$debug";w.activeTexture.set(A.TEXTURE0),u.emptyTexture.bind(A.LINEAR,A.CLAMP_TO_EDGE),M?B._makeGlobeTileDebugBuffers(u.context,T):B._makeDebugTileBoundsBuffers(u.context,T.projection);const K=B._tileDebugBuffer||u.debugBuffer,ue=B._tileDebugIndexBuffer||u.debugIndexBuffer,oe=B._tileDebugSegments||u.debugSegments;if(N.draw(u,A.LINE_STRIP,G,$,X,Yt.disabled,qu(L,h.toPremultipliedRenderColor(null)),J,K,ue,oe,null,null,null,[B._globeTileDebugBorderBuffer]),y){const ye=B.latestRawTileData,ze=Math.floor((ye&&ye.byteLength||0)/1024);let Oe=r.canonical.toString();r.overscaledZ!==r.canonical.z&&(Oe+=` => ${r.overscaledZ}`),Oe+=` ${B.state}`,Oe+=` ${ze}kb`,function($e,ot){$e.initDebugOverlayCanvas();const Ae=$e.debugOverlayCanvas,_e=$e.context.gl,Ne=$e.debugOverlayCanvas.getContext("2d");Ne.clearRect(0,0,Ae.width,Ae.height),Ne.shadowColor="white",Ne.shadowBlur=2,Ne.lineWidth=1.5,Ne.strokeStyle="white",Ne.textBaseline="top",Ne.font="bold 36px Open Sans, sans-serif",Ne.fillText(ot,5,5),Ne.strokeText(ot,5,5),$e.debugOverlayTexture.update(Ae),$e.debugOverlayTexture.bind(_e.LINEAR,_e.CLAMP_TO_EDGE)}(u,Oe)}const le=t.getTile(r).tileSize,re=512/Math.min(le,512)*(r.overscaledZ/T.zoom)*.5,te=B._tileDebugTextBuffer||u.debugBuffer,he=B._tileDebugTextIndexBuffer||u.quadTriangleIndexBuffer,we=B._tileDebugTextSegments||u.debugSegments;N.draw(u,A.TRIANGLES,G,$,ai.alphaBlended,Yt.disabled,qu(L,s.ao.transparent.toPremultipliedRenderColor(null),re),J,te,he,we,null,null,null,[B._globeTileDebugTextBuffer])}function ql(u,t,r,h){Se(u,0,t+r/2,u.transform.width,r,h)}function Bn(u,t,r,h){Se(u,t-r/2,0,r,u.transform.height,h)}function Se(u,t,r,h,p,g){const y=u.context,w=y.gl;w.enable(w.SCISSOR_TEST),w.scissor(t*s.o.devicePixelRatio,r*s.o.devicePixelRatio,h*s.o.devicePixelRatio,p*s.o.devicePixelRatio),y.clear({color:g}),w.disable(w.SCISSOR_TEST)}const Kg=s.ei([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:kd}=Kg;function $s(u,t,r,h){u.emplaceBack(t,r,h)}class Ld{constructor(t){this.vertexArray=new s.em,this.indices=new s.b0,$s(this.vertexArray,-1,-1,1),$s(this.vertexArray,1,-1,1),$s(this.vertexArray,-1,1,1),$s(this.vertexArray,1,1,1),$s(this.vertexArray,-1,-1,-1),$s(this.vertexArray,1,-1,-1),$s(this.vertexArray,-1,1,-1),$s(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=t.createVertexBuffer(this.vertexArray,kd),this.indexBuffer=t.createIndexBuffer(this.indices),this.segment=s.bg.simpleSegment(0,0,36,12)}}function Wl(u,t,r,h,p,g){const y=u.context.gl,w=t.paint.get("sky-atmosphere-color"),T=t.paint.get("sky-atmosphere-halo-color"),A=t.paint.get("sky-atmosphere-sun-intensity"),M=((z,L,D,N,B)=>({u_matrix_3f:z,u_sun_direction:L,u_sun_intensity:D,u_color_tint_r:[N.r,N.g,N.b,N.a],u_color_tint_m:[B.r,B.g,B.b,B.a],u_luminance:5e-5}))(s.eo(s.dO(),h),p,A,w.toPremultipliedRenderColor(null),T.toPremultipliedRenderColor(null));y.framebufferTexture2D(y.FRAMEBUFFER,y.COLOR_ATTACHMENT0,y.TEXTURE_CUBE_MAP_POSITIVE_X+g,t.skyboxTexture,0),r.draw(u,y.TRIANGLES,Dt.disabled,Jt.disabled,ai.unblended,Yt.frontCW,M,"skyboxCapture",t.skyboxGeometry.vertexBuffer,t.skyboxGeometry.indexBuffer,t.skyboxGeometry.segment)}const Yg=s.ei([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class zc{constructor(t){const r=new s.ep;r.emplaceBack(-1,1,1,0,0),r.emplaceBack(1,1,1,1,0),r.emplaceBack(1,-1,1,1,1),r.emplaceBack(-1,-1,1,0,1);const h=new s.b0;h.emplaceBack(0,1,2),h.emplaceBack(2,3,0),this.vertexBuffer=t.createVertexBuffer(r,Yg.members),this.indexBuffer=t.createIndexBuffer(h),this.segments=s.bg.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const Yv=s.ei([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class Jv{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class Jg{constructor(t){this.colorModeAlphaBlendedWriteRGB=new ai([1,Ns,1,Ns],s.ao.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new ai([1,0,1,0],s.ao.transparent,[!1,!1,!1,!0]),this.params=new Jv,this.updateNeeded=!0}update(t){const r=t.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new zc(r);const h=this.params.sizeRange,p=this.params.intensityRange,g=function(M){const z=s.eq(30),L=[];for(let D=0;D<M;++D){const N=2*Math.PI*z(),B=Math.acos(1-2*z())-.5*Math.PI;L.push(s.d5(Math.cos(B)*Math.cos(N),Math.cos(B)*Math.sin(N),Math.sin(B)))}return L}(this.params.starsCount),y=s.eq(300),w=new s.er,T=new s.b0;let A=0;for(let M=0;M<g.length;++M){const z=s.c5([],g[M],200),L=Math.max(0,1+.01*h*(1*y()-.5)),D=Math.max(0,1+.01*p*(1*y()-.5));w.emplaceBack(z[0],z[1],z[2],-1,-1,L,D),w.emplaceBack(z[0],z[1],z[2],1,-1,L,D),w.emplaceBack(z[0],z[1],z[2],1,1,L,D),w.emplaceBack(z[0],z[1],z[2],-1,1,L,D),T.emplaceBack(A+0,A+1,A+2),T.emplaceBack(A+0,A+2,A+3),A+=4}this.starsVx=r.createVertexBuffer(w,Yv.members),this.starsIdx=r.createIndexBuffer(T),this.starsSegments=s.bg.simpleSegment(0,0,w.length,T.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(t,r){const h=t.context,p=h.gl,g=t.transform,y=new Dt(p.LEQUAL,Dt.ReadOnly,[0,1]),w=s.aj(g.zoom),T=t.style.getLut(r.scope),A=r.properties.get("color-use-theme")==="none",M=r.properties.get("color").toNonPremultipliedRenderColor(A?null:T),z=r.properties.get("high-color-use-theme")==="none",L=r.properties.get("high-color").toNonPremultipliedRenderColor(z?null:T),D=r.properties.get("space-color-use-theme")==="none",N=r.properties.get("space-color").toNonPremultipliedRenderColor(D?null:T),B=5e-4,G=s.es(r.properties.get("horizon-blend"),0,1,B,.25),$=s.dE(t,h,g)&&G===B?g.worldSize/(2*Math.PI*1.025)-1:g.globeRadius,X=t.frameCounter/1e3%1,J=s.ag(g.globeCenterInViewSpace),K=Math.sqrt(Math.pow(J,2)-Math.pow($,2)),ue=Math.acos(K/J),oe=le=>{const re=g.projection.name==="globe"?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];le&&re.push("ALPHA_PASS");const te=t.getOrCreateProgram("globeAtmosphere",{defines:re}),he=((ye,ze,Oe,$e,ot,Ae,_e,Ne,Re,Ke,pt,wt)=>({u_frustum_tl:ye,u_frustum_tr:ze,u_frustum_br:Oe,u_frustum_bl:$e,u_horizon:ot,u_transition:Ae,u_fadeout_range:_e,u_atmosphere_fog_color:Ne.toArray01(),u_high_color:Re.toArray01(),u_space_color:Ke.toArray01(),u_temporal_offset:pt,u_horizon_angle:wt}))(g.frustumCorners.TL,g.frustumCorners.TR,g.frustumCorners.BR,g.frustumCorners.BL,g.frustumCorners.horizon,w,G,M,L,N,X,ue);t.uploadCommonUniforms(h,te);const we=this.atmosphereBuffer;we&&te.draw(t,p.TRIANGLES,y,Jt.disabled,le?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,Yt.backCW,he,le?"atmosphere_glow_alpha":"atmosphere_glow",we.vertexBuffer,we.indexBuffer,we.segments)};oe(!1),oe(!0)}drawStars(t,r){const h=s.aA(r.properties.get("star-intensity"),0,1);if(h===0)return;const p=t.context,g=p.gl,y=t.transform,w=t.getOrCreateProgram("stars"),T=s.c7([]);s.c9(T,T,-y._pitch),s.c8(T,T,-y.angle),s.c9(T,T,s.an(y._center.lat)),s.et(T,T,-s.an(y._center.lng));const A=s.cc(new Float32Array(16),T),M=s.aB([],y.starsProjMatrix,A),z=s.eo([],A),L=s.eu([],z),D=[0,1,0];s.dQ(D,D,L),s.c5(D,D,this.params.sizeMultiplier);const N=[1,0,0];s.dQ(N,N,L),s.c5(N,N,this.params.sizeMultiplier);const B=(G=D,$=N,X=h,{u_matrix:Float32Array.from(M),u_up:G,u_right:$,u_intensity_multiplier:X});var G,$,X;t.uploadCommonUniforms(p,w),this.starsVx&&this.starsIdx&&w.draw(t,g.TRIANGLES,Dt.disabled,Jt.disabled,this.colorModeAlphaBlendedWriteRGB,Yt.disabled,B,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}class zd{constructor(){this.visibleTiles=[]}updateBorders(t,r){const h=[],p=[],g=t._getRenderableCoordinates(!1,!0);for(const T of g){const A=t.getTile(T);if(!A.hasData())continue;const M=A.getBucket(r);M&&(M.isEmpty()||(h.push(T.key),p.push({bucket:M,tileID:T.canonical})))}let y=h.length!==this.visibleTiles.length;if(!y){h.sort();for(let T=0;T<h.length;T++)if(h[T]!==this.visibleTiles[T]){y=!0;break}}if(!y)return;const w=new Set;this.visibleTiles=h,p.sort((T,A)=>T.tileID.z-A.tileID.z||T.tileID.x-A.tileID.x||T.tileID.y-A.tileID.y);for(const T of p){const A=new Array,M=new Array,z=T.bucket;for(const L of z.featuresOnBorder)w.has(L.featureId)?M.push(L.footprintIndex):(w.add(L.featureId),A.push(L.footprintIndex));z.updateFootprintHiddenFlags(A,s.ev,!1),z.updateFootprintHiddenFlags(M,s.ev,!0)}}}function Dd(u,t){const r=[...u],h=t.cameraWorldSizeForFog/t.worldSize,p=s.bA([]);return s.cS(p,p,[h,h,1]),s.aB(r,p,r),s.aB(r,t.worldToFogMatrix,r),r}function Od(u,t,r,h,p){const g=r.material,y=h.context,{baseColorTexture:w,metallicRoughnessTexture:T}=g.pbrMetallicRoughness,{normalTexture:A,occlusionTexture:M,emissionTexture:z}=g;function L(N,B,G){if(N&&(u.push(B),y.activeTexture.set(y.gl.TEXTURE0+G),N.gfxTexture)){const{minFilter:$,magFilter:X,wrapS:J,wrapT:K}=N.sampler;N.gfxTexture.bindExtraParam($,X,J,K)}}L(w,"HAS_TEXTURE_u_baseColorTexture",Cr.BaseColor),L(T,"HAS_TEXTURE_u_metallicRoughnessTexture",Cr.MetallicRoughness),L(A,"HAS_TEXTURE_u_normalTexture",Cr.Normal),L(M,"HAS_TEXTURE_u_occlusionTexture",Cr.Occlusion),L(z,"HAS_TEXTURE_u_emissionTexture",Cr.Emission),p&&(p.texture||(p.texture=new s.d$(h.context,p.image,[p.image.height,p.image.height,p.image.height],y.gl.RGBA8)),y.activeTexture.set(y.gl.TEXTURE0+Cr.LUT),p.texture&&p.texture.bind(y.gl.LINEAR,y.gl.CLAMP_TO_EDGE),u.push("APPLY_LUT_ON_GPU")),r.texcoordBuffer&&(u.push("HAS_ATTRIBUTE_a_uv_2f"),t.push(r.texcoordBuffer)),r.colorBuffer&&(u.push(r.colorBuffer.itemSize===12?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),t.push(r.colorBuffer)),r.normalBuffer&&(u.push("HAS_ATTRIBUTE_a_normal_3f"),t.push(r.normalBuffer)),r.pbrBuffer&&(u.push("HAS_ATTRIBUTE_a_pbr"),u.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),t.push(r.pbrBuffer)),g.alphaMode!=="OPAQUE"&&g.alphaMode!=="MASK"||u.push("UNPREMULT_TEXTURE_IN_SHADER"),g.defined||u.push("DIFFUSE_SHADED");const D=h.shadowRenderer;D&&(u.push("RENDER_SHADOWS","DEPTH_TEXTURE"),D.useNormalOffset&&u.push("NORMAL_OFFSET"))}function Fd(u,t,r,h,p,g){const y=u.modelOpacity,w=t.context,T=new Dt(t.context.gl.LEQUAL,u.isLightMesh?Dt.ReadOnly:Dt.ReadWrite,t.depthRangeFor3D),A=t.transform,M=u.mesh,z=M.material,L=z.pbrMetallicRoughness,D=t.style.fog;let N;N=t.transform.projection.zAxisUnit==="pixels"?[...u.nodeModelMatrix]:s.aB([],h.zScaleMatrix,u.nodeModelMatrix),s.aB(N,h.negCameraPosMatrix,N);const B=s.bl([],N);s.eg(B,B);const G=r.paint.get("model-color-use-theme").constantOr("default")==="none",$=r.paint.get("model-emissive-strength").constantOr(0),X=Vl(new Float32Array(u.worldViewProjection),new Float32Array(N),new Float32Array(B),null,t,y,L.baseColorFactor,z.emissiveFactor,L.metallicFactor,L.roughnessFactor,z,$,r,void 0,void 0,u.materialOverride,u.modelColor),J={defines:[]},K=[],ue=t.shadowRenderer;ue&&(ue.useNormalOffset=!1),Od(J.defines,K,M,t,G?null:r.lut);let oe=null;if(D){const te=Dd(u.nodeModelMatrix,t.transform);if(oe=new Float32Array(te),A.projection.name!=="globe"){const he=M.aabb.min,we=M.aabb.max,[ye,ze]=D.getOpacityForBounds(te,he[0],he[1],we[0],we[1]);J.overrideFog=ye>=Ge||ze>=Ge}}const le=Ya(t,r.paint.get("model-cutoff-fade-range"));le.shouldRenderCutoff&&J.defines.push("RENDER_CUTOFF");const re=t.getOrCreateProgram("model",J);t.uploadCommonUniforms(w,re,null,oe,le),t.renderPass!=="shadow"&&ue&&ue.setupShadowsFromMatrix(u.nodeModelMatrix,re),re.draw(t,w.gl.TRIANGLES,T,p,g,M.material.doubleSided?Yt.disabled:Yt.backCCW,X,r.id,M.vertexBuffer,M.indexBuffer,M.segments,r.paint,t.transform.zoom,void 0,K)}function Ju(u,t){return u.style._importedAsBasemap?"basemap":t.scope}function Zl(u,t,r,h,p,g,y,w,T,A){const M=u.transform,z=!!t.isGeometryBloom&&t.isGeometryBloom;if(z&&u.renderPass==="shadow")return;const L=M.projection.name==="globe"?s.eD(r,M):[...r];s.aB(L,L,t.globalMatrix);const D=s.aB([],h,L);if(t.meshes)for(const N of t.meshes){const B=w.get(N.material.name);if(B&&B.opacity<=0)continue;if(N.material.alphaMode!=="BLEND"){y.push({mesh:N,depth:0,modelIndex:p,worldViewProjection:D,nodeModelMatrix:L,isLightMesh:z,materialOverride:B,modelOpacity:T,modelColor:A});continue}const G=s.af([],N.centroid,D);!M.isOrthographic&&G[2]<=0||g.push({mesh:N,depth:G[2],modelIndex:p,worldViewProjection:D,nodeModelMatrix:L,isLightMesh:z,materialOverride:B,modelOpacity:T,modelColor:A})}if(t.children)for(const N of t.children)Zl(u,N,r,h,p,g,y,w,T,A)}function xs(u,t,r,h){const p=r.shadowRenderer;if(!p)return;const g=p.getShadowPassDepthMode(),y=p.getShadowPassColorMode(),w=p.calculateShadowPassMatrixFromMatrix(t),T=Zp(w);r.getOrCreateProgram("modelDepth",{defines:r._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(r,r.context.gl.TRIANGLES,g,Jt.disabled,y,Yt.disabled,T,h.id,u.vertexBuffer,u.indexBuffer,u.segments,h.paint,r.transform.zoom,void 0,void 0)}function Qg(u,t,r,h,p,g){for(const y of p){const w=Object.assign({},h);w.part=y;const T={type:"Unknown",id:t,properties:w},A={orientation:u.paint.get("model-rotation").evaluate(T,r)};g.set(y,A)}}function ey(u,t,r,h,p,g){for(const y of p){const w=Object.assign({},h);w.part=y;const T={type:"Unknown",id:t,properties:w},A={color:u.paint.get("model-color").evaluate(T,r),colorMix:u.paint.get("model-color-mix-intensity").evaluate(T,r),opacity:u.paint.get("model-opacity").evaluate(T,r),emissionStrength:u.paint.get("model-emissive-strength").evaluate(T,r)};g.set(y,A)}}function ty(u,t,r,h,p){let g=!1;for(const w of h)w.modelOpacity!==1&&(Fd(w,u,t,p[w.modelIndex],Jt.disabled,ai.disabled),g=!0);for(const w of h)Fd(w,u,t,p[w.modelIndex],w.modelOpacity!==1?u.stencilModeFor3D():Jt.disabled,u.colorModeForRenderPass());g&&u.resetStencilClippingMasks();const y=ai.additive;for(const w of r)Fd(w,u,t,p[w.modelIndex],Jt.disabled,w.isLightMesh?y:u.colorModeForRenderPass())}function iy(u,t,r){const h=t.updateZoomBasedPaintProperties(),p=function(g,y,w){let T,A,M,z=g.terrain?g.terrain.exaggeration():0;if(g.terrain&&z>0){const L=g.terrain,D=L.findDEMTileFor(w);D&&D.dem?T=s.eF.create(L,w,D):z=0}if(z===0&&(y.terrainElevationMin=0,y.terrainElevationMax=0),z===y.validForExaggeration&&(z===0||T&&T._demTile&&T._demTile.tileID===y.validForDEMTile.id&&T._dem._timestamp===y.validForDEMTile.timestamp))return!1;for(const L in y.instancesPerModel){const D=y.instancesPerModel[L];for(let N=0;N<D.instancedDataArray.length;++N){const B=(T?z*T.getElevationAt(0|D.instancedDataArray.float32[16*N],0|D.instancedDataArray.float32[16*N+1],!0,!0):0)+D.instancesEvaluatedElevation[N];D.instancedDataArray.float32[16*N+6]=B,A=A?Math.min(y.terrainElevationMin,B):B,M=M?Math.max(y.terrainElevationMax,B):B}}return y.terrainElevationMin=A||0,y.terrainElevationMax=M||0,y.validForExaggeration=z,y.validForDEMTile=T&&T._demTile?{id:T._demTile.tileID,timestamp:T._dem._timestamp}:{id:void 0,timestamp:0},!0}(u,t,r);(h||p)&&(t.uploaded=!1,t.upload(u.context))}const Gs={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new s.d9([0,0,0],[s.al,s.al,0])};function lo(u,t){const r=1<<u.canonical.z,h=t.getFreeCameraOptions().position,p=t.elevation,g=u.canonical.x/r,y=(u.canonical.x+1)/r,w=u.canonical.y/r,T=(u.canonical.y+1)/r;let A=t._centerAltitude;if(p){const D=p.getMinMaxForTile(u);D&&D.max>A&&(A=D.max)}const M=s.aA(h.x,g,y)-h.x,z=s.aA(h.y,w,T)-h.y,L=s.cf(A,t.center.lat)-h.z;return t._zoomFromMercatorZ(Math.sqrt(M*M+z*z+L*L))}function ny(u,t,r,h,p,g,y){const w=u.context,T=u.renderPass==="shadow",A=u.shadowRenderer,M=T&&A?A.getShadowPassDepthMode():new Dt(w.gl.LEQUAL,Dt.ReadWrite,u.depthRangeFor3D),z=u.isTileAffectedByFog(g),L=u.transform.projection.name==="globe";if(r.meshes)for(const D of r.meshes){const N=L?[]:["MODEL_POSITION_ON_GPU"],B=[];let G,$,X;const J=!L&&h.instancedDataArray.length>20;J&&N.push("INSTANCED_ARRAYS");const K=Ya(u,t.paint.get("model-cutoff-fade-range"));if(K.shouldRenderCutoff&&N.push("RENDER_CUTOFF"),T&&A)G=u.getOrCreateProgram("modelDepth",{defines:N}),$=Zp(y.shadowTileMatrix,y.shadowTileMatrix,Float32Array.from(r.globalMatrix)),X=A.getShadowPassColorMode();else{Od(N,B,D,u,t.paint.get("model-color-use-theme").constantOr("default")==="none"?null:t.lut),G=u.getOrCreateProgram("model",{defines:N,overrideFog:z});const oe=D.material,le=oe.pbrMetallicRoughness,re=t.paint.get("model-opacity").constantOr(1),te=t.paint.get("model-emissive-strength").constantOr(0);$=Vl(g.expandedProjMatrix,Float32Array.from(r.globalMatrix),new Float32Array(16),null,u,re,le.baseColorFactor,oe.emissiveFactor,le.metallicFactor,le.roughnessFactor,oe,te,t,p),A&&(y.shadowUniformsInitialized?G.setShadowUniformValues(w,A.getShadowUniformValues()):(A.setupShadows(g.toUnwrapped(),G,"model-tile"),y.shadowUniformsInitialized=!0)),X=K.shouldRenderCutoff||re<1||oe.alphaMode!=="OPAQUE"?ai.alphaBlended:ai.unblended}u.uploadCommonUniforms(w,G,g.toUnwrapped(),null,K);const ue=D.material.doubleSided?Yt.disabled:Yt.backCCW;if(J)B.push(h.instancedDataBuffer),G.draw(u,w.gl.TRIANGLES,M,Jt.disabled,X,ue,$,t.id,D.vertexBuffer,D.indexBuffer,D.segments,t.paint,u.transform.zoom,void 0,B,h.instancedDataArray.length);else{const oe=T?"u_instance":"u_normal_matrix";for(let le=0;le<h.instancedDataArray.length;++le)$[oe]=new Float32Array(h.instancedDataArray.arrayBuffer,64*le,16),G.draw(u,w.gl.TRIANGLES,M,Jt.disabled,X,ue,$,t.id,D.vertexBuffer,D.indexBuffer,D.segments,t.paint,u.transform.zoom,void 0,B)}}if(r.children)for(const D of r.children)ny(u,t,D,h,p,g,y)}const Qu=[1,-1,1];function Qv(u,t,r,h){if(!r.modelManager)return!0;const p=r.modelManager;if(!r.shadowRenderer)return!0;const g=r.shadowRenderer,y=t.aabb;let w=!0,T=u.maxHeight;if(T===0){let M=0;for(const z in u.instancesPerModel){const L=p.getModel(z,h);L?M=Math.max(M,Math.max(Math.max(L.aabb.max[0],L.aabb.max[1]),L.aabb.max[2])):w=!1}T=u.maxScale*M*1.41+u.maxVerticalOffset,w&&(u.maxHeight=T)}y.max[2]=T,y.min[2]+=u.terrainElevationMin,y.max[2]+=u.terrainElevationMax,s.af(y.min,y.min,t.tileMatrix),s.af(y.max,y.max,t.tileMatrix);const A=y.intersects(g.getCurrentCascadeFrustum());return r.currentShadowCascade===0&&(u.isInsideFirstShadowMapFrustum=A===2),A===0}function vn(u,t){const r=u.uniformValues.u_cutoff_params[0],h=u.uniformValues.u_cutoff_params[1],p=u.uniformValues.u_cutoff_params[2],g=u.uniformValues.u_cutoff_params[3];return h===r||g===p?1:s.aA(((t-r)/(h-r)-p)/(g-p),0,1)}function _i(u,t,r,h){if(t.pitch<20)return 1;const p=t.getWorldToCameraMatrix();s.aB(p,p,u);const g=s.bU(r.min[0],r.min[1],r.min[2],1);let y=s.aC(s.eG(),g,p),w=y,T=y;g[1]=r.max[1],y=s.aC(s.eG(),g,p),w=y[1]<w[1]?y:w,T=y[1]>T[1]?y:T,g[0]=r.max[0],y=s.aC(s.eG(),g,p),w=y[1]<w[1]?y:w,T=y[1]>T[1]?y:T,g[1]=r.min[1],y=s.aC(s.eG(),g,p),w=y[1]<w[1]?y:w,T=y[1]>T[1]?y:T;const A=s.aA(h[0],0,1),M=100*t.pixelsPerMeter*s.aA(h[1],0,1),z=s.aA(h[2],0,1),L=s.eH(s.eG(),w,T,A),D=Math.tan(.5*t.fovX),N=-L[2]*D;if(M===0)return L[1]<-Math.abs(N)?z:1;const B=(-Math.abs(N)-L[1])/M,G=(X,J,K)=>(1-K)*X+K*J,$=s.aA(G(1,z,B),z,1);return G(1,$,s.aA((t.pitch-20)/20,0,1))}class ry{}class al{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(t,r,h){{const z=this._storage.get(r.id);if(z)return z.lastUsedFrameIdx=t,z.buf}const p=h.gl,g=p.getBufferParameter(p.ELEMENT_ARRAY_BUFFER,p.BUFFER_SIZE),y=new ArrayBuffer(g),w=new Int16Array(y);p.getBufferSubData(p.ELEMENT_ARRAY_BUFFER,0,new Int16Array(y));const T=new s.eJ;for(let z=0;z<g/2;z+=3){const L=w[z],D=w[z+1],N=w[z+2];T.emplaceBack(L,D),T.emplaceBack(D,N),T.emplaceBack(N,L)}const A=h.bindVertexArrayOES.current,M=new ry;return M.buf=new vs(h,T),M.lastUsedFrameIdx=t,this._storage.set(r.id,M),h.bindVertexArrayOES.set(A),M.buf}update(t){for(const[r,h]of this._storage)t-h.lastUsedFrameIdx>30&&(h.buf.destroy(),this._storage.delete(r))}destroy(){for(const[t,r]of this._storage)r.buf.destroy(),this._storage.delete(t)}}class Dc{constructor(){this.occluderSize=30,this.depthOffset=-1e-4}}const Oc=s.ei([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_rainParticleData",components:4}]);class _a{constructor(t){this.revealStart=11,this.revealRange=2}}const em=s.ei([{type:"Float32",name:"a_pos_2f",components:2}]);class tm{destroy(){this.vignetteVx&&this.vignetteVx.destroy(),this.vignetteIdx&&this.vignetteIdx.destroy()}draw(t,r){const h=t.getOrCreateProgram("vignette");if(!this.vignetteVx||!this.vignetteIdx){const y=new s.eK,w=new s.b0;y.emplaceBack(-1,-1),y.emplaceBack(1,-1),y.emplaceBack(1,1),y.emplaceBack(-1,1),w.emplaceBack(0,1,2),w.emplaceBack(0,2,3),this.vignetteVx=t.context.createVertexBuffer(y,em.members),this.vignetteIdx=t.context.createIndexBuffer(w)}const p=s.bg.simpleSegment(0,0,4,6);if(this.vignetteVx&&this.vignetteIdx){t.uploadCommonUniforms(t.context,h);const y={u_vignetteShape:(g={vignetteShape:[r.start,r.range,Math.pow(10,r.fadePower)],vignetteColor:[r.color.r,r.color.g,r.color.b,r.color.a*r.strength]}).vignetteShape,u_vignetteColor:g.vignetteColor};h.draw(t,t.context.gl.TRIANGLES,Dt.disabled,Jt.disabled,ai.alphaBlended,Yt.disabled,y,"vignette",this.vignetteVx,this.vignetteIdx,p)}var g}}class im{constructor(){this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0}update(t,r){const h=t.getFreeCameraOptions().position,p=h.toAltitude(),g=h.toLngLat(),y=s.an(g.lng),w=s.an(g.lat),T=t.pixelsPerMeter/r,A=y*s.eM,M=s.eM*Math.log(Math.tan(Math.PI/4+w/2));if(this._offsetXPrev===void 0)this._offsetXPrev=0,this._offsetYPrev=0,this._elevationPrev=0,this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0;else{const z=-this._offsetYPrev+M,L=-this._elevationPrev+p;this._accumulatedOffsetX+=(-this._offsetXPrev+A)*T,this._accumulatedOffsetY+=z*T,this._accumulatedElevation+=L*T,this._offsetXPrev=A,this._offsetYPrev=M,this._elevationPrev=p}}getPosition(){return[this._accumulatedOffsetX,this._accumulatedOffsetY,this._accumulatedElevation]}}function Bd(u,t){return[-(u[0]-Math.floor(u[0]/t)*t),-(u[1]-Math.floor(u[1]/t)*t),-(u[2]-Math.floor(u[2]/t)*t)]}function Fo(u){const t=s.eq(1323123451230),r=[];for(let h=0;h<u;++h){const p=2*t()-1,g=2*t()-1,y=2*t()-1;r.push(s.d5(p,g,y))}return r}function yo(u,t,r,h,p){const g=s.aA((p-r)/(h-r),0,1);return(1-g)*u+g*t}class Xl{constructor(t){this._movement=new im,this._accumulatedTimeFromStart=0,this._prevTime=Date.now()/1e3,this._vignette=new tm,this._ppmScaleFactor=t}destroy(){this.particlesVx&&this.particlesVx.destroy(),this.particlesIdx&&this.particlesIdx.destroy(),this._vignette&&this._vignette.destroy()}updateOnRender(t,r){const h=t.transform;this._movement.update(h,this._ppmScaleFactor);const p=h.starsProjMatrix,g=s.c7([]);s.c9(g,g,s.an(90)-h._pitch),s.c8(g,g,-h.angle);const y=s.cc(new Float32Array(16),g),w=s.eL(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),T=s.eg([],w),A=s.aB([],T,y),M=Date.now()/1e3;return this._accumulatedTimeFromStart+=(M-this._prevTime)*r,this._prevTime=M,{projectionMatrix:p,modelviewMatrix:A}}}class Nd extends Xl{constructor(t){super(4.25),this._params={overrideStyleParameters:!1,intensity:.5,timeFactor:1,velocityConeAperture:0,velocity:300,boxSize:2500,dropletSizeX:1,dropletSizeYScale:10,distortionStrength:70,screenThinning:{intensity:.57,start:.46,range:1.17,fadePower:.17,affectedRatio:1,particleOffset:-.2},color:{r:.66,g:.68,b:.74,a:.7},direction:{x:-50,y:-35},shapeDirPower:2,shapeNormalPower:1},this._revealParams=new _a("Precipitation > Rain"),this._vignetteParams={strength:1,start:.7,range:1,fadePower:.4,color:{r:.27,g:.27,b:.27,a:1}},this.particlesCount=16e3}update(t){const r=t.context;if(!this.particlesVx){const h=Fo(this.particlesCount),p=new s.eN,g=new s.b0;let y=0;const w=s.eq(1323123451230);for(let T=0;T<h.length;++T){const A=h[T],M=[2*w()-1,w(),w(),w()];p.emplaceBack(A[0],A[1],A[2],-1,-1,...M),p.emplaceBack(A[0],A[1],A[2],1,-1,...M),p.emplaceBack(A[0],A[1],A[2],1,1,...M),p.emplaceBack(A[0],A[1],A[2],-1,1,...M),g.emplaceBack(y+0,y+1,y+2),g.emplaceBack(y+0,y+2,y+3),y+=4}this.particlesVx=r.createVertexBuffer(p,Oc.members),this.particlesIdx=r.createIndexBuffer(g)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.rain)return;const r=this._params.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},h=t.transform.zoom;if(r.revealStart>h)return;const p=yo(0,1,r.revealStart,r.revealStart+r.revealRange,h);if(!this.particlesVx||!this.particlesIdx)return;const g=structuredClone(this._params);let y=[-g.direction.x,g.direction.y,-100];s.aw(y,y);const w=structuredClone(this._vignetteParams);w.strength*=p,g.overrideStyleParameters||(g.intensity=t.style.rain.state.density,g.timeFactor=t.style.rain.state.intensity,g.color=structuredClone(t.style.rain.state.color),y=structuredClone(t.style.rain.state.direction),g.screenThinning.intensity=t.style.rain.state.centerThinning,g.dropletSizeX=t.style.rain.state.dropletSize[0],g.dropletSizeYScale=t.style.rain.state.dropletSize[1]/t.style.rain.state.dropletSize[0],g.distortionStrength=100*t.style.rain.state.distortionStrength,w.strength=1,w.color=structuredClone(t.style.rain.state.vignetteColor));const T=this.updateOnRender(t,g.timeFactor),A=t.context,M=A.gl,z=t.transform;this.screenTexture&&this.screenTexture.size[0]===t.width&&this.screenTexture.size[1]===t.height||(this.screenTexture=new s.T(A,{width:t.width,height:t.height,data:null},M.RGBA8)),g.distortionStrength>0&&(A.activeTexture.set(M.TEXTURE0),this.screenTexture.bind(M.LINEAR,M.CLAMP_TO_EDGE),M.copyTexSubImage2D(M.TEXTURE_2D,0,0,0,0,0,t.width,t.height));const L=t.getOrCreateProgram("rainParticle");t.uploadCommonUniforms(A,L),A.activeTexture.set(M.TEXTURE0),this.screenTexture.bind(M.LINEAR,M.CLAMP_TO_EDGE);const D=[g.color.r,g.color.g,g.color.b,g.color.a],N=(B,G)=>{const $=Bd(this._movement.getPosition(),B),X=g.dropletSizeX,J=g.dropletSizeX*g.dropletSizeYScale,K=t.width/2,ue=t.height/2,oe=yo(0,g.screenThinning.start,0,1,g.screenThinning.intensity),le=yo(.001,g.screenThinning.range,0,1,g.screenThinning.intensity),re=yo(0,g.screenThinning.particleOffset,0,1,g.screenThinning.intensity),te=(he={modelview:T.modelviewMatrix,projection:T.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:$,velocityConeAperture:g.velocityConeAperture,velocity:g.velocity,boxSize:B,rainDropletSize:[X,J],distortionStrength:g.distortionStrength,rainDirection:y,color:D,screenSize:[z.width,z.height],thinningCenterPos:[K,ue],thinningShape:[oe,le,Math.pow(10,g.screenThinning.fadePower)],thinningAffectedRatio:g.screenThinning.affectedRatio,thinningParticleOffset:re,shapeDirectionalPower:g.shapeDirPower,shapeNormalPower:g.shapeNormalPower,mode:G?0:1},{u_modelview:Float32Array.from(he.modelview),u_projection:Float32Array.from(he.projection),u_time:he.time,u_cam_pos:he.camPos,u_texScreen:0,u_velocityConeAperture:he.velocityConeAperture,u_velocity:he.velocity,u_boxSize:he.boxSize,u_rainDropletSize:he.rainDropletSize,u_distortionStrength:he.distortionStrength,u_rainDirection:he.rainDirection,u_color:he.color,u_screenSize:he.screenSize,u_thinningCenterPos:he.thinningCenterPos,u_thinningShape:he.thinningShape,u_thinningAffectedRatio:he.thinningAffectedRatio,u_thinningParticleOffset:he.thinningParticleOffset,u_shapeDirectionalPower:he.shapeDirectionalPower,u_shapeNormalPower:he.shapeNormalPower,u_mode:he.mode});var he;const we=Math.round(g.intensity*this.particlesCount),ye=s.bg.simpleSegment(0,0,4*we,2*we);L.draw(t,M.TRIANGLES,Dt.disabled,Jt.disabled,ai.alphaBlended,Yt.disabled,te,"rain_particles",this.particlesVx,this.particlesIdx,ye)};g.distortionStrength>0&&N(g.boxSize,!0),N(g.boxSize,!1),this._vignette.draw(t,w)}}const nm=s.ei([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_snowParticleData",components:4},{type:"Float32",name:"a_snowParticleDataHorizontalOscillation",components:2}]);class rm extends Xl{constructor(t){super(2.25),this._params={overrideStyleParameters:!1,intensity:.85,timeFactor:.75,velocityConeAperture:70,velocity:40,horizontalOscillationRadius:4,horizontalOscillationRate:1.5,boxSize:2e3,billboardSize:2,shapeFadeStart:.27,shapeFadePower:.21,screenThinning:{intensity:.4,start:.15,range:1.4,fadePower:.24,affectedRatio:1,particleOffset:-.2},color:{r:1,g:1,b:1,a:1},direction:{x:-50,y:-35}},this._revealParams=new _a("Precipitation > Snow"),this._vignetteParams={strength:.3,start:.78,range:.46,fadePower:.2,color:{r:1,g:1,b:1,a:1}},this.particlesCount=16e3}update(t){const r=t.context;if(!this.particlesVx){const h=Fo(this.particlesCount),p=new s.eO,g=new s.b0;let y=0;const w=s.eq(1323123451230);for(let T=0;T<h.length;++T){const A=h[T],M=w(),z=w(),L=w(),D=[T/h.length,M,z,L],N=[w(),w()];p.emplaceBack(A[0],A[1],A[2],-1,-1,...D,...N),p.emplaceBack(A[0],A[1],A[2],1,-1,...D,...N),p.emplaceBack(A[0],A[1],A[2],1,1,...D,...N),p.emplaceBack(A[0],A[1],A[2],-1,1,...D,...N),g.emplaceBack(y+0,y+1,y+2),g.emplaceBack(y+0,y+2,y+3),y+=4}this.particlesVx=r.createVertexBuffer(p,nm.members),this.particlesIdx=r.createIndexBuffer(g)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.snow)return;const r=structuredClone(this._params);let h=[-r.direction.x,r.direction.y,-100];s.aw(h,h);const p=structuredClone(this._vignetteParams),g=r.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},y=t.transform.zoom;if(g.revealStart>y)return;const w=yo(0,1,g.revealStart,g.revealStart+g.revealRange,y);p.strength*=w,r.overrideStyleParameters||(r.intensity=t.style.snow.state.density,r.timeFactor=t.style.snow.state.intensity,r.color=structuredClone(t.style.snow.state.color),h=structuredClone(t.style.snow.state.direction),r.screenThinning.intensity=t.style.snow.state.centerThinning,r.billboardSize=2.79*t.style.snow.state.flakeSize,p.strength=1,p.color=structuredClone(t.style.snow.state.vignetteColor));const T=this.updateOnRender(t,r.timeFactor);if(!this.particlesVx||!this.particlesIdx)return;const A=t.context,M=A.gl,z=t.transform,L=t.getOrCreateProgram("snowParticle");t.uploadCommonUniforms(A,L),((D,N,B)=>{const G=Bd(this._movement.getPosition(),D),$=z.width/2,X=z.height/2,J=yo(0,B.screenThinning.start,0,1,B.screenThinning.intensity),K=yo(.001,B.screenThinning.range,0,1,B.screenThinning.intensity),ue=yo(0,B.screenThinning.particleOffset,0,1,B.screenThinning.intensity),oe=(le={modelview:T.modelviewMatrix,projection:T.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:G,velocityConeAperture:B.velocityConeAperture,velocity:B.velocity,horizontalOscillationRadius:B.horizontalOscillationRadius,horizontalOscillationRate:B.horizontalOscillationRate,boxSize:D,billboardSize:1*B.billboardSize,simpleShapeParameters:[B.shapeFadeStart,B.shapeFadePower],screenSize:[z.width,z.height],thinningCenterPos:[$,X],thinningShape:[J,K,Math.pow(10,B.screenThinning.fadePower)],thinningAffectedRatio:B.screenThinning.affectedRatio,thinningParticleOffset:ue,color:[B.color.r,B.color.g,B.color.b,B.color.a],direction:h},{u_modelview:Float32Array.from(le.modelview),u_projection:Float32Array.from(le.projection),u_time:le.time,u_cam_pos:le.camPos,u_velocityConeAperture:le.velocityConeAperture,u_velocity:le.velocity,u_horizontalOscillationRadius:le.horizontalOscillationRadius,u_horizontalOscillationRate:le.horizontalOscillationRate,u_boxSize:le.boxSize,u_billboardSize:le.billboardSize,u_simpleShapeParameters:le.simpleShapeParameters,u_screenSize:le.screenSize,u_thinningCenterPos:le.thinningCenterPos,u_thinningShape:le.thinningShape,u_thinningAffectedRatio:le.thinningAffectedRatio,u_thinningParticleOffset:le.thinningParticleOffset,u_particleColor:le.color,u_direction:le.direction});var le;const re=Math.round(B.intensity*this.particlesCount),te=s.bg.simpleSegment(0,0,4*re,2*re);this.particlesVx&&this.particlesIdx&&L.draw(t,M.TRIANGLES,Dt.disabled,Jt.disabled,ai.alphaBlended,Yt.disabled,oe,"snow_particles",this.particlesVx,this.particlesIdx,te)})(r.boxSize,0,r),this._vignette.draw(t,p)}}const ll={symbol:function(u,t,r,h,p){if(u.renderPass!=="translucent")return;const g=Jt.disabled,y=u.colorModeForRenderPass(),w=r.layout.get("text-variable-anchor"),T=r.layout.get("text-size-scale-range"),A=s.aA(u.scaleFactor,T[0],T[1]);w&&function(L,D,N,B,G,$,X,J){const K=D.transform,ue=G==="map",oe=$==="map";for(const le of L){const re=B.getTile(le),te=re.getBucket(N);if(!te||!te.text||!te.text.segments.get().length)continue;const he=s.bK(te.textSizeData,K.zoom,J),we=Fs(le,te.getProjection(),K),ye=K.calculatePixelsToTileUnitsMatrix(re),ze=Jr(we,re.tileID.canonical,oe,ue,K,te.getProjection(),ye),Oe=te.hasIconTextFit()&&te.hasIconData();he&&Gt(te,ue,oe,X,K,ze,le,Math.pow(2,K.zoom-re.tileID.overscaledZ),he,Oe)}}(h,u,r,t,r.layout.get("text-rotation-alignment"),r.layout.get("text-pitch-alignment"),p,A);const M=r.paint.get("icon-opacity").constantOr(1)!==0,z=r.paint.get("text-opacity").constantOr(1)!==0;r.layout.get("symbol-sort-key").constantOr(1)!==void 0&&(M||z)?Xu(u,t,r,h,g,y):(M&&Xu(u,t,r,h,g,y,{onlyIcons:!0}),z&&Xu(u,t,r,h,g,y,{onlyText:!0})),t.map.showCollisionBoxes&&(It(u,t,r,h,r.paint.get("text-translate"),r.paint.get("text-translate-anchor"),!0),It(u,t,r,h,r.paint.get("icon-translate"),r.paint.get("icon-translate-anchor"),!1))},circle:function(u,t,r,h){if(u.renderPass!=="translucent")return;const p=r.paint.get("circle-opacity"),g=r.paint.get("circle-stroke-width"),y=r.paint.get("circle-stroke-opacity"),w=r.layout.get("circle-sort-key").constantOr(1)!==void 0,T=r.paint.get("circle-emissive-strength");if(p.constantOr(1)===0&&(g.constantOr(1)===0||y.constantOr(1)===0))return;const A=u.context,M=A.gl,z=u.transform,L=!(!u.terrain||!u.terrain.enabled),D=r.layout.get("circle-elevation-reference"),N=u.depthModeForSublayer(0,Dt.ReadOnly),B=new Dt(u.context.gl.LEQUAL,Dt.ReadOnly,u.depthRangeFor3D),G=D==="none"||L?N:B,$=Jt.disabled,X=u.colorModeForDrapableLayerRenderPass(T),J=z.projection.name==="globe",K=[s.aF(z.center.lng),s.aJ(z.center.lat)],ue=[];for(let le=0;le<h.length;le++){const re=h[le],te=t.getTile(re),he=te.getBucket(r);if(!he||he.projection.name!==z.projection.name)continue;const we=he.programConfigurations.get(r.id),ye=he.layoutVertexBuffer,ze=he.globeExtVertexBuffer,Oe=he.indexBuffer,$e=s.e0(r),ot=[ze],Ae=u.isTileAffectedByFog(re);J&&$e.push("PROJECTION_GLOBE_VIEW"),$e.push("DEPTH_D24"),u.terrain&&z.depthOcclusionForSymbolsAndCircles&&$e.push("DEPTH_OCCLUSION"),he.hasElevation&&!u.terrain&&($e.push("ELEVATED_ROADS"),ot.push(he.elevatedLayoutVertexBuffer));const _e=u.getOrCreateProgram("circle",{config:we,defines:$e,overrideFog:Ae}),Ne=z.projection.createInversionMatrix(z,re.canonical),Re={programConfiguration:we,program:_e,layoutVertexBuffer:ye,dynamicBuffers:ot,indexBuffer:Oe,uniformValues:s.e1(u,re,te,Ne,K,r),tile:te};if(w){const Ke=he.segments.get();for(const pt of Ke)ue.push({segments:new s.bg([pt]),sortKey:pt.sortKey,state:Re})}else ue.push({segments:he.segments,sortKey:0,state:Re})}w&&ue.sort((le,re)=>le.sortKey-re.sortKey);const oe={useDepthForOcclusion:z.depthOcclusionForSymbolsAndCircles};for(const le of ue){const{programConfiguration:re,program:te,layoutVertexBuffer:he,dynamicBuffers:we,indexBuffer:ye,uniformValues:ze,tile:Oe}=le.state,$e=le.segments;u.terrain&&u.terrain.setupElevationDraw(Oe,te,oe),u.uploadCommonUniforms(A,te,Oe.tileID.toUnwrapped()),te.draw(u,M.TRIANGLES,G,$,X,Yt.disabled,ze,r.id,he,ye,$e,r.paint,z.zoom,re,we)}},heatmap:function(u,t,r,h){if(r.paint.get("heatmap-opacity")!==0)if(u.renderPass==="offscreen"){const p=u.context,g=p.gl,y=Jt.disabled,w=new ai([g.ONE,g.ONE,g.ONE,g.ONE],s.ao.transparent,[!0,!0,!0,!0]);(function(D,N,B,G){const $=D.gl,X=N.width*G,J=N.height*G;D.activeTexture.set($.TEXTURE1),D.viewport.set([0,0,X,J]);let K=B.heatmapFbo;if(!K||K&&(K.width!==X||K.height!==J)){K&&K.destroy();const ue=$.createTexture();$.bindTexture($.TEXTURE_2D,ue),$.texParameteri($.TEXTURE_2D,$.TEXTURE_WRAP_S,$.CLAMP_TO_EDGE),$.texParameteri($.TEXTURE_2D,$.TEXTURE_WRAP_T,$.CLAMP_TO_EDGE),$.texParameteri($.TEXTURE_2D,$.TEXTURE_MIN_FILTER,$.LINEAR),$.texParameteri($.TEXTURE_2D,$.TEXTURE_MAG_FILTER,$.LINEAR),K=B.heatmapFbo=D.createFramebuffer(X,J,1,null),function(oe,le,re,te,he,we){const ye=oe.gl;ye.texImage2D(ye.TEXTURE_2D,0,oe.extRenderToTextureHalfFloat?ye.RGBA16F:ye.RGBA,he,we,0,ye.RGBA,oe.extRenderToTextureHalfFloat?ye.HALF_FLOAT:ye.UNSIGNED_BYTE,null),te.colorAttachment0.set(re)}(D,0,ue,K,X,J)}else $.bindTexture($.TEXTURE_2D,K.colorAttachment0.get()),D.bindFramebuffer.set(K.framebuffer)})(p,u,r,u.transform.projection.name==="globe"?.5:.25),p.clear({color:s.ao.transparent});const T=u.transform,A=T.projection.name==="globe",M=A?["PROJECTION_GLOBE_VIEW"]:[],z=A?Yt.frontCCW:Yt.disabled,L=[s.aF(T.center.lng),s.aJ(T.center.lat)];for(let D=0;D<h.length;D++){const N=h[D];if(t.hasRenderableParent(N))continue;const B=t.getTile(N),G=B.getBucket(r);if(!G||G.projection.name!==T.projection.name)continue;const $=u.isTileAffectedByFog(N),X=G.programConfigurations.get(r.id),J=u.getOrCreateProgram("heatmap",{config:X,defines:M,overrideFog:$}),{zoom:K}=u.transform;u.terrain&&u.terrain.setupElevationDraw(B,J),u.uploadCommonUniforms(p,J,N.toUnwrapped());const ue=T.projection.createInversionMatrix(T,N.canonical);J.draw(u,g.TRIANGLES,Dt.disabled,y,w,z,Fg(u,N,B,ue,L,K,r.paint.get("heatmap-intensity")),r.id,G.layoutVertexBuffer,G.indexBuffer,G.segments,r.paint,u.transform.zoom,X,A?[G.globeExtVertexBuffer]:null)}p.viewport.set([0,0,u.width,u.height])}else u.renderPass==="translucent"&&(u.context.setColorMode(u.colorModeForRenderPass()),function(p,g){const y=p.context,w=y.gl,T=g.heatmapFbo;if(!T)return;y.activeTexture.set(w.TEXTURE0),w.bindTexture(w.TEXTURE_2D,T.colorAttachment0.get()),y.activeTexture.set(w.TEXTURE1);let A=g.colorRampTexture;A||(A=g.colorRampTexture=new s.T(y,g.colorRamp,w.RGBA8)),A.bind(w.LINEAR,w.CLAMP_TO_EDGE),p.getOrCreateProgram("heatmapTexture").draw(p,w.TRIANGLES,Dt.disabled,Jt.disabled,p.colorModeForRenderPass(),Yt.disabled,((M,z,L,D)=>({u_image:0,u_color_ramp:1,u_opacity:z.paint.get("heatmap-opacity")}))(0,g),g.id,p.viewportBuffer,p.quadTriangleIndexBuffer,p.viewportSegments,g.paint,p.transform.zoom)}(u,r))},line:function(u,t,r,h){if(u.renderPass!=="translucent")return;const p=r.paint.get("line-opacity"),g=r.paint.get("line-width");if(p.constantOr(1)===0||g.constantOr(1)===0)return;const y=r.paint.get("line-emissive-strength").isConstant(),w=r.paint.get("line-emissive-strength").constantOr(0),T=r.paint.get("line-occlusion-opacity"),A=r.layout.get("line-elevation-reference"),M=r.layout.get("line-width-unit")==="meters",z=A==="sea",L=!(!u.terrain||!u.terrain.enabled),D=u.context,N=D.gl;if(r.hasElevatedBuckets&&u.transform.projection.name==="globe")return;const B=r.layout.get("line-cross-slope"),G=B!==void 0,$=B<1,X=u.colorModeForDrapableLayerRenderPass(y?w:null),J=u.terrain&&u.terrain.renderingToTexture,K=J?1:s.o.devicePixelRatio,ue=r.paint.get("line-dasharray"),oe=ue.constantOr(1),le=r.layout.get("line-cap"),re=ue.constantOr(null),te=le.constantOr(null),he=r.paint.get("line-pattern"),we=he.constantOr(1),ye=r.paint.get("line-pattern-cross-fade"),ze=he.constantOr(null),Oe=r.paint.get("line-opacity").constantOr(1);let $e=!we&&Oe!==1||u.depthOcclusion&&T>0&&T<1;const ot=r.paint.get("line-gradient"),Ae=we?"linePattern":"line",_e=s.e2(r);let Ne;if(J&&u.terrain&&u.terrain.clipOrMaskOverlapStencilType()&&($e=!1),T!==0&&u.depthOcclusion){const wt=r.paint._values["line-opacity"];wt&&wt.value&&wt.value.kind==="constant"?Ne=wt.value:s.w(`Occlusion opacity for layer ${r.id} is supported only when line-opacity isn't data-driven.`)}g.value.kind!=="constant"&&g.value.isLineProgressConstant===!1&&_e.push("VARIABLE_LINE_WIDTH"),J&&(u.emissiveMode!=="dual-source-blending"||y?u.emissiveMode==="mrt-fallback"&&_e.push("USE_MRT1"):_e.push("DUAL_SOURCE_BLENDING"));const Re=(wt,ht,st,Rt,At,vt)=>{for(const Tt of wt){const Ut=t.getTile(Tt);if(we&&!Ut.patternsLoaded())continue;const ii=Ut.getBucket(r);if(!ii||ii.elevationType!=="none"&&!At||ii.elevationType==="none"&&At)continue;u.prepareDrawTile();const wi=[...ht],Ui=u.shadowRenderer,Lt=ii.elevationType==="road"&&!!Ui&&Ui.enabled;let Fi=[0,0,0];if(Lt){const ui=u.style.directionalLight,_n=u.style.ambientLight;ui&&_n&&(Fi=ua(u.style,ui,_n)),wi.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET")}const ti=ii.programConfigurations.get(r.id);let Gi=!1;if(ze&&Ut.imageAtlas){const ui=s.e3.from(ze),_n=ui.getPrimary().scaleSelf(K).toString(),Gn=Ut.imageAtlas.patternPositions.get(_n),Cn=ui.getSecondary(),rn=Cn?Ut.imageAtlas.patternPositions.get(Cn.scaleSelf(K).toString()):null;Gi=!!Gn&&!!rn,Gn&&ti.setConstantPatternPositions(Gn,rn)}ye>0&&(Gi||ti.getPatternTransitionVertexBuffer("line-pattern"))&&wi.push("LINE_PATTERN_TRANSITION");const Qi=u.isTileAffectedByFog(Tt),Xi=u.getOrCreateProgram(Ae,{config:ti,defines:wi,overrideFog:Qi});if(!we&&re&&te&&Ut.lineAtlas){const ui=Ut.lineAtlas.getDash(re,te);ui&&ti.setConstantPatternPositions(ui)}Lt&&Ui.setupShadows(Ut.tileID.toUnwrapped(),Xi,"vector-tile");let[Di,ci]=r.paint.get("line-trim-offset");(te==="round"||te==="square")&&Di!==ci&&(Di===0&&(Di-=1),ci===1&&(ci+=1));const $i=J?Tt.projMatrix:null,zn=M?1/ii.tileToMeter/s.ay(Ut,1,u.transform.zoom):1,xn=M?1/ii.tileToMeter/s.ay(Ut,1,Math.floor(u.transform.zoom)):1,Hi=we?s.e4(u,Ut,r,$i,K,zn,xn,[Di,ci],Fi,ye):s.e5(u,Ut,r,$i,ii.lineClipsArray.length,K,zn,xn,[Di,ci],Fi);if(ot){const ui=ii.gradients[r.id];let _n=ui.texture;if(r.gradientVersion!==ui.version){let Gn=256;if(r.stepInterpolant){const Cn=t.getSource().maxzoom,rn=Tt.canonical.z===Cn?Math.ceil(1<<u.transform.maxZoom-Tt.canonical.z):1;Gn=s.aA(s.e6(ii.maxLineLength/s.al*1024*rn),256,D.maxTextureSize)}ui.gradient=s.e7({expression:r.gradientExpression(),evaluationKey:"lineProgress",resolution:Gn,image:ui.gradient||void 0,clips:ii.lineClipsArray}),ui.texture?ui.texture.update(ui.gradient):ui.texture=new s.T(D,ui.gradient,N.RGBA8),ui.version=r.gradientVersion,_n=ui.texture}D.activeTexture.set(N.TEXTURE1),_n.bind(r.stepInterpolant?N.NEAREST:N.LINEAR,N.CLAMP_TO_EDGE)}oe&&(D.activeTexture.set(N.TEXTURE0),Ut.lineAtlasTexture&&Ut.lineAtlasTexture.bind(N.LINEAR,N.REPEAT),ti.updatePaintBuffers()),we&&(D.activeTexture.set(N.TEXTURE0),Ut.imageAtlasTexture&&Ut.imageAtlasTexture.bind(N.LINEAR,N.CLAMP_TO_EDGE),ti.updatePaintBuffers()),At&&!z&&u.terrain.setupElevationDraw(Ut,Xi),u.uploadCommonUniforms(D,Xi,Tt.toUnwrapped());const Ci=ui=>{Ne!=null&&(Ne.value=Oe*T),Xi.draw(u,N.TRIANGLES,st,ui,X,Yt.disabled,Hi,r.id,ii.layoutVertexBuffer,ii.indexBuffer,ii.segments,r.paint,u.transform.zoom,ti,[ii.layoutVertexBuffer2,ii.patternVertexBuffer,ii.zOffsetVertexBuffer]),Ne!=null&&(Ne.value=Oe)};if($e&&!At){const ui=u.stencilModeForClipping(Tt).ref;ui===0&&J&&D.clear({stencil:0});const _n={func:N.EQUAL,mask:255};Hi.u_alpha_discard_threshold=.8,Ci(new Jt(_n,ui,255,N.KEEP,N.KEEP,N.INVERT)),Hi.u_alpha_discard_threshold=0,Ci(new Jt(_n,ui,255,N.KEEP,N.KEEP,N.KEEP))}else Hi.u_alpha_discard_threshold=$e&&At&&vt?.8:0,Ci(At?Rt:u.stencilModeForClipping(Tt))}};let Ke=u.depthModeForSublayer(0,Dt.ReadOnly);const pt=new Dt(u.depthOcclusion?N.GREATER:N.LEQUAL,Dt.ReadOnly,u.depthRangeFor3D);if(r.hasNonElevatedBuckets){const wt=!J&&u.terrain;T!==0&&wt?s.w(`Occlusion opacity for layer ${r.id} is supported on terrain only if the layer has line-z-offset enabled.`):wt?s.w(`Cannot render non-elevated lines in immediate mode when terrain is enabled. Layer: ${r.id}.`):Re(h,_e,Ke,Jt.disabled,!1,!0)}if(r.hasElevatedBuckets){A==="hd-road-markup"?L||(Ke=pt,_e.push("ELEVATED_ROADS")):(_e.push("ELEVATED"),Ke=pt,G&&_e.push($?"CROSS_SLOPE_HORIZONTAL":"CROSS_SLOPE_VERTICAL"),z&&_e.push("ELEVATION_REFERENCE_SEA"));const wt=$e?u.stencilModeFor3D():Jt.disabled;u.forceTerrainMode=!0,Re(h,_e,Ke,wt,!0,!0),$e&&Re(h,_e,Ke,wt,!0,!1),u.forceTerrainMode=!1}$e&&(u.resetStencilClippingMasks(),J&&D.clear({stencil:0})),T===0||u.depthOcclusion||J||u.layersWithOcclusionOpacity.push(u.currentLayer)},fill:function(u,t,r,h){const p=r.paint.get("fill-color"),g=r.paint.get("fill-opacity");if(g.constantOr(1)===0)return;const y=r.paint.get("fill-emissive-strength"),w=u.colorModeForDrapableLayerRenderPass(y),T=r.paint.get("fill-pattern"),A=u.opaquePassEnabledForLayer()&&!T.constantOr(1)&&p.constantOr(s.ao.transparent).a===1&&g.constantOr(0)===1?"opaque":"translucent";let M="none";r.layout.get("fill-elevation-reference")!=="none"?M="road":r.paint.get("fill-z-offset").constantOr(1)!==0&&(M="offset");const z=!(!u.terrain||!u.terrain.enabled),L={painter:u,sourceCache:t,layer:r,coords:h,colorMode:w,elevationType:M,terrainEnabled:z,pass:A};if(u.renderPass==="shadow")return void(u.shadowRenderer&&M==="road"&&!z&&function(N){const{painter:B,sourceCache:G,layer:$,coords:X}=N,J=B.context.gl,K=N.painter.shadowRenderer;for(const ue of X){const oe=G.getTile(ue),le=oe.getBucket($);if(!le)continue;const re=le.elevatedStructures;if(!re||!re.shadowCasterSegments||re.shadowCasterSegments.segments[0].primitiveLength===0)continue;B.prepareDrawTile();const te=le.bufferData.programConfigurations.get($.id),he=B.isTileAffectedByFog(ue),we=B.getOrCreateProgram("elevatedStructuresDepth",{config:te,overrideFog:he}),ye=K.calculateShadowPassMatrixFromTile(oe.tileID.toUnwrapped());B.uploadCommonUniforms(B.context,we,ue.toUnwrapped());const ze={u_matrix:ye,u_depth_bias:0};we.draw(B,J.TRIANGLES,K.getShadowPassDepthMode(),Jt.disabled,K.getShadowPassColorMode(),Yt.disabled,ze,$.id,re.vertexBuffer,re.indexBuffer,re.shadowCasterSegments,$.paint,B.transform.zoom,te)}}(L));const D=u.emissiveMode==="mrt-fallback";if(M!=="offset"){if(Ad(L,!1,D),M==="road"){const N=!z&&u.renderPass==="translucent";N&&Id(u,t,r,h,"geometry"),Ad(L,!0,D,Jt.disabled),N&&function(B){const{painter:G,sourceCache:$,layer:X,coords:J,colorMode:K}=B,ue=G.context.gl,oe=B.painter.shadowRenderer,le=!!oe&&oe.enabled,re=new Dt(G.context.gl.LEQUAL,Dt.ReadOnly,G.depthRangeFor3D);let te=[0,0,0];if(le){const we=G.style.directionalLight,ye=G.style.ambientLight;we&&ye&&(te=ua(G.style,we,ye))}const he=we=>{for(const ye of J){const ze=$.getTile(ye),Oe=ze.getBucket(X);if(!Oe)continue;const $e=Oe.elevatedStructures;if(!$e)continue;let ot,Ae;if(we?(ot=$e.renderableBridgeSegments,Ae=$e.bridgeProgramConfigurations.get(X.id)):(ot=$e.renderableTunnelSegments,Ae=$e.tunnelProgramConfigurations.get(X.id)),!ot||ot.segments[0].primitiveLength===0)continue;Ae.updatePaintBuffers(),G.prepareDrawTile();const _e=G.isTileAffectedByFog(ye),Ne=[];le&&Ne.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET");const Re=G.getOrCreateProgram("elevatedStructures",{config:Ae,overrideFog:_e,defines:Ne}),Ke=G.translatePosMatrix(ye.projMatrix,ze,X.paint.get("fill-translate"),X.paint.get("fill-translate-anchor"));le&&oe.setupShadows(ze.tileID.toUnwrapped(),Re,"vector-tile");const pt=nl(Ke,te);G.uploadCommonUniforms(G.context,Re,ye.toUnwrapped()),Re.draw(G,ue.TRIANGLES,re,Jt.disabled,K,Yt.backCCW,pt,X.id,$e.vertexBuffer,$e.indexBuffer,ot,X.paint,G.transform.zoom,Ae,[$e.vertexBufferNormal])}};he(!0),he(!1)}(L)}}else Ad(L,!1,D,u.stencilModeFor3D())},"fill-extrusion":function(u,t,r,h){const p=r.paint.get("fill-extrusion-opacity"),g=u.context,y=g.gl,w=u.terrain,T=w&&w.renderingToTexture;if(p===0)return;const A=u.emissiveMode==="mrt-fallback",M=u.conflationActive&&u.style.isLayerClipped(r,t.getSource()),z=u.style.order.indexOf(r.fqid);if(M&&function(L,D,N,B,G){for(const $ of B){const X=D.getTile($).getBucket(N);X&&(X.updateReplacement($,L.replacementSource,G),X.uploadCentroid(L.context))}}(u,t,r,h,z),w||M)for(const L of h){const D=t.getTile(L).getBucket(r);D&&Kv(u.context,t,L,D,r,w,M)}if(u.renderPass==="shadow"&&u.shadowRenderer){const L=u.shadowRenderer;if(w&&p<.65&&r._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof s.ad)return;const D=L.getShadowPassDepthMode(),N=L.getShadowPassColorMode();Cd(u,t,r,h,D,Jt.disabled,N,M)}else if(u.renderPass==="translucent"){const L=!r.paint.get("fill-extrusion-pattern").constantOr(1),D=r.paint.get("fill-extrusion-color").constantOr(s.ao.white);if(!T&&D.a!==0){const N=new Dt(u.context.gl.LEQUAL,Dt.ReadWrite,u.depthRangeFor3D);p===1&&L?Cd(u,t,r,h,N,Jt.disabled,ai.unblended,M):(Cd(u,t,r,h,N,Jt.disabled,ai.disabled,M),Cd(u,t,r,h,N,u.stencilModeFor3D(),u.colorModeForRenderPass(),M),u.resetStencilClippingMasks())}if(u.style.enable3dLights()&&L&&(!w&&u.transform.projection.name!=="globe"||T)){const N=r.paint.get("fill-extrusion-opacity"),B=r.paint.get("fill-extrusion-ambient-occlusion-intensity"),G=r.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),$=r.paint.get("fill-extrusion-flood-light-intensity"),X=r.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",J=r.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(X?null:r.lut).toArray01().slice(0,3),K=B>0&&G>0,ue=$>0,oe=(te,he,we)=>(1-we)*te+we*he,le=new Yp;le.translate=r.paint.get("fill-extrusion-translate"),le.translateAnchor=r.paint.get("fill-extrusion-translate-anchor"),le.edgeRadius=r.layout.get("fill-extrusion-edge-radius"),le.cutoffFadeRange=r.paint.get("fill-extrusion-cutoff-fade-range");const re=te=>{const he=u.depthModeForSublayer(1,Dt.ReadOnly,y.LEQUAL,!0),we=r.paint.get(te?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),ye=oe(.1,3,we),ze=u._showOverdrawInspector;if(!ze){const Oe=new Jt({func:y.ALWAYS,mask:255},255,255,y.KEEP,y.KEEP,y.REPLACE),$e=new ai([y.ONE,y.ONE,y.ONE,y.ONE],s.ao.transparent,[!1,!1,!1,!0],y.MIN);fa(le,u,t,r,h,he,Oe,$e,Yt.disabled,te,"sdf",N,B,G,$,J,ye,M,!1)}{const Oe=ze?Jt.disabled:new Jt({func:y.EQUAL,mask:255},255,255,y.KEEP,y.DECR,y.DECR),$e=ze?u.colorModeForRenderPass():new ai([y.ONE_MINUS_DST_ALPHA,y.DST_ALPHA,y.ONE,y.ONE],s.ao.transparent,[!0,!0,!0,!0]);fa(le,u,t,r,h,he,Oe,$e,Yt.disabled,te,"color",N,B,G,$,J,ye,M,!1)}};if(T){const te=()=>{const we=w.drapeBufferSize[0],ye=w.drapeBufferSize[1];let ze=w.framebufferCopyTexture;return ze&&(!ze||ze.size[0]===we&&ze.size[1]===ye)||(ze&&ze.destroy(),ze=w.framebufferCopyTexture=new s.T(g,new s.q({width:we,height:ye}),y.RGBA8)),ze.bind(y.LINEAR,y.CLAMP_TO_EDGE),y.copyTexSubImage2D(y.TEXTURE_2D,0,0,0,0,0,we,ye),ze},he=(we,ye,ze)=>{const Oe=u.depthModeForSublayer(1,Dt.ReadOnly,y.LEQUAL,!1),$e=r.paint.get(we?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),ot=oe(.1,3,$e);{const Ae=new ai([y.ONE,y.ONE,y.ONE,y.ONE],s.ao.transparent,[!1,!1,!1,!0]);fa(le,u,t,r,h,Oe,Jt.disabled,Ae,Yt.disabled,we,"clear",N,B,G,$,J,ot,M,ye)}{const Ae=new Jt({func:y.ALWAYS,mask:255},255,255,y.KEEP,y.KEEP,y.REPLACE),_e=new ai([y.ONE,y.ONE,y.ONE,y.ONE],s.ao.transparent,[!1,!1,!1,!0],y.MIN);fa(le,u,t,r,h,Oe,Ae,_e,Yt.disabled,we,"sdf",N,B,G,$,J,ot,M,ye)}A&&!we&&(ze=te());{const Ae=we?y.ZERO:y.ONE_MINUS_DST_ALPHA,_e=new Jt({func:y.EQUAL,mask:255},255,255,y.KEEP,y.DECR,y.DECR),Ne=new ai([Ae,y.DST_ALPHA,y.ONE_MINUS_DST_ALPHA,y.ZERO],s.ao.transparent,[!0,!0,!0,!0]);fa(le,u,t,r,h,Oe,_e,Ne,Yt.disabled,we,"color",N,B,G,$,J,ot,M,ye)}if(!A||we){const Ae=new ai([y.ONE,y.ONE,y.ONE,we?y.ZERO:y.ONE],s.ao.transparent,[!1,!1,!1,!0],we?y.FUNC_ADD:y.MAX);fa(le,u,t,r,h,Oe,Jt.disabled,Ae,Yt.disabled,we,"clear",N,B,G,$,J,ot,M,ye,ze)}else{y.drawBuffers([y.NONE,y.COLOR_ATTACHMENT1]);const Ae=new Jt({func:y.EQUAL,mask:255},254,255,y.KEEP,y.DECR,y.DECR),_e=new ai([y.ONE,y.ONE,y.ONE,y.ONE],s.ao.transparent,[!0,!1,!1,!1],y.MAX);fa(le,u,t,r,h,Oe,Ae,_e,Yt.disabled,we,"emissive",N,B,G,$,J,ot,M,ye,ze),y.drawBuffers([y.COLOR_ATTACHMENT0])}};if(K||ue){let we;u.prepareDrawTile(),A&&!K||(we=te()),K&&he(!0,!1,we),ue&&he(!1,!0,we)}}else K&&re(!0),ue&&re(!1),(K||ue)&&u.resetStencilClippingMasks()}}},building:function(u,t,r,h){u.currentLayer<u.firstLightBeamLayer&&(u.firstLightBeamLayer=u.currentLayer);const p=r.paint.get("building-ambient-occlusion-ground-intensity"),g=r.paint.get("building-ambient-occlusion-ground-radius"),y=r.paint.get("building-ambient-occlusion-ground-attenuation"),w=r.paint.get("building-opacity");if(w<=0)return;let T=p>0&&g>0,A=!0;const M=r.paint.get("building-vertical-scale");if(M<=0)return;u.shadowRenderer||(A=!1);const z=u.conflationActive&&u.style.isLayerClipped(r,t.getSource()),L=u.style.order.indexOf(r.fqid);if(function(D,N,B,G,$,X){for(const J of X){const K=N.getTile(J).getBucket(B);K&&($&&K.updateReplacement(J,D.replacementSource,G),K.uploadUpdatedIndexBuffer(D.context))}}(u,t,r,L,z,h),function(D,N,B,G){for(const $ of G){const X=N.getTile($).getBucket(B);X&&X.needsEvaluation()&&X.uploadUpdatedColorBuffer(D.context)}}(u,t,r,h),r.resetLayerRenderingStats(u),u.shadowRenderer&&(u.shadowRenderer.useNormalOffset=!0),u.renderPass==="shadow"&&u.shadowRenderer){const D=u.shadowRenderer,N=[],B=D.getShadowPassDepthMode();Ku({painter:u,source:t,layer:r,coords:h,defines:N,blendMode:D.getShadowPassColorMode(),depthMode:B,opacity:w,verticalScale:M,facadeEmissiveChance:0,facadeAOIntensity:0,floodLightIntensity:0,floodLightColor:[0,0,0]})}else if(u.renderPass==="translucent"){let D=["HAS_ATTRIBUTE_a_part_color_emissive","LIGHTING_3D_MODE"];A&&(D=D.concat("RENDER_SHADOWS","DEPTH_TEXTURE")),u.shadowRenderer&&u.shadowRenderer.useNormalOffset&&(D=D.concat("NORMAL_OFFSET"));const N=r.paint.get("building-facade-emissive-chance"),B=r.paint.get("building-ambient-occlusion-intensity"),G=r.paint.get("building-flood-light-intensity"),$=r.paint.get("building-flood-light-color-use-theme").constantOr("default")==="none",X=r.paint.get("building-flood-light-color").toNonPremultipliedRenderColor($?null:r.lut).toArray01().slice(0,3),J=r.paint.get("building-flood-light-ground-attenuation"),K=G>0,ue=new Dt(u.context.gl.LEQUAL,Dt.ReadWrite,u.depthRangeFor3D);w<1&&Ku({painter:u,source:t,layer:r,coords:h,defines:D,blendMode:ai.disabled,depthMode:ue,opacity:w,verticalScale:M,facadeEmissiveChance:N,facadeAOIntensity:B,floodLightIntensity:G,floodLightColor:X,depthOnly:!0});const oe=u.colorModeForRenderPass();Ku({painter:u,source:t,layer:r,coords:h,defines:D,blendMode:oe,depthMode:ue,opacity:w,verticalScale:M,facadeEmissiveChance:N,facadeAOIntensity:B,floodLightIntensity:G,floodLightColor:X}),T&&Pd(u,t,r,h,!0,w,p,g,G,X,y,z),K&&Pd(u,t,r,h,!1,w,p,g,G,X,J,z)}else if(u.renderPass==="light-beam"){const D=["HAS_ATTRIBUTE_a_part_color_emissive","HAS_ATTRIBUTE_a_bloom_attenuation"],N=new Dt(u.context.gl.LEQUAL,Dt.ReadOnly,u.depthRangeFor3D);Ku({painter:u,source:t,layer:r,coords:h,defines:D,blendMode:ai.alphaBlended,depthMode:N,opacity:w,verticalScale:M,facadeEmissiveChance:0,facadeAOIntensity:0,floodLightIntensity:0,floodLightColor:[0,0,0]})}u.shadowRenderer&&(u.shadowRenderer.useNormalOffset=!1),u.resetStencilClippingMasks()},hillshade:function(u,t,r,h){if(u.renderPass!=="offscreen"&&u.renderPass!=="translucent"||u.style.disableElevatedTerrain)return;const p=u.context,g=u.terrain&&u.terrain.renderingToTexture,[y,w]=u.renderPass!=="translucent"||g?[{},h]:u.stencilConfigForOverlap(h);for(const T of w){const A=t.getTile(T);if(A.needsHillshadePrepare&&u.renderPass==="offscreen")jv(u,A,r);else if(u.renderPass==="translucent"){const M=u.depthModeForSublayer(0,Dt.ReadOnly),z=r.paint.get("hillshade-emissive-strength"),L=u.colorModeForDrapableLayerRenderPass(z),D=g&&u.terrain?u.terrain.stencilModeForRTTOverlap(T):y[T.overscaledZ];Nv(u,T,A,r,M,D,L)}}p.viewport.set([0,0,u.width,u.height]),u.resetStencilClippingMasks()},raster:function(u,t,r,h,p,g){if(u.renderPass!=="translucent"||r.paint.get("raster-opacity")===0)return;const y=u.transform.projection.name==="globe",w=r.paint.get("raster-elevation")!==0,T=w&&y;if(u.renderElevatedRasterBackface&&!T)return;const A=u.context,M=A.gl,z=t.getSource(),L=function(oe,le,re,te,he){const we=le.paint.get("raster-color"),ye=oe.type==="raster-array",ze=[],Oe=le.paint.get("raster-resampling"),$e=le.paint.get("raster-color-mix");let ot=le.paint.get("raster-color-range");const Ae=[$e[0],$e[1],$e[2],0],_e=$e[3];let Ne=Oe==="nearest"?te.NEAREST:te.LINEAR;if(ye&&(ze.push("RASTER_ARRAY"),we||ze.push("RASTER_COLOR"),Oe==="linear"&&ze.push("RASTER_ARRAY_LINEAR"),Ne=te.NEAREST,!ot&&oe.rasterLayers)){const Re=oe.rasterLayers.find(({id:Ke})=>Ke===le.sourceLayer);Re&&Re.fields&&Re.fields.range&&(ot=Re.fields.range)}if(ot=ot||[0,1],we){ze.push("RASTER_COLOR"),re.activeTexture.set(te.TEXTURE2),le.updateColorRamp(ot);let Re=le.colorRampTexture;Re||(Re=le.colorRampTexture=new s.T(re,le.colorRamp,te.RGBA8)),Re.bind(te.LINEAR,te.CLAMP_TO_EDGE)}return he&&ze.push("USE_MRT1"),{mix:Ae,range:ot,offset:_e,defines:ze,resampling:Ne}}(z,r,A,M,u.terrain&&u.terrain.renderingToTexture&&u.emissiveMode==="mrt-fallback");if(z instanceof s.aU&&!h.length&&!y)return;const D=r.paint.get("raster-emissive-strength"),N=u.colorModeForDrapableLayerRenderPass(D),B=u.terrain&&u.terrain.renderingToTexture,G=!u.options.moving,$=r.paint.get("raster-resampling")==="nearest"?M.NEAREST:M.LINEAR;if(z instanceof s.aU&&!h.length&&(z.onNorthPole||z.onSouthPole)){const oe=w?u.stencilModeFor3D():Jt.disabled;return void Yu(!!z.onNorthPole,null,u,t,r,D,L,Yt.disabled,oe)}if(!h.length)return;const[X,J]=z instanceof s.aU||B?[{},h]:u.stencilConfigForOverlap(h),K=J[J.length-1].overscaledZ;T&&L.defines.push("PROJECTION_GLOBE_VIEW"),w&&L.defines.push("RENDER_CUTOFF");const ue=(oe,le,re)=>{for(const te of oe){const he=te.toUnwrapped(),we=t.getTile(te);if(B&&(!we||!we.hasData()))continue;A.activeTexture.set(M.TEXTURE0);const ye=ma(we,z,r,L);if(!ye||!ye.texture)continue;const{texture:ze,mix:Oe,offset:$e,tileSize:ot,buffer:Ae}=ye;let _e,Ne;B?(_e=Dt.disabled,Ne=te.projMatrix):w?(_e=new Dt(M.LEQUAL,Dt.ReadWrite,u.depthRangeFor3D),Ne=y?Float32Array.from(u.transform.expandedFarZProjMatrix):u.transform.calculateProjMatrix(he,G)):(_e=u.depthModeForSublayer(te.overscaledZ-K,r.paint.get("raster-opacity")===1?Dt.ReadWrite:Dt.ReadOnly,M.LESS),Ne=u.transform.calculateProjMatrix(he,G));const Re=u.terrain&&B?u.terrain.stencilModeForRTTOverlap(te):X[te.overscaledZ],Ke=g?0:r.paint.get("raster-fade-duration");we.registerFadeDuration(Ke);const pt=t.findLoadedParent(te,0),wt=Hu(we,pt,t,u.transform,Ke);let ht,st;!wt.isFading&&we.refreshedUponExpiration&&(we.refreshedUponExpiration=!1),u.terrain&&u.terrain.prepareDrawTile(),A.activeTexture.set(M.TEXTURE0),ze.bind($,M.CLAMP_TO_EDGE),A.activeTexture.set(M.TEXTURE1),pt?(pt.texture&&pt.texture.bind($,M.CLAMP_TO_EDGE),ht=Math.pow(2,pt.tileID.overscaledZ-we.tileID.overscaledZ),st=[we.tileID.canonical.x*ht%1,we.tileID.canonical.y*ht%1]):ze.bind($,M.CLAMP_TO_EDGE),"useMipmap"in ze&&A.extTextureFilterAnisotropic&&u.transform.pitch>20&&M.texParameterf(M.TEXTURE_2D,A.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,A.extTextureFilterAnisotropicMax);const Rt=u.transform;let At;const vt=w?Hg(Rt):[0,0,0,0];let Tt,Ut,ii,wi,Ui,Lt=0;if(T&&z instanceof s.aU&&z.coordinates.length>3)Tt=Float32Array.from(s.bk(s.dJ(new s.cD(0,0,0)))),Ut=Float32Array.from(Rt.globeMatrix),ii=Float32Array.from(s.dF(Rt)),wi=[s.aF(Rt.center.lng),s.aJ(Rt.center.lat)],At=z.elevatedGlobePerspectiveTransform,Ui=z.elevatedGlobeGridMatrix||new Float32Array(9);else if(T){const Qi=s.dG(te.canonical);Lt=s.dH(Qi.getCenter().lat),Tt=Float32Array.from(s.bk(s.dJ(te.canonical))),Ut=Float32Array.from(Rt.globeMatrix),ii=Float32Array.from(s.dF(Rt)),wi=[s.aF(Rt.center.lng),s.aJ(Rt.center.lat)],At=[0,0],Ui=Float32Array.from(s.dI(te.canonical,Qi,Lt,Rt.worldSize/Rt._pixelsPerMercatorPixel))}else At=z instanceof s.aU?z.perspectiveTransform:[0,0],Tt=new Float32Array(16),Ut=new Float32Array(9),ii=new Float32Array(16),wi=[0,0],Ui=new Float32Array(9);const Fi=Bg(Ne,Tt,Ut,ii,Ui,st||[0,0],s.aj(u.transform.zoom),wi,vt,ht||1,wt,r,At,w?r.paint.get("raster-elevation"):0,2,Oe,$e,L.range,ot,Ae,D),ti=u.isTileAffectedByFog(te),Gi=u.getOrCreateProgram("raster",{defines:L.defines,overrideFog:ti});if(u.uploadCommonUniforms(A,Gi,he),z instanceof s.aU){const Qi=z.elevatedGlobeVertexBuffer,Xi=z.elevatedGlobeIndexBuffer;if(B||!y)z.boundsBuffer&&z.boundsSegments&&Gi.draw(u,M.TRIANGLES,_e,Jt.disabled,N,Yt.disabled,Fi,r.id,z.boundsBuffer,u.quadTriangleIndexBuffer,z.boundsSegments);else if(Qi&&Xi){const Di=Rt.zoom<=s.c_?z.elevatedGlobeSegments:z.getSegmentsForLongitude(Rt.center.lng);Di&&Gi.draw(u,M.TRIANGLES,_e,Jt.disabled,N,le,Fi,r.id,Qi,Xi,Di)}}else if(T){_e=new Dt(M.LEQUAL,Dt.ReadOnly,u.depthRangeFor3D);const Qi=u.globeSharedBuffers;if(Qi){const[Xi,Di,ci]=Qi.getGridBuffers(Lt,!1);Gi.draw(u,M.TRIANGLES,_e,re||Re,u.colorModeForRenderPass(),le,Fi,r.id,Xi,Di,ci)}}else{const{tileBoundsBuffer:Qi,tileBoundsIndexBuffer:Xi,tileBoundsSegments:Di}=u.getTileBoundsBuffers(we);Gi.draw(u,M.TRIANGLES,_e,Re,N,Yt.disabled,Fi,r.id,Qi,Xi,Di)}}if(!(z instanceof s.aU)&&T)for(const te of oe){const he=te.canonical.y===(1<<te.canonical.z)-1;te.canonical.y===0&&Yu(!0,te,u,t,r,D,L,le,re||Jt.disabled),he&&Yu(!1,te,u,t,r,D,L,le===Yt.frontCW?Yt.backCW:Yt.frontCW,re||Jt.disabled)}};T?ue(J,u.renderElevatedRasterBackface?Yt.backCW:Yt.frontCW,u.stencilModeFor3D()):ue(J,Yt.disabled,void 0),u.resetStencilClippingMasks()},"raster-particle":function(u,t,r,h,p,g){u.renderPass==="offscreen"&&function(y,w,T,A){if(!A.length)return;const M=y.context,z=M.gl,L=w.getSource();if(!(L instanceof Yr))return;const D=Math.ceil(Math.sqrt(T.paint.get("raster-particle-count")));let N=T.particlePositionRGBAImage;if(!N||N.width!==D){const J=function(K){const ue=K*K,oe=new Uint8Array(4*ue),le=function(te){return te|=0,te=Math.imul(2747636419^te,2654435769),te=Math.imul(te^te>>>16,2654435769),((te=Math.imul(te^te>>>16,2654435769))>>>0)/4294967296},re=1/1.1;for(let te=0;te<ue;te++){const he=re*(le(2*te+0)+Vs),we=re*(le(2*te+1)+Vs),ye=255*he%1,ze=255*we%1,Oe=ye,$e=we-ze/255,ot=ze;oe[4*te+0]=255*(he-ye/255),oe[4*te+1]=255*Oe,oe[4*te+2]=255*$e,oe[4*te+3]=255*ot}return oe}(D);N=T.particlePositionRGBAImage=new s.q({width:D,height:D},J)}let B=T.particleFramebuffer;B?B.width!==D&&(B.destroy(),B=T.particleFramebuffer=M.createFramebuffer(D,D,1,null)):B=T.particleFramebuffer=M.createFramebuffer(D,D,1,null);const G=[];for(const J of A){const K=w.getTile(J);if(!(K instanceof $h))continue;const ue=Qp(K,L,T);if(!ue)continue;const oe=[K.tileSize,K.tileSize];let le=T.tileFramebuffer;le||(le=T.tileFramebuffer=M.createFramebuffer(oe[0],oe[1],1,null));let re=K.rasterParticleState;re||(re=K.rasterParticleState=new Rd(M,J,oe,N));const te=re.update(T.lastInvalidatedAt);re.particleTextureDimension!==D&&re.updateParticleTexture(J,N);const he=re.targetColorTexture;re.targetColorTexture=re.backgroundColorTexture,re.backgroundColorTexture=he;const we=re.particleTexture0;re.particleTexture0=re.particleTexture1,re.particleTexture1=we,G.push([J,ue,re,te])}if(G.length===0)return;const $=s.o.now(),X=T.previousDrawTimestamp?.001*($-T.previousDrawTimestamp):.0167;if(T.previousDrawTimestamp=$,T.hasColorMap()){M.activeTexture.set(z.TEXTURE0+2);let J=T.colorRampTexture;J||(J=T.colorRampTexture=new s.T(M,T.colorRamp,z.RGBA8)),J.bind(z.LINEAR,z.CLAMP_TO_EDGE)}M.bindFramebuffer.set(T.tileFramebuffer.framebuffer),function(J,K,ue){const oe=J.context,le=oe.gl,re=K.tileFramebuffer;oe.activeTexture.set(le.TEXTURE0);const te={u_texture:0,u_opacity:1.05*(we=K.paint.get("raster-particle-fade-opacity-factor"))/(we+.05)},he=J.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var we;for(const ye of ue){const[,,ze,Oe]=ye;re.colorAttachment0.set(ze.targetColorTexture.texture),oe.viewport.set([0,0,re.width,re.height]),oe.clear({color:s.ao.transparent}),Oe&&(ze.backgroundColorTexture.bind(le.NEAREST,le.CLAMP_TO_EDGE),he.draw(J,le.TRIANGLES,Dt.disabled,Jt.disabled,ai.alphaBlended,Yt.disabled,te,K.id,J.viewportBuffer,J.quadTriangleIndexBuffer,J.viewportSegments))}}(y,T,G),function(J,K,ue,oe){const le=J.context,re=le.gl,te=ue.tileFramebuffer,he=J.transform.projection.name==="globe",we=ue.paint.get("raster-particle-max-speed");for(const ye of oe){const[ze,Oe,$e]=ye;le.activeTexture.set(re.TEXTURE0+0),Oe.texture.bind(re.LINEAR,re.CLAMP_TO_EDGE),te.colorAttachment0.set($e.targetColorTexture.texture);const ot=J.getOrCreateProgram("rasterParticleDraw",{defines:Oe.defines,overrideFog:!1});le.activeTexture.set(re.TEXTURE0+1);const Ae=Oe.scalarData?[]:[0,1,2,3].map(Re=>s.e9[Re](ze));Ae.push(ze);const _e=ze.canonical.x,Ne=ze.canonical.y;for(const Re of Ae){const Ke=K.getTile(he?Re.wrapped():Re);if(!Ke)continue;const pt=Ke.rasterParticleState;if(!pt)continue;const wt=Re.canonical.x+(1<<Re.canonical.z)*(Re.wrap-ze.wrap),ht=Re.canonical.y;pt.particleTexture0.bind(re.NEAREST,re.CLAMP_TO_EDGE);const st=Xv(1,pt.particleTexture0.size[0],[wt-_e,ht-Ne],0,Oe.texture.size,2,we,Oe.textureOffset,Oe.scale,Oe.offset);ot.draw(J,re.POINTS,Dt.disabled,Jt.disabled,ai.alphaBlended,Yt.disabled,st,ue.id,pt.particleIndexBuffer,void 0,pt.particleSegment)}}}(y,w,T,G),M.bindFramebuffer.set(T.particleFramebuffer.framebuffer),function(J,K,ue,oe){const le=J.context,re=le.gl,te=K.paint.get("raster-particle-max-speed"),he=oe*K.paint.get("raster-particle-speed-factor")*.15,we=function(ze){return Math.pow(ze,6)}(.01+1*K.paint.get("raster-particle-reset-rate-factor")),ye=K.particleFramebuffer;le.viewport.set([0,0,ye.width,ye.height]);for(const ze of ue){const[,Oe,$e]=ze;le.activeTexture.set(re.TEXTURE0+0),Oe.texture.bind(re.LINEAR,re.CLAMP_TO_EDGE),le.activeTexture.set(re.TEXTURE0+1);const ot=$e.particleTexture0;ot.bind(re.NEAREST,re.CLAMP_TO_EDGE);const Ae=jg(1,ot.size[0],0,Oe.texture.size,te,he,we,Oe.textureOffset,Oe.scale,Oe.offset);ye.colorAttachment0.set($e.particleTexture1.texture),le.clear({color:s.ao.transparent}),J.getOrCreateProgram("rasterParticleUpdate",{defines:Oe.defines}).draw(J,re.TRIANGLES,Dt.disabled,Jt.disabled,ai.unblended,Yt.disabled,Ae,K.id,J.viewportBuffer,J.quadTriangleIndexBuffer,J.viewportSegments)}}(y,T,G,X)}(u,t,r,h),u.renderPass==="translucent"&&(function(y,w,T,A,M){const z=y.context,L=z.gl,D=w.getSource().tileSize,N=5*(1-s.ah(s.cL,s.cL+1,y.transform.zoom))*D+T.paint.get("raster-particle-elevation"),B=!y.options.moving,G=y.transform.projection.name==="globe";if(!A.length)return;const[$,X]=y.stencilConfigForOverlap(A),J=[];G&&J.push("PROJECTION_GLOBE_VIEW");const K=y.stencilModeFor3D();for(const ue of X){const oe=ue.toUnwrapped(),le=w.getTile(ue);if(!le.rasterParticleState)continue;const re=le.rasterParticleState,te=100;le.registerFadeDuration(te);const he=w.findLoadedParent(ue,0),we=Hu(le,he,w,y.transform,te);let ye,ze;y.terrain&&y.terrain.prepareDrawTile(),z.activeTexture.set(L.TEXTURE0),re.targetColorTexture.bind(L.LINEAR,L.CLAMP_TO_EDGE),z.activeTexture.set(L.TEXTURE1),he&&he.rasterParticleState?(he.rasterParticleState.targetColorTexture.bind(L.LINEAR,L.CLAMP_TO_EDGE),ye=Math.pow(2,he.tileID.overscaledZ-le.tileID.overscaledZ),ze=[le.tileID.canonical.x*ye%1,le.tileID.canonical.y*ye%1]):re.targetColorTexture.bind(L.LINEAR,L.CLAMP_TO_EDGE);const Oe=G?Float32Array.from(y.transform.expandedFarZProjMatrix):y.transform.calculateProjMatrix(oe,B),$e=y.transform,ot=qg($e),Ae=s.dG(ue.canonical),_e=s.dH(Ae.getCenter().lat);let Ne,Re,Ke,pt,wt;G?(Ne=Float32Array.from(s.bk(s.dJ(ue.canonical))),Re=Float32Array.from($e.globeMatrix),Ke=Float32Array.from(s.dF($e)),pt=[s.aF($e.center.lng),s.aJ($e.center.lat)],wt=Float32Array.from(s.dI(ue.canonical,Ae,_e,$e.worldSize/$e._pixelsPerMercatorPixel))):(Ne=new Float32Array(16),Re=new Float32Array(9),Ke=new Float32Array(16),pt=[0,0],wt=new Float32Array(9));const ht=Zv(Oe,Ne,Re,Ke,wt,ze||[0,0],s.aj(y.transform.zoom),pt,ot,ye||1,we,N),st=y.isTileAffectedByFog(ue),Rt=y.getOrCreateProgram("rasterParticle",{defines:J,overrideFog:st});if(y.uploadCommonUniforms(z,Rt,oe),G){const At=new Dt(L.LEQUAL,Dt.ReadOnly,y.depthRangeFor3D),vt=0,Tt=y.globeSharedBuffers;if(Tt){const[Ut,ii,wi]=Tt.getGridBuffers(_e,vt!==0);Rt.draw(y,L.TRIANGLES,At,K,ai.alphaBlended,y.renderElevatedRasterBackface?Yt.frontCCW:Yt.backCCW,ht,T.id,Ut,ii,wi)}}else{const At=y.depthModeForSublayer(0,Dt.ReadOnly),vt=$[ue.overscaledZ],{tileBoundsBuffer:Tt,tileBoundsIndexBuffer:Ut,tileBoundsSegments:ii}=y.getTileBoundsBuffers(le);Rt.draw(y,L.TRIANGLES,At,vt,ai.alphaBlended,Yt.disabled,ht,T.id,Tt,Ut,ii)}}y.resetStencilClippingMasks()}(u,t,r,h),u.style.map.triggerRepaint())},background:function(u,t,r,h){const p=r.paint.get("background-color"),g=r.paint.get("background-color-use-theme").constantOr("default")==="none",y=r.paint.get("background-opacity"),w=r.paint.get("background-emissive-strength"),T=r.paint.get("background-pitch-alignment")==="viewport";if(y===0)return;const A=u.context,M=A.gl,z=u.transform,L=z.tileSize,D=r.paint.get("background-pattern");let N;if(D!==void 0&&(D===null||(N=u.imageManager.getPattern(s.I.from(D.toString()),r.scope,u.style.getLut(r.scope)),!N)))return;const B=!D&&p.a===1&&y===1&&u.opaquePassEnabledForLayer()?"opaque":"translucent";if(u.renderPass!==B)return;const G=Jt.disabled,$=u.depthModeForSublayer(0,B==="opaque"?Dt.ReadWrite:Dt.ReadOnly),X=u.colorModeForDrapableLayerRenderPass(w),J=D?"backgroundPattern":"background";let K,ue=h;ue||(K=u.getBackgroundTiles(),ue=Object.values(K).map(le=>le.tileID)),D&&(A.activeTexture.set(M.TEXTURE0),u.imageManager.bind(u.context,r.scope));const oe=[];if(u.terrain&&u.terrain.renderingToTexture&&u.emissiveMode==="mrt-fallback"&&oe.push("USE_MRT1"),T){const le=u.getOrCreateProgram(J,{overrideFog:!1,overrideRtt:!0,defines:oe}),re=new Float32Array(s.bA([])),te=new s.aQ(0,0,0,0,0),he=D?ol(re,w,y,u,0,r.scope,N,T,{tileID:te,tileSize:L}):Wu(re,w,y,p.toPremultipliedRenderColor(g?null:r.lut));le.draw(u,M.TRIANGLES,$,G,X,Yt.disabled,he,r.id,u.viewportBuffer,u.quadTriangleIndexBuffer,u.viewportSegments)}else for(const le of ue){const re=u.isTileAffectedByFog(le),te=u.getOrCreateProgram(J,{overrideFog:re,defines:oe}),he=le.toUnwrapped(),we=h?le.projMatrix:u.transform.calculateProjMatrix(he);u.prepareDrawTile();const ye=t?t.getTile(le):K?K[le.key]:new zl(le,L,z.zoom,u),ze=D?ol(we,w,y,u,0,r.scope,N,T,{tileID:le,tileSize:L}):Wu(we,w,y,p.toPremultipliedRenderColor(g?null:r.lut));u.uploadCommonUniforms(A,te,he);const{tileBoundsBuffer:Oe,tileBoundsIndexBuffer:$e,tileBoundsSegments:ot}=u.getTileBoundsBuffers(ye);te.draw(u,M.TRIANGLES,$,G,X,Yt.disabled,ze,r.id,Oe,$e,ot)}},sky:function(u,t,r){const h=u._atmosphere?s.aj(u.transform.zoom):1,p=r.paint.get("sky-opacity")*h;if(p===0)return;const g=u.context,y=r.paint.get("sky-type"),w=new Dt(g.gl.LEQUAL,Dt.ReadOnly,[0,1]),T=u.frameCounter/1e3%1;y==="atmosphere"?u.renderPass==="offscreen"?r.needsSkyboxCapture(u)&&(function(A,M,z,L){const D=A.context,N=D.gl;let B=M.skyboxFbo;if(!B){B=M.skyboxFbo=D.createFramebuffer(32,32,1,null),M.skyboxGeometry=new Ld(D),M.skyboxTexture=D.gl.createTexture(),N.bindTexture(N.TEXTURE_CUBE_MAP,M.skyboxTexture),N.texParameteri(N.TEXTURE_CUBE_MAP,N.TEXTURE_WRAP_S,N.CLAMP_TO_EDGE),N.texParameteri(N.TEXTURE_CUBE_MAP,N.TEXTURE_WRAP_T,N.CLAMP_TO_EDGE),N.texParameteri(N.TEXTURE_CUBE_MAP,N.TEXTURE_MIN_FILTER,N.LINEAR),N.texParameteri(N.TEXTURE_CUBE_MAP,N.TEXTURE_MAG_FILTER,N.LINEAR);for(let J=0;J<6;++J)N.texImage2D(N.TEXTURE_CUBE_MAP_POSITIVE_X+J,0,N.RGBA,32,32,0,N.RGBA,N.UNSIGNED_BYTE,null)}D.bindFramebuffer.set(B.framebuffer),D.viewport.set([0,0,32,32]);const G=M.getCenter(A,!0),$=A.getOrCreateProgram("skyboxCapture"),X=new Float64Array(16);s.bA(X),s.en(X,X,.5*-Math.PI),Wl(A,M,$,X,G,0),s.bA(X),s.en(X,X,.5*Math.PI),Wl(A,M,$,X,G,1),s.bA(X),s.cU(X,X,.5*-Math.PI),Wl(A,M,$,X,G,2),s.bA(X),s.cU(X,X,.5*Math.PI),Wl(A,M,$,X,G,3),s.bA(X),Wl(A,M,$,X,G,4),s.bA(X),s.en(X,X,Math.PI),Wl(A,M,$,X,G,5),D.viewport.set([0,0,A.width,A.height])}(u,r),r.markSkyboxValid(u)):u.renderPass==="sky"&&function(A,M,z,L,D){const N=A.context,B=N.gl,G=A.transform,$=A.getOrCreateProgram("skybox");N.activeTexture.set(B.TEXTURE0),B.bindTexture(B.TEXTURE_CUBE_MAP,M.skyboxTexture);const X=((J,K,ue,oe,le)=>({u_matrix:J,u_sun_direction:K,u_cubemap:0,u_opacity:oe,u_temporal_offset:le}))(G.skyboxMatrix,M.getCenter(A,!1),0,L,D);A.uploadCommonUniforms(N,$),$.draw(A,B.TRIANGLES,z,Jt.disabled,A.colorModeForRenderPass(),Yt.backCW,X,"skybox",M.skyboxGeometry.vertexBuffer,M.skyboxGeometry.indexBuffer,M.skyboxGeometry.segment)}(u,r,w,p,T):y==="gradient"&&u.renderPass==="sky"&&function(A,M,z,L,D){const N=A.context,B=N.gl,G=A.transform,$=A.getOrCreateProgram("skyboxGradient");M.skyboxGeometry||(M.skyboxGeometry=new Ld(N)),N.activeTexture.set(B.TEXTURE0);let X=M.colorRampTexture;X||(X=M.colorRampTexture=new s.T(N,M.colorRamp,B.RGBA8)),X.bind(B.LINEAR,B.CLAMP_TO_EDGE);const J=((K,ue,oe,le,re)=>({u_matrix:K,u_color_ramp:0,u_center_direction:ue,u_radius:s.an(oe),u_opacity:le,u_temporal_offset:re}))(G.skyboxMatrix,M.getCenter(A,!1),M.paint.get("sky-gradient-radius"),L,D);A.uploadCommonUniforms(N,$),$.draw(A,B.TRIANGLES,z,Jt.disabled,A.colorModeForRenderPass(),Yt.backCW,J,"skyboxGradient",M.skyboxGeometry.vertexBuffer,M.skyboxGeometry.indexBuffer,M.skyboxGeometry.segment)}(u,r,w,p,T)},custom:function(u,t,r,h){const p=u.context,g=r.implementation;if(!u.transform.projection.unsupportedLayers||!u.transform.projection.unsupportedLayers.includes("custom")||u.terrain&&(u.terrain.renderingToTexture||u.renderPass==="offscreen")&&r.isDraped(t)){if(u.renderPass==="offscreen"){const y=g.prerender;if(y){if(u.setCustomLayerDefaults(),p.setColorMode(u.colorModeForRenderPass()),u.transform.projection.name==="globe"){const w=u.transform.pointMerc;y.call(g,p.gl,u.transform.customLayerMatrix(),u.transform.getProjection(),u.transform.globeToMercatorMatrix(),s.aj(u.transform.zoom),[w.x,w.y],u.transform.pixelsPerMeterRatio)}else y.call(g,p.gl,u.transform.customLayerMatrix());p.setDirty(),u.setBaseState()}}else if(u.renderPass==="translucent"){if(u.terrain&&u.terrain.renderingToTexture){const w=g.renderToTile;if(w){const T=h[0].canonical,A={x:T.x+h[0].wrap*(g.wrapTileId?0:1<<T.z),y:T.y,z:T.z};p.setDepthMode(Dt.disabled),p.setStencilMode(Jt.disabled),p.setColorMode(u.colorModeForRenderPass()),u.setCustomLayerDefaults(),w.call(g,p.gl,A),p.setDirty(),u.setBaseState()}return}u.setCustomLayerDefaults(),p.setColorMode(u.colorModeForRenderPass()),p.setStencilMode(Jt.disabled);const y=g.renderingMode==="3d"?new Dt(u.context.gl.LEQUAL,Dt.ReadWrite,u.depthRangeFor3D):u.depthModeForSublayer(0,Dt.ReadOnly);if(p.setDepthMode(y),u.transform.projection.name==="globe"){const w=u.transform.pointMerc;g.render(p.gl,u.transform.customLayerMatrix(),u.transform.getProjection(),u.transform.globeToMercatorMatrix(),s.aj(u.transform.zoom),[w.x,w.y],u.transform.pixelsPerMeterRatio)}else g.render(p.gl,u.transform.customLayerMatrix());p.setDirty(),u.setBaseState(),p.bindFramebuffer.set(null)}}else s.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(u,t,r,h){if(u.renderPass==="opaque")return;const p=r.paint.get("model-opacity").constantOr(1),g=r.paint.get("model-elevation-reference"),y=g==="ground",w=g==="ground";if(p===0)return;const T=r.paint.get("model-cast-shadows");if(u.renderPass==="shadow"&&(!T||u.terrain&&p<.65&&r._transitionablePaint._values["model-opacity"].value.expression instanceof s.ad))return;const A=u.shadowRenderer,M=r.paint.get("model-receive-shadows");A&&(A.useNormalOffset=!0,M||(A.enabled=!1));const z=()=>{A&&(A.useNormalOffset=!0,M||(A.enabled=!0))},L=t.getSource();if(u.renderPass==="light-beam"&&L.type!=="batched-model")return;if(L.type==="vector"||L.type==="geojson")return function(K,ue,oe,le,re){const te=K.transform,he=te.projection.name==="globe",we=te.getFreeCameraOptions().position;if(!K.modelManager)return;const ye=K.modelManager;oe.modelManager=ye;const ze=K.shadowRenderer;if(!oe._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const Oe=oe._unevaluatedLayout._values["model-id"],$e=Object.assign({},oe.layout.get("model-id").parameters),ot=K.style.order.indexOf(oe.fqid),Ae=oe.paint.get("model-opacity").constantOr(1);for(const _e of le){const Ne=ue.getTile(_e).getBucket(oe);if(!Ne||Ne.projection.name!==te.projection.name)continue;const Re=Ne.getModelUris();if(Re&&!Ne.modelsRequested&&(ye.addModelsFromBucket(Re,re),Ne.modelsRequested=!0),he)$e.zoom=_e.overscaledZ;else{const vt=lo(_e,te);$e.zoom=vt}const Ke=Oe.possiblyEvaluate($e);if(iy(K,Ne,_e),Gs.shadowUniformsInitialized=!1,Gs.useSingleShadowCascade=!!ze&&ze.getMaxCascadeForTile(_e.toUnwrapped())===0,K.renderPass==="shadow"&&ze){if(K.currentShadowCascade===1&&Ne.isInsideFirstShadowMapFrustum)continue;const vt=te.calculatePosMatrix(_e.toUnwrapped(),te.worldSize);if(Gs.tileMatrix.set(vt),Gs.shadowTileMatrix=Float32Array.from(ze.calculateShadowPassMatrixFromMatrix(vt)),Gs.aabb.min=[0,0,0],Gs.aabb.max[0]=Gs.aabb.max[1]=s.al,Gs.aabb.max[2]=0,Qv(Ne,Gs,K,oe.scope))continue}const pt=1<<_e.canonical.z,wt=[((we.x-_e.wrap)*pt-_e.canonical.x)*s.al,(we.y*pt-_e.canonical.y)*s.al,we.z*pt*s.al];K.conflationActive&&Object.keys(Ne.instancesPerModel).length>0&&K.style.isLayerClipped(oe,ue.getSource())&&Ne.updateReplacement(_e,K.replacementSource,ot,oe.scope)&&(Ne.uploaded=!1,Ne.upload(K.context));let ht=0;const st=new Array,Rt=new Array,At=new Array;for(let vt in Ne.instancesPerModel){const Tt=Ne.instancesPerModel[vt];Tt.features.length>0&&!he&&(vt=Ke.evaluate(Tt.features[0].feature,{}));const Ut=ye.getModel(vt,re);if(Ut||ye.hasURLBeenRequested(vt)||Ne.modelUris.includes(vt)||(Ne.modelUris.push(vt),Ne.modelsRequested=!1),Ut&&Ut.uploaded)if(he){const ii=s.c5([],[we.x,we.y,we.z],K.transform.worldSize);s.ew(ii,ii);for(let wi=0;wi<Tt.instancedDataArray.length;++wi){const Ui=[0,0,0],Lt=[1,1,1],Fi=s.ex(),ti=Tt.tileCoordinatesForInstance(wi),Gi=Tt.transformForInstance(wi);s.ey(Lt,Gi),s.ez(Fi,Gi),s.eA(Ui,Fi);const Qi=Tt.translationForInstance(wi),Xi=new s.aT(0,0);s.eB(Ne.canonical,Xi,ti.x,ti.y);const Di=s.bC();s.eC(Di,Ut,K.transform,Xi,Ui,Lt,Qi,!0,!1,!1);const ci=Tt.colorForInstance(wi),$i=s.bA([]),zn=s.ef(Xi.lat,K.transform.zoom),xn=s.bq([],[1,1,1/zn]);s.br($i,$i,ii),At.push({zScaleMatrix:xn,negCameraPosMatrix:$i});for(const Hi of Ut.nodes)Zl(K,Hi,Di,K.transform.expandedFarZProjMatrix,ht,st,Rt,Ut.materialOverrides,Ae,ci);++ht}}else for(const ii of Ut.nodes)ny(K,oe,ii,Tt,wt,_e,Gs)}if(he)if(K.renderPass==="shadow"){for(const vt of Rt)xs(vt.mesh,vt.nodeModelMatrix,K,oe);for(const vt of st)xs(vt.mesh,vt.nodeModelMatrix,K,oe)}else ty(K,oe,st,Rt,At)}}(u,t,r,h,Ju(u,r)),void z();if(!L.loaded())return;if(L.type==="batched-model")return function(K,ue,oe,le){oe.resetLayerRenderingStats(K);const re=K.context,te=K.transform,he=K.style.fog,we=K.shadowRenderer;if(te.projection.name!=="mercator")return void s.w(`Drawing 3D landmark models for ${te.projection.name} projection is not yet implemented`);const ye=K.transform.getFreeCameraOptions().position,ze=s.c5([],[ye.x,ye.y,ye.z],K.transform.worldSize),Oe=s.ew([],ze),$e=s.bA([]),ot=s.ef(te.center.lat,te.zoom),Ae=s.bq([],[1,1,1/ot]);s.br($e,$e,Oe);const _e=oe.paint.get("model-opacity").constantOr(1),Ne=new Dt(re.gl.LEQUAL,Dt.ReadWrite,K.depthRangeFor3D),Re=new Dt(re.gl.LEQUAL,Dt.ReadOnly,K.depthRangeFor3D),Ke=new s.d9([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),pt=K.renderPass==="shadow",wt=pt&&we?we.getCurrentCascadeFrustum():te.getFrustum(te.scaleZoom(te.worldSize)),ht=oe.paint.get("model-front-cutoff"),st=ht[2]<1,Rt=Ya(K,oe.paint.get("model-cutoff-fade-range")),At=oe.getLayerRenderingStats();(function(vt,Tt,Ut,ii){const wi=vt.terrain?vt.terrain.exaggeration():0,Ui=vt.transform.zoom;for(const Lt of ii){const Fi=Tt.getTile(Lt).getBucket(Ut);Fi&&(Fi.setFilter(Ut.filter),vt.conflationActive&&Fi.updateReplacement(Lt,vt.replacementSource),Fi.evaluateTransform(vt,Ut),vt.terrain&&wi>0&&Fi.elevationUpdate(vt.terrain,wi,Lt,Ut.source),Fi.needsReEvaluation(vt,Ui,Ut)&&Fi.evaluate(Ut))}})(K,ue,oe,le),function(){let vt,Tt,Ut;st?(vt=le.length-1,Tt=-1,Ut=-1):(vt=0,Tt=le.length,Ut=1);const ii=new Float64Array(16),wi=s.cA(),Ui=new s.P(0,0);for(let Lt=vt;Lt!==Tt;Lt+=Ut){const Fi=le[Lt],ti=ue.getTile(Fi).getBucket(oe);if(!ti||!ti.uploaded)continue;let Gi=!1;we&&(Gi=we.getMaxCascadeForTile(Fi.toUnwrapped())===0);const Qi=te.calculatePosMatrix(Fi.toUnwrapped(),te.worldSize),Xi=ti.modelTraits;!pt&&st&&(s.bl(ii,Qi),s.af(wi,ze,ii),Ui.x=wi[0],Ui.y=wi[1]);const Di=[];ti.setFilter(oe.filter);for(const ci of ti.getNodesInfo()){if(ci.hiddenByReplacement||!ci.node.meshes)continue;const $i=ci.node;let zn=0;K.terrain&&$i.elevation&&(zn=$i.elevation*K.terrain.exaggeration());const xn=(()=>{const Hr=ci.aabb;return Ke.min=[...Hr.min],Ke.max=[...Hr.max],Ke.min[2]+=zn,Ke.max[2]+=zn,s.af(Ke.min,Ke.min,Qi),s.af(Ke.max,Ke.max,Qi),Ke})(),Hi=ci.evaluatedScale;if(Hi[0]<=1&&Hi[1]<=1&&Hi[2]<=1&&xn.intersects(wt)===0)continue;if(!pt&&st){const Hr=.16666666666666666;ci.cameraCollisionOpacity=ze[0]>xn.min[0]&&ze[0]<xn.max[0]&&ze[1]>xn.min[1]&&ze[1]<xn.max[1]&&ze[2]*ot<xn.max[2]&&$i.footprint&&s.c0(Ui,$i.footprint)?Math.max(ci.cameraCollisionOpacity-Hr,0):Math.min(1,ci.cameraCollisionOpacity+Hr)}const Ci=[...Qi],ui=1/s.d7(Fi.canonical),_n=$i.anchor?$i.anchor[0]:0,Gn=$i.anchor?$i.anchor[1]:0;s.br(Ci,Ci,[_n*(Hi[0]-1)+ci.evaluatedTranslation[0]*ui,Gn*(Hi[1]-1)+ci.evaluatedTranslation[1]*ui,zn+ci.evaluatedTranslation[2]]),s.cq(Hi,s.eE)||s.cS(Ci,Ci,Hi);const Cn=s.aB([],Ci,$i.globalMatrix),rn=s.aB([],te.expandedFarZProjMatrix,Cn),co=s.aB([],te.expandedFarZProjMatrix,Ci),Fr=s.aC([],[_n,Gn,zn,1],rn)[2];$i.hidden=!1;let lr=_e;pt||(st&&(lr*=ci.cameraCollisionOpacity,lr*=_i(Ci,te,ci.aabb,ht)),lr*=vn(Rt,Fr)),lr!==0?Di.push({nodeInfo:ci,depth:Fr,opacity:lr,wvpForNode:rn,wvpForTile:co,nodeModelMatrix:Cn,tileModelMatrix:Ci}):$i.hidden=!0}pt||Di.sort((ci,$i)=>!st||ci.opacity===1&&$i.opacity===1?ci.depth<$i.depth?-1:1:ci.opacity===1?-1:$i.opacity===1?1:ci.depth>$i.depth?-1:1);for(const ci of Di){const $i=ci.nodeInfo,zn=$i.node;let xn=s.aB([],Ae,ci.tileModelMatrix);s.aB(xn,$e,xn);const Hi=s.bl([],xn);s.eg(Hi,Hi),s.cS(Hi,Hi,Qu),xn=s.aB(xn,xn,zn.globalMatrix);const Ci=K.renderPass==="light-beam",ui=oe.paint.get("model-color-use-theme").constantOr("default")==="none",_n=Xi&s.eI.HasMapboxMeshFeatures,Gn=_n?0:$i.evaluatedRMEA[0][2];for(let Cn=0;Cn<zn.meshes.length;++Cn){const rn=zn.meshes[Cn],co=Cn===zn.lightMeshIndex;let Fr=ci.wvpForNode;if(co){if(!Ci&&!K.terrain&&K.shadowRenderer){K.currentLayer<K.firstLightBeamLayer&&(K.firstLightBeamLayer=K.currentLayer);continue}Fr=ci.wvpForTile}else if(Ci)continue;const lr={defines:[]},Hr=[];if(!pt&&we&&(we.useNormalOffset=!!rn.normalBuffer),Od(lr.defines,Hr,rn,K,ui?null:oe.lut),_n||lr.defines.push("DIFFUSE_SHADED"),Gi&&lr.defines.push("SHADOWS_SINGLE_CASCADE"),At&&(pt?At.numRenderedVerticesInShadowPass+=rn.vertexArray.length:At.numRenderedVerticesInTransparentPass+=rn.vertexArray.length),pt){xs(rn,ci.nodeModelMatrix,K,oe);continue}let qr=null;if(he){const Wn=Dd(ci.nodeModelMatrix,K.transform);if(qr=new Float32Array(Wn),te.projection.name!=="globe"){const on=rn.aabb.min,Yn=rn.aabb.max,[Dn,Pn]=he.getOpacityForBounds(Wn,on[0],on[1],Yn[0],Yn[1]);lr.overrideFog=Dn>=Ge||Pn>=Ge}}const zr=rn.material;let No;zr.occlusionTexture&&zr.occlusionTexture.offsetScale&&(No=zr.occlusionTexture.offsetScale,lr.defines.push("OCCLUSION_TEXTURE_TRANSFORM"));const ns=K.getOrCreateProgram("model",lr);!pt&&we&&we.setupShadowsFromMatrix(ci.tileModelMatrix,ns,we.useNormalOffset),K.uploadCommonUniforms(re,ns,null,qr);const xo=zr.pbrMetallicRoughness;xo.metallicFactor=.9,xo.roughnessFactor=.5;const Nn=Vl(new Float32Array(Fr),new Float32Array(xn),new Float32Array(Hi),new Float32Array(zn.globalMatrix),K,ci.opacity,xo.baseColorFactor,zr.emissiveFactor,xo.metallicFactor,xo.roughnessFactor,zr,Gn,oe,[0,0,0],No);!co&&($i.hasTranslucentParts||ci.opacity<1)&&ns.draw(K,re.gl.TRIANGLES,Ne,Jt.disabled,ai.disabled,Yt.backCCW,Nn,oe.id,rn.vertexBuffer,rn.indexBuffer,rn.segments,oe.paint,K.transform.zoom,void 0,Hr),ns.draw(K,re.gl.TRIANGLES,co?Re:Ne,Jt.disabled,co||ci.opacity<1||$i.hasTranslucentParts?ai.alphaBlended:ai.unblended,Yt.backCCW,Nn,oe.id,rn.vertexBuffer,rn.indexBuffer,rn.segments,oe.paint,K.transform.zoom,void 0,Hr)}}}}()}(u,t,r,h),void z();if(L.type!=="model")return;const D=L.getModels(),N=[],B=u.transform.getFreeCameraOptions().position,G=s.c5([],[B.x,B.y,B.z],u.transform.worldSize);s.ew(G,G);const $=[],X=[];let J=0;for(const K of D){const ue=t.getFeatureState("",K.id),oe={type:"Unknown",id:K.id,properties:K.featureProperties},le=r.paint.get("model-rotation").evaluate(oe,ue),re=r.paint.get("model-scale").evaluate(oe,ue),te=r.paint.get("model-translation").evaluate(oe,ue),he=r.paint.get("model-opacity").evaluate(oe,ue);Qg(r,K.id,ue,K.featureProperties,K.nodeOverrideNames,K.nodeOverrides),ey(r,K.id,ue,K.featureProperties,K.materialOverrideNames,K.materialOverrides),K.nodeOverrides.size>0&&K.computeBoundsAndApplyParent(),K.computeModelMatrix(u,le,re,te,w,y,!1);const we=s.bA([]),ye=s.ef(K.position.lat,u.transform.zoom),ze=s.bq([],[1,1,1/ye]);s.br(we,we,G),N.push({zScaleMatrix:ze,negCameraPosMatrix:we});for(const Oe of K.nodes)Zl(u,Oe,K.matrix,u.transform.expandedFarZProjMatrix,J,$,X,K.materialOverrides,he);J++}if($.sort((K,ue)=>ue.depth-K.depth),u.renderPass!=="shadow")ty(u,r,$,X,N),z();else{for(const K of X)xs(K.mesh,K.nodeModelMatrix,u,r);for(const K of $)xs(K.mesh,K.nodeModelMatrix,u,r);z()}}},jd={line:function(u,t,r){if(u.hasElevatedBuckets=!1,u.hasNonElevatedBuckets=!1,u._unevaluatedLayout.getValue("line-elevation-reference")!==void 0||u._unevaluatedLayout.getValue("line-z-offset")!==void 0){if(t){const h=t.getVisibleCoordinates();for(const p of h){const g=t.getTile(p).getBucket(u);if(g&&(g.elevationType!=="none"?u.hasElevatedBuckets=!0:u.hasNonElevatedBuckets=!0,u.hasElevatedBuckets&&u.hasNonElevatedBuckets))break}}}else u.hasNonElevatedBuckets=!0},model:function(u,t,r){const h=t.getSource();if(!h.loaded())return;if(h.type==="vector"||h.type==="geojson")return void(r.modelManager&&r.modelManager.upload(r,Ju(r,u)));if(h.type==="batched-model"||h.type!=="model")return;const p=h.getModels();for(const g of p)g.upload(r.context)},raster:function(u,t,r){const h=t.getSource();if(!(h instanceof Yr&&h.loaded()))return;const p=u.sourceLayer||h.rasterLayerIds&&h.rasterLayerIds[0];if(!p)return;const g=u.paint.get("raster-array-band")||h.getInitialBand(p);if(g==null)return;const y=t.getIds().map(w=>t.getTileByID(w));for(const w of y)w.updateNeeded(u.id,g)&&h.prepareTile(w,p,u.id,g)},"raster-particle":function(u,t,r){const h=t.getSource();if(!(h instanceof Yr&&h.loaded()))return;const p=u.sourceLayer||h.rasterLayerIds&&h.rasterLayerIds[0];if(!p)return;const g=u.paint.get("raster-particle-array-band")||h.getInitialBand(p);if(g==null)return;const y=t.getIds().map(w=>t.getTileByID(w));for(const w of y)w.updateNeeded(u.id,g)&&h.prepareTile(w,p,u.id,g)}},Bo={fill:Id},Ud={fill:function(u,t,r,h){if(!r.layout||r.layout.get("fill-elevation-reference")==="none"||r.paint.get("fill-opacity").constantOr(1)===0)return;const p=u.context.gl,g=new Dt(p.LEQUAL,Dt.ReadOnly,u.depthRangeFor3D),y=new Jt({func:p.ALWAYS,mask:255},255,255,p.KEEP,p.KEEP,p.REPLACE),w=u.transform.getFreeCameraOptions().position,T=u.getOrCreateProgram("elevatedStructuresDepthReconstruct");for(const A of h){const M=t.getTile(A),z=M.getBucket(r);if(!z)continue;const L=z.elevatedStructures;if(!L||L.depthSegments.segments[0].primitiveLength===0)continue;const D=Gg(A.toUnwrapped(),w),N=u.translatePosMatrix(A.projMatrix,M,r.paint.get("fill-translate"),r.paint.get("fill-translate-anchor")),B=Ul(N,D,0,1,0);T.draw(u,p.TRIANGLES,g,y,ai.disabled,Yt.disabled,B,r.id,L.vertexBuffer,L.indexBuffer,L.depthSegments,r.paint,u.transform.zoom)}}};class Vd{constructor(t,r,h,p,g){this.context=new Lc(t,r),this.transform=h,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this._timeStamp=s.o.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={forceEnablePrecipitation:!1,showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};const y=["fill","line","symbol","circle","heatmap","fill-extrusion","building","raster","raster-particle","hillshade","model","background","sky"];for(const T of y)this._debugParams.enabledLayers[T]=!0;for(const T of y);this.occlusionParams=new Dc,this.setup(),this.numSublayers=Io.maxUnderzooming+Io.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new s.eP,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new wc(this),this._wireframeDebugCache=new al,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[];const w=new s.q({width:1,height:1},Uint8Array.of(0,0,0,0));this.emptyDepthTexture=new s.T(this.context,w,t.RGBA8),this._clippingActiveLastFrame=!1,this.scaleFactor=p,this.worldview=g,this._forceEmissiveMode=!1,this.emissiveMode="constant"}updateTerrain(t,r){const h=!!t&&!!t.terrain&&this.transform.projection.supportsTerrain;if(!(h||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new Vp(this,t));const p=this._terrain;this.transform.elevation=h?p:null,p.update(t,this.transform,r),this.transform.elevation&&!p.enabled&&(this.transform.elevation=null)}_updateFog(t){const r=t.fog;if(!r||this.transform.projection.name==="globe"||r.getOpacity(this.transform.pitch)<1||r.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[h,p]=r.getFovAdjustedRange(this.transform._fov);if(h>p)return void(this.transform.fogCullDistSq=null);const g=h+.78*(p-h);this.transform.fogCullDistSq=g*g}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(t){t&&!this._terrain&&(this._terrain=new Vp(this,this.style)),this._forceTerrainMode=t}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(t,r){if(this.width=t*s.o.devicePixelRatio,this.height=r*s.o.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const h of this.style.order)this.style._mergedLayers[h].resize()}setup(){const t=this.context,r=new s.bd;r.emplaceBack(0,0),r.emplaceBack(s.al,0),r.emplaceBack(0,s.al),r.emplaceBack(s.al,s.al),this.tileExtentBuffer=t.createVertexBuffer(r,s.bf.members),this.tileExtentSegments=s.bg.simpleSegment(0,0,4,2);const h=new s.bd;h.emplaceBack(0,0),h.emplaceBack(s.al,0),h.emplaceBack(0,s.al),h.emplaceBack(s.al,s.al),this.debugBuffer=t.createVertexBuffer(h,s.bf.members),this.debugSegments=s.bg.simpleSegment(0,0,4,5);const p=new s.bd;p.emplaceBack(-1,-1),p.emplaceBack(1,-1),p.emplaceBack(-1,1),p.emplaceBack(1,1),this.viewportBuffer=t.createVertexBuffer(p,s.bf.members),this.viewportSegments=s.bg.simpleSegment(0,0,4,2);const g=new s.b1;g.emplaceBack(0,0,0,0),g.emplaceBack(s.al,0,s.al,0),g.emplaceBack(0,s.al,0,s.al),g.emplaceBack(s.al,s.al,s.al,s.al),this.mercatorBoundsBuffer=t.createVertexBuffer(g,s.bi.members),this.mercatorBoundsSegments=s.bg.simpleSegment(0,0,4,2);const y=new s.b0;y.emplaceBack(0,1,2),y.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=t.createIndexBuffer(y);const w=new s.be;for(const A of[0,1,3,2,0])w.emplaceBack(A);this.debugIndexBuffer=t.createIndexBuffer(w),this.emptyTexture=new s.T(t,new s.q({width:1,height:1},Uint8Array.of(0,0,0,0)),t.gl.RGBA8),this.identityMat=s.bC();const T=this.context.gl;this.stencilClearMode=new Jt({func:T.ALWAYS,mask:0},0,255,T.ZERO,T.ZERO,T.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(t){return t._makeTileBoundsBuffers(this.context,this.transform.projection),t._tileBoundsBuffer?{tileBoundsBuffer:t._tileBoundsBuffer,tileBoundsIndexBuffer:t._tileBoundsIndexBuffer,tileBoundsSegments:t._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const t=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,t.TRIANGLES,Dt.disabled,this.stencilClearMode,ai.disabled,Yt.disabled,Gu(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(t,r,h){if(!r||this.currentStencilSource===r.id||!t.isTileClipped()||!h||h.length===0)return;if(this._tileClippingMaskIDs&&!this.terrain){let w=!1;for(const T of h)if(this._tileClippingMaskIDs[T.key]===void 0){w=!0;break}if(!w)return}this.currentStencilSource=r.id;const p=this.context,g=p.gl;this.nextStencilID+h.length>256&&this.clearStencil(),p.setColorMode(ai.disabled),p.setDepthMode(Dt.disabled);const y=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const w of h){const T=r.getTile(w),A=this._tileClippingMaskIDs[w.key]=this.nextStencilID++,{tileBoundsBuffer:M,tileBoundsIndexBuffer:z,tileBoundsSegments:L}=this.getTileBoundsBuffers(T);y.draw(this,g.TRIANGLES,Dt.disabled,new Jt({func:g.ALWAYS,mask:0},A,255,g.KEEP,g.KEEP,g.REPLACE),ai.disabled,Yt.disabled,Gu(w.projMatrix),"$clipping",M,z,L)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const t=this.nextStencilID++,r=this.context.gl;return new Jt({func:r.NOTEQUAL,mask:255},t,255,r.KEEP,r.KEEP,r.REPLACE)}stencilModeForClipping(t){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(t);const r=this.context.gl;return new Jt({func:r.EQUAL,mask:255},this._tileClippingMaskIDs[t.key],0,r.KEEP,r.KEEP,r.REPLACE)}stencilConfigForOverlap(t){const r=this.context.gl,h=t.sort((y,w)=>w.overscaledZ-y.overscaledZ),p=h[h.length-1].overscaledZ,g=h[0].overscaledZ-p+1;if(g>1){this.currentStencilSource=void 0,this.nextStencilID+g>256&&this.clearStencil();const y={};for(let w=0;w<g;w++)y[w+p]=new Jt({func:r.GEQUAL,mask:255},w+this.nextStencilID,255,r.KEEP,r.KEEP,r.REPLACE);return this.nextStencilID+=g,[y,h]}return[{[p]:Jt.disabled},h]}colorModeForRenderPass(){const t=this.context.gl;return this._showOverdrawInspector?new ai([t.CONSTANT_COLOR,t.ONE,t.CONSTANT_COLOR,t.ONE],new s.ao(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?ai.unblended:ai.alphaBlended}colorModeForDrapableLayerRenderPass(t){const r=this.context.gl;return this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture&&this.renderPass==="translucent"?t!=null&&this.emissiveMode!=="mrt-fallback"||this.emissiveMode==="constant"?new ai([r.ONE,r.ONE_MINUS_SRC_ALPHA,r.CONSTANT_ALPHA,r.ONE_MINUS_SRC_ALPHA],new s.ao(0,0,0,t??0),[!0,!0,!0,!0]):this.emissiveMode==="dual-source-blending"?new ai([r.ONE,r.ONE_MINUS_SRC_ALPHA,this.context.extBlendFuncExtended.SRC1_ALPHA_WEBGL,r.ONE_MINUS_SRC_ALPHA],s.ao.transparent,[!0,!0,!0,!0]):this.colorModeForRenderPass():this.colorModeForRenderPass()}depthModeForSublayer(t,r,h,p=!1){if(this.depthOcclusion)return new Dt(this.context.gl.GREATER,Dt.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!p)return Dt.disabled;const g=1-((1+this.currentLayer)*this.numSublayers+t)*this.depthEpsilon;return new Dt(h||this.context.gl.LEQUAL,r,[g,g])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){const t=this.context.gl,r=Math.ceil(this.width),h=Math.ceil(this.height),p=this.context.bindFramebuffer.get(),g=t.getParameter(t.TEXTURE_BINDING_2D);this.depthFBO&&this.depthFBO.width===r&&this.depthFBO.height===h||(this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),r!==0&&h!==0&&(this.depthFBO=new $g(this.context,r,h,0,"texture"),this.depthTexture=new s.T(this.context,{width:r,height:h,data:null},t.DEPTH24_STENCIL8),this.depthFBO.depthAttachment.set(this.depthTexture.texture))),this.context.bindFramebuffer.set(p),t.bindTexture(t.TEXTURE_2D,g),this.depthFBO&&(t.bindFramebuffer(t.READ_FRAMEBUFFER,null),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.depthFBO.framebuffer),t.blitFramebuffer(0,0,r,h,0,0,r,h,t.DEPTH_BUFFER_BIT,t.NEAREST),t.bindFramebuffer(t.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(this._dt===0?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce((t,r)=>t+r/this._fpsHistory.length,0))}render(t,r){const h=s.o.now();this._dt=h-this._timeStamp,this._timeStamp=h,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=t.map.repaint,this.style=t,this.options=r;const p=this.style._mergedLayers,g=!(!this.terrain||!this.terrain.enabled),y=()=>this.style._getOrder(g).filter(Ae=>{const _e=p[Ae];return!(_e.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[_e.type]});let w=y(),T=!1,A=!1,M=null,z=0,L=!1;for(const Ae of w){const _e=p[Ae];_e.visibility!=="none"&&(_e.type==="circle"?T=!0:_e.type==="building"?(M=_e,++z):_e.type==="symbol"&&(_e.hasOcclusionOpacityProperties?A=!0:T=!0))}this.updateEmissiveMode();let D=w.map(Ae=>p[Ae]);const N=this.style._mergedSourceCaches;this.imageManager=t.imageManager,this.modelManager=t.modelManager,this.symbolFadeChange=t.placement.symbolFadeChange(s.o.now()),this.imageManager.beginFrame();for(const Ae in N){const _e=N[Ae];_e.used&&(_e.prepare(this.context),_e.getSource().usedInConflation&&++z)}let B=!1;for(const Ae of D)Ae.isHidden(this.transform.zoom)||(Ae.type==="clip"&&(B=!0),this.prepareLayer(Ae));const G={},$={},X={},J={},K={};for(const Ae in N){const _e=N[Ae];G[Ae]=_e.getVisibleCoordinates(),$[Ae]=G[Ae].slice().reverse(),X[Ae]=_e.getVisibleCoordinates(!0).reverse(),J[Ae]=_e.getShadowCasterCoordinates(),K[Ae]=_e.sortCoordinatesByDistance(G[Ae])}const ue=Ae=>{const _e=this.style.getLayerSourceCache(Ae);return _e&&_e.used?_e.getSource():null};if(z||B||this._clippingActiveLastFrame){const Ae=[],_e=[];let Ne=0;for(const Re of D)this.isSourceForClippingOrConflation(Re,ue(Re))&&(Ae.push(Re),_e.push(Ne)),Ne++;if(Ae&&(B||Ae.length>1)||this._clippingActiveLastFrame){B=!1;const Re=[];for(let Ke=0;Ke<Ae.length;Ke++){const pt=Ae[Ke],wt=_e[Ke],ht=this.style.getLayerSourceCache(pt);if(!ht||!ht.used||!ht.getSource().usedInConflation&&pt.type!=="clip"&&pt.type!=="building")continue;let st=s.eQ,Rt=s.b_.None;const At=[];let vt=!0;if(pt.type==="building")st=s.eS;else if(pt.type==="clip"){st=wt;for(const Tt of pt.layout.get("clip-layer-types"))Rt|=Tt==="model"?s.b_.Model:Tt==="symbol"?s.b_.Symbol:s.b_.FillExtrusion;for(const Tt of pt.layout.get("clip-layer-scope"))At.push(Tt);pt.isHidden(this.transform.zoom)?vt=!1:B=!0}vt&&Re.push({layer:pt.fqid,cache:ht,order:st,clipMask:Rt,clipScope:At})}this.replacementSource.setSources(Re),L=!0}}this._clippingActiveLastFrame=B,L||this.replacementSource.clear(),this.conflationActive=L,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let Ae=0;Ae<D.length;Ae++){const _e=D[Ae];if(_e.visibility==="none")continue;const Ne=_e.cutoffRange();if(this.longestCutoffRange=Math.max(Ne,this.longestCutoffRange),Ne>0){const Re=ue(_e);Re&&(this.minCutoffZoom=Math.max(Re.minzoom,this.minCutoffZoom)),_e.minzoom&&(this.minCutoffZoom=Math.max(_e.minzoom,this.minCutoffZoom))}_e.is3D(g)&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=Ae),this._lastOcclusionLayer=Ae)}const oe=this.style&&this.style.fog;oe?(this._fogVisible=oe.getOpacity(this.transform.pitch)!==0,this._fogVisible&&this.transform.projection.name!=="globe"&&(this._fogVisible=oe.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(X),this.opaquePassCutoff=0,w=y(),D=w.map(Ae=>p[Ae]));const le=this._shadowRenderer;if(le){le.updateShadowParameters(this.transform,this.style.directionalLight);for(const Ae in N)for(const _e of G[Ae]){let Ne={min:0,max:0};this.terrain&&(Ne=this.terrain.getMinMaxForTile(_e)||Ne),le.addShadowReceiver(_e.toUnwrapped(),Ne.min,Ne.max)}}this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new s.eR(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new Jg(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0);const re=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.snow),te=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.rain);if(re&&!this._snow&&(this._snow=new rm(this)),!re&&this._snow&&(this._snow.destroy(),delete this._snow),te&&!this._rain&&(this._rain=new Nd(this)),!te&&this._rain&&(this._rain.destroy(),delete this._rain),this._snow&&this._snow.update(this),this._rain&&this._rain.update(this),M){this.buildingTileBorderManager||(this.buildingTileBorderManager=new zd);const Ae=this.style.getLayerSourceCache(M);this.buildingTileBorderManager.updateBorders(Ae,M)}if(!Eo.has(this.context.gl))return;this.renderPass="offscreen";for(const Ae of D){const _e=t.getLayerSourceCache(Ae);if(!Ae.hasOffscreenPass()||Ae.isHidden(this.transform.zoom))continue;const Ne=_e?$[_e.id]:void 0;(Ae.type==="custom"||Ae.type==="raster"||Ae.type==="raster-particle"||Ae.isSky()||Ne&&Ne.length)&&this.renderLayer(this,_e,Ae,Ne)}this.depthRangeFor3D=[0,1-(D.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,J)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const he=this.transform.projection.name==="globe"||this.transform.isHorizonVisible(),we=(()=>{if(r.showOverdrawInspector)return s.ao.black;const Ae=this.style.fog;if(Ae&&this.transform.projection.supportsFog){const _e=this.style.getLut(Ae.scope);if(!he){const Ne=Ae.properties.get("color-use-theme")==="none",Re=Ae.properties.get("color").toNonPremultipliedRenderColor(Ne?null:_e).toArray01();return new s.ao(...Re)}if(he){const Ne=Ae.properties.get("space-color-use-theme")==="none",Re=Ae.properties.get("space-color").toNonPremultipliedRenderColor(Ne?null:_e).toArray01();return new s.ao(...Re)}}return s.ao.transparent})();if(this.context.clear({color:we,depth:1}),this.clearStencil(),this._showOverdrawInspector=r.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&he&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=w.length-1;this.currentLayer>=0;this.currentLayer--){const Ae=D[this.currentLayer],_e=t.getLayerSourceCache(Ae);if(Ae.isSky())continue;const Ne=_e?(Ae.is3D(g)?K:$)[_e.id]:void 0;this._renderTileClippingMasks(Ae,_e,Ne),this.renderLayer(this,_e,Ae,Ne)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&he&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||s.aj(this.transform.zoom)>0)&&(this.transform.projection.name==="globe"||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<w.length;this.currentLayer++){const Ae=D[this.currentLayer],_e=t.getLayerSourceCache(Ae);Ae.isSky()&&this.renderLayer(this,_e,Ae,_e?$[_e.id]:void 0)}function ye(Ae,_e){let Ne;return _e&&(Ne=(Ae.type==="symbol"?X:Ae.is3D(g)?K:$)[_e.id]),Ne}if(this.renderPass="translucent",this.transform.projection.name==="globe"){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<w.length;){const Ae=D[this.currentLayer];if(Ae.type==="raster"||Ae.type==="raster-particle"){const _e=t.getLayerSourceCache(Ae);this.renderLayer(this,_e,Ae,ye(Ae,_e))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let ze=0;le&&(ze=le.getShadowCastingLayerCount());let Oe=!1,$e=-1;for(let Ae=0;Ae<w.length;++Ae){const _e=D[Ae];_e.isHidden(this.transform.zoom)||_e.is3D(g)&&($e=Ae)}A&&$e===-1&&(T=!0);let ot=!1;for(;this.currentLayer<w.length;){const Ae=D[this.currentLayer],_e=t.getLayerSourceCache(Ae);if(Ae.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(Ae)){if(Ae.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(!ot&&Ae.is3D(g)&&!g){const Ne=this.currentLayer,Re=Ke=>{for(this.currentLayer=0;this.currentLayer<D.length;this.currentLayer++){const pt=D[this.currentLayer];if(Bo[pt.type]){const wt=this.style.getLayerSourceCache(pt);Bo[pt.type](this,wt,pt,ye(pt,wt),Ke)}}};Re("initialize"),Re("reset"),this.currentLayer=Ne,ot=!0}if(T&&!Oe&&this.terrain&&!this.transform.isOrthographic&&(Oe=!0,this.blitDepth()),A&&$e!==-1&&this.currentLayer===$e+1&&!this.transform.isOrthographic&&this.blitDepth(),this.terrain||this._renderTileClippingMasks(Ae,_e,_e?G[_e.id]:void 0),this.renderLayer(this,_e,Ae,ye(Ae,_e)),!this.terrain&&le&&ze>0&&Ae.hasShadowPass()&&--ze==0){{this.clearStencil(),this.resetStencilClippingMasks();const Ne=this.currentLayer;for(this.currentLayer=0;this.currentLayer<D.length;this.currentLayer++){const Re=D[this.currentLayer];if(Ud[Re.type]){const Ke=this.style.getLayerSourceCache(Re);Ud[Re.type](this,Ke,Re,ye(Re,Ke))}}this.currentLayer=Ne}if(le.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer){const Ne=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=Ne;this.currentLayer++){const Re=D[this.currentLayer];if(!Re.hasLightBeamPass())continue;const Ke=t.getLayerSourceCache(Re);this.renderLayer(this,Ke,Re,Ke?$[Ke.id]:void 0)}this.currentLayer=Ne,this.renderPass="translucent"}}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){const Ne=this.currentLayer;this.depthOcclusion=!0;for(const Re of this.layersWithOcclusionOpacity){this.currentLayer=Re;const Ke=D[this.currentLayer],pt=t.getLayerSourceCache(Ke),wt=pt?$[pt.id]:void 0;this.terrain||this._renderTileClippingMasks(Ke,pt,pt?G[pt.id]:void 0),this.renderLayer(this,pt,Ke,wt)}this.depthOcclusion=!1,this.currentLayer=Ne,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this._snow&&this._snow.draw(this),this._rain&&this._rain.draw(this),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let Ae=null;D.forEach(_e=>{const Ne=t.getLayerSourceCache(_e);Ne&&!_e.isHidden(this.transform.zoom)&&Ne.getVisibleCoordinates().length&&(!Ae||Ae.getSource().maxzoom<Ne.getSource().maxzoom)&&(Ae=Ne)}),Ae&&this.options.showTileBoundaries&&ut(this,Ae,Ae.getVisibleCoordinates(),s.ao.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&ut(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new s.ao(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&function(Ae){const _e=Ae.transform.padding;ql(Ae,Ae.transform.height-(_e.top||0),3,Wg),ql(Ae,_e.bottom||0,3,Zg),Bn(Ae,_e.left||0,3,Xg),Bn(Ae,Ae.transform.width-(_e.right||0),3,Gl);const Ne=Ae.transform.centerPoint;(function(Re,Ke,pt,wt){Se(Re,Ke-1,pt-10,2,20,wt),Se(Re,Ke-10,pt-1,20,2,wt)})(Ae,Ne.x,Ae.transform.height-Ne.y,Hl)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),L||(this.conflationActive=!1)}prepareLayer(t){this.gpuTimingStart(t);const{unsupportedLayers:r}=this.transform.projection,h=!r||!r.includes(t.type);if(jd[t.type]&&(h||this.terrain&&t.type==="custom")){const p=this.style.getLayerSourceCache(t);jd[t.type](t,p,this)}this.gpuTimingEnd()}renderLayer(t,r,h,p){h.isHidden(this.transform.zoom)||(h.type==="background"||h.type==="sky"||h.type==="custom"||h.type==="model"||h.type==="raster"||h.type==="raster-particle"||p&&p.length)&&(this.id=h.id,this.gpuTimingStart(h),t.transform.projection.unsupportedLayers&&t.transform.projection.unsupportedLayers.includes(h.type)&&(!t.terrain||h.type!=="custom")||h.type==="clip"||ll[h.type](t,r,h,p,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(t){if(!this.options.gpuTiming)return;const r=this.context.extTimerQuery,h=this.context.gl;let p=this.gpuTimers[t.id];p||(p=this.gpuTimers[t.id]={calls:0,cpuTime:0,query:h.createQuery()}),p.calls++,h.beginQuery(r.TIME_ELAPSED_EXT,p.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const t=this.context.extTimerQuery,r=this.context.gl,h=r.createQuery();this.deferredRenderGpuTimeQueries.push(h),r.beginQuery(t.TIME_ELAPSED_EXT,h)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const t=this.gpuTimers;return this.gpuTimers={},t}collectDeferredRenderGpuQueries(){const t=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],t}queryGpuTimers(t){const r={};for(const h in t){const p=t[h],g=this.context.extTimerQuery,y=g.getQueryParameter(p.query,this.context.gl.QUERY_RESULT)/1e6;g.deleteQueryEXT(p.query),r[h]=y}return r}queryGpuTimeDeferredRender(t){if(!this.options.gpuTimingDeferredRender)return 0;const r=this.context.gl;let h=0;for(const p of t)h+=r.getQueryParameter(p,r.QUERY_RESULT)/1e6,r.deleteQuery(p);return h}translatePosMatrix(t,r,h,p,g){if(!h[0]&&!h[1])return t;const y=g?p==="map"?this.transform.angle:0:p==="viewport"?-this.transform.angle:0;if(y){const A=Math.sin(y),M=Math.cos(y);h=[h[0]*M-h[1]*A,h[0]*A+h[1]*M]}const w=[g?h[0]:s.ay(r,h[0],this.transform.zoom),g?h[1]:s.ay(r,h[1],this.transform.zoom),0],T=new Float32Array(16);return s.br(T,t,w),T}saveTileTexture(t){if(t.context!==this.context)return;const r=t.size[0],h=this._tileTextures[r];h?h.push(t):this._tileTextures[r]=[t]}getTileTexture(t){const r=this._tileTextures[t];return r&&r.length>0?r.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return this.context.extTextureFloatLinear!=null}currentGlobalDefines(t,r,h){const p=h===void 0?this.terrain&&this.terrain.renderingToTexture:h,g=[];return this.style&&this.style.enable3dLights()&&(t==="globeRaster"||t==="terrainRaster"?(g.push("LIGHTING_3D_MODE"),g.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):p||g.push("LIGHTING_3D_MODE")),this.renderPass==="shadow"&&(this._shadowMapDebug||g.push("DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(g.push("TERRAIN"),this.linearFloatFilteringSupported()&&g.push("TERRAIN_DEM_FLOAT_FORMAT")),this.transform.projection.name==="globe"&&g.push("GLOBE"),!this._fogVisible||p||r!==void 0&&!r||g.push("FOG","FOG_DITHERING"),p&&g.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&g.push("OVERDRAW_INSPECTOR"),g}getOrCreateProgram(t,r){this.cache=this.cache||{};const h=r&&r.defines||[],p=r&&r.config,g=this.currentGlobalDefines(t,r&&r.overrideFog,r&&r.overrideRtt).concat(h),y=Rg.cacheKey(Pp[t],t,g,p);return this.cache[y]||(this.cache[y]=new Rg(this.context,t,Pp[t],p,Ed[t],g)),this.cache[y]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const t=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(t.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new s.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA8))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),this.emptyDepthTexture&&this.emptyDepthTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(t,r){if(this.style.enable3dLights()){const h=this.style.directionalLight,p=this.style.ambientLight;if(h&&p){const g=((y,w,T)=>{const A=y.properties.get("direction"),M=y.properties.get("color-use-theme")==="none",z=y.properties.get("color").toNonPremultipliedRenderColor(M?null:T.getLut(y.scope)).toArray01(),L=y.properties.get("intensity"),D=w.properties.get("color-use-theme")==="none",N=w.properties.get("color").toNonPremultipliedRenderColor(D?null:T.getLut(w.scope)).toArray01(),B=w.properties.get("intensity"),G=[A.x,A.y,A.z],$=s.dN(N,B),X=s.dN(z,L);return{u_lighting_ambient_color:$,u_lighting_directional_dir:G,u_lighting_directional_color:X,u_ground_radiance:Mc(G,X,$)}})(h,p,this.style);r.setLightsUniformValues(t,g)}}}uploadCommonUniforms(t,r,h,p,g){if(this.uploadCommonLightUniforms(t,r),this.terrain&&this.terrain.renderingToTexture)return;const y=this.style.fog;if(y){const w=y.getOpacity(this.transform.pitch),T=((A,M,z,L,D,N,B,G,$,X,J,K)=>{const ue=A.transform,oe=M.properties.get("color-use-theme")==="none",le=M.properties.get("color").toNonPremultipliedRenderColor(oe?null:A.style.getLut(M.scope)).toArray01();le[3]=L;const re=A.frameCounter/1e3%1,[te,he]=M.properties.get("vertical-range");return{u_fog_matrix:z?ue.calculateFogTileMatrix(z):K||A.identityMat,u_fog_range:M.getFovAdjustedRange(ue._fov),u_fog_color:le,u_fog_horizon_blend:M.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(te,he),he],u_fog_temporal_offset:re,u_frustum_tl:D,u_frustum_tr:N,u_frustum_br:B,u_frustum_bl:G,u_globe_pos:$,u_globe_radius:X,u_viewport:J,u_globe_transition:s.aj(ue.zoom),u_is_globe:+(ue.projection.name==="globe")}})(this,y,h,w,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*s.o.devicePixelRatio,this.transform.height*s.o.devicePixelRatio],p);r.setFogUniformValues(t,T)}g&&r.setCutoffUniformValues(t,g.uniformValues)}setTileLoadedFlag(t){this.tileLoaded=t}saveCanvasCopy(){const t=this.canvasCopy();t&&(this.frameCopies.push(t),this.tileLoaded=!1)}canvasCopy(){const t=this.context.gl,r=t.createTexture();return t.bindTexture(t.TEXTURE_2D,r),t.copyTexImage2D(t.TEXTURE_2D,0,t.RGBA,0,0,t.drawingBufferWidth,t.drawingBufferHeight,0),r}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const t=this.style&&this.style.fog;return!!t&&t.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){const t=this._backgroundTiles,r=this._backgroundTiles={},h=this.transform.coveringTiles({tileSize:512});for(const p of h)r[p.key]=t[p.key]||new zl(p,512,this.transform.tileZoom,this,void 0,this.worldview);return r}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(t,r){return!(!t.is3D(!(!this.terrain||!this.terrain.enabled))||t.type!=="clip"&&t.type!=="building"&&(t.minzoom&&t.minzoom>this.transform.zoom||(this.style._clipLayerPresent||t.sourceLayer!=="building"&&t.sourceLayer!=="procedural_buildings")&&(!r||r.type!=="batched-model")))}isTileAffectedByFog(t){if(!this.style||!this.style.fog)return!1;if(this.transform.projection.name==="globe")return!0;let r=this._cachedTileFogOpacities[t.key];return r||(this._cachedTileFogOpacities[t.key]=r=this.style.fog.getOpacityForTile(t)),r[0]>=Ge||r[1]>=Ge}setupDepthForOcclusion(t,r,h){const p=this.context,g=p.gl,y=!!h;var w;h||(h={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0}),p.activeTexture.set(g.TEXTURE3),t&&this.depthFBO&&this.depthTexture?(this.depthTexture.bind(g.NEAREST,g.CLAMP_TO_EDGE),h.u_depth_size_inv=[1/this.depthFBO.width,1/this.depthFBO.height],h.u_depth_range_unpack=[2/((w=this.depthRangeFor3D)[1]-w[0]),-1-2*w[0]/(w[1]-w[0])],h.u_occluder_half_size=.5*this.occlusionParams.occluderSize,h.u_occlusion_depth_offset=this.occlusionParams.depthOffset):this.emptyDepthTexture.bind(g.NEAREST,g.CLAMP_TO_EDGE),p.activeTexture.set(g.TEXTURE0),y||r.setTerrainUniformValues(p,h)}updateEmissiveMode(){if(this._forceEmissiveMode)return;const t=this.style.hasDataDrivenEmissiveStrength();this.emissiveMode=t?this.context.extBlendFuncExtended?"dual-source-blending":"mrt-fallback":"constant"}}function $d(u,t){let r=!1,h=null;const p=()=>{h=null,r&&(u(),h=setTimeout(p,t),r=!1)};return()=>(r=!0,h||p(),h)}class om{constructor(t){this._hashName=t&&encodeURIComponent(t),s.aY(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=$d(this._updateHashUnthrottled.bind(this),300)}addTo(t){return this._map=t,window.addEventListener("hashchange",this._onHashChange,!1),t.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const t=this._map;if(!t)return"";const r=sr(t);if(this._hashName){const h=this._hashName;let p=!1;const g=location.hash.slice(1).split("&").map(y=>{const w=y.split("=")[0];return w===h?(p=!0,`${w}=${r}`):y}).filter(y=>y);return p||g.push(`${h}=${r}`),`#${g.join("&")}`}return`#${r}`}_getCurrentHash(){const t=location.hash.replace("#","");if(this._hashName){let r;return t.split("&").map(h=>h.split("=")).forEach(h=>{h[0]===this._hashName&&(r=h)}),(r&&r[1]||"").split("/")}return t.split("/")}_onHashChange(){const t=this._map;if(!t)return!1;const r=this._getCurrentHash();if(r.length>=3&&!r.some(h=>isNaN(Number(h)))){const h=t.dragRotate.isEnabled()&&t.touchZoomRotate.isEnabled()?+(r[3]||0):t.getBearing();return t.jumpTo({center:[+r[2],+r[1]],zoom:+r[0],bearing:h,pitch:+(r[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function sr(u,t){const r=u.getCenter(),h=Math.round(100*u.getZoom())/100,p=Math.ceil((h*Math.LN2+Math.log(512/360/.5))/Math.LN10),g=Math.pow(10,p),y=Math.round(r.lng*g)/g,w=Math.round(r.lat*g)/g,T=u.getBearing(),A=u.getPitch();let M=t?`/${y}/${w}/${h}`:`${h}/${w}/${y}`;return(T||A)&&(M+="/"+Math.round(10*T)/10),A&&(M+=`/${Math.round(A)}`),M}const Fc={linearity:.3,easing:s.eT(0,0,.3,1)},sm=Object.assign({deceleration:2500,maxSpeed:1400},Fc),am=Object.assign({deceleration:20,maxSpeed:1400},Fc),Kl=Object.assign({deceleration:1e3,maxSpeed:360},Fc),lm=Object.assign({deceleration:1e3,maxSpeed:90},Fc);class cm{constructor(t){this._map=t,this.clear()}clear(){this._inertiaBuffer=[]}record(t){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:s.o.now(),settings:t})}_drainInertiaBuffer(){const t=this._inertiaBuffer,r=s.o.now();for(;t.length>0&&r-t[0].time>160;)t.shift()}_onMoveEnd(t){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;const r={zoom:0,bearing:0,pitch:0,pan:new s.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:g}of this._inertiaBuffer)r.zoom+=g.zoomDelta||0,r.bearing+=g.bearingDelta||0,r.pitch+=g.pitchDelta||0,g.panDelta&&r.pan._add(g.panDelta),g.around&&(r.around=g.around),g.pinchAround&&(r.pinchAround=g.pinchAround);const h=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,p={};if(r.pan.mag()){const g=Hs(r.pan.mag(),h,Object.assign({},sm,t||{}));p.offset=r.pan.mult(g.amount/r.pan.mag()),p.center=this._map.transform.center,Bc(p,g)}if(r.zoom){const g=Hs(r.zoom,h,am);p.zoom=this._map.transform.zoom+g.amount,Bc(p,g)}if(r.bearing){const g=Hs(r.bearing,h,Kl);p.bearing=this._map.transform.bearing+s.aA(g.amount,-179,179),Bc(p,g)}if(r.pitch){const g=Hs(r.pitch,h,lm);p.pitch=this._map.transform.pitch+g.amount,Bc(p,g)}if(p.zoom||p.bearing){const g=r.pinchAround===void 0?r.around:r.pinchAround;p.around=g?this._map.unproject(g):this._map.getCenter()}return this.clear(),p.noMoveStart=!0,p}}function Bc(u,t){(!u.duration||u.duration<t.duration)&&(u.duration=t.duration,u.easing=t.easing)}function Hs(u,t,r){const{maxSpeed:h,linearity:p,deceleration:g}=r,y=s.aA(u*p/(t/1e3),-h,h),w=Math.abs(y)/(g*p);return{easing:r.easing,duration:1e3*w,amount:y*(w/2)}}class vo extends s.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,r,h,p={}){const g=Zt(r.getCanvasContainer(),h),y=r.unproject(g);super(t,Object.assign({point:g,lngLat:y,originalEvent:h},p)),this._defaultPrevented=!1,this.target=r}}class cl extends s.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,r,h){const p=t==="touchend"?h.changedTouches:h.touches,g=mn(r.getCanvasContainer(),p),y=g.map(T=>r.unproject(T)),w=g.reduce((T,A,M,z)=>T.add(A.div(z.length)),new s.P(0,0));super(t,{points:g,point:w,lngLats:y,lngLat:r.unproject(w),originalEvent:h}),this._defaultPrevented=!1}}class um extends s.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,r){super("wheel",{originalEvent:r}),this._defaultPrevented=!1}}class Gd{constructor(t,r){this._map=t,this._clickTolerance=r.clickTolerance}reset(){this._mousedownPos=void 0}wheel(t){return this._firePreventable(new um(this._map,t))}mousedown(t,r){return this._mousedownPos=r,this._firePreventable(new vo(t.type,this._map,t))}mouseup(t){this._map.fire(new vo(t.type,this._map,t))}preclick(t){const r=new MouseEvent("preclick",t);this._map.fire(new vo(r.type,this._map,r))}click(t,r){this._mousedownPos&&this._mousedownPos.dist(r)>=this._clickTolerance||(this.preclick(t),this._map.fire(new vo(t.type,this._map,t)))}dblclick(t){return this._firePreventable(new vo(t.type,this._map,t))}mouseover(t){this._map.fire(new vo(t.type,this._map,t))}mouseout(t){this._map.fire(new vo(t.type,this._map,t))}touchstart(t){return this._firePreventable(new cl(t.type,this._map,t))}touchmove(t){this._map.fire(new cl(t.type,this._map,t))}touchend(t){this._map.fire(new cl(t.type,this._map,t))}touchcancel(t){this._map.fire(new cl(t.type,this._map,t))}_firePreventable(t){if(this._map.fire(t),t.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class hm{constructor(t){this._map=t}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(t){this._map.fire(new vo(t.type,this._map,t))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new vo("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(t){this._delayContextMenu?this._contextMenuEvent=t:this._map.fire(new vo(t.type,this._map,t)),this._map.listens("contextmenu")&&t.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Hd{constructor(t,r){this._map=t,this._el=t.getCanvasContainer(),this._container=t.getContainer(),this._clickTolerance=r.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(t,r){this.isEnabled()&&t.shiftKey&&t.button===0&&(Ze(),this._startPos=this._lastPos=r,this._active=!0)}mousemoveWindow(t,r){if(!this._active)return;const h=r,p=this._startPos,g=this._lastPos;if(!p||!g||g.equals(h)||!this._box&&h.dist(p)<this._clickTolerance)return;this._lastPos=h,this._box||(this._box=We("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",t));const y=Math.min(p.x,h.x),w=Math.max(p.x,h.x),T=Math.min(p.y,h.y),A=Math.max(p.y,h.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${y}px,${T}px)`,this._box.style.width=w-y+"px",this._box.style.height=A-T+"px")})}mouseupWindow(t,r){if(!this._active)return;const h=this._startPos,p=r;if(h&&t.button===0){if(this.reset(),zt(),h.x!==p.x||h.y!==p.y)return this._map.fire(new s.z("boxzoomend",{originalEvent:t})),{cameraAnimation:g=>g.fitScreenCoordinates(h,p,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",t)}}keydown(t){this._active&&t.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",t))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),Ct(),delete this._startPos,delete this._lastPos}_fireEvent(t,r){return this._map.fire(new s.z(t,{originalEvent:r}))}}function qd(u,t){const r={};for(let h=0;h<u.length;h++)r[u[h].identifier]=t[h];return r}class oy{constructor(t){this.reset(),this.numTouches=t.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(t,r,h){(this.centroid||h.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===0&&(this.startTime=t.timeStamp),h.length===this.numTouches&&(this.centroid=function(p){const g=new s.P(0,0);for(const y of p)g._add(y);return g.div(p.length)}(r),this.touches=qd(h,r)))}touchmove(t,r,h){if(this.aborted||!this.centroid)return;const p=qd(h,r);for(const g in this.touches){const y=p[g];(!y||y.dist(this.touches[g])>30)&&(this.aborted=!0)}}touchend(t,r,h){if((!this.centroid||t.timeStamp-this.startTime>500)&&(this.aborted=!0),h.length===0){const p=!this.aborted&&this.centroid;if(this.reset(),p)return p}}}class Wd{constructor(t){this.singleTap=new oy(t),this.numTaps=t.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(t,r,h){this.singleTap.touchstart(t,r,h)}touchmove(t,r,h){this.singleTap.touchmove(t,r,h)}touchend(t,r,h){const p=this.singleTap.touchend(t,r,h);if(p){const g=t.timeStamp-this.lastTime<500,y=!this.lastTap||this.lastTap.dist(p)<30;if(g&&y||this.reset(),this.count++,this.lastTime=t.timeStamp,this.lastTap=p,this.count===this.numTaps)return this.reset(),p}}}class sy{constructor(){this._zoomIn=new Wd({numTouches:1,numTaps:2}),this._zoomOut=new Wd({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(t,r,h){this._zoomIn.touchstart(t,r,h),this._zoomOut.touchstart(t,r,h)}touchmove(t,r,h){this._zoomIn.touchmove(t,r,h),this._zoomOut.touchmove(t,r,h)}touchend(t,r,h){const p=this._zoomIn.touchend(t,r,h),g=this._zoomOut.touchend(t,r,h);return p?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:y=>y.easeTo({duration:300,zoom:y.getZoom()+1,around:y.unproject(p)},{originalEvent:t})}):g?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:y=>y.easeTo({duration:300,zoom:y.getZoom()-1,around:y.unproject(g)},{originalEvent:t})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const ay={0:1,2:2},dm={Control:"ctrlKey",Alt:"altKey",Shift:"shiftKey",Meta:"metaKey"};class Zd{constructor(t){this.reset(),this._clickTolerance=t.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(t,r){return!1}_move(t,r){return{}}mousedown(t,r){if(this._lastPoint)return;const h=Xt(t);this._correctButton(t,h)&&(this._lastPoint=r,this._eventButton=h)}mousemoveWindow(t,r){const h=this._lastPoint;if(h){if(t.preventDefault(),this._eventButton!=null&&function(p,g){const y=ay[g];return p.buttons===void 0||(p.buttons&y)!==y}(t,this._eventButton))this.reset();else if(this._moved||!(r.dist(h)<this._clickTolerance))return this._moved=!0,this._lastPoint=r,this._move(h,r)}}mouseupWindow(t){this._lastPoint&&Xt(t)===this._eventButton&&(this._moved&&zt(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class ly extends Zd{mousedown(t,r){super.mousedown(t,r),this._lastPoint&&(this._active=!0)}_correctButton(t,r){return r===0&&!t.ctrlKey}_move(t,r){return{around:r,panDelta:r.sub(t)}}}class fm extends Zd{constructor(t){super(t),this._pitchRotateKey=t.pitchRotateKey?dm[t.pitchRotateKey]:void 0}_correctButton(t,r){return this._pitchRotateKey?r===0&&t[this._pitchRotateKey]:r===0&&t.ctrlKey||r===2}_move(t,r){const h=.8*(r.x-t.x);if(h)return this._active=!0,{bearingDelta:h}}contextmenu(t){this._pitchRotateKey||t.preventDefault()}}class pm extends Zd{constructor(t){super(t),this._pitchRotateKey=t.pitchRotateKey?dm[t.pitchRotateKey]:void 0}_correctButton(t,r){return this._pitchRotateKey?r===0&&t[this._pitchRotateKey]:r===0&&t.ctrlKey||r===2}_move(t,r){const h=-.5*(r.y-t.y);if(h)return this._active=!0,{pitchDelta:h}}contextmenu(t){this._pitchRotateKey||t.preventDefault()}}class cy{constructor(t,r){this._map=t,this._el=t.getCanvasContainer(),this._minTouches=1,this._clickTolerance=r.clickTolerance||1,this.reset(),s.aY(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new s.P(0,0)}touchstart(t,r,h){return this._calculateTransform(t,r,h)}touchmove(t,r,h){if(this._active&&!(h.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(h.length===1&&!s.eU())return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return t.cancelable&&t.preventDefault(),this._calculateTransform(t,r,h)}}touchend(t,r,h){this._calculateTransform(t,r,h),this._active&&h.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(t,r,h){h.length>0&&(this._active=!0);const p=qd(h,r),g=new s.P(0,0),y=new s.P(0,0);let w=0;for(const A in p){const M=p[A],z=this._touches[A];z&&(g._add(M),y._add(M.sub(z)),w++,p[A]=M)}if(this._touches=p,w<this._minTouches||!y.mag())return;const T=y.div(w);return this._sum._add(T),this._sum.mag()<this._clickTolerance?void 0:{around:g.div(w),panDelta:T}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=We("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")},500)}}class Xd{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(t){}_move(t,r,h){return{}}touchstart(t,r,h){this._firstTwoTouches||h.length<2||(this._firstTwoTouches=[h[0].identifier,h[1].identifier],this._start([r[0],r[1]]))}touchmove(t,r,h){const p=this._firstTwoTouches;if(!p)return;t.preventDefault();const[g,y]=p,w=eh(h,r,g),T=eh(h,r,y);if(!w||!T)return;const A=this._aroundCenter?null:w.add(T).div(2);return this._move([w,T],A,t)}touchend(t,r,h){if(!this._firstTwoTouches)return;const[p,g]=this._firstTwoTouches,y=eh(h,r,p),w=eh(h,r,g);y&&w||(this._active&&zt(),this.reset())}touchcancel(){this.reset()}enable(t){this._enabled=!0,this._aroundCenter=!!t&&t.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function eh(u,t,r){for(let h=0;h<u.length;h++)if(u[h].identifier===r)return t[h]}function uy(u,t){return Math.log2(u/t)}class ex extends Xd{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(t){this._startDistance=this._distance=t[0].dist(t[1])}_move(t,r){const h=this._distance;if(this._distance=t[0].dist(t[1]),this._active||!(Math.abs(uy(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:uy(this._distance,h),pinchAround:r}}}function hy(u,t){return 180*u.angleWith(t)/Math.PI}class An extends Xd{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(t){this._startVector=this._vector=t[0].sub(t[1]),this._minDiameter=t[0].dist(t[1])}_move(t,r){const h=this._vector;if(this._vector=t[0].sub(t[1]),h&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:hy(this._vector,h),pinchAround:r}}_isBelowThreshold(t){this._minDiameter=Math.min(this._minDiameter,t.mag());const r=25/(Math.PI*this._minDiameter)*360,h=this._startVector;if(!h)return!1;const p=hy(t,h);return Math.abs(p)<r}}function Kd(u){return Math.abs(u.y)>Math.abs(u.x)}class tx extends Xd{constructor(t){super(),this._map=t}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(t){this._lastPoints=t,Kd(t[0].sub(t[1]))&&(this._valid=!1)}_move(t,r,h){const p=this._lastPoints;if(!p)return;const g=t[0].sub(p[0]),y=t[1].sub(p[1]);return this._map._cooperativeGestures&&!s.eU()&&h.touches.length<3||(this._valid=this.gestureBeginsVertically(g,y,h.timeStamp),!this._valid)?void 0:(this._lastPoints=t,this._active=!0,{pitchDelta:(g.y+y.y)/2*-.5})}gestureBeginsVertically(t,r,h){if(this._valid!==void 0)return this._valid;const p=t.mag()>=2,g=r.mag()>=2;if(!p&&!g)return;if(!p||!g)return this._firstMove==null&&(this._firstMove=h),h-this._firstMove<100&&void 0;const y=t.y>0==r.y>0;return Kd(t)&&Kd(r)&&y}}const ix={panStep:100,bearingStep:15,pitchStep:10};class nx{constructor(){const t=ix;this._panStep=t.panStep,this._bearingStep=t.bearingStep,this._pitchStep=t.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(t){if(t.altKey||t.ctrlKey||t.metaKey)return;let r=0,h=0,p=0,g=0,y=0;switch(t.keyCode){case 61:case 107:case 171:case 187:r=1;break;case 189:case 109:case 173:r=-1;break;case 37:t.shiftKey?h=-1:(t.preventDefault(),g=-1);break;case 39:t.shiftKey?h=1:(t.preventDefault(),g=1);break;case 38:t.shiftKey?p=1:(t.preventDefault(),y=-1);break;case 40:t.shiftKey?p=-1:(t.preventDefault(),y=1);break;default:return}return this._rotationDisabled&&(h=0,p=0),{cameraAnimation:w=>{const T=w.getZoom();w.easeTo({duration:300,easeId:"keyboardHandler",easing:th,zoom:r?Math.round(T)+r*(t.shiftKey?2:1):T,bearing:w.getBearing()+h*this._bearingStep,pitch:w.getPitch()+p*this._pitchStep,offset:[-g*this._panStep,-y*this._panStep],center:w.getCenter()},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function th(u){return u*(2-u)}const mm=4.000244140625,_m=1/450;class Yd{constructor(t,r){this._map=t,this._el=t.getCanvasContainer(),this._handler=r,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=_m,s.aY(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(t){this._defaultZoomRate=t}setWheelZoomRate(t){this._wheelZoomRate=t}isEnabled(){return!!this._enabled}isActive(){return this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(t){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!t&&t.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(t){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(t.ctrlKey||t.metaKey||this.isZooming()||s.eU()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let r=t.deltaMode===WheelEvent.DOM_DELTA_LINE?40*t.deltaY:t.deltaY;const h=s.o.now(),p=h-(this._lastWheelEventTime||0);this._lastWheelEventTime=h,r!==0&&r%mm==0?this._type="wheel":r!==0&&Math.abs(r)<4?this._type="trackpad":p>400?(this._type=null,this._lastValue=r,this._timeout=window.setTimeout(this._onTimeout,40,t)):this._type||(this._type=Math.abs(p*r)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,r+=this._lastValue)),t.shiftKey&&r&&(r/=4),this._type&&(this._lastWheelEvent=t,this._delta-=r,this._active||this._start(t)),t.preventDefault()}_onTimeout(t){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(t)}_start(t){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const r=Zt(this._el,t);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:r,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const t=this._map.transform;this._type==="wheel"&&t.projection.wrap&&(t._center.lng>=180||t._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const r=()=>t._terrainEnabled()&&this._aroundCoord?t.computeZoomRelativeTo(this._aroundCoord):t.zoom;if(this._delta!==0){const A=this._type==="wheel"&&Math.abs(this._delta)>mm?this._wheelZoomRate:this._defaultZoomRate;let M=2/(1+Math.exp(-Math.abs(this._delta*A)));this._delta<0&&M!==0&&(M=1/M);const z=r(),L=Math.pow(2,z),D=typeof this._targetZoom=="number"?t.zoomScale(this._targetZoom):L;this._targetZoom=Math.min(t.maxZoom,Math.max(t.minZoom,t.scaleZoom(D*M))),this._type==="wheel"&&(this._startZoom=z,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const h=typeof this._targetZoom=="number"?this._targetZoom:r(),p=this._startZoom,g=this._easing;let y,w=!1;if(this._type==="wheel"&&p&&g){const A=Math.min((s.o.now()-this._lastWheelEventTime)/200,1),M=g(A);y=s.ak(p,h,M),A<1?this._frameId||(this._frameId=!0):w=!0}else y=h,w=!0;this._active=!0,w&&(this._active=!1,this._finishTimeout=window.setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200));let T=y-r();return T*this._lastDelta<0&&(T=0),{noInertia:!0,needsRenderFrame:!w,zoomDelta:T,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(t){let r=s.eV;if(this._prevEase){const h=this._prevEase,p=(s.o.now()-h.start)/h.duration,g=h.easing(p+.01)-h.easing(p),y=.27/Math.sqrt(g*g+1e-4)*.01,w=Math.sqrt(.0729-y*y);r=s.eT(y,w,.25,1)}return this._prevEase={start:s.o.now(),duration:t,easing:r},r}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=We("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")},200)}}class ga{constructor(t,r){this._clickZoom=t,this._tapZoom=r}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class Jd{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(t,r){return t.preventDefault(),{cameraAnimation:h=>{h.easeTo({duration:300,zoom:h.getZoom()+(t.shiftKey?-1:1),around:h.unproject(r)},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class ar{constructor(){this._tap=new Wd({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(t,r,h){this._swipePoint||(this._tapTime&&t.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?h.length>0&&(this._swipePoint=r[0],this._swipeTouch=h[0].identifier):this._tap.touchstart(t,r,h))}touchmove(t,r,h){if(this._tapTime){if(this._swipePoint){if(h[0].identifier!==this._swipeTouch)return;const p=r[0],g=p.y-this._swipePoint.y;return this._swipePoint=p,t.preventDefault(),this._active=!0,{zoomDelta:g/128}}}else this._tap.touchmove(t,r,h)}touchend(t,r,h){this._tapTime?this._swipePoint&&h.length===0&&this.reset():this._tap.touchend(t,r,h)&&(this._tapTime=t.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class qs{constructor(t,r,h){this._el=t,this._mousePan=r,this._touchPan=h}enable(t){this._inertiaOptions=t||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class ih{constructor(t,r,h){this._pitchWithRotate=t.pitchWithRotate,this._mouseRotate=r,this._mousePitch=h}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class Qd{constructor(t,r,h,p){this._el=t,this._touchZoom=r,this._touchRotate=h,this._tapDragZoom=p,this._rotationDisabled=!1,this._enabled=!0}enable(t){this._touchZoom.enable(t),this._rotationDisabled||this._touchRotate.enable(t),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const nh=u=>u.zoom||u.drag||u.pitch||u.rotate;class rx extends s.z{}class rh{constructor(){this.constants=[1,1,.01],this.radius=0}setup(t,r){const h=s.av([],r,t);this.radius=s.ag(h[2]<0?s.eX([],h,this.constants):[h[0],h[1],0])}projectRay(t){s.eX(t,t,this.constants),s.aw(t,t),s.eY(t,t,this.constants);const r=s.c5([],t,this.radius);if(r[2]>0){const h=s.c5([],[0,0,1],s.bJ(r,[0,0,1])),p=s.c5([],s.aw([],[r[0],r[1],0]),this.radius),g=s.d8([],r,s.c5([],s.av([],s.d8([],p,h),r),2));r[0]=g[0],r[1]=g[1]}return r}}function ef(u){return u.panDelta&&u.panDelta.mag()||u.zoomDelta||u.bearingDelta||u.pitchDelta}class ox{constructor(t,r){this._map=t,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new cm(t),this._bearingSnap=r.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new rh,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(r),s.aY(["handleEvent","handleWindowEvent"],this);const h=this._el;this._listeners=[[h,"touchstart",{passive:!0}],[h,"touchmove",{passive:!1}],[h,"touchend",void 0],[h,"touchcancel",void 0],[h,"mousedown",void 0],[h,"mousemove",void 0],[h,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[h,"mouseover",void 0],[h,"mouseout",void 0],[h,"dblclick",void 0],[h,"click",void 0],[h,"keydown",{capture:!1}],[h,"keyup",void 0],[h,"wheel",{passive:!1}],[h,"contextmenu",void 0],[window,"blur",void 0]];for(const[p,g,y]of this._listeners){const w=p===document?this.handleWindowEvent:this.handleEvent;p.addEventListener(g,w,y)}}destroy(){for(const[t,r,h]of this._listeners){const p=t===document?this.handleWindowEvent:this.handleEvent;t.removeEventListener(r,p,h)}}_addDefaultHandlers(t){const r=this._map,h=r.getCanvasContainer();this._add("mapEvent",new Gd(r,t));const p=r.boxZoom=new Hd(r,t);this._add("boxZoom",p);const g=new sy,y=new Jd;r.doubleClickZoom=new ga(y,g),this._add("tapZoom",g),this._add("clickZoom",y);const w=new ar;this._add("tapDragZoom",w);const T=r.touchPitch=new tx(r);this._add("touchPitch",T);const A=new fm(t),M=new pm(t);r.dragRotate=new ih(t,A,M),this._add("mouseRotate",A,["mousePitch"]),this._add("mousePitch",M,["mouseRotate"]);const z=new ly(t),L=new cy(r,t);r.dragPan=new qs(h,z,L),this._add("mousePan",z),this._add("touchPan",L,["touchZoom","touchRotate"]);const D=new An,N=new ex;r.touchZoomRotate=new Qd(h,N,D,w),this._add("touchRotate",D,["touchPan","touchZoom"]),this._add("touchZoom",N,["touchPan","touchRotate"]),this._add("blockableMapEvent",new hm(r));const B=r.scrollZoom=new Yd(r,this);this._add("scrollZoom",B,["mousePan"]);const G=r.keyboard=new nx;this._add("keyboard",G);for(const $ of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])t.interactive&&t[$]&&r[$].enable(t[$])}_add(t,r,h){this._handlers.push({handlerName:t,handler:r,allowed:h}),this._handlersById[t]=r}stop(t){if(!this._updatingCamera){for(const{handler:r}of this._handlers)r.reset();this._inertia.clear(),this._fireEvents({},{},t),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:t}of this._handlers)if(t.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!nh(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(t,r,h){for(const p in t)if(p!==h&&(!r||r.indexOf(p)<0))return!0;return!1}handleWindowEvent(t){this.handleEvent(t,`${t.type}Window`)}_getMapTouches(t){const r=[];for(const h of t)this._el.contains(h.target)&&r.push(h);return r}handleEvent(t,r){this._updatingCamera=!0;const h=t.type==="renderFrame",p=h?void 0:t,g={needsRenderFrame:!1},y={},w={},T=t.touches?this._getMapTouches(t.touches):void 0,A=T?mn(this._el,T):h?void 0:Zt(this._el,t);for(const{handlerName:L,handler:D,allowed:N}of this._handlers){if(!D.isEnabled())continue;let B;this._blockedByActive(w,N,L)?D.reset():D[r||t.type]&&(B=D[r||t.type](t,A,T),this.mergeHandlerResult(g,y,B,L,p),B&&B.needsRenderFrame&&this._triggerRenderFrame()),(B||D.isActive())&&(w[L]=D)}const M={};for(const L in this._previousActiveHandlers)w[L]||(M[L]=p);this._previousActiveHandlers=w,(Object.keys(M).length||ef(g))&&(this._changes.push([g,y,M]),this._triggerRenderFrame()),(Object.keys(w).length||ef(g))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:z}=g;z&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],z(this._map))}mergeHandlerResult(t,r,h,p,g){if(!h)return;Object.assign(t,h);const y={handlerName:p,originalEvent:h.originalEvent||g};h.zoomDelta!==void 0&&(r.zoom=y),h.panDelta!==void 0&&(r.drag=y),h.pitchDelta!==void 0&&(r.pitch=y),h.bearingDelta!==void 0&&(r.rotate=y)}_applyChanges(){const t={},r={},h={};for(const[p,g,y]of this._changes)p.panDelta&&(t.panDelta=(t.panDelta||new s.P(0,0))._add(p.panDelta)),p.zoomDelta&&(t.zoomDelta=(t.zoomDelta||0)+p.zoomDelta),p.bearingDelta&&(t.bearingDelta=(t.bearingDelta||0)+p.bearingDelta),p.pitchDelta&&(t.pitchDelta=(t.pitchDelta||0)+p.pitchDelta),p.around!==void 0&&(t.around=p.around),p.aroundCoord!==void 0&&(t.aroundCoord=p.aroundCoord),p.pinchAround!==void 0&&(t.pinchAround=p.pinchAround),p.noInertia&&(t.noInertia=p.noInertia),Object.assign(r,g),Object.assign(h,y);this._updateMapTransform(t,r,h),this._changes=[]}_updateMapTransform(t,r,h){const p=this._map,g=p.transform,y=X=>[X.x,X.y,X.z];if((X=>{const J=this._eventsInProgress.drag;return J&&!this._handlersById[J.handlerName].isActive()})()&&!ef(t)){const X=g.zoom;g.cameraElevationReference="sea",this._originalZoom!=null&&g._orthographicProjectionAtLowPitch&&g.projection.name!=="globe"&&g.pitch===0?(g.cameraElevationReference="ground",g.zoom=this._originalZoom):(g.recenterOnTerrain(),g.cameraElevationReference="ground"),X!==g.zoom&&this._map._update(!0)}if(g._isCameraConstrained&&p._stop(!0),!ef(t))return void this._fireEvents(r,h,!0);let{panDelta:w,zoomDelta:T,bearingDelta:A,pitchDelta:M,around:z,aroundCoord:L,pinchAround:D}=t;g._isCameraConstrained&&(T>0&&(T=0),g._isCameraConstrained=!1),D!==void 0&&(z=D),(T||(X=>r[X]&&!this._eventsInProgress[X])("drag"))&&z&&(this._dragOrigin=y(g.pointCoordinate3D(z)),this._originalZoom=g.zoom,this._trackingEllipsoid.setup(g._camera.position,this._dragOrigin)),g.cameraElevationReference="sea",p._stop(!0),z=z||p.transform.centerPoint,A&&(g.bearing+=A),M&&(g.pitch+=M),g._updateCameraState();const N=[0,0,0];if(w)if(g.projection.name==="mercator"){const X=this._trackingEllipsoid.projectRay(g.screenPointToMercatorRay(z).dir),J=this._trackingEllipsoid.projectRay(g.screenPointToMercatorRay(z.sub(w)).dir);N[0]=J[0]-X[0],N[1]=J[1]-X[1]}else{const X=g.pointCoordinate(z);if(g.projection.name==="globe"){w=w.rotate(-g.angle);const J=g._pixelsPerMercatorPixel/g.worldSize;N[0]=-w.x*s.eW(s.a$(X.y))*J,N[1]=-w.y*s.eW(g.center.lat)*J}else{const J=g.pointCoordinate(z.sub(w));X&&J&&(N[0]=J.x-X.x,N[1]=J.y-X.y)}}const B=g.zoom,G=[0,0,0];if(T){const X=y(L||g.pointCoordinate3D(z)),J={dir:s.aw([],s.av([],X,g._camera.position))};if(J.dir[2]<0){const K=g.zoomDeltaToMovement(X,T);s.c5(G,J.dir,K)}}const $=s.d8(N,N,G);g._translateCameraConstrained($),T&&Math.abs(g.zoom-B)>1e-4&&g.recenterOnTerrain(),g.cameraElevationReference="ground",this._map._update(),t.noInertia||this._inertia.record(t),this._fireEvents(r,h,!0)}_fireEvents(t,r,h){const p=nh(this._eventsInProgress),g=nh(t),y={};for(const M in t){const{originalEvent:z}=t[M];this._eventsInProgress[M]||(y[`${M}start`]=z),this._eventsInProgress[M]=t[M]}!p&&g&&this._fireEvent("movestart",g.originalEvent);for(const M in y)this._fireEvent(M,y[M]);g&&this._fireEvent("move",g.originalEvent);for(const M in t){const{originalEvent:z}=t[M];this._fireEvent(M,z)}const w={};let T;for(const M in this._eventsInProgress){const{handlerName:z,originalEvent:L}=this._eventsInProgress[M];this._handlersById[z].isActive()||(delete this._eventsInProgress[M],T=r[z]||L,w[`${M}end`]=T)}for(const M in w)this._fireEvent(M,w[M]);const A=nh(this._eventsInProgress);if(h&&(p||g)&&!A){this._updatingCamera=!0;const M=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),z=L=>L!==0&&-this._bearingSnap<L&&L<this._bearingSnap;M?(z(M.bearing||this._map.getBearing())&&(M.bearing=0),this._map.easeTo(M,{originalEvent:T})):(this._map.fire(new s.z("moveend",{originalEvent:T})),z(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(t,r){this._map.fire(new s.z(t,r?{originalEvent:r}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(t=>{this._frameId=void 0,this.handleEvent(new rx("renderFrame",{timeStamp:t})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}const tf="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class gm extends s.E{constructor(t,r){super(),this._moving=!1,this._zooming=!1,this.transform=t,this._bearingSnap=r.bearingSnap,this._respectPrefersReducedMotion=r.respectPrefersReducedMotion!==!1,s.aY(["_renderFrameCallback"],this)}getCenter(){return new s.aT(this.transform.center.lng,this.transform.center.lat)}setCenter(t,r){return this.jumpTo({center:t},r)}panBy(t,r,h){return t=s.P.convert(t).mult(-1),this.panTo(this.transform.center,Object.assign({offset:t},r),h)}panTo(t,r,h){return this.easeTo(Object.assign({center:t},r),h)}getZoom(){return this.transform.zoom}setZoom(t,r){return this.jumpTo({zoom:t},r),this}zoomTo(t,r,h){return this.easeTo(Object.assign({zoom:t},r),h)}zoomIn(t,r){return this.zoomTo(this.getZoom()+1,t,r),this}zoomOut(t,r){return this.zoomTo(this.getZoom()-1,t,r),this}getBearing(){return this.transform.bearing}setBearing(t,r){return this.jumpTo({bearing:t},r),this}getPadding(){return this.transform.padding}setPadding(t,r){return this.jumpTo({padding:t},r),this}rotateTo(t,r,h){return this.easeTo(Object.assign({bearing:t},r),h)}resetNorth(t,r){return this.rotateTo(0,Object.assign({duration:1e3},t),r),this}resetNorthPitch(t,r){return this.easeTo(Object.assign({bearing:0,pitch:0,duration:1e3},t),r),this}snapToNorth(t,r){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(t,r):this}getPitch(){return this.transform.pitch}setPitch(t,r){return this.jumpTo({pitch:t},r),this}cameraForBounds(t,r){t=s.aI.convert(t);const h=r&&r.bearing||0,p=r&&r.pitch||0,g=t.getNorthWest(),y=t.getSouthEast();return this._cameraForBounds(this.transform,g,y,h,p,r)}_extendPadding(t){const r={top:0,right:0,bottom:0,left:0};return t==null?Object.assign({},r,this.transform.padding):typeof t=="number"?{top:t,bottom:t,right:t,left:t}:Object.assign({},r,t)}_extendCameraOptions(t){return(t=Object.assign({offset:[0,0],maxZoom:this.transform.maxZoom},t)).padding=this._extendPadding(t.padding),t}_minimumAABBFrustumDistance(t,r){const h=r.max[0]-r.min[0],p=r.max[1]-r.min[1];return h/p>t.aspect?h/(2*Math.tan(.5*t.fovX)*t.aspect):p/(2*Math.tan(.5*t.fovY)*t.aspect)}_cameraForBoundsOnGlobe(t,r,h,p,g,y){const w=t.clone(),T=this._extendCameraOptions(y);w.bearing=p,w.pitch=g;const A=s.aT.convert(r),M=s.aT.convert(h),z=.5*(A.lat+M.lat),L=.5*(A.lng+M.lng),D=s.eZ(z,L),N=s.aw([],D),B=s.aw([],s.bI([],N,[0,1,0])),G=s.bI([],B,N),$=[B[0],B[1],B[2],0,G[0],G[1],G[2],0,N[0],N[1],N[2],0,0,0,0,1],X=[D,s.eZ(A.lat,A.lng),s.eZ(M.lat,A.lng),s.eZ(M.lat,M.lng),s.eZ(A.lat,M.lng),s.eZ(z,A.lng),s.eZ(z,M.lng),s.eZ(A.lat,L),s.eZ(M.lat,L)];let J=s.d9.fromPoints(X.map(Re=>[s.bJ(B,Re),s.bJ(G,Re),s.bJ(N,Re)]));const K=s.af([],J.center,$);s.e_(K)===0&&s.e$(K,0,0,1),s.aw(K,K),s.c5(K,K,s.aD),w.center=s.f0(K);const ue=w.getWorldToCameraMatrix(),oe=s.bl(new Float64Array(16),ue);J=s.d9.applyTransform(J,s.aB([],ue,$));const le=this._extendAABB(J,w,T,p);if(!le)return void s.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");J=le,s.af(K,K,ue);const re=.5*(J.max[2]-J.min[2]),te=this._minimumAABBFrustumDistance(w,J),he=s.c5([],[0,0,1],re),we=s.d8(he,K,he),ye=te+(w.pitch===0?0:s.bG(K,we)),ze=w.globeCenterInViewSpace,Oe=s.av([],K,[ze[0],ze[1],ze[2]]);s.aw(Oe,Oe),s.c5(Oe,Oe,ye);const $e=s.d8([],K,Oe);s.af($e,$e,oe);const ot=s.eM/s.aD,Ae=s.ag($e),_e=s.cf(Math.max(Ae*ot-s.eM,Number.EPSILON),0),Ne=Math.min(w.zoomFromMercatorZAdjusted(_e),T.maxZoom);return Ne>.5*(s.c_+s.cL)?(w.setProjection({name:"mercator"}),w.zoom=Ne,this._cameraForBounds(w,r,h,p,g,y)):{center:w.center,zoom:Ne,bearing:p,pitch:g}}_extendAABB(t,r,h,p){const g=.5*((h.padding.left||0)+(h.padding.right||0)),y=.5*((h.padding.top||0)+(h.padding.bottom||0)),w=y,T=g,A=g,M=y,z=r.width-(T+A),L=r.height-(w+M),D=s.av([],t.max,t.min),N=Math.min(z/D[0],L/D[1]),B=Math.min(r.scaleZoom(r.scale*N),h.maxZoom);if(isNaN(B))return null;const G=r.scale/r.zoomScale(B),$=new s.d9([t.min[0]-T*G,t.min[1]-M*G,t.min[2]],[t.max[0]+A*G,t.max[1]+w*G,t.max[2]]),X=(typeof h.offset.x=="number"&&typeof h.offset.y=="number"?new s.P(h.offset.x,h.offset.y):s.P.convert(h.offset)).rotate(-s.an(p));return $.center[0]-=X.x*G,$.center[1]+=X.y*G,$}queryTerrainElevation(t,r){const h=this.transform.elevation;return h?(r=Object.assign({},{exaggerated:!0},r),h.getAtPoint(s.ae.fromLngLat(t),null,r.exaggerated)):null}_cameraForBounds(t,r,h,p,g,y){if(t.projection.name==="globe")return this._cameraForBoundsOnGlobe(t,r,h,p,g,y);const w=t.clone(),T=this._extendCameraOptions(y);w.bearing=p,w.pitch=g;const A=s.aT.convert(r),M=s.aT.convert(h),z=new s.aT(A.lng,M.lat),L=new s.aT(M.lng,A.lat),D=w.project(A),N=w.project(M),B=this.queryTerrainElevation(A),G=this.queryTerrainElevation(M),$=this.queryTerrainElevation(z),X=this.queryTerrainElevation(L),J=[[D.x,D.y,Math.min(B||0,G||0,$||0,X||0)],[N.x,N.y,Math.max(B||0,G||0,$||0,X||0)]];let K=s.d9.fromPoints(J);const ue=w.getWorldToCameraMatrix(),oe=s.bl(new Float64Array(16),ue);K=s.d9.applyTransform(K,ue);const le=this._extendAABB(K,w,T,p);if(!le)return void s.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");K=le;const re=.5*s.av([],K.max,K.min)[2],te=this._minimumAABBFrustumDistance(w,K),he=[0,0,1,0];s.aC(he,he,ue),s.f1(he,he);const we=s.c5([],he,te+re),ye=s.d8([],K.center,we);s.af(K.center,K.center,oe),s.af(ye,ye,oe);const ze=w.unproject(new s.P(K.center[0],K.center[1])),Oe=s.f2(w.projection,ze),$e=Math.pow(2,Oe),ot=Math.min(w._zoomFromMercatorZ(ye[2]*w.pixelsPerMeter*$e/w.worldSize),T.maxZoom);return w.mercatorFromTransition&&ot<.5*(s.c_+s.cL)?(w.setProjection({name:"globe"}),w.zoom=ot,this._cameraForBounds(w,r,h,p,g,y)):{center:ze,zoom:ot,bearing:p,pitch:g}}fitBounds(t,r,h){const p=this.cameraForBounds(t,r);return this._fitInternal(p,r,h)}fitScreenCoordinates(t,r,h,p,g){const y=s.P.convert(t),w=s.P.convert(r),T=new s.P(Math.min(y.x,w.x),Math.min(y.y,w.y)),A=new s.P(Math.max(y.x,w.x),Math.max(y.y,w.y));if(this.transform.projection.name==="mercator"&&this.transform.anyCornerOffEdge(y,w))return this;const M=this.transform.pointLocation3D(T),z=this.transform.pointLocation3D(A),L=this.transform.pointLocation3D(new s.P(T.x,A.y)),D=this.transform.pointLocation3D(new s.P(A.x,T.y)),N=[Math.min(M.lng,z.lng,L.lng,D.lng),Math.min(M.lat,z.lat,L.lat,D.lat)],B=[Math.max(M.lng,z.lng,L.lng,D.lng),Math.max(M.lat,z.lat,L.lat,D.lat)],G=p&&p.pitch?p.pitch:this.getPitch(),$=this._cameraForBounds(this.transform,N,B,h,G,p);return this._fitInternal($,p,g)}_fitInternal(t,r,h){return t?(r=Object.assign(t,r)).linear?this.easeTo(r,h):this.flyTo(r,h):this}jumpTo(t,r){this.stop();const h=t.preloadOnly?this.transform.clone():this.transform;let p=!1,g=!1,y=!1;"zoom"in t&&h.zoom!==+t.zoom&&(p=!0,h.zoom=+t.zoom),t.center!==void 0&&(h.center=s.aT.convert(t.center)),"bearing"in t&&h.bearing!==+t.bearing&&(g=!0,h.bearing=+t.bearing),"pitch"in t&&h.pitch!==+t.pitch&&(y=!0,h.pitch=+t.pitch);const w=typeof t.padding=="number"?this._extendPadding(t.padding):t.padding;if(t.padding!=null&&!h.isPaddingEqual(w))if(t.retainPadding===!1){const T=h.clone();T.padding=w,h.setLocationAtPoint(h.center,T.centerPoint)}else h.padding=w;return t.preloadOnly?(this._preloadTiles(h),this):(this.fire(new s.z("movestart",r)).fire(new s.z("move",r)),p&&this.fire(new s.z("zoomstart",r)).fire(new s.z("zoom",r)).fire(new s.z("zoomend",r)),g&&this.fire(new s.z("rotatestart",r)).fire(new s.z("rotate",r)).fire(new s.z("rotateend",r)),y&&this.fire(new s.z("pitchstart",r)).fire(new s.z("pitch",r)).fire(new s.z("pitchend",r)),this.fire(new s.z("moveend",r)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||s.w(tf),this.transform.getFreeCameraOptions()}setFreeCameraOptions(t,r){const h=this.transform;if(!h.projection.supportsFreeCamera)return s.w(tf),this;this.stop();const p=h.zoom,g=h.pitch,y=h.bearing;h.setFreeCameraOptions(t);const w=p!==h.zoom,T=g!==h.pitch,A=y!==h.bearing;return this.fire(new s.z("movestart",r)).fire(new s.z("move",r)),w&&this.fire(new s.z("zoomstart",r)).fire(new s.z("zoom",r)).fire(new s.z("zoomend",r)),A&&this.fire(new s.z("rotatestart",r)).fire(new s.z("rotate",r)).fire(new s.z("rotateend",r)),T&&this.fire(new s.z("pitchstart",r)).fire(new s.z("pitch",r)).fire(new s.z("pitchend",r)),this.fire(new s.z("moveend",r)),this}easeTo(t,r){this._stop(!1,t.easeId),((t=Object.assign({offset:[0,0],duration:500,easing:s.eV},t)).animate===!1||this._prefersReducedMotion(t))&&(t.duration=0);const h=this.transform,p=this.getZoom(),g=this.getBearing(),y=this.getPitch(),w=this.getPadding(),T="zoom"in t?+t.zoom:p,A="bearing"in t?this._normalizeBearing(t.bearing,g):g,M="pitch"in t?+t.pitch:y,z=this._extendPadding(t.padding),L=s.P.convert(t.offset);let D,N,B;if(h.projection.name==="globe"){const he=s.ae.fromLngLat(h.center),we=L.rotate(-h.angle);he.x+=we.x/h.worldSize,he.y+=we.y/h.worldSize;const ye=he.toLngLat(),ze=s.aT.convert(t.center||ye);this._normalizeCenter(ze),D=h.centerPoint.add(we),N=new s.P(he.x,he.y).mult(h.worldSize),B=new s.P(s.aF(ze.lng),s.aJ(ze.lat)).mult(h.worldSize).sub(N)}else{D=h.centerPoint.add(L);const he=h.pointLocation(D),we=s.aT.convert(t.center||he);this._normalizeCenter(we),N=h.project(he),B=h.project(we).sub(N)}const G=h.zoomScale(T-p);let $,X;t.around&&($=s.aT.convert(t.around),X=h.locationPoint($));const J=this._zooming||T!==p,K=this._rotating||g!==A,ue=this._pitching||M!==y,oe=!h.isPaddingEqual(z),le=t.retainPadding===!1?h.clone():h,re=he=>we=>{if(J&&(he.zoom=s.ak(p,T,we)),K&&(he.bearing=s.ak(g,A,we)),ue&&(he.pitch=s.ak(y,M,we)),oe&&(le.interpolatePadding(w,z,we),D=le.centerPoint.add(L)),$)he.setLocationAtPoint($,X);else{const ye=he.zoomScale(he.zoom-p),ze=T>p?Math.min(2,G):Math.max(.5,G),Oe=Math.pow(ze,1-we),$e=he.unproject(N.add(B.mult(we*Oe)).mult(ye));he.setLocationAtPoint(he.renderWorldCopies?$e.wrap():$e,D)}return t.preloadOnly||this._fireMoveEvents(r),he};if(t.preloadOnly){const he=this._emulate(re,t.duration,h);return this._preloadTiles(he),this}const te={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=J,this._rotating=K,this._pitching=ue,this._padding=oe,this._easeId=t.easeId,this._prepareEase(r,t.noMoveStart,te),this._ease(re(h),he=>{h.cameraElevationReference==="sea"&&h.recenterOnTerrain(),this._afterEase(r,he)},t),this}_prepareEase(t,r,h={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&this.transform.pitch===0&&this.transform.projection.name!=="globe"&&(this.transform.cameraElevationReference="ground"),r||h.moving||this.fire(new s.z("movestart",t)),this._zooming&&!h.zooming&&this.fire(new s.z("zoomstart",t)),this._rotating&&!h.rotating&&this.fire(new s.z("rotatestart",t)),this._pitching&&!h.pitching&&this.fire(new s.z("pitchstart",t))}_fireMoveEvents(t){this.fire(new s.z("move",t)),this._zooming&&this.fire(new s.z("zoom",t)),this._rotating&&this.fire(new s.z("rotate",t)),this._pitching&&this.fire(new s.z("pitch",t))}_afterEase(t,r){if(this._easeId&&r&&this._easeId===r)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const h=this._zooming,p=this._rotating,g=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,h&&this.fire(new s.z("zoomend",t)),p&&this.fire(new s.z("rotateend",t)),g&&this.fire(new s.z("pitchend",t)),this.fire(new s.z("moveend",t))}flyTo(t,r){if(this._prefersReducedMotion(t)){const Re=s.aH(t,["center","zoom","bearing","pitch","around","padding","retainPadding"]);return this.jumpTo(Re,r)}this.stop(),t=Object.assign({offset:[0,0],speed:1.2,curve:1.42,easing:s.eV},t);const h=this.transform,p=this.getZoom(),g=this.getBearing(),y=this.getPitch(),w=this.getPadding(),T="zoom"in t?s.aA(+t.zoom,h.minZoom,h.maxZoom):p,A="bearing"in t?this._normalizeBearing(t.bearing,g):g,M="pitch"in t?+t.pitch:y,z=this._extendPadding(t.padding),L=h.zoomScale(T-p),D=s.P.convert(t.offset);let N=h.centerPoint.add(D);const B=h.pointLocation(N),G=s.aT.convert(t.center||B);this._normalizeCenter(G);const $=h.project(B),X=h.project(G).sub($);let J=t.curve;const K=Math.max(h.width,h.height),ue=K/L,oe=X.mag();if("minZoom"in t){const Re=s.aA(Math.min(t.minZoom,p,T),h.minZoom,h.maxZoom),Ke=K/h.zoomScale(Re-p);J=Math.sqrt(Ke/oe*2)}const le=J*J;function re(Re){const Ke=(ue*ue-K*K+(Re?-1:1)*le*le*oe*oe)/(2*(Re?ue:K)*le*oe);return Math.log(Math.sqrt(Ke*Ke+1)-Ke)}function te(Re){return(Math.exp(Re)-Math.exp(-Re))/2}function he(Re){return(Math.exp(Re)+Math.exp(-Re))/2}const we=re(0);let ye=function(Re){return he(we)/he(we+J*Re)},ze=function(Re){return K*((he(we)*(te(Ke=we+J*Re)/he(Ke))-te(we))/le)/oe;var Ke},Oe=(re(1)-we)/J;if(Math.abs(oe)<1e-6||!isFinite(Oe)){if(Math.abs(K-ue)<1e-6)return this.easeTo(t,r);const Re=ue<K?-1:1;Oe=Math.abs(Math.log(ue/K))/J,ze=function(){return 0},ye=function(Ke){return Math.exp(Re*J*Ke)}}t.duration="duration"in t?+t.duration:1e3*Oe/("screenSpeed"in t?+t.screenSpeed/J:+t.speed),t.maxDuration&&t.duration>t.maxDuration&&(t.duration=0);const $e=g!==A,ot=M!==y,Ae=!h.isPaddingEqual(z),_e=t.retainPadding===!1?h.clone():h,Ne=Re=>Ke=>{const pt=Ke*Oe,wt=1/ye(pt);Re.zoom=Ke===1?T:p+Re.scaleZoom(wt),$e&&(Re.bearing=s.ak(g,A,Ke)),ot&&(Re.pitch=s.ak(y,M,Ke)),Ae&&(_e.interpolatePadding(w,z,Ke),N=_e.centerPoint.add(D));const ht=Ke===1?G:Re.unproject($.add(X.mult(ze(pt))).mult(wt));return Re.setLocationAtPoint(Re.renderWorldCopies?ht.wrap():ht,N),Re._updateCameraOnTerrain(),t.preloadOnly||this._fireMoveEvents(r),Re};if(t.preloadOnly){const Re=this._emulate(Ne,t.duration,h);return this._preloadTiles(Re),this}return this._zooming=!0,this._rotating=$e,this._pitching=ot,this._padding=Ae,this._prepareEase(r,!1),this._ease(Ne(h),()=>this._afterEase(r),t),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(t){}_cancelRenderFrame(t){}_stop(t,r){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const h=this._onEaseEnd;this._onEaseEnd=void 0,h.call(this,r)}if(!t){const h=this.handlers;h&&h.stop(!1)}return this}_ease(t,r,h){h.animate===!1||h.duration===0?(t(1),r()):(this._easeStart=s.o.now(),this._easeOptions=h,this._onEaseFrame=t,this._onEaseEnd=r,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const t=Math.min((s.o.now()-this._easeStart)/this._easeOptions.duration,1),r=this._onEaseFrame;r&&r(this._easeOptions.easing(t)),t<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(t,r){t=s.bT(t,-180,180);const h=Math.abs(t-r);return Math.abs(t-360-r)<h&&(t-=360),Math.abs(t+360-r)<h&&(t+=360),t}_normalizeCenter(t){const r=this.transform;if(r.maxBounds||r.projection.name!=="globe"&&!r.renderWorldCopies)return;const h=t.lng-r.center.lng;t.lng+=h>180?-360:h<-180?360:0}_prefersReducedMotion(t){return this._respectPrefersReducedMotion&&s.o.prefersReducedMotion&&!(t&&t.essential)}_emulate(t,r,h){const p=Math.ceil(15*r/1e3),g=[],y=t(h.clone());for(let w=0;w<=p;w++){const T=y(w/p);g.push(T.clone())}return g}_preloadTiles(t,r){}}class oh{constructor(t={}){this.options=t,s.aY(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(t){const r=this.options&&this.options.compact,h=t._getUIString("AttributionControl.ToggleAttribution");this._map=t,this._container=We("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=We("button","mapboxgl-ctrl-attrib-button",this._container),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._compactButton.setAttribute("aria-label",h);const p=We("span","mapboxgl-ctrl-icon",this._compactButton);return p.setAttribute("aria-hidden","true"),p.setAttribute("title",h),this._innerContainer=We("div","mapboxgl-ctrl-attrib-inner",this._container),r&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),r===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let t=this._editLink;t||(t=this._editLink=this._container.querySelector(".mapbox-improve-map"));const r=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||s.e.ACCESS_TOKEN}];if(t){const h=r.reduce((p,g,y)=>(g.value&&(p+=`${g.key}=${g.value}${y<r.length-1?"&":""}`),p),"?");t.href=`${s.e.FEEDBACK_URL}/${h}#${sr(this._map,!0)}`,t.rel="noopener nofollow"}}_updateData(t){!t||(t.dataType!=="source"||t.sourceDataType!=="metadata"&&t.sourceDataType!=="visibility")&&t.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let t=[];if(this._map.style.stylesheet){const p=this._map.style.stylesheet;this.styleOwner=p.owner,this.styleId=p.id}const r=this._map.style._mergedSourceCaches;for(const p in r){const g=r[p];if(g.used){const y=g.getSource();y.attribution&&t.indexOf(y.attribution)<0&&t.push(y.attribution)}}t.sort((p,g)=>p.length-g.length),t=t.filter((p,g)=>{for(let y=g+1;y<t.length;y++)if(t[y].indexOf(p)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?t=[...this.options.customAttribution,...t]:t.unshift(this.options.customAttribution));const h=t.map(p=>function(g){const y=new DOMParser().parseFromString(g,"text/html");return Array.from(y.body.querySelectorAll("*")).forEach(w=>{const T=w.textContent||"";if(w.tagName!=="A")return void w.replaceWith(y.createTextNode(T));const A=w.getAttribute("href");if(!A||!/^(https?:|mailto:)/i.test(A))return void w.replaceWith(y.createTextNode(T));const M=y.createElement("a");M.href=A,M.textContent=T,M.rel="noopener nofollow";const z=w.getAttribute("class");z&&(M.className=z),w.replaceWith(M)}),y.body.innerHTML}(p)).join(" | ");h!==this._attribHTML&&(this._attribHTML=h,t.length?(this._innerContainer.innerHTML=h,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class sh{constructor(){s.aY(["_updateLogo","_updateCompact"],this)}onAdd(t){this._map=t,this._container=We("div","mapboxgl-ctrl");const r=We("a","mapboxgl-ctrl-logo");return r.target="_blank",r.rel="noopener nofollow",r.href="https://www.mapbox.com/",r.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),r.setAttribute("rel","noopener nofollow"),this._container.appendChild(r),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(t){t&&t.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const t=this._map.style._sourceCaches;if(Object.entries(t).length===0)return!0;for(const r in t){const h=t[r].getSource();if(h.hasOwnProperty("mapbox_logo")&&!h.mapbox_logo)return!1}return!0}_updateCompact(){const t=this._container.children;if(t.length){const r=t[0];this._map.getCanvasContainer().offsetWidth<250?r.classList.add("mapboxgl-compact"):r.classList.remove("mapboxgl-compact")}}}class Nc{constructor(){s.aY(["_onIndoorUpdate"],this)}onAdd(t){return this._map=t,this._container=We("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._map.indoor.on("selector-update",r=>this._onIndoorUpdate(r)),this._container}_createButton(t,r){const h=We("button",t,this._container);return h.type="button",h.addEventListener("click",r),h}_createSeparator(){return We("div","mapboxgl-ctrl-separator",this._container)}_setButtonTitle(t,r){this._map&&(t.setAttribute("aria-label",r),t.textContent=r)}onRemove(){this._container&&this._container.remove(),this._map&&this._map.indoor&&(this._map.indoor.off("selector-update",this._onIndoorUpdate),this._map=null)}getDefaultPosition(){return"right"}_onIndoorUpdate(t){if(!t||!t.floors)return this._model=t,void(this._container.style.display="none");const r=this._model;this._model=t,this._container.style.display="inline-block",this._container.style.borderRadius="8px",r&&Array.from(this._container.children).forEach(h=>h.remove()),t.floors.length>0&&(this.addBuildingsToggleButton(),this.addCurrentFloors(t.floors,t.activeFloorsVisible),this._updateBuildingsButtonState())}addBuildingsToggleButton(){const t=this._createButton("mapboxgl-ctrl-buildings-toggle",()=>{const r=this._map;this._model&&r&&r._setIndoorActiveFloorsVisibility(!this._model.activeFloorsVisible)});We("span","mapboxgl-ctrl-icon",t).setAttribute("aria-hidden","true"),t.classList.add("mapboxgl-ctrl-level-button","mapboxgl-ctrl-buildings-toggle"),this._model&&!this._model.activeFloorsVisible&&t.classList.add("mapboxgl-ctrl-level-button-selected"),this._container.append(t),this._createSeparator()}_updateBuildingsButtonState(){const t=this._container.querySelector(".mapboxgl-ctrl-buildings-toggle");t&&this._model&&(this._model.activeFloorsVisible?t.classList.remove("mapboxgl-ctrl-level-button-selected"):t.classList.add("mapboxgl-ctrl-level-button-selected"))}addCurrentFloors(t,r){for(let h=0;h<t.length;h++){const p=t[h],g=this._createButton("mapboxgl-ctrl-level-button",()=>{this._map._selectIndoorFloor(p.id)});this._setButtonTitle(g,p.zIndex.toString()),this._model&&p.id===this._model.selectedFloorId&&r&&g.classList.add("mapboxgl-ctrl-level-button-selected"),this._container.append(g),h<t.length-1&&this._createSeparator()}}}class ya{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(t){const r=++this._id;return this._queue.push({callback:t,id:r,cancelled:!1}),r}remove(t){const r=this._currentlyRunning,h=r?this._queue.concat(r):this._queue;for(const p of h)if(p.id===t)return void(p.cancelled=!0)}run(t=0){const r=this._currentlyRunning=this._queue;this._queue=[];for(const h of r)if(!h.cancelled&&(h.callback(t),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}class va{constructor(t){this.jumpTo(t)}getValue(t){if(t<=this._startTime)return this._start;if(t>=this._endTime)return this._end;const r=s.dD((t-this._startTime)/(this._endTime-this._startTime));return this._start*(1-r)+this._end*r}isEasing(t){return t>=this._startTime&&t<=this._endTime}jumpTo(t){this._startTime=-1/0,this._endTime=-1/0,this._start=t,this._end=t}easeTo(t,r,h){this._start=this.getValue(r),this._end=t,this._startTime=r,this._endTime=r+h}}const xa={"AttributionControl.ToggleAttribution":"Toggle attribution","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox homepage","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use  + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};class ul extends s.z{constructor(t,r,h,p){const{point:g,lngLat:y,originalEvent:w,target:T}=t;super(t.type,{point:g,lngLat:y,originalEvent:w,target:T}),this.preventDefault=()=>{t.preventDefault()},this.id=r,this.interaction=h,this.feature=p}}class ws{constructor(t){this.map=t,this.interactionsByType=new Map,this.delegatedInteractions=new Map,this.typeById=new Map,this.filters=new Map,this.handleType=this.handleType.bind(this),this.handleMove=this.handleMove.bind(this),this.handleOut=this.handleOut.bind(this),this.hoveredFeatures=new Map,this.prevHoveredFeatures=new Map}add(t,r){if(this.typeById.has(t))throw new Error(`Interaction id "${t}" already exists.`);const h=r.filter;let p=r.type;h&&this.filters.set(t,s.b6(h)),p==="mouseover"&&(p="mouseenter"),p==="mouseout"&&(p="mouseleave");const g=this.interactionsByType.get(p)||new Map;p==="mouseenter"||p==="mouseleave"?(this.delegatedInteractions.size===0&&(this.map.on("mousemove",this.handleMove),this.map.on("mouseout",this.handleOut)),this.delegatedInteractions.set(t,r)):g.size===0&&this.map.on(p,this.handleType),g.size===0&&this.interactionsByType.set(p,g),g.set(t,r),this.typeById.set(t,p)}get(t){const r=this.typeById.get(t);if(!r)return;const h=this.interactionsByType.get(r);return h?h.get(t):void 0}remove(t){const r=this.typeById.get(t);if(!r)return;this.typeById.delete(t),this.filters.delete(t);const h=this.interactionsByType.get(r);h&&(h.delete(t),r==="mouseenter"||r==="mouseleave"?(this.delegatedInteractions.delete(t),this.delegatedInteractions.size===0&&(this.map.off("mousemove",this.handleMove),this.map.off("mouseout",this.handleOut))):h.size===0&&this.map.off(r,this.handleType))}queryTargets(t,r){const h=[];for(const[p,g]of r)g.target&&h.push({targetId:p,target:g.target,filter:this.filters.get(p)});return this.map.style.queryRenderedTargets(t,h,this.map.transform)}handleMove(t){this.prevHoveredFeatures=this.hoveredFeatures,this.hoveredFeatures=new Map;const r=this.queryTargets(t.point,Array.from(this.delegatedInteractions).reverse());r.length&&(t.type="mouseenter",this.handleType(t,r));const h=new Map;for(const[p,{feature:g}]of this.prevHoveredFeatures)this.hoveredFeatures.has(p)||h.set(g.id,g);h.size&&(t.type="mouseleave",this.handleType(t,Array.from(h.values())))}handleOut(t){const r=Array.from(this.hoveredFeatures.values()).map(({feature:h})=>h);r.length&&(t.type="mouseleave",this.handleType(t,r)),this.hoveredFeatures.clear()}handleType(t,r){const h=t.type==="mouseenter";if(h&&!this.interactionsByType.has(t.type))return void s.w("mouseenter interaction required for mouseleave to work.");const p=Array.from(this.interactionsByType.get(t.type)).reverse(),g=!!r;r=r||this.queryTargets(t.point,p);let y=!1;const w=new Set;for(const T of r){for(const[A,M]of p){if(!M.target)continue;const z=T.variants?T.variants[A]:null;if(z){for(const L of z){if(gc(L,T,w,A))continue;const D=new s.dx(T,L),N=kl(L,T,A);g&&D.id!==void 0&&(D.state=this.map.getFeatureState(D));const B=h?this.prevHoveredFeatures.get(N):null,G=new ul(t,A,M,D),$=B?B.stop:M.handler(G);if(h&&this.hoveredFeatures.set(N,{feature:T,stop:$}),$!==!1){y=!0;break}}if(y)break}}if(y)break}if(!y)for(const[T,A]of p){const{handler:M,target:z}=A;if(!z&&M(new ul(t,T,A,null))!==!1)break}}}function sx(u,t){if(Array.isArray(u)&&Array.isArray(t)){const r=new Set(u),h=new Set(t);return r.size===h.size&&u.every(p=>h.has(p))}return s.by(u,t)}const ax={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1,precompilePrograms:!0,scaleFactor:1,spriteFormat:"auto"},lx={showCompass:!0,showZoom:!0,visualizePitch:!1};class cx{constructor(t,r,h=!1){this._clickTolerance=10,this.element=r,this.mouseRotate=new fm({clickTolerance:t.dragRotate._mouseRotate._clickTolerance}),this.map=t,h&&(this.mousePitch=new pm({clickTolerance:t.dragRotate._mousePitch._clickTolerance})),s.aY(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),r.addEventListener("mousedown",this.mousedown),r.addEventListener("touchstart",this.touchstart,{passive:!1}),r.addEventListener("touchmove",this.touchmove),r.addEventListener("touchend",this.touchend),r.addEventListener("touchcancel",this.reset)}down(t,r){this.mouseRotate.mousedown(t,r),this.mousePitch&&this.mousePitch.mousedown(t,r),Ze()}move(t,r){const h=this.map,p=this.mouseRotate.mousemoveWindow(t,r),g=p&&p.bearingDelta;if(g&&h.setBearing(h.getBearing()+g),this.mousePitch){const y=this.mousePitch.mousemoveWindow(t,r),w=y&&y.pitchDelta;w&&h.setPitch(h.getPitch()+w)}}off(){const t=this.element;t.removeEventListener("mousedown",this.mousedown),t.removeEventListener("touchstart",this.touchstart),t.removeEventListener("touchmove",this.touchmove),t.removeEventListener("touchend",this.touchend),t.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){Ct(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(t){this.down(Object.assign({},t,{ctrlKey:!0,preventDefault:()=>t.preventDefault()}),Zt(this.element,t)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(t){this.move(t,Zt(this.element,t))}mouseup(t){this.mouseRotate.mouseupWindow(t),this.mousePitch&&this.mousePitch.mouseupWindow(t),this.offTemp()}touchstart(t){t.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=mn(this.element,t.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>t.preventDefault()},this._startPos))}touchmove(t){t.targetTouches.length!==1?this.reset():(this._lastPos=mn(this.element,t.targetTouches)[0],this.move({preventDefault:()=>t.preventDefault()},this._lastPos))}touchend(t){t.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}function ym(u,t,r){if(u=new s.aT(u.lng,u.lat),t){const h=new s.aT(u.lng-360,u.lat),p=new s.aT(u.lng+360,u.lat),g=360*Math.ceil(Math.abs(u.lng-r.center.lng)/360),y=r.locationPoint3D(u).distSqr(t),w=t.x<0||t.y<0||t.x>r.width||t.y>r.height;r.locationPoint3D(h).distSqr(t)<y&&(w||Math.abs(h.lng-r.center.lng)<g)?u=h:r.locationPoint3D(p).distSqr(t)<y&&(w||Math.abs(p.lng-r.center.lng)<g)&&(u=p)}for(;Math.abs(u.lng-r.center.lng)>180;){const h=r.locationPoint3D(u);if(h.x>=0&&h.y>=0&&h.x<=r.width&&h.y<=r.height)break;u.lng>r.center.lng?u.lng-=360:u.lng+=360}return u}const Gr={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"},es={rotation:0,rotationAlignment:"auto",pitchAlignment:"auto",occludedOpacity:.2,altitude:0};class nf extends s.E{constructor(t,r){super(),(t instanceof HTMLElement||r)&&(t=Object.assign({element:t},r)),s.aY(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this);const{anchor:h="center",color:p="#3FB1CE",scale:g=1,draggable:y=!1,clickTolerance:w=0,rotation:T=es.rotation,rotationAlignment:A=es.rotationAlignment,pitchAlignment:M=es.pitchAlignment,occludedOpacity:z=es.occludedOpacity,altitude:L=es.altitude}=t||{};this._anchor=h,this._color=p,this._scale=g,this._draggable=y,this._clickTolerance=w,this._rotation=T,this._rotationAlignment=A,this._pitchAlignment=M,this._occludedOpacity=z,this._altitude=L,this._state="inactive",this._isDragging=!1,this._updateMoving=()=>this._update(!0),t&&t.element?(this._element=t.element,this._offset=s.P.convert(t&&t.offset||[0,0])):(this._defaultMarker=!0,this._element=this._createDefaultMarker(),this._offset=s.P.convert(t&&t.offset||[0,-14])),this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",B=>{B.preventDefault()}),this._element.addEventListener("mousedown",B=>{B.preventDefault()});const D=this._element.classList;for(const B in Gr)D.remove(`mapboxgl-marker-anchor-${B}`);D.add(`mapboxgl-marker-anchor-${this._anchor}`);const N=t&&t.className?t.className.trim().split(/\s+/):[];D.add(...N),this._popup=null}_createDefaultMarker(){const t=We("div"),r=ct("svg",{display:"block",height:41*this._scale+"px",width:27*this._scale+"px",viewBox:"0 0 27 41"},t);if(this._altitude===0){const h=ct("radialGradient",{id:"shadowGradient"},ct("defs",{},r));ct("stop",{offset:"10%","stop-opacity":.4},h),ct("stop",{offset:"100%","stop-opacity":.05},h),ct("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},r)}return ct("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},r),ct("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},r),ct("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},r),t}addTo(t){return t===this._map||(this.remove(),this._map=t,t.getCanvasContainer().appendChild(this._element),t.on("move",this._updateMoving),t.on("moveend",this._update),t.on("remove",this._clearFadeTimer),t._addMarker(this),this.setDraggable(this._draggable),this._update(),t.on("click",this._onMapClick)),this}remove(){const t=this._map;return t&&(t.off("click",this._onMapClick),t.off("move",this._updateMoving),t.off("moveend",this._update),t.off("mousedown",this._addDragHandler),t.off("touchstart",this._addDragHandler),t.off("mouseup",this._onUp),t.off("touchend",this._onUp),t.off("mousemove",this._onMove),t.off("touchmove",this._onMove),t.off("remove",this._clearFadeTimer),t._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(t){return this._lngLat=s.aT.convert(t),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}setAltitude(t){return t===this._altitude||(this._defaultMarker&&(this._altitude===0&&t!==0||this._altitude!==0&&t===0)&&(this._element=this._createDefaultMarker()),this._altitude=t||es.altitude,this._update()),this}getAltitude(){return this._altitude}getElement(){return this._element}setPopup(t){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),t){if(!("offset"in t.options)){const p=Math.sqrt(Math.pow(13.5,2)/2);t.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[p,-1*(38.1-13.5+p)],"bottom-right":[-p,-1*(38.1-13.5+p)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=t,t._marker=this,t._altitude=this._altitude,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(t){const r=t.code,h=t.charCode||t.keyCode;r!=="Space"&&r!=="Enter"&&h!==32&&h!==13||this.togglePopup()}_onMapClick(t){const r=t.originalEvent.target,h=this._element;this._popup&&(r===h||h.contains(r))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const t=this._popup;return t?(t.isOpen()?(t.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(t.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const t=this._map,r=this._pos;if(!t||!r)return!1;const h=t.unproject(r,this._altitude),p=t.getFreeCameraOptions();if(!p.position)return!1;const g=p.position.toLngLat();return g.distanceTo(h)<.9*g.distanceTo(this._lngLat)}_evaluateOpacity(){const t=this._map;if(!t)return;const r=this._pos;if(!r||r.x<0||r.x>t.transform.width||r.y<0||r.y>t.transform.height)return void this._clearFadeTimer();const h=t.unproject(r,this._altitude);let p;t._showingGlobe()&&s.f5(t.transform,this._lngLat)?p=0:(p=1-t._queryFogOpacity(h),t.transform._terrainEnabled()&&t.getTerrain()&&this._behindTerrain()&&(p*=this._occludedOpacity)),this._element.style.opacity=`${p}`,this._element.style.pointerEvents=p>0?"auto":"none",this._popup&&this._popup._setOpacity(p),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const t=this._pos;if(!t||!this._map)return;const r=this._offset.mult(this._scale);this._element.style.transform=`
            translate(${t.x}px,${t.y}px)
            ${Gr[this._anchor]}
            ${this._calculateXYTransform()} ${this._calculateZTransform()}
            translate(${r.x}px,${r.y}px)
        `}_calculateXYTransform(){const t=this._pos,r=this._map,h=this.getPitchAlignment();if(!r||!t||h!=="map")return"";if(!r._showingGlobe()){const T=r.getPitch();return T?`rotateX(${T}deg)`:""}const p=s.cX(s.f6(r.transform,this._lngLat)),g=t.sub(s.f7(r.transform)),y=Math.abs(g.x)+Math.abs(g.y);if(y===0)return"";const w=p/y;return`rotateX(${-g.y*w}deg) rotateY(${g.x*w}deg)`}_calculateZTransform(){const t=this._pos,r=this._map;if(!r||!t)return"";let h=0;const p=this.getRotationAlignment();if(p==="map")if(r._showingGlobe()){const g=r.project(new s.aT(this._lngLat.lng,this._lngLat.lat+.001),this._altitude),y=r.project(new s.aT(this._lngLat.lng,this._lngLat.lat-.001),this._altitude).sub(g);h=s.cX(Math.atan2(y.y,y.x))-90}else h=-r.getBearing();else if(p==="horizon"){const g=s.ah(4,6,r.getZoom()),y=s.f7(r.transform);y.y+=g*r.transform.height;const w=t.sub(y),T=s.cX(Math.atan2(w.y,w.x));h=(T>90?T-270:T+90)*(1-g)}return h+=this._rotation,h?`rotateZ(${h}deg)`:""}_update(t){cancelAnimationFrame(this._updateFrameId);const r=this._map;r&&(r.transform.renderWorldCopies&&(this._lngLat=ym(this._lngLat,this._pos,r.transform)),this._pos=r.project(this._lngLat,this._altitude),t===!0?this._updateFrameId=requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),r._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(r._showingGlobe()||r.getTerrain()||r.getFog())&&!this._fadeTimer&&(this._fadeTimer=window.setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(t){return this._offset=s.P.convert(t),this._update(),this}addClassName(t){return this._element.classList.add(t),this}removeClassName(t){return this._element.classList.remove(t),this}toggleClassName(t){return this._element.classList.toggle(t)}_onMove(t){const r=this._map;if(!r)return;const h=this._pointerdownPos,p=this._positionDelta;if(h&&p){if(!this._isDragging){const g=this._clickTolerance||r._clickTolerance;if(t.point.dist(h)<g)return;this._isDragging=!0}this._pos=t.point.sub(p),this._lngLat=r.unproject(this._pos,this._altitude),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new s.z("dragstart"))),this.fire(new s.z("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const t=this._map;t&&(t.off("mousemove",this._onMove),t.off("touchmove",this._onMove)),this._state==="active"&&this.fire(new s.z("dragend")),this._state="inactive"}_addDragHandler(t){const r=this._map,h=this._pos;r&&h&&this._element.contains(t.originalEvent.target)&&(t.preventDefault(),this._positionDelta=t.point.sub(h),this._pointerdownPos=t.point,this._state="pending",r.on("mousemove",this._onMove),r.on("touchmove",this._onMove),r.once("mouseup",this._onUp),r.once("touchend",this._onUp))}setDraggable(t){this._draggable=!!t;const r=this._map;return r&&(t?(r.on("mousedown",this._addDragHandler),r.on("touchstart",this._addDragHandler)):(r.off("mousedown",this._addDragHandler),r.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(t){return this._rotation=t||es.rotation,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(t){return this._rotationAlignment=t||es.rotationAlignment,this._update(),this}getRotationAlignment(){return this._rotationAlignment==="auto"||this._rotationAlignment==="horizon"&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(t){return this._pitchAlignment=t||es.pitchAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment==="auto"?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(t){return this._occludedOpacity=t||es.occludedOpacity,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const ux={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},jc={maxWidth:100,unit:"metric"},vm={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},ts={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",altitude:0},is=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function Yl(u=new s.P(0,0),t="bottom"){if(typeof u=="number"){const r=Math.round(Math.sqrt(.5*Math.pow(u,2)));switch(t){case"top":return new s.P(0,u);case"top-left":return new s.P(r,r);case"top-right":return new s.P(-r,r);case"bottom":return new s.P(0,-u);case"bottom-left":return new s.P(r,-r);case"bottom-right":return new s.P(-r,-r);case"left":return new s.P(u,0);case"right":return new s.P(-u,0)}return new s.P(0,0)}return u instanceof s.P||Array.isArray(u)?s.P.convert(u):s.P.convert(u[t]||[0,0])}return{version:Z,supported:mt.supported,setRTLTextPlugin:s.fb,getRTLTextPluginStatus:s.fa,Map:class extends gm{constructor(u){me.mark(Q.create);const t=u;if((u=Object.assign({},ax,u)).minZoom!=null&&u.maxZoom!=null&&u.minZoom>u.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(u.minPitch!=null&&u.maxPitch!=null&&u.minPitch>u.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(u.minPitch!=null&&u.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(u.maxPitch!=null&&u.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(u.antialias&&s.f3(window)&&(u.antialias=!1,s.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new bp(u.minZoom,u.maxZoom,u.minPitch,u.maxPitch,u.renderWorldCopies,null,null),u),this._repaint=!!u.repaint,this._interactive=u.interactive,this._minTileCacheSize=u.minTileCacheSize,this._maxTileCacheSize=u.maxTileCacheSize,this._failIfMajorPerformanceCaveat=u.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=u.preserveDrawingBuffer,this._antialias=u.antialias,this._trackResize=u.trackResize,this._bearingSnap=u.bearingSnap,this._refreshExpiredTiles=u.refreshExpiredTiles,this._fadeDuration=u.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=u.crossSourceCollisions,this._collectResourceTiming=u.collectResourceTiming,this._language=this._parseLanguage(u.language),this._worldview=u.worldview,this._renderTaskQueue=new ya,this._domRenderTaskQueue=new ya,this._controls=[],this._markers=[],this._popups=[],this._mapId=s.b2(),this._locale=Object.assign({},xa,u.locale),this._clickTolerance=u.clickTolerance,this._cooperativeGestures=u.cooperativeGestures,this._performanceMetricsCollection=u.performanceMetricsCollection,this._tessellationStep=u.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._precompilePrograms=u.precompilePrograms,this._scaleFactorChanged=!1,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new va(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._scaleFactor=u.scaleFactor,this._requestManager=new wl(u.transformRequest,u.accessToken,u.testMode),this._silenceAuthErrors=!!u.testMode,this._contextCreateOptions=u.contextCreateOptions?Object.assign({},u.contextCreateOptions):{},typeof u.container=="string"){const r=document.getElementById(u.container);if(!r)throw new Error(`Container '${u.container.toString()}' not found.`);this._container=r}else{if(!(u.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=u.container}if(this._container.childNodes.length>0&&s.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),u.maxBounds&&this.setMaxBounds(u.maxBounds),this._spriteFormat=u.spriteFormat,s.aY(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");if(this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new ox(this,u),this._localFontFamily=u.localFontFamily,this._localIdeographFontFamily=u.localIdeographFontFamily,(u.style||!u.testMode)&&this.setStyle(u.style||s.e.DEFAULT_STYLE,{config:u.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),u.projection&&this.setProjection(u.projection),u.hash&&(this._hash=new om(typeof u.hash=="string"&&u.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){t.center==null&&t.zoom==null||(this.transform._unmodified=!1),this.jumpTo({center:u.center,zoom:u.zoom,bearing:u.bearing,pitch:u.pitch});const r=u.bounds;r&&(this.resize(),this.fitBounds(r,Object.assign({},u.fitBoundsOptions,{duration:0})))}this.resize(),u.attributionControl&&this.addControl(new oh({customAttribution:u.customAttribution})),this._logoControl=new sh,this.addControl(this._logoControl,u.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent(),this._postStyleWithAppearanceEvent(),this._setupIndoor()}),this.on("data",r=>{this._update(r.dataType==="style"),this.fire(new s.z(`${r.dataType}data`,r))}),this.on("dataloading",r=>{this.fire(new s.z(`${r.dataType}dataloading`,r))}),this._interactions=new ws(this)}_getMapId(){return this._mapId}addControl(u,t){if(t===void 0&&(t=u.getDefaultPosition?u.getDefaultPosition():"top-right"),!u||!u.onAdd)return this.fire(new s.y(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const r=u.onAdd(this);this._controls.push(u);const h=this._controlPositions[t];return t.indexOf("bottom")!==-1?h.insertBefore(r,h.firstChild):h.appendChild(r),this}removeControl(u){if(!u||!u.onRemove)return this.fire(new s.y(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const t=this._controls.indexOf(u);return t>-1&&this._controls.splice(t,1),u.onRemove(this),this}hasControl(u){return this._controls.indexOf(u)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(u){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const t=!this._moving;return t&&this.fire(new s.z("movestart",u)).fire(new s.z("move",u)),this.fire(new s.z("resize",u)),t&&this.fire(new s.z("moveend",u)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(u){return this.transform.setMaxBounds(s.aI.convert(u)),this._update()}setMinZoom(u){if((u=u??-2)>=-2&&u<=this.transform.maxZoom)return this.transform.minZoom=u,this._update(),this.getZoom()<u?this.setZoom(u):this.fire(new s.z("zoomstart")).fire(new s.z("zoom")).fire(new s.z("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(u){if((u=u??22)>=this.transform.minZoom)return this.transform.maxZoom=u,this._update(),this.getZoom()>u?this.setZoom(u):this.fire(new s.z("zoomstart")).fire(new s.z("zoom")).fire(new s.z("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(u){if((u=u??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(u>=0&&u<=this.transform.maxPitch)return this.transform.minPitch=u,this._update(),this.getPitch()<u?this.setPitch(u):this.fire(new s.z("pitchstart")).fire(new s.z("pitch")).fire(new s.z("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(u){if((u=u??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(u>=this.transform.minPitch)return this.transform.maxPitch=u,this._update(),this.getPitch()>u?this.setPitch(u):this.fire(new s.z("pitchstart")).fire(new s.z("pitch")).fire(new s.z("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getScaleFactor(){return this._scaleFactor}setScaleFactor(u){return this._scaleFactor=u,this.painter.scaleFactor=u,this._scaleFactorChanged=!0,this.style._updateFilteredLayers(t=>t.type==="symbol"),this._update(!0),this}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(u){return this.transform.renderWorldCopies=u,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(u){return u==="auto"?navigator.language:Array.isArray(u)?u.length===0?void 0:u.map(t=>t==="auto"?navigator.language:t):u}setLanguage(u){const t=this._parseLanguage(u);if(!this.style||t===this._language)return this;this._language=t,this.style.reloadSources();for(const r of this._controls)r._setLanguage&&r._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(u){return this.style&&u!==this._worldview?(this._worldview=u,this._styleDirty=!0,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return this.transform.projection.name==="globe"}setProjection(u){return this._lazyInitEmptyStyle(),u?typeof u=="string"&&(u={name:u}):u=null,this._useExplicitProjection=!!u,this._prioritizeAndUpdateProjection(u,this.style.projection)}_updateProjectionTransition(){if(this.getProjection().name!=="globe")return;const u=this.transform,t=u.projection.name;let r;t==="globe"&&u.zoom>=s.cL?(u.setMercatorFromTransition(),r=!0):t==="mercator"&&u.zoom<s.cL&&(u.setProjection({name:"globe"}),r=!0),r&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate(),this._update(!0))}_prioritizeAndUpdateProjection(u,t){return this._updateProjection(u||t||{name:"mercator"})}_updateProjection(u){let t;const r=this.transform.mercatorFromTransition;t=u.name==="globe"&&this.transform.zoom>=s.cL?this.transform.setMercatorFromTransition():this.transform.setProjection(u),this.style.applyProjectionUpdate();const h=this.transform.getProjection().name==="mercator"&&r!==this.transform.mercatorFromTransition;return(t||h)&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(u,t){return this.transform.locationPoint3D(s.aT.convert(u),t)}unproject(u,t){return this.transform.pointLocation3D(s.P.convert(u),t)}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(u,t,r){const h=p=>{let g=[];if(Array.isArray(t)){const y=t.filter(w=>this.getLayer(w));g=y.length?this.queryRenderedFeatures(p,{layers:y}):[]}else g=this.queryRenderedFeatures(p,{target:t});return g};if(u==="mouseenter"||u==="mouseover"){let p=!1;return{listener:r,targets:t,delegates:{mousemove:y=>{const w=h(y.point);w.length?p||(p=!0,r.call(this,new vo(u,this,y.originalEvent,{features:w}))):p=!1},mouseout:()=>{p=!1}}}}if(u==="mouseleave"||u==="mouseout"){let p=!1;return{listener:r,targets:t,delegates:{mousemove:w=>{h(w.point).length?p=!0:p&&(p=!1,r.call(this,new vo(u,this,w.originalEvent)))},mouseout:w=>{p&&(p=!1,r.call(this,new vo(u,this,w.originalEvent)))}}}}{const p=g=>{const y=h(g.point);y.length&&(g.features=y,r.call(this,g),delete g.features)};return{listener:r,targets:t,delegates:{[u]:p}}}}on(u,t,r){if(typeof t=="function"||r===void 0)return super.on(u,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;const h=this._createDelegatedListener(u,t,r);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[u]=this._delegatedListeners[u]||[],this._delegatedListeners[u].push(h);for(const p in h.delegates)this.on(p,h.delegates[p]);return this}once(u,t,r){if(typeof t=="function"||r===void 0)return super.once(u,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;const h=this._createDelegatedListener(u,t,r);for(const p in h.delegates)this.once(p,h.delegates[p]);return this}off(u,t,r){if(typeof t=="function"||r===void 0)return super.off(u,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;const h=this._delegatedListeners?this._delegatedListeners[u]:void 0;return h&&(p=>{for(let g=0;g<p.length;g++){const y=p[g];if(y.listener===r&&sx(y.targets,t)){for(const w in y.delegates)this.off(w,y.delegates[w]);return p.splice(g,1),this}}})(h),this}queryRenderedFeatures(u,t){if(!this.style)return[];if(u===void 0||u instanceof s.P||Array.isArray(u)||t!==void 0||(t=u,u=void 0),u=u||[[0,0],[this.transform.width,this.transform.height]],!t){const g=this.style.queryRenderedFeatures(u,void 0,this.transform),y=this.style.queryRenderedFeatureset(u,void 0,this.transform);return g.concat(y)}let r=!0;if(t.target&&(r=this._isTargetValid(t.target),r&&!t.layers))return this.style.queryRenderedFeatureset(u,t,this.transform);let h=!0;if(t.layers&&Array.isArray(t.layers)){for(const g of t.layers)if(!this._isValidId(g)){h=!1;break}if(h&&!t.target)return this.style.queryRenderedFeatures(u,t,this.transform)}let p=[];return h&&(p=p.concat(this.style.queryRenderedFeatures(u,t,this.transform))),r&&(p=p.concat(this.style.queryRenderedFeatureset(u,t,this.transform))),p}querySourceFeatures(u,t){return!u||typeof u=="string"&&!this._isValidId(u)?[]:this.style.querySourceFeatures(u,t)}queryRasterValue(u,t,r){return this._isValidId(u)?this.style.queryRasterValue(u,t,r):Promise.resolve(null)}isPointOnSurface(u){const{name:t}=this.transform.projection;return t!=="globe"&&t!=="mercator"&&s.w(`${t} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(s.P.convert(u))}addInteraction(u,t){return this._interactions.add(u,t),this}removeInteraction(u){return this._interactions.remove(u),this}getCooperativeGestures(){return this._cooperativeGestures}setCooperativeGestures(u){return this._cooperativeGestures=u,this}setStyle(u,t){return t=Object.assign({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},t),this.style&&u&&t.diff!==!1&&t.localFontFamily===this._localFontFamily&&t.localIdeographFontFamily===this._localIdeographFontFamily&&!t.config?(this.style._diffStyle(u,(r,h)=>{if(r){const p=typeof r=="string"?r:r instanceof Error?r.message:r.error;s.w(`Unable to perform style diff: ${p}. Rebuilding the style from scratch.`),this._updateStyle(u,t)}else h&&this._update(!0)},()=>this._postStyleLoadEvent()),this):(this._localIdeographFontFamily=t.localIdeographFontFamily,this._localFontFamily=t.localFontFamily,this._updateStyle(u,t))}_getUIString(u){const t=this._locale[u];if(t==null)throw new Error(`Missing UI string '${u}'`);return t}_updateStyle(u,t){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),u){const r=Object.assign({},t);t&&t.config&&(r.initialConfig=t.config,delete r.config),this.style=new Qo(this,r).load(u),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new Qo(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(s.w("There is no style added to the map."),!1)}_isValidId(u){return u==null?(this.fire(new s.y(new Error("IDs can't be empty."))),!1):!s.dr(u)||(this.fire(new s.y(new Error(`IDs can't contain special symbols: "${u}".`))),!1)}_isTargetValid(u){return"featuresetId"in u?this._isValidId("importId"in u?u.importId:u.featuresetId):"layerId"in u&&this._isValidId(u.layerId)}_areTargetsValid(u){if(Array.isArray(u)){for(const t of u)if(!this._isValidId(t))return!1;return!0}return this._isTargetValid(u)}addSource(u,t){return this._isValidId(u)?(this._lazyInitEmptyStyle(),this.style.addSource(u,t),this._update(!0)):this}isSourceLoaded(u){return!!this._isValidId(u)&&!!this.style&&this.style._isSourceCacheLoaded(u)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(u,t,r){this._lazyInitEmptyStyle(),this.style.addSourceType(u,t,r)}removeSource(u){return this._isValidId(u)?(this.style.removeSource(u),this._updateTerrain(),this._update(!0)):this}getSource(u){return this._isValidId(u)?this.style.getOwnSource(u):null}addImage(u,t,{pixelRatio:r=1,sdf:h=!1,stretchX:p,stretchY:g,content:y}={}){this._lazyInitEmptyStyle();const w=s.I.from(u);if(t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap){const{width:T,height:A,data:M}=s.o.getImageData(t);this.style.addImage(w,{data:new s.q({width:T,height:A},M),pixelRatio:r,stretchX:p,stretchY:g,content:y,sdf:h,version:0,usvg:!1})}else if(t.width===void 0||t.height===void 0)this.fire(new s.y(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:T,height:A}=t,M=t;this.style.addImage(w,{data:new s.q({width:T,height:A},new Uint8Array(M.data)),pixelRatio:r,stretchX:p,stretchY:g,content:y,sdf:h,usvg:!1,version:0,userImage:M}),M.onAdd&&M.onAdd(this,u)}}updateImage(u,t){this._lazyInitEmptyStyle();const r=s.I.from(u),h=this.style.getImage(r);if(!h)return void this.fire(new s.y(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const p=t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap?s.o.getImageData(t):t,{width:g,height:y,data:w}=p;if(g===void 0||y===void 0)return void this.fire(new s.y(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(g!==(h.usvg?h.icon.usvg_tree.width:h.data.width)||y!==(h.usvg?h.icon.usvg_tree.height:h.data.height))return void this.fire(new s.y(new Error(`The width and height of the updated image (${g}, ${y})
                must be that same as the previous version of the image
                (${h.data.width}, ${h.data.height})`)));const T=!(t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap);let A=!1;h.usvg?(h.data=new s.q({width:g,height:y},new Uint8Array(w)),h.usvg=!1,h.icon=void 0,A=!0):h.data.replace(w,T),this.style.updateImage(r,h,A)}hasImage(u){return u?!!this.style&&!!this.style.getImage(s.I.from(u)):(this.fire(new s.y(new Error("Missing required image id"))),!1)}removeImage(u){this.style.removeImage(s.I.from(u))}loadImage(u,t){s.n(this._requestManager.transformRequest(u,s.R.Image),(r,h)=>{t(r,h instanceof HTMLImageElement?s.o.getImageData(h):h)})}listImages(){return this.style.listImages().map(u=>u.name)}addModel(u,t){this._lazyInitEmptyStyle(),this.style.addModel(u,t)}hasModel(u){return u?this.style.hasModel(u):(this.fire(new s.y(new Error("Missing required model id"))),!1)}removeModel(u){this.style.removeModel(u)}listModels(){return this.style.listModels()}addLayer(u,t){return this._isValidId(u.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(u,t),this._update(!0)):this}getSlot(u){const t=this.getLayer(u);return t&&t.slot||null}setSlot(u,t){return this.style.setSlot(u,t),this.style.mergeLayers(),this._update(!0)}addImport(u,t){return this.style.addImport(u,t).catch(r=>this.fire(new s.y(new Error("Failed to add import",r)))),this}updateImport(u,t){return typeof t!="string"&&t.id!==u?(this.removeImport(u),this.addImport(t)):(this.style.updateImport(u,t),this._update(!0))}removeImport(u){return this.style.removeImport(u),this}moveImport(u,t){return this.style.moveImport(u,t),this._update(!0)}moveLayer(u,t){return this._isValidId(u)?(this.style.moveLayer(u,t),this._update(!0)):this}removeLayer(u){return this._isValidId(u)?(this.style.removeLayer(u),this._update(!0)):this}getLayer(u){if(!this._isValidId(u))return null;const t=this.style.getOwnLayer(u);return t?t.type==="custom"?t.implementation:t.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(u,t,r){return this._isValidId(u)?(this.style.setLayerZoomRange(u,t,r),this._update(!0)):this}setFilter(u,t,r={}){return this._isValidId(u)?(this.style.setFilter(u,t,r),this._update(!0)):this}getFilter(u){return this._isValidId(u)?this.style.getFilter(u):null}setPaintProperty(u,t,r,h={}){return this._isValidId(u)?(this.style.setPaintProperty(u,t,r,h),this._update(!0)):this}getPaintProperty(u,t){return this._isValidId(u)?this.style.getPaintProperty(u,t):null}setLayoutProperty(u,t,r,h={}){return this._isValidId(u)?(this.style.setLayoutProperty(u,t,r,h),this._update(!0)):this}getLayoutProperty(u,t){return this._isValidId(u)?this.style.getLayoutProperty(u,t):null}setLayerProperty(u,t,r,h={}){return this._isValidId(u)?(t==="appearances"&&this._postAddingAppearancesToStyleEvent(),this.style.setLayerProperty(u,t,r,h),this._update(!0)):this}getGlyphsUrl(){return this.style.getGlyphsUrl()}setGlyphsUrl(u){return this.style.setGlyphsUrl(u),this._update(!0)}getSchema(u){return this.style.getSchema(u)}setSchema(u,t){return this.style.setSchema(u,t),this._update(!0)}getConfig(u){return this.style.getConfig(u)}setConfig(u,t){return this.style.setConfig(u,t),this._update(!0)}getConfigProperty(u,t){return this.style.getConfigProperty(u,t)}setConfigProperty(u,t,r){return this.style.setConfigProperty(u,t,r),this._update(!0)}getFeaturesetDescriptors(u){return this.style.getFeaturesetDescriptors(u)}setLights(u){if(this._lazyInitEmptyStyle(),u&&u.length===1&&u[0].type==="flat"){const t=u[0];t.properties?this.style.setFlatLight(t.properties,t.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(u),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const u=this.style.getLights()||[];return u.length===0&&u.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),u}setLight(u,t={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:u}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(u){return this._lazyInitEmptyStyle(),!u&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(u),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(u){return this._lazyInitEmptyStyle(),this.style.setFog(u),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setSnow(u){return this._lazyInitEmptyStyle(),this.style.setSnow(u),this._update(!0)}getSnow(){return this.style?this.style.getSnow():null}setRain(u){return this._lazyInitEmptyStyle(),this.style.setRain(u),this._update(!0)}getRain(){return this.style?this.style.getRain():null}setColorTheme(u){return this._lazyInitEmptyStyle(),this.style.setColorTheme(u),this._update(!0)}setImportColorTheme(u,t){return this._lazyInitEmptyStyle(),this.style.setImportColorTheme(u,t),this._update(!0)}setCamera(u){return this.style.setCamera(u),this._triggerCameraUpdate(u)}_triggerCameraUpdate(u){return this._update(this.transform.setOrthographicProjectionAtLowPitch(u["camera-projection"]==="orthographic"))}getCamera(){return this.style.camera}_queryFogOpacity(u){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(s.aT.convert(u),this.transform):0}setFeatureState(u,t){return u.source&&!this._isValidId(u.source)?this:(this.style.setFeatureState(u,t),this._update())}removeFeatureState(u,t){return u.source&&!this._isValidId(u.source)?this:(this.style.removeFeatureState(u,t),this._update())}getFeatureState(u){return u.source&&!this._isValidId(u.source)?null:this.style.getFeatureState(u)}_selectIndoorFloor(u){this.indoor.selectFloor(u)}_setIndoorActiveFloorsVisibility(u){this.indoor.setActiveFloorsVisibility(u)}_addIndoorControl(){this._indoorControl||(this._indoorControl=new Nc),this.addControl(this._indoorControl,"right")}_removeIndoorControl(){this._indoorControl&&this.removeControl(this._indoorControl)}_updateContainerDimensions(){if(!this._container)return;const u=this._container.getBoundingClientRect().width||400,t=this._container.getBoundingClientRect().height||300;let r,h,p,g=this._container;for(;g&&(!h||!p);){const y=window.getComputedStyle(g).transform;y&&y!=="none"&&(r=y.match(/matrix.*\((.+)\)/)[1].split(", "),r[0]&&r[0]!=="0"&&r[0]!=="1"&&(h=r[0]),r[3]&&r[3]!=="0"&&r[3]!=="1"&&(p=r[3])),g=g.parentElement}this._containerWidth=h?Math.abs(u/h):u,this._containerHeight=p?Math.abs(t/p):t}_detectMissingCSS(){window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&s.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupIndoor(){this.style.isIndoorEnabled()&&(this.indoor=new vg(this.style),this.on("load",()=>{this._addIndoorControl(),this.indoor._updateUI(this.transform.zoom,this.transform.center,this.transform.getBounds()),this.on("move",()=>{this.indoor._updateUI(this.transform.zoom,this.transform.center,this.transform.getBounds())}),this.on("idle",()=>{this.indoor._updateUI(this.transform.zoom,this.transform.center,this.transform.getBounds())})}))}_setupContainer(){const u=this._container;u.classList.add("mapboxgl-map"),(this._missingCSSCanary=We("div","mapboxgl-canary",u)).style.visibility="hidden",this._detectMissingCSS();const t=this._canvasContainer=We("div","mapboxgl-canvas-container",u);this._canvas=We("canvas","mapboxgl-canvas",t),this._interactive&&(t.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const r=this._controlContainer=We("div","mapboxgl-control-container",u),h=this._controlPositions={};["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"].forEach(p=>{h[p]=We("div",`mapboxgl-ctrl-${p}`,r)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(u,t){const r=s.o.devicePixelRatio||1;this._canvas.width=r*Math.ceil(u),this._canvas.height=r*Math.ceil(t),this._canvas.style.width=`${u}px`,this._canvas.style.height=`${t}px`}_addMarker(u){this._markers.push(u)}_removeMarker(u){const t=this._markers.indexOf(u);t!==-1&&this._markers.splice(t,1)}_addPopup(u){this._popups.push(u)}_removePopup(u){const t=this._popups.indexOf(u);t!==-1&&this._popups.splice(t,1)}_setupPainter(){const u=Object.assign({},mt.supported.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),t=this._canvas.getContext("webgl2",u);t?(Xr(t,!0),this.painter=new Vd(t,this._contextCreateOptions,this.transform,this._scaleFactor,this._worldview),this.on("data",r=>{r.dataType==="source"&&this.painter.setTileLoadedFlag(!0)}),s.k.testSupport(t)):this.fire(new s.y(new Error("Failed to initialize WebGL")))}_contextLost(u){u.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new s.z("webglcontextlost",{originalEvent:u}))}_contextRestored(u){this._setupPainter(),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight)),this._updateTerrain(),this.style&&(this.style.clearLayers(),this.style.imageManager.destroyAtlasTextures(),this.style.reloadModels(),this.style.clearSources()),this._update(),this.fire(new s.z("webglcontextrestored",{originalEvent:u}))}_onMapScroll(u){if(u.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}idle(){return!this.isMoving()&&this.loaded()}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty}_update(u){return this.style?(this._styleDirty=this._styleDirty||u,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(u){return this._update(),this._renderTaskQueue.add(u)}_cancelRenderFrame(u){this._renderTaskQueue.remove(u)}_requestDomTask(u){!this.loaded()||this.loaded()&&!this.isMoving()?u():this._domRenderTaskQueue.add(u)}_render(u){let t;this.fire(new s.z("renderstart")),++this._frameId;const r=this.painter.context.extTimerQuery,h=s.o.now(),p=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(t=p.createQuery(),p.beginQuery(r.TIME_ELAPSED_EXT,t)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(u),this._domRenderTaskQueue.run(u),this._removed)return;this._updateProjectionTransition();const g=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const A=this.transform.zoom,M=this.transform.pitch,z=s.o.now(),L=new s.ac(A,{now:z,fadeDuration:g,pitch:M,transition:this.style.transition,worldview:this._worldview});this.style.update(L)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let y=!1;this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),y=this._updateAverageElevation(h),this.style.updateSources(this.transform),this.style.updateImageProviders(),this.isMoving()||this._forceMarkerAndPopupUpdate()):y=this._updateAverageElevation(h);const w=this.style&&this.style._updatePlacement(this.painter,this.painter.transform,this.showCollisionBoxes,g,this._crossSourceCollisions,this.painter.replacementSource,this._scaleFactorChanged);if(this._scaleFactorChanged&&(this._scaleFactorChanged=!1),w&&(this._placementDirty=w.needsRerender),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:g,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new s.z("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,me.mark(Q.load),this.fire(new s.z("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&(this.style.snow||this.style.rain)&&(this._styleDirty=!0),this.style&&this.style.imageManager.hasPatternsInFlight()&&(this._styleDirty=!0),this.style&&!this.style.modelManager.isLoaded()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),t){const A=s.o.now()-h;p.endQuery(r.TIME_ELAPSED_EXT),setTimeout(()=>{const M=p.getQueryParameter(t,p.QUERY_RESULT)/1e6;p.deleteQuery(t),this.fire(new s.z("gpu-timing-frame",{cpuTime:A,gpuTime:M}))},50)}if(this.listens("gpu-timing-layer")){const A=this.painter.collectGpuTimers();setTimeout(()=>{const M=this.painter.queryGpuTimers(A);this.fire(new s.z("gpu-timing-layer",{layerTimes:M}))},50)}if(this.listens("gpu-timing-deferred-render")){const A=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{const M=this.painter.queryGpuTimeDeferredRender(A);this.fire(new s.z("gpu-timing-deferred-render",{gpuTime:M}))},50)}const T=this._sourcesDirty||this._styleDirty||this._placementDirty||y;if(T||this._repaint)this.triggerRepaint();else{const A=this.idle();if(A&&(y=this._updateAverageElevation(h,!0)),y)this.triggerRepaint();else if(this._triggerFrame(!1),A&&(this.fire(new s.z("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const M=this._calculateSpeedIndex();this.fire(new s.z("speedindexcompleted",{speedIndex:M})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||T||(this._fullyLoaded=!0,me.mark(Q.fullLoad),this._performanceMetricsCollection&&Kn(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(u){for(const t of this._markers)u&&!this.getRenderWorldCopies()&&(t._lngLat=t._lngLat.wrap()),t._update();for(const t of this._popups)!u||this.getRenderWorldCopies()||t._trackPointer||(t._lngLat=t._lngLat.wrap()),t._update()}_updateAverageElevation(u,t=!1){const r=p=>(this.transform.averageElevation=p,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&r(0);const h=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(h||(t||u-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(u)){const p=this.transform.averageElevation;let g=this.transform.sampleAverageElevation();this.transform.elevation!=null&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(g)?g=0:this._averageElevationLastSampledAt=u;const y=Math.abs(p-g);if(y>1){if(this._isInitialLoad||h)return this._averageElevation.jumpTo(g),r(g);this._averageElevation.easeTo(g,u,300)}else if(y>1e-4)return this._averageElevation.jumpTo(g),r(g)}return!!this._averageElevation.isEasing(u)&&r(this._averageElevation.getValue(u))}_authenticate(){$a(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,u=>{if(u&&(u.message===Ri||u.status===401)){const t=this.painter.context.gl;Xr(t,!1),this._logoControl instanceof sh&&this._logoControl._updateLogo(),t&&t.clear(t.DEPTH_BUFFER_BIT|t.COLOR_BUFFER_BIT|t.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new s.y(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),ja(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_postStyleLoadEvent(){this.style.globalId&&ia(this._requestManager._customAccessToken,{map:this,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_postStyleWithAppearanceEvent(){this.style.globalId&&this.style.hasAppearances()&&yn(this._requestManager._customAccessToken)}_postAddingAppearancesToStyleEvent(){jr(this._requestManager._customAccessToken)}_updateTerrain(){const u=this._isDragging();this.painter.updateTerrain(this.style,u)}_calculateSpeedIndex(){const u=this.painter.canvasCopy(),t=this.painter.getCanvasCopiesAndTimestamps();t.timeStamps.push(performance.now());const r=this.painter.context.gl,h=r.createFramebuffer();function p(g){r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,g,0);const y=new Uint8Array(r.drawingBufferWidth*r.drawingBufferHeight*4);return r.readPixels(0,0,r.drawingBufferWidth,r.drawingBufferHeight,r.RGBA,r.UNSIGNED_BYTE,y),y}return r.bindFramebuffer(r.FRAMEBUFFER,h),this._canvasPixelComparison(p(u),t.canvasCopies.map(p),t.timeStamps)}_canvasPixelComparison(u,t,r){let h=r[1]-r[0];const p=u.length/4;for(let g=0;g<t.length;g++){const y=t[g];let w=0;for(let T=0;T<y.length;T+=4)y[T]===u[T]&&y[T+1]===u[T+1]&&y[T+2]===u[T+2]&&y[T+3]===u[T+3]&&(w+=1);h+=(r[g+2]-r[g+1])*(1-w/p)}return h}remove(){this._hash&&this._hash.remove();for(const t of this._controls)t.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.indoor&&this.indoor.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);const u=this.painter.context.gl.getExtension("WEBGL_lose_context");u&&u.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),Eo.delete(this.painter.context.gl),Va.remove(),Er.remove(),this._removed=!0,this.fire(new s.z("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(u){this._renderNextFrame=this._renderNextFrame||u,this.style&&!this._frame&&(this._frame=s.o.frame(t=>{const r=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,r&&this._render(t)}))}_preloadTiles(u){const t=this.style?this.style.getSourceCaches():[];return s.bw(t,(r,h)=>r._preloadTiles(u,h),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(u){this._trackResize&&this.resize({originalEvent:u})._update()}_onVisibilityChange(){document.visibilityState==="hidden"&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(u){this._showTileBoundaries!==u&&(this._showTileBoundaries=u,this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(u){this._showParseStatus!==u&&(this._showParseStatus=u,this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(u){this._showTerrainWireframe!==u&&(this._showTerrainWireframe=u,this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(u){this._showLayers2DWireframe!==u&&(this._showLayers2DWireframe=u,this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(u){this._showLayers3DWireframe!==u&&(this._showLayers3DWireframe=u,this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(u){this._speedIndexTiming!==u&&(this._speedIndexTiming=u,this._update())}get showPadding(){return!!this._showPadding}set showPadding(u){this._showPadding!==u&&(this._showPadding=u,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(u){this._showCollisionBoxes!==u&&(this._showCollisionBoxes=u,this.style&&u?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(u){this._showOverdrawInspector!==u&&(this._showOverdrawInspector=u,this._update())}get repaint(){return!!this._repaint}set repaint(u){this._repaint!==u&&(this._repaint=u,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(u){this._vertices=u,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(u){this._showTileAABBs!==u&&(this._showTileAABBs=u,u&&this._update())}_setCacheLimits(u,t){s.f4(u,t)}get version(){return Z}},NavigationControl:class{constructor(u={}){this.options=Object.assign({},lx,u),this._container=We("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",t=>t.preventDefault()),this.options.showZoom&&(s.aY(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",t=>{this._map&&this._map.zoomIn({},{originalEvent:t})}),We("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",t=>{this._map&&this._map.zoomOut({},{originalEvent:t})}),We("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(s.aY(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",t=>{const r=this._map;r&&(this.options.visualizePitch?r.resetNorthPitch({},{originalEvent:t}):r.resetNorth({},{originalEvent:t}))}),this._compassIcon=We("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const u=this._map;if(!u)return;const t=u.getZoom(),r=t===u.getMaxZoom(),h=t===u.getMinZoom();this._zoomInButton.disabled=r,this._zoomOutButton.disabled=h,this._zoomInButton.setAttribute("aria-disabled",r.toString()),this._zoomOutButton.setAttribute("aria-disabled",h.toString())}_rotateCompassArrow(){const u=this._map;if(!u)return;const t=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(u.transform.pitch*(Math.PI/180)),.5)}) rotateX(${u.transform.pitch}deg) rotateZ(${u.transform.angle*(180/Math.PI)}deg)`:`rotate(${u.transform.angle*(180/Math.PI)}deg)`;u._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=t)})}onAdd(u){return this._map=u,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),u.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&u.on("pitch",this._rotateCompassArrow),u.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new cx(u,this._compass,this.options.visualizePitch)),this._container}onRemove(){const u=this._map;u&&(this._container.remove(),this.options.showZoom&&u.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&u.off("pitch",this._rotateCompassArrow),u.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(u,t){const r=We("button",u,this._container);return r.type="button",r.addEventListener("click",t),r}_setButtonTitle(u,t){if(!this._map)return;const r=this._map._getUIString(`NavigationControl.${t}`);u.setAttribute("aria-label",r),u.firstElementChild&&u.firstElementChild.setAttribute("title",r)}},GeolocateControl:class extends s.E{constructor(u={}){super();const t=navigator.geolocation;this.options=Object.assign({geolocation:t},ux,u),s.aY(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=$d(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(u){return this._map=u,this._container=We("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){this._geolocationWatchID!==void 0&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(u){const t=(r=!!this.options.geolocation)=>{this._supportsGeolocation=r,u(r)};this._supportsGeolocation!==void 0?u(this._supportsGeolocation):navigator.permissions!==void 0?navigator.permissions.query({name:"geolocation"}).then(r=>t(r.state!=="denied")).catch(()=>t()):t()}_isOutOfMapMaxBounds(u){const t=this._map.getMaxBounds(),r=u.coords;return!!t&&(r.longitude<t.getWest()||r.longitude>t.getEast()||r.latitude<t.getSouth()||r.latitude>t.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(u){if(this._map){if(this._isOutOfMapMaxBounds(u))return this._setErrorState(),this.fire(new s.z("outofmaxbounds",u)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=u,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(u),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(u),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new s.z("geolocate",Object.assign({coords:u.coords,timestamp:u.timestamp},u.toJSON?{toJSON:u.toJSON.bind(u)}:{}))),this._finish()}}_updateCamera(u){const t=new s.aT(u.coords.longitude,u.coords.latitude),r=u.coords.accuracy,h=this._map.getBearing(),p=Object.assign({bearing:h},this.options.fitBoundsOptions);this._map.fitBounds(t.toBounds(r),p,{geolocateSource:!0})}_updateMarker(u){if(u){const t=new s.aT(u.coords.longitude,u.coords.latitude);this._accuracyCircleMarker.setLngLat(t).addTo(this._map),this._userLocationDotMarker.setLngLat(t).addTo(this._map),this._accuracy=u.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const u=this._map.transform,t=s.cf(1,u._center.lat)*u.worldSize,r=Math.ceil(2*this._accuracy*t);this._circleElement.style.width=`${r}px`,this._circleElement.style.height=`${r}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(u){if(this._map){if(this.options.trackUserLocation)if(u.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(u.code===3&&this._noTimeout)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new s.z("error",u)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(u){if(this._map!==void 0){if(this._container.addEventListener("contextmenu",t=>t.preventDefault()),this._geolocateButton=We("button","mapboxgl-ctrl-geolocate",this._container),We("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",u===!1){s.w("Geolocation support is not available so the GeolocateControl will be disabled.");const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}else{const t=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=We("div","mapboxgl-user-location"),this._dotElement.appendChild(We("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(We("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new nf({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=We("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new nf({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",t=>{t.geolocateSource||this._watchState!=="ACTIVE_LOCK"||t.originalEvent&&t.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new s.z("trackuserlocationend")))})}}_onDeviceOrientation(u){this._userLocationDotMarker&&(u.webkitCompassHeading?this._heading=u.webkitCompassHeading:u.absolute===!0&&(this._heading=-1*u.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return s.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new s.z("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new s.z("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new s.z("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let u;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(u={maximumAge:6e5,timeout:0},this._noTimeout=!0):(u=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,u),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=window.setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const u=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};typeof DeviceMotionEvent<"u"&&typeof DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(t=>{t==="granted"&&u()}).catch(console.error):u()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:oh,ScaleControl:class{constructor(u={}){this.options=Object.assign({},jc,u),s.aY(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const u=this.options.maxWidth||100,t=this._map,r=t._containerHeight/2,h=t._containerWidth/2-u/2,p=t.unproject([h,r]),g=t.unproject([h+u,r]),y=p.distanceTo(g);if(this.options.unit==="imperial"){const w=3.2808*y;w>5280?this._setScale(u,w/5280,"mile"):this._setScale(u,w,"foot")}else this.options.unit==="nautical"?this._setScale(u,y/1852,"nautical-mile"):y>=1e3?this._setScale(u,y/1e3,"kilometer"):this._setScale(u,y,"meter")}_setScale(u,t,r){this._map._requestDomTask(()=>{const h=function(g){const y=Math.pow(10,`${Math.floor(g)}`.length-1);let w=g/y;return w=w>=10?10:w>=5?5:w>=3?3:w>=2?2:w>=1?1:function(T){const A=Math.pow(10,Math.ceil(-Math.log(T)/Math.LN10));return Math.round(T*A)/A}(w),y*w}(t),p=h/t;this._container.innerHTML=r!=="nautical-mile"?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:r}).format(h):`${h}&nbsp;${vm[r]}`,this._container.style.width=u*p+"px"})}onAdd(u){return this._map=u,this._language=u.getLanguage(),this._container=We("div","mapboxgl-ctrl mapboxgl-ctrl-scale",u.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(u){this._language=u,this._update()}setUnit(u){this.options.unit=u,this._update()}},FullscreenControl:class{constructor(u={}){this._fullscreen=!1,u&&u.container&&(u.container instanceof HTMLElement?this._container=u.container:s.w("Full screen control 'container' must be a DOM element.")),s.aY(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(u){return this._map=u,this._container||(this._container=this._map.getContainer()),this._controlContainer=We("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",s.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){const u=this._fullscreenButton=We("button","mapboxgl-ctrl-fullscreen",this._controlContainer);We("span","mapboxgl-ctrl-icon",u).setAttribute("aria-hidden","true"),u.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const u=this._getTitle();this._fullscreenButton.setAttribute("aria-label",u),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",u)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},IndoorControl:Nc,Popup:class extends s.E{constructor(u){super(),this.options=Object.assign(Object.create(ts),u),this._altitude=this.options.altitude,s.aY(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(u&&u.className?u.className.trim().split(/\s+/):[])}addTo(u){return this._map&&this.remove(),this._map=u,this.options.closeOnClick&&u.on("preclick",this._onClose),this.options.closeOnMove&&u.on("move",this._onClose),u.on("remove",this.remove),this._update(),u._addPopup(this),this._focusFirstElement(),this._trackPointer?(u.on("mousemove",this._onMouseEvent),u.on("mouseup",this._onMouseEvent),u._canvasContainer.classList.add("mapboxgl-track-pointer")):u.on("move",this._update),this.fire(new s.z("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const u=this._map;return u&&(u.off("move",this._update),u.off("move",this._onClose),u.off("preclick",this._onClose),u.off("click",this._onClose),u.off("remove",this.remove),u.off("mousemove",this._onMouseEvent),u.off("mouseup",this._onMouseEvent),u.off("drag",this._onMouseEvent),u._canvasContainer&&u._canvasContainer.classList.remove("mapboxgl-track-pointer"),u._removePopup(this),this._map=void 0),this.fire(new s.z("close")),this}getLngLat(){return this._lngLat}setLngLat(u){this._lngLat=s.aT.convert(u),this._pos=null,this._trackPointer=!1,this._update();const t=this._map;return t&&(t.on("move",this._update),t.off("mousemove",this._onMouseEvent),t._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}getAltitude(){return this._altitude}setAltitude(u){return this._altitude=u,this._update(),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const u=this._map;return u&&(u.off("move",this._update),u.on("mousemove",this._onMouseEvent),u.on("drag",this._onMouseEvent),u._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(u){return this.setDOMContent(document.createTextNode(u))}setHTML(u){const t=document.createDocumentFragment(),r=document.createElement("body");let h;for(r.innerHTML=u;h=r.firstChild,h;)t.appendChild(h);return this.setDOMContent(t)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(u){return this.options.maxWidth=u,this._update(),this}setDOMContent(u){let t=this._content;if(t)for(;t.hasChildNodes();)t.firstChild&&t.removeChild(t.firstChild);else t=this._content=We("div","mapboxgl-popup-content",this._container||void 0);if(t.appendChild(u),this.options.closeButton){const r=this._closeButton=We("button","mapboxgl-popup-close-button",t);r.type="button",r.setAttribute("aria-label","Close popup"),r.innerHTML='<span aria-hidden="true">&#215;</span>',r.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(u){return this._classList.add(u),this._updateClassList(),this}removeClassName(u){return this._classList.delete(u),this._updateClassList(),this}setOffset(u){return this.options.offset=u,this._update(),this}toggleClassName(u){let t;return this._classList.delete(u)?t=!1:(this._classList.add(u),t=!0),this._updateClassList(),t}_onMouseEvent(u){this._update(u.point)}_getAnchor(u){if(this.options.anchor)return this.options.anchor;const t=this._map,r=this._container,h=this._pos;if(!t||!r||!h)return"bottom";const p=r.offsetWidth,g=r.offsetHeight,y=h.x<p/2,w=h.x>t.transform.width-p/2;if(h.y+u<g)return y?"top-left":w?"top-right":"top";if(h.y>t.transform.height-g){if(y)return"bottom-left";if(w)return"bottom-right"}return y?"left":w?"right":"bottom"}_updateClassList(){const u=this._container;if(!u)return;const t=[...this._classList];t.push("mapboxgl-popup"),this._anchor&&t.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&t.push("mapboxgl-popup-track-pointer"),u.className=t.join(" ")}_update(u){const t=this._map,r=this._content;if(!t||!this._lngLat&&!this._trackPointer||!r)return;let h=this._container;if(h||(h=this._container=We("div","mapboxgl-popup",t.getContainer()),this._tip=We("div","mapboxgl-popup-tip",h),h.appendChild(r)),this.options.maxWidth&&h.style.maxWidth!==this.options.maxWidth&&(h.style.maxWidth=this.options.maxWidth),t.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=ym(this._lngLat,this._pos,t.transform)),!this._trackPointer||u){const p=this._pos=this._trackPointer&&u instanceof s.P?u:t.project(this._lngLat,this._altitude),g=Yl(this.options.offset),y=this._anchor=this._getAnchor(g.y),w=Yl(this.options.offset,y),T=p.add(w).round();t._requestDomTask(()=>{this._container&&y&&(this._container.style.transform=`${Gr[y]} translate(${T.x}px,${T.y}px)`)})}if(!this._marker&&t._showingGlobe()){const p=s.f5(t.transform,this._lngLat)?0:1;this._setOpacity(p)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const u=this._container.querySelector(is);u&&u.focus()}_onClose(){this.remove()}_setOpacity(u){this._container&&(this._container.style.opacity=`${u}`),this._content&&(this._content.style.pointerEvents=u?"auto":"none")}},Marker:nf,Style:Qo,LngLat:s.aT,LngLatBounds:s.aI,Point:s.P,MercatorCoordinate:s.ae,FreeCameraOptions:so,Evented:s.E,config:s.e,prewarm:s.f9,clearPrewarmedResources:s.f8,get accessToken(){return s.e.ACCESS_TOKEN},set accessToken(u){s.e.ACCESS_TOKEN=u},get baseApiUrl(){return s.e.API_URL},set baseApiUrl(u){s.e.API_URL=u},get workerCount(){return s.fi.workerCount},set workerCount(u){s.fi.workerCount=u},get maxParallelImageRequests(){return s.e.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(u){s.e.MAX_PARALLEL_IMAGE_REQUESTS=u},clearStorage(u){s.fh(u)},get workerUrl(){return s.fg.workerUrl},set workerUrl(u){s.fg.workerUrl=u},get workerClass(){return s.fg.workerClass},set workerClass(u){s.fg.workerClass=u},get workerParams(){return s.fg.workerParams},set workerParams(u){s.fg.workerParams=u},get dracoUrl(){return s.ff()},set dracoUrl(u){s.fe(u)},get meshoptUrl(){return s.fd()},set meshoptUrl(u){s.fc(u)},setNow:s.o.setNow,restoreNow:s.o.restoreNow}});var O=S;return O})})(wM);var uB=wM.exports;const b_=az(uB);b_.accessToken="your_mapbox_token_here";function hB({locations:c,onLocationClick:a,onMapClick:m,selectedLocation:x}){const S=vi.useRef(null),P=vi.useRef(null),O=vi.useRef([]),[s,Z]=vi.useState(!1);return vi.useEffect(()=>{if(!(!S.current||P.current))return P.current=new b_.Map({container:S.current,style:"mapbox://styles/mapbox/streets-v12",center:[-98.5795,39.8283],zoom:4}),P.current.addControl(new b_.NavigationControl,"top-right"),P.current.addControl(new b_.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!0}),"top-right"),P.current.on("load",()=>{Z(!0)}),P.current.on("click",Q=>{m(Q.lngLat.lng,Q.lngLat.lat)}),()=>{var Q;(Q=P.current)==null||Q.remove()}},[m]),vi.useEffect(()=>{!P.current||!s||(O.current.forEach(Q=>Q.remove()),O.current=[],c.forEach(Q=>{const me=document.createElement("div");me.className="marker",me.style.width="32px",me.style.height="32px",me.style.cursor="pointer",me.innerHTML=`
        <div style="
          background-color: ${(x==null?void 0:x.id)===Q.id?"#2563eb":"#10b981"};
          width: 32px;
          height: 32px;
          border-radius: 50%;
          border: 3px solid white;
          box-shadow: 0 2px 8px rgba(0,0,0,0.3);
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 18px;
        ">
          
        </div>
      `,me.addEventListener("click",De=>{De.stopPropagation(),a(Q)});const Ee=new b_.Marker(me).setLngLat([Q.longitude,Q.latitude]).addTo(P.current);O.current.push(Ee)}))},[c,s,a,x]),vi.useEffect(()=>{x&&P.current&&P.current.flyTo({center:[x.longitude,x.latitude],zoom:14,duration:1e3})},[x]),Ce.jsx("div",{className:"relative w-full h-full",children:Ce.jsx("div",{ref:S,className:"absolute inset-0"})})}function dB({location:c,onClose:a,onUpdate:m}){const{user:x}=up(),[S,P]=vi.useState([]),[O,s]=vi.useState([]),[Z,Q]=vi.useState(!1),[me,Ee]=vi.useState(0),[De,Xe]=vi.useState(""),[mt,We]=vi.useState(!1);vi.useEffect(()=>{ct()},[c.id]);const ct=async()=>{var Ze;try{const[Ct,kt]=await Promise.all([dr.from("ratings").select("*, profiles(username, avatar_url)").eq("location_id",c.id).order("created_at",{ascending:!1}),dr.from("photos").select("*, profiles(username, avatar_url)").eq("location_id",c.id).order("created_at",{ascending:!1})]);if(Ct.data&&P(Ct.data),kt.data&&s(kt.data),x){const zt=(Ze=Ct.data)==null?void 0:Ze.find(Zt=>Zt.user_id===x.id);zt&&(Ee(zt.rating),Xe(zt.comment||""))}}catch(Ct){console.error("Error loading location data:",Ct)}},Me=async Ze=>{if(Ze.preventDefault(),!(!x||me===0))try{const{error:Ct}=await dr.from("ratings").upsert({location_id:c.id,user_id:x.id,rating:me,comment:De.trim()||null,updated_at:new Date().toISOString()});if(Ct)throw Ct;Q(!1),await ct(),m()}catch(Ct){console.error("Error submitting rating:",Ct)}},xe=async Ze=>{if(!x||!Ze.target.files||Ze.target.files.length===0)return;const Ct=Ze.target.files[0];We(!0);try{const kt=Ct.name.split(".").pop(),zt=`${x.id}/${Date.now()}.${kt}`,{error:Zt}=await dr.storage.from("dog-photos").upload(zt,Ct);if(Zt)throw Zt;const{data:{publicUrl:mn}}=dr.storage.from("dog-photos").getPublicUrl(zt),{error:Xt}=await dr.from("photos").insert({location_id:c.id,user_id:x.id,photo_url:mn});if(Xt)throw Xt;await ct(),m()}catch(kt){console.error("Error uploading photo:",kt)}finally{We(!1)}},Pe=Ze=>Ce.jsx("div",{className:"flex gap-1",children:[1,2,3,4,5].map(Ct=>Ce.jsx("span",{className:"text-xl",children:Ct<=Ze?"":""},Ct))});return Ce.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50 p-4",children:Ce.jsxs("div",{className:"bg-white rounded-t-3xl sm:rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto",children:[Ce.jsxs("div",{className:"sticky top-0 bg-white border-b px-6 py-4 flex items-center justify-between",children:[Ce.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:c.name}),Ce.jsx("button",{onClick:a,className:"p-2 hover:bg-gray-100 rounded-full transition",children:Ce.jsx(Q_,{size:24})})]}),Ce.jsxs("div",{className:"p-6 space-y-6",children:[Ce.jsxs("div",{children:[Ce.jsxs("div",{className:"flex items-center gap-4 mb-2",children:[Ce.jsx("div",{className:"flex items-center gap-2",children:Pe(Math.round(c.average_rating))}),Ce.jsx("span",{className:"text-2xl font-bold text-gray-900",children:c.average_rating.toFixed(1)}),Ce.jsxs("span",{className:"text-gray-500",children:["(",c.total_ratings," ",c.total_ratings===1?"rating":"ratings",")"]})]}),c.description&&Ce.jsx("p",{className:"text-gray-600 mb-2",children:c.description}),c.address&&Ce.jsx("p",{className:"text-sm text-gray-500",children:c.address})]}),Ce.jsxs("div",{className:"flex gap-3",children:[Ce.jsxs("button",{onClick:()=>Q(!Z),className:"flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 px-4 rounded-lg transition flex items-center justify-center gap-2",children:[Ce.jsx(rB,{size:20}),me>0?"Update Rating":"Rate Location"]}),Ce.jsxs("label",{className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition flex items-center justify-center gap-2 cursor-pointer",children:[Ce.jsx(tB,{size:20}),mt?"Uploading...":"Add Photo",Ce.jsx("input",{type:"file",accept:"image/*",onChange:xe,className:"hidden",disabled:mt})]})]}),Z&&Ce.jsxs("form",{onSubmit:Me,className:"bg-gray-50 rounded-lg p-4 space-y-4",children:[Ce.jsxs("div",{children:[Ce.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Your Rating"}),Ce.jsx("div",{className:"flex gap-2",children:[1,2,3,4,5].map(Ze=>Ce.jsx("button",{type:"button",onClick:()=>Ee(Ze),className:"text-3xl hover:scale-110 transition",children:Ze<=me?"":""},Ze))})]}),Ce.jsxs("div",{children:[Ce.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Comment (optional)"}),Ce.jsx("textarea",{value:De,onChange:Ze=>Xe(Ze.target.value),rows:3,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent",placeholder:"Share your experience..."})]}),Ce.jsx("button",{type:"submit",disabled:me===0,className:"w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed",children:"Submit Rating"})]}),O.length>0&&Ce.jsxs("div",{children:[Ce.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Photos"}),Ce.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-3",children:O.map(Ze=>Ce.jsx("div",{className:"aspect-square rounded-lg overflow-hidden",children:Ce.jsx("img",{src:Ze.photo_url,alt:"Dog photo",className:"w-full h-full object-cover"})},Ze.id))})]}),S.length>0&&Ce.jsxs("div",{children:[Ce.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Reviews"}),Ce.jsx("div",{className:"space-y-4",children:S.map(Ze=>{var Ct;return Ce.jsxs("div",{className:"border-b pb-4 last:border-0",children:[Ce.jsxs("div",{className:"flex items-start justify-between mb-2",children:[Ce.jsxs("div",{children:[Ce.jsx("p",{className:"font-semibold text-gray-900",children:((Ct=Ze.profiles)==null?void 0:Ct.username)||"Anonymous"}),Ce.jsx("div",{className:"flex gap-1 mt-1",children:Pe(Ze.rating)})]}),Ce.jsx("span",{className:"text-sm text-gray-500",children:new Date(Ze.created_at).toLocaleDateString()})]}),Ze.comment&&Ce.jsx("p",{className:"text-gray-600",children:Ze.comment})]},Ze.id)})})]})]})]})})}const fB=["park","beach","cafe","restaurant","trail","store","other"];function pB({latitude:c,longitude:a,onClose:m,onSuccess:x}){const{user:S}=up(),[P,O]=vi.useState(""),[s,Z]=vi.useState(""),[Q,me]=vi.useState(""),[Ee,De]=vi.useState("park"),[Xe,mt]=vi.useState(!1),[We,ct]=vi.useState(""),Me=async xe=>{if(xe.preventDefault(),!!S){mt(!0),ct("");try{const{error:Pe}=await dr.from("locations").insert({name:P,description:s.trim()||null,address:Q.trim()||null,latitude:c,longitude:a,category:Ee,created_by:S.id});if(Pe)throw Pe;x(),m()}catch(Pe){ct("Failed to add location. Please try again."),console.error("Error adding location:",Pe)}finally{mt(!1)}}};return Ce.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:Ce.jsxs("div",{className:"bg-white rounded-2xl w-full max-w-md",children:[Ce.jsxs("div",{className:"border-b px-6 py-4 flex items-center justify-between",children:[Ce.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"Add Dog-Friendly Location"}),Ce.jsx("button",{onClick:m,className:"p-2 hover:bg-gray-100 rounded-full transition",children:Ce.jsx(Q_,{size:20})})]}),Ce.jsxs("form",{onSubmit:Me,className:"p-6 space-y-4",children:[Ce.jsxs("div",{className:"bg-emerald-50 rounded-lg p-3 flex items-center gap-2 text-sm text-emerald-800",children:[Ce.jsx(dT,{size:16}),Ce.jsxs("span",{children:[c.toFixed(4),", ",a.toFixed(4)]})]}),Ce.jsxs("div",{children:[Ce.jsx("label",{htmlFor:"name",className:"block text-sm font-medium text-gray-700 mb-1",children:"Location Name *"}),Ce.jsx("input",{id:"name",type:"text",value:P,onChange:xe=>O(xe.target.value),required:!0,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent",placeholder:"e.g., Central Dog Park"})]}),Ce.jsxs("div",{children:[Ce.jsx("label",{htmlFor:"category",className:"block text-sm font-medium text-gray-700 mb-1",children:"Category *"}),Ce.jsx("select",{id:"category",value:Ee,onChange:xe=>De(xe.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent",children:fB.map(xe=>Ce.jsx("option",{value:xe,children:xe.charAt(0).toUpperCase()+xe.slice(1)},xe))})]}),Ce.jsxs("div",{children:[Ce.jsx("label",{htmlFor:"address",className:"block text-sm font-medium text-gray-700 mb-1",children:"Address (optional)"}),Ce.jsx("input",{id:"address",type:"text",value:Q,onChange:xe=>me(xe.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent",placeholder:"123 Main St, City, State"})]}),Ce.jsxs("div",{children:[Ce.jsx("label",{htmlFor:"description",className:"block text-sm font-medium text-gray-700 mb-1",children:"Description (optional)"}),Ce.jsx("textarea",{id:"description",value:s,onChange:xe=>Z(xe.target.value),rows:3,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent",placeholder:"What makes this place dog-friendly?"})]}),We&&Ce.jsx("div",{className:"bg-red-50 text-red-700 px-4 py-3 rounded-lg text-sm",children:We}),Ce.jsxs("div",{className:"flex gap-3",children:[Ce.jsx("button",{type:"button",onClick:m,className:"flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition",children:"Cancel"}),Ce.jsx("button",{type:"submit",disabled:Xe,className:"flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed",children:Xe?"Adding...":"Add Location"})]})]})]})})}function mB({onClose:c,onLocationSelect:a}){const{user:m}=up(),[x,S]=vi.useState([]),[P,O]=vi.useState(!0);vi.useEffect(()=>{s()},[m]);const s=async()=>{var Q,me;if(m){O(!0);try{const{data:Ee}=await dr.from("friends").select("friend_id").eq("user_id",m.id).eq("status","accepted"),De=(Ee==null?void 0:Ee.map(ct=>ct.friend_id))||[];if(De.length===0){S([]),O(!1);return}const[Xe,mt]=await Promise.all([dr.from("ratings").select(`
            id,
            rating,
            comment,
            created_at,
            user_id,
            profiles:user_id (username, avatar_url),
            locations:location_id (id, name)
          `).in("user_id",De).order("created_at",{ascending:!1}).limit(20),dr.from("photos").select(`
            id,
            photo_url,
            caption,
            created_at,
            user_id,
            profiles:user_id (username, avatar_url),
            locations:location_id (id, name)
          `).in("user_id",De).order("created_at",{ascending:!1}).limit(20)]),We=[];(Q=Xe.data)==null||Q.forEach(ct=>{We.push({id:ct.id,type:"rating",user:ct.profiles,location:ct.locations,created_at:ct.created_at,rating:ct.rating,comment:ct.comment})}),(me=mt.data)==null||me.forEach(ct=>{We.push({id:ct.id,type:"photo",user:ct.profiles,location:ct.locations,created_at:ct.created_at,photo_url:ct.photo_url,caption:ct.caption})}),We.sort((ct,Me)=>new Date(Me.created_at).getTime()-new Date(ct.created_at).getTime()),S(We)}catch(Ee){console.error("Error loading feed:",Ee)}finally{O(!1)}}},Z=Q=>Ce.jsx("div",{className:"flex gap-1",children:[1,2,3,4,5].map(me=>Ce.jsx("span",{className:"text-lg",children:me<=Q?"":""},me))});return Ce.jsxs("div",{className:"fixed inset-0 bg-white z-50 flex flex-col",children:[Ce.jsxs("div",{className:"sticky top-0 bg-white border-b px-6 py-4 flex items-center justify-between",children:[Ce.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Friends Activity"}),Ce.jsx("button",{onClick:c,className:"p-2 hover:bg-gray-100 rounded-full transition",children:Ce.jsx(Q_,{size:24})})]}),Ce.jsx("div",{className:"flex-1 overflow-y-auto",children:P?Ce.jsx("div",{className:"flex items-center justify-center h-64",children:Ce.jsx("div",{className:"text-gray-500",children:"Loading feed..."})}):x.length===0?Ce.jsxs("div",{className:"flex flex-col items-center justify-center h-64 text-center p-6",children:[Ce.jsx("p",{className:"text-2xl mb-2",children:""}),Ce.jsx("p",{className:"text-gray-600 mb-4",children:"No activity yet from your friends."}),Ce.jsx("p",{className:"text-sm text-gray-500",children:"Add friends to see their ratings and photos!"})]}):Ce.jsx("div",{className:"max-w-2xl mx-auto p-4 space-y-4",children:x.map(Q=>Ce.jsx("div",{className:"bg-white border rounded-xl shadow-sm overflow-hidden hover:shadow-md transition",children:Ce.jsxs("div",{className:"p-4",children:[Ce.jsx("div",{className:"flex items-center justify-between mb-3",children:Ce.jsxs("div",{className:"flex items-center gap-3",children:[Ce.jsx("div",{className:"w-10 h-10 bg-emerald-100 rounded-full flex items-center justify-center",children:Q.user.avatar_url?Ce.jsx("img",{src:Q.user.avatar_url,alt:Q.user.username,className:"w-full h-full rounded-full object-cover"}):Ce.jsx("span",{className:"text-lg",children:""})}),Ce.jsxs("div",{children:[Ce.jsx("p",{className:"font-semibold text-gray-900",children:Q.user.username}),Ce.jsxs("p",{className:"text-xs text-gray-500",children:[new Date(Q.created_at).toLocaleDateString()," at"," ",new Date(Q.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})]})]})]})}),Q.type==="rating"?Ce.jsxs("div",{children:[Ce.jsx("div",{className:"mb-2",children:Z(Q.rating)}),Q.comment&&Ce.jsx("p",{className:"text-gray-700 mb-3",children:Q.comment})]}):Ce.jsxs("div",{children:[Q.photo_url&&Ce.jsx("img",{src:Q.photo_url,alt:"Dog photo",className:"w-full rounded-lg mb-2"}),Q.caption&&Ce.jsx("p",{className:"text-gray-700 mb-3",children:Q.caption})]}),Ce.jsxs("button",{onClick:()=>{a(Q.location.id),c()},className:"flex items-center gap-2 text-emerald-600 hover:text-emerald-700 text-sm font-medium",children:[Ce.jsx(dT,{size:16}),Q.location.name]})]})},`${Q.type}-${Q.id}`))})})]})}function _B({onClose:c,onLocationSelect:a,currentLocation:m}){const{user:x}=up(),[S,P]=vi.useState([]),[O,s]=vi.useState(null),[Z,Q]=vi.useState([]),[me,Ee]=vi.useState(!1),[De,Xe]=vi.useState(""),[mt,We]=vi.useState(""),[ct,Me]=vi.useState(!1),[xe,Pe]=vi.useState(!0);vi.useEffect(()=>{Ze()},[x]),vi.useEffect(()=>{O&&Ct(O)},[O]);const Ze=async()=>{if(x){Pe(!0);try{const{data:Xt,error:Mi}=await dr.from("favorite_lists").select("*").eq("user_id",x.id).order("created_at",{ascending:!1});if(Mi)throw Mi;P(Xt||[])}catch(Xt){console.error("Error loading lists:",Xt)}finally{Pe(!1)}}},Ct=async Xt=>{try{const{data:Mi,error:or}=await dr.from("list_locations").select(`
          location_id,
          locations (*)
        `).eq("list_id",Xt);if(or)throw or;Q((Mi==null?void 0:Mi.map(Ri=>Ri.locations))||[])}catch(Mi){console.error("Error loading list locations:",Mi)}},kt=async Xt=>{if(Xt.preventDefault(),!!x)try{const{data:Mi,error:or}=await dr.from("favorite_lists").insert({user_id:x.id,name:De,description:mt.trim()||null,is_public:ct}).select().single();if(or)throw or;P([Mi,...S]),Xe(""),We(""),Me(!1),Ee(!1)}catch(Mi){console.error("Error creating list:",Mi)}},zt=async Xt=>{if(confirm("Are you sure you want to delete this list?"))try{const{error:Mi}=await dr.from("favorite_lists").delete().eq("id",Xt);if(Mi)throw Mi;P(S.filter(or=>or.id!==Xt)),O===Xt&&(s(null),Q([]))}catch(Mi){console.error("Error deleting list:",Mi)}},Zt=async Xt=>{if(m)try{const{error:Mi}=await dr.from("list_locations").insert({list_id:Xt,location_id:m.id});if(Mi)throw Mi.code==="23505"&&alert("This location is already in this list!"),Mi;O===Xt&&await Ct(Xt),alert("Location added to list!")}catch(Mi){console.error("Error adding to list:",Mi)}},mn=async(Xt,Mi)=>{try{const{error:or}=await dr.from("list_locations").delete().eq("list_id",Xt).eq("location_id",Mi);if(or)throw or;await Ct(Xt)}catch(or){console.error("Error removing from list:",or)}};return Ce.jsxs("div",{className:"fixed inset-0 bg-white z-50 flex flex-col",children:[Ce.jsxs("div",{className:"sticky top-0 bg-white border-b px-6 py-4 flex items-center justify-between",children:[Ce.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Favorite Lists"}),Ce.jsx("button",{onClick:c,className:"p-2 hover:bg-gray-100 rounded-full transition",children:Ce.jsx(Q_,{size:24})})]}),Ce.jsx("div",{className:"flex-1 overflow-y-auto",children:Ce.jsxs("div",{className:"max-w-4xl mx-auto p-4",children:[m&&Ce.jsxs("div",{className:"bg-emerald-50 border border-emerald-200 rounded-lg p-4 mb-4",children:[Ce.jsxs("p",{className:"text-sm text-emerald-800 mb-2",children:["Add ",Ce.jsx("strong",{children:m.name})," to a list:"]}),Ce.jsx("div",{className:"flex flex-wrap gap-2",children:S.map(Xt=>Ce.jsx("button",{onClick:()=>Zt(Xt.id),className:"px-3 py-1 bg-white border border-emerald-300 text-emerald-700 rounded-full text-sm hover:bg-emerald-100 transition",children:Xt.name},Xt.id))})]}),Ce.jsx("div",{className:"mb-6",children:me?Ce.jsxs("form",{onSubmit:kt,className:"bg-gray-50 rounded-lg p-4 space-y-4",children:[Ce.jsxs("div",{children:[Ce.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"List Name"}),Ce.jsx("input",{type:"text",value:De,onChange:Xt=>Xe(Xt.target.value),required:!0,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent",placeholder:"e.g., Weekend Parks"})]}),Ce.jsxs("div",{children:[Ce.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Description (optional)"}),Ce.jsx("textarea",{value:mt,onChange:Xt=>We(Xt.target.value),rows:2,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent",placeholder:"Describe your list..."})]}),Ce.jsxs("div",{className:"flex items-center gap-2",children:[Ce.jsx("input",{type:"checkbox",id:"isPublic",checked:ct,onChange:Xt=>Me(Xt.target.checked),className:"w-4 h-4 text-emerald-600 rounded"}),Ce.jsx("label",{htmlFor:"isPublic",className:"text-sm text-gray-700",children:"Make this list public"})]}),Ce.jsxs("div",{className:"flex gap-3",children:[Ce.jsx("button",{type:"button",onClick:()=>Ee(!1),className:"flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition",children:"Cancel"}),Ce.jsx("button",{type:"submit",className:"flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-4 rounded-lg transition",children:"Create List"})]})]}):Ce.jsxs("button",{onClick:()=>Ee(!0),className:"w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 px-4 rounded-lg transition flex items-center justify-center gap-2",children:[Ce.jsx(xM,{size:20}),"Create New List"]})}),xe?Ce.jsx("div",{className:"text-center py-8 text-gray-500",children:"Loading lists..."}):S.length===0?Ce.jsxs("div",{className:"text-center py-8",children:[Ce.jsx("p",{className:"text-2xl mb-2",children:""}),Ce.jsx("p",{className:"text-gray-600",children:"No lists yet. Create your first list!"})]}):Ce.jsx("div",{className:"space-y-4",children:S.map(Xt=>Ce.jsxs("div",{className:"border rounded-lg overflow-hidden",children:[Ce.jsxs("button",{onClick:()=>s(O===Xt.id?null:Xt.id),className:"w-full px-4 py-3 bg-white hover:bg-gray-50 flex items-center justify-between transition",children:[Ce.jsxs("div",{className:"flex items-center gap-3",children:[Ce.jsx(vM,{className:"text-emerald-600",size:20}),Ce.jsxs("div",{className:"text-left",children:[Ce.jsx("p",{className:"font-semibold text-gray-900",children:Xt.name}),Xt.description&&Ce.jsx("p",{className:"text-sm text-gray-600",children:Xt.description})]})]}),Ce.jsx("button",{onClick:Mi=>{Mi.stopPropagation(),zt(Xt.id)},className:"p-2 hover:bg-red-100 rounded-full transition text-red-600",children:Ce.jsx(oB,{size:18})})]}),O===Xt.id&&Ce.jsx("div",{className:"border-t bg-gray-50 p-4",children:Z.length===0?Ce.jsx("p",{className:"text-sm text-gray-500 text-center py-4",children:"No locations in this list yet"}):Ce.jsx("div",{className:"space-y-2",children:Z.map(Mi=>Ce.jsxs("div",{className:"bg-white rounded-lg p-3 flex items-center justify-between",children:[Ce.jsxs("button",{onClick:()=>{a(Mi.id),c()},className:"flex items-center gap-2 text-left flex-1",children:[Ce.jsx(dT,{size:16,className:"text-emerald-600"}),Ce.jsxs("div",{children:[Ce.jsx("p",{className:"font-medium text-gray-900",children:Mi.name}),Ce.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[Ce.jsx("span",{children:Mi.category}),Ce.jsx("span",{children:""}),Ce.jsxs("span",{children:[" ",Mi.average_rating.toFixed(1)]})]})]})]}),Ce.jsx("button",{onClick:()=>mn(Xt.id,Mi.id),className:"p-2 hover:bg-red-100 rounded-full transition text-red-600",children:Ce.jsx(Q_,{size:16})})]},Mi.id))})})]},Xt.id))})]})})]})}function gB(){const{user:c,profile:a,loading:m,signOut:x}=up(),[S,P]=vi.useState([]),[O,s]=vi.useState(null),[Z,Q]=vi.useState(!1),[me,Ee]=vi.useState(null),[De,Xe]=vi.useState(!1),[mt,We]=vi.useState(!1),[ct,Me]=vi.useState(!1),[xe,Pe]=vi.useState("map");vi.useEffect(()=>{c&&Ze()},[c]);const Ze=async()=>{try{const{data:zt,error:Zt}=await dr.from("locations").select("*").order("created_at",{ascending:!1});if(Zt)throw Zt;P(zt||[])}catch(zt){console.error("Error loading locations:",zt)}},Ct=(zt,Zt)=>{Ee({lat:Zt,lng:zt}),Q(!0)},kt=async zt=>{const Zt=S.find(mn=>mn.id===zt);if(Zt)s(Zt);else{const{data:mn}=await dr.from("locations").select("*").eq("id",zt).single();mn&&s(mn)}};return m?Ce.jsx("div",{className:"min-h-screen bg-gradient-to-br from-emerald-50 to-blue-50 flex items-center justify-center",children:Ce.jsx("div",{className:"text-2xl",children:"Loading..."})}):c?Ce.jsxs("div",{className:"h-screen flex flex-col bg-white",children:[Ce.jsxs("header",{className:"bg-white border-b px-4 py-3 flex items-center justify-between shadow-sm",children:[Ce.jsxs("div",{className:"flex items-center gap-2",children:[Ce.jsx("span",{className:"text-3xl",children:""}),Ce.jsx("h1",{className:"text-xl font-bold text-gray-900",children:"SniffLocal"})]}),Ce.jsxs("div",{className:"flex items-center gap-3",children:[Ce.jsx("span",{className:"text-sm text-gray-600 hidden sm:inline",children:(a==null?void 0:a.username)||"User"}),Ce.jsx("button",{onClick:x,className:"p-2 hover:bg-gray-100 rounded-full transition",title:"Sign Out",children:Ce.jsx(nB,{size:20,className:"text-gray-600"})})]})]}),Ce.jsxs("div",{className:"flex-1 relative",children:[xe==="map"&&Ce.jsx(hB,{locations:S,onLocationClick:s,onMapClick:Ct,selectedLocation:O}),xe==="feed"&&De&&Ce.jsx(mB,{onClose:()=>Xe(!1),onLocationSelect:kt}),xe==="lists"&&mt&&Ce.jsx(_B,{onClose:()=>We(!1),onLocationSelect:kt,currentLocation:O}),xe==="profile"&&ct&&Ce.jsxs("div",{className:"fixed inset-0 bg-white z-50 flex flex-col",children:[Ce.jsxs("div",{className:"border-b px-6 py-4 flex items-center justify-between",children:[Ce.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Profile"}),Ce.jsx("button",{onClick:()=>{Me(!1),Pe("map")},className:"p-2 hover:bg-gray-100 rounded-full transition",children:Ce.jsx(DA,{size:24})})]}),Ce.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:Ce.jsxs("div",{className:"max-w-md mx-auto space-y-6",children:[Ce.jsxs("div",{className:"text-center",children:[Ce.jsx("div",{className:"w-24 h-24 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4",children:Ce.jsx("span",{className:"text-5xl",children:""})}),Ce.jsx("h3",{className:"text-2xl font-bold text-gray-900 mb-1",children:(a==null?void 0:a.display_name)||(a==null?void 0:a.username)}),Ce.jsxs("p",{className:"text-gray-600",children:["@",a==null?void 0:a.username]})]}),Ce.jsxs("div",{className:"bg-gray-50 rounded-lg p-6 space-y-4",children:[Ce.jsx("h4",{className:"font-semibold text-gray-900",children:"Account Info"}),Ce.jsxs("div",{children:[Ce.jsx("p",{className:"text-sm text-gray-600",children:"Email"}),Ce.jsx("p",{className:"text-gray-900",children:c.email})]}),Ce.jsxs("div",{children:[Ce.jsx("p",{className:"text-sm text-gray-600",children:"Member Since"}),Ce.jsx("p",{className:"text-gray-900",children:new Date((a==null?void 0:a.created_at)||"").toLocaleDateString()})]})]}),Ce.jsx("button",{onClick:x,className:"w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-lg transition",children:"Sign Out"})]})})]}),O&&Ce.jsx(dB,{location:O,onClose:()=>s(null),onUpdate:Ze}),Z&&me&&Ce.jsx(pB,{latitude:me.lat,longitude:me.lng,onClose:()=>{Q(!1),Ee(null)},onSuccess:()=>{Ze(),Q(!1),Ee(null)}})]}),Ce.jsxs("nav",{className:"bg-white border-t flex items-center justify-around py-2 shadow-lg",children:[Ce.jsxs("button",{onClick:()=>{Pe("map"),Xe(!1),We(!1),Me(!1)},className:`flex flex-col items-center gap-1 px-4 py-2 rounded-lg transition ${xe==="map"?"text-emerald-600":"text-gray-600 hover:text-emerald-600"}`,children:[Ce.jsx(DA,{size:24}),Ce.jsx("span",{className:"text-xs font-medium",children:"Map"})]}),Ce.jsxs("button",{onClick:()=>{Pe("feed"),Xe(!0),We(!1),Me(!1)},className:`flex flex-col items-center gap-1 px-4 py-2 rounded-lg transition ${xe==="feed"?"text-emerald-600":"text-gray-600 hover:text-emerald-600"}`,children:[Ce.jsx(lB,{size:24}),Ce.jsx("span",{className:"text-xs font-medium",children:"Feed"})]}),Ce.jsx("button",{onClick:()=>{xe==="map"&&(Ee({lat:39.8283,lng:-98.5795}),Q(!0))},className:"bg-emerald-600 text-white p-4 rounded-full shadow-lg hover:bg-emerald-700 transition -mt-6",children:Ce.jsx(xM,{size:28})}),Ce.jsxs("button",{onClick:()=>{Pe("lists"),Xe(!1),We(!0),Me(!1)},className:`flex flex-col items-center gap-1 px-4 py-2 rounded-lg transition ${xe==="lists"?"text-emerald-600":"text-gray-600 hover:text-emerald-600"}`,children:[Ce.jsx(vM,{size:24}),Ce.jsx("span",{className:"text-xs font-medium",children:"Lists"})]}),Ce.jsxs("button",{onClick:()=>{Pe("profile"),Xe(!1),We(!1),Me(!0)},className:`flex flex-col items-center gap-1 px-4 py-2 rounded-lg transition ${xe==="profile"?"text-emerald-600":"text-gray-600 hover:text-emerald-600"}`,children:[Ce.jsx(aB,{size:24}),Ce.jsx("span",{className:"text-xs font-medium",children:"Profile"})]})]})]}):Ce.jsx(cB,{})}ZP(document.getElementById("root")).render(Ce.jsx(vi.StrictMode,{children:Ce.jsx(JF,{children:Ce.jsx(gB,{})})}));
